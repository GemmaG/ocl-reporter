<head> <title>Blogs</title>
  <link rel="alternate" href="http://www.cl.cam.ac.uk/projects/ocamllabs/blogs/rss10.xml" title="" type="application/rss+xml" />
  <style>
      a.icon-github {
    background: url(../github.png) no-repeat 0 0;
          background: url(../github.png) no-repeat 0 0;
    padding: 0 0 2px 2em;
      }
      a.icon-cloud {
    background: url(../cloud.png) no-repeat 0 0;
          background-size: 17px;
    padding: 0 0 2px 2em;
      }
      a.icon-bullhorn {
    background: url(../bullhorn.png) no-repeat 0 0;
          background-size: 17px;
    padding: 0 0 2px 2em;
      }
      a.icon-wrench {
    background: url(../wrench.png) no-repeat 0 0;
          background-size: 17px;
    padding: 0 0 2px 2em;
      }
      h2.posttitle {
          font-size: 120%;
      }
  div.toc {
      background-color: rgb(239, 239, 239);
      margin: 0.5em 0em 1.5em 1px;
      border: 1px solid black;
      font-size: 0.7em;
      padding: 0px 0px 1ex;
      font-size: 100%;
  }
    a.planet-toggle {
      font-size: 90%;
      padding: 5px 10px;
      margin-bottom: 2ex;
      color: #4b4b4b;
      background: #e6e6e6;
      border: 1px solid #dedede;
    }

    a.planet-toggle:hover, a.planet-toggle:focus {
      color: #ffffff;
      background: #c77a27;
    }

    .btn {
      display: inline-block;
      color: #ffffff;
      *display: inline;
      /* IE7 inline-block hack */

      *zoom: 1;
      padding: 10px 20px;
      margin-bottom: 0;
      font-family: Lato, sans-serif;
      font-weight: bold;
      font-size: 18px;
      line-height: 28px;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      background: #8eaf20;
      border: 1px solid #8eaf20;
      *border: 0;
      -webkit-border-radius: 4px;
      -moz-border-radius: 4px;
      border-radius: 4px;
      *margin-left: .3em;
      text-shadow: rgba(0, 0, 0, 0.34) 1px 1px 2px;
      -webkit-box-shadow: rgba(0, 0, 0, 0.46) 0 2px 2px;
      -moz-box-shadow: rgba(0, 0, 0, 0.46) 0 2px 2px;
      box-shadow: rgba(0, 0, 0, 0.46) 0 2px 2px;
    }
    .btn:first-child {
      *margin-left: 0;
    }
    .btn:hover,
    .btn:focus {
      color: #ffffff;
      text-decoration: none;
      background-position: 0 -15px;
      -webkit-transition: background-position 0.1s linear;
      -moz-transition: background-position 0.1s linear;
      -o-transition: background-position 0.1s linear;
      transition: background-position 0.1s linear;
    }
    .btn:focus {
      outline: none;
    }
    .btn.active,
    .btn:active {
      background-image: none;
      outline: 0;
      -webkit-box-shadow: inset 0 2px 4px rgba(0,0,0,.15), 0 1px 2px rgba(0,0,0,.05);
      -moz-box-shadow: inset 0 2px 4px rgba(0,0,0,.15), 0 1px 2px rgba(0,0,0,.05);
      box-shadow: inset 0 2px 4px rgba(0,0,0,.15), 0 1px 2px rgba(0,0,0,.05);
    }
    .btn.disabled,
    .btn[disabled] {
      cursor: default;
      background-image: none;
      opacity: 0.65;
      filter: alpha(opacity=65);
      -webkit-box-shadow: none;
      -moz-box-shadow: none;
      box-shadow: none;
    }

  div#content-primary p img, div#content-primary img.right { float: none; }

  </style>
  <script type = "text/javascript">
    function switchContent(id1,id2) {
     // Get the DOM reference
     var contentId1 = document.getElementById(id1);
     var contentId2 = document.getElementById(id2);
     // Toggle
     contentId1.style.display = "none";
     contentId2.style.display = "block";
     }
  </script>
  </head>

  <body>

  <div id="container">

  <h4>Recent Posts</h4>
  <table width="90%">
<tr>
    <td><i> Mar 02, 2015 </i></td>
    <td><a href="#http://hh360.user.srcf.net/blog/?p=832">Part 2: Running your own DNS Resolver with MirageOS</a></td>
    <td>Heidi Howard</td>
 </tr>

<tr>
    <td><i> Feb 18, 2015 </i></td>
    <td><a href="#http://hh360.user.srcf.net/blog/?p=792">Part 1: Running your own DNS Resolver with MirageOS</a></td>
    <td>Heidi Howard</td>
 </tr>

<tr>
    <td><i> Feb 10, 2015 </i></td>
    <td><a href="#http://openmirage.org/blog/announcing-bitcoin-pinata">Smash the Bitcoin Pinata for fun and profit!</a></td>
    <td>Amir Chaudhry</td>
 </tr>

<tr>
    <td><i> Feb 05, 2015 </i></td>
    <td><a href="#http://ocamllabs.github.com/compiler-hacking/2015/02/05/back-in-the-lab">Ninth OCaml compiler hacking evening (back in the lab, with a talk from Oleg)</a></td>
    <td>Compiler Hacking</td>
 </tr>

<tr>
    <td><i> Jan 21, 2015 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2015/01/21/securing-the-unikernel/">Securing the Unikernel</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Jan 08, 2015 </i></td>
    <td><a href="#http://amirchaudhry.com/towards-governance-framework-for-ocamlorg">Towards a governance framework for OCaml.org</a></td>
    <td>Amir Chaudhry</td>
 </tr>

<tr>
    <td><i> Dec 31, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/2014-in-review">Mirage 2014 review: IPv6, TLS, Irmin, Jitsu and community growth</a></td>
    <td>Anil Madhavapeddy</td>
 </tr>

<tr>
    <td><i> Oct 27, 2014 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad/">Visualising an asynchronous monad</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Sep 23, 2014 </i></td>
    <td><a href="#http://ocamllabs.github.com/compiler-hacking/2014/09/23/compiler-hacking-by-the-river">Eighth OCaml compiler hacking evening (at Mill Lane, by the river)</a></td>
    <td>Compiler Hacking</td>
 </tr>

<tr>
    <td><i> Sep 17, 2014 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2014/09/17/simplifying-the-solver-with-functors/">Simplifying the solver with functors</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Aug 15, 2014 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2014/08/15/optimising-the-unikernel/">Optimising the unikernel</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Jul 28, 2014 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">My first unikernel</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Jul 25, 2014 </i></td>
    <td><a href="#http://hh360.user.srcf.net/blog/?p=493">Release of  “ARC: Analysis of Raft Consensus”</a></td>
    <td>Heidi Howard</td>
 </tr>

<tr>
    <td><i> Jul 24, 2014 </i></td>
    <td><a href="#http://ocamllabs.github.com/compiler-hacking/2014/07/24/compiler-hacking-at-citrix">Seventh OCaml compiler hacking session (at Citrix)</a></td>
    <td>Compiler Hacking</td>
 </tr>

<tr>
    <td><i> Jul 22, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/announcing-mirage-20-release">Mirage v2.0: a recap of the new features</a></td>
    <td>Anil Madhavapeddy</td>
 </tr>

<tr>
    <td><i> Jul 22, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/introducing-xen-minios-arm">Building an ARMy of Xen unikernels</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Jul 21, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/introducing-irmin-in-xenstore">Using Irmin to add fault-tolerance to the Xenstore database</a></td>
    <td>Dave Scott</td>
 </tr>

<tr>
    <td><i> Jul 18, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/introducing-irmin">Introducing Irmin: Git-like distributed, branchable storage</a></td>
    <td>Thomas Gazagnaire</td>
 </tr>

<tr>
    <td><i> Jul 17, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/intro-tcpip">Fitting the modular Mirage TCP/IP stack together</a></td>
    <td>Mindy Preston</td>
 </tr>

<tr>
    <td><i> Jul 16, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/update-on-vchan">Vchan: Low-latency inter-VM communication channels</a></td>
    <td>Jon Ludlam</td>
 </tr>

<tr>
    <td><i> Jul 15, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/modular-foreign-function-bindings">Modular foreign function bindings</a></td>
    <td>Jeremy Yallop</td>
 </tr>

<tr>
    <td><i> Jul 14, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">OCaml-TLS: the protocol implementation and mitigations to known attacks</a></td>
    <td>David Kaloper</td>
 </tr>

<tr>
    <td><i> Jul 11, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/introducing-asn1">OCaml-TLS: ASN.1 and notation embedding</a></td>
    <td>David Kaloper</td>
 </tr>

<tr>
    <td><i> Jul 10, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/introducing-x509">OCaml-TLS: Adventures in X.509 certificate parsing and validation</a></td>
    <td>Hannes Mehnert</td>
 </tr>

<tr>
    <td><i> Jul 09, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/introducing-nocrypto">OCaml-TLS: building the nocrypto library core</a></td>
    <td>David Kaloper</td>
 </tr>

<tr>
    <td><i> Jul 08, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/introducing-ocaml-tls">Introducing transport layer security (TLS) in pure OCaml</a></td>
    <td>Hannes Mehnert</td>
 </tr>

<tr>
    <td><i> Jul 08, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/mirage-1.2-released">Mirage 1.2 released and the 2.0 runup begins</a></td>
    <td>Anil Madhavapeddy</td>
 </tr>

<tr>
    <td><i> Jun 24, 2014 </i></td>
    <td><a href="#http://ocamllabs.github.com/compiler-hacking/2014/06/24/highlights-from-recent-sessions">Highlights from recent sessions</a></td>
    <td>Compiler Hacking</td>
 </tr>

<tr>
    <td><i> Jun 20, 2014 </i></td>
    <td><a href="#http://ocamllabs.github.com/compiler-hacking/2014/06/20/sixth-compiler-hacking-session">Sixth OCaml compiler hacking session</a></td>
    <td>Compiler Hacking</td>
 </tr>

<tr>
    <td><i> Jun 06, 2014 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/">Python to OCaml: retrospective</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> May 08, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/welcome-to-our-summer-hackers">Welcome to the summer Mirage hackers</a></td>
    <td>Anil Madhavapeddy</td>
 </tr>

<tr>
    <td><i> Apr 29, 2014 </i></td>
    <td><a href="#http://amirchaudhry.com/writing-planet-in-pure-ocaml">Writing Planet in pure OCaml</a></td>
    <td>Amir Chaudhry</td>
 </tr>

<tr>
    <td><i> Apr 24, 2014 </i></td>
    <td><a href="#http://ocamllabs.github.com/compiler-hacking/2014/04/24/fifth-compiler-hacking-session">Fifth OCaml compiler hacking session</a></td>
    <td>Compiler Hacking</td>
 </tr>

<tr>
    <td><i> Feb 25, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/applying-for-gsoc2014">MirageOS is in Google Summer of Code 2014</a></td>
    <td>Anil Madhavapeddy</td>
 </tr>

<tr>
    <td><i> Feb 13, 2014 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2014/02/13/ocaml-what-you-gain/">OCaml: what you gain</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Feb 11, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/mirage-1.1-released">Mirage 1.1.0: the eat-your-own-dogfood release</a></td>
    <td>Anil Madhavapeddy</td>
 </tr>

<tr>
    <td><i> Feb 11, 2014 </i></td>
    <td><a href="#http://ocamllabs.github.com/compiler-hacking/2014/02/11/fourth-compiler-hacking-session">Fourth OCaml compiler hacking session</a></td>
    <td>Compiler Hacking</td>
 </tr>

<tr>
    <td><i> Feb 04, 2014 </i></td>
    <td><a href="#http://ocamllabs.github.com/compiler-hacking/2014/02/04/handler-case">How to handle success</a></td>
    <td>Compiler Hacking</td>
 </tr>

<tr>
    <td><i> Jan 07, 2014 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/">OCaml: the bugs so far</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Jan 03, 2014 </i></td>
    <td><a href="#http://openmirage.org/blog/decks-n-drums">Presenting Decks</a></td>
    <td>Richard Mortier</td>
 </tr>

<tr>
    <td><i> Dec 29, 2013 </i></td>
    <td><a href="#http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#Dec%202013">Dec 2013 news update</a></td>
    <td>Anil Madhavapeddy</td>
 </tr>

<tr>
    <td><i> Dec 20, 2013 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2013/12/20/polymorphism-for-beginners/">Polymorphism for beginners</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Dec 19, 2013 </i></td>
    <td><a href="#http://openmirage.org/blog/mirage-1.0.3-released">Mirage 1.0.3 released; tutorial on building this website available</a></td>
    <td>Anil Madhavapeddy</td>
 </tr>

<tr>
    <td><i> Dec 09, 2013 </i></td>
    <td><a href="#http://openmirage.org/blog/announcing-mirage10">Mirage 1.0: not just a hallucination!</a></td>
    <td>Anil Madhavapeddy</td>
 </tr>

<tr>
    <td><i> Nov 28, 2013 </i></td>
    <td><a href="#http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/">Asynchronous Python vs OCaml</a></td>
    <td>Thomas Leonard</td>
 </tr>

<tr>
    <td><i> Nov 26, 2013 </i></td>
    <td><a href="#http://amirchaudhry.com/switching-from-bootstrap-to-zurb-foundation">Switching from Bootstrap to Zurb Foundation</a></td>
    <td>Amir Chaudhry</td>
 </tr>

<tr>
    <td><i> Nov 20, 2013 </i></td>
    <td><a href="#http://amirchaudhry.com/announcing-new-ocamlorg">Announcing the new OCaml.org</a></td>
    <td>Amir Chaudhry</td>
 </tr>

<tr>
    <td><i> Nov 06, 2013 </i></td>
    <td><a href="#http://amirchaudhry.com/migration-plan-ocaml-org">Migration plan for the OCaml.org redesign</a></td>
    <td>Amir Chaudhry</td>
 </tr>

<tr>
    <td><i> Oct 30, 2013 </i></td>
    <td><a href="#http://ocamllabs.github.com/compiler-hacking/2013/10/30/third-compiler-hacking-session">Third OCaml compiler hacking session</a></td>
    <td>Compiler Hacking</td>
 </tr>

<tr>
    <td><i> Oct 28, 2013 </i></td>
    <td><a href="#http://amirchaudhry.com/fpdays-review">Review of the OCaml FPDays tutorial</a></td>
    <td>Amir Chaudhry</td>
 </tr>
</table>
<div class="channelgroup">
  <div class="entrygroup" id="http://hh360.user.srcf.net/blog/?p=832">
    <a name="#http://hh360.user.srcf.net/blog/?p=832"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/heidi.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://hh360.user.srcf.net/blog/?p=832">Part 2: Running your own DNS Resolver with MirageOS</a>
      (<a href="http://hh360.user.srcf.net/blog/category/pl/ocaml/feed/" title="Read, Write & Execute » OCaml">Heidi Howard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post1"><p>Last time, we wrote a simple &ldquo;dig like&rdquo; unikernel. Given a domain and the address of a nameserver, the unikernel resolved the domain&nbsp;by asking the nameserver and returned the return to the console.</p>
<p>Today, we will look at another way to resolve a DNS query, being a DNS server. This is useful in its own right but also allows us to cool things with our local DNS resolver such as locally overwriting DNS names and resolving .local names, both of which we will add to our DNS resolver another day.</p>
<p>Today&nbsp;we use features only added to ocaml-dns library in version 0.15 (currently <a href="https://github.com/mirage/ocaml-dns/pull/52">PR #52</a>), so if you do not have this version or later, then update OPAM or pin the master branch on github.</p>
<p>Building a DNS server with MirageOS is simple, look at the following code:</p>
<pre>open Lwt
open V1_LWT
open Dns
open Dns_server

let port = 53
let zonefile = &quot;test.zone&quot;

module Main (C:CONSOLE) (K:KV_RO) (S:STACKV4) = struct

  module U = S.UDPV4
  module DNS = Dns_server_mirage.Make(K)(S)

  let start c k s =
    &hellip;</pre><a onclick="switchContent('ocamlorg-post1','ocamlorg-post2')" class="btn planet-toggle" href="#http://hh360.user.srcf.net/blog/?p=832">Read more...</a></div><div id="ocamlorg-post2" style="display: none"><p>Last time, we wrote a simple &ldquo;dig like&rdquo; unikernel. Given a domain and the address of a nameserver, the unikernel resolved the domain&nbsp;by asking the nameserver and returned the return to the console.</p>
<p>Today, we will look at another way to resolve a DNS query, being a DNS server. This is useful in its own right but also allows us to cool things with our local DNS resolver such as locally overwriting DNS names and resolving .local names, both of which we will add to our DNS resolver another day.</p>
<p>Today&nbsp;we use features only added to ocaml-dns library in version 0.15 (currently <a href="https://github.com/mirage/ocaml-dns/pull/52">PR #52</a>), so if you do not have this version or later, then update OPAM or pin the master branch on github.</p>
<p>Building a DNS server with MirageOS is simple, look at the following code:</p>
<pre>open Lwt
open V1_LWT
open Dns
open Dns_server

let port = 53
let zonefile = &quot;test.zone&quot;

module Main (C:CONSOLE) (K:KV_RO) (S:STACKV4) = struct

  module U = S.UDPV4
  module DNS = Dns_server_mirage.Make(K)(S)

  let start c k s =
    let t = DNS.create s k in
    DNS.serve_with_zonefile t ~port ~zonefile
end
</pre>
<p>The above code will serve DNS requests to port 53, responding with the resource records (RR) in test.zone. We have provided an example zone file in the <a href="https://github.com/heidi-ann/ocaml-dns-examples">repo</a>&nbsp;with the code from this guide. To use this unikernel, we also need to edit the config.ml file from yesterday.</p>
<pre>open Mirage

let data = crunch &quot;./data&quot;

let handler =
  foreign &quot;Unikernel.Main&quot; (console @-&gt; kv_ro @-&gt; stackv4 @-&gt; job)

let ip_config:ipv4_config = {
  address= Ipaddr.V4.make 192 168 1 2;
  netmask= Ipaddr.V4.make 255 255 255 0;
  gateways= [Ipaddr.V4.make 192 168 1 1];
}

let direct =
  let stack = direct_stackv4_with_static_ipv4 default_console tap0 ip_config  in
  handler $ default_console $ data $ stack

let () =
  add_to_ocamlfind_libraries [&quot;dns.mirage&quot;;&quot;dns.lwt-core&quot;];
  add_to_opam_packages [&quot;dns&quot;];
  register &quot;dns&quot; [direct]
</pre>
<p>We are using crunch to access the zone file in the data directory. As explain in part 1, this config file is specific to my network setup for xen backends and can easily be generalised.</p>
<p>You can now test your DNS server and see it work</p>
<pre>$ dig @192.168.1.2 ns0.d1.signpo.st.</pre>
<p>&nbsp;</p>
<a onclick="switchContent('ocamlorg-post2','ocamlorg-post1')" class="btn planet-toggle" href="#http://hh360.user.srcf.net/blog/?p=832">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://hh360.user.srcf.net/blog/?p=832">by Heidi Howard at Mar 02, 2015 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://hh360.user.srcf.net/blog/?p=792">
    <a name="#http://hh360.user.srcf.net/blog/?p=792"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/heidi.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://hh360.user.srcf.net/blog/?p=792">Part 1: Running your own DNS Resolver with MirageOS</a>
      (<a href="http://hh360.user.srcf.net/blog/category/pl/ocaml/feed/" title="Read, Write & Execute » OCaml">Heidi Howard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post3"><p>The following is the first part in a step-by-step guide to setting up your own DNS resolver using MirageOS. I will be running this on a low power, low cost ARM device called the <a href="http://www.amazon.co.uk/Cubieboard-A20-chip-New-IT/dp/B00FB5ILQ4">Cubieboard 2</a>. Up to date code for each version of the DNS&nbsp;resolver is on G<a href="https://github.com/heidi-ann/ocaml-dns-examples">ithub</a>. This guide assumes some basic experience&nbsp;of <a href="http://ocsigen.org/lwt/2.4.7/api/index">lwt</a> and MirageOS, up to the level of the&nbsp;<a href="http://www.openmirage.org/wiki/hello-world">Hello World Tutorial</a>.</p>
<p>Feedback on this article and pull requests to the <a href="https://github.com/heidi-ann/ocaml-dns-examples">demo code</a>&nbsp;are welcome.</p>
<h4>Part&nbsp;1.1 &ndash; Setting up the cubieboard with MirageOS</h4>
<p>Plenty of information on setting up a cubieboard with Xen and MirageOS is available elsewhere, most notability:</p>
<ul>
<li>MirageOS <a href="http://www.openmirage.org/wiki/hello-world">Hello World Tutorial</a> &amp; <a href="https://github.com/mirage/mirage-skeleton">Code</a></li>
<li>Cubieboard2 Xen<a href="https://github.com/mirage/xen-arm-builder"> Binaries</a></li>
</ul>
<p>For debugging I am a big fan for wireshark. I run a full wireshark sesson on the machine which is connection sharing to my cubieboard network, to check all external traffic.</p>
<p>For this guide, I will always be compiling for Xen ARM backend, with direct network connection via br0 and a static IP for all unikernels. My test networ&hellip;</p><a onclick="switchContent('ocamlorg-post3','ocamlorg-post4')" class="btn planet-toggle" href="#http://hh360.user.srcf.net/blog/?p=792">Read more...</a></div><div id="ocamlorg-post4" style="display: none"><p>The following is the first part in a step-by-step guide to setting up your own DNS resolver using MirageOS. I will be running this on a low power, low cost ARM device called the <a href="http://www.amazon.co.uk/Cubieboard-A20-chip-New-IT/dp/B00FB5ILQ4">Cubieboard 2</a>. Up to date code for each version of the DNS&nbsp;resolver is on G<a href="https://github.com/heidi-ann/ocaml-dns-examples">ithub</a>. This guide assumes some basic experience&nbsp;of <a href="http://ocsigen.org/lwt/2.4.7/api/index">lwt</a> and MirageOS, up to the level of the&nbsp;<a href="http://www.openmirage.org/wiki/hello-world">Hello World Tutorial</a>.</p>
<p>Feedback on this article and pull requests to the <a href="https://github.com/heidi-ann/ocaml-dns-examples">demo code</a>&nbsp;are welcome.</p>
<h4>Part&nbsp;1.1 &ndash; Setting up the cubieboard with MirageOS</h4>
<p>Plenty of information on setting up a cubieboard with Xen and MirageOS is available elsewhere, most notability:</p>
<ul>
<li>MirageOS <a href="http://www.openmirage.org/wiki/hello-world">Hello World Tutorial</a> &amp; <a href="https://github.com/mirage/mirage-skeleton">Code</a></li>
<li>Cubieboard2 Xen<a href="https://github.com/mirage/xen-arm-builder"> Binaries</a></li>
</ul>
<p>For debugging I am a big fan for wireshark. I run a full wireshark sesson on the machine which is connection sharing to my cubieboard network, to check all external traffic.</p>
<p>For this guide, I will always be compiling for Xen ARM backend, with direct network connection via br0 and a static IP for all unikernels. My test network router is configured to give out static IP of the form 192.168.1.x to hosts&nbsp;with the MAC address 00:00:00:00:00:0x. As a result, my config.ml file look like:</p>
<pre>open Mirage

let ip_config:ipv4_config = {
  address= Ipaddr.V4.make 192 168 1 2;
  netmask= Ipaddr.V4.make 255 255 255 0;
  gateways= [Ipaddr.V4.make 192 168 1 1];
}

let client =
  foreign &quot;Unikernel.Client&quot; @@ console @-&gt; stackv4 @-&gt; job

let () =
  add_to_ocamlfind_libraries [ &quot;dns.mirage&quot;; ];
  register &quot;dns-client&quot; 
[ client $ default_console $ direct_stackv4_with_static_ipv4 default_console tap0 ip_config]
</pre>
<p>Since the IP address of the unikernel is 192.168.1.2, before launching the unikernel, I do:</p>
<pre>echo &quot;vif = [ 'mac=00:00:00:00:00:02,bridge=br0' ]&quot; &gt;&gt; dns-client.xl
</pre>
<p>I build unikernel using the usual commands:</p>
<pre>mirage configure --xen
make depend; make; make run
# edit file.xl
sudo xl create -c file.xl
</pre>
<h4>Part&nbsp;1.2 &ndash; Getting Started</h4>
<p>The following is the complete code for a unikernel which queries a DNS server for a DNS domain and prints to console the IP address returned.</p>
<pre>open Lwt
open V1_LWT

let domain = &quot;google.com&quot;
let server = Ipaddr.V4.make 8 8 8 8

module Client (C:CONSOLE) (S:STACKV4) = struct

  module U = S.UDPV4
  module DNS = Dns_resolver_mirage.Make(OS.Time)(S)

  let start c s =
    let t = DNS.create s in
    OS.Time.sleep 2.0 
    &gt;&gt;= fun () -&gt;
    C.log_s c (&quot;Resolving &quot; ^ domain)
    &gt;&gt;= fun () -&gt;
    DNS.gethostbyname t ~server domain
    &gt;&gt;= fun rl -&gt;
    Lwt_list.iter_s
      (fun r -&gt;
         C.log_s c (&quot;Answer &quot; ^ (Ipaddr.to_string r))
      ) rl

end
</pre>
<p>This unikernel will query a DNS server at 8.8.8.8 (google public DNS resolver) for a domain google.com. Here we are using the simple function, DNS.gethostbyname, with the following type sig:</p>
<pre>  val gethostbyname : t -&gt;
    ?server:Ipaddr.V4.t -&gt; ?dns_port:int -&gt;
    ?q_class:Dns.Packet.q_class -&gt;
    ?q_type:Dns.Packet.q_type -&gt;
    string -&gt; Ipaddr.t list Lwt.t
</pre>
<p>This returns a list of IP&rsquo;s, which we then iterative over with Lwt_list.iter_s and print to the console.</p>
<h4>Part&nbsp;1.3 &ndash;&nbsp;Boot time parameters</h4>
<p>Hardcoding the server and domain is far from ideal, instead we will provide them at boot time with Bootvar, the interface for bootvar is below:</p>
<pre>type t
(* read boot parameter line and store in assoc list - expected format is &quot;key1=val1 key2=val2&quot; *)
val create: unit -&gt; t Lwt.t

(* get boot parameter *)
val get: t -&gt; string -&gt; string option

(* get boot parameter, throws Not Found exception *)
val get_exn: t -&gt; string -&gt; string
</pre>
<p>We can now use this to provide domain and server at boot time instead of compile time</p>
<pre>let start c s =
    Bootvar.create () &gt;&gt;= fun bootvar -&gt;
    let domain = Bootvar.get_exn bootvar &quot;domain&quot; in
    let server = Ipaddr.V4.of_string_exn (Bootvar.get_exn bootvar &quot;server&quot;) in
    ...
</pre>
<h4>Part&nbsp;1.4 &ndash; Using Resolve</h4>
<p>Now, a real DNS resolver will need to make many more parameters (any DNS query) and return full DNS responses not just IP address. Thus we need to move on from DNS.hostbyname to using the less abstract resolve function, resolve:</p>
<pre>  val resolve :
    (module Dns.Protocol.CLIENT) -&gt;
    t -&gt; Ipaddr.V4.t -&gt; int -&gt;
    Dns.Packet.q_class -&gt;
    Dns.Packet.q_type -&gt;
    Dns.Name.domain_name -&gt;
    Dns.Packet.t Lwt.t 
</pre>
<p>We can achieve same result of hostbyname as follows:</p>
<pre>...
    DNS.resolve (module Dns.Protocol.Client) t server 53 Q_IN Q_A (string_to_domain_name domain)
    &gt;&gt;= fun r -&gt;
    let ips =
    List.fold_left (fun a x -&gt;
      match x.rdata with
      | A ip -&gt; (Ipaddr.V4 ip) :: a
      | _ -&gt; a ) [] r.answers in
...
</pre>
<p>We are now explicit about parameters such as port, class and type. Note that we have opened the <a href="https://github.com/mirage/ocaml-dns/blob/master/lib/name.mli">Dns.Name</a> and <a href="https://github.com/mirage/ocaml-dns/blob/master/lib/packet.mli">Dns.Packet.t</a> modules. The return value of resolve is a <a href="https://github.com/mirage/ocaml-dns/blob/master/lib/packet.mli">Dns.Packet.t</a>, we fold over answers in the produce an IPaddr.V4 list as with hostbyname. We can also use the to_string function in Packet to print</p>
<p>I&rsquo;ve taken a break to do some refactoring work on the ocaml-dns library. In the next post, Part 2, we will expand our code to a DNS stub resolver.</p>
<p>&nbsp;</p>
<a onclick="switchContent('ocamlorg-post4','ocamlorg-post3')" class="btn planet-toggle" href="#http://hh360.user.srcf.net/blog/?p=792">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://hh360.user.srcf.net/blog/?p=792">by Heidi Howard at Feb 18, 2015 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/announcing-bitcoin-pinata">
    <a name="#http://openmirage.org/blog/announcing-bitcoin-pinata"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/announcing-bitcoin-pinata">Smash the Bitcoin Pinata for fun and profit!</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          
      <p><a href="http://ownme.ipredator.se/"><img src="http://amirchaudhry.com/images/btc-pinata/btc-pinata.png" width="300px" style="float:right; padding: 10px"/></a></p>
<p>Last summer we announced the beta release of a clean-slate implementation of
TLS in pure OCaml, alongside a <a href="http://openmirage.org/blog/introducing-ocaml-tls">series of blog posts</a> that described
the libraries and the thinking behind them.  It took two hackers six months
&mdash; starting on <a href="https://goo.gl/maps/GpcQs">the beach</a> &mdash;  to get the stack to that point and
their <a href="https://tls.openmirage.org">demo server</a> is still going strong. Since then, the team has
continued working and recently <a href="http://media.ccc.de/browse/congress/2014/31c3_-_6443_-_en_-_saal_2_-_201412271245_-_trustworthy_secure_modular_operating_system_engineering_-_hannes_-_david_kaloper.html#video">presented</a> at the 31st Chaos
Communication Congress.</p>
<p>The authors are putting their stack to the test again and this time they've
built a <strong><a href="http://ownme.ipredator.se">Bitcoin Pi&ntilde;ata</a></strong>! Essentially, they've hidden a
private key to a bitcoin address within a Unikernel running on Xen. If you're
able to smash your way in, then you get to keep the spoils.</p>
<p>There's more context around this in my <a href="http://amirchaudhry.com/bitcoin-pinata/">Pi&ntilde;ata post</a> and you can see
the details on the <a href="http://ownme.ipredator.se">site itself</a>. Remember that the codebase is
<a href="https://github.com/mirleft/">all open</a> (as well as <a href="https://github.com/mirleft/ocaml-tls/issues?q=label:%22security%20concern%22%20">issues</a>) so there's nothing to
reverse engineer. Have fun!</p>

   
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/announcing-bitcoin-pinata">by Amir Chaudhry at Feb 10, 2015 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://ocamllabs.github.com/compiler-hacking/2015/02/05/back-in-the-lab">
    <a name="#http://ocamllabs.github.com/compiler-hacking/2015/02/05/back-in-the-lab"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../images/hax0ring.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://ocamllabs.github.com/compiler-hacking/2015/02/05/back-in-the-lab">Ninth OCaml compiler hacking evening (back in the lab, with a talk from Oleg)</a>
      (<a href="http://ocamllabs.github.io/compiler-hacking/rss.xml" title="OCaml Labs compiler hacking">Compiler Hacking</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post5"><p>We'll be meeting in the Computer Lab next Tuesday (10th February 2015) for another evening of compiler hacking.  All welcome!  Please <strong><a href="http://doodle.com/zxmeyn2ih92mke85">add yourself to the Doodle poll</a></strong> if you're planning to come along, and sign up to the <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking">mailing list</a> to receive updates.</p>

<h3>Talk: Generating code with polymorphic let (Oleg Kiselyov)</h3>

<p>This time we'll be starting with a talk from <a href="http://okmij.org/ftp">Oleg Kiselyov</a>:</p>

<blockquote>
<h4>Generating code with polymorphic let</h4>

<p>One of the simplest ways of implementing staging is source-to-source
translation from the quotation-unquotation code to code-generating
combinators. For example, MetaOCaml could be implemented as a
pre-processor to the ordinary OCaml. However simple, the approach is
surprising productive and extensible, as Lightweight Modular Staging
(LMS) in Scala has demonstrated. However, there is a fatal flaw:
handling quotations that contain polymorphic let. The translation to
code-generating combinators represents a future-stage let-binding with
the present-staging lambda-binding, which is m&hellip;</p></blockquote><a onclick="switchContent('ocamlorg-post5','ocamlorg-post6')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2015/02/05/back-in-the-lab">Read more...</a></div><div id="ocamlorg-post6" style="display: none"><p>We'll be meeting in the Computer Lab next Tuesday (10th February 2015) for another evening of compiler hacking.  All welcome!  Please <strong><a href="http://doodle.com/zxmeyn2ih92mke85">add yourself to the Doodle poll</a></strong> if you're planning to come along, and sign up to the <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking">mailing list</a> to receive updates.</p>

<h3>Talk: Generating code with polymorphic let (Oleg Kiselyov)</h3>

<p>This time we'll be starting with a talk from <a href="http://okmij.org/ftp">Oleg Kiselyov</a>:</p>

<blockquote>
<h4>Generating code with polymorphic let</h4>

<p>One of the simplest ways of implementing staging is source-to-source
translation from the quotation-unquotation code to code-generating
combinators. For example, MetaOCaml could be implemented as a
pre-processor to the ordinary OCaml. However simple, the approach is
surprising productive and extensible, as Lightweight Modular Staging
(LMS) in Scala has demonstrated. However, there is a fatal flaw:
handling quotations that contain polymorphic let. The translation to
code-generating combinators represents a future-stage let-binding with
the present-staging lambda-binding, which is monomorphic. Even if
polymorphic lambda-bindings are allowed, they require type
annotations, which precludes the source-to-source translation.</p>

<p>We show the solution to the problem, using a different translation. It
works with the current OCaml. It also almost works in theory,
requiring a small extension to the relaxed value
restriction. Surprisingly, this extension seems to be exactly the one
needed to make the value restriction sound in a staged language with
reference cells and cross-stage-persistence.</p>

<p>The old, seems completely settled question of value restriction is
thrown deep-open in staged languages. We gain a profound problem to
work on.</p>
</blockquote>

<h3>(Approximate) schedule</h3>

<p><strong>6pm</strong> Start, set up<br/>
<strong>6.30pm</strong> Talk<br/>
<strong>7pm</strong> Pizza<br/>
<strong>7.30pm-10pm</strong> Compiler hacking  </p>

<h3>Further details</h3>

<p><strong>Where</strong>:
  Room <a href="http://www.cl.cam.ac.uk/research/dtg/openroommap/static/?s=FW11&amp;amp%3Blabels=1">FW11</a>, <a href="http://www.cl.cam.ac.uk/directions/">Computer Laboratory, Madingley Road</a></p>

<p><strong>When</strong>: 6pm, Tuesday 10th February</p>

<p><strong>Who</strong>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><strong>What</strong>: fixing bugs, implementing new features, learning about OCaml internals.</p>

<p><strong>Wiki</strong>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-projects</a> for various levels of experience (see also some <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-previously-worked-on">things we've done on previous evenings</a>), but feel free to come along and work on whatever you fancy.</p>

<p>We'll be ordering pizza, so if you want to be counted for food you should aim to arrive by 6pm.</p>
<a onclick="switchContent('ocamlorg-post6','ocamlorg-post5')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2015/02/05/back-in-the-lab">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://ocamllabs.github.com/compiler-hacking/2015/02/05/back-in-the-lab">by Compiler Hacking at Feb 05, 2015 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2015/01/21/securing-the-unikernel/">
    <a name="#http://roscidus.com/blog/blog/2015/01/21/securing-the-unikernel/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2015/01/21/securing-the-unikernel/">Securing the Unikernel</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post7"><p>Back in July, I used <a href="http://openmirage.org/">MirageOS</a> to create <a href="http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">my first unikernel</a>, a simple REST service for queuing file uploads, deployable as a virtual machine.
While a traditional VM would be a complete Linux system (kernel, init system, package manager, shell, etc), a Mirage unikernel is a single OCaml program which pulls in just the features (network driver, TCP stack, web server, etc) it needs as libraries.
Now it&rsquo;s time to look at securing the system with HTTPS and access controls, ready for deployment.</p>



<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#introduction">Introduction</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#ocaml">OCaml</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#xen">Xen</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#transport-layer-security">Transport Layer Security</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#c-stubs-for-xen">C stubs for Xen</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#ethernet-frame-alignment">Ethernet frame alignment</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#http-api">HTTP API</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-private-key">The private key</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-partition-code">The partition code</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#entropy">Entropy</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#access-control">Access control</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#python-client">Python client</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#conclusions">Conclusions</a></li>
</ul>

<p>( this post also appeared on <a href="https://news.ycombinator.com/item?id=8922568">Hacker News</a> and
  <a href="http://www.reddit.com/r/netsec/comments/2t67e2/securing_the_unikernel/">Reddit</a> )</p>

<h2>Introduction</h2>

<p>As a quick reminder, the service (&ldquo;Incoming queue&rdquo;) accepts uploads from various contributors and queues them until the (firewalled) repository &hellip;</p><a onclick="switchContent('ocamlorg-post7','ocamlorg-post8')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2015/01/21/securing-the-unikernel/">Read more...</a></div><div id="ocamlorg-post8" style="display: none"><p>Back in July, I used <a href="http://openmirage.org/">MirageOS</a> to create <a href="http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">my first unikernel</a>, a simple REST service for queuing file uploads, deployable as a virtual machine.
While a traditional VM would be a complete Linux system (kernel, init system, package manager, shell, etc), a Mirage unikernel is a single OCaml program which pulls in just the features (network driver, TCP stack, web server, etc) it needs as libraries.
Now it&rsquo;s time to look at securing the system with HTTPS and access controls, ready for deployment.</p>



<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#introduction">Introduction</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#ocaml">OCaml</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#xen">Xen</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#transport-layer-security">Transport Layer Security</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#c-stubs-for-xen">C stubs for Xen</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#ethernet-frame-alignment">Ethernet frame alignment</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#http-api">HTTP API</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-private-key">The private key</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-partition-code">The partition code</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#entropy">Entropy</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#access-control">Access control</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#python-client">Python client</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#conclusions">Conclusions</a></li>
</ul>

<p>( this post also appeared on <a href="https://news.ycombinator.com/item?id=8922568">Hacker News</a> and
  <a href="http://www.reddit.com/r/netsec/comments/2t67e2/securing_the_unikernel/">Reddit</a> )</p>

<h2>Introduction</h2>

<p>As a quick reminder, the service (&ldquo;Incoming queue&rdquo;) accepts uploads from various contributors and queues them until the (firewalled) repository software downloads them, checks the GPG signatures, and merges them into the public software repository, signed with the repository&rsquo;s key:</p>

<p><img src="http://roscidus.com/blog/images/0repo-multi.png" class="center"/></p>

<p>Although the queue service isn&rsquo;t security critical, since the GPG signatures are made and checked elsewhere, I would like to ensure it has a few properties:</p>

<ul>
  <li>Only the repository can fetch items from the queue.</li>
  <li>Only authorised users can upload to it.</li>
  <li>I can see where an upload came from and revoke access if necessary.</li>
  <li>An attacker cannot take control of the system and use it to attack other systems.</li>
</ul>

<p>We often think of security as a set of things we want to <em>prevent</em> - taking away possible actions from a fundamentally vulnerable underlying system (such as my original implementation, which had no security features).
But ideally I&rsquo;d like every component of the system to be isolated by default, with allowed interactions (shown here by arrows) specified explicitly.
We should then be able to argue (informally) that the system will meet the goals above without having to verify that every line of code is correct.</p>

<p>My unikernel is written in OCaml and runs as a guest OS under the Xen hypervisor, so let&rsquo;s look at how well those technologies support isolation first&hellip;</p>

<h2>OCaml</h2>

<p>I want to isolate the components of my unikernel, giving each just the access it requires.
When writing an OS, some unsafe code will occasionally be needed, but it should be clear which components use unsafe features (so they can be audited more carefully), and unsafe features shouldn&rsquo;t be needed often.</p>

<p>For example, the code for handling an HTTP upload request should only be able to use our on-disk queue&rsquo;s <a href="https://github.com/0install/0repo-queue/blob/6ff713d353316447eda66b310adc42634accf98a/upload_queue.mli#L22">Uploader interface</a> and its own HTTP connection.
Then we would know that an attacker with upload permission can only cause new items to be added to the queue, no matter how buggy that code is.
It should not be able to read the web server&rsquo;s private key, establish new out-bound connections, corrupt the disk, etc.</p>

<p>Like most modern languages, OCaml is memory-safe, so components can&rsquo;t interfere with each other through buggy pointer arithmetic or unsafe casts of the kind commonly found in C code.</p>

<p>But we also need to avoid global variables, which would allow two components to communicate without us explicitly connecting them.
I can&rsquo;t reason about the security of the system by looking at arrows in the architecture diagrams if unconnected components can magically create new arrows by themselves!
I&rsquo;ve seen a few interesting approaches to this problem (please correct me if I&rsquo;ve got this wrong):</p>

<dl>
  <dt>Haskell</dt>
  <dd>Haskell avoids all side-effects, which makes global variables impossible (without using &ldquo;unsafe&rdquo; features), since updating them would be a side-effect.</dd>
  <dt>Rust</dt>
  <dd>Rust almost avoids the problem of globals through its ownership types.
Since only one thread can have a pointer to a mutable value at a time, mutable values can&rsquo;t normally be global.
Rust does allow &ldquo;mutable statics&rdquo; (which contain only pointers to fixed data), but requires an explicit &ldquo;unsafe&rdquo; block to use them, which is good.</dd>
  <dt>E</dt>
  <dd>E allows modules to declare top-level variables, but each time the module is imported it creates a fresh copy.</dd>
</dl>

<p>OCaml does allow global variables, but by convention they are generally not used.</p>

<p>A second problem is controlling access to the outside world, including the network and disks (which you could consider to be more global variables):</p>

<dl>
  <dt>Haskell</dt>
  <dd>Haskell doesn&rsquo;t allow functions to access the outside world at all, but they can return an <code>IO</code> type if they want to do something (the caller must then pass this value up to the top level).
This makes it easy to see that e.g. evaluating a function &ldquo;<code>uriPath :: URI -&gt; String</code>&rdquo; cannot access the network.
However, it appears that all IO gets lumped in together: a value of type <code>IO String</code> may cause any side-effects at all (disk, network, etc), so the entire side-effecting part of the program needs to be audited.</dd>
  <dt>Rust</dt>
  <dd>Rust allows all code full access to the system via its standard library.
For example, any code can read or write any file.</dd>
  <dt>E</dt>
  <dd>E passes all access to the outside world to the program&rsquo;s entry point.
For example, <code>&lt;file&gt;</code> grants access to the file system and <code>&lt;unsafe&gt;</code> grants access to all unsafe features.
These can be passed to libraries to grant them access, and can be attenuated (wrapped) to provide limited access.</dd>
</dl>

<p>For example:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>main.e </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">def</span> <span class="n">queue</span> <span class="o">:=</span> <span class="o">&lt;</span><span class="nl">import:</span><span class="n">makeQueue</span><span class="o">&gt;(&lt;</span><span class="nl">file:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">myprog</span><span class="o">/</span><span class="n">queue</span><span class="o">&gt;)</span>
</span><span class="line"><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here, <code>queue</code> has read-write access to the <code>/var/myprog/queue</code> sub-tree (and nothing else).
It also has no way to share data with any other parts of the program, including other queues.</p>

<p>Like Rust, OCaml does not limit access to the outside world.
However, Mirage itself uses E-style dependency injection everywhere, with the unikernel&rsquo;s <code>start</code> function being passed all external resources as arguments:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>unikernel.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">Main</span> <span class="o">(</span><span class="nc">C</span> <span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">CONSOLE</span><span class="o">)</span>
</span><span class="line">            <span class="o">(</span><span class="nc">B</span> <span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">BLOCK</span><span class="o">)</span>
</span><span class="line">            <span class="o">(</span><span class="nc">H</span> <span class="o">:</span> <span class="nn">Cohttp_lwt</span><span class="p">.</span><span class="nc">Server</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">struct</span>
</span><span class="line">    <span class="k">module</span> <span class="nc">Q</span> <span class="o">=</span> <span class="nn">Upload_queue</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">B</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="n">start</span> <span class="n">console</span> <span class="n">block</span> <span class="n">http</span> <span class="o">=</span>
</span><span class="line">      <span class="n">lwt</span> <span class="n">queue</span> <span class="o">=</span> <span class="nn">Q</span><span class="p">.</span><span class="n">create</span> <span class="n">block</span> <span class="k">in</span>
</span><span class="line">      <span class="o">...</span>
</span><span class="line">  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Because everything in Mirage is defined using abstract types, libraries always expect to be passed the things they need explicitly.
We know that <code>Upload_queue</code> above won&rsquo;t access a block device directly because it needs to support different kinds of block device.</p>

<p>OCaml <em>does</em> enforce its abstractions.
There&rsquo;s no way for the <code>Upload_queue</code> to discover that <code>block</code> is really a Xen block device with some extra functionality
(as a Java program might do with <code>if (block instanceof XenBlock)</code>, for example).
This means that we can reason about the limits of what functions may do by looking only at their type signatures.</p>

<p>The use of functors means you can attenuate access as desired.
For example, if we want to grant just part of <code>block</code> to the queue then we can create our own module implementing the <code>BLOCK</code> type that exposes just some partition of the device, and pass that to the <code>Upload_queue.Make</code> functor.</p>

<p>In summary then, we can reason about security fairly well in Mirage if we assume the libraries are not malicious, but we cannot make hard guarantees.
It should be possible to check with automatic static analysis that we&rsquo;re not using any &ldquo;unsafe&rdquo; features such as global variables, direct access to devices, or allocating uninitialised memory, but I don&rsquo;t know of any tools to do that (except <a href="http://www.skyhunter.com/marcs/emilyWalnut.html">Emily</a>, but that seems to be just a proof-of-concept).
But these issues are minor: any reasonably safe modern language will be a huge improvement over legacy C or C++ systems!</p>

<h2>Xen</h2>

<p>The Xen hypervisor allows multiple guest operating systems to run on a single physical machine.
It is used by many cloud hosting providers, including Amazon&rsquo;s AWS.
I run it on my CubieTruck - a small ARM board.
Xen allows me to run my unikernel on the same machine as other services, but ideally with the same security properties as if it had its own dedicated machine.
If some other guest on the machine is compromised, it shouldn&rsquo;t affect my unikernel, and if the unikernel is compromised then it shouldn&rsquo;t affect other guests.</p>

<p><span class="caption-wrapper center"><img src="http://roscidus.com/blog/images/xen.png" class="caption" width="" height="" title="A typical Xen deployment, running four domains."/><span class="caption-text">A typical Xen deployment, running four domains.</span></span></p>

<p>The diagram above shows a deployment with Linux and Mirage guests. Only dom0 has access to the physical hardware; the other guests only see virtual devices, provided by dom0.</p>

<p>How secure is Xen?
The <a href="http://xenbits.xen.org/xsa/">Xen security advisories</a> page shows that there are about 3 new Xen advisories each month.
However, it&rsquo;s hard to compare programs this way because the number of vulnerabilities reported depends greatly on the number of people using the program, whether they use it for security-critical tasks, and how seriously the project takes problems (e.g. whether a denial-of-service attack is considered a security bug).</p>

<p>I started using Xen in April 2014.
These are the security problems I&rsquo;ve found myself so far:</p>

<dl>
  <dt><a href="http://xenbits.xen.org/xsa/advisory-93.html">XSA-93</a> Hardware features unintentionally exposed to guests on ARM</dt>
  <dd>While trying to get Mini-OS to boot, I tried implementing ARM&rsquo;s recommended boot code for invalidating the cache
(at startup, you should invalidate the cache, dropping any previous contents).
When running under a hypervisor this should be a null-op since the cache is always valid by the time a guest is running, but Xen allowed the operation to go ahead, discarding pending writes by the hypervisor and other guests and crashing the system.
This could probably be used for a successful attack.</dd>
  <dt><a href="http://xenbits.xen.org/xsa/advisory-94.html">XSA-94</a> : Hypervisor crash setting up GIC on arm32</dt>
  <dd>I tried to program an out-of-range register, causing the hypervisor to dereference a null pointer and panic.
This is just a denial of service (the host machine needs to be rebooted); it shouldn&rsquo;t allow access to other VMs.</dd>
  <dt><a href="http://xenbits.xen.org/xsa/advisory-95.html">XSA-95</a> : Input handling vulnerabilities loading guest kernel on ARM</dt>
  <dd>I got the length wrong when creating the zImage for the unikernel (I included the .bss section in the length).
The <code>xl create</code> tool didn&rsquo;t notice and tried to read the extra data, causing the tool to segfault.
You could use this to read a bit of private data from the <code>xl</code> process, but it&rsquo;s unlikely there would be anything useful there.</dd>
</dl>

<p>Although that&rsquo;s more bugs than you might expect, note that they&rsquo;re all specific to the relatively new ARM support.
The second and third are both due to using C, and would have been avoided in a safer language.
I&rsquo;m not really sure why the &ldquo;xl&rdquo; tool needs to be in C - that seems to be asking for trouble.</p>

<p>To drive the physical hardware, Xen runs the first guest (dom0) with access to everything.
This is usually Linux, and I had various problems with that. For example:</p>

<dl>
  <dt><a href="http://lists.xen.org/archives/html/xen-devel/2014-08/msg00053.html">Bug sharing the same page twice</a></dt>
  <dd>Linux got confused when the unikernel shared the same page twice (it split a single page of RAM into multiple TCP segments).
This wasn&rsquo;t a security bug (I think), but after it was fixed, I then got:</dd>
  <dt><a href="http://lists.xen.org/archives/html/xen-devel/2014-08/msg00596.html">Page still granted</a></dt>
  <dd>If my unikernel sent a network packet and then exited quickly, dom0 would get stuck and I&rsquo;d have to reboot.</dd>
  <dt><a href="https://github.com/talex5/linux/commit/6b6dcc2857d84070c94fe4e3498486337d292870">Oops if network is used too quickly</a></dt>
  <dd>The Linux dom0 initialises the virtual network device while the VM is booting.
My unikernel booted fast enough to send packets before the device structure had been fully filled in, leading to an oops.</dd>
  <dt><a href="http://lists.xen.org/archives/html/xen-devel/2014-09/msg02254.html">Linux Dom0 oops and reboot on indirect block requests</a></dt>
  <dd>Sending lots of block device requests to Linux dom0 from the unikernel would cause Linux to oops in <code>swiotlb_tbl_unmap_single</code> and reboot the host.
I wasn&rsquo;t the first to find this though, and backporting the patch from Linux 3.17 seemed to fix it (I don&rsquo;t actually know what the problem was).</dd>
</dl>

<p>So it might seem that using Xen doesn&rsquo;t get us very far.
We&rsquo;re still running Linux in dom0, and it still has full access to the machine.
For example, a malicious network packet from outside or from a guest might still give an attacker full control of the machine.
Why not just use <a href="http://www.linux-kvm.org/">KVM</a> and run the guests under Linux directly?</p>

<p>The big (potential) advantage of Xen here is <a href="http://wiki.xen.org/wiki/Dom0_Disaggregation">Dom0 Disaggregation</a>.
With this, Dom0 gives control of different pieces of physical hardware to different VMs rather than driving them itself.
For example, <a href="https://wiki.qubes-os.org/">Qubes</a> (a security-focused desktop OS using Xen) runs a separate &ldquo;<a href="https://wiki.qubes-os.org/wiki/QubesNet">NetVM</a>&rdquo; Linux guest just to handle the network device.
This is connected only to the <a href="https://qubes-os.org/wiki/QubesFirewall">FirewallVM</a> - another Linux guest that just routes packets to other VMs.</p>

<p>This is interesting for two reasons.
First, if an attacker exploits a bug in the network device driver, they&rsquo;re still outside your firewall.
Secondly, it provides a credible path to replacing parts of Linux with alternative implementations, possibly written in safer languages.
You could, for example, have Linux running dom0 but use FreeBSD to drive the network card, Mirage to provide the firewall, and OpenBSD to handle USB.</p>

<p>Finally, it&rsquo;s worth noting that Mirage is not tied to Xen, but can target various systems (mainly Unix and Xen currently, but there is some JavaScript support too).
If it turns out that e.g. <a href="http://genode.org/about/challenges">Genode on seL4</a> (a formally verified microkernel) provides better security, we should be able to support that too.</p>

<h2>Transport Layer Security</h2>

<p>We won&rsquo;t get far securing the system while attackers can read and modify our communications.
The <a href="https://github.com/mirleft/ocaml-tls/">ocaml-tls</a> project provides an OCaml implementation of TLS (<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Layer Security</a>), and
in September <a href="http://lists.xenproject.org/archives/html/mirageos-devel/2014-09/msg00100.html">Hannes Mehnert showed it running on Mirage/Xen/ARM devices</a>.
Given the various flaws exposed recently in popular C TLS libraries, an OCaml implementation is very welcome.
Getting the Xen support in a state where it could be widely used took a bit of work, but
I&rsquo;ve submitted all the patches I made, so it should be easier for other people now - see <a href="https://github.com/mirage/mirage-dev/pull/52">https://github.com/mirage/mirage-dev/pull/52</a>.</p>

<h3>C stubs for Xen</h3>

<p>TLS needs some C code for the low-level cryptographic functions, which have to be constant time to avoid leaking information about the key, so first I had to make packages providing versions of libgmp, ctypes, zarith and nocrypto compiled to run in kernel mode.</p>

<p>The reason you need to compile C programs specially to run in kernel mode is because on x86 processors user mode code can assume the existence of a <a href="http://en.wikipedia.org/wiki/Red_zone_(computing)">red zone</a>, which allows some optimisations that aren&rsquo;t safe in kernel mode.</p>

<h3>Ethernet frame alignment</h3>

<p>The Mirage network driver sends Ethernet frames to dom0 by sharing pages of memory.
Each frame must therefore be contained in a single page.
The TLS code was (correctly) passing a large buffer to the TCP layer, which <a href="http://lists.xenproject.org/archives/html/mirageos-devel/2015-01/msg00029.html">incorrectly</a> asked the network device to send each TCP-sized chunk of it.
Chunks overlapping page boundaries then got rejected.</p>

<p>My previous experiments with <a href="http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad/#udp-transmission">tracing the network layer</a> had shown that we actually share two pages for each packet: one for the IP header and one for the payload.
Doing this avoids the need to copy the data to a new buffer, but adds the overhead of granting and revoking access to both pages.
I modified the network driver to copy the data into a single block inside a single page and got <a href="https://github.com/mirage/mirage-net-xen/pull/17">a large speed boost</a>.
Indeed, it got so much faster that it triggered <a href="https://github.com/mirage/mirage-net-xen/pull/16">a bug handling full transmit buffers</a> - which made it initially appear slower!</p>

<p>In addition to fixing the alignment problem when using TLS, and being faster, this has a nice security benefit:
the only data shared with the network driver domain is data explicitly sent to it.
Before, we had to share the entire page of memory containing the application&rsquo;s buffer, and there was no way to know what else might have been there.
This offers some protection if the network driver domain is compromised.</p>

<h3>HTTP API</h3>

<p>My original code configured a plain HTTP server on port 8080 like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>config.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="o">...</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">server</span> <span class="o">=</span>
</span><span class="line">  <span class="n">http_server</span> <span class="o">(`</span><span class="nc">TCP</span> <span class="o">(`</span><span class="nc">Port</span> <span class="mi">8080</span><span class="o">))</span> <span class="o">(</span><span class="n">conduit_direct</span> <span class="o">(</span><span class="n">stack</span> <span class="n">default_console</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">register</span> <span class="s2">&quot;queue&quot;</span> <span class="o">[</span>
</span><span class="line">    <span class="n">queue</span> <span class="o">$</span> <span class="n">default_console</span> <span class="o">$</span> <span class="n">storage</span> <span class="o">$</span> <span class="n">server</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>stack</code> creates TCP/IP stack.
<code>conduit_direct</code> can dynamically select different transports (e.g. http or vchan).
<code>http_server</code> applies the configuration to the conduit to get an HTTP server using plain HTTP.</p>

<p>I added support to <code>Conduit_mirage</code> to let it wrap any underlying conduit with TLS.
However, the configuration needed for TLS is fairly complicated, and involves a secret key which must be protected.
Therefore, I switched to creating only the <code>conduit</code> in <code>config.ml</code> and having the unikernel itself load the key and certificate by copying a local &ldquo;keys&rdquo; directory into the unikernel image as a &ldquo;crunch&rdquo; filesystem:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>config.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">conduit</span> <span class="o">=</span> <span class="n">conduit_direct</span>
</span><span class="line">    <span class="o">~</span><span class="n">tls</span><span class="o">:(</span><span class="n">tls_over_conduit</span> <span class="n">default_entropy</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="n">stack</span> <span class="n">default_console</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">register</span> <span class="s2">&quot;queue&quot;</span> <span class="o">[</span>
</span><span class="line">    <span class="n">queue</span> <span class="o">$</span> <span class="n">default_console</span> <span class="o">$</span> <span class="n">storage</span> <span class="o">$</span> <span class="n">conduit</span> <span class="o">$</span> <span class="n">crunch</span> <span class="s2">&quot;keys&quot;</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>unikernel.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line">    <span class="k">let</span> <span class="n">start</span> <span class="n">c</span> <span class="n">b</span> <span class="n">conduit</span> <span class="n">kv</span> <span class="o">=</span>
</span><span class="line">      <span class="n">lwt</span> <span class="n">certificate</span> <span class="o">=</span> <span class="nn">X509</span><span class="p">.</span><span class="n">certificate</span> <span class="n">kv</span> <span class="o">`</span><span class="nc">Default</span> <span class="k">in</span>
</span><span class="line">      <span class="k">let</span> <span class="n">tls_config</span> <span class="o">=</span> <span class="nn">Tls</span><span class="p">.</span><span class="nn">Config</span><span class="p">.</span><span class="err">(</span><span class="n">of_server</span> <span class="o">(</span><span class="n">server</span> <span class="o">~</span><span class="n">certificate</span> <span class="bp">()</span><span class="o">))</span> <span class="k">in</span>
</span><span class="line">      <span class="k">let</span> <span class="n">http</span> <span class="n">spec</span> <span class="o">=</span>
</span><span class="line">        <span class="k">let</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">conduit</span> <span class="k">in</span>
</span><span class="line">        <span class="k">let</span> <span class="n">mode</span> <span class="o">=</span> <span class="o">`</span><span class="nc">TLS</span> <span class="o">(</span><span class="n">tls_config</span><span class="o">,</span> <span class="o">`</span><span class="nc">TCP</span> <span class="o">(`</span><span class="nc">Port</span> <span class="mi">8443</span><span class="o">))</span> <span class="k">in</span>
</span><span class="line">        <span class="nn">Conduit</span><span class="p">.</span><span class="n">serve</span> <span class="o">~</span><span class="n">ctx</span> <span class="o">~</span><span class="n">mode</span> <span class="o">(</span><span class="nn">H</span><span class="p">.</span><span class="n">listen</span> <span class="n">spec</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">      <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This runs a secure HTTPS server on port 8443.
The rest of the code is as before.</p>

<h3>The private key</h3>

<p>The next question is where to store the real private key.
The examples provided by the TLS package compile it into the unikernel image using crunch, but it&rsquo;s common to keep unikernel binaries in Git repositories and people don&rsquo;t expect kernel images to contain secrets.
In a traditional Linux system, we&rsquo;d store the private key on the disk, so I decided to try the same here.
(I did think about storing the key encrypted in the unikernel and storing the password on the disk so you&rsquo;d need both to get the key, but the TLS library doesn&rsquo;t support encrypted keys yet.)</p>

<p>I don&rsquo;t use a regular filesystem for my queuing service, and I wouldn&rsquo;t want to share it with the key if I did, so instead I reserved a separate 4KB partition of the disk for the key.
It turned out that Mirage already has partitioning support in the form of the <a href="https://github.com/mirage/ocaml-mbr">ocaml-mbr</a> library.
I didn&rsquo;t actually create an MBR at the start, but just used the <a href="https://github.com/talex5/ocaml-mbr/blob/master/lib/mbr_partition.mli"><code>Mbr_partition</code></a> functor to wrap the underlying block device into two parts.
The configuration looks like this:</p>

<p><img src="http://roscidus.com/blog/images/queue-baseline.png" class="border center"/></p>

<p>How safe is this?
I don&rsquo;t want to audit all the code for handling the queue, and I shouldn&rsquo;t have to: we can see from the diagram that the only components with access to the key are the disk, the partitions and the TLS library.
We need to trust that the TLS library will protect the key (not easy, but that&rsquo;s its job) and that <code>queue_partition</code> won&rsquo;t let <code>queue</code> access the part of the disk with the key.</p>

<p>We also need to trust the disk, but if the partitions are only allowing correct requests through, that shouldn&rsquo;t be too much to ask.</p>

<h3>The partition code</h3>

<p>Before relying on the partition code, we&rsquo;d better take a look at it because it may not be designed to enforce security.
Indeed, a quick look at the code shows that it isn&rsquo;t:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line">  <span class="k">let</span> <span class="n">read</span> <span class="n">t</span> <span class="n">start_sector</span> <span class="n">buffers</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="n">length</span> <span class="o">=</span> <span class="nn">Int64</span><span class="p">.</span><span class="n">add</span> <span class="n">start_sector</span> <span class="o">(</span><span class="n">length</span> <span class="n">buffers</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">    <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">length_sectors</span>
</span><span class="line">    <span class="k">then</span> <span class="n">return</span> <span class="o">(`</span><span class="nc">Error</span> <span class="o">(`</span><span class="nc">Unknown</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;read %Ld %Ld out of range&quot;</span> <span class="n">start_sector</span> <span class="n">length</span><span class="o">)))</span>
</span><span class="line">    <span class="k">else</span> <span class="nn">B</span><span class="p">.</span><span class="n">read</span> <span class="n">t</span><span class="o">.</span><span class="n">b</span> <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">add</span> <span class="n">start_sector</span> <span class="n">t</span><span class="o">.</span><span class="n">start_sector</span><span class="o">)</span> <span class="n">buffers</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">write</span> <span class="n">t</span> <span class="n">start_sector</span> <span class="n">buffers</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="n">length</span> <span class="o">=</span> <span class="nn">Int64</span><span class="p">.</span><span class="n">add</span> <span class="n">start_sector</span> <span class="o">(</span><span class="n">length</span> <span class="n">buffers</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">    <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">length_sectors</span>
</span><span class="line">    <span class="k">then</span> <span class="n">return</span> <span class="o">(`</span><span class="nc">Error</span> <span class="o">(`</span><span class="nc">Unknown</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;write %Ld %Ld out of range&quot;</span> <span class="n">start_sector</span> <span class="n">length</span><span class="o">)))</span>
</span><span class="line">    <span class="k">else</span> <span class="nn">B</span><span class="p">.</span><span class="n">write</span> <span class="n">t</span><span class="o">.</span><span class="n">b</span> <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">add</span> <span class="n">start_sector</span> <span class="n">t</span><span class="o">.</span><span class="n">start_sector</span><span class="o">)</span> <span class="n">buffers</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It checks only that the requested start sector plus the length of the results buffer is less than the length of the partition.
To (hopefully) make this bullet-proof, I:</p>

<ul>
  <li>moved the checks into a single function so we don&rsquo;t have to check two copies,</li>
  <li>added a check that the start sector isn&rsquo;t negative,</li>
  <li>modified the end check to avoid integer overflow, and</li>
  <li>added some unit-tests.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line">  <span class="k">let</span> <span class="n">adjust_start</span> <span class="n">name</span> <span class="n">op</span> <span class="n">t</span> <span class="n">start_sector</span> <span class="n">buffers</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="n">buffers_len_sectors</span> <span class="o">=</span> <span class="n">length</span> <span class="n">t</span> <span class="n">buffers</span> <span class="k">in</span>
</span><span class="line">    <span class="k">if</span> <span class="n">start_sector</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="n">L</span> <span class="o">||</span>
</span><span class="line">       <span class="n">start_sector</span> <span class="o">&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">length_sectors</span> <span class="o">--</span> <span class="n">buffers_len_sectors</span>
</span><span class="line">    <span class="k">then</span> <span class="n">return</span> <span class="o">(`</span><span class="nc">Error</span> <span class="o">(`</span><span class="nc">Unknown</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span>
</span><span class="line">      <span class="s2">&quot;%s %Ld+%Ld out of range&quot;</span> <span class="n">name</span> <span class="n">start_sector</span> <span class="n">buffers_len_sectors</span><span class="o">)))</span>
</span><span class="line">    <span class="k">else</span> <span class="n">op</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">b</span> <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">add</span> <span class="n">start_sector</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">start_sector</span><span class="o">)</span> <span class="n">buffers</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">read</span> <span class="o">=</span> <span class="n">adjust_start</span> <span class="s2">&quot;read&quot;</span> <span class="nn">B</span><span class="p">.</span><span class="n">read</span>
</span><span class="line">  <span class="k">let</span> <span class="n">write</span> <span class="o">=</span> <span class="n">adjust_start</span> <span class="s2">&quot;write&quot;</span> <span class="nn">B</span><span class="p">.</span><span class="n">write</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The need to protect against overflow is an annoyance.
OCaml&rsquo;s <code>Int64.(add max_int one)</code> doesn&rsquo;t abort, but returns <code>Int64.min_int</code>.
That&rsquo;s disappointing, but not surprising.
I wrote a unit-test that tried to read sector <code>Int64.max_int</code> and ran it (before updating the code) to check it detected the problem.
I was expecting the partition code to pass the request to the underlying block device, which I expected to return an error about the invalid sector, but it didn&rsquo;t!
It turns out, <code>Int64.to_int</code> (used by my in-memory test block device) silently truncates out-of-range integers:</p>

<pre><code># Int64.max_int;;
- : int64 = 9223372036854775807L
# Int64.(add max_int one);;
- : int64 = -9223372036854775808L
# Int64.min_int;;
- : int64 = -9223372036854775808L
# Int64.(to_int min_int);;
- : int = 0
</code></pre>

<p>So, if the queue can be tricked into asking for sector 9223372036854775807 then the partition would accept it as valid and the block device would truncate it and give access to sector 0 - the sector with the private key!</p>

<p>Still, this is a nice demonstration of how we can add security in Mirage by inserting a new module (<code>Mbr_partition</code>) between two existing ones.
Rather than having some complicated fixed policy language (e.g. SELinux), we can build whatever security abstractions we like.
Here I just limited which parts of the disk the queue could access, but we could do many other things: make a partition read-only, make it readable only until the unikernel finishes initialising, apply rate-limiting on reads, etc.</p>

<p>Here&rsquo;s the final code. It:</p>

<ol>
  <li>Takes a block device, a conduit, and a KV store as inputs.</li>
  <li>Creates two partitions (views) onto the block device.</li>
  <li>Creates a queue on one partition.</li>
  <li>Reads the private key from the other, and the certificate from the KV store.</li>
  <li>Begins serving HTTPS requests.</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>unikernel.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">Main</span> <span class="o">(</span><span class="nc">C</span> <span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">CONSOLE</span><span class="o">)</span>
</span><span class="line">            <span class="o">(</span><span class="nc">B</span> <span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">BLOCK</span><span class="o">)</span>
</span><span class="line">            <span class="o">(</span><span class="nc">Conduit</span> <span class="o">:</span> <span class="nn">Conduit_mirage</span><span class="p">.</span><span class="nc">S</span><span class="o">)</span>
</span><span class="line">            <span class="o">(</span><span class="nc">CertStore</span> <span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">KV_RO</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">Part</span> <span class="o">=</span> <span class="nn">Mbr_partition</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">B</span><span class="o">)</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">Q</span> <span class="o">=</span> <span class="nn">Upload_queue</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">Part</span><span class="o">)</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">Http</span> <span class="o">=</span> <span class="nn">HTTP</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">Conduit</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="o">[...]</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">start</span> <span class="n">c</span> <span class="n">b</span> <span class="n">conduit</span> <span class="n">cert_store</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">B</span><span class="p">.</span><span class="n">get_info</span> <span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">info</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="n">key_sectors</span> <span class="o">=</span> <span class="o">(</span><span class="n">key_partition_size</span> <span class="o">+</span> <span class="n">info</span><span class="o">.</span><span class="nn">B</span><span class="p">.</span><span class="n">sector_size</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">/</span>
</span><span class="line">                      <span class="n">info</span><span class="o">.</span><span class="nn">B</span><span class="p">.</span><span class="n">sector_size</span> <span class="o">|&gt;</span> <span class="nn">Int64</span><span class="p">.</span><span class="n">of_int</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">queue_sectors</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="nn">B</span><span class="p">.</span><span class="n">size_sectors</span> <span class="o">--</span> <span class="n">key_sectors</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">    <span class="nn">Part</span><span class="p">.</span><span class="err">(</span><span class="n">connect</span> <span class="o">{</span><span class="n">b</span><span class="o">;</span> <span class="n">start_sector</span> <span class="o">=</span> <span class="mi">0</span><span class="n">L</span><span class="o">;</span>
</span><span class="line">                      <span class="n">length_sectors</span> <span class="o">=</span> <span class="n">key_sectors</span><span class="o">})</span>
</span><span class="line">    <span class="o">&gt;&gt;|=</span> <span class="k">fun</span> <span class="n">key_partition</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="nn">Part</span><span class="p">.</span><span class="err">(</span><span class="n">connect</span> <span class="o">{</span><span class="n">b</span><span class="o">;</span> <span class="n">start_sector</span> <span class="o">=</span> <span class="n">key_sectors</span><span class="o">;</span>
</span><span class="line">                      <span class="n">length_sectors</span> <span class="o">=</span> <span class="n">queue_sectors</span><span class="o">})</span>
</span><span class="line">    <span class="o">&gt;&gt;|=</span> <span class="k">fun</span> <span class="n">queue_partition</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="nn">Q</span><span class="p">.</span><span class="n">create</span> <span class="n">queue_partition</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">q</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="n">lwt</span> <span class="n">certs</span> <span class="o">=</span>
</span><span class="line">      <span class="n">read_from_kv</span> <span class="n">cert_store</span> <span class="s2">&quot;tls/server.pem&quot;</span>
</span><span class="line">      <span class="o">&gt;|=</span> <span class="nn">X509</span><span class="p">.</span><span class="nn">Cert</span><span class="p">.</span><span class="n">of_pem_cstruct</span> <span class="k">in</span>
</span><span class="line">    <span class="n">lwt</span> <span class="n">pk</span> <span class="o">=</span>
</span><span class="line">      <span class="n">read_from_partition</span> <span class="n">key_partition</span> <span class="o">~</span><span class="n">len</span><span class="o">:</span><span class="n">private_key_len</span>
</span><span class="line">      <span class="o">&gt;|=</span> <span class="nn">X509</span><span class="p">.</span><span class="nn">PK</span><span class="p">.</span><span class="n">of_pem_cstruct1</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">tls_config</span> <span class="o">=</span> <span class="nn">Tls</span><span class="p">.</span><span class="nn">Config</span><span class="p">.</span><span class="err">(</span><span class="n">of_server</span>
</span><span class="line">      <span class="o">(</span><span class="n">server</span> <span class="o">~</span><span class="n">certificate</span><span class="o">:(</span><span class="n">certs</span><span class="o">,</span> <span class="n">pk</span><span class="o">)</span> <span class="bp">()</span><span class="o">))</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="n">spec</span> <span class="o">=</span> <span class="nn">Http</span><span class="p">.</span><span class="nn">Server</span><span class="p">.</span><span class="n">make</span> <span class="o">~</span><span class="n">callback</span><span class="o">:(</span><span class="n">callback</span> <span class="n">q</span><span class="o">)</span> <span class="o">~</span><span class="n">conn_closed</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">mode</span> <span class="o">=</span> <span class="o">`</span><span class="nc">TLS</span> <span class="o">(</span><span class="n">tls_config</span><span class="o">,</span> <span class="o">`</span><span class="nc">TCP</span> <span class="o">(`</span><span class="nc">Port</span> <span class="mi">8443</span><span class="o">))</span> <span class="k">in</span>
</span><span class="line">    <span class="nn">Conduit</span><span class="p">.</span><span class="n">serve</span> <span class="o">~</span><span class="n">ctx</span><span class="o">:</span><span class="n">conduit</span> <span class="o">~</span><span class="n">mode</span> <span class="o">(</span><span class="nn">Http</span><span class="p">.</span><span class="nn">Server</span><span class="p">.</span><span class="n">listen</span> <span class="n">spec</span><span class="o">)</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>Entropy</h3>

<p>Another issue is getting good random numbers, which is required for the cryptography.
On start-up, the unikernel displayed:</p>

<pre><code>Entropy_xen_weak: using a weak entropy source seeded only from time.
</code></pre>

<p>To fix this, you need to use <a href="https://github.com/djs55/mirage-entropy">Dave Scott&rsquo;s version</a> (with a slight patch from me):</p>

<pre><code>opam pin add mirage-entropy-xen 'https://github.com/talex5/mirage-entropy.git#handshake'
</code></pre>

<p>You should then see:</p>

<pre><code>Entropy_xen: attempting to connect to Xen entropy source org.openmirage.entropy.1
Console.connect org.openmirage.entropy.1: doesn't currently exist, waiting for hotplug
</code></pre>

<p>Now run <a href="https://github.com/mirage/xentropyd">xentropyd</a> in dom0 to share the host&rsquo;s entropy with guests.</p>

<p>The interesting question here is what Linux guests do for entropy, especially on ARM where there&rsquo;s no <code>RdRand</code> instruction.</p>

<h2>Access control</h2>

<p>Traditional means of access control involve issuing users with passwords or X.509 client certificates, which they share with the software they&rsquo;re running.
All requests sent by the client can then be authenticated as coming from them and approved based on some access control policy.
This approach leads to all the well-known problems with traditional access control: the <a href="http://en.wikipedia.org/wiki/Confused_deputy_problem">confused deputy problem</a>, Cross-Site Request Forgery, Clickjacking, etc, so I want to avoid that kind of &ldquo;ambient authority&rdquo;.</p>

<p>The previous diagram let us reason about how the different components within the unikernel could interact with each other, showing the possible (initial) interactions with arrows.
Now I want to stretch arrows across the Internet, so I can reason in the same way about the larger distributed system that includes my queue service with the uploaders and downloaders.</p>

<p>Like C pointers, traditional web URLs do not give us what we want: a compromised CA anywhere in the world will allow an attacker to impersonate our service, and our URLs may be guessable.
Instead, I decided to try a <a href="http://www.waterken.com/dev/YURL/Definition/">YURL</a>:</p>

<blockquote>
  <p>&rdquo;[&hellip;] the identifier MUST provide enough information to: locate the target site; authenticate the target site; and, if required, establish a private communication channel with the target site. A URL that meets these requirements is a YURL.&rdquo;</p>
</blockquote>

<p>The latest version of this (draft) scheme I could find was some brief notes in <a href="http://iiw.idcommons.net/HTTPSY_%E2%80%93_Leave_the_Certificate_Authority_Behind">HTTPSY</a> (2014), which uses the format:</p>

<pre><code>httpsy://algorithm:fingerprint@domain:port/path1/!redactedPath2/&hellip;
</code></pre>

<p>There are two parts we need to consider: how the client determines that it is connected to the real service, and how the service determines what the client can do.</p>

<p>To let the client authenticate the server without relying on the CA system, YURLs include a hash (fingerprint) of the server&rsquo;s public key.
You can get the fingerprint of an X509 certificate like this:</p>

<pre><code>$ openssl x509 -in server.pem -fingerprint -sha256 -noout
SHA256 Fingerprint=3F:27:2D:E6:D6:3D:7C:08:E0:E3:EF:02:A8:DA:9A:74:62:84:57:21:B4:72:39:FD:D0:72:0E:76:71:A5:E9:94
</code></pre>

<p>Base32-encoding shortens this to <code>h4ts3zwwhv6aryhd54bkrwu2orriivzbwrzdt7oqoihhm4nf5gka</code>.</p>

<p>Alternatively, to get the value with OCaml, use:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="nn">Certificate</span><span class="p">.</span><span class="n">cs_of_cert</span> <span class="n">cert</span> <span class="o">|&gt;</span> <span class="nn">Nocrypto</span><span class="p">.</span><span class="nn">Hash</span><span class="p">.</span><span class="n">digest</span> <span class="o">`</span><span class="nc">SHA256</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To control what each user of the service can do, we give each user a unique YURL containing a <a href="http://wiki.erights.org/wiki/Swiss_number">Swiss number</a>, which is like a password except that it applies only to a specific resource, not to the whole site.
The Swiss number comes after the <code>!</code> in the URL, which indicates to browsers that it shouldn&rsquo;t be displayed, included in Referer headers, etc.
You can use any unguessably long random string here (I used <code>pwgen 32 1</code>).
After checking the server&rsquo;s fingerprint, the client requests the path with the Swiss number included.</p>

<p>Putting it all together, then, a sample URL to give to the downloader looks like this:</p>

<pre><code>httpsy://sha256:h4ts3zwwhv6aryhd54bkrwu2orriivzbwrzdt7oqoihhm4nf5gka@10.0.0.2:8443/downloader/!eequuthieyexahzahShain0abeiwaej4
</code></pre>

<p>The old code for handling requests looked like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">match</span> <span class="nn">Uri</span><span class="p">.</span><span class="n">path</span> <span class="n">request</span><span class="o">.</span><span class="nn">Cohttp</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="n">uri</span> <span class="k">with</span>
</span><span class="line"><span class="o">|</span> <span class="s2">&quot;/uploader&quot;</span> <span class="o">-&gt;</span> <span class="n">handle_uploader</span> <span class="n">q</span> <span class="n">request</span> <span class="n">body</span>
</span><span class="line"><span class="o">|</span> <span class="s2">&quot;/downloader&quot;</span> <span class="o">-&gt;</span> <span class="n">handle_downloader</span> <span class="n">q</span> <span class="n">request</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This becomes:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">re_endpoint</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^/</span><span class="se">\\</span><span class="s2">(uploader</span><span class="se">\\</span><span class="s2">|downloader</span><span class="se">\\</span><span class="s2">)/!</span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">)$&quot;</span> <span class="k">in</span>
</span><span class="line"><span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">Uri</span><span class="p">.</span><span class="n">path</span> <span class="n">request</span><span class="o">.</span><span class="nn">Cohttp</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="n">uri</span> <span class="k">in</span>
</span><span class="line"><span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">re_endpoint</span> <span class="n">path</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">(</span>
</span><span class="line">  <span class="k">let</span> <span class="n">label</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">path</span> <span class="k">in</span>
</span><span class="line">  <span class="k">let</span> <span class="n">swiss_hash</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">path</span> <span class="o">|&gt;</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">of_string</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">Nocrypto</span><span class="p">.</span><span class="nn">Hash</span><span class="p">.</span><span class="n">digest</span> <span class="o">`</span><span class="nc">SHA256</span> <span class="o">|&gt;</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">to_string</span>
</span><span class="line">    <span class="o">|&gt;</span> <span class="nn">B64</span><span class="p">.</span><span class="n">encode</span> <span class="k">in</span>
</span><span class="line">  <span class="k">match</span> <span class="n">label</span><span class="o">,</span> <span class="n">swiss_hash</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="s2">&quot;uploader&quot;</span><span class="o">,</span> <span class="s2">&quot;kW8VOKYP1eu/cWInpJx/jzYDSJzo1RUR14GoxV/CImM=&quot;</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">handle_uploader</span> <span class="n">q</span> <span class="n">request</span> <span class="n">body</span> <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;Alice&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="s2">&quot;downloader&quot;</span><span class="o">,</span> <span class="s2">&quot;PEj3nuboy3BktVGzi9y/UBmgkrGuhHD1i6WsXDw1naI=&quot;</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">handle_downloader</span> <span class="n">q</span> <span class="n">request</span> <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;0repo&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">bad_path</span> <span class="n">path</span>
</span><span class="line"><span class="o">)</span> <span class="k">else</span> <span class="n">bad_path</span> <span class="n">path</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I hashed the Swiss number here so that the unikernel doesn&rsquo;t have to contain any secrets and I therefore don&rsquo;t have to worry about timing attacks.
Even if the attacker knows the hash we&rsquo;re looking for, they still shouldn&rsquo;t be able to generate a URL which hashes to that value.</p>

<p>By giving each user of the service a different Swiss number we can keep records of who authorised each request and revoke access individually if needed (here the <code>~user:&quot;Alice&quot;</code> indicates this is the uploader URL we gave to Alice).</p>

<p>Of course, the YURLs need to be sent to users securely too.
In my case, the users already have known GPG keys, so I can just email them an encrypted version.</p>

<h3>Python client</h3>

<p>The downloader (0repo) is written in Python, so the next step was to check that it could still access the service.
The Python SSL API was rather confusing, but this seems to work:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>client.py </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c">#!/usr/bin/python3</span>
</span><span class="line">
</span><span class="line"><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
</span><span class="line"><span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">client</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">ssl</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">hashlib</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">base64</span>
</span><span class="line">
</span><span class="line"><span class="c"># Note: MUST check fingerprint BEFORE sending URL path with Swiss number</span>
</span><span class="line"><span class="k">class</span> <span class="nc">FingerprintContext</span><span class="p">:</span>
</span><span class="line">    <span class="n">required_fingerprint</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class="line">    <span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
</span><span class="line">    <span class="n">check_hostname</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">required_fingerprint</span> <span class="o">=</span> <span class="n">fingerprint</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class="line">        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class="line">        <span class="n">cert</span> <span class="o">=</span> <span class="n">wrapped</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">(</span><span class="n">binary_form</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</span><span class="line">        <span class="n">actual_fingerprint</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32encode</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'='</span><span class="p">)</span>
</span><span class="line">        <span class="k">if</span> <span class="n">actual_fingerprint</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_fingerprint</span><span class="p">:</span>
</span><span class="line">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Expected server certificate to have fingerprint:</span><span class="se">\n</span><span class="si">%s</span><span class="s"> but got:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">required_fingerprint</span><span class="p">,</span> <span class="n">actual_fingerprint</span><span class="p">))</span>
</span><span class="line">        <span class="k">return</span> <span class="n">wrapped</span>
</span><span class="line">
</span><span class="line"><span class="c"># Testing...</span>
</span><span class="line"><span class="n">url</span> <span class="o">=</span> <span class="s">&quot;httpsy://sha256:h4ts3zwwhv6aryhd54bkrwu2orriivzbwrzdt7oqoihhm4nf5gka@localhost:8443/downloader/!eequuthieyexahzahShain0abeiwaej4&quot;</span>
</span><span class="line"><span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line"><span class="k">assert</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s">&quot;httpsy&quot;</span>
</span><span class="line"><span class="k">assert</span> <span class="n">parsed</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&quot;sha256&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">conn</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="p">(</span>
</span><span class="line">    <span class="n">host</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
</span><span class="line">    <span class="n">port</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
</span><span class="line">    <span class="n">context</span> <span class="o">=</span> <span class="n">FingerprintContext</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">password</span><span class="p">),</span>
</span><span class="line">    <span class="n">check_hostname</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
</span><span class="line"><span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span><span class="line"><span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">&quot;Fetching item of size </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="n">resp</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s">'Content-Length'</span><span class="p">))</span>
</span><span class="line"><span class="n">d</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class="line"><span class="k">print</span><span class="p">(</span><span class="s">&quot;Fetched </span><span class="si">%d</span><span class="s"> bytes&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2>Conclusions</h2>

<p>MirageOS should allow us to build systems that are far more secure than traditional operating systems.
By starting with isolated components and then connecting them together in a controlled way we can feel some confidence that our security goals will be met.</p>

<p>At the language level, OCaml&rsquo;s abstract types and functors make it easy to reason informally about how the components of our system will interact. Mirage passes values granting access to the outside world (disks, network cards, etc) to our unikernel&rsquo;s <code>start</code> function.
Our code can then delegate these permissions to the rest of the code in a controlled fashion.
For example, we can grant the queuing code access only to its part of the disk (and not the bit containing the TLS private key) by wrapping the disk in a partition functor.
Although OCaml doesn&rsquo;t actually prevent us from bypassing this system and accessing devices directly, code that does so would not be able to support the multiple different back-ends (e.g. Unix and Xen) that Mirage requires and so could not be written accidentally.
It should be possible for a static analysis tool to verify that modules don&rsquo;t do this.</p>

<p>Moving up a level from separating the components of our unikernel, Xen allows us to isolate multiple unikernels and other VMs running on a single physical host.
Just as we interposed a disk partition between the queue and the disk within the unikernel, we can use Xen to interpose a firewall VM between the physical network device and our unikernel.</p>

<p>Finally, the use of transport layer security and YURLs allows us to continue this pattern of isolation to the level of networks, so that we can reason in the same way about distributed systems.
My current code mixes the handling of YURLs with the existing application logic, but it should be possible to abstract this and make it reusable, so that remote services appear just like any local service.
In many systems this is awkward because local APIs are used synchronously while remote ones are asynchronous, but in Mirage everything is non-blocking anyway, so there is no difference.</p>

<p>I feel I should put some kind of warning here about these very new security features not being ready for real use and how you should instead use mature, widely deployed systems such as Linux and OpenSSL.
But really, can it be any worse?</p>

<p>If you&rsquo;ve spotted any flaws in my reasoning or code, please add comments!
The code for this unikernel can be found on the <code>tls</code> branch at <a href="https://github.com/0install/0repo-queue/tree/tls">https://github.com/0install/0repo-queue/tree/tls</a>.</p>

<a onclick="switchContent('ocamlorg-post8','ocamlorg-post7')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2015/01/21/securing-the-unikernel/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2015/01/21/securing-the-unikernel/">by Thomas Leonard at Jan 21, 2015 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://amirchaudhry.com/towards-governance-framework-for-ocamlorg">
    <a name="#http://amirchaudhry.com/towards-governance-framework-for-ocamlorg"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/amir.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://amirchaudhry.com/towards-governance-framework-for-ocamlorg">Towards a governance framework for OCaml.org</a>
      (<a href="http://amirchaudhry.com/tags/ocaml-labs-atom.xml" title="Amir Chaudhry - 'ocaml-labs'">Amir Chaudhry</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post9">
<p>The projects around the OCaml.org domain name are becoming more established
and it&rsquo;s time to think about how they&rsquo;re organised. 2014 saw a <em>lot</em> of
activity, which built on the <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#OnlineatOCamlorg">successes from 2013</a>.
Some of the main things that stand out to me are:</p>

<ul>
  <li>More <a href="http://ocaml.org/contributors.html">volunteers</a> contributing to the public website with
translations, bug fixes and content updates, as well as many new visitors &mdash;
for example, the new page on <a href="http://ocaml.org/learn/teaching-ocaml.html">teaching OCaml</a> received over 5k
visits alone. The increasing contributions are a result of the earlier work on
<a href="http://amirchaudhry.com/announcing-new-ocamlorg/">re-engineering the site</a> and there are many ways to get involved
so please do <a href="https://github.com/ocaml/ocaml.org/labels/contribute!">contribute</a>!</li>
</ul>

<p><a href="http://opam.ocaml.org/"><img src="http://amirchaudhry.com/images/web/opampkg-2015-01-08.png" style="float: right; margin-left: 10px"/></a></p>

<ul>
  <li>The relentless improvements and growth of OPAM, both in terms of the
repository &mdash; with over 1000 additional packages and several
<a href="http://lists.ocaml.org/pipermail/opam-devel/2014-October/000781.html">new repo maintainers</a> &mdash; and also improved workflows (e.g the new
<a href="http://opam.ocaml.org/blog/opam-1-2-pin/">pin functionality</a>). 
The OPAM site and package list also moved to the ocaml.org domain, becoming
the substrate for the OCaml Platform efforts. This began with the work towards
<a href="http://opam.ocaml.org/blog/opam-1-2-0-beta4/">OP&hellip;</a></li></ul><a onclick="switchContent('ocamlorg-post9','ocamlorg-post10')" class="btn planet-toggle" href="#http://amirchaudhry.com/towards-governance-framework-for-ocamlorg">Read more...</a></div><div id="ocamlorg-post10" style="display: none">
<p>The projects around the OCaml.org domain name are becoming more established
and it&rsquo;s time to think about how they&rsquo;re organised. 2014 saw a <em>lot</em> of
activity, which built on the <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#OnlineatOCamlorg">successes from 2013</a>.
Some of the main things that stand out to me are:</p>

<ul>
  <li>More <a href="http://ocaml.org/contributors.html">volunteers</a> contributing to the public website with
translations, bug fixes and content updates, as well as many new visitors &mdash;
for example, the new page on <a href="http://ocaml.org/learn/teaching-ocaml.html">teaching OCaml</a> received over 5k
visits alone. The increasing contributions are a result of the earlier work on
<a href="http://amirchaudhry.com/announcing-new-ocamlorg/">re-engineering the site</a> and there are many ways to get involved
so please do <a href="https://github.com/ocaml/ocaml.org/labels/contribute!">contribute</a>!</li>
</ul>

<p><a href="http://opam.ocaml.org/"><img src="http://amirchaudhry.com/images/web/opampkg-2015-01-08.png" style="float: right; margin-left: 10px"/></a></p>

<ul>
  <li>The relentless improvements and growth of OPAM, both in terms of the
repository &mdash; with over 1000 additional packages and several
<a href="http://lists.ocaml.org/pipermail/opam-devel/2014-October/000781.html">new repo maintainers</a> &mdash; and also improved workflows (e.g the new
<a href="http://opam.ocaml.org/blog/opam-1-2-pin/">pin functionality</a>). 
The OPAM site and package list also moved to the ocaml.org domain, becoming
the substrate for the OCaml Platform efforts. This began with the work towards
<a href="http://opam.ocaml.org/blog/opam-1-2-0-beta4/">OPAM 1.2</a> and there is much more to come (including closer
integration in terms of styling). Join the <a href="http://lists.ocaml.org/listinfo/platform">Platform list</a> to
keep up to date.</li>
</ul>

<ul>
  <li>Much more activity on the <a href="http://lists.ocaml.org">mailing lists</a> in general and user groups
requesting to have lists made (e.g the <a href="http://lists.ocaml.org/listinfo/teaching">teaching list</a>). If anyone
has a need for a new list, just ask on the
<a href="http://lists.ocaml.org/listinfo/infrastructure">infrastructure list</a>!</li>
</ul>

<p>There is other work besides those I&rsquo;ve mentioned and I think by any measure,
all the projects have been quite successful. As the community continues to
develop, it&rsquo;s important to clarify how things currently work to improve the
level of transparency and make it easier for newcomers to get involved.</p>

<h3>Factors for a governance framework</h3>

<p>For the last couple of months, I&rsquo;ve been looking over how larger projects
manage themselves and the governance documents that are available. My aim has
been to put such a document together for the OCaml.org domain without
introducing burdensome processes.  There are number of things that stood out
to me during this process, which have guided the approach I&rsquo;m taking.</p>

<p>My considerations for an OCaml.org governance document:</p>

<ul>
  <li>
    <p>A governance document is not <em>necessary</em> for success but it&rsquo;s valuable to
demonstrate a commitment to a <strong>stable decision-making process</strong>.  There are
many projects that progress perfectly well without any documented processes
and indeed the work around OCaml.org so far is a good example of this (as well
as OCaml itself).  However, for projects to achieve a scale greater than the
initial teams, it&rsquo;s a significant benefit to encode in writing how things work
(NB: please note that I didn&rsquo;t define the <em>type</em> of decision-making process -
merely that it&rsquo;s a stable one).</p>
  </li>
  <li>
    <p>It must <strong>clarify its scope</strong> so that there is no confusion about what the
document covers. In the case of OCaml.org, it needs to be clear that the
governance covers the domain itself, rather than referring to the website. </p>
  </li>
  <li>
    <p>It should <strong>document the reality</strong>, rather than represent an aspirational
goal or what people <em>believe</em> a governance structure should look like.  It&rsquo;s
very tempting to think of an idealised structure without recognising that
behaviours and norms have <em>already</em> been established. Sometimes this will be
vague and poorly defined but that might simply indicate areas that the
community hasn&rsquo;t encountered yet (e.g it&rsquo;s uncommon for any new project to
seriously think about dispute resolution processes until they have to).  In
this sense, the initial version of a governance document should simply be a
written description of how things currently stand, rather than a means to
adjust that behaviour.  </p>
  </li>
  <li>
    <p>It should be <strong>simple and self-contained</strong>, so that anyone can understand
the intent quickly without recourse to other documents.  It may be tempting to
consider every edge-case or try to resolve every likely ambiguity but this
just leads to large, legal documents.  This approach may well be necessary
once projects have reached a certain scale but to implement it sooner would be
a case of premature optimisation &mdash; not to mention that very few people would 
read and remember such a document.</p>
  </li>
  <li>
    <p>It&rsquo;s a <strong>living document</strong>. If the community decides that it would prefer a
new arrangement, then the document conveniently provides a stable starting
point from which to iterate. Indeed, it <em>should</em> adapt along with the project
that it governs. </p>
  </li>
</ul>

<p>With the above points in mind, I&rsquo;ve been putting together a draft governance
framework to cover how the OCaml.org domain name is managed.  It&rsquo;s been a
quiet work-in-progress for some time and I&rsquo;ll be getting in touch with
maintainers of specific projects soon.  Once I&rsquo;ve had a round of reviews, I&rsquo;ll
be sharing it more widely and posting it here!</p>


<a onclick="switchContent('ocamlorg-post10','ocamlorg-post9')" class="btn planet-toggle" href="#http://amirchaudhry.com/towards-governance-framework-for-ocamlorg">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://amirchaudhry.com/towards-governance-framework-for-ocamlorg">by Amir Chaudhry at Jan 08, 2015 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/2014-in-review">
    <a name="#http://openmirage.org/blog/2014-in-review"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/2014-in-review">Mirage 2014 review: IPv6, TLS, Irmin, Jitsu and community growth</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post11">
      <p><small>
 This work funded in part by the EU FP7 User-Centric Networking project, Grant
 No. 611001.
</small></p>
<p>An action-packed year has flown by for Mirage, and it's time for a little recap of what's been happening and the plans for the new year.
We announced <a href="http://openmirage.org/blog/announcing-mirage10">Mirage 1.0</a> just over a year ago, and 2014 also saw a major <a href="http://openmirage.org/blog/announcing-mirage-20-release">2.0 summer release</a> and the growth of a developer community that have been building support for IPv6, Transport Layer Security, on-demand spawning, profiling and much more.  There have been 205 individual library <a href="http://openmirage.org/releases">releases</a>, 25 <a href="http://decks.openmirage.org">presentations</a>, and lots of <a href="http://openmirage.org/links">online chatter</a> through the year, so here follows a summary of our major activities recently.</p>
<h3>Clean-Slate Transport Layer Security</h3>

<p><a href="http://media.ccc.de/browse/congress/2014/31c3_-_6443_-_en_-_saal_2_-_201412271245_-_trustworthy_secure_modular_operating_system_engineering_-_hannes_-_david_kaloper.html#video"><img src="http://openmirage.org/graphics/tls-31c3.png" width="300px" style="float:right; padding: 5px"/></a></p>
<p>David Kaloper and Hannes Mehnert started 2014 with getting interested in writing a <a href="https://ocaml.org/meetings/ocaml/2014/ocaml2014_4.pdf">safer and cleaner TLS stack</a> in OCaml, and ended the year with a complete demonstration and talk last week in <a href="http://media.ccc.de/browse/congress/2014/31c3_-_6443_-_en_-_saal_2_-_201412271245_-_trustworthy_secure_modular_operating_system_engineering_-_hannes_-_david_kaloper.html#video">31C3</a>, the premier hacker conference!  Their blog posts over the summer remain an excellent introduction to the new&hellip;</p><a onclick="switchContent('ocamlorg-post11','ocamlorg-post12')" class="btn planet-toggle" href="#http://openmirage.org/blog/2014-in-review">Read more...</a></div><div id="ocamlorg-post12" style="display: none">
      <p><small>
 This work funded in part by the EU FP7 User-Centric Networking project, Grant
 No. 611001.
</small></p>
<p>An action-packed year has flown by for Mirage, and it's time for a little recap of what's been happening and the plans for the new year.
We announced <a href="http://openmirage.org/blog/announcing-mirage10">Mirage 1.0</a> just over a year ago, and 2014 also saw a major <a href="http://openmirage.org/blog/announcing-mirage-20-release">2.0 summer release</a> and the growth of a developer community that have been building support for IPv6, Transport Layer Security, on-demand spawning, profiling and much more.  There have been 205 individual library <a href="http://openmirage.org/releases">releases</a>, 25 <a href="http://decks.openmirage.org">presentations</a>, and lots of <a href="http://openmirage.org/links">online chatter</a> through the year, so here follows a summary of our major activities recently.</p>
<h3>Clean-Slate Transport Layer Security</h3>

<p><a href="http://media.ccc.de/browse/congress/2014/31c3_-_6443_-_en_-_saal_2_-_201412271245_-_trustworthy_secure_modular_operating_system_engineering_-_hannes_-_david_kaloper.html#video"><img src="http://openmirage.org/graphics/tls-31c3.png" width="300px" style="float:right; padding: 5px"/></a></p>
<p>David Kaloper and Hannes Mehnert started 2014 with getting interested in writing a <a href="https://ocaml.org/meetings/ocaml/2014/ocaml2014_4.pdf">safer and cleaner TLS stack</a> in OCaml, and ended the year with a complete demonstration and talk last week in <a href="http://media.ccc.de/browse/congress/2014/31c3_-_6443_-_en_-_saal_2_-_201412271245_-_trustworthy_secure_modular_operating_system_engineering_-_hannes_-_david_kaloper.html#video">31C3</a>, the premier hacker conference!  Their blog posts over the summer remain an excellent introduction to the new stack:</p>
<ul><li><em>&quot;<a href="http://openmirage.org/blog/introducing-ocaml-tls">OCaml-TLS: Introducing transport layer security (TLS) in pure OCaml</a>&quot;</em> presents the motivation and architecture behind our clean-slate implementation of the protocol.</li><li><em>&quot;<a href="http://openmirage.org/blog/introducing-nocrypto">OCaml-TLS: building the nocrypto library core</a>&quot;</em> talks about the cryptographic primitives that form the heart of TLS confidentiality guarantees, and how they expose safe interfaces to the rest of the stack.</li><li><em>&quot;<a href="http://openmirage.org/blog/introducing-x509">OCaml-TLS: adventures in X.509 certificate parsing and validation</a>&quot;</em> explains how authentication and chain-of-trust verification is implemented in our stack.</li><li><em>&quot;<a href="http://openmirage.org/blog/introducing-asn1">OCaml-TLS: ASN.1 and notation embedding</a>&quot;</em> introduces the libraries needed for handling ASN.1 grammars, the wire representation of messages in TLS.</li><li><em>&quot;<a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">OCaml-TLS: the protocol implementation and mitigations to known attacks</a>&quot;</em> concludes with the implementation of the core TLS protocol logic itself.</li></ul>

<p>By summer, the stack was complete enough to connect to the majority of TLS 1.0+ sites on the Internet, and work progressed to integration with the remainder of the Mirage libraries.  By November, the <a href="https://github.com/mirage/ocaml-conduit">Conduit</a> network library had Unix support for both the <a href="https://github.com/savonet/ocaml-ssl">OpenSSL/Lwt</a> bindings and the pure OCaml stack, with the ability to dynamically select them.  You can now deploy and test the pure OCaml TLS stack on a webserver simply by:</p>
<pre><code>opam install lwt tls cohttp
export CONDUIT_TLS=native
cohttp-server-lwt -c &lt;certfile&gt; -p &lt;port&gt; &lt;directory&gt;</code></pre><p>This will spin up an HTTPS server that serves the contents of <code>&lt;directory&gt;</code> to you over TLS.
At the same time, we were also working on integrating the TLS stack into the Xen unikernel backend, so we could run completely standalone.  This required some surgery:</p>
<ul><li>The <a href="https://github.com/mirleft/ocaml-nocrypto">nocrypto</a> crypto core is written in C, so we had to improve support for linking in external C libraries.  Since the Xen unikernel is a single address-space custom kernel, we also need to be careful to compile it with the correct compilation flags or else risk <a href="https://github.com/mirage/mirage-tcpip/issues/80">subtle bugs</a>. Thomas Leonard completely rearranged the Mirage compilation pipeline to support <a href="https://github.com/mirage/mirage/pull/332">separation compilation of C stubs</a>, and we had the opportunity to remove lots of duplicated code within <a href="https://github.com/mirage/mirage-platform">mirage-platform</a> as a result of this work.</li><li>Meanwhile, the problem of gathering entropy in a virtual machine reared its head.  We created a <a href="https://github.com/mirage/mirage-entropy">mirage-entropy</a> device driver, and an <a href="http://lists.xenproject.org/archives/html/mirageos-devel/2014-11/msg00146.html">active discussion</a> ensued about how best to gather reliable randomness from Xen.  <a href="http://dave.recoil.org">Dave Scott</a> built the best solution -- the <a href="https://github.com/mirage/xentropyd">xenentropyd</a> that proxies entropy from dom0 to a unikernel VM.</li><li>David Kaloper also ported the <code>nocrypto</code> library to use the <a href="https://github.com/ocamllabs/ocaml-ctypes">OCaml-Ctypes</a> library, which increases the safety of the C bindings significantly.  This is described in more detail in the &quot;<a href="http://openmirage.org/blog/modular-foreign-function-bindings">Modular foreign function bindings</a>&quot; blog post from the summer.  This forms the basis for allowing Xen unikernels to communicate with C code, and integration with the Mirage toolchain will continue to improve next year.</li></ul>

<p>You can see <a href="http://media.ccc.de/browse/congress/2014/31c3_-_6443_-_en_-_saal_2_-_201412271245_-_trustworthy_secure_modular_operating_system_engineering_-_hannes_-_david_kaloper.html#video">Hannes and David present OCaml-TLS</a> at CCC online.  It's been a real pleasure watching their work develop in the last 12 months with such precision and attention to detail!</p>
<h3>HTTP and JavaScript</h3>

<p><a href="http://rgrinberg.com/">Rudi Grinberg</a> got sufficiently irked with the poor state of documentation for the <a href="https://github.com/mirage/ocaml-cohttp">CoHTTP</a> library that he began gently contributing fixes towards the end of 2013, and rapidly became one of the maintainers.  He also began improving the ecosystem around the web stack by building a HTTP routing layer, described in his blog posts:</p>
<ul><li><em><a href="http://rgrinberg.com/blog/2014/12/13/primitive-type-safe-routing/">Type Safe Routing - Baby Steps</a></em>: type-safe routing of URLs to avoid dangling links</li><li><em><a href="http://rgrinberg.com/blog/2014/04/04/introducing-opium/">Introducing Opium</a></em>: middleware for REST services</li><li><em><a href="http://rgrinberg.com/blog/2014/04/11/middleware-intro/">Middleware in Opium</a></em>: a walkthrough the Opium HTTP middleware model</li><li><em><a href="http://rgrinberg.com/blog/2014/05/23/humane-re-intro/">Introducing Humane-Re</a></em>: more friendly regular expression interfaces</li></ul>

<p>Meanwhile, <a href="http://www.ujamjar.com/">Andy Ray</a> started developing <a href="http://www.ujamjar.com/hardcaml/">HardCaml</a> (a register transfer level hardware design system) in OCaml, and built the <a href="https://andrewray.github.io/iocamljs/">iocamljs</a> interactive browser notebook.  This uses <a href="http://ocsigen.org/js_of_ocaml">js_of_ocaml</a> to port the <em>entire</em> OCaml compilation toolstack to JavaScript, including <code>ocamlfind</code>, Lwt threading and dynamic loading support.  The results are browsable <a href="https://andrewray.github.io/iocamljs/">online</a>, and it is now easy to generate a JavaScript-driven interactive page for many Mirage libraries.</p>
<p>An interesting side effect of Andy's patches were the addition of a <a href="https://github.com/mirage/ocaml-cohttp/pull/172">JavaScript port</a> to the CoHTTP library.  For those not familiar with the innards, CoHTTP uses the <a href="https://realworldocaml.org/v1/en/html/functors.html">OCaml module system</a> to build a very portable HTTP implementation that can make mapped to different I/O models (Lwt or Async cooperative threading or POSIX blocking I/O), and to different operating systems (e.g. Unix or Mirage).  The JavaScript support mapped the high-level modules in CoHTTP to the XMLHTTPRequest native to JavaScript, allowing the same OCaml HTTP client code to run efficiently on Unix, Windows and now an IOCamlJS browser instance.</p>
<p>Mirage uses a number of libraries developed by the <a href="http://ocsigen.org">Ocsigen</a> team at <a href="http://irill.org">IRILL</a> in Paris, and so I was thrilled to <a href="https://www.irill.org/videos/oups-december-2014/MirageOS">deliver a talk</a> there in December.  Romain Calascibetta started integrating Ocsigen and Mirage over the summer, and the inevitable plotting over beer in Paris lead <a href="https://github.com/Drup">Gabriel Radanne</a> to kick off an effort to integrate the complete Ocsigen web stack into Mirage. Head to <a href="https://github.com/ocsigen/ocsigenserver/issues/54">ocsigen/ocsigenserver#54</a> if you're interested in seeing this happen in 2015!
I also expect the JavaScript and Mirage integration to continue to improve in 2015, thanks to large industrial users such as <a href="https://github.com/facebook">Facebook</a> adopting <code>js_of_ocaml</code> in their open-source tools such as <a href="https://github.com/facebook/hack">Hack</a> and <a href="https://github.com/facebook/flow">Flow</a>.</p>
<h3>IPv6</h3>

<p>We've wanted IPv6 support in Mirage since its inception, and several people contributed to making this possible.  At the start of the year, <a href="https://github.com/hhugo">Hugo Heuzard</a> and <a href="https://github.com/dsheets">David Sheets</a> got <a href="https://github.com/mirage/ocaml-ipaddr/pull/9">IPv6 parsing support</a> into the <code>ipaddr</code> library (with me watching bemusedly at how insanely complex parsing is versus IPv4).</p>
<p>Meanwhile, <a href="https://www.dpmms.cam.ac.uk/~no263/">Nicolas Ojeda Bar</a> had been building OCaml networking libraries independently for some time, such as a <a href="https://github.com/nojb/ocaml-imap">IMAP client</a>, <a href="https://github.com/nojb/ocaml-maildir">Maildir</a> handler, and a <a href="https://github.com/nojb/ocaml-bt">Bittorrent</a> client.  He became interested in the networking layer of Mirage, and performed a <a href="https://github.com/mirage/mirage-tcpip/pull/70">comprehensive cleanup</a>  that resulted in a more modular stack that now supports both IPv4 and IPv6!</p>
<p>The addition of IPv6 support also forced us to consider how to simplify the configuration frontend to Mirage unikernels that was <a href="http://openmirage.org/blog/mirage-1.1-released">originally written</a> by Thomas Gazagnaire and <a href="http://openmirage.org/blog/intro-tcpip">described here</a> by Mindy Preston.
Nicolas has <a href="http://lists.xenproject.org/archives/html/mirageos-devel/2014-12/msg00001.html">proposed</a> a declarative extension to the configuration that allows applications to extend the <code>mirage</code> command-line more easily, thus unifying the &quot;built-in&quot; Mirage compilation modes (such as choosing between Xen or Unix) and protocol-specific choices (such as configuring IPv4 and IPv6).</p>
<p>The new approach opens up the possibility of writing more user-friendly configuration frontends that can render them as a text- or web-based selectors, which is really important as more real-world uses of Mirage are being created.  It should be possible in 2015 to solve common problems such as web or DNS serving without having to write a single line of OCaml code.</p>
<h3>Profiling</h3>

<p><a href="http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad"><img src="http://roscidus.com/blog/images/mirage-profiling/block-reads-3-32.png" width="300px" style="float:right; padding: 5px"/></a></p>
<p>One of the benefits touted by our CACM article on <a href="http://queue.acm.org/detail.cfm?id=2566628">unikernels</a> at the start of the year was the improved tooling from the static linking of an entire application stack with an operating system layer.
<a href="http://roscidus.com">Thomas Leonard</a> joined the project this year after publishing a widely read <a href="http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/">blog series</a> on his experiences from switching from Python to OCaml.
Aside from leading (and upstreaming to Xen) the port of <a href="http://openmirage.org/blog/introducing-xen-minios-arm">Mirage to ARM</a>, he also explored how to add profiling throughout the unikernel stack.</p>
<p>The support is now comprehensive and integrated into the Mirage trees: the <a href="http://ocsigen.org/lwt">Lwt</a> cooperative threading engine has hooks for thread switching, most of the core libraries register named events, traces are dumped into shared memory buffers in the <a href="http://wiki.eclipse.org/Linux_Tools_Project/TMF/CTF_guide">CTF</a> file format used by the Linux trace toolkit, and there are JavaScript and GTK+ <a href="https://github.com/talex5/mirage-trace-viewer">GUI frontends</a> that can parse them.</p>
<p>You can find the latest instructions on <a href="http://openmirage.org/wiki/profiling">Tracing and Profiling</a> on this website, and here are Thomas' original blog posts on the subject:</p>
<ul><li><a href="http://roscidus.com/blog/blog/2014/08/15/optimising-the-unikernel/">Optimising the Unikernel</a></li><li><a href="http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad/">Visualising an Asynchronous Monad</a></li></ul>

<h3>Irmin</h3>

<p><a href="https://gazagnaire.org">Thomas Gazagnaire</a> spent most of the year furiously hacking away at the storage layer in Irmin, which is a clean-slate storage stack that uses a Git-like branching model as the basis for distributed unikernel storage.  <a href="https://github.com/mirage/irmin/releases/tag/0.9.0">Irmin 0.9.0</a> was released in December with efficiency improvements and a sufficiently portable set of dependencies to make JavaScript compilation practical.</p>
<ul><li><em>&quot;<a href="http://openmirage.org/blog/introducing-irmin">Introducing Irmin: Git-like distributed, branchable storage</a>&quot;</em>  describes the concepts and high-level architecture of the system.</li><li><em>&quot;<a href="http://openmirage.org/blog/introducing-irmin-in-xenstore">Using Irmin to add fault-tolerance to the Xenstore database</a>&quot;</em> shows how Irmin is used in a real-world application: the security-critical Xen toolstack that manages hosts full of virtual machines (<a href="https://www.youtube.com/watch?v=DSzvFwIVm5s">video</a>).</li><li>There have been several other early adopters of Irmin for their own projects (independent of Mirage).  One of the most exciting is by <a href="https://github.com/gregatcam">Gregory Tsipenyuk</a>, who has been developing a version-controlled <a href="https://github.com/gregtatcam/imaplet-lwt">Irmin-based IMAP server</a> that offers a very different model for e-mail management.  Expect to see more of this in the new year!</li></ul>

<p>We also had the pleasure of Benjamin Farinier and Matthieu Journault join us as summer interns.  Both of them did a great job improving the internals of Irmin, and Benjamin's work on <em><a href="http://gazagnaire.org/pub/FGM15.pdf">Mergeable Persistent Datastructures</a></em> will be presented at JFLA 2015.</p>
<h3>Jitsu</h3>

<p><a href="http://decks.openmirage.org/irill14-seminar#/"><img src="http://openmirage.org/graphics/decks-on-arm.png" width="250px" style="float:right; padding: 5px"/></a></p>
<p><a href="http://www.skjegstad.com/">Magnus Skjegstad</a> returned to Cambridge and got interested in the rapid dynamic provisioning of unikernels.  He built <a href="https://github.com/MagnusS/jitsu">Jitsu</a>, a DNS server that spawns unikernels in response to DNS requests and boots them in real-time with no perceptible lag to the end user.  The longer term goal behind this is to enable a community cloud of ARM-based <a href="http://cubieboard.org/">Cubieboard2</a> boards that serve user content without requiring centralised data centers, but with the ease-of-use of existing systems.</p>
<p>Building Jitsu and hitting our goal of extremely low latency management of unikernels required a huge amount of effort from across the Mirage team.</p>
<ul><li><a href="http://dave.recoil.org">Dave Scott</a> and <a href="http://jon.recoil.org">Jon Ludlam</a> (two of the Xen maintainers at Citrix) improved the Xen <code>xl</code> toolstack to deserialise the VM startup chain to shave 100s of milliseconds off every operation.</li><li><a href="http://roscidus.com/blog/">Thomas Leonard</a> drove the removal of our forked <a href="http://wiki.xen.org/wiki/Mini-OS">Xen MiniOS</a> with a library version that is being fed upstream (including ARM support).  This made the delta between Xen and Mirage much smaller and therefore made reducing end-to-end latency tractable.</li><li><a href="https://github.com/dsheets">David Sheets</a> built a test harness to boot unikernel services and measure their latency under very different conditions, including contrasting boot timer versus <a href="http://docker.com">Docker</a> containers.  In many instances, we ended up booting faster than containers due to not touching disk at all with a standalone unikernel.  <a href="http://www.cl.cam.ac.uk/~iml1/">Ian Leslie</a> built us some custom power measurement hardware that came in handy to figure out how to drive down the energy cost of unikernels running on ARM boards.</li><li><a href="http://gazagnaire.org">Thomas Gazagnaire</a>, Balraj Singh, Magnus Skjegstad built the <code>synjitsu</code> proxy server that intercepts and proxies TCP connections to mask the couple of 100 milliseconds during unikernel boot time, ensuring that no TCP connections ever require retransmission from the client.</li><li><a href="http://dave.recoil.org">Dave Scott</a> and I built out the <a href="https://github.com/mirage/">vchan</a> shared memory transport that supports low-latency communiction between unikernels and/or Unix processes.  This is rapidly heading into a Plan9-like model, with the additional twist of using Git instead of a flat filesystem hierarchy as its coordination basis.</li><li><a href="http://amirchaudhry.com/">Amir Chaudhry</a> and <a href="http://mort.io">Richard Mortier</a> documented the Git-based (and eventually Irmin-based) workflow behind managing the unikernels themselves, so that they can easily be deployed to distance ARM devices simply by running <code>git pull</code>.  You can read more about this in his <a href="http://amirchaudhry.com/from-jekyll-to-unikernel-in-fifty-lines/">From Jekyll to Unikernels</a> post.</li></ul>

<p>All of this work was hastily crammed into a <a href="https://www.usenix.org/conference/nsdi15/call-for-papers">USENIX NSDI 2015</a> paper that got submitted at 4am on a bright autumn morning.  We'll put the preprint available when it's ready in January, along with a blog post describing how you can deploy this infrastructure for yourself.</p>
<h3>Community</h3>

<p>All of the above work was only possible due to the vastly improved tooling and infrastructure around the project.  Our community manager Amir Chaudhry led the <a href="http://openmirage.org/docs/">minuted</a> calls every two weeks that tied the efforts together, and we established some <a href="https://github.com/mirage/mirage-www/wiki/Pioneer-Projects">pioneer projects</a> for newcomers to tackle.</p>
<p><img src="http://openmirage.org/graphics/opam-packages-20141231.png" width="250px" style="float:right; padding: 5px"/></p>
<p>The <a href="https://opam.ocaml.org">OPAM</a> package manager continued to be the frontend for all Mirage tools, with releases of libraries happening <a href="http://openmirage.org/releases">regularly</a>.  Because of the modular nature of Mirage code, most of the libraries can also be used as normal Unix-based libraries, meaning that we aren't just limited to Mirage users but can benefit from the entire OCaml community.  The graph to the right shows the growth of the total package database since the project started to give you a sense of how much activity there is.</p>
<p>The major <a href="http://opam.ocaml.org/blog/opam-1-2-0-release/">OPAM 1.2</a> also added a number of new features that made Mirage code easier to develop, including a <a href="http://opam.ocaml.org/blog/opam-1-2-pin/">Git-based library pinning workflow</a> that works superbly with GitHub, and <a href="http://opam.ocaml.org/blog/opam-1-2-travisci/">easier Travis integration</a> for continuous integration.  <a href="https://github.com/niksu">Nik Sultana</a> also improved the <a href="https://github.com/mirage/is-mirage-broken/tree/master/logs">is-mirage-broken</a> to give us a cron-driven prod if a library update caused an end-to-end failure in building the Mirage website or other self-hosted infrastructure.</p>
<p>Our favourite <a href="http://www.somerandomidiot.com">random idiot</a>, Mindy Preston, wrote up a superb blog series about her experiences in the spring of 2014 with moving her homepage to be hosted on Mirage.  This was followed up by <a href="http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">Thomas Leonard</a>, <a href="http://philtomson.github.io/blog/2014/09/10/some-notes-on-building-and-running-mirage-unikernels-on-cubieboard2/">Phil Tomson</a>, <a href="https://github.com/iw/mirage-jekyll">Ian Wilkinson</a>, <a href="http://ocaml.is-awesome.net/2014/11/building-a-blog-with-mirage-os">Toby Moore</a>, and many others that we've tried to record in our <a href="http://openmirage.org/links/">link log</a>.  We really appreciate the hundreds of bug reports filed by users and folk trying out Mirage; by taking the trouble to do this, you've  helped us refine and polish the frontend.  One challenge for 2015 that we could use help on is to pull together many of these distributed blogged instructions and merge them back into the main documentation (get in touch if interested!).</p>
<p>OCaml has come a long way in the last year in terms of tooling, and another task my research group <a href="http://ocaml.io">OCaml Labs</a> works on at Cambridge is the development of the <a href="https://ocaml.org/meetings/ocaml/2014/ocaml2014_7.pdf">OCaml Platform</a>.  I'll be blogging separately about our OCaml-specific activities in a few days, but all of this work has a direct impact on Mirage itself since it lets us establish a local feedback loop between Mirage and OCaml developers to rapidly iterate on large-scale development.  The regular <a href="http://ocamllabs.github.io/compiler-hacking/">OCaml compiler hacking sessions</a> organised by Jeremy Yallop and Leo White have been a great success this year, with a wide variety of people from academic (Cambridge, London universities and Microsoft Research) and industrial (Jane Street, Citrix and Facebook among others) and locally interested folk.
One very important project that has had a lot of work put into it in 2014 (but isn't quite ready for a public release yet) is <a href="https://github.com/samoht/assemblage">Assemblage</a>, which will remove much of the boilerplate currently needed to build and release an OCaml library to OPAM.</p>
<p>We also had a great time working with open-source summer programs. Thanks to the Xen Foundation and GNOME for their support here, and we hope to do this again next summer!  The roundup posts were:</p>
<ul><li><em><a href="http://www.somerandomidiot.com/blog/2014/08/22/opw-fin/">OPW FIN</a></em> by Mindy Preston: on of her <a href="http://gnome.org/opw/">FOSS Outreach Program</a> work.</li><li><em><a href="http://1000hippos.wordpress.com/">Amazon Adventures</a></em> by Jyotsna Prakash: on her <a href="https://developers.google.com/open-source/soc/?csw=1">Google Summer of Code</a> 2014 efforts on EC2 bindings.</li></ul>

<h3>Upcoming features</h3>

<p>So what's coming up for our unikernels in 2015?  Our focus heading into the new year is very much on improving the ease-of-use and deployability of Mirage and fleshing out the feature set for the early adopters such as the <a href="https://github.com/xapi-project">XAPI</a> project, <a href="http://events.linuxfoundation.org/sites/events/files/slides/XenStore_MAC_XenSummit_2014.pdf">Galois</a>, and the <a href="http://nymote.org">Nymote</a> personal data project.  Here are some of the highlights:</p>
<ul><li><p><strong>Dust Clouds</strong>: The work on Jitsu is leading to the construction of what we term &quot;<a href="http://anil.recoil.org/papers/2010-iswp-dustclouds.pdf">dust clouds</a>&quot;: on-demand scaling of unikernel services within milliseconds of requests coming in, terminated right beside the user on local ARM devices.  The model supports existing clouds as well, and so we are improving support for cloud APIs such via Jyotsna Prakash's <a href="https://github.com/moonlightdrive/ocaml-ec2">EC2</a> bindings, <a href="https://github.com/djs55/xe-unikernel-upload">XenAPI</a>, and (volunteers needed) OpenStack support.  If you're interested in tracking this work, head over to the <a href="http://nymote.org">Nymote</a> site for updates.</p>
</li><li><p><strong>Portability</strong>: Beyond Xen, there are several efforts afoot to port Mirage to bare metal targets.  One promising effort is to use <a href="http://rumpkernel.org">Rump Kernels</a> as the boot infrastructure and Mirage as the application stack.  We hope to have a Raspberry Pi and other ARM targets fairly soon.  Meanwhile at the end of the spectrum is mobile computing, which was part of the original <a href="http://anil.recoil.org/papers/2010-bcs-visions.pdf">multiscale</a> vision for starting the project.  The JavaScript, iOS and Android ports are all progressing (mainly thanks to community contributions around OCaml support for this space, such as Jeff Psellos' hard work on <a href="http://psellos.com/ocaml/">OCaml-IOS</a>).</p>
</li><li><p><strong>Protocol Development</strong>: There are a huge number of protocols being developed independently, and more are always welcome.  <a href="https://github.com/infidel">Luke Dunstan</a> is hacking on <a href="https://github.com/mirage/ocaml-dns/pull/35#discussion_r22388447">multicast DNS</a> support, we have an IMAP <a href="https://github.com/nojb/ocaml-imap">client</a> and <a href="https://github.com/gregtatcam/imaplet-lwt/">server</a>, <a href="https://github.com/dominicjprice">Dominic Price</a> has built a series of social network APIs for <a href="https://github.com/dominicjprice/sociaml-facebook-api">Facebook</a> or <a href="https://github.com/dominicjprice/sociaml-tumblr-api">Tumblr</a>, and <a href="http://nottingham.ac.uk/horizon/people/masoud.koleini">Masoud Koleini</a> has been extending Haris Rotsos' work to achieve a line-rate and type-safe <a href="https://github.com/mirage/ocaml-openflow">OpenFlow</a> switch and controller based on the <a href="https://github.com/frenetic-lang">Frenetic</a> project.  Hannes is also developing <a href="https://github.com/hannesm/jackline">Jackline</a>, which uses his Mirage to assemble a trustworthy communication client.  <a href="http://erratique.ch/software">Daniel Buenzli</a> also continues to release a growing set of high-quality, modular libraries that we depend on throughout Mirage.</p>
</li><li><p><strong>Storage</strong>: All storage services from the unikernels will be Git-based (e.g. logging, command-and-control, key-value retrieval).  Expect to see Xen toolstack extensions that make this support seamless, so a single Linux VM will be able to control a large army of unikernels via persistent data structures.</p>
</li></ul>

<h3>Want to get involved?</h3>

<p>This is a really fun time to get involved with unikernels and the Mirage project. The year of 2014 has seen <a href="http://openmirage.org/links/">lots of discussion</a> about the potential of unikernels and we'll see some of the first big deployments involving them in 2015.  For the ones among you who wish to learn more, then check out the <a href="https://github.com/mirage/mirage-www/wiki/Pioneer-Projects">pioneer projects</a>, watch out for <a href="http://openmirage.org/wiki">Amir's meeting notes</a> and join the voice calls if you want a more interactive discussion, and engage on the <a href="http://openmirage.org/community/">mailing lists</a> with any questions you might have.</p>
<p>For me personally, it's been a real privilege to spend the year working with and learning from the friendly, intelligent and diverse community that is springing up around the project.  The progression from experiment to reality has been a lot of work, but the unikernel dream is finally coming together rath[er nicely thanks to everyone's hard work and enthusiasm.  I'd also like to thank all of our <a href="http://openmirage.org/community/">funding bodies</a> and the <a href="http://linuxfoundation.org">Linux Foundation</a> and the <a href="http://xenproject.org">Xen Project</a> (especially Lars Kurth and Russell Pavlicek) for their support throughout the year that made all this work possible.  Happy new year, everyone!</p>

   <a onclick="switchContent('ocamlorg-post12','ocamlorg-post11')" class="btn planet-toggle" href="#http://openmirage.org/blog/2014-in-review">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/2014-in-review">by Anil Madhavapeddy at Dec 31, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad/">
    <a name="#http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad/">Visualising an asynchronous monad</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post13"><p>Many asynchronous programs make use of <a href="http://en.wikipedia.org/wiki/Promise_(programming)">promises</a> (also known as using <em>light-weight threads</em> or an <em>asynchronous monad</em>) to manage concurrency.
I&rsquo;ve been working on tools to collect trace data from such programs and visualise the results, to help with profiling and debugging.</p>

<p>The diagram below shows a trace from a <a href="http://openmirage.org/">Mirage unikernel</a> reading data from disk in a loop.
You should be able to pan around by dragging in the diagram, and zoom by using your mouse&rsquo;s scroll wheel.
If you&rsquo;re on a mobile device then pinch-to-zoom should work if you follow the full-screen link, although it will probably be slow.
If nothing else works, the ugly zoom buttons at the bottom zoom around the last point clicked.</p>



<canvas style="width: 100%; height: 500px">
  <p>
  <img src="http://roscidus.com/blog/images/mirage-profiling/trace-viewer-console.png" width="622" height="484" alt="Mirage Trace Viewer screenshot"/><br/>
  <strong>WARNING: No HTML canvas support (this is just a static image)! Try a newer browser&hellip;</strong>
  </p>
</canvas>
<p><a href="http://roscidus.com/blog/javascripts/trace-viewer.html?trace=intro">View full screen</a></p>

<p>The web viewer requires JavaScript and HTML canvas support.
If it doesn&rsquo;t work, you can also build the <a href="https://github.com/talex5/mirage-trace-viewer">trace viewer</a> as a (much faster) native GTK application.</p>

<p>In this post I&rsquo;&hellip;</p><a onclick="switchContent('ocamlorg-post13','ocamlorg-post14')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad/">Read more...</a></div><div id="ocamlorg-post14" style="display: none"><p>Many asynchronous programs make use of <a href="http://en.wikipedia.org/wiki/Promise_(programming)">promises</a> (also known as using <em>light-weight threads</em> or an <em>asynchronous monad</em>) to manage concurrency.
I&rsquo;ve been working on tools to collect trace data from such programs and visualise the results, to help with profiling and debugging.</p>

<p>The diagram below shows a trace from a <a href="http://openmirage.org/">Mirage unikernel</a> reading data from disk in a loop.
You should be able to pan around by dragging in the diagram, and zoom by using your mouse&rsquo;s scroll wheel.
If you&rsquo;re on a mobile device then pinch-to-zoom should work if you follow the full-screen link, although it will probably be slow.
If nothing else works, the ugly zoom buttons at the bottom zoom around the last point clicked.</p>



<canvas style="width: 100%; height: 500px">
  <p>
  <img src="http://roscidus.com/blog/images/mirage-profiling/trace-viewer-console.png" width="622" height="484" alt="Mirage Trace Viewer screenshot"/><br/>
  <strong>WARNING: No HTML canvas support (this is just a static image)! Try a newer browser&hellip;</strong>
  </p>
</canvas>
<p><a href="http://roscidus.com/blog/javascripts/trace-viewer.html?trace=intro">View full screen</a></p>

<p>The web viewer requires JavaScript and HTML canvas support.
If it doesn&rsquo;t work, you can also build the <a href="https://github.com/talex5/mirage-trace-viewer">trace viewer</a> as a (much faster) native GTK application.</p>

<p>In this post I&rsquo;ll explain how to read these diagrams, and how to trace your own programs.</p>

<p>( this post also appeared on <a href="https://news.ycombinator.com/item?id=8514923">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/2kgp50/visualising_an_asynchronous_monad/">Reddit</a> )</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#introduction">Introduction</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#bind">Bind</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#join">Join</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#choose">Choose</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#pick">Pick</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#exceptions">Exceptions</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#making-your-own-traces">Making your own traces</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#examples">Examples</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#profiling-the-console">Profiling the console</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#udp-transmission">UDP transmission</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#tcp-transmission">TCP transmission</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#disk-access">Disk access</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#implementation-notes">Implementation notes</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#summary">Summary</a></li>
</ul>

<h2>Introduction</h2>

<p>Many asynchronous programs make use of <em>promises</em> (also known as using <em>light-weight threads</em> or an <em>asynchronous monad</em>).
A promise/thread is a place-holder for a value that will arrive in the future.</p>

<p>Here&rsquo;s a really simple example (an OCaml program using <a href="http://ocsigen.org/lwt/">Lwt</a>).
It creates a thread that resolves to unit (void) after one second:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">open</span> <span class="nc">Lwt</span>
</span><span class="line"><span class="k">open</span> <span class="nc">Lwt_unix</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">example_1</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">sleep</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="c">(* Run the main loop until example_1 resolves. *)</span>
</span><span class="line">  <span class="nn">Lwt_unix</span><span class="p">.</span><span class="n">run</span> <span class="o">(</span><span class="n">example_1</span> <span class="bp">()</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<canvas style="width: 100%; height: 106px"></canvas>

<p>In the diagram, time runs from left to right.
Threads (promises) are shown as horizontal lines.
The diagram shows:</p>

<ul>
  <li>Initially, only the main thread (&ldquo;0&rdquo;) is present.</li>
  <li>The main thread then creates a new thread, labelled &ldquo;sleep&rdquo;.</li>
  <li>The sleep thread is a &ldquo;task&rdquo; thread (this is just a helpful label added when the thread is created).</li>
  <li>The whole process then goes to sleep for one second, which is shown by the darker background.</li>
  <li>At the end of the second, the process wakes up and resolves the sleep thread to its value (unit), shown by the green arrow.</li>
  <li>The main thread, which was waiting for the sleep thread, reads the value (the blue arrow) and exits the program.</li>
</ul>

<p>If you zoom in on the arrows (go down to a grid division of about 10 microseconds), you&rsquo;ll also see a white segment on the main thread, which shows when it was running (only one thread runs at a time).</p>

<p>Because thread 0 is actually the main event loop (rather than a Lwt thread), things are a little more complicated than normal.
When the process has nothing to do, thread 0 puts the process to sleep until the next scheduled timer.
When the OS wakes the process, thread 0 resumes, determines that the &ldquo;sleep&rdquo; thread can be resolved, and does so.
This causes any callbacks registered on the sleep thread to be called, but in this case there aren&rsquo;t any and control returns to thread 0.
Thread 0 then checks the sleep thread (because that determines when to finish), and ends the loop because it&rsquo;s resolved.</p>

<h3>Bind</h3>

<p>Callbacks can be attached to a promise/thread to process the value when it arrives.
Attaching the callback immediately creates a new promise for the final result of the callback.</p>

<p>Here&rsquo;s a program that sleeps twice in series.
The <code>&gt;&gt;=</code> (bind) operator attaches the callback function to the first thread.
I&rsquo;ve made the sleeps very short so you can see the process waking up without having to zoom.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">example_2</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">00001</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">  <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">00001</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<canvas style="width: 100%; height: 136px"></canvas>

<p>In this case, the main thread creates two new threads at the start: one for the result of the first sleep and a second (&ldquo;bind&rdquo;) for the result of running the callback on the result.
It&rsquo;s easier to see how the first thread is resolved here: the main thread handling the polling loop wakes up and resolves the sleep thread, which then causes the bind thread to resume.</p>

<p>You might wonder why the bind thread disappears when the second sleep starts.
It hasn&rsquo;t finished, but when the bind&rsquo;s callback function returns the second sleep thread as its result, the bind thread is merged with the sleep thread.
This is the asynchronous equivalent of a tail call optimisation, allowing us to create loops without needing an unbounded number of threads.</p>

<p>Actually, displaying binds in this way tends to clutter up the diagrams, so the viewer has a simplification rule that is enabled by default: if the first event on a bind thread is a read, the part of the bind up to that point isn&rsquo;t drawn.
Therefore, the default display for this program is:</p>

<canvas style="width: 100%; height: 106px"></canvas>

<p>If you zoom in on the central green arrow, you can see the tiny remaining bind thread between the two sleeps.</p>

<h3>Join</h3>

<p><code>Lwt.join</code> waits for a collection of threads to finish:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">example_3</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">join</span> <span class="o">[</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">003</span><span class="o">;</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">001</span><span class="o">;</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">002</span><span class="o">;</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<canvas style="width: 100%; height: 196px"></canvas>

<p>In the trace, you can see the join thread being notified each time one of the threads it&rsquo;s waiting for completes.
When they&rsquo;re all done, it resolves itself.</p>

<h3>Choose</h3>

<p><code>Lwt.choose</code> is similar to join, but only waits until one of its threads finishes:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">example_4</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">choose</span> <span class="o">[</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">003</span><span class="o">;</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">00001</span><span class="o">;</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">002</span><span class="o">;</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<canvas style="width: 100%; height: 196px"></canvas>

<p>I cheated a bit here.
To avoid clutter, the viewer only draws each thread until its last recorded event (without this, threads that get garbage collected span the whole width of the trace), so I used <code>Profile.label ~thread &quot;(continues)&quot;</code> to create extra label events on the two remaining threads to make it clearer what&rsquo;s happening here.</p>

<h3>Pick</h3>

<p><code>Lwt.pick</code> is similar to choose, but additionally cancels the other threads:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">example_5</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">pick</span> <span class="o">[</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">003</span><span class="o">;</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">00001</span><span class="o">;</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">001</span><span class="o">;</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<canvas style="width: 100%; height: 196px"></canvas>

<h3>Exceptions</h3>

<p>Failed threads are shown with a red bar at the end and the exception message is displayed.
Also, any &ldquo;reads&rdquo; arrow coming from it is shown in red rather than blue.
Here, the bind thread fails but the try one doesn&rsquo;t because it catches the exception and returns unit.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">example_6</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">try_lwt</span>
</span><span class="line">    <span class="n">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0001</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">failwith</span> <span class="s2">&quot;oops&quot;</span>
</span><span class="line">  <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">return</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note: I&rsquo;m using the Lwt syntax extension here for <code>try_lwt</code>, but you can use <code>Lwt.try_bind</code> if you prefer.</p>

<canvas style="width: 100%; height: 106px"></canvas>

<p>The same simplification done for &ldquo;bind&rdquo; threads also applies to &ldquo;try&rdquo; threads, so the try thread doesn&rsquo;t appear at all until you zoom in on the red arrow.</p>

<h2>Making your own traces</h2>

<p>Update: These instructions were out-of-date so I&rsquo;ve removed them. See the <a href="https://github.com/mirage/mirage-profile">mirage-profile</a> page for up-to-date instructions.</p>

<h2>Examples</h2>

<p>A few months ago, I made <a href="http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">my first unikernel</a> - a REST service for queuing files as a Xen guest OS.
Unlike a normal guest, which would include a Linux kernel, init system, libc, shell, Apache, etc, a Mirage unikernel is a single executable, and almost pure OCaml (apart from malloc, the garbage collector, etc).
Unikernels can be very small and simple, and have a much smaller attack surface than traditional systems.</p>

<p>For my first attempt at <a href="http://roscidus.com/blog/blog/2014/08/15/optimising-the-unikernel/">optimising the unikernel</a>, I used OCaml&rsquo;s built-in profiling support.
This recorded function calls and how much time was spent in each one.
But I quickly discovered that CPU time was rarely the important factor - how the various asynchronous threads were scheduled was more important, and the tracing made it difficult to see this.</p>

<p>So, let&rsquo;s see how the new tracing does on my previous problems&hellip;</p>

<h3>Profiling the console</h3>

<p>In the previous profiling post, I generated this graph using libreoffice:</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/xen-console-messages.png" class="border center"/></p>

<p>As a reminder, Xen guests output to the console by writing the text to a shared memory page, increasing a counter to indicate this, and signalling dom0. The console logger in dom0 reads the data, increments another counter to confirm it got it, and signals back to the guest that that part of the buffer is free again.</p>

<p>To use the new tracing system, I added a <code>Profile.note_increase &quot;sent&quot; len</code> to the main loop, which increments a &ldquo;sent&rdquo; count on each iteration (i.e. each time we write a line to the console).
The viewer adds a mark on the trace for each increment and overlays a graph (the red line) so you can see overall progress easily:</p>

<canvas style="width: 100%; height: 300px"></canvas>
<p><a href="http://roscidus.com/blog/javascripts/trace-viewer.html?trace=console">View full screen</a> | <a href="http://roscidus.com/blog/data/traces/console.sexp">Download console.sexp</a></p>

<p>As before, we can see that we send messages rapidly in bursts, followed by long periods without progress.
Zooming in to the places where the red line is increasing, we can see the messages being written to the buffer without any delays.
Looking at the edges of the sleeping regions, it&rsquo;s clear that we&rsquo;re simply waiting for Xen to notify us of space by signalling us on event channel 2.</p>

<p>Here&rsquo;s the complete test code:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">open</span> <span class="nc">Lwt</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nc">Main</span> <span class="o">(</span><span class="nc">C</span><span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">CONSOLE</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Profile</span><span class="p">.</span><span class="n">start</span> <span class="o">~</span><span class="n">size</span><span class="o">:</span><span class="mi">10000</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">start</span> <span class="n">c</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">msg</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="o">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="sc">'X'</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1800</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">iterations</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">      <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="bp">()</span>
</span><span class="line">      <span class="o">|</span> <span class="n">i</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="nn">Profile</span><span class="p">.</span><span class="n">note_increase</span> <span class="s2">&quot;sent&quot;</span> <span class="n">len</span><span class="o">;</span>
</span><span class="line">          <span class="nn">C</span><span class="p">.</span><span class="n">log_s</span> <span class="n">c</span> <span class="n">msg</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="o">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="n">t0</span> <span class="o">=</span> <span class="nn">Clock</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">    <span class="n">loop</span> <span class="n">iterations</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="nn">Clock</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-.</span> <span class="n">t0</span> <span class="k">in</span>
</span><span class="line">    <span class="nn">C</span><span class="p">.</span><span class="n">log_s</span> <span class="n">c</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Wrote %d bytes in %.3f seconds (%.2f KB/s)&quot;</span>
</span><span class="line">      <span class="n">bytes</span> <span class="n">time</span>
</span><span class="line">      <span class="o">(</span><span class="n">float_of_int</span> <span class="n">bytes</span> <span class="o">/.</span> <span class="n">time</span> <span class="o">/.</span> <span class="mi">1024</span><span class="o">.))</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="n">events</span> <span class="o">=</span> <span class="nn">Profile</span><span class="p">.</span><span class="n">events</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">    <span class="n">for_lwt</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">events</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
</span><span class="line">      <span class="nn">C</span><span class="p">.</span><span class="n">log_s</span> <span class="n">c</span> <span class="o">(</span><span class="nn">Profile</span><span class="p">.</span><span class="n">to_string</span> <span class="n">events</span><span class="o">.(</span><span class="n">i</span><span class="o">))</span>
</span><span class="line">    <span class="k">done</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">OS</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>UDP transmission</h3>

<p>Last time, we saw packet transmission being interrupted by periods of sleeping, garbage collection, and some brief but mysterious pauses.
I noted that the GC tended to run during <code>Ring.ack_responses</code>, suggesting that was getting called quite often, and with the new tracing we can see why.</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/udp-packets.png" class="border center"/></p>

<p>This trace shows a unikernel booting (scroll left if you want to see that) and then sending 10 UDP packets.
I&rsquo;ve left the trace running a little longer so you can see the acks (this is very obvious when sending more than 10 packets, but I wanted to keep this trace small):</p>

<canvas style="width: 100%; height: 700px"></canvas>
<p><a href="http://roscidus.com/blog/javascripts/trace-viewer.html?trace=udp">View full screen</a> | <a href="http://roscidus.com/blog/data/traces/udp.sexp">Download udp.sexp</a></p>

<p>Mirage creates two threads for each packet that we add to the ring buffer and they stick around until we get a notification back from dom0 that the packet has been read (actually, we create six threads for each packet, but the bind simplification hides four of them).</p>

<p>It looks like each packet is in two parts, as each one generates two acks, one much later than the other.
I think the two parts are the UDP header and the payload, which each have their own IO page.
Given the time needed to share and unshare pages, it would probably be more efficient to copy the payload into the same page as the header.
Interestingly, dom0 seems to ack all the headers first, but holds on to the payload pages for longer.</p>

<p>With 20 threads for just ten packets, you can imagine that the trace gets rather crowded when sending thousands!</p>

<h3>TCP transmission</h3>

<p>As before, the TCP picture is rather complicated:</p>

<canvas style="width: 100%; height: 700px"></canvas>
<p><a href="http://roscidus.com/blog/javascripts/trace-viewer.html?trace=tcp">View full screen</a> | <a href="http://roscidus.com/blog/data/traces/tcp.sexp">Download tcp.sexp</a></p>

<p>The above shows a unikernel running on my ARM Cubietruck connecting to netcat on my laptop and sending 100 TCP packets over the stream.
There are three counters here:</p>

<ul>
  <li><code>main-to-tcp</code> (purple) is incremented by the main thread just before sending a block of data to the TCP stream (just enough to fill one TCP segment).</li>
  <li><code>tcp-to-ip</code> (red) shows when the TCP system sent a segment to the IP layer for transmission.</li>
  <li><code>tcp-ackd-segs</code> (orange) shows when the TCP system got confirmation of receipt from the remote host (note: a TCP ask is not the same as a dom0 ring ack, which just says the network driver has accepted the segment for transmission).</li>
</ul>

<p>There is clearly scope to improve the viewer here, but a few things can be seen already.
The general cycle is:</p>

<ul>
  <li>The unikernel is sleeping, waiting for TCP acks.</li>
  <li>The remote end acks some packets (the orange line goes up).</li>
  <li>The TCP layer transmits some of the buffered packets (red line goes up).</li>
  <li>The TCP layer allows the main code to send more data (purple line goes up).</li>
  <li>The transmitted pages are freed (the dense vertical green lines) once Xen acks them.</li>
</ul>

<p>I did wonder whether we unshared the pages as soon as dom0 had read the segment, or only when the remote end sent the TCP ack.
Having the graphs overlaid on the trace lets us answer this question - you can see that when the red line goes up (segments sent to dom0), the <code>ring.write</code> thread that is created then ends (and the page is unshared) in response to <code>ring.poll ack_responses</code>, before the TCP acks arrive.</p>

<p>TCP starts slowly, but as the window size gets bigger and more packets are transmitted at a time, the sleeping periods get shorter and then disappear as the process becomes CPU-bound.</p>

<p>There&rsquo;s also a long garbage collection period near the end (shortly before we close the socket).
This might be partly the fault of the tracing system, which currently allocates lots of small values, rather than writing to a preallocated buffer.</p>

<h3>Disk access</h3>

<p>For our final example, let&rsquo;s revisit the block device profiling from last time.
Back then, making a series of read requests, each for 32 pages of data, produced this chart:</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/block-reads-1-32.png" class="border center"/></p>

<p>With the new tracing, we can finally see what those mysterious wake-ups in the middle are:</p>

<canvas style="width: 100%; height: 500px"></canvas>
<p><a href="http://roscidus.com/blog/javascripts/trace-viewer.html?trace=disk-direct">View full screen</a> | <a href="http://roscidus.com/blog/data/traces/disk-direct.sexp">Download disk-direct.sexp</a></p>

<p>Each time the main test code&rsquo;s read call returns, the orange trace (&ldquo;read&rdquo;) goes up.
You can see that we make three blocking calls to dom0 for each request.
I added another counter for the number of active grant refs (pages shared with dom0), shown as the red line (&ldquo;gntref&rdquo;).
You can see that for each call we share a bunch of pages, wait, and then unshare them all again.</p>

<p>In each group of three, we share 11 pages for the first two requests, but only 10 for the third.
This makes obvious what previously required a careful reading of the block code: requests for more than 11 pages have to be split up because that&rsquo;s all you can fit in the request structure.
Our request for 32 pages is split into requests for 11 + 11 + 10 pages, which are sent in series.</p>

<p>In fact, Xen also supports &ldquo;indirect&rdquo; requests, where the request structure references full pages of requests.
I added support for this to mirage-block-xen, which improved the speed nicely.
Here&rsquo;s a trace with indirect requests enabled:</p>

<canvas style="width: 100%; height: 500px"></canvas>
<p><a href="http://roscidus.com/blog/javascripts/trace-viewer.html?trace=disk-indirect">View full screen</a> | <a href="http://roscidus.com/blog/data/traces/disk-indirect.sexp">Download disk-indirect.sexp</a></p>

<p>If you zoom in where the red line starts to rise, you can see it has 32 steps, as we allocate all the pages in one go, followed by a final later increment for the indirect page.</p>

<p>Zooming out, you can see we paused for GC a little later.
We got lucky here, with the GC occurring just after we sent the request and just before we started waiting for the reply, so it hardly slowed us down.
If we&rsquo;d been unlucky the GC might have run before we sent the request, leaving dom0 idle and wasting the time.
Keeping multiple requests in flight would eliminate this risk.</p>

<h2>Implementation notes</h2>

<p>I originally wrote the viewer as a native GTK application in OCaml.
The browser version was created by running the magical <a href="http://ocsigen.org/js_of_ocaml/">js_of_ocaml</a> tool, which turned out to be incredibly easy.
I just had to add support for the HTML canvas API alongside the code for GTK&rsquo;s Cairo canvas, but they&rsquo;re almost the same anyway.
Now my embarrassing inability to learn JavaScript need not hold me back!</p>

<p>Finding a layout algorithm that produced sensible results was the hardest part.
I&rsquo;m quite pleased with the result.
The basic algorithm is:</p>

<ul>
  <li>Generate an <a href="http://en.wikipedia.org/wiki/Interval_tree">interval tree</a> of the thread lifetimes.</li>
  <li>Starting with the root thread, place each thread at the highest place on the screen where it doesn&rsquo;t overlap any other threads, and no higher than its parent.</li>
  <li>Visit the threads recursively, depth first, visiting the child threads created in <em>reverse</em> order.</li>
  <li>If one thread merges with another, allow them to overlap.</li>
  <li>Don&rsquo;t show bind-type threads as children of their actual creator, but instead delay their start time to when they get activated and make them children of the thread that activates them, <em>unless</em> their parent merges with them.</li>
</ul>

<p>For the vertical layout I originally used scrolling, but it was hard to navigate.
It now transforms the vertical coordinates from the layout engine by passing them through the <code>tanh</code> function, allowing you to focus on a particular thread but still see all the others, just more bunched up.
The main difficulty here is focusing on one of the top or bottom threads without wasting half the display area, which complicated the code a bit.</p>

<h2>Summary</h2>

<p>Understanding concurrent programs can be much easier with a good visualisation.
By instrumenting Lwt, it was quite easy to collect useful information about what threads were doing.
Libraries that use Lwt only needed to be modified in order to label the threads.</p>

<p>My particular interest in making these tools is to explore the behaviour of <a href="http://openmirage.org/">Mirage unikernels</a> - tiny virtual machines written in OCaml that run without the overhead of traditional operating systems.</p>

<p>The traces produced provide much more information than the graphs I made previously.
We can see now not just when the unikernel isn&rsquo;t making progress, but why.
We saw that the networking code spends a lot of time handling ack messages from dom0 saying that it has read the data we shared with it, and that the disk code was splitting requests into small chunks because it didn&rsquo;t support indirect requests.</p>

<p>There is plenty of scope for improvement in the tools - some things I&rsquo;d like include:</p>

<ul>
  <li>A way to group or hide threads if you want to focus on something else, as diagrams can become very cluttered with e.g. threads waiting for shared pages to be released.</li>
  <li>The ability to stitch together traces from multiple machines so you can e.g. follow the progress of an IP packet after it leaves the VM.</li>
  <li>A visual indication of when interrupts occur vs when Mirage gets around to servicing them.</li>
  <li>More stats collection and reporting (e.g. average response time to handle a TCP request, etc).</li>
  <li>A more compact log format and more efficient tracing.</li>
</ul>

<p>But hopefully, these tools will already help people to learn more about how their unikernels behave.
If you&rsquo;re interested in tracing or unikernels, the <a href="http://openmirage.org/community/">Mirage mailing list</a> is a good place to discuss things.</p>





<a onclick="switchContent('ocamlorg-post14','ocamlorg-post13')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2014/10/27/visualising-an-asynchronous-monad/">by Thomas Leonard at Oct 27, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://ocamllabs.github.com/compiler-hacking/2014/09/23/compiler-hacking-by-the-river">
    <a name="#http://ocamllabs.github.com/compiler-hacking/2014/09/23/compiler-hacking-by-the-river"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../images/hax0ring.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://ocamllabs.github.com/compiler-hacking/2014/09/23/compiler-hacking-by-the-river">Eighth OCaml compiler hacking evening (at Mill Lane, by the river)</a>
      (<a href="http://ocamllabs.github.io/compiler-hacking/rss.xml" title="OCaml Labs compiler hacking">Compiler Hacking</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post15"><p><strong>Update: This session will be a joint F#/OCaml hacking event, beginning with a talk from Don Syme about F# compiler and language development!</strong></p>

<p>For the eighth Cambridge OCaml compiler hacking evening we'll be meeting in the <a href="http://www.cam.ac.uk/news/first-ever-postdoc-centre-is-new-home-for-research-staff">University Postdoc centre</a> at <a href="https://goo.gl/maps/cZXev">16 Mill Lane</a> (near the river, next door to <a href="http://makespace.org/space/">Makespace</a>) on 6.30pm Tuesday 30th September.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/svwkevcs5p2xs8n8"><strong>indicate interest via Doodle</strong></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking">sign up to the mailing list</a> to receive updates:</p>

<p><strong>Where</strong>:
  Postdoc Centre<br/>
  Basement, <a href="https://goo.gl/maps/cZXev">16 Mill Lane</a><br/>
  Cambridge, CB2 1SB<br/>
  United Kingdom  </p>

<p><strong>When</strong>: 6.30pm, Tuesday 30th September</p>

<p><strong>Who</strong>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><strong>What</strong>: fixing bugs, implementing new features, learning about OCaml internals.  This time we'll be focusing on code quality: refactoring, adding test cases, reviewng existing proposals and updating packages after the r&hellip;</p><a onclick="switchContent('ocamlorg-post15','ocamlorg-post16')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/09/23/compiler-hacking-by-the-river">Read more...</a></div><div id="ocamlorg-post16" style="display: none"><p><strong>Update: This session will be a joint F#/OCaml hacking event, beginning with a talk from Don Syme about F# compiler and language development!</strong></p>

<p>For the eighth Cambridge OCaml compiler hacking evening we'll be meeting in the <a href="http://www.cam.ac.uk/news/first-ever-postdoc-centre-is-new-home-for-research-staff">University Postdoc centre</a> at <a href="https://goo.gl/maps/cZXev">16 Mill Lane</a> (near the river, next door to <a href="http://makespace.org/space/">Makespace</a>) on 6.30pm Tuesday 30th September.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/svwkevcs5p2xs8n8"><strong>indicate interest via Doodle</strong></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking">sign up to the mailing list</a> to receive updates:</p>

<p><strong>Where</strong>:
  Postdoc Centre<br/>
  Basement, <a href="https://goo.gl/maps/cZXev">16 Mill Lane</a><br/>
  Cambridge, CB2 1SB<br/>
  United Kingdom  </p>

<p><strong>When</strong>: 6.30pm, Tuesday 30th September</p>

<p><strong>Who</strong>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><strong>What</strong>: fixing bugs, implementing new features, learning about OCaml internals.  This time we'll be focusing on code quality: refactoring, adding test cases, reviewng existing proposals and updating packages after the recent <a href="https://sympa.inria.fr/sympa/arc/caml-list/2014-08/msg00127.html">release of OCaml 4.02</a>.</p>

<p><strong>Wiki</strong>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-projects</a> for various levels of experience (see also some <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-previously-worked-on">things we've done on previous evenings</a>), but feel free to come along and work on whatever you fancy.</p>

<p>We'll also be ordering pizza, so if you want to be counted for food you should aim to arrive by 6.45pm.</p>
<a onclick="switchContent('ocamlorg-post16','ocamlorg-post15')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/09/23/compiler-hacking-by-the-river">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://ocamllabs.github.com/compiler-hacking/2014/09/23/compiler-hacking-by-the-river">by Compiler Hacking at Sep 23, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2014/09/17/simplifying-the-solver-with-functors/">
    <a name="#http://roscidus.com/blog/blog/2014/09/17/simplifying-the-solver-with-functors/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2014/09/17/simplifying-the-solver-with-functors/">Simplifying the solver with functors</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post17"><p>After <a href="http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/">converting 0install to OCaml</a>, I&rsquo;ve been looking at using more of OCaml&rsquo;s features to further clean up the APIs.
In this post, I describe how using OCaml functors has made 0install&rsquo;s dependency solver easier to understand and more flexible.</p>



<p>( this post also appeared on <a href="https://news.ycombinator.com/item?id=8342826">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/2gw0dn/simplifying_0installs_solver_with_ocamls_functors/">Reddit</a> )</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#introduction">Introduction</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#how-dependency-solvers-work">How dependency solvers work</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#optimising-the-result">Optimising the result</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#the-current-solver-code">The current solver code</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#discovering-the-interface">Discovering the interface</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#comparison-with-java">Comparison with Java</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#diagnostics">Diagnostics</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#selections">Selections</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#summary">Summary</a></li>
</ul>

<h2>Introduction</h2>

<p>To run a program you need to pick a version of it to use, as well as compatible versions of all its dependencies.
For example, if you wanted <a href="http://0install.net/">0install</a> to select a suitable set of components to run <a href="http://www.serscis.eu/0install/serscis-access-modeller">SAM</a>, you could do it like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$ 0install select http://www.serscis.eu/0install/serscis-access-modeller
</span><span class="line">- URI: http://www.serscis.eu/0install/serscis-access-modeller
</span><span class="line">  Version: 0.16
</span><span class="line">  Path: (not cached)&hellip;</span></code></pre></td></tr></table></div></figure></notextile></div><a onclick="switchContent('ocamlorg-post17','ocamlorg-post18')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/09/17/simplifying-the-solver-with-functors/">Read more...</a></div><div id="ocamlorg-post18" style="display: none"><p>After <a href="http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/">converting 0install to OCaml</a>, I&rsquo;ve been looking at using more of OCaml&rsquo;s features to further clean up the APIs.
In this post, I describe how using OCaml functors has made 0install&rsquo;s dependency solver easier to understand and more flexible.</p>



<p>( this post also appeared on <a href="https://news.ycombinator.com/item?id=8342826">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/2gw0dn/simplifying_0installs_solver_with_ocamls_functors/">Reddit</a> )</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#introduction">Introduction</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#how-dependency-solvers-work">How dependency solvers work</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#optimising-the-result">Optimising the result</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#the-current-solver-code">The current solver code</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#discovering-the-interface">Discovering the interface</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#comparison-with-java">Comparison with Java</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#diagnostics">Diagnostics</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#selections">Selections</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#summary">Summary</a></li>
</ul>

<h2>Introduction</h2>

<p>To run a program you need to pick a version of it to use, as well as compatible versions of all its dependencies.
For example, if you wanted <a href="http://0install.net/">0install</a> to select a suitable set of components to run <a href="http://www.serscis.eu/0install/serscis-access-modeller">SAM</a>, you could do it like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$ 0install select http://www.serscis.eu/0install/serscis-access-modeller
</span><span class="line">- URI: http://www.serscis.eu/0install/serscis-access-modeller
</span><span class="line">  Version: 0.16
</span><span class="line">  Path: (not cached)
</span><span class="line">  
</span><span class="line">  - URI: http://repo.roscidus.com/utils/graphviz
</span><span class="line">    Version: 2.38.0-2
</span><span class="line">    Path: (package:arch:graphviz:2.38.0-2:x86_64)
</span><span class="line">  
</span><span class="line">  - URI: http://repo.roscidus.com/java/swt
</span><span class="line">    Version: 3.6.1
</span><span class="line">    Path: (not cached)
</span><span class="line">  
</span><span class="line">  - URI: http://repo.roscidus.com/java/iris
</span><span class="line">    Version: 0.6.0
</span><span class="line">    Path: (not cached)
</span><span class="line">  
</span><span class="line">  - URI: http://repo.roscidus.com/java/openjdk-jre
</span><span class="line">    Version: 7.65-2.5.2-1
</span><span class="line">    Path: (package:arch:jre7-openjdk:7.65-2.5.2-1:x86_64)</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here, the solver selected SAM version 0.16, along with its dependencies. GraphViz 2.38.0 and OpenJDK-JRE 7.65 are already installed from my distribution repository, while SWT 3.6.1 and IRIS 0.6.0 need to be downloaded (e.g. using <code>0install download</code>).</p>

<p>This post is about the code that decides which versions to use, and my attempts to make it easier to understand using OCaml functors and abstraction.
For a gentle introduction to functors, see <a href="https://realworldocaml.org/v1/en/html/functors.html">Real World OCaml: Chapter 9. Functors</a>.</p>

<h3>How dependency solvers work</h3>

<p>( This section isn&rsquo;t about functors, but it&rsquo;s quite interesting background. You can skip it if you prefer. )</p>

<p>Let&rsquo;s say I want to run <code>foo</code>, a graphical Java application.
There are three versions available:</p>

<ul>
  <li><code>foo1</code> (stable)
    <ul>
      <li>requires Java 6..!7 (at least version 6, but before version 7)</li>
    </ul>
  </li>
  <li><code>foo2</code> (stable)
    <ul>
      <li>requires Java 6.. (at least version 6)</li>
      <li>requires SWT</li>
    </ul>
  </li>
  <li><code>foo3</code> (testing)
    <ul>
      <li>requires Java 7..</li>
      <li>requires SWT</li>
    </ul>
  </li>
</ul>

<p>Let&rsquo;s imagine we have some candidates for Java and SWT too:</p>

<ul>
  <li>Java: <code>java6_32bit</code>, <code>java6_64bit</code>, <code>java7_64bit</code>, <code>java8_64bit</code></li>
  <li>SWT: <code>swt35_32bit</code>, <code>swt35_64bit</code>, <code>swt36_32bit</code>, <code>swt36_64bit</code></li>
</ul>

<p>My computer can run 32- and 64-bit binaries, so we need to consider both.</p>

<p>We start by generating a set of boolean constraints defining the necessary and sufficient conditions for a set of valid selections.
Each candidate becomes one variable, with <code>true</code> meaning it will be used and <code>false</code> that it won&rsquo;t (following the approach in <a href="https://cseweb.ucsd.edu/~lerner/papers/opium.html">OPIUM</a>).
For example, we don&rsquo;t want to select more than one version of each component, so the following must all be true:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">at_most_one</span><span class="p">(</span><span class="n">foo1</span><span class="p">,</span> <span class="n">foo2</span><span class="p">,</span> <span class="n">foo3</span><span class="p">)</span>
</span><span class="line"><span class="n">at_most_one</span><span class="p">(</span><span class="n">java6_32bit</span><span class="p">,</span> <span class="n">java6_64bit</span><span class="p">,</span> <span class="n">java7_64bit</span><span class="p">,</span> <span class="n">java8_64bit</span><span class="p">)</span>
</span><span class="line"><span class="n">at_most_one</span><span class="p">(</span><span class="n">swt35_32bit</span><span class="p">,</span> <span class="n">swt35_64bit</span><span class="p">,</span> <span class="n">swt36_32bit</span><span class="p">,</span> <span class="n">swt36_64bit</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We must select some version of <code>foo</code> itself, since that&rsquo;s our goal:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">foo1</span> <span class="ow">or</span> <span class="n">foo2</span> <span class="ow">or</span> <span class="n">foo3</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If we select <code>foo1</code>, we must select one of the Java 6 candidates.
Another way to say this is that we must either <em>not</em> select foo1 or, if we do, we must select a compatible Java version:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">foo1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">java6_32bit</span> <span class="ow">or</span> <span class="n">java6_64bit</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">foo2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">java6_32bit</span> <span class="ow">or</span> <span class="n">java6_64bit</span> <span class="ow">or</span> <span class="n">java7_64bit</span> <span class="ow">or</span> <span class="n">java8_64bit</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">foo3</span><span class="p">)</span> <span class="ow">or</span> <span class="n">java7_64bit</span> <span class="ow">or</span> <span class="n">java8_64bit</span>
</span><span class="line">
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">foo2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">swt35_32bit</span> <span class="ow">or</span> <span class="n">swt35_64bit</span> <span class="ow">or</span> <span class="n">swt36_32bit</span> <span class="ow">or</span> <span class="n">swt36_64bit</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">foo3</span><span class="p">)</span> <span class="ow">or</span> <span class="n">swt35_32bit</span> <span class="ow">or</span> <span class="n">swt35_64bit</span> <span class="ow">or</span> <span class="n">swt36_32bit</span> <span class="ow">or</span> <span class="n">swt36_64bit</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>SWT doesn&rsquo;t work with Java 8 (in this imaginary example):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">swt35_32bit</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">java8_64bit</span><span class="p">)</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">swt35_64bit</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">java8_64bit</span><span class="p">)</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">swt36_32bit</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">java8_64bit</span><span class="p">)</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">swt36_64bit</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">java8_64bit</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally, although we can use 32 bit or 64 bit programs, we can&rsquo;t mix different types within a single program:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">java6_32bit</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">x64</span><span class="p">)</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">java6_64bit</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x64</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">java7_64bit</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x64</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">java8_64bit</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x64</span>
</span><span class="line">
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">swt35_32bit</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">x64</span><span class="p">)</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">swt35_64bit</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x64</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">swt36_32bit</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">x64</span><span class="p">)</span>
</span><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">swt36_64bit</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x64</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Once we have all the equations, we throw them at a standard <a href="http://en.wikipedia.org/wiki/Boolean_satisfiability_problem">SAT</a> solver to get a set of valid versions.
0install&rsquo;s SAT solver is based on the <a href="http://minisat.se/Papers.html">MiniSat</a> algorithm.
The basic algorithm, <a href="http://en.wikipedia.org/wiki/DPLL_algorithm">DPLL</a>, works like this:</p>

<ol>
  <li>The SAT solver simplifies the problem by looking for clauses with only a single variable.
If it finds any, it knows the value of that variable and can simplify the other clauses.</li>
  <li>When no further simplification is possible, it asks its caller to pick a variable to try.
Here, we might try <code>foo2=true</code>, for example.
It then goes back to step 1 to simplify again and so on, until it has either a solution or a conflict.
If a variable assignment leads to a conflict, then we go back and try it the other way (e.g. <code>foo2=false</code>).</li>
</ol>

<p>In the above example, the process would be:</p>

<ol>
  <li>No initial simplification is possible.</li>
  <li>Try <code>foo2=true</code>.</li>
  <li>This immediately leads to <code>foo1=false</code> and <code>foo3=false</code>.</li>
  <li>Now we try <code>java8_64bit=true</code>.</li>
  <li>This immediately removes the other versions of Java from consideration.</li>
  <li>It also immediately leads to <code>x64=true</code>, which eliminates all the 32-bit binaries.</li>
  <li>It also eliminates all versions of SWT.</li>
  <li><code>foo2</code> depends on SWT, so eliminating all versions leads to <code>foo2=false</code>, which is a conflict because we already set it to <code>true</code>.</li>
</ol>

<p>MiniSat, unlike basic DPLL, doesn&rsquo;t just backtrack when it gets a conflict.
It also works backwards from the conflicting clause to find a small set of variables that are sufficient to cause the conflict.
In this case, we find that <code>foo2 and java8_64bit</code> implies conflict.
To avoid the conflict, we must make sure that at least one of these is false, and we can do this by adding a new clause:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="ow">not</span><span class="p">(</span><span class="n">foo2</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">java8_64bit</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In this example, this has the same effect as simple backtracking, but if we&rsquo;d chosen other variables between these two then learning the general rule could save us from exploring many other dead-ends.
We now try with <code>java7_64bit=true</code> and then <code>swt36_64bit=true</code>, which leads to a solution.</p>

<h3>Optimising the result</h3>

<p>The above process will always find some valid solution if one exists, but we generally want an &ldquo;optimal&rdquo; solution (e.g. preferring newer versions).
There are several ways to do this.</p>

<p>In his talk at <a href="https://ocaml.org/meetings/ocaml/2014/#Program">OCaml 2014</a>, <em>Using Preferences to Tame your Package Manager</em>, Roberto Di Cosmo explained how their tools allow you to specify a function to be optimised (e.g. <code>-count(removed),-count(changed)</code> to minimise the number of packages to be removed or changed).
When you have a global set of package versions (as in OPAM, Debian, etc) this is very useful, because the package manager needs to find solution that balances the needs of all installed programs.</p>

<p>0install has an interesting advantage here.
We can install multiple versions of libraries in parallel, and we don&rsquo;t allow one program to influence another program&rsquo;s choices.
If we run another SWT application, <code>bar</code>, we&rsquo;ll probably pick the same SWT version (<code>bar</code> will probably also prefer the latest stable 64-bit version) and so <code>foo</code> and <code>bar</code> will share the copy.
But if we run a non-SWT Java application, we are free to pick a better version of Java (e.g. Java 8) just for that program.</p>

<p>This means that we don&rsquo;t need to find a compromise solution for multiple programs.
When running <code>foo</code>, the version of <code>foo</code> itself is far more important than the versions of the libraries it uses.
We therefore define the &ldquo;optimal&rdquo; solution as the one optimising first the version of the main program, then the version of its first dependency and so on.
This means that:</p>

<ul>
  <li>The behaviour is predictable and easy to explain.</li>
  <li>The behaviour is stable (small changes to libraries deep in the tree have little effect).</li>
  <li>Programs can rank their dependencies by importance, because earlier dependencies are optimised first.</li>
  <li>If <code>foo2</code> is the best version for our policy (e.g. &ldquo;prefer latest stable version&rdquo;) then every solution with <code>foo2=true</code> is better than every solution without.
If we direct the solver to try <code>foo2=true</code> and get a solution, there&rsquo;s no point considering the <code>foo2=false</code> cases.
This means that the first solution we find will always be optimal, which is very fast!</li>
</ul>

<h2>The current solver code</h2>

<p>The existing code is made up of several components:</p>

<p><span class="caption-wrapper border center"><img src="http://roscidus.com/blog/images/solver/components.png" class="caption" width="" height="" title="Arrows indicate &quot;uses&quot; relationship."/><span class="caption-text">Arrows indicate &ldquo;uses&rdquo; relationship.</span></span></p>

<dl>
  <dt>SAT Solver</dt>
  <dd>Implements the SAT solver itself (if you want to use this code in your own projects, Simon Cruanes has
made a standalone version at <a href="https://github.com/c-cube/sat">https://github.com/c-cube/sat</a>, which has some additional features and
optimisations).</dd>
  <dt>Solver</dt>
  <dd>Fetches the candidate versions for each interface URI (equivalent to the package name in other systems) and builds up the SAT problem, then uses the SAT solver to solve it.
It directs the SAT solver in the direction of the optimal solution when there is a choice, as explained above.</dd>
  <dt>Impl provider</dt>
  <dd>Takes an interface URI and provides the candidates (&ldquo;implementations&rdquo;) to the solver.
The candidates can come from multiple XML &ldquo;feed&rdquo; files: the one at the given URI itself, plus any extra feeds that one imports, plus any additional local or remote feeds the user has added (e.g. a version in a local Git checkout or which has been built from source locally).
The impl provider also filters out obviously impossible choices (e.g. Windows binaries if we&rsquo;re on Linux, uncached versions in off-line mode, etc) and then ranks the remaining candidates according to the local policy (e.g. preferring stable versions, higher version numbers, etc).</dd>
  <dt>Feed provider</dt>
  <dd>Simply loads the feed XML from the disk cache or local file, if available.
It does not access the network.</dd>
  <dt>Driver</dt>
  <dd>Uses the solver to get an initial solution.
Then it asks the feed provider which feeds the solver tried to access and starts downloading them.
As new feeds arrive, it runs the solver again, possibly starting more downloads.
Managing these downloads is quite interesting; I used it as the example in <a href="http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/">Asynchronous Python vs OCaml</a>.</dd>
</dl>

<p>This is reasonably well split up already, thanks to occasional refactoring efforts, but we can always do better.
The subject of today&rsquo;s refactoring is the solver module itself.</p>

<p>Here&rsquo;s the problem:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>solver.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">class</span> <span class="k">type</span> <span class="n">result</span> <span class="o">=</span>
</span><span class="line">  <span class="k">object</span>
</span><span class="line">    <span class="k">method</span> <span class="n">get_selections</span> <span class="o">:</span> <span class="nn">Selections</span><span class="p">.</span><span class="n">t</span>
</span><span class="line">
</span><span class="line">    <span class="c">(* The remaining methods are used to provide diagnostics *)</span>
</span><span class="line">    <span class="k">method</span> <span class="n">get_selected</span> <span class="o">:</span> <span class="n">source</span><span class="o">:</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="nn">General</span><span class="p">.</span><span class="n">iface_uri</span> <span class="o">-&gt;</span>
</span><span class="line">    			  <span class="nn">Impl</span><span class="p">.</span><span class="n">generic_implementation</span> <span class="n">option</span>
</span><span class="line">    <span class="k">method</span> <span class="n">impl_provider</span> <span class="o">:</span> <span class="nn">Impl_provider</span><span class="p">.</span><span class="n">impl_provider</span>
</span><span class="line">    <span class="k">method</span> <span class="n">implementations</span> <span class="o">:</span>
</span><span class="line">      <span class="o">((</span><span class="nn">General</span><span class="p">.</span><span class="n">iface_uri</span> <span class="o">*</span> <span class="kt">bool</span><span class="o">)</span> <span class="o">*</span>
</span><span class="line">       <span class="o">(</span><span class="n">diagnostics</span> <span class="o">*</span> <span class="nn">Impl</span><span class="p">.</span><span class="n">generic_implementation</span><span class="o">)</span> <span class="n">option</span><span class="o">)</span> <span class="kt">list</span>
</span><span class="line">    <span class="k">method</span> <span class="n">requirements</span> <span class="o">:</span> <span class="n">requirements</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c">(** Find a set of implementations which satisfy these</span>
</span><span class="line"><span class="c">  * requirements.</span>
</span><span class="line"><span class="c">  * @param closest_match adds a lowest-ranked (but valid)</span>
</span><span class="line"><span class="c">  *        implementation to every interface, so we can always</span>
</span><span class="line"><span class="c">  *        select something. Useful for diagnostics. *)</span>
</span><span class="line"><span class="k">val</span> <span class="n">do_solve</span> <span class="o">:</span>
</span><span class="line">  <span class="nn">Impl_provider</span><span class="p">.</span><span class="n">impl_provider</span> <span class="o">-&gt;</span> <span class="n">requirements</span> <span class="o">-&gt;</span>
</span><span class="line">  <span class="n">closest_match</span><span class="o">:</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="n">result</span> <span class="n">option</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>What does <code>do_solve</code> actually do?
It gets candidates (of type <code>Impl.generic_implementation</code>) from <code>Impl_provider</code> and produces a <code>Selections.t</code>.
<code>Impl.generic_implementation</code> is a complex type including, among other things, the raw XML <code>&lt;implementation&gt;</code> element from the feed XML.
A <code>Selections.t</code> is a set of <code>&lt;selection&gt;</code> XML elements.</p>

<p>In other words: <code>do_solve</code> takes some arbitrary XML and produces some other XML.
It&rsquo;s very hard to tell from the <code>solver.mli</code> interface file what features of the input data it uses in the solve, and which it simply passes through.</p>

<p>Now imagine that instead of working on these messy concrete types, the solver instead used only a module with this type:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>sigs.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">SOLVER_INPUT</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl_provider</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span>
</span><span class="line">  <span class="k">type</span> <span class="n">dependency</span>
</span><span class="line">  <span class="k">type</span> <span class="n">restriction</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">implementations</span> <span class="o">:</span> <span class="n">impl_provider</span> <span class="o">-&gt;</span> <span class="n">iface_uri</span> <span class="o">-&gt;</span> <span class="n">impl</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">dependencies</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">dependency</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">required_interface</span> <span class="o">:</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="n">iface_uri</span>
</span><span class="line">  <span class="k">val</span> <span class="n">restrictions</span> <span class="o">:</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="n">restriction</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">meets_restriction</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">restriction</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We could then see exactly what information the solver needed to do its job.
For example, we could see just from the type signature that the solver doesn&rsquo;t understand version numbers, but just uses <code>meets_restriction</code> to check whether an abstract implementation (candidate) meets an abstract restriction.</p>

<p>Using OCaml&rsquo;s functors we can do just this, splitting out the core (non-XML) parts of the solver into a <code>Solver_core</code> module with a signature something like:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>solver_core.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">Make</span> <span class="o">:</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">Model</span> <span class="o">:</span> <span class="nn">Sigs</span><span class="p">.</span><span class="nc">SOLVER_INPUT</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">val</span> <span class="n">do_solve</span> <span class="o">:</span>
</span><span class="line">    <span class="nn">Model</span><span class="p">.</span><span class="n">impl_provider</span> <span class="o">-&gt;</span> <span class="n">requirements</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">closest_match</span><span class="o">:</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="nn">Model</span><span class="p">.</span><span class="n">impl</span> <span class="nn">StringMap</span><span class="p">.</span><span class="n">t</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This says that, given <em>any</em> concrete module that matches the <code>SOLVER_INPUT</code> type, the <code>Make</code> functor will return a module with a suitable <code>do_solve</code> function.
In particular, the compiler will check that the solver core makes no further assumptions about the types.
If it assumes that a <code>Model.impl_provider</code> is any particular concrete type then <code>solver_core.ml</code> will fail to compile, for example.</p>

<h2>Discovering the interface</h2>

<p>The above sounds nice in theory, but how easy is it to change the existing code to the new design?
I don&rsquo;t even know what <code>SOLVER_INPUT</code> will actually look like - surely more complex than the example above!
Actually, it turned out to be quite easy.
You can start with just a few concrete types, e.g.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>sigs.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">SOLVER_INPUT</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl_provider</span> <span class="o">=</span> <span class="nn">Impl_provider</span><span class="p">.</span><span class="n">impl_provider</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span> <span class="o">=</span> <span class="nn">Impl</span><span class="p">.</span><span class="n">generic_implementation</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This doesn&rsquo;t constrain <code>Solver_core</code> at all, since it&rsquo;s allowed to know the real types and use them as before.
This step just lets us make the <code>Solver_core.Make</code> functor and have things still compile and work.</p>

<p>Next, I made <code>impl_provider</code> abstract (removing the <code>= Impl_provider.impl_provider</code>), letting the compiler find all the places where the code assumed the concrete type.</p>

<p>First, it was getting the candidate implementations for an interface from it.
The <code>impl_provider</code> was actually returning several things: the valid candidates, the rejects, and an optional conflicting interface (used when one interface replaces another).
The solver doesn&rsquo;t use the rejects, which are only needed for the diagnostics system, so we can simplify that interface here.</p>

<p>Secondly, not all dependencies need to be considered (e.g. a Windows-only dependency when we&rsquo;re on Linux).
Since the <code>impl_provider</code> already knows the platform in order to filter out incompatible binaries, we also use it to filter the dependencies.
Our new module type is:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>sigs.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">SOLVER_INPUT</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl_provider</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span> <span class="o">=</span> <span class="nn">Impl</span><span class="p">.</span><span class="n">generic_implementation</span>
</span><span class="line">  <span class="k">type</span> <span class="n">dependency</span> <span class="o">=</span> <span class="nn">Impl</span><span class="p">.</span><span class="n">dependency</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="n">iface_info</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">replacement</span> <span class="o">:</span> <span class="n">iface_uri</span> <span class="n">option</span><span class="o">;</span>
</span><span class="line">    <span class="n">impls</span> <span class="o">:</span> <span class="n">impl</span> <span class="kt">list</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">implementations</span> <span class="o">:</span> <span class="n">impl_provider</span> <span class="o">-&gt;</span> <span class="n">iface_uri</span> <span class="o">-&gt;</span>
</span><span class="line">                        <span class="n">source</span><span class="o">:</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="n">iface_info</span>
</span><span class="line">  <span class="k">val</span> <span class="n">is_dep_needed</span> <span class="o">:</span> <span class="n">impl_provider</span> <span class="o">-&gt;</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>At this point, I&rsquo;m not trying to improve the interface, just to find out what it is.
Continuing to make the types abstract in this way is a fairly mechanical process, which led to:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>sigs.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">SOLVER_INPUT</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">type</span> <span class="n">t</span>  <span class="c">(* new name for impl_provider *)</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command</span>
</span><span class="line">  <span class="k">type</span> <span class="n">dependency</span>
</span><span class="line">  <span class="k">type</span> <span class="n">restriction</span>
</span><span class="line">  <span class="k">type</span> <span class="n">iface_info</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">replacement</span> <span class="o">:</span> <span class="n">iface_uri</span> <span class="n">option</span><span class="o">;</span>
</span><span class="line">    <span class="n">impls</span> <span class="o">:</span> <span class="n">impl</span> <span class="kt">list</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">val</span> <span class="n">implementations</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">iface_uri</span> <span class="o">-&gt;</span> <span class="n">source</span><span class="o">:</span><span class="kt">bool</span> <span class="o">-&gt;</span> <span class="n">iface_info</span>
</span><span class="line">  <span class="k">val</span> <span class="n">get_command</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">command</span> <span class="n">option</span>
</span><span class="line">  <span class="k">val</span> <span class="n">requires</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">dependency</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">command_requires</span> <span class="o">:</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="n">dependency</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">machine_group</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="nn">Arch</span><span class="p">.</span><span class="n">machine_group</span> <span class="n">option</span>
</span><span class="line">  <span class="k">val</span> <span class="n">restrictions</span> <span class="o">:</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="n">restriction</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">meets_restriction</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">restriction</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line">  <span class="k">val</span> <span class="n">dep_iface</span> <span class="o">:</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="n">iface_uri</span>
</span><span class="line">  <span class="k">val</span> <span class="n">dep_required_commands</span> <span class="o">:</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">dep_essential</span> <span class="o">:</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line">  <span class="k">val</span> <span class="n">restricts_only</span> <span class="o">:</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line">  <span class="k">val</span> <span class="n">is_dep_needed</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line">  <span class="k">val</span> <span class="n">impl_self_commands</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">command_self_commands</span> <span class="o">:</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">impl_to_string</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">command_to_string</span> <span class="o">:</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The main addition is the <code>command</code> type, which is essentially an optional entry point to an implementation.
For example, if a library can also be used as a program then it may provide a &ldquo;run&rdquo; command, perhaps adding a dependency on an option parser library.
Programs often also provide a &ldquo;test&rdquo; command for running the unit-tests, etc.
There are also two <code>to_string</code> functions at the end for debugging and diagnostics.</p>

<p>Having elicited this API between the solver and the rest of the system, it was clear that it had a few flaws:</p>

<ul>
  <li>
    <p><code>is_dep_needed</code> is pointless. There are only two places where we pass a dependency to the solver (<code>requires</code> and <code>command_requires</code>), so we can just filter the unnecessary dependencies out there and not bother the solver core with them at all.
The abstraction ensures there&rsquo;s no other way for the solver core to get a dependency.</p>
  </li>
  <li>
    <p><code>impl_self_commands</code> and <code>command_self_commands</code> worried me.
These are used for the (rare) case that one command in an implementation depends on another command in the same implementation.
This might happen if, for example, the &ldquo;test&rdquo; command wants to test the &ldquo;run&rdquo; command.
Logically, these are just another kind of dependency; returning them separately means code that follows dependencies might forget them.</p>

    <p>Sure enough, there was just such a bug in the code.
When we build the SAT problem we <em>do</em> consider self commands (so we always find a valid result), but when we&rsquo;re optimising the result we ignore them, possibly leading to non-optimal solutions.
I added a unit-test and made <code>requires</code> return both dependencies and self commands together to avoid the same mistake in future.</p>
  </li>
  <li>
    <p>For a similar reason, I replaced <code>dep_iface</code>, <code>dep_required_commands</code>, <code>restricts_only</code> and <code>dep_essential</code> with a single <code>dep_info</code> function returning a record type.</p>
  </li>
  <li>
    <p>I added <code>type command_name = private string</code>.
This means that the solver can&rsquo;t confuse command names with other strings and makes the type signature more obvious.
I didn&rsquo;t make it fully abstract, but was a bit lazy and used <code>private</code>, allowing the solver to cast to a string for debug logging and to let it use them as keys in a StringMap.</p>
  </li>
  <li>
    <p>There is a boolean <code>source</code> attribute in <code>do_solve</code> and <code>implementations</code>.
This is used if the user wants to select source code rather than a binary.
I wanted to support the case of a compiler that is compiled using an older version of itself (though I never completed this work).
In that case, we need to select different versions of the same interface, so the solver actually picks a unique implementation for each (interface, source) pair.</p>

    <p>I tried giving these pairs a new abstract type - &ldquo;role&rdquo; - and that simplified things nicely.
It turned out that every place where we passed only an interface (e.g. <code>dep_iface</code>), we eventually ended up doing <code>(iface, false)</code> to get back to a role, so I was able to replace these with roles too.</p>

    <p>This is quite significant.
Currently, the main interface can be source or binary but dependencies are always binary.
For example, source code may depend on a compiler, build tool, etc.
People have wondered in the past how easy it would be to support dependencies on source code too - it turns out this now requires no changes to the solver, just an extra attribute in the XML format!</p>
  </li>
  <li>
    <p>With the role type now abstract, I removed <code>Model.t</code> (the <code>impl_provider</code>) and moved it inside the role type.
This simplifies the API and allows us to use different providers for different roles (imagine solving for components to cross-compile a program; some dependencies like <code>make</code> should be for the build platform, while others are for the target).</p>
  </li>
</ul>

<p>Here&rsquo;s the new API:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>sigs.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">SOLVER_INPUT</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">Role</span> <span class="o">:</span> <span class="k">sig</span>
</span><span class="line">    <span class="k">type</span> <span class="n">t</span>
</span><span class="line">    <span class="k">val</span> <span class="n">to_string</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">    <span class="k">val</span> <span class="n">compare</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command</span>
</span><span class="line">  <span class="k">type</span> <span class="n">restriction</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command_name</span> <span class="o">=</span> <span class="k">private</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">type</span> <span class="n">dependency</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">dep_role</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
</span><span class="line">    <span class="n">dep_restrictions</span> <span class="o">:</span> <span class="n">restriction</span> <span class="kt">list</span><span class="o">;</span>
</span><span class="line">    <span class="n">dep_importance</span> <span class="o">:</span> <span class="o">[</span> <span class="o">`</span><span class="n">essential</span> <span class="o">|</span> <span class="o">`</span><span class="n">recommended</span> <span class="o">|</span> <span class="o">`</span><span class="n">restricts</span> <span class="o">];</span>
</span><span class="line">    <span class="n">dep_required_commands</span> <span class="o">:</span> <span class="n">command_name</span> <span class="kt">list</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="n">role_information</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">replacement</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="n">option</span><span class="o">;</span>
</span><span class="line">    <span class="n">impls</span> <span class="o">:</span> <span class="n">impl</span> <span class="kt">list</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="n">requirements</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">role</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
</span><span class="line">    <span class="n">command</span> <span class="o">:</span> <span class="n">command_name</span> <span class="n">option</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="k">val</span> <span class="n">implementations</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">role_information</span>
</span><span class="line">  <span class="k">val</span> <span class="n">get_command</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">command_name</span> <span class="o">-&gt;</span> <span class="n">command</span> <span class="n">option</span>
</span><span class="line">  <span class="k">val</span> <span class="n">requires</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">dependency</span> <span class="kt">list</span> <span class="o">*</span> <span class="n">command_name</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">command_requires</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="n">dependency</span> <span class="kt">list</span> <span class="o">*</span> <span class="n">command_name</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">machine_group</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="nn">Arch</span><span class="p">.</span><span class="n">machine_group</span> <span class="n">option</span>
</span><span class="line">  <span class="k">val</span> <span class="n">meets_restriction</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">restriction</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line">  <span class="k">val</span> <span class="n">impl_to_string</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">command_to_string</span> <span class="o">:</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note: <code>Role</code> is a submodule to make it easy to use it as the key in a map.</p>

<p>Hopefully you find it much easier to understand what the solver does (and doesn&rsquo;t) do from this type.
The <code>Solver_core</code> code no longer depends on the rest of 0install and can be understood on its own.</p>

<p>The remaining code in <code>Solver</code> defines the implementation of a <code>SOLVER_INPUT</code> module and applies the functor, like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">CoreModel</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span> <span class="o">=</span> <span class="nn">Impl</span><span class="p">.</span><span class="n">generic_implementation</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command</span> <span class="o">=</span> <span class="nn">Impl</span><span class="p">.</span><span class="n">command</span>
</span><span class="line">  <span class="k">type</span> <span class="n">restriction</span> <span class="o">=</span> <span class="nn">Impl</span><span class="p">.</span><span class="n">restriction</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command_name</span> <span class="o">=</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">type</span> <span class="n">dependency</span> <span class="o">=</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">*</span> <span class="nn">Impl</span><span class="p">.</span><span class="n">dependency</span>
</span><span class="line">  <span class="o">...</span>
</span><span class="line">  <span class="k">let</span> <span class="n">get_command</span> <span class="n">impl</span> <span class="n">name</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">StringMap</span><span class="p">.</span><span class="n">find</span> <span class="n">name</span> <span class="nn">Impl</span><span class="p">.</span><span class="err">(</span><span class="n">impl</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">commands</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">dep_info</span> <span class="o">(</span><span class="n">role</span><span class="o">,</span> <span class="n">dep</span><span class="o">)</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="n">dep_role</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">      <span class="n">scope</span> <span class="o">=</span> <span class="n">role</span><span class="o">.</span><span class="n">scope</span><span class="o">;</span>
</span><span class="line">      <span class="n">iface</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="nn">Impl</span><span class="p">.</span><span class="n">dep_iface</span><span class="o">;</span>
</span><span class="line">      <span class="c">(* note: only dependencies on binaries supported for now. *)</span>
</span><span class="line">      <span class="n">source</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
</span><span class="line">    <span class="o">};</span>
</span><span class="line">    <span class="n">dep_importance</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="nn">Impl</span><span class="p">.</span><span class="n">dep_importance</span><span class="o">;</span>
</span><span class="line">    <span class="n">dep_required_commands</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="nn">Impl</span><span class="p">.</span><span class="n">dep_required_commands</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="o">...</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nc">Core</span> <span class="o">=</span> <span class="nn">Solver_core</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">CoreModel</span><span class="o">)</span>
</span><span class="line"><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>CoreModel</code> implementation of <code>SOLVER_INPUT</code> simply maps the abstract types and functions to use the real types.
The limitation that dependencies are always binary is easier to see here, and it&rsquo;s fairly obvious how to fix it.</p>

<p>Note that we <em>don&rsquo;t</em> define the module as <code>module CoreModel : SOLVER_INPUT = ...</code>.
The rest of the code in <code>Solver</code> still needs to see the concrete types; only <code>Solver_core</code> is restricted to see it just as a <code>SOLVER_INPUT</code>.</p>

<h2>Comparison with Java</h2>

<p>Using functors for this seemed pretty easy, and I started wondering how I&rsquo;d solve this problem in other languages.
Python simply can&rsquo;t do this kind of thing, of course - there you have to read all the code to understand what it does.
In Java, we might declare some abstract interfaces, though:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">interface</span> <span class="nc">RoleInfo</span> <span class="o">{</span>
</span><span class="line">  <span class="n">List</span><span class="o">&lt;</span><span class="n">Impl</span><span class="o">&gt;</span> <span class="nf">get_implementations</span><span class="o">();</span>
</span><span class="line">  <span class="n">Role</span> <span class="nf">get_replacement</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="kd">interface</span> <span class="nc">Impl</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Command</span> <span class="nf">get_command</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">);</span>
</span><span class="line">  <span class="n">String</span> <span class="nf">machine_group</span><span class="o">();</span>
</span><span class="line">  <span class="n">List</span><span class="o">&lt;</span><span class="n">Dependency</span><span class="o">&gt;</span> <span class="nf">requires</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="kd">interface</span> <span class="nc">Restriction</span> <span class="o">{</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">meets_restriction</span><span class="o">(</span><span class="n">Impl</span> <span class="n">i</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="kd">interface</span> <span class="nc">Dependency</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Role</span> <span class="nf">get_role</span><span class="o">();</span>
</span><span class="line">  <span class="n">List</span><span class="o">&lt;</span><span class="n">Restriction</span><span class="o">&gt;</span> <span class="nf">get_restrictions</span><span class="o">();</span>
</span><span class="line">  <span class="n">Importance</span> <span class="nf">get_importance</span><span class="o">();</span>
</span><span class="line">  <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">get_required_commands</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="kd">interface</span> <span class="nc">Role</span> <span class="o">{</span>
</span><span class="line">  <span class="n">RoleInfo</span> <span class="nf">get_implementations</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="kd">class</span> <span class="nc">Solver</span> <span class="o">{</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">,</span><span class="n">Impl</span><span class="o">&gt;</span> <span class="n">do_solve</span><span class="o">(</span><span class="n">Role</span> <span class="n">r</span><span class="o">,</span> <span class="n">String</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="o">...</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>There&rsquo;s a problem, though.
We can create a <code>ConcreteRole</code> and pass that to <code>Solver.do_solve</code>, but we&rsquo;ll get back a map from abstract roles to abstract impls.
We need to get concrete types out to do anything useful with the result.</p>

<p>A Java programmer would probably cast the results back to the concrete types, but there&rsquo;s a problem with this (beyond the obvious fact that it&rsquo;s not statically type checked):
If we accept dynamic casting as a legitimate technique (OCaml doesn&rsquo;t support it), there&rsquo;s nothing to stop the abstract solver core from doing it too.
We&rsquo;re back to reading all the code to find out what information it really uses.</p>

<p>There are other places where dynamic casts are needed too, such as in <code>meets_restriction</code> (which needs a concrete implementation, not an abstract one).</p>

<p>I did try using generics, but I didn&rsquo;t manage to get it to compile, and I stopped when I got to:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line">  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">I</span><span class="o">,</span><span class="n">R</span><span class="o">,</span><span class="n">D</span><span class="o">&gt;</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&lt;</span><span class="n">I</span><span class="o">,</span><span class="n">R</span><span class="o">,</span><span class="n">D</span><span class="o">&gt;,</span><span class="n">Impl</span><span class="o">&lt;</span><span class="n">I</span><span class="o">,</span><span class="n">R</span><span class="o">,</span><span class="n">D</span><span class="o">&gt;&gt;</span>
</span><span class="line">         <span class="n">do_solve</span><span class="o">(</span><span class="n">Role</span><span class="o">&lt;</span><span class="n">I</span><span class="o">,</span><span class="n">R</span><span class="o">,</span><span class="n">D</span><span class="o">&gt;</span> <span class="n">role</span><span class="o">,</span> <span class="n">String</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I think it&rsquo;s fair to say that if this ever did compile, it certainly wouldn&rsquo;t have made the code easier to read.</p>

<h2>Diagnostics</h2>

<p>The <code>Diagnostics</code> module takes a failed solver result (produced with <code>do_solve ~closest_match:true</code>) that is close to what we think the user wanted but with some components left blank, and tries to explain to the user why none of the available candidates was suitable
(see the <a href="http://0install.net/injector-trouble.html">Trouble-shooting</a> guide for some examples and pictures).</p>

<p>I made a <code>SOLVER_RESULT</code> module type which extended <code>SOLVER_INPUT</code> with the final selections and diagnostic information:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>sigs.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">SOLVER_RESULT</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">include</span> <span class="nc">SOLVER_INPUT</span>
</span><span class="line">  <span class="k">type</span> <span class="n">t</span>
</span><span class="line">  <span class="k">val</span> <span class="n">requirements</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">requirements</span>
</span><span class="line">  <span class="k">val</span> <span class="n">user_restrictions</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">restriction</span> <span class="n">option</span>
</span><span class="line">  <span class="k">val</span> <span class="n">get_selected</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">impl</span> <span class="n">option</span>
</span><span class="line">  <span class="k">val</span> <span class="n">selected_commands</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">command_name</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">explain</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="n">rejection</span>
</span><span class="line">  <span class="k">val</span> <span class="n">rejects</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">impl</span> <span class="o">*</span> <span class="n">rejection</span><span class="o">)</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">describe_problem</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">rejection</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="n">version</span>
</span><span class="line">  <span class="k">val</span> <span class="n">version</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">version</span>
</span><span class="line">  <span class="k">val</span> <span class="n">format_version</span> <span class="o">:</span> <span class="n">version</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">id_of_impl</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">format_machine</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">string_of_restriction</span> <span class="o">:</span> <span class="n">restriction</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">dummy_impl</span> <span class="o">:</span> <span class="n">impl</span>	<span class="c">(** Placeholder for missing impls *)</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note: the <code>explain</code> function here is for the diagnostics-of-last-resort; the diagnostics system uses it on cases it can&rsquo;t explain itself, which generally indicates a bug somewhere.</p>

<p>Then I made a <code>Diagnostics.Make</code> functor as with <code>Solver_core</code>.
This means that the diagnostics now sees the same information as the solver, with the above additions.
For example, it sees the same dependencies as the solver did (e.g. we can&rsquo;t forget to filter them out with <code>is_dep_needed</code>).
Like the solver, the diagnostics assumed that a dependency was always a binary dependency and used <code>(iface, false)</code> to get the role.
Since the role is now abstract, it can&rsquo;t do this and should cope with source dependencies automatically.</p>

<p>The new API prompted me to consider self-command dependencies again, so the diagnostics code is now able to explain correctly problems caused by missing self-commands (previously, I forgot to handle this case).</p>

<h2>Selections</h2>

<p>Sometimes we use the results of the solver directly.
In other cases, we save them to disk as an <a href="http://0install.net/selections-spec.html">XML selections document</a> first.
These XML documents are handled by the <code>Selections</code> module, which had its own API.</p>

<p>For consistency, I decided to share type names and methods as much as possible.
I split out the core of <code>SOLVER_INPUT</code> into another module type:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">CORE_MODEL</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">Role</span> <span class="o">:</span> <span class="k">sig</span> <span class="o">...</span> <span class="k">end</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command_name</span> <span class="o">=</span> <span class="k">private</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">type</span> <span class="n">dependency</span>
</span><span class="line">  <span class="k">type</span> <span class="n">dep_info</span> <span class="o">=</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="n">requirements</span> <span class="o">=</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</span><span class="line">  <span class="k">val</span> <span class="n">requires</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">dependency</span> <span class="kt">list</span> <span class="o">*</span> <span class="n">command_name</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">command_requires</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="n">dependency</span> <span class="kt">list</span> <span class="o">*</span> <span class="n">command_name</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">dep_info</span> <span class="o">:</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="n">dep_info</span>
</span><span class="line">  <span class="k">val</span> <span class="n">get_command</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">command_name</span> <span class="o">-&gt;</span> <span class="n">command</span> <span class="n">option</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">SOLVER_INPUT</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">include</span> <span class="nc">CORE_MODEL</span>
</span><span class="line">  <span class="k">type</span> <span class="n">role_information</span> <span class="o">=</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</span><span class="line">  <span class="k">type</span> <span class="n">restriction</span>
</span><span class="line">  <span class="k">val</span> <span class="n">impl_to_string</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">command_to_string</span> <span class="o">:</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">implementations</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">role_information</span>
</span><span class="line">  <span class="k">val</span> <span class="n">restrictions</span> <span class="o">:</span> <span class="n">dependency</span> <span class="o">-&gt;</span> <span class="n">restriction</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">meets_restriction</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">restriction</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line">  <span class="k">val</span> <span class="n">machine_group</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="nn">Arch</span><span class="p">.</span><span class="n">machine_group</span> <span class="n">option</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Actually, there is some overlap with <code>SOLVER_RESULT</code> too, so I created a <code>SELECTIONS</code> type as well:</p>

<p><img src="http://roscidus.com/blog/images/solver/sigs.png" class="border center"/></p>

<p>Now the relationship becomes clear.
<code>SOLVER_INPUT</code> extends the core model with ways to get the possible candidates and restrictions on their use.
<code>SELECTIONS</code> extends the core with ways to find out which implementations were selected.
<code>SOLVER_RESULT</code> combines the above two, providing extra information for diagnostics by relating the selections back to the candidates (information that isn&rsquo;t available when loading saved selections).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">SELECTIONS</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">type</span> <span class="n">t</span>
</span><span class="line">  <span class="k">type</span> <span class="n">role</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command_name</span>
</span><span class="line">  <span class="k">type</span> <span class="n">requirements</span>
</span><span class="line">  <span class="k">val</span> <span class="n">get_selected</span> <span class="o">:</span> <span class="n">role</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">impl</span> <span class="n">option</span>
</span><span class="line">  <span class="k">val</span> <span class="n">selected_commands</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">role</span> <span class="o">-&gt;</span> <span class="n">command_name</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">val</span> <span class="n">requirements</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">requirements</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">RoleMap</span> <span class="o">:</span> <span class="nc">MAP</span> <span class="k">with</span> <span class="k">type</span> <span class="n">key</span> <span class="o">=</span> <span class="n">role</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">SOLVER_RESULT</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="k">include</span> <span class="nc">SOLVER_INPUT</span>
</span><span class="line">  <span class="k">include</span> <span class="nc">SELECTIONS</span> <span class="k">with</span>
</span><span class="line">    <span class="k">type</span> <span class="n">impl</span> <span class="o">:=</span> <span class="n">impl</span> <span class="ow">and</span>
</span><span class="line">    <span class="k">type</span> <span class="n">command_name</span> <span class="o">:=</span> <span class="n">command_name</span> <span class="ow">and</span>
</span><span class="line">    <span class="k">type</span> <span class="n">requirements</span> <span class="o">:=</span> <span class="n">requirements</span> <span class="ow">and</span>
</span><span class="line">    <span class="k">type</span> <span class="n">role</span> <span class="o">=</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span>
</span><span class="line">  <span class="k">type</span> <span class="n">rejection</span>
</span><span class="line">  <span class="k">val</span> <span class="n">rejects</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">impl</span> <span class="o">*</span> <span class="n">rejection</span><span class="o">)</span> <span class="kt">list</span>
</span><span class="line">  <span class="k">type</span> <span class="n">version</span>
</span><span class="line">  <span class="k">val</span> <span class="n">version</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">version</span>
</span><span class="line">  <span class="k">val</span> <span class="n">format_version</span> <span class="o">:</span> <span class="n">version</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">user_restrictions</span> <span class="o">:</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">restriction</span> <span class="n">option</span>
</span><span class="line">  <span class="k">val</span> <span class="n">id_of_impl</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">format_machine</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">string_of_restriction</span> <span class="o">:</span> <span class="n">restriction</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">describe_problem</span> <span class="o">:</span> <span class="n">impl</span> <span class="o">-&gt;</span> <span class="n">rejection</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">explain</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span>
</span><span class="line">  <span class="k">val</span> <span class="n">raw_selections</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">impl</span> <span class="nn">RoleMap</span><span class="p">.</span><span class="n">t</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I had a bit of trouble here.
I wanted to include <code>CORE_MODEL</code> in <code>SELECTIONS</code>, but doing that caused an error when I tried to bring them together in <code>SOLVER_RESULT</code>,
because of the duplicate <code>Role</code> submodule.
So instead I just define the types I need and let the user of the signature link them up.</p>

<p>Update: I&rsquo;ve since discovered that you can just do <code>with module Role := Role</code> to solve this.</p>

<p>Correct use of the <code>with</code> keyword seems the key to a happy life with OCaml functors.
When defining the <code>RoleMap</code> submodule in <code>SELECTIONS</code> I use it to let users know the keys of a <code>RoleMap</code> are the same type as <code>SELECTIONS.role</code> (otherwise it will be abstract and you can&rsquo;t assume anything about it).
In <code>SOLVER_RESULT</code>, I use it to link the types in <code>SELECTIONS</code> with the types in <code>SOLVER_INPUT</code>.</p>

<p>Notice the use of <code>=</code> vs <code>:=</code>.
<code>=</code> says that two types are the same.
<code>:=</code> additionally removes the type from the module signature.
We use <code>:=</code> for <code>impl</code> because we already have a type with that name from <code>SOLVER_INPUT</code> and we can&rsquo;t have two.
However, we use <code>=</code> for <code>role</code> because that doesn&rsquo;t exist in <code>CORE_MODEL</code> and we&rsquo;d like <code>SOLVER_RESULT</code> to include everything in <code>SELECTIONS</code>.</p>

<p>Finally, I included the new <code>SELECTIONS</code> signature in the interface file for the <code>Selections</code> module:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>selections.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">type</span> <span class="n">selection</span> <span class="o">=</span> <span class="o">[`</span><span class="n">selection</span><span class="o">]</span> <span class="nn">Element</span><span class="p">.</span><span class="n">t</span>
</span><span class="line"><span class="k">type</span> <span class="n">role</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">iface</span> <span class="o">:</span> <span class="nn">General</span><span class="p">.</span><span class="n">iface_uri</span><span class="o">;</span>
</span><span class="line">  <span class="n">source</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line"><span class="k">include</span> <span class="nn">Sigs</span><span class="p">.</span><span class="nc">CORE_MODEL</span> <span class="k">with</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span> <span class="o">=</span> <span class="n">selection</span> <span class="ow">and</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command_name</span> <span class="o">=</span> <span class="kt">string</span> <span class="ow">and</span>
</span><span class="line">  <span class="k">type</span> <span class="nn">Role</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">role</span>
</span><span class="line"><span class="k">include</span> <span class="nn">Sigs</span><span class="p">.</span><span class="nc">SELECTIONS</span> <span class="k">with</span>
</span><span class="line">  <span class="k">type</span> <span class="n">role</span> <span class="o">:=</span> <span class="n">role</span> <span class="ow">and</span>
</span><span class="line">  <span class="k">type</span> <span class="n">command_name</span> <span class="o">:=</span> <span class="n">command_name</span> <span class="ow">and</span>
</span><span class="line">  <span class="k">type</span> <span class="n">requirements</span> <span class="o">:=</span> <span class="n">requirements</span> <span class="ow">and</span>
</span><span class="line">  <span class="k">type</span> <span class="n">impl</span> <span class="o">:=</span> <span class="n">selection</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this change, anything that uses <code>SELECTIONS</code> can work with both loaded selections and with the solver output, even though they have different implementations.
For example, the <code>Tree</code> module generates a tree (for display) from a selections dependency graph (pruning loops and diamonds).
It&rsquo;s now a functor, which can be used with either.
For example, <code>0install show selections.xml</code> applies it to the <code>Selections</code> module:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">SelectionsTree</span> <span class="o">=</span> <span class="nn">Tree</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">Selections</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="o">...</span> <span class="nn">SelectionsTree</span><span class="p">.</span><span class="n">as_tree</span> <span class="n">sels</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The same code is used in the GUI to render the tree view, but now with <code>Make(Solver.Model)</code>.
As before, it&rsquo;s important to preserve the types - the GUI needs to know that each node in the tree is a <code>Solver.Model.Role.t</code> so that it can show information about the available candidates, for example.</p>

<h2>Summary</h2>

<p>An important function of a package manager is finding a set of package versions that are compatible.
An efficient way to do this is to express the necessary and sufficient constraints as a set of boolean equations and then use a SAT solver to find a solution.
While finding a valid solution is easy, finding the optimal one can be harder.
Because 0install is able to install libraries in parallel and can choose to use different versions for different applications, it only needs to consider one application at a time.
As well as being faster, this makes it possible to use a simple definition of optimality that is easy to compute.</p>

<p>0install&rsquo;s existing solver code has already been broken down into modular components: downloading metadata, collecting candidates, rejecting invalid candidates and ranking the rest, building the SAT problem and solving it.
However, the code that builds the SAT problem and optimises the solution was tightly coupled to the concrete representation, making it harder to see what it was doing and harder to extend it with new features.
Its type signature essentially just said that it takes XML as input and returns XML as output.</p>

<p>OCaml functors are functions over modules.
They allow a module to declare the interface it expects from its dependencies in an abstract way, providing just the information the module requires and nothing else.
The module can then be compiled against this abstract interface, ensuring that it makes no assumptions about the actual types.
Later, the functor can be applied to the concrete representation to get a module that uses the concrete types.</p>

<p>Turning the existing solver code into a functor turned out to be a simple iterative process that discovered the existing implicit API between the solver and the rest of the code.
Once this abstract API had been found, many possible improvements became obvious.
The new solver core is both simpler than the original and can be understood on its own without looking at the rest of the code.
It is also more flexible: we could now add support for source dependencies, cross-compilation, etc, without changing the core of the solver.
The challenge now is only how to express these things in the XML format.</p>

<p>In a language without functors, such as Java, we could still define the solver to work over abstract interfaces, but the results returned would also be abstract, which is not useful.
Trying to achieve the same effect as functors using generics appears very difficult and the resulting code would likely be hard to read.</p>

<p>Splitting up the abstract interface into multiple module types allowed parts of the interface to be shared with the separate selections-handling module.
This in turn allowed another module - for turning selections into trees - to become a functor that could also work directly on the solver results.
Finally, it made the relationship between the solver results and the selections type clear - solver results are selections plus diagnostics information.</p>

<p>The code discussed in this post can be found at <a href="https://github.com/0install/0install">https://github.com/0install/0install</a>.</p>

<a onclick="switchContent('ocamlorg-post18','ocamlorg-post17')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/09/17/simplifying-the-solver-with-functors/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2014/09/17/simplifying-the-solver-with-functors/">by Thomas Leonard at Sep 17, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2014/08/15/optimising-the-unikernel/">
    <a name="#http://roscidus.com/blog/blog/2014/08/15/optimising-the-unikernel/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2014/08/15/optimising-the-unikernel/">Optimising the unikernel</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post19"><p>After <a href="http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">creating my REST queuing service as a Mirage unikernel</a>, I reported that it could serve the data at 2.46 MB/s from my ARM CubieTruck dev board.
That&rsquo;s fast enough for my use (it&rsquo;s faster than my Internet connection), but I was curious why it was slower than the Linux guest, which serves files with <code>nc</code> at 20 MB/s.</p>



<p>( this post also appeared on <a href="https://news.ycombinator.com/item?id=8206882">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/2e7jbx/optimising_the_unikernel_thomas_leonards_blog/">Reddit</a> )</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#the-tcp-test-case">The TCP test-case</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#compiler-optimisations">Compiler optimisations</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-support">Profiling support</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-the-console">Profiling the console</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-udp">Profiling UDP</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-tcp">Profiling TCP</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-disk-access">Profiling disk access</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#update-linux-is-slow-too">Update: Linux is slow too!</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-the-queuing-service">Profiling the queuing service</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#conclusions">Conclusions</a></li>
</ul>

<h2>The TCP test-case</h2>

<p>To avoid confusing things by testing the disk and the network at the same time, I made a simpler test case that waits for a TCP connection
and transmits a pre-allocated buffer multiple times:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>unikernel.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">Main</span> <span class="o">(</span><span class="nc">C</span><span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">CONSOLE</span><span class="o">)</span> <span class="o">(</span><span class="nc">S</span><span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">STACKV4</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">let</span> <span class="n">buffe&hellip;</span></span></code></pre></td></tr></table></div></figure></notextile></div><a onclick="switchContent('ocamlorg-post19','ocamlorg-post20')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/08/15/optimising-the-unikernel/">Read more...</a></div><div id="ocamlorg-post20" style="display: none"><p>After <a href="http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">creating my REST queuing service as a Mirage unikernel</a>, I reported that it could serve the data at 2.46 MB/s from my ARM CubieTruck dev board.
That&rsquo;s fast enough for my use (it&rsquo;s faster than my Internet connection), but I was curious why it was slower than the Linux guest, which serves files with <code>nc</code> at 20 MB/s.</p>



<p>( this post also appeared on <a href="https://news.ycombinator.com/item?id=8206882">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/2e7jbx/optimising_the_unikernel_thomas_leonards_blog/">Reddit</a> )</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#the-tcp-test-case">The TCP test-case</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#compiler-optimisations">Compiler optimisations</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-support">Profiling support</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-the-console">Profiling the console</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-udp">Profiling UDP</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-tcp">Profiling TCP</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-disk-access">Profiling disk access</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#update-linux-is-slow-too">Update: Linux is slow too!</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#profiling-the-queuing-service">Profiling the queuing service</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#conclusions">Conclusions</a></li>
</ul>

<h2>The TCP test-case</h2>

<p>To avoid confusing things by testing the disk and the network at the same time, I made a simpler test case that waits for a TCP connection
and transmits a pre-allocated buffer multiple times:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>unikernel.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">Main</span> <span class="o">(</span><span class="nc">C</span><span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">CONSOLE</span><span class="o">)</span> <span class="o">(</span><span class="nc">S</span><span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">STACKV4</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Io_page</span><span class="p">.</span><span class="n">pages</span> <span class="mi">16</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Io_page</span><span class="p">.</span><span class="n">to_cstruct</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">start</span> <span class="n">c</span> <span class="n">s</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">S</span><span class="p">.</span><span class="n">listen_tcpv4</span> <span class="n">s</span> <span class="o">~</span><span class="n">port</span><span class="o">:</span><span class="mi">80</span> <span class="o">(</span><span class="k">fun</span> <span class="n">flow</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">let</span> <span class="n">warmups</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">in</span>
</span><span class="line">      <span class="k">let</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">100</span> <span class="k">in</span>
</span><span class="line">      <span class="k">let</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">lenv</span> <span class="n">buffer</span> <span class="o">*</span> <span class="n">iterations</span> <span class="k">in</span>
</span><span class="line">      <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">        <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="bp">()</span>
</span><span class="line">        <span class="o">|</span> <span class="n">i</span> <span class="o">-&gt;</span>
</span><span class="line">            <span class="n">lwt</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">S</span><span class="p">.</span><span class="nn">TCPV4</span><span class="p">.</span><span class="n">writev</span> <span class="n">flow</span> <span class="n">buffer</span> <span class="k">in</span>
</span><span class="line">            <span class="n">loop</span> <span class="o">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">      <span class="n">loop</span> <span class="n">warmups</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">lwt</span> <span class="n">time</span> <span class="o">=</span> <span class="nn">Profile</span><span class="p">.</span><span class="n">time</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">iterations</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">      <span class="nn">S</span><span class="p">.</span><span class="nn">TCPV4</span><span class="p">.</span><span class="n">close</span> <span class="n">flow</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="nn">C</span><span class="p">.</span><span class="n">log_s</span> <span class="n">c</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Wrote %d bytes in %.3f seconds (%.2f KB/s)&quot;</span>
</span><span class="line">        <span class="n">bytes</span> <span class="n">time</span>
</span><span class="line">        <span class="o">(</span><span class="n">float_of_int</span> <span class="n">bytes</span> <span class="o">/.</span> <span class="n">time</span> <span class="o">/.</span> <span class="mi">1024</span><span class="o">.))</span>
</span><span class="line">    <span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="nn">S</span><span class="p">.</span><span class="n">listen</span> <span class="n">s</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>Profile.time</code> just runs the function and returns how long it took in seconds.
I do a few warm-up iterations at the start because TCP starts slowly and we don&rsquo;t want to benchmark that.</p>

<h2>Compiler optimisations</h2>

<p>While looking at the assembler output during some earlier debugging, I&rsquo;d noticed that gcc was generating very poor code. For example:</p>

<pre><code>0041a550 &lt;_xmalloc&gt;:
  41a550:	e92d4800 	push	{fp, lr}
  41a554:	e28db004 	add	fp, sp, #4
  41a558:	e24dd028 	sub	sp, sp, #40	; 0x28
  41a55c:	e50b0028 	str	r0, [fp, #-40]	; 0x28
  41a560:	e50b102c 	str	r1, [fp, #-44]	; 0x2c
  41a564:	e3a03000 	mov	r3, #0
  41a568:	e50b300c 	str	r3, [fp, #-12]
  41a56c:	e3a03010 	mov	r3, #16
  41a570:	e50b3014 	str	r3, [fp, #-20]
  41a574:	e51b002c 	ldr	r0, [fp, #-44]	; 0x2c
  41a578:	e3a01004 	mov	r1, #4
  41a57c:	ebffff5d 	bl	41a2f8 &lt;align_up&gt;
  41a580:	e50b002c 	str	r0, [fp, #-44]	; 0x2c
  41a584:	e51b002c 	ldr	r0, [fp, #-44]	; 0x2c
  ...
</code></pre>

<p>gcc is using registers very inefficiently here.
For example, it stores <code>r1</code> to <code>[fp, #-44]</code> and then a few lines later loads from there into <code>r0</code>, when it could just have moved it directly.
The last two lines show it saving <code>r0</code> to the stack and then immediately loading it back again into the same register!</p>

<p>The fix here turned out to be simple.
Mini-OS by default compiles in debug mode with no optimisations.
Compiling with <code>debug=n</code> fixes this, and I <a href="https://github.com/mirage/mirage-xen-minios/pull/4">updated mirage-xen-minios</a> to do this.</p>

<table class="table">
  <thead>
    <tr>
      <th>Optimisations</th>
      <th>TCP download speed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>none</td>
      <td>6.92 MB/s</td>
    </tr>
    <tr>
      <td>-O3</td>
      <td>11.93 MB/s</td>
    </tr>
  </tbody>
</table>

<p>Even though Mirage is almost all OCaml, it does use Mini-OS&rsquo;s C functions for various low-level operations and these optimisations make a big difference!</p>

<h2>Profiling support</h2>

<p>The OCaml compiler provides a profiling option, which works the same way as gcc&rsquo;s <code>-pg</code> option for C code.
To enable it, you add <code>true: profile</code> to your <code>_tags</code> file and rebuild.</p>

<p>I decided to see what would happen if I enabled this for my Xen unikernel:</p>

<pre><code>_build/main.native.o: In function `caml_program':
:(.text+0x2): undefined reference to `__gnu_mcount_nc'
</code></pre>

<p>Profiling works by inserting a call to <code>__gnu_mcount_nc</code> at the start of every function.
It looks like this:</p>

<pre><code>00000000 &lt;caml_program&gt;:
   0:       b500            push    {lr}
   2:       f7ff fffe       bl      0 &lt;__gnu_mcount_nc&gt;
   ...
</code></pre>

<p>The <code>__gnu_mcount_nc</code> function gets the address of the callee function (<code>caml_program</code> in this example) in the link register (<code>lr</code>/<code>r14</code>) and the address of its caller on the stack (pushed by the code fragment above).
Normally, the profiler would use this information to build up a static call graph (saying which functions call which other functions).
Using a regular timer interrupt to sample the program counter it can estimate how much time was spent in each function,
and using the call graph it can show cumulative totals (time spent in each function plus time spent in its children).</p>

<p>I decided to start with something a bit simpler.
I wrote <a href="https://github.com/talex5/xen/blob/8f786348db50611e1251dc3ed505bdf5bb388fe9/extras/mini-os/arch/arm/arm32.S#L330">some ARM code</a> for <code>__gnu_mcount_nc</code> that simply writes the caller, callee and current time to a trace buffer (when the buffer is full, it stops tracing).
Ideally, I&rsquo;d like to get notified each time we leave a function too.
gcc can do that for C code with its <code>-finstrument-functions</code> option, but I didn&rsquo;t see an option for that in OCaml.
Instead, I assume that every function runs until I see a call whose caller is not its parent.
This works surprisingly well, though it does mean that if a function seems to take a long time you need to check its parents too,
and it might get confused for recursive calls.
Also, for tail calls, we see the parent as the function we will return to rather than the function that actually called us.</p>

<p>At the end, I dump out the trace buffer to the console with some OCaml code.
Back on my laptop, I wrote some code to parse this output and look up each address in the ELF image to get the function name for each address.
(This code isn&rsquo;t public yet as it needs a lot of cleaning up.)</p>

<p>One thing I quickly discovered: compiling just the unikernel with profiling isn&rsquo;t sufficient.
As soon as you call a non-profiled function it can no longer construct the call graph and the results are useless.
I manually recompiled every C and OCaml library I was using with profiling, which was quite tedious.</p>

<p>Update: Thomas Gazagnaire has added an <a href="https://github.com/ocaml/opam-repository/pull/2479">OPAM profiling switch</a> which should make this much easier in future.</p>

<p>Initially, the trace buffer filled up almost instantly with calls to <code>stub_evtchn_test_and_clear</code>.
It seems that we call this once for each of the 4096 channels every time we look for work.
To avoid clutter, I reduced the number of event channels to 10 (this had no noticeable effect on performance).
I also tried removing the <code>memset</code> which zeroes out newly allocated IO pages.
This also made no difference.</p>

<p>I measured the overhead added by the tracing, both when compiled in but inactive and when actively writing to the trace buffer:</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/tracing-overhead.png" class="border center"/></p>

<p>So, not too bad.</p>

<h2>Profiling the console</h2>

<p>The TCP code&rsquo;s trace was quite complicated, so I decided to start by profiling the much simpler console device,
which I&rsquo;d noticed was surprisingly slow at dumping the trace results.</p>

<p>A Xen virtual console is a pair of ring buffers (one for input from the keyboard, one for output to the screen) in a shared memory page, defined like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>console.h </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="k">struct</span> <span class="n">xencons_interface</span> <span class="p">{</span>
</span><span class="line">    <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span><span class="line">    <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
</span><span class="line">    <span class="n">XENCONS_RING_IDX</span> <span class="n">in_cons</span><span class="p">,</span> <span class="n">in_prod</span><span class="p">;</span>
</span><span class="line">    <span class="n">XENCONS_RING_IDX</span> <span class="n">out_cons</span><span class="p">,</span> <span class="n">out_prod</span><span class="p">;</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We&rsquo;re only interested in the &ldquo;out&rdquo; side here.
The producer (i.e. our unikernel) writes the data to the buffer and advances the <code>out_prod</code> counter.
The consumer (<code>xenconsoled</code>, running in Dom0) reads the data and advances <code>out_cons</code>.
If the consumer catches up with the producer it sleeps until the producer notifies it there is more data.
If the producer catches up with the consumer (the buffer is full) it sleeps until the consumer notifies it there is space available again.</p>

<p>Here&rsquo;s my console test-case - writing a string to the console in a loop:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">Main</span> <span class="o">(</span><span class="nc">C</span><span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">CONSOLE</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">let</span> <span class="n">start</span> <span class="n">c</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">6</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">msg</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="o">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="sc">'X'</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">iterations</span> <span class="o">=</span> <span class="mi">10000</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="n">iterations</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">      <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="bp">()</span>
</span><span class="line">      <span class="o">|</span> <span class="n">i</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="nn">C</span><span class="p">.</span><span class="n">log_s</span> <span class="n">c</span> <span class="n">msg</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="o">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">    <span class="n">loop</span> <span class="mi">1000</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>  <span class="c">(* Warm up *)</span>
</span><span class="line">    <span class="k">let</span> <span class="n">t0</span> <span class="o">=</span> <span class="nn">Clock</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">    <span class="n">lwt</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">loop</span> <span class="n">iterations</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="nn">Clock</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="o">-.</span> <span class="n">t0</span> <span class="k">in</span>
</span><span class="line">    <span class="nn">C</span><span class="p">.</span><span class="n">log_s</span> <span class="n">c</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Wrote %d bytes in %.3f seconds (%.2f KB/s)&quot;</span>
</span><span class="line">      <span class="n">bytes</span> <span class="n">time</span>
</span><span class="line">      <span class="o">(</span><span class="n">float_of_int</span> <span class="n">bytes</span> <span class="o">/.</span> <span class="n">time</span> <span class="o">/.</span> <span class="mi">1024</span><span class="o">.))</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">OS</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">2</span><span class="o">.</span><span class="mi">0</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I got around 45 KB/s. The trace output looked like this:</p>

<table class="table">
  <thead>
    <tr>
      <th style="text-align: right">Start</th>
      <th>Function</th>
      <th style="text-align: right">Duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">118684</td>
      <td>- - <code>camlUnikernel__loop_1270</code></td>
      <td style="text-align: right">219</td>
    </tr>
    <tr>
      <td style="text-align: right">118730</td>
      <td>- - &gt; <code>camlConsole__write_all_low_1123</code></td>
      <td style="text-align: right">158</td>
    </tr>
    <tr>
      <td style="text-align: right">118737</td>
      <td>- - &gt; - <code>camlRing__repeat_1279</code></td>
      <td style="text-align: right">89</td>
    </tr>
    <tr>
      <td style="text-align: right">118739</td>
      <td>- - &gt; - - <code>camlRing__write_1270</code></td>
      <td style="text-align: right">87</td>
    </tr>
    <tr>
      <td style="text-align: right">118830</td>
      <td>- - &gt; - <code>camlEventchn__fun_1138</code></td>
      <td style="text-align: right">58</td>
    </tr>
    <tr>
      <td style="text-align: right">118831</td>
      <td>- - &gt; - - <code>stub_evtchn_notify</code></td>
      <td style="text-align: right">57</td>
    </tr>
    <tr>
      <td style="text-align: right">118907</td>
      <td>- - <code>camlUnikernel__loop_1270</code></td>
      <td style="text-align: right">211</td>
    </tr>
    <tr>
      <td style="text-align: right">118944</td>
      <td>- - &gt; <code>camlConsole__write_all_low_1123</code></td>
      <td style="text-align: right">168</td>
    </tr>
    <tr>
      <td style="text-align: right">118951</td>
      <td>- - &gt; - <code>camlRing__repeat_1279</code></td>
      <td style="text-align: right">100</td>
    </tr>
    <tr>
      <td style="text-align: right">118953</td>
      <td>- - &gt; - - <code>camlRing__write_1270</code></td>
      <td style="text-align: right">98</td>
    </tr>
    <tr>
      <td style="text-align: right">119054</td>
      <td>- - &gt; - <code>camlEventchn__fun_1138</code></td>
      <td style="text-align: right">58</td>
    </tr>
    <tr>
      <td style="text-align: right">119055</td>
      <td>- - &gt; - - <code>stub_evtchn_notify</code></td>
      <td style="text-align: right">57</td>
    </tr>
  </tbody>
</table>

<p>The start time and duration are measured in counter clock ticks, and the counter is running at 24 MHz.
The <code>--&gt;--&gt;--&gt;</code> indicates the level of nesting (I vary the character to make it easier to scan vertically with the eye).
The output shows two iterations of the loop taken from the middle of the sample.
To make the output more readable, my analysis script prunes the tree at calls that took less than 50 ticks, and removes calls to the Lwt library (while still showing the functions they called as a result).
The durations include the times for their children (including pruned children).</p>

<p>You can see that on each iteration we call <code>Console.write_all_low</code>, which writes the string to the shared memory ring and notifies the console daemon in Dom0.
Each iteration is taking roughly 200 ticks, which is about 8 us per iteration.
So we&rsquo;d expect the speed to be around 6 bytes / 8 us, which is about 700 KB/s.</p>

<p>Looking at the cumulative time spent in each function, the top entries are:</p>

<table class="table">
  <thead>
    <tr>
      <th>Function</th>
      <th>Ticks (at 24 MHz)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>caml_c_call</code></td>
      <td>9002738</td>
    </tr>
    <tr>
      <td><code>caml_block_domain</code></td>
      <td>9001576</td>
    </tr>
    <tr>
      <td><code>block_domain</code></td>
      <td>9001462</td>
    </tr>
    <tr>
      <td><code>camlUnikernel__loop_1270</code></td>
      <td>374418</td>
    </tr>
    <tr>
      <td><code>camlConsole__write_all_low_1123</code></td>
      <td>298735</td>
    </tr>
  </tbody>
</table>

<p>Note: the trace only includes calls until the trace buffer was full, so these aren&rsquo;t the total times for the whole run.
But we can immediately see that we spent most of the time in <code>block_domain</code>, which is what Mirage calls when it has nothing to do and is waiting for an external event.
Here&rsquo;s a graph showing how many iterations of the test loop we had started over time:</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/xen-console-messages.png" class="border center"/></p>

<p>So, we wrote 679 messages very quickly, then waited a long time, then wrote 1027 more, then waited again, etc.
I thought there might be a bug in <code>block_domain</code> causing it to miss a wake-up event, so I limited the time it would spend blocking.
It didn&rsquo;t make any difference; it would keep waking up, seeing that it had nothing to do, and going back to sleep again.</p>

<p>In case the problem was with Mirage&rsquo;s implementation of the shared rings or console device,
I tried writing the same test directly in C in Mini-OS&rsquo;s <code>test.c</code> and got the same result (I had to modify it slightly because by default Mini-OS&rsquo;s <code>console_print</code> discards data when the buffer is full instead of waiting).
Finally, I tried it from a Linux guest and got 25 KB/s (interestingly, Linux uses 100% CPU while doing this).
The times were highly variable (each point on this plot is from writing the message 10,000 times and calculating the average):</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/xen-console-speed.png" class="border center"/></p>

<p>After some investigation, it turned out that Xen was deliberately limiting the rate:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>xen/tools/console/daemon/io.c </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="c"><span class="line"><span class="cm">/* How many events are allowed in each time period */</span>
</span><span class="line"><span class="cp">#define RATE_LIMIT_ALLOWANCE 30</span>
</span><span class="line"><span class="cm">/* Duration of each time period in ms */</span>
</span><span class="line"><span class="cp">#define RATE_LIMIT_PERIOD 200</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Mystery solved, although I don&rsquo;t know why the rates are so variable.
Mirage wasn&rsquo;t doing anything except running the test case and Linux was booted with <code>init=/bin/bash</code>, so there was nothing else running there either.</p>

<p>Lessons:</p>

<ul>
  <li>Just scrolling through the raw trace can be misleading. It appears that it keeps calling the loop function, but in fact almost all the time was spent in the two very rare <code>block_domain</code> calls. Graphing iterations over time can show these problems effectively.</li>
  <li>Compare with the speed on Linux. Sometimes, Xen really is that slow and it&rsquo;s not our fault.</li>
  <li>Compile everything for profiling or the results aren&rsquo;t much use.</li>
</ul>

<h2>Profiling UDP</h2>

<p>TCP involves ack packets, expanding windows and other complications, so I next looked at the simpler <a href="http://en.wikipedia.org/wiki/User_Datagram_Protocol">UDP</a> protocol.
Here, we can throw packets out continuously without worrying about the other end.</p>

<p>With a payload size of 1476 bytes (the maximum possible for UDP), I got 17 MB/s.
All packets were successfully received on my laptop.
My Linux guest got 13.4 MB/s with <code>nc -u &lt; /dev/zero</code>, so we&rsquo;re actually faster!</p>

<p>Here&rsquo;s a sample iteration from the trace:</p>

<table class="table">
  <thead>
    <tr>
      <th style="text-align: right">Start</th>
      <th>Function</th>
      <th style="text-align: right">Duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">243418</td>
      <td>- - &gt; - <code>camlUnikernel__loop_1287</code></td>
      <td style="text-align: right">938</td>
    </tr>
    <tr>
      <td style="text-align: right">243436</td>
      <td>- - &gt; - - <code>camlUdpv4__fun_1430</code></td>
      <td style="text-align: right">266</td>
    </tr>
    <tr>
      <td style="text-align: right">243439</td>
      <td>- - &gt; - - &gt; <code>camlIpv4__allocate_frame_1369</code></td>
      <td style="text-align: right">190</td>
    </tr>
    <tr>
      <td style="text-align: right">243440</td>
      <td>- - &gt; - - &gt; - <code>camlIo_page__get_1122</code></td>
      <td style="text-align: right">72</td>
    </tr>
    <tr>
      <td style="text-align: right">243632</td>
      <td>- - &gt; - - &gt; <code>camlIpv4__fun_1509</code></td>
      <td style="text-align: right">69</td>
    </tr>
    <tr>
      <td style="text-align: right">243818</td>
      <td>- - &gt; - - <code>camlNetif__fun_2893</code></td>
      <td style="text-align: right">185</td>
    </tr>
    <tr>
      <td style="text-align: right">243852</td>
      <td>- - &gt; - - &gt; <code>camlNetif__fun_2618</code></td>
      <td style="text-align: right">103</td>
    </tr>
    <tr>
      <td style="text-align: right">243895</td>
      <td>- - &gt; - - &gt; - <code>camlLwt_ring__fun_1223</code></td>
      <td style="text-align: right">58</td>
    </tr>
    <tr>
      <td style="text-align: right">244007</td>
      <td>- - &gt; - - <code>camlNetif__fun_2931</code></td>
      <td style="text-align: right">132</td>
    </tr>
    <tr>
      <td style="text-align: right">244009</td>
      <td>- - &gt; - - &gt; <code>camlNetif__xmit_1509</code></td>
      <td style="text-align: right">123</td>
    </tr>
    <tr>
      <td style="text-align: right">244028</td>
      <td>- - &gt; - - &gt; - <code>camlNetif__fun_2618</code></td>
      <td style="text-align: right">76</td>
    </tr>
    <tr>
      <td style="text-align: right">244141</td>
      <td>- - &gt; - - <code>camlNetif__fun_2958</code></td>
      <td style="text-align: right">177</td>
    </tr>
    <tr>
      <td style="text-align: right">244144</td>
      <td>- - &gt; - - &gt; <code>camlRing__push_requests_and_check_notify_1112</code></td>
      <td style="text-align: right">174</td>
    </tr>
    <tr>
      <td style="text-align: right">244150</td>
      <td>- - &gt; - - &gt; - <code>camlRing__sring_push_requests_1070</code></td>
      <td style="text-align: right">158</td>
    </tr>
    <tr>
      <td style="text-align: right">244151</td>
      <td>- - &gt; - - &gt; - - <code>caml_memory_barrier</code></td>
      <td style="text-align: right">77</td>
    </tr>
    <tr>
      <td style="text-align: right">244231</td>
      <td>- - &gt; - - &gt; - - <code>caml_memory_barrier</code></td>
      <td style="text-align: right">77</td>
    </tr>
  </tbody>
</table>

<p>Here&rsquo;s a graph of loop iterations (packets sent) over time (each blue dot is one packet sent):</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/udp-packets.png" class="border center"/></p>

<p>The gaps indicate places where we were not sending packets.
The garbage collector shows up twice in the trace (both times in <code>Ring.ack_responses</code> oddly).
However, we spend more time in <code>block_domain</code> than doing GC, indicating that we&rsquo;re often waiting for Xen.
Looking at the trace just before it blocks, I see calls to <code>Netif.wait_for_free_tx</code>, which seems reasonable.</p>

<h2>Profiling TCP</h2>

<p>The TCP header is larger than the UDP one, making it less efficient even in the best case,
and TCP needs to process acks, keep track of window sizes, and handle retransmissions.
Strange, then, that the Linux guest manages 39 MB/s over TCP compared with just 13.4 MB/s for UDP!
(even stranger is that I got 47.2 MB/s for Linux when I tried it for last
month&rsquo;s post; however I am using a different version of Linux in dom0 now)</p>

<p>I capture some packets sent by the Linux guest using <code>tshark</code> running in Dom0.
Loading it into Wireshark on my laptop, I see that all the TCP checksums are wrong, so it
looks like Linux is using TCP checksum offloading.</p>

<p>According to <a href="http://lists.xen.org/archives/html/xen-devel/2013-12/msg00884.html">Question about TCP checksum offload in Xen</a>:</p>

<blockquote>
  <p>A domain has no way of knowing how any given packet is going to leave the host (or even if it is) so it can&rsquo;t know ahead of time whether to calculate any checksums: the skb&rsquo;s [socket buffers] are just marked with &ldquo;checksum needed&rdquo; as usual and either the egress NIC will do the job or dom0 will do it.</p>
</blockquote>

<p>Getting this working on Mirage was a bit tricky.
The TCP layer can avoid adding the checksum only if the network device says it&rsquo;s capable of doing it itself, and packets have to be flagged as needing the checksum.
You can&rsquo;t just flag all packets because the Linux dom0 silently drops non-TCP/UDP packets with it set (e.g. ARP packets).
I hacked something together and got a modest speed improvement.</p>

<p>Here&rsquo;s a graph for the TCP test, where each iteration of the loop is sending one TCP packet (segment):</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/tcp-packets.png" class="border center"/></p>

<p>Note: we send many warm up packets before starting the trace as TCP starts slowly (which looks pretty but isn&rsquo;t relevant here).</p>

<p>Zooming in, the picture is quite interesting (where it had gaps, I searched for a typical function that occurred in the gap and added a symbol for it):</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/tcp-packets-zoom.png" class="border center"/></p>

<p>It looks like we start by transmitting packets steadily, until the current window is full.
Then we start buffering the packets instead of sending them, which is very fast.
At some point the TCP system stops accepting more data, which causes the main loop to block, allowing us to process other events.
<code>rx_poll response</code> indicates one iteration of the <code>Netif.rx_poll</code> loop, which seems to be dealing with acks from Xen saying that our packets have been transmitted (and the memory can therefore be recycled).
After a while, the TCP ack packets arrive and we process them, which opens up the transmit window again.
Then we send out the buffered packets, before returning to the main loop.</p>

<p>So, in each cycle we spend about 60% of the time transmitting packets, a quarter dealing with acks from Xen and the rest handling TCP acks from the remote host.
It might be possible to optimise things a bit here by reusing grant references, but I didn&rsquo;t investigate further.</p>

<h2>Profiling disk access</h2>

<p>My next test case reads a series of sectors sequentially from the disk and then writes them. Reading or writing one sector (4096 bytes) at a time was very slow (2.7 MB/s read, 0.7 MB/s write).
Using larger buffers, so that we transfer more in each operation, helped but even at 64 sectors per op I only got 12.3 MB/s read / 5.12 MB/s write (the device is capable of 20 MB/s read and 10 MB/s write).
Here&rsquo;s a trace where we read using 32-sector buffers (10.9 MB/s):</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/block-reads-1-32.png" class="border center"/></p>

<p>We spend a lot of time waiting for each block to arrive, although there are some curious ack messages, which we deal with quickly.
What if we have two requests in flight at once?
This gets us 18.27 MB/s:</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/block-reads-2-32.png" class="border center"/></p>

<p>Strangely, the two blocks arrive close together.
Although it takes us longer to get the first one (I don&rsquo;t know why), we get them more quickly after that.
Having three requests in flight doesn&rsquo;t help though (18.25 MB/s):</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/block-reads-3-32.png" class="border center"/></p>

<p>Looking at the block driver code, it batches requests into groups of 11. This probably explains why 32 sectors-per-read did well - it&rsquo;s very close to 33.</p>

<p>For writing, the number of requests in flight makes little difference, but writing 8 sectors in each request is by far the best (7 MB/s).</p>

<p>I don&rsquo;t understand why we&rsquo;re not getting the full speed of the card here, since we&rsquo;re spending most of the time blocking.
However, we are pretty close (18r/7w out of a possible 20r/10w), which is good enough for today.</p>

<h3>Update: Linux is slow too!</h3>

<p>I originally tested with <code>hdparm</code>, which reports about 20 MB/s as expected:</p>

<pre><code>$ hdparm -t /dev/mmcblk0
 Timing buffered disk reads:  62 MB in  3.07 seconds =  20.21 MB/sec
</code></pre>

<p>But testing with <code>dd</code>, I don&rsquo;t get this speed.
<code>dd</code>&rsquo;s speed seems to depend a lot on the block size. Using <code>4096 * 11</code> bytes (which I assume is what dom0 would do in response to a single guest request), I get just 16.9 MB/s:</p>

<pre><code>$ dd iflag=direct if=/dev/vg0/bench of=/dev/null bs=45056 count=1000
1000+0 records in
1000+0 records out
45056000 bytes (45 MB) copied, 2.65911 s, 16.9 MB/s
</code></pre>

<table class="table">
  <thead>
    <tr>
      <th style="text-align: right">Block size (pages)</th>
      <th style="text-align: right">Linux dom0</th>
      <th style="text-align: right">Linux domU</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">11</td>
      <td style="text-align: right">17.0 MB/s</td>
      <td style="text-align: right">14.5 MB/s</td>
    </tr>
    <tr>
      <td style="text-align: right">16</td>
      <td style="text-align: right">18.8 MB/s</td>
      <td style="text-align: right">16.3 MB/s</td>
    </tr>
    <tr>
      <td style="text-align: right">32</td>
      <td style="text-align: right">20.8 MB/s</td>
      <td style="text-align: right">18.6 MB/s</td>
    </tr>
  </tbody>
</table>

<p>So perhaps Mirage is doing pretty well already - it&rsquo;s about as fast as the Linux guest.
Xen seems to be the limiting factor here, because it doesn&rsquo;t allow us to make large enough requests.</p>

<h2>Profiling the queuing service</h2>

<p>Finally, I looked at applying all this new information to my queuing service.
As a baseline, <code>wget</code> reports that I can currently download from it at 4.6 MB/s, with profiling compiled in but disabled:</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/http-download1.png" class="border center"/></p>

<p>There&rsquo;s some complicated copying going on because we&rsquo;re using the HTTP Chunked encoding, which writes the size of each chunk of data followed by the data itself, then the next chunk, etc.
Since we know the length at the start, we can use the simpler Fixed encoding.
This increases the speed to 5.2 MB/s.
It&rsquo;s a shame the HTTP API uses strings everywhere: we have to copy the data from the disk buffer to a string on the heap to give it to the HTTP API, which then copies it back into a new buffer to send it to the network card.
If it took a stream of buffers, we could just pass them straight through.</p>

<p>Finally, I added the read-ahead support from the block profiling above, which increased the speed to 6.8 MB/s.
Here&rsquo;s the new graph, showing that we&rsquo;re sending packets much faster (note the change in the Y-scale):</p>

<p><img src="http://roscidus.com/blog/images/mirage-profiling/http-download2.png" class="border center"/></p>

<p>I used a queue length of 5, with 33 sectors per request. I tried increasing it to 10, but that caused more GC work.</p>

<h2>Conclusions</h2>

<p>Even the unoptimised service is faster than my current (ADSL) Internet connection, so optimising it isn&rsquo;t currently necessary, but it&rsquo;s interesting to look at performance and get a feel for where the bottlenecks are.</p>

<p>Mirage doesn&rsquo;t have any specific profiling support, but the fact that the whole OS is a single executable makes profiling it quite easy.
OCaml&rsquo;s <code>profile</code> option isn&rsquo;t a perfect fit for tracing because it doesn&rsquo;t record when a function finishes, but you can still get useful results from it.
Graphing some metric (e.g. packets sent) over time seemed the most useful way to look at the data.
I&rsquo;m currently just using libreoffice&rsquo;s chart tool, but I should probably find something more suitable.
It would be great to be able to zoom in easily, show durations (not just events), filter the trace display easily, etc.
I&rsquo;d also like support for following Lwt threads even when they block.
Recommendations for good visualisation tools welcome!</p>

<p>Writing to the Xen console from Mirage is slow because <code>xenconsoled</code> rate limits us. Mirage still gets better performance than Linux though, and uses far less CPU (looks like Linux is just spinning). My UDP test kernel sent data faster than Linux&rsquo;s <code>nc</code> utility (probably because <code>nc</code> made a poor choice of payload size). Linux does very well on TCP. I don&rsquo;t know why it&rsquo;s so fast. Using Xen&rsquo;s TCP checksum offloading does help a bit though. SD card performance on Mirage is close to what the hardware supports when I choose the right request size and keep two requests in flight at once. It&rsquo;s surprising we don&rsquo;t manage the full speed, though. For networking and disk access, managing Xen&rsquo;s grant refs for the shared memory pages seems to take up a lot of time - maybe there are ways to optimise that.</p>

<p>With a few modifications (TCP checksum offload, HTTP fixed encoding, keeping multiple disk reads in flight and using optimal buffer sizes), I increased the download speed of my test service running on my ARM dev board from 2.46 MB/s to 7.24 MB/s (when compiled without profiling).
I&rsquo;m sure people more familiar with Mirage will have more suggestions.</p>
<a onclick="switchContent('ocamlorg-post20','ocamlorg-post19')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/08/15/optimising-the-unikernel/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2014/08/15/optimising-the-unikernel/">by Thomas Leonard at Aug 15, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">
    <a name="#http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">My first unikernel</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post21"><p>I wanted to make a simple REST service for queuing file uploads, deployable as a virtual machine. The traditional way to do this is to download a Linux cloud image, install the software inside it, and deploy that. Instead I decided to try a <a href="http://queue.acm.org/detail.cfm?id=2566628">unikernel</a>.</p>

<p>Unikernels promise some interesting benefits. The Ubuntu 14.04 amd64-disk1.img cloud image is 243 MB unconfigured, while the unikernel ended up at just 5.2 MB (running the queue service). Ubuntu runs a large amount of C code in security-critical places, while the unikernel is almost entirely type-safe OCaml. And besides, trying new things is fun.</p>



<p>( this post also appeared on <a href="http://www.reddit.com/r/programming/comments/2c1soi/my_first_unikernel_created_in_ocaml_and_mirage/">Reddit</a> and <a href="https://news.ycombinator.com/item?id=8109485">Hacker News</a> )</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#introduction">Introduction</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#a-hello-world-kernel">A hello world kernel</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#using-mirage-libraries">Using Mirage libraries</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-mirage-unix-libraries">The mirage-unix libraries</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-mirage-tool">The <code>mirage</code> tool</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#test-case">Test case</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#storage">Storage</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#implementation">Implementation</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#unit-testing-the-storage-system">Unit-testing the storage system</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-http-server">The HTTP server</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#buffered-reads">Buffered reads</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#streaming-uploads">Streaming uploads</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#buffered-writes">Buffered writes</a></li>
     &hellip;</ul></li></ul><a onclick="switchContent('ocamlorg-post21','ocamlorg-post22')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">Read more...</a></div><div id="ocamlorg-post22" style="display: none"><p>I wanted to make a simple REST service for queuing file uploads, deployable as a virtual machine. The traditional way to do this is to download a Linux cloud image, install the software inside it, and deploy that. Instead I decided to try a <a href="http://queue.acm.org/detail.cfm?id=2566628">unikernel</a>.</p>

<p>Unikernels promise some interesting benefits. The Ubuntu 14.04 amd64-disk1.img cloud image is 243 MB unconfigured, while the unikernel ended up at just 5.2 MB (running the queue service). Ubuntu runs a large amount of C code in security-critical places, while the unikernel is almost entirely type-safe OCaml. And besides, trying new things is fun.</p>



<p>( this post also appeared on <a href="http://www.reddit.com/r/programming/comments/2c1soi/my_first_unikernel_created_in_ocaml_and_mirage/">Reddit</a> and <a href="https://news.ycombinator.com/item?id=8109485">Hacker News</a> )</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#introduction">Introduction</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#a-hello-world-kernel">A hello world kernel</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#using-mirage-libraries">Using Mirage libraries</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-mirage-unix-libraries">The mirage-unix libraries</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-mirage-tool">The <code>mirage</code> tool</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#test-case">Test case</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#storage">Storage</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#implementation">Implementation</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#unit-testing-the-storage-system">Unit-testing the storage system</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#the-http-server">The HTTP server</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#buffered-reads">Buffered reads</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#streaming-uploads">Streaming uploads</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#buffered-writes">Buffered writes</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#upload-speed-on-xen">Upload speed on Xen</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#tcp-retransmissions">TCP retransmissions</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#adding-a-block-cache">Adding a block cache</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#replacing-fat">Replacing FAT</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#conclusions">Conclusions</a></li>
</ul>

<p>Regular readers will know that a few months ago I began a new job at Cambridge University.
Working for an author of Real World OCaml and leader of OCaml Labs, on a project building pure-OCaml distributed systems, who found me through my blog posts about learning OCaml, I thought they might want me to write some OCaml.</p>

<p>But no.
They&rsquo;ve actually had me <a href="http://openmirage.org/blog/introducing-xen-minios-arm">porting the tiny Mini-OS kernel to ARM</a>, using a mixture of C and assembler, to let <a href="http://openmirage.org/">the Mirage unikernel</a> run on ARM devices.
Of course, I got curious and wanted to write a Mirage application for myself&hellip;</p>

<h2>Introduction</h2>

<p>Linux, like many popular operating systems, is a <em>multi-user</em> system.
This design dates back to the early days of computing, when a single expensive computer, running a single OS, would be shared between many users.
The goal of the kernel is to protect itself from its users, and to protect the users from each other.</p>

<p>Today, computers are cheap and many people own several.
Even when a physical computer is shared (e.g. in cloud computing), this is typically done by running multiple virtual machines, each serving a single user.
Here, protecting the OS from its (usually single) application is pointless.</p>

<p>Removing the security barrier between the kernel and the application greatly simplifies things;
we can run the whole system (kernel + application) as a single, privileged, executable - a <em>unikernel</em>.</p>

<p>And while we&rsquo;re rewriting everything anyway, we might as well replace C with a modern memory safe language, eliminating whole classes of bugs and security vulnerabilities, allowing decent error reporting, and providing structured data types throughout.</p>

<p>In the past, two things have made writing a completely new OS impractical:</p>

<ul>
  <li>Legacy applications won&rsquo;t run on it.</li>
  <li>It probably won&rsquo;t support your hardware.</li>
</ul>

<p>Virtualisation removes both obstacles:
legacy applications can run in their own legacy VMs, and
drivers are only needed for the virtual devices - e.g.
a single network driver and a single block driver will cover all real network cards and hard drives.</p>

<h3>A hello world kernel</h3>

<p>The <a href="http://openmirage.org/wiki/install">mirage tutorial</a> starts by showing the easy, fully-automated way to build a unikernel.
If you want to get started quickly you may prefer to read that and skip this section, but since one of the advantages of unikernels is their relative simplicity, let&rsquo;s do things the &ldquo;hard&rdquo; way first to understand how it works behind the scenes.</p>

<p>Here&rsquo;s the normal &ldquo;hello world&rdquo; program in OCaml:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>hw.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">print_endline</span> <span class="s2">&quot;Hello, world!&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To compile and run as a normal application, we&rsquo;d do:</p>

<pre><code>$ ocamlopt hw.ml -o hw
$ ./hw 
Hello, world!
</code></pre>

<p>How can we make a unikernel that does the equivalent?
As it turns out, the above code works unmodified (though the Mirage people might frown at you for doing it this way).
We compile hw.ml to a <code>hw.native.o</code> file and then link with the unikernel libraries instead of the standard C library:</p>

<pre><code>$ export OPAM_DIR=$(opam config var prefix)
$ export PKG_CONFIG_PATH=$OPAM_DIR/lib/pkgconfig
$ ocamlopt -output-obj -o hw.native.o hw.ml
$ ld -d -static -nostdlib --start-group \
    $(pkg-config --static --libs openlibm libminios-xen) \
    hw.native.o \
    $OPAM_DIR/lib/mirage-xen/libocaml.a \
    $OPAM_DIR/lib/mirage-xen/libxencaml.a \
    --end-group \
    $(gcc -print-libgcc-file-name) \
    -o hw.xen
</code></pre>

<p>We now have a kernel image, <code>hw.xen</code>, which can be booted as a VM under the <a href="http://www.xenproject.org/developers/teams/hypervisor.html">Xen hypervisor</a> (as used by Amazon, Rackspace, etc to host VMs). But first, let&rsquo;s look at the libraries we added:</p>

<dl>
  <dt>openlibm</dt>
  <dd>This is a standard maths library. It provides functions such as <code>sin</code>, <code>cos</code>, etc.</dd>
  <dt>libminios-xen</dt>
  <dd>This provides the architecture-specific boot code, a <code>printk</code> function for debugging, <code>malloc</code> for allocating memory and some low-level functions for talking to Xen.</dd>
  <dt>libocaml.a</dt>
  <dd>The OCaml runtime (the garbage collector, etc).</dd>
  <dt>libxencaml.a</dt>
  <dd>OCaml bindings for libminios and some boot code.</dd>
  <dt>libgcc.a</dt>
  <dd>Support functions for code that gcc generates (actually, not needed on x86).</dd>
</dl>

<p>To deploy the new unikernel, we create a Xen configuration file for it (here, I&rsquo;m giving it 16 MB of RAM):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>hw.xl </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">name</span> <span class="o">=</span> <span class="s">'hw'</span>
</span><span class="line"><span class="n">kernel</span> <span class="o">=</span> <span class="s">'hw.xen'</span>
</span><span class="line"><span class="n">memory</span> <span class="o">=</span> <span class="mi">16</span>
</span><span class="line"><span class="n">on_crash</span> <span class="o">=</span> <span class="s">'preserve'</span>
</span><span class="line"><span class="n">on_poweroff</span> <span class="o">=</span> <span class="s">'preserve'</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Setting <code>on_crash</code> and <code>on_poweroff</code> to <code>preserve</code> lets us see any output or errors, which would otherwise be missed if the VM exits too quickly.</p>

<p>We can now boot our new VM:</p>

<pre><code>$ xl create -c hw.xl
Xen Minimal OS!
  start_info: 000000000009b000(VA)
    nr_pages: 0x800
  shared_inf: 0x6ee97000(MA)
     pt_base: 000000000009e000(VA)
nr_pt_frames: 0x5
    mfn_list: 0000000000097000(VA)
   mod_start: 0x0(VA)
     mod_len: 0
       flags: 0x0
    cmd_line: 
       stack: 0000000000055e00-0000000000075e00
Mirage: start_kernel
MM: Init
      _text: 0000000000000000(VA)
     _etext: 000000000003452d(VA)
   _erodata: 000000000003c000(VA)
     _edata: 000000000003e4d0(VA)
stack start: 0000000000055e00(VA)
       _end: 0000000000096d64(VA)
  start_pfn: a6
    max_pfn: 800
Mapping memory range 0x400000 - 0x800000
setting 0000000000000000-000000000003c000 readonly
skipped 0000000000001000
MM: Initialise page allocator for a8000(a8000)-800000(800000)
MM: done
Demand map pfns at 801000-2000801000.
Initialising timer interface
Initialising console ... done.
gnttab_table mapped at 0000000000801000.
xencaml: app_main_thread
getenv(OCAMLRUNPARAM) -&gt; null
getenv(CAMLRUNPARAM) -&gt; null
Unsupported function lseek called in Mini-OS kernel
Unsupported function lseek called in Mini-OS kernel
Unsupported function lseek called in Mini-OS kernel
Hello, world!
main returned 0
</code></pre>

<p>( Note: I&rsquo;m testing locally by running Xen under VirtualBox. Not all of Xen&rsquo;s features can be used in this mode, but it works for testing unikernels. I&rsquo;m also using my Git version of <code>mirage-xen</code>; the official one will display an error after printing the greeting because it expects you to provide a mainloop too. The warnings about <code>lseek</code> are just OCaml trying to find the current file offsets for <code>stdin</code>, <code>stdout</code> and <code>stderr</code>.)</p>

<p>As you can see, the boot process is quite short.
Execution begins at <a href="http://xenbits.xenproject.org/gitweb/?p=xen.git%3Ba=blob%3Bf=extras/mini-os/arch/x86/x86_64.S%3Bh=df3469ef4319a75cc9d4c36b51f4097897c015f2%3Bhb=HEAD#l19"><code>_start</code></a>.
Using <code>objdump -d hw.xen</code>, you can see that this just sets up the stack pointer register and calls the C function <code>arch_init</code>:</p>

<pre><code>0000000000000000 &lt;_start&gt;:
       0:   fc                      cld    
       1:   48 8b 25 0f 00 00 00    mov    0xf(%rip),%rsp        # 17 &lt;stack_start&gt;
       8:   48 81 e4 00 00 ff ff    and    $0xffffffffffff0000,%rsp
       f:   48 89 f7                mov    %rsi,%rdi
      12:   e8 e2 bb 00 00          callq  bbf9 &lt;arch_init&gt;
</code></pre>

<p><a href="http://xenbits.xenproject.org/gitweb/?p=xen.git%3Ba=blob%3Bf=extras/mini-os/arch/x86/setup.c%3Bh=5e87dd1d99014a8139d8a63b375793661e57263b%3Bhb=HEAD#l93">arch_init</a> (in libminios) initialises the traps and FPU and then prints <code>Xen Minimal OS!</code> and information about various addresses.
It then calls <code>start_kernel</code>.</p>

<p><a href="https://github.com/mirage/mirage-platform/blob/45814f85acca6174915acbb571146e1c4e978684/xen/runtime/xencaml/main.c#L57">start_kernel</a> (in libxencaml) sets up a few more features (events, interrupts, malloc, time-keeping and grant tables), then calls <code>caml_startup</code>.</p>

<p><a href="https://github.com/mirage/mirage-platform/blob/45814f85acca6174915acbb571146e1c4e978684/xen/runtime/ocaml/startup.c#L202">caml_startup</a> (in libocaml) initialises the garbage collector and calls <code>caml_program</code>, which is our <code>hw.native.o</code>.</p>

<p>We call <code>print_endline</code>, which libxencaml, as a convenience for debugging, forwards to libminios&rsquo;s <code>console_print</code>.</p>

<h3>Using Mirage libraries</h3>

<p>The above was a bit of a hack, which ended up just using the C console driver in libminios (one of the few things it provides, as it&rsquo;s needed for printk).
We can instead use the <code>mirage-console-xen</code> OCaml library, like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>hw.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">open</span> <span class="nc">Lwt</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">main</span> <span class="o">=</span>
</span><span class="line">  <span class="nn">Console</span><span class="p">.</span><span class="n">connect</span> <span class="s2">&quot;0&quot;</span> <span class="o">&gt;&gt;=</span> <span class="k">function</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;Failed to connect to console&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="nc">Ok</span> <span class="n">default_console</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="nn">Console</span><span class="p">.</span><span class="n">log_s</span> <span class="n">default_console</span> <span class="s2">&quot;Hello, world!&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="nn">OS</span><span class="p">.</span><span class="nn">Main</span><span class="p">.</span><span class="n">run</span> <span class="n">main</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Mirage uses the usual <code>Lwt</code> library for cooperative threading, which I wrote about at last year in <a href="http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/">Asynchronous Python vs OCaml</a> - <code>&gt;&gt;=</code> means to wait for the result, allowing other code to run. Everything in Mirage is non-blocking, even looking up the console. <code>OS.Main.run</code> runs the main event loop.</p>

<p>Since we&rsquo;re using libraries, let&rsquo;s switch to ocamlbuild and give the dependencies in the <code>_tags</code> file, as usual for OCaml projects:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>_tags </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">true: warn(A), strict_sequence, package(mirage-console-xen)</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The only unusual thing we have to do here is tell ocamlbuild not to link in the <code>Unix</code> module when we build <code>hw.native.o</code>:</p>

<pre><code>$ ocamlbuild -lflags -linkpkg,-dontlink,unix -use-ocamlfind hw.native.o
</code></pre>

<p>In the same way, we can use other libraries to access raw block devices (<a href="https://github.com/mirage/mirage-block-xen">mirage-block-xen</a>), timers (<a href="https://github.com/mirage/mirage-clock">mirage-clock-xen</a>) and network interfaces (<a href="https://github.com/mirage/mirage-net-xen/">mirage-net-xen</a>).
Other (non-Xen-specific) OCaml libraries can then be used on top of these low-level drivers.
For example, <a href="https://github.com/mirage/ocaml-fat">fat-filesystem</a> can provide a filesystem on a block device, while <a href="https://github.com/mirage/mirage-tcpip">tcpip</a> provides an OCaml TCP/IP stack on a network interface.</p>

<h3>The mirage-unix libraries</h3>

<p>You may have noticed that the Xen driver libraries we used above ended in <code>-xen</code>.
In fact, each of these is just an implementation of some generic interface provided by Mirage.
For example, <a href="https://github.com/mirage/mirage/blob/master/types/V1.mli">mirage/types</a> defines the abstract <code>CONSOLE</code> interface as:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">CONSOLE</span> <span class="o">=</span> <span class="k">sig</span>
</span><span class="line">  <span class="c">(** Text console input/output operations. *)</span>
</span><span class="line">
</span><span class="line">  <span class="k">type</span> <span class="n">error</span> <span class="o">=</span> <span class="o">[</span>
</span><span class="line">    <span class="o">|</span> <span class="o">`</span><span class="nc">Invalid_console</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class="line">  <span class="o">]</span>
</span><span class="line">  <span class="c">(** The type representing possible errors when attaching a console. *)</span>
</span><span class="line">
</span><span class="line">  <span class="k">include</span> <span class="nc">DEVICE</span> <span class="k">with</span>
</span><span class="line">    <span class="k">type</span> <span class="n">error</span> <span class="o">:=</span> <span class="n">error</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">write</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span>
</span><span class="line">  <span class="c">(** [write t buf off len] writes up to [len] chars of [String.sub buf</span>
</span><span class="line"><span class="c">      off len] to the console [t] and returns the number of bytes</span>
</span><span class="line"><span class="c">      written. Raises {!Invalid_argument} if [len &gt; buf - off]. *)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">write_all</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="n">io</span>
</span><span class="line">  <span class="c">(** [write_all t buf off len] is a thread that writes [String.sub buf</span>
</span><span class="line"><span class="c">      off len] to the console [t] and returns when done. Raises</span>
</span><span class="line"><span class="c">      {!Invalid_argument} if [len &gt; buf - off]. *)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">log</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span><span class="line">  <span class="c">(** [log str] writes as much characters of [str] that can be written</span>
</span><span class="line"><span class="c">      in one write operation to the console [t], then writes</span>
</span><span class="line"><span class="c">      &quot;\r\n&quot; to it. *)</span>
</span><span class="line">
</span><span class="line">  <span class="k">val</span> <span class="n">log_s</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="n">io</span>
</span><span class="line">  <span class="c">(** [log_s str] is a thread that writes [str ^ &quot;\r\n&quot;] in the</span>
</span><span class="line"><span class="c">      console [t]. *)</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>By linking against the <code>-unix</code> versions of libraries rather than the <code>-xen</code> ones, we can compile our code as an ordinary Unix program and run it directly.
This makes testing and debugging very easy.</p>

<p>To make sure our code is generic enough to do this, we can wrap it in a functor that takes any console module as an input:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>unikernel.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">Main</span> <span class="o">(</span><span class="nc">C</span> <span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">CONSOLE</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">let</span> <span class="n">start</span> <span class="n">c</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">C</span><span class="p">.</span><span class="n">log_s</span> <span class="n">c</span> <span class="s2">&quot;Hello, world!&quot;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The code that provides a Xen or Unix console and calls this goes in <code>main.ml</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>main.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">open</span> <span class="nc">Lwt</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">console</span> <span class="o">=</span>
</span><span class="line">  <span class="nn">Console</span><span class="p">.</span><span class="n">connect</span> <span class="s2">&quot;0&quot;</span> <span class="o">&gt;&gt;=</span> <span class="k">function</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;Failed to connect to console&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="nc">Ok</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="n">c</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nc">U</span> <span class="o">=</span> <span class="nn">Unikernel</span><span class="p">.</span><span class="nc">Main</span><span class="o">(</span><span class="nc">Console</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="nn">OS</span><span class="p">.</span><span class="nn">Main</span><span class="p">.</span><span class="n">run</span> <span class="o">(</span><span class="n">console</span> <span class="o">&gt;&gt;=</span> <span class="nn">U</span><span class="p">.</span><span class="n">start</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>The <code>mirage</code> tool</h3>

<p>With the platform-specific code isolated in <code>main.ml</code>, we can now use the <code>mirage</code> command-line tool to generate it automatically for the target platform.
<code>mirage</code> takes a <code>config.ml</code> configuration file and generates <code>Makefile</code> and <code>main.ml</code> based on the current platform and the arguments passed.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>config.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">open</span> <span class="nc">Mirage</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">foreign</span> <span class="s2">&quot;Unikernel.Main&quot;</span> <span class="o">(</span><span class="n">console</span> <span class="o">@-&gt;</span> <span class="n">job</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">register</span> <span class="s2">&quot;hw&quot;</span> <span class="o">[</span>
</span><span class="line">    <span class="n">main</span> <span class="o">$</span> <span class="n">default_console</span>
</span><span class="line">  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<pre><code>$ mirage configure --unix
$ make
$ ./mir-hw 
Hello, world!
</code></pre>

<p>I won&rsquo;t describe this in detail because at this point we&rsquo;ve reached the start of the <a href="http://openmirage.org/wiki/hello-world">official tutorial</a>, and you can read that instead.</p>

<h2>Test case</h2>

<p>Because <a href="http://0install.net">0install</a> is decentralised, it doesn&rsquo;t need a single centrally-managed repository (or several incompatible repositories, each trying to package every program, as is common with Linux distributions).
In 0install, it&rsquo;s possible for every developer to run their own <a href="http://0install.net/0repo.html">repository</a>, containing just their software, with cross-repository dependencies handled automatically.
But just because it&rsquo;s possible doesn&rsquo;t mean we have to go to that extreme: having medium sized repositories each managed by a team of people can be very convenient, especially where package maintainers come and go.</p>

<p>The general pattern for a group repository is to have a public server that accepts new package uploads from developers, and a private (firewalled) server with the repository&rsquo;s GPG key, which downloads from it:</p>

<p><img src="http://roscidus.com/blog/images/0repo-multi.png" class="center"/></p>

<p>Debian uses an anonymous FTP server for its incoming queue, polling it with a cron job.
This turns out to be surprisingly complicated.
You need to handle incomplete uploads (not processing them until they&rsquo;re done, or deleting them eventually if they never complete), allow contributors to overwrite or delete their own partial uploads (Debian allows you to upload a GPG-signed command file, which provides some control), etc, as well as keep the service fully patched.
Also, the cron system can be annoying: if the package contains a mistake then it will be several minutes before it discovers this and emails the packager.</p>

<p>Perhaps there are some decent systems out there to handle all this, but it seemed like a good opportunity to try making a unikernel.</p>

<p>A particularly nice feature of this test-case is that it doesn&rsquo;t matter too much if it fails:
the repository itself will check the developer&rsquo;s signature on the files, so an attacker can&rsquo;t compromise the repository by breaking into the queue; everything in the queue is intended to become public, so we need not worry much about confidentiality; lost uploads can be easily resubmitted; and if it goes down for a bit, it just means that new software can&rsquo;t be added to the repository.
So, there&rsquo;s nothing critical about this service, which is reassuring.</p>

<h3>Storage</h3>

<p>The <a href="https://github.com/mirage/merge-queues">merge-queues</a> library builds a queue abstraction on top of
<a href="https://github.com/mirage/irmin">Irmin</a>, a Git-inspired storage system for Mirage.
But my needs are simple, and I wanted to test the more primitive libraries first, so I decided to build my queue directly on a plain filesystem.
This was the first interface I came up with:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>upload_queue.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="k">type</span> <span class="nc">FS</span> <span class="o">=</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">FS</span> <span class="k">with</span>
</span><span class="line">  <span class="k">type</span> <span class="n">page_aligned_buffer</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">t</span> <span class="ow">and</span>
</span><span class="line">  <span class="k">type</span> <span class="n">block_device_error</span> <span class="o">=</span> <span class="nn">Fat</span><span class="p">.</span><span class="nn">Fs</span><span class="p">.</span><span class="n">block_error</span>
</span><span class="line">
</span><span class="line"><span class="c">(** An upload.</span>
</span><span class="line"><span class="c"> * To avoid loading complete uploads into RAM, we stream them</span>
</span><span class="line"><span class="c"> * between the network and the disk. *)</span>
</span><span class="line"><span class="k">type</span> <span class="n">item</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">size</span> <span class="o">:</span> <span class="n">int64</span><span class="o">;</span>
</span><span class="line">  <span class="n">data</span> <span class="o">:</span> <span class="kt">string</span> <span class="nn">Lwt_stream</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">type</span> <span class="n">add_error</span> <span class="o">=</span> <span class="o">[`</span><span class="nc">Wrong_size</span> <span class="k">of</span> <span class="n">int64</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Unknown</span> <span class="k">of</span> <span class="n">exn</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nc">Make</span> <span class="o">:</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">F</span> <span class="o">:</span> <span class="nc">FS</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">sig</span>
</span><span class="line">  <span class="c">(** An upload queue. *)</span>
</span><span class="line">  <span class="k">type</span> <span class="n">t</span>
</span><span class="line">
</span><span class="line">  <span class="c">(** Create a new queue, backed by a filesystem. *)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">create</span> <span class="o">:</span> <span class="nn">F</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">t</span>
</span><span class="line">
</span><span class="line">  <span class="k">module</span> <span class="nc">Upload</span> <span class="o">:</span> <span class="k">sig</span>
</span><span class="line">    <span class="c">(** Add an upload to the queue.</span>
</span><span class="line"><span class="c">     * The upload is added only once the end of the stream is</span>
</span><span class="line"><span class="c">     * reached, and only if the total size matches the size</span>
</span><span class="line"><span class="c">     * in the record.</span>
</span><span class="line"><span class="c">     * To cancel an add, just terminate the stream. *)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">add</span> <span class="o">:</span>
</span><span class="line">      <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">item</span> <span class="o">-&gt;</span> <span class="o">[</span> <span class="o">`</span><span class="nc">Ok</span> <span class="k">of</span> <span class="kt">unit</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Error</span> <span class="k">of</span> <span class="n">add_error</span> <span class="o">]</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">t</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">module</span> <span class="nc">Download</span> <span class="o">:</span> <span class="k">sig</span>
</span><span class="line">    <span class="c">(** Interface for the repository software to fetch items</span>
</span><span class="line"><span class="c">     * from the queue. Only one client may use this interface</span>
</span><span class="line"><span class="c">     * at a time, or things will go wrong. *)</span>
</span><span class="line">
</span><span class="line">    <span class="c">(** Return a fresh stream for the item at the head of the</span>
</span><span class="line"><span class="c">     * queue, without removing it. After downloading it</span>
</span><span class="line"><span class="c">     * successfully, the client should call [delete]. If the</span>
</span><span class="line"><span class="c">     * queue is empty, this blocks until an item is available. *)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">peek</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">item</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">t</span>
</span><span class="line">
</span><span class="line">    <span class="c">(** Delete the item previously retrieved by [peek].</span>
</span><span class="line"><span class="c">     * If the previous item has already been deleted, this does</span>
</span><span class="line"><span class="c">     * nothing, even if there are more items in the queue. *)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">delete</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">unit</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">t</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Our <code>unikernel.ml</code> will use this to make a queue, backed by a filesystem.
Uploaders&rsquo; HTTP POSTs will be routed to <code>Upload.add</code>, while the repository&rsquo;s GET and DELETE invocations go to the <code>Download</code> submodule.
<code>delete</code> is a separate operation because we want the repository to confirm that it got the item successfully before we delete it, in case of network errors.</p>

<p>Ideally, we might require that the <code>DELETE</code> comes over the same HTTP connection as the <code>GET</code> just in case we accidentally run two instances of the repository software, but that&rsquo;s unlikely and it&rsquo;s convenient to test using separate <code>curl</code> invocations.</p>

<p>We&rsquo;re using another functor here, <code>Upload_queue.Make</code>, so that our queue will work over any filesystem.
In theory, we can configure our unikernel with a FAT filesystem on a block device when running under Xen,
while using a regular directory when running under Linux (e.g. for testing).</p>

<p>But it doesn&rsquo;t work.
You can see at the top that I had to restrict Mirage&rsquo;s abstract <code>FS</code> type in two ways:</p>

<ul>
  <li>
    <p>The <code>read</code> and <code>write</code> functions in <code>FS</code> pass the data using the abstract <code>page_aligned_buffer</code> type.
Since we need to do something with the data, this isn&rsquo;t good enough.
I therefore declare that this must be a <code>Cstruct.t</code> (basically, an array of bytes).
This is actually OK; <a href="https://github.com/mirage/mirage-fs-unix">mirage-fs-unix</a> also uses this type.</p>
  </li>
  <li>
    <p>One of the possible error codes from <code>FS</code> is the abstract type <code>FS.block_device_error</code>, and I can&rsquo;t
see any way to turn one of these into a string using the <code>FS</code> interface.
I therefore require a filesystem implementation that defines it to be <code>Fat.Fs.block_error</code>.
Obviously, this means we now only support the FAT filesystem.</p>
  </li>
</ul>

<p>This doesn&rsquo;t prevent us from running as a normal process, because we can ask for a Unix &ldquo;block&rdquo; device (actually, just a plain <code>disk.img</code> file) and pass that to the <code>Fat</code> module, but it would be nice to have the option of using a real directory.</p>

<p>I asked about this on the mailing list - <a href="http://lists.xenproject.org/archives/html/mirageos-devel/2014-07/msg00048.html">Mirage questions from writing a REST service</a> - and it looks like the <code>FS</code> type will change soon.</p>

<h3>Implementation</h3>

<p>For the curious, this initial implementation is in <a href="https://github.com/0install/0repo-queue/blob/063db53c6faf76c7a9edd18416c25459603b777d/upload_queue.ml">upload_queue.ml</a>.</p>

<p>Internally, the module creates an in-memory queue to keep track of successful uploads.
Uploads are streamed to the disk and
when an upload completes with the declared size, the filename is added to the queue.
If the upload ends with the wrong size (probably because the connection was lost), the file is deleted.</p>

<p>But what if our VM gets rebooted?
We need to scan the file system at start up and work out which uploads are complete and which should be deleted.
My first thought was to name the files <code>NUMBER.part</code> during the upload and rename on success.
However, the <code>FS</code> interface currently lacks a <code>rename</code> method.
Instead, I write an <code>N</code> byte to the start of each file and set it to <code>Y</code> on success.
That works, but renaming would be nicer!</p>

<p>For downloading, the <code>peek</code> function returns the item at the head of the queue.
If the queue is empty, it waits until something arrives.
The repository just makes a GET request - if something is available then it returns immediately,
otherwise the connection stays open until some data is ready, allowing the repository to respond immediately to new uploads.</p>

<h3>Unit-testing the storage system</h3>

<p>Because our unikernel can run as a process, testing is easy even if you don&rsquo;t have a local Xen deployment.
A set of unit-tests test the upload queue module just as for any other program, and the service can be run as a normal process, listening on a normal TCP socket.
A slight annoyance here is that the generated Makefile doesn&rsquo;t include any rules to build the tests so you have to add them manually, and
if you regenerate the Makefile then it loses the new rule.</p>

<p>As you might expect from such a new system, testing uncovered several problems. The first (minor) problem is that when the disk becomes full, the unhelpful error reported by the filesystem is <code>Failure(&quot;Unknown error: Failure(\&quot;fault\&quot;)&quot;)</code>.</p>

<p>( I asked about this on the mailing list - <a href="http://lists.xenproject.org/archives/html/mirageos-devel/2014-07/msg00069.html">Error handling in Mirage</a> - and there seems to be agreement that error handling should change. )</p>

<p>A more serious problem was that deleting files corrupted the FAT directory index.
I downloaded the FAT library and added a unit-test for delete, which made it easy to track the problem down (despite my lack of knowledge of FAT).
Here&rsquo;s the code for marking a directory entry as deleted in the FAT library:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line">    <span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">sub</span> <span class="n">block</span> <span class="n">offset</span> <span class="n">sizeof</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">delta</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">create</span> <span class="n">sizeof</span> <span class="k">in</span>
</span><span class="line">    <span class="k">begin</span> <span class="k">match</span> <span class="n">unmarshal</span> <span class="n">b</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="nc">Lfn</span> <span class="n">lfn</span> <span class="o">-&gt;</span>
</span><span class="line">	<span class="k">let</span> <span class="n">lfn'</span> <span class="o">=</span> <span class="o">{</span> <span class="n">lfn</span> <span class="k">with</span> <span class="n">lfn_deleted</span> <span class="o">=</span> <span class="bp">true</span> <span class="o">}</span> <span class="k">in</span>
</span><span class="line">	<span class="n">marshal</span> <span class="n">delta</span> <span class="o">(</span><span class="nc">Lfn</span> <span class="n">lfn'</span><span class="o">)</span>
</span><span class="line">      <span class="o">|</span> <span class="nc">Dos</span> <span class="n">dos</span> <span class="o">-&gt;</span>
</span><span class="line">	<span class="k">let</span> <span class="n">dos'</span> <span class="o">=</span> <span class="o">{</span> <span class="n">dos</span> <span class="k">with</span> <span class="n">deleted</span> <span class="o">=</span> <span class="bp">true</span> <span class="o">}</span> <span class="k">in</span>
</span><span class="line">	<span class="n">marshal</span> <span class="n">b</span> <span class="o">(</span><span class="nc">Dos</span> <span class="n">dos'</span><span class="o">)</span>
</span><span class="line">      <span class="o">|</span> <span class="nc">End</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>
</span><span class="line">    <span class="k">end</span><span class="o">;</span>
</span><span class="line">    <span class="nn">Update</span><span class="p">.</span><span class="n">from_cstruct</span> <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">of_int</span> <span class="n">offset</span><span class="o">)</span> <span class="n">delta</span> <span class="o">::</span> <span class="n">acc</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It&rsquo;s supposed to take an entry, unmarshal it into an OCaml structure, set the <code>deleted</code> flag, and marshal the result into a new <code>delta</code> structure.
These deltas are returned and applied to the device.
The bug is a simple typo: <code>Lfn</code> (long filename) entries update correctly, but for old <code>Dos</code> ones it writes the new block to the input, not to <code>delta</code>.
The fix was simple enough (I also refactored it slightly to encourage the correct behaviour in future):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line">    <span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">sub</span> <span class="n">block</span> <span class="n">offset</span> <span class="n">sizeof</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">delta</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">create</span> <span class="n">sizeof</span> <span class="k">in</span>
</span><span class="line">    <span class="n">marshal</span> <span class="n">delta</span> <span class="k">begin</span> <span class="k">match</span> <span class="n">unmarshal</span> <span class="n">b</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="nc">Lfn</span> <span class="n">lfn</span> <span class="o">-&gt;</span> <span class="nc">Lfn</span> <span class="o">{</span> <span class="n">lfn</span> <span class="k">with</span> <span class="n">lfn_deleted</span> <span class="o">=</span> <span class="bp">true</span> <span class="o">}</span>
</span><span class="line">      <span class="o">|</span> <span class="nc">Dos</span> <span class="n">dos</span> <span class="o">-&gt;</span> <span class="nc">Dos</span> <span class="o">{</span> <span class="n">dos</span> <span class="k">with</span> <span class="n">deleted</span> <span class="o">=</span> <span class="bp">true</span> <span class="o">}</span>
</span><span class="line">      <span class="o">|</span> <span class="nc">End</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>
</span><span class="line">    <span class="k">end</span><span class="o">;</span>
</span><span class="line">    <span class="nn">Update</span><span class="p">.</span><span class="n">from_cstruct</span> <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">of_int</span> <span class="n">offset</span><span class="o">)</span> <span class="n">delta</span> <span class="o">::</span> <span class="n">acc</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This demonstrates both the good and the bad of Mirage: the bug was easy to find and fix, using regular debugging tools.
I&rsquo;m sure fixing a filesystem corruption bug in the Linux kernel would have been vastly more difficult.
On the other hard, Linux is rather well tested, whereas I appear to be the first person ever to try deleting a file in Mirage!</p>

<h3>The HTTP server</h3>

<p>This turned out to be quite simple. Here&rsquo;s the unikernel&rsquo;s <a href="https://github.com/0install/0repo-queue/blob/92c99d34104b6bea707044924f9753a9cc7f0414/unikernel.ml"><code>start</code></a> function:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>unikernel.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">Main</span> <span class="o">(</span><span class="nc">C</span> <span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">CONSOLE</span><span class="o">)</span>
</span><span class="line">            <span class="o">(</span><span class="nc">F</span> <span class="o">:</span> <span class="nn">Upload_queue</span><span class="p">.</span><span class="nc">FS</span><span class="o">)</span>
</span><span class="line">            <span class="o">(</span><span class="nc">H</span> <span class="o">:</span> <span class="nn">Cohttp_lwt</span><span class="p">.</span><span class="nc">Server</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">Q</span> <span class="o">=</span> <span class="nn">Upload_queue</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">F</span><span class="o">)</span>
</span><span class="line">  <span class="o">[...]</span>
</span><span class="line">  <span class="k">let</span> <span class="n">start</span> <span class="n">c</span> <span class="n">fs</span> <span class="n">http</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">Log</span><span class="p">.</span><span class="n">write</span> <span class="o">:=</span> <span class="nn">C</span><span class="p">.</span><span class="n">log_s</span> <span class="n">c</span><span class="o">;</span>
</span><span class="line">    <span class="nn">Log</span><span class="p">.</span><span class="n">info</span> <span class="s2">&quot;starting queue service&quot;</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="nn">Q</span><span class="p">.</span><span class="n">create</span> <span class="n">fs</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">q</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="n">callback</span> <span class="o">_</span><span class="n">conn_id</span> <span class="n">request</span> <span class="n">body</span> <span class="o">=</span>
</span><span class="line">      <span class="k">match</span> <span class="nn">Uri</span><span class="p">.</span><span class="n">path</span> <span class="n">request</span><span class="o">.</span><span class="nn">H</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="n">uri</span> <span class="k">with</span>
</span><span class="line">      <span class="o">|</span> <span class="s2">&quot;/uploader&quot;</span> <span class="o">-&gt;</span> <span class="n">handle_uploader</span> <span class="n">q</span> <span class="n">request</span> <span class="n">body</span>
</span><span class="line">      <span class="o">|</span> <span class="s2">&quot;/downloader&quot;</span> <span class="o">-&gt;</span> <span class="n">handle_downloader</span> <span class="n">q</span> <span class="n">request</span>
</span><span class="line">      <span class="o">|</span> <span class="n">path</span> <span class="o">-&gt;</span>
</span><span class="line">          <span class="nn">H</span><span class="p">.</span><span class="n">respond_error</span>
</span><span class="line">	    <span class="o">~</span><span class="n">status</span><span class="o">:`</span><span class="nc">Bad_request</span>
</span><span class="line">      	    <span class="o">~</span><span class="n">body</span><span class="o">:(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Bad path '%s'</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">path</span><span class="o">)</span>
</span><span class="line">	    <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">    <span class="k">let</span> <span class="n">conn_closed</span> <span class="o">_</span><span class="n">conn_id</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="nn">Log</span><span class="p">.</span><span class="n">info</span> <span class="s2">&quot;connection closed&quot;</span> <span class="o">|&gt;</span> <span class="n">ignore</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">    <span class="n">http</span> <span class="o">{</span> <span class="nn">H</span><span class="p">.</span>
</span><span class="line">      <span class="n">callback</span><span class="o">;</span>
</span><span class="line">      <span class="n">conn_closed</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here, our functor is extended to take a filesystem (using the restricted type required by our <code>Upload_queue</code>, as noted above) and an HTTP server module as arguments.</p>

<p>The HTTP server calls our <code>callback</code> each time it receives a request, and this dispatches <code>/uploader</code> requests to <code>handle_uploader</code> and <code>/downloader</code> ones to <code>handle_downloader</code>. These are also very simple, e.g.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line">  <span class="k">let</span> <span class="n">get</span> <span class="n">q</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">Q</span><span class="p">.</span><span class="nn">Download</span><span class="p">.</span><span class="n">peek</span> <span class="n">q</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="o">{</span><span class="nn">Upload_queue</span><span class="p">.</span><span class="n">size</span><span class="o">;</span> <span class="n">data</span><span class="o">}</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="n">body</span> <span class="o">=</span> <span class="nn">Cohttp_lwt_body</span><span class="p">.</span><span class="n">of_stream</span> <span class="n">data</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">headers</span> <span class="o">=</span> <span class="nn">Cohttp</span><span class="p">.</span><span class="nn">Header</span><span class="p">.</span><span class="n">init_with</span>
</span><span class="line">      <span class="s2">&quot;Content-Length&quot;</span> <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">to_string</span> <span class="n">size</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">    <span class="c">(* Adding a content-length loses the transfer-encoding</span>
</span><span class="line"><span class="c">     * for some reason, so add it back: *)</span>
</span><span class="line">    <span class="k">let</span> <span class="n">headers</span> <span class="o">=</span> <span class="nn">Cohttp</span><span class="p">.</span><span class="nn">Header</span><span class="p">.</span><span class="n">add</span> <span class="n">headers</span>
</span><span class="line">      <span class="s2">&quot;transfer-encoding&quot;</span> <span class="s2">&quot;chunked&quot;</span> <span class="k">in</span>
</span><span class="line">    <span class="nn">H</span><span class="p">.</span><span class="n">respond</span> <span class="o">~</span><span class="n">headers</span> <span class="o">~</span><span class="n">status</span><span class="o">:`</span><span class="nc">OK</span> <span class="o">~</span><span class="n">body</span> <span class="bp">()</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">handle_downloader</span> <span class="n">q</span> <span class="n">request</span> <span class="o">=</span>
</span><span class="line">    <span class="k">match</span> <span class="nn">H</span><span class="p">.</span><span class="nn">Request</span><span class="p">.</span><span class="n">meth</span> <span class="n">request</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="o">`</span><span class="nc">GET</span> <span class="o">-&gt;</span> <span class="n">get</span> <span class="n">q</span>
</span><span class="line">    <span class="o">|</span> <span class="o">`</span><span class="nc">DELETE</span> <span class="o">-&gt;</span> <span class="n">delete</span> <span class="n">q</span>
</span><span class="line">    <span class="o">|</span> <span class="o">`</span><span class="nc">HEAD</span> <span class="o">|</span> <span class="o">`</span><span class="nc">PUT</span> <span class="o">|</span> <span class="o">`</span><span class="nc">POST</span>
</span><span class="line">    <span class="o">|</span> <span class="o">`</span><span class="nc">OPTIONS</span> <span class="o">|</span> <span class="o">`</span><span class="nc">PATCH</span> <span class="o">-&gt;</span> <span class="n">unsupported_method</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The other methods (<code>put</code> and <code>delete</code>) are similar.</p>

<h3>Buffered reads</h3>

<p>Running as a <code>--unix</code> process, I initially got a download speed of
17.2 KB/s, which was rather disappointing.
Especially as Apache on the same machine gets 615 MB/s!</p>

<p>Increasing the size of the chunks I was reading from the Fat
filesystem (a disk.img file) from 512 bytes to 1MB, I was able to
increase this to 2.83 MB/s, and removing the <code>O_DIRECT</code> flag from
<code>mirage-block-unix</code>, download speed increased to 15 MB/s (so this is
with Linux caching the data in RAM).</p>

<p>To check the filesystem was the problem, I removed the <code>F.read</code> call
(so it would return uninitialised data instead of the actual file contents).
It then managed a very respectable 514 MB/s.
Nothing wrong with the HTTP code then.</p>

<h3>Streaming uploads</h3>

<p>It all worked nicely running as a Unix process, so the next step was to deploy on Xen.
I was hoping that most of the bugs would already have been found during the Unix testing,
but in fact there were more lurking.</p>

<p>It worked for very small files, but when uploading larger files it quickly ran
out of memory on my 64-bit x86 test system. I also tried it on my 32-bit CubieTruck
ARM board, but that failed even sooner, with <code>Invalid_argument(&quot;String.create&quot;)</code> (on 32-bit
platforms, OCaml strings are limited to 16 MB).</p>

<p>In both cases, the problem was that the <a href="https://github.com/mirage/ocaml-cohttp">cohttp</a> library tried to read the entire upload in one go.
I found the <a href="https://github.com/mirage/ocaml-cohttp/blob/86394acdb580257ee78cb6976966662575b01bb0/cohttp/transfer_io.ml#L56">read</a> function in <code>Transfer_io</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">read</span> <span class="o">~</span><span class="n">len</span> <span class="n">ic</span> <span class="o">=</span>
</span><span class="line">  <span class="c">(* TODO functorise string to a bigbuffer *)</span>
</span><span class="line">  <span class="k">match</span> <span class="n">len</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span><span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="nc">Done</span>
</span><span class="line">  <span class="o">|</span><span class="n">len</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">read_exactly</span> <span class="n">ic</span> <span class="n">len</span> <span class="o">&gt;&gt;=</span> <span class="k">function</span>
</span><span class="line">    <span class="o">|</span><span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="nc">Done</span>
</span><span class="line">    <span class="o">|</span><span class="nc">Some</span> <span class="n">buf</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="o">(</span><span class="nc">Final_chunk</span> <span class="n">buf</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I changed it to use <code>read</code> rather than <code>read_exactly</code> (<code>read</code> returns whatever data is available, waiting only if there isn&rsquo;t any at all):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">read</span> <span class="o">~</span><span class="n">remaining</span> <span class="n">ic</span> <span class="o">=</span>
</span><span class="line">  <span class="c">(* TODO functorise string to a bigbuffer *)</span>
</span><span class="line">  <span class="k">match</span> <span class="o">!</span><span class="n">remaining</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span><span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">return</span> <span class="nc">Done</span>
</span><span class="line">  <span class="o">|</span><span class="n">len</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">read</span> <span class="n">ic</span> <span class="n">len</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">buf</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">remaining</span> <span class="o">:=</span> <span class="o">!</span><span class="n">remaining</span> <span class="o">-</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">buf</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">!</span><span class="n">remaining</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">return</span> <span class="o">(</span><span class="nc">Final_chunk</span> <span class="n">buf</span><span class="o">)</span>
</span><span class="line">    <span class="k">else</span> <span class="n">return</span> <span class="o">(</span><span class="nc">Chunk</span> <span class="n">buf</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I also had to change the signature to take a mutable reference (<code>remaining</code>) for the remaining data, otherwise it has no way to know when it&rsquo;s done (<a href="https://github.com/talex5/ocaml-cohttp/commit/030969c32d310d690b8df5929d9a5f32caee6eb5">patch</a>).</p>

<h3>Buffered writes</h3>

<p>With the uploads now split into chunks, upload speed with <code>--unix</code> was 178 KB/s.
Batching up the chunks (which were generally 4 KB each) into a 64 KB buffer increased the speed to 2083 KB/s.
With a 1 MB buffer, I got 6386 KB/s.</p>

<p>Here&rsquo;s the code I used:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">page_buffer</span> <span class="o">=</span> <span class="nn">Io_page</span><span class="p">.</span><span class="n">get</span> <span class="mi">256</span> <span class="o">|&gt;</span> <span class="nn">Io_page</span><span class="p">.</span><span class="n">to_cstruct</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line"><span class="c">(* Set the first byte to N to indicate that we're not done yet.</span>
</span><span class="line"><span class="c"> * If we reboot while this flag is set, the partial upload will</span>
</span><span class="line"><span class="c"> * be deleted. *)</span>
</span><span class="line"><span class="k">let</span> <span class="n">page_buffer_used</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
</span><span class="line"><span class="nn">Cstruct</span><span class="p">.</span><span class="n">set_char</span> <span class="n">page_buffer</span> <span class="mi">0</span> <span class="sc">'N'</span><span class="o">;</span>
</span><span class="line"><span class="k">let</span> <span class="n">file_offset</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">flush_page_buffer</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="nn">Log</span><span class="p">.</span><span class="n">info</span> <span class="s2">&quot;Flushing %d bytes to disk&quot;</span> <span class="o">!</span><span class="n">page_buffer_used</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">  <span class="k">let</span> <span class="n">buffered_data</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">sub</span> <span class="n">page_buffer</span> <span class="mi">0</span> <span class="o">!</span><span class="n">page_buffer_used</span> <span class="k">in</span>
</span><span class="line">  <span class="nn">F</span><span class="p">.</span><span class="n">write</span> <span class="n">q</span><span class="o">.</span><span class="n">fs</span> <span class="n">name</span> <span class="o">!</span><span class="n">file_offset</span> <span class="n">buffered_data</span> <span class="o">&gt;&gt;|=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">  <span class="n">file_offset</span> <span class="o">:=</span> <span class="o">!</span><span class="n">file_offset</span> <span class="o">+</span> <span class="o">!</span><span class="n">page_buffer_used</span><span class="o">;</span>
</span><span class="line">  <span class="n">page_buffer_used</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class="line">  <span class="n">return</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="k">rec</span> <span class="n">add_data</span> <span class="n">src</span> <span class="n">i</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">src_remaining</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">src</span> <span class="o">-</span> <span class="n">i</span> <span class="k">in</span>
</span><span class="line">  <span class="k">if</span> <span class="n">src_remaining</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">return</span> <span class="bp">()</span>
</span><span class="line">  <span class="k">else</span> <span class="o">(</span>
</span><span class="line">    <span class="k">let</span> <span class="n">page_buffer_free</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">len</span> <span class="n">page_buffer</span> <span class="o">-</span> <span class="o">!</span><span class="n">page_buffer_used</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">min</span> <span class="n">page_buffer_free</span> <span class="n">src_remaining</span> <span class="k">in</span>
</span><span class="line">    <span class="nn">Cstruct</span><span class="p">.</span><span class="n">blit_from_string</span> <span class="n">src</span> <span class="n">i</span> <span class="n">page_buffer</span> <span class="o">!</span><span class="n">page_buffer_used</span> <span class="n">chunk_size</span><span class="o">;</span>
</span><span class="line">    <span class="n">page_buffer_used</span> <span class="o">:=</span> <span class="o">!</span><span class="n">page_buffer_used</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="o">;</span>
</span><span class="line">    <span class="n">lwt</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">      <span class="k">if</span> <span class="n">page_buffer_free</span> <span class="o">=</span> <span class="n">chunk_size</span> <span class="k">then</span> <span class="n">flush_page_buffer</span> <span class="bp">()</span>
</span><span class="line">      <span class="k">else</span> <span class="n">return</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">    <span class="n">add_data</span> <span class="n">src</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="o">)</span>
</span><span class="line">  <span class="o">)</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line"><span class="n">data</span> <span class="o">|&gt;</span> <span class="nn">Lwt_stream</span><span class="p">.</span><span class="n">iter_s</span> <span class="o">(</span><span class="k">fun</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">add_data</span> <span class="n">data</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&gt;&gt;=</span>
</span><span class="line"><span class="n">flush_page_buffer</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Asking on the mailing list confirmed that
<a href="http://lists.xenproject.org/archives/html/mirageos-devel/2014-07/msg00054.html">Fat is not well optimised</a>.
This isn&rsquo;t actually a problem for my service, since it&rsquo;s still faster than
my Internet connection, but there&rsquo;s clearly more work needed here.</p>

<h3>Upload speed on Xen</h3>

<p>Testing on my little CubieTruck board, I then got:</p>

<table class="table">
  <tbody>
    <tr>
      <td>Upload speed</td>
      <td>74 KB/s</td>
    </tr>
    <tr>
      <td>Download speed</td>
      <td>1.6 KB/s</td>
    </tr>
  </tbody>
</table>

<p>Hmm. To get a feel for what the board is capable of, I ran <code>nc -l -p 8080 &lt; /dev/zero</code> on the board
and <code>nc cubietruck 8080 | pv &gt; /dev/null</code> on my laptop, getting 29 MB/s.</p>

<p>Still, my unikernel is running as a guest, meaning it has the overhead of using the virtual network
interface (it has to pass the data to dom0, which then sends it over the real interface). So I installed
a Linux guest and tried from there. 47.2 MB/s. Interesting. I have no idea why it&rsquo;s faster than dom0!</p>

<p>I loaded up <a href="http://www.wireshark.org/">Wireshark</a> to see what was happening with the unikernel transfers.
The upload transfer mostly went fast, but stalled in the middle for 15 seconds and then for 12 seconds at the end.
Wireshark showed that the unikernel was ack&rsquo;ing the packets but reducing the TCP window size, indicating that the packets weren&rsquo;t being processed by the application code.
The delays corresponded to the times when we were flushing the data to the SD card, which makes sense.
So, this looks like another filesystem problem (we should be able to write to the SD card much faster than this).</p>

<h3>TCP retransmissions</h3>

<p>For the download, Wireshark showed that many of the packets had incorrect TCP checksums and were having to be retransmitted.
I was already familiar with this bug from a previous mailing list discussion: <a href="http://lists.xenproject.org/archives/html/mirageos-devel/2014-07/msg00131.html">wireshark capture of failed download from mirage-www on ARM</a>.
That turned out be <a href="http://lists.xenproject.org/archives/html/xen-users/2014-07/msg00067.html">a Linux bug</a> - the privileged dom0 code responsible for sending our virtual network packets to the real network becomes confused if two packets occupy the same physical page in memory.</p>

<p>Here&rsquo;s what happens:</p>

<ol>
  <li>We read 1 MB of data from the disk and send it to the HTTP layer as the next chunk.</li>
  <li><a href="https://github.com/mirage/ocaml-cohttp/blob/86394acdb580257ee78cb6976966662575b01bb0/cohttp/transfer_io.ml#L48"><code>Chunked.write</code></a> does the HTTP chunking and sends it to the TCP/IP channel.</li>
  <li><a href="https://github.com/mirage/mirage-tcpip/blob/dedd5e0626a3fc8d679e60e92e5fc327c37759bd/channel/channel.ml#L181"><code>Channel.write_string</code></a> writes the HTTP output into pages (aligned 4K blocks of memory).</li>
  <li><a href="https://github.com/mirage/mirage-tcpip/blob/dedd5e0626a3fc8d679e60e92e5fc327c37759bd/tcp/pcb.ml#L476"><code>Pcb.writefn</code></a> then determines that each page is too big for a TCP packet and splits each one into smaller chunks, sharing the single underlying page:</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line">  <span class="k">let</span> <span class="k">rec</span> <span class="n">writefn</span> <span class="n">pcb</span> <span class="n">wfn</span> <span class="n">data</span> <span class="o">=</span>
</span><span class="line">    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">len</span> <span class="n">data</span> <span class="k">in</span>
</span><span class="line">    <span class="k">match</span> <span class="n">write_available</span> <span class="n">pcb</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">write_wait_for</span> <span class="n">pcb</span> <span class="mi">1</span> <span class="o">&gt;&gt;</span>
</span><span class="line">      <span class="n">writefn</span> <span class="n">pcb</span> <span class="n">wfn</span> <span class="n">data</span>
</span><span class="line">    <span class="o">|</span> <span class="n">av_len</span> <span class="k">when</span> <span class="n">av_len</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">let</span> <span class="n">first_bit</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">sub</span> <span class="n">data</span> <span class="mi">0</span> <span class="n">av_len</span> <span class="k">in</span>
</span><span class="line">      <span class="k">let</span> <span class="n">remaing_bit</span> <span class="o">=</span> <span class="nn">Cstruct</span><span class="p">.</span><span class="n">sub</span> <span class="n">data</span> <span class="n">av_len</span> <span class="o">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">av_len</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">      <span class="n">writefn</span> <span class="n">pcb</span> <span class="n">wfn</span> <span class="n">first_bit</span>  <span class="o">&gt;&gt;</span>
</span><span class="line">      <span class="n">writefn</span> <span class="n">pcb</span> <span class="n">wfn</span> <span class="n">remaing_bit</span>
</span><span class="line">    <span class="o">|</span> <span class="n">av_len</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">wfn</span> <span class="o">[</span><span class="n">data</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>My original fix changed <code>mirage-net-xen</code> to wait until the first buffer had been read before sending the second one.
That fixed the retransmissions, but all the waiting meant I still only got 56 KB/s.
Instead, I changed <code>writefn</code> to copy <code>remaining_bit</code> into a new IO page, and with that I got 495 KB/s.</p>

<p>Replacing the filesystem read with a simple <code>String.create</code> of the same length, I got 3.9 MB/s, showing that once again the
FAT filesystem was now the limiting factor.</p>

<h3>Adding a block cache</h3>

<p>I tried adding a <a href="https://github.com/0install/0repo-queue/blob/fat-caching/block_cache.ml">block cache</a> layer between <code>mirage-block-xen</code> and <code>fat-filesystem</code>, like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">Main</span> <span class="o">(</span><span class="nc">C</span> <span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">CONSOLE</span><span class="o">)</span>
</span><span class="line">            <span class="o">(</span><span class="nc">B</span> <span class="o">:</span> <span class="nn">V1_LWT</span><span class="p">.</span><span class="nc">BLOCK</span><span class="o">)</span>
</span><span class="line">	    <span class="o">(</span><span class="nc">H</span> <span class="o">:</span> <span class="nn">Cohttp_lwt</span><span class="p">.</span><span class="nc">Server</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">BC</span> <span class="o">=</span> <span class="nn">Block_cache</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">B</span><span class="o">)</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">F</span> <span class="o">=</span> <span class="nn">Fat</span><span class="p">.</span><span class="nn">Fs</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">BC</span><span class="o">)(</span><span class="nc">Io_page</span><span class="o">)</span>
</span><span class="line">  <span class="k">module</span> <span class="nc">Q</span> <span class="o">=</span> <span class="nn">Upload_queue</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">F</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">mem_cache_size</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>	<span class="c">(* 1 MB *)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">start</span> <span class="n">c</span> <span class="n">b</span> <span class="n">http</span> <span class="o">=</span>
</span><span class="line">    <span class="nn">Log</span><span class="p">.</span><span class="n">write</span> <span class="o">:=</span> <span class="nn">C</span><span class="p">.</span><span class="n">log_s</span> <span class="n">c</span><span class="o">;</span>
</span><span class="line">    <span class="nn">Log</span><span class="p">.</span><span class="n">info</span> <span class="s2">&quot;start in queue service&quot;</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="nn">BC</span><span class="p">.</span><span class="n">connect</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">mem_cache_size</span><span class="o">)</span> <span class="o">&gt;&gt;=</span> <span class="k">function</span>
</span><span class="line">    <span class="o">|</span> <span class="o">`</span><span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;BC.connect&quot;</span>
</span><span class="line">    <span class="o">|</span> <span class="o">`</span><span class="nc">Ok</span> <span class="n">bc</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">F</span><span class="p">.</span><span class="n">connect</span> <span class="n">bc</span> <span class="o">&gt;&gt;=</span> <span class="k">function</span>
</span><span class="line">    <span class="o">|</span> <span class="o">`</span><span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;F.connect&quot;</span>
</span><span class="line">    <span class="o">|</span> <span class="o">`</span><span class="nc">Ok</span> <span class="n">fs</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="nn">Q</span><span class="p">.</span><span class="n">create</span> <span class="n">fs</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">q</span> <span class="o">-&gt;</span>
</span><span class="line"><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this in place, upload speed remains at 76 KB/s, but the download speed increases to 1 MB/s (for a 20 MB file, which therefore doesn&rsquo;t fit in the cache).
This suggests that the FAT filesystem is reading the same disk sectors many times.
Enlarging the memory cache to cover the whole file, the download speed only increases to 1.3 MB/s,
so the FAT code must be doing some inefficient calculations too.</p>

<h3>Replacing FAT</h3>

<p>Since most of my problems seemed to be coming from using FAT, I decided to try a new approach.
I removed all the FAT code and the block cache and changed <code>upload_queue.ml</code> to write directly to the block
device.
With that (no caching), I get:</p>

<table class="table">
  <tbody>
    <tr>
      <td>Upload speed</td>
      <td>2.27 MB/s</td>
    </tr>
    <tr>
      <td>Download speed</td>
      <td>2.46 MB/s</td>
    </tr>
  </tbody>
</table>

<p>That&rsquo;s not too bad. It&rsquo;s faster than my Internet connection, which means that the unikernel is no longer the limiting factor.</p>

<p>Here&rsquo;s the new version: <a href="https://github.com/0install/0repo-queue/blob/master/upload_queue.ml"><code>upload_queue.ml</code></a>.
The big simplification comes from knowing that the queue will spend most of its time empty (another good reason to use a small VM for it).
The code has a <code>next_free_sector</code> which it advances every time an upload starts.
When the queue becomes empty and there are no uploads in progress this variable is reset back to sector 1 (sector 0 holds the index).
This does mean that we may report disk full errors to uploaders even when there is free space on the disk, but this won&rsquo;t happen in typical usage because the repository downloads things as soon as they&rsquo;re uploaded (if it does happen, it just means uploaders have to wait a couple of minutes until the repository empties the queue).</p>

<p>Managing the block device manually brought a few more advantages over FAT:</p>

<ol>
  <li>No need to generate random file names for the uploads.</li>
  <li>No need to delete incomplete uploads (we only write the file&rsquo;s index entry to disk on success).</li>
  <li>The system should recover automatically from filesystem corruption because invalid entries can be detected reliably at boot time and discarded.</li>
  <li>Disk full errors are reported correctly.</li>
  <li>The queue ordering isn&rsquo;t lost on reboot.</li>
</ol>

<h2>Conclusions</h2>

<p>Modern operating systems are often extremely complex, but much of this is historical baggage which isn&rsquo;t needed on a modern system where you&rsquo;re running a single application as a VM under a hypervisor. Mirage allows you to create very small VMs which contain almost no C code. These VMs should be easier to write, more reliable and more secure.</p>

<p>Creating a bootable OCaml kernel is surprisingly easy, and from there adding support for extra devices is just a matter of pulling in the appropriate libraries. By programming against generic interfaces, you can create code that runs under Linux/Unix/OS X or as a virtual machine under Xen, and switch between configurations using the <code>mirage</code> tool.</p>

<p>Mirage is still very young, and I found many rough edges while writing my queuing service for 0install:</p>

<ul>
  <li>While Linux provides fast, reliable filesystems as standard, Mirage currently only provides a basic FAT implementation.</li>
  <li>Linux provides caching as standard, while you have to implement this yourself on Mirage.</li>
  <li>Error reporting should be a big improvement over C&rsquo;s error codes, but getting friendly error messages from Mirage is currently difficult.</li>
  <li>The system has clearly been designed for high performance (the APIs generally write to user-provided buffers to avoid copying, much like C libraries do), but many areas have not yet been optimised.</li>
  <li>Buffers often have extra requirements (e.g. must be page-aligned, a single page, immutable, etc) which are not currently captured in the type system, and this can lead to run-time errors which would ideally have been detected at compile time.</li>
</ul>

<p>However, there is <a href="http://openmirage.org/blog/announcing-mirage-20-release">a huge amount of work</a> happening on Mirage right now and it looks like all of these problems are being worked on.
If you&rsquo;re interested in low-level OS programming and don&rsquo;t want to mess about with C, Mirage is a lot of fun, and it can be useful for practical tasks already with a bit of effort.</p>

<p>There are still many areas I need to find out more about.
In particular, using the new <a href="http://openmirage.org/blog/introducing-ocaml-tls">pure-OCaml TLS stack</a> to secure the system and trying the <a href="http://openmirage.org/blog/introducing-irmin">Irmin Git-like distributed, branchable storage</a> to provide the queue instead of writing it myself.
I hope to try those soon&hellip;</p>
<a onclick="switchContent('ocamlorg-post22','ocamlorg-post21')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2014/07/28/my-first-unikernel/">by Thomas Leonard at Jul 28, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://hh360.user.srcf.net/blog/?p=493">
    <a name="#http://hh360.user.srcf.net/blog/?p=493"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/heidi.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://hh360.user.srcf.net/blog/?p=493">Release of  “ARC: Analysis of Raft Consensus”</a>
      (<a href="http://hh360.user.srcf.net/blog/category/pl/ocaml/feed/" title="Read, Write & Execute » OCaml">Heidi Howard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <p><span style="color: #555555;">&nbsp;&ldquo;ARC: Analysis of Raft Consensus&rdquo;&nbsp;is now available online as a UCAM technical report.&nbsp;</span><br/>
<a href="http://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-857.pdf">http://www.cl.cam.ac.uk/techreports/UCAM-CL-TR-857.pdf</a></p>
<h2 style="color: #333333;">Abstract</h2>
<p style="color: #333333;">The Paxos algorithm, despite being synonymous with distributed consensus for a decade, is famously difficult to reason about and implement due to its non-intuitive approach and underspecification. In response, this project implemented and evaluated a framework for constructing fault-tolerant applications, utilising the recently proposed Raft algorithm for distributed consensus. Constructing a simulation framework for our implementation enabled us to evaluate the protocol on everything from understandability and efficiency to correctness and performance in diverse network environments. We propose a range of optimisations to the protocol and released to the community a testbed for developing further optimisations and investigating optimal protocol parameters for real-world deployments.</p>
<p>Thank you everyone for your feedback.</p>

        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://hh360.user.srcf.net/blog/?p=493">by Heidi Howard at Jul 25, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://ocamllabs.github.com/compiler-hacking/2014/07/24/compiler-hacking-at-citrix">
    <a name="#http://ocamllabs.github.com/compiler-hacking/2014/07/24/compiler-hacking-at-citrix"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../images/hax0ring.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://ocamllabs.github.com/compiler-hacking/2014/07/24/compiler-hacking-at-citrix">Seventh OCaml compiler hacking session (at Citrix)</a>
      (<a href="http://ocamllabs.github.io/compiler-hacking/rss.xml" title="OCaml Labs compiler hacking">Compiler Hacking</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post23"><p>For the seventh Cambridge OCaml compiler-hacking session we'll be meeting at <a href="https://maps.google.co.uk/maps?q=101%20Cambridge%20Science%20Park%20Milton%20Road,%20Cambridge&amp;hl=en&amp;ll=52.232955,0.150338&amp;spn=0.003082,0.006947&amp;sll=52.231717,0.144648&amp;sspn=0.012327,0.027788&amp;oq=101Cambrideg%20Science&amp;t=h&amp;hq=101%20Cambridge%20Science%20Park%20Milton%20Road,&amp;hnear=Cambridge,%20United%20Kingdom&amp;z=18">the Citrix office in the Cambridge Science Park</a> on 6.30pm Friday 1st August.  Thanks to Citrix for supporting and hosting the session!</p>

<p>We'll kick off with a demo from <a href="https://github.com/def-lkb">Fr&eacute;d&eacute;ric Bour</a> of modular implicits, an OCaml extension that adds support for overloading.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/46f2bnk4xny724in"><strong>indicate interest via Doodle</strong></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking">sign up to the mailing list</a> to receive updates:</p>

<p><strong>Where</strong>:
  Citrix Systems Research &amp; Development Ltd.<br/>
  <a href="https://maps.google.co.uk/maps?q=101%20Cambridge%20Science%20Park%20Milton%20Road,%20Cambridge&amp;hl=en&amp;ll=52.232955,0.150338&amp;spn=0.003082,0.006947&amp;sll=52.231717,0.144648&amp;sspn=0.012327,0.027788&amp;oq=101Cambrideg%20Science&amp;t=h&amp;hq=101%20Cambridge%20Science%20Park%20Milton%20Road,&amp;hnear=Cambridge,%20United%20Kingdom&amp;z=18">Building 101</a><br/>
  Cambridge Science Park<br/>
  Milton Road<br/>
  Cambridge, CB4 0FY<br/>
  United Kingdom  </p>

<p><strong>When</strong>: 6.30pm, Friday 1st August</p>

<p><strong>Who</strong>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><strong>What</strong>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><strong>Wiki</strong>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; prett&hellip;</p><a onclick="switchContent('ocamlorg-post23','ocamlorg-post24')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/07/24/compiler-hacking-at-citrix">Read more...</a></div><div id="ocamlorg-post24" style="display: none"><p>For the seventh Cambridge OCaml compiler-hacking session we'll be meeting at <a href="https://maps.google.co.uk/maps?q=101%20Cambridge%20Science%20Park%20Milton%20Road,%20Cambridge&amp;hl=en&amp;ll=52.232955,0.150338&amp;spn=0.003082,0.006947&amp;sll=52.231717,0.144648&amp;sspn=0.012327,0.027788&amp;oq=101Cambrideg%20Science&amp;t=h&amp;hq=101%20Cambridge%20Science%20Park%20Milton%20Road,&amp;hnear=Cambridge,%20United%20Kingdom&amp;z=18">the Citrix office in the Cambridge Science Park</a> on 6.30pm Friday 1st August.  Thanks to Citrix for supporting and hosting the session!</p>

<p>We'll kick off with a demo from <a href="https://github.com/def-lkb">Fr&eacute;d&eacute;ric Bour</a> of modular implicits, an OCaml extension that adds support for overloading.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/46f2bnk4xny724in"><strong>indicate interest via Doodle</strong></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking">sign up to the mailing list</a> to receive updates:</p>

<p><strong>Where</strong>:
  Citrix Systems Research &amp; Development Ltd.<br/>
  <a href="https://maps.google.co.uk/maps?q=101%20Cambridge%20Science%20Park%20Milton%20Road,%20Cambridge&amp;hl=en&amp;ll=52.232955,0.150338&amp;spn=0.003082,0.006947&amp;sll=52.231717,0.144648&amp;sspn=0.012327,0.027788&amp;oq=101Cambrideg%20Science&amp;t=h&amp;hq=101%20Cambridge%20Science%20Park%20Milton%20Road,&amp;hnear=Cambridge,%20United%20Kingdom&amp;z=18">Building 101</a><br/>
  Cambridge Science Park<br/>
  Milton Road<br/>
  Cambridge, CB4 0FY<br/>
  United Kingdom  </p>

<p><strong>When</strong>: 6.30pm, Friday 1st August</p>

<p><strong>Who</strong>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><strong>What</strong>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><strong>Wiki</strong>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-projects</a> for various levels of experience (see also some <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-previously-worked-on">things we've worked on in previous sessions</a>), but feel free to come along and work on whatever you fancy.</p>

<p>We'll also be ordering pizza, so if you want to be counted for food you should aim to arrive by 6.45pm.</p>
<a onclick="switchContent('ocamlorg-post24','ocamlorg-post23')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/07/24/compiler-hacking-at-citrix">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://ocamllabs.github.com/compiler-hacking/2014/07/24/compiler-hacking-at-citrix">by Compiler Hacking at Jul 24, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/announcing-mirage-20-release">
    <a name="#http://openmirage.org/blog/announcing-mirage-20-release"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/announcing-mirage-20-release">Mirage v2.0: a recap of the new features</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post25">
      <p><small>
 This work funded in part by the EU FP7 User-Centric Networking project, Grant
 No. 611001.
</small></p>
<p>The <a href="http://openmirage.org/blog/announcing-mirage10">first release</a> of Mirage back in December 2013 introduced the prototype
of the <a href="http://queue.acm.org/detail.cfm?id=2566628">unikernel concept</a>, which realised the promise of a safe,
flexible mechanism to build highly optimized software stacks purpose-built for deployment in the public cloud (more <a href="http://openmirage.org/wiki/overview-of-mirage">background</a> on this).
Since then, we've been hard at work using and extending Mirage for real projects and the community has been
<a href="http://openmirage.org/blog/welcome-to-our-summer-hackers">steadily growing</a>.</p>
<p>We're thrilled to announce the release of Mirage OS v2.0 today!  Over the past
few weeks the <a href="http://openmirage.org/community">team</a> has been <a href="https://github.com/mirage/mirage/issues/257">hard at work</a> blogging about all
the new features in this latest release, coordinated by the tireless <a href="http://amirchaudhry.com">Amir Chaudhry</a>:</p>
<p><img src="http://openmirage.org/graphics/cubieboard2.jpg" width="250px" style="float:right; padding: 5px"/></p>
<ul><li><strong>ARM device support</strong>: While the first version of Mirage was specialised towards conventional x86 clouds, the code generation and boot libraries have now been made portable enough to operate on low-power embedded ARM devices such as the <a href="http://cubieboard.org/">Cubieboard 2</a>.  This is a key part of ou&hellip;</li></ul><a onclick="switchContent('ocamlorg-post25','ocamlorg-post26')" class="btn planet-toggle" href="#http://openmirage.org/blog/announcing-mirage-20-release">Read more...</a></div><div id="ocamlorg-post26" style="display: none">
      <p><small>
 This work funded in part by the EU FP7 User-Centric Networking project, Grant
 No. 611001.
</small></p>
<p>The <a href="http://openmirage.org/blog/announcing-mirage10">first release</a> of Mirage back in December 2013 introduced the prototype
of the <a href="http://queue.acm.org/detail.cfm?id=2566628">unikernel concept</a>, which realised the promise of a safe,
flexible mechanism to build highly optimized software stacks purpose-built for deployment in the public cloud (more <a href="http://openmirage.org/wiki/overview-of-mirage">background</a> on this).
Since then, we've been hard at work using and extending Mirage for real projects and the community has been
<a href="http://openmirage.org/blog/welcome-to-our-summer-hackers">steadily growing</a>.</p>
<p>We're thrilled to announce the release of Mirage OS v2.0 today!  Over the past
few weeks the <a href="http://openmirage.org/community">team</a> has been <a href="https://github.com/mirage/mirage/issues/257">hard at work</a> blogging about all
the new features in this latest release, coordinated by the tireless <a href="http://amirchaudhry.com">Amir Chaudhry</a>:</p>
<p><img src="http://openmirage.org/graphics/cubieboard2.jpg" width="250px" style="float:right; padding: 5px"/></p>
<ul><li><strong>ARM device support</strong>: While the first version of Mirage was specialised towards conventional x86 clouds, the code generation and boot libraries have now been made portable enough to operate on low-power embedded ARM devices such as the <a href="http://cubieboard.org/">Cubieboard 2</a>.  This is a key part of our efforts to build a safe, unified <a href="http://anil.recoil.org/papers/2010-bcs-visions.pdf">mutiscale programming model</a> for both cloud and mobile workloads as part of the <a href="http://nymote.org">Nymote</a> project.  We also upstreamed the changes required to the Xen Project so that other unikernel efforts such as <a href="https://github.com/GaloisInc/HaLVM">HalVM</a> or <a href="https://www.usenix.org/system/files/conference/nsdi14/nsdi14-paper-martins.pdf">ClickOS</a> can benefit.<ul><li><em>&quot;<a href="http://openmirage.org/blog/introducing-xen-minios-arm">Introducing an ARMy of unikernels</a>&quot;</em> by <a href="http://roscidus.com/blog/">Thomas Leonard</a> talks about the changes required and <a href="http://openmirage.org/wiki/xen-on-cubieboard2">instructions</a> for trying this out for yourself on your own cheap Cubieboard.</li></ul></li><li><strong>Irmin distributed, branchable storage</strong>: Unikernels usually execute in a distributed, disconnection-prone environment (particularly with the new mobile ARM support).  We therefore built the <a href="https://github.com/mirage/irmin">Irmin</a> library to explicitly make synchronization easier via a Git-like persistence model that can be used to build and easily trace the operation of distributed applications across all of these diverse environments.<ul><li><em>&quot;<a href="http://openmirage.org/blog/introducing-irmin">Introducing Irmin: Git-like distributed, branchable storage</a>&quot;</em> by <a href="http://gazagnaire.org">Thomas Gazagnaire</a> describes the concepts and high-level architecture of the system.</li><li><em>&quot;<a href="http://openmirage.org/blog/introducing-irmin-in-xenstore">Using Irmin to add fault-tolerance to the Xenstore database</a>&quot;</em> by <a href="http://dave.recoil.org">Dave Scott</a> shows how Irmin is used in a real-world application: the security-critical Xen toolstack that manages hosts full of virtual machines (<a href="https://www.youtube.com/watch?v=DSzvFwIVm5s">video</a>).</li></ul></li><li><strong>OCaml TLS</strong>: The philosophy of Mirage is to construct the entire operating system in a safe programming style, from the device drivers up.  This continues in this release with a comprehensive OCaml implementation of <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Level Security</a>, the most widely deployed end-to-end encryption protocol on the Internet (and one that is very prone to <a href="https://en.wikipedia.org/wiki/Heartbleed">bad security holes</a>).  The blog series is written by <a href="https://github.com/hannesm">Hannes Mehnert</a> and <a href="https://github.com/pqwy">David Kaloper</a>.<ul><li><em>&quot;<a href="http://openmirage.org/blog/introducing-ocaml-tls">OCaml-TLS: Introducing transport layer security (TLS) in pure OCaml</a>&quot;</em> presents the motivation and architecture behind our clean-slate implementation of the protocol.</li><li><em>&quot;<a href="http://openmirage.org/blog/introducing-nocrypto">OCaml-TLS: building the nocrypto library core</a>&quot;</em> talks about the cryptographic primitives that form the heart of TLS confidentiality guarantees, and how they expose safe interfaces to the rest of the stack.</li><li><em>&quot;<a href="http://openmirage.org/blog/introducing-x509">OCaml-TLS: adventures in X.509 certificate parsing and validation</a>&quot;</em> explains how authentication and chain-of-trust verification is implemented in our stack.</li><li><em>&quot;<a href="http://openmirage.org/blog/introducing-asn1">OCaml-TLS: ASN.1 and notation embedding</a>&quot;</em> introduces the libraries needed for handling ASN.1 grammars, the wire representation of messages in TLS.</li><li><em>&quot;<a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">OCaml-TLS: the protocol implementation and mitigations to known attacks</a>&quot;</em> concludes with the implementation of the core TLS protocol logic itself.</li></ul></li><li><strong>Modularity and communication</strong>: Mirage is built on the concept of a <a href="http://anil.recoil.org/papers/2013-asplos-mirage.pdf">library operating system</a>, and this release provides many new libraries to flexibly extend applications with new functionality.<ul><li><em>&quot;<a href="http://openmirage.org/blog/intro-tcpip">Fitting the modular Mirage TCP/IP stack together</a>&quot;</em> by <a href="http://somerandomidiot.com">Mindy Preston</a> explains the rather unique modular architecture of our TCP/IP stack that lets you swap between the conventional Unix sockets API, or a complete implementation of TCP/IP in pure OCaml.</li><li><em>&quot;<a href="http://openmirage.org/blog/update-on-vchan">Vchan: low-latency inter-VM communication channels</a>&quot;</em> by <a href="http://jon.recoil.org">Jon Ludlam</a> shows how unikernels can communicate efficiently with each other to form distributed clusters on a multicore Xen host, by establishing shared memory rings with each other.</li><li><em>&quot;<a href="http://openmirage.org/blog/modular-foreign-function-bindings">Modular foreign function bindings</a>&quot;</em> by <a href="https://github.com/yallop">Jeremy Yallop</a> continues the march towards abstraction by expaining how to interface safely with code written in C, without having to write any unsafe C bindings!  This forms the basis for allowing Xen unikernels to communicate with existing libraries that they may want to keep at arm's length for security reasons.</li></ul></li></ul>

<p>All the libraries required for these new features are <a href="http://openmirage.org/releases">regularly
released</a> into the <a href="http://opam.ocaml.org">OPAM</a> package manager, so
just follow the <a href="http://openmirage.org/wiki/install">installation instructions</a> to give them a spin.
A release this size probably introduces minor hiccups that may cause build
failures, so we very much encourage <a href="https://github.com/mirage/mirage/issues">bug
reports</a> on our issue tracker or
<a href="http://openmirage.org/community">questions</a> to our mailing lists.  Don't be shy: no question is too
basic, and we'd love to hear of any weird and wacky uses you put this new
release to!  And finally, the lifeblood of Mirage is about sharing and
<a href="http://opam.ocaml.org/doc/Packaging.html">publishing libraries</a> that add new functionality to the framework, so do get
involved and open-source your own efforts.</p>
<p><em>Breaking news</em>: <a href="http://mort.io">Richard Mortier</a> and I will be speaking at <a href="http://www.oscon.com">OSCON</a> this week on Thursday morning about the new features <a href="http://www.oscon.com/oscon2014/public/schedule/detail/35024">in F150 in the Cloud Track</a>. Come along if you are in rainy Portland at the moment!</p>

   <a onclick="switchContent('ocamlorg-post26','ocamlorg-post25')" class="btn planet-toggle" href="#http://openmirage.org/blog/announcing-mirage-20-release">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/announcing-mirage-20-release">by Anil Madhavapeddy at Jul 22, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/introducing-xen-minios-arm">
    <a name="#http://openmirage.org/blog/introducing-xen-minios-arm"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/introducing-xen-minios-arm">Building an ARMy of Xen unikernels</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post27">
      <p>Mirage has just gained the ability to compile unikernels for the Xen/arm32
platform, allowing Mirage guests to run under the Xen hypervisor on ARM
devices such as the <a href="http://cubietruck.com/collections/frontpage/products/cubieboard2-allwinner-a20-arm-cortex-a7-dual-core-development-board">Cubieboard 2</a> and <a href="http://cubietruck.com/collections/frontpage/products/cubietruck-cubieboard3-cortex-a7-dual-core-2gb-ram-8gb-flash-with-wifi-bt">CubieTruck</a>.</p>
<h3>Introduction</h3>

<p>The ARMv7 architecture introduced the (optional) Virtualization Extensions,
providing hardware support for running virtual machines on ARM devices, and
Xen's <a href="http://www.xenproject.org/developers/teams/arm-hypervisor.html">ARM Hypervisor</a> uses this to support hardware accelerated
ARM guests.</p>
<p><a href="http://wiki.xen.org/wiki/Mini-OS">Mini-OS</a> is a tiny OS kernel designed specifically for running under Xen.
It provides code to initialise the CPU, display messages on the console,
allocate memory (malloc), and not much else. It is used as the low-level
core of Mirage's Xen implementation.</p>
<p>Mirage v1 was built on an old version of Mini-OS which didn't support ARM.
For Mirage v2, we have added ARM support to the current Mini-OS (completing
Karim Allah Ahmed's <a href="http://lists.xen.org/archives/html/xen-devel/2014-01/msg00249.html">initial ARM port</a>) and made Mirage depend
on it as an external library.
This means that Mirage will automatically gain support for&hellip;</p><a onclick="switchContent('ocamlorg-post27','ocamlorg-post28')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-xen-minios-arm">Read more...</a></div><div id="ocamlorg-post28" style="display: none">
      <p>Mirage has just gained the ability to compile unikernels for the Xen/arm32
platform, allowing Mirage guests to run under the Xen hypervisor on ARM
devices such as the <a href="http://cubietruck.com/collections/frontpage/products/cubieboard2-allwinner-a20-arm-cortex-a7-dual-core-development-board">Cubieboard 2</a> and <a href="http://cubietruck.com/collections/frontpage/products/cubietruck-cubieboard3-cortex-a7-dual-core-2gb-ram-8gb-flash-with-wifi-bt">CubieTruck</a>.</p>
<h3>Introduction</h3>

<p>The ARMv7 architecture introduced the (optional) Virtualization Extensions,
providing hardware support for running virtual machines on ARM devices, and
Xen's <a href="http://www.xenproject.org/developers/teams/arm-hypervisor.html">ARM Hypervisor</a> uses this to support hardware accelerated
ARM guests.</p>
<p><a href="http://wiki.xen.org/wiki/Mini-OS">Mini-OS</a> is a tiny OS kernel designed specifically for running under Xen.
It provides code to initialise the CPU, display messages on the console,
allocate memory (malloc), and not much else. It is used as the low-level
core of Mirage's Xen implementation.</p>
<p>Mirage v1 was built on an old version of Mini-OS which didn't support ARM.
For Mirage v2, we have added ARM support to the current Mini-OS (completing
Karim Allah Ahmed's <a href="http://lists.xen.org/archives/html/xen-devel/2014-01/msg00249.html">initial ARM port</a>) and made Mirage depend
on it as an external library.
This means that Mirage will automatically gain support for other
architectures that get added later.
We are currently working with the Xen developers to get
<a href="https://github.com/talex5/xen">our Mini-OS fork</a> upstreamed.</p>
<p>In a similar way, we have replaced Mirage v1's bundled maths library with a
dependency on the external
<a href="https://github.com/JuliaLang/openlibm">OpenLibm</a>, which we also extended
with ARM support (this was just a case of fixing the build system; the code
is from FreeBSD's libm, which already supported ARM).</p>
<p>Mirage v1 also bundled <a href="http://www.fefe.de/dietlibc/">dietlibc</a> to provide its standard C library.
A nice side-effect of this work came when we were trying to separate out the
dietlibc headers from the old Mini-OS headers in Mirage.
These had rather grown together over time and the work was proving
difficult, until we discovered that we no longer needed a libc at all, as
almost everything that used it had been replaced with pure OCaml versions!
The only exception was the <code>printf</code> code for formatting floating point
numbers, which OCaml uses in its <code>printf</code> implementation.
We replaced that by taking the small <code>fmt_fp</code> function from
<a href="http://www.musl-libc.org/">musl libc</a>.</p>
<p>Here's the final diffstat of the changes to <a href="https://github.com/mirage/mirage-platform">mirage-platform</a>
adding ARM support:</p>
<pre><code>778 files changed, 1949 insertions(+), 59689 deletions(-)</code></pre>

<h3>Trying it out</h3>

<p>You'll need an ARM device with the Virtualization Extensions.
I've been testing using the Cubieboard 2 (and CubieTruck):</p>
<p><img src="http://openmirage.org/graphics/cubieboard2.jpg" alt="Cubieboard2"/></p>
<p>The first step is to install Xen.
<a href="http://openmirage.org/wiki/xen-on-cubieboard2">Running Xen on the Cubieboard2</a>
documents the manual installation process, but you can now also use
<a href="https://github.com/mirage/xen-arm-builder">mirage/xen-arm-builder</a> to build
an SDcard image automatically.
Copy the image to the SDcard, connect the network cable and power, and the
board will boot Xen.</p>
<p>Once booted you can ssh to Dom0, the privileged Linux domain used to manage
the system, <a href="http://openmirage.org/wiki/install">install Mirage</a>, and build your unikernel just
as on x86.
Currently, you need to select the Git versions of some components.
The following commands will install the necessary versions if you're using
the xen-arm-builder image:</p>
<pre class="bash"><code class="bash">$ opam init
$ opam install mirage-xen-minios
$ opam remote add mirage-dev git://github.com/mirage/mirage-dev
$ opam install mirage</code></pre>

<h3>Technical details</h3>

<p>One of the pleasures of unikernels is that you can comprehend the whole
system with relatively little effort, and
those wishing to understand, debug or contribute to the ARM support may find
the following technical sections interesting.
However, you don't need to know the details of the ARM port to use it,
as Mirage abstracts away the details of the underlying platform.</p>
<h4>The boot process</h4>

<p>An ARM Mirage unikernel uses the <a href="http://www.simtec.co.uk/products/SWLINUX/files/booting_article.html">Linux zImage format</a>, though it is
not actually compressed. Xen will allocate some RAM for the image and load
the kernel at the offset 0x8000 (32 KB).</p>
<p>Execution begins in <a href="https://github.com/talex5/xen/blob/cde4b7e14b0aeedcdc006b0622905b7af2665c77/extras/mini-os/arch/arm/arm32.S#L8">arm32.S</a>, with the <code>r2</code> register pointing to a
<a href="http://www.devicetree.org">Flattened Device Tree (FDT)</a> describing details of the virtual system.
This assembler code performs a few basic boot tasks:</p>
<ol><li>Configuring the MMU, which maps virtual addresses to physical addresses (see next section).</li><li>Turning on caching and branch prediction.</li><li>Setting up the exception vector table (this says how to handle interrupts and deal with various faults, such as reading from an invalid address).</li><li>Setting up the stack pointer and calling the C function <code>arch_init</code>.</li></ol>

<p><a href="https://github.com/talex5/xen/blob/cde4b7e14b0aeedcdc006b0622905b7af2665c77/extras/mini-os/arch/arm/setup.c#L74">arch_init</a> makes some calls to the hypervisor to set up support for the console and interrupt controller, and then calls <code>start_kernel</code>.</p>
<p><a href="https://github.com/mirage/mirage-platform/blob/b0a027d4486230ce6e1e8fd0e7354b17e9c388f5/xen/runtime/xencaml/main.c#L57">start_kernel</a> (in libxencaml) sets up a few more features (events, malloc, time-keeping and <a href="http://wiki.xen.org/wiki/Grant_Table">grant tables</a>), then calls <code>caml_startup</code>.</p>
<p><a href="https://github.com/mirage/mirage-platform/blob/b0a027d4486230ce6e1e8fd0e7354b17e9c388f5/xen/runtime/ocaml/startup.c#L202">caml_startup</a> (in libocaml) initialises the garbage collector and calls <code>caml_program</code>, which is your application's <code>main.ml</code>.</p>
<h4>The address space</h4>

<p>With the Virtualization Extensions, there are two stages to converting a
virtual memory address (used by application code) to a physical address in
RAM.
The first stage is under the control of the guest VM, mapping the virtual
address to what the guest believes is the physical address (this address is
referred to as the <em>Intermediate Physical Address</em> or <em>IPA</em>).
The second stage, under the control of Xen, maps the IPA to the real
physical address.
The tables holding these mappings are called <em>translation tables</em>.</p>
<p>Mirage's memory needs are simple: most of the RAM should be used for the
garbage-collected OCaml heap, with a few pages used for interacting with Xen
(these don't go on the OCaml heap because they must be page aligned and must
not move around).</p>
<p>Xen does not commit to using a fixed address as the IPA of the RAM, but the
C code needs to run from a known location. To solve this problem the
assembler code in <code>arm32.S</code> detects where it is running from and sets up a
virtual-to-physical mapping that will make it appear at the expected
location, by adding a fixed offset to each virtual address.
For example, on Xen/unstable, we configure the beginning of the virtual
address space to look like this (on Xen 4.4, the physical addresses would
start at 80000000 instead):</p>
<table>
  <tr><th>Virtual address</th><th>Physical address (IPA)</th><th>Purpose</th></tr>
  <tr><td>400000</td><td>40000000</td><td>Stack (16 KB)</td></tr>
  <tr><td>404000</td><td>40004000</td><td>Translation tables (16 KB)</td></tr>
  <tr><td>408000</td><td>40008000</td><td>Kernel image</td></tr>
</table>

<p>The physical address is always at a fixed offset from the virtual address and
the addresses wrap around, so virtual address c0400000 maps back to physical
address 0 (in this example).</p>
<p>The stack, which grows downwards, is placed at the start of RAM so that a
stack overflow will trigger a fault rather than overwriting other data.</p>
<p>The 16 KB translation table is an array of 4-byte entries each mapping 1 MB
of the virtual address space, so the 16 KB table is able to map the entire
32-bit address space (4 GB). Each entry can either give the physical section
address directly (which is what we do) or point to a second-level table
mapping individual 4 KB pages. By using only the top-level table we reduce
possible delays due to <a href="http://en.wikipedia.org/wiki/Translation_lookaside_buffer">TLB misses</a>.</p>
<p>After the kernel code comes the data (constants and global variables), then
the <a href="http://en.wikipedia.org/wiki/.bss">bss</a> section (data that is initially
zero, and therefore doesn't need to be stored in the kernel image),
and finally the rest of the RAM, which is handed over to the malloc system.</p>
<h3>Contact</h3>

<p>The current version seems to be working well on Xen 4.4 (stable) and the 4.5
development version, but has only been lightly tested.
If you have any problems or questions, or get it working on other devices,
please <a href="http://openmirage.org/community/">let us know</a>!</p>

   <a onclick="switchContent('ocamlorg-post28','ocamlorg-post27')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-xen-minios-arm">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/introducing-xen-minios-arm">by Thomas Leonard at Jul 22, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/introducing-irmin-in-xenstore">
    <a name="#http://openmirage.org/blog/introducing-irmin-in-xenstore"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/introducing-irmin-in-xenstore">Using Irmin to add fault-tolerance to the Xenstore database</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post29">
      <p><em>This is the second in a series of posts that introduces the <a href="https://github.com/mirage/irmin">Irmin</a> distributed storage engine.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-irmin">introductory post</a>.</em></p>
<p><a href="http://wiki.xen.org/wiki/XenStore">Xenstore</a> is a critical service found on all hosts
running <a href="http://www.xen.org/">Xen</a>. Xenstore is necessary to</p>
<ul><li>configure all VM I/O devices such as disk controllers and network interface cards;</li><li>share performance statistics and OS version information; and</li><li>signal VMs during shutdown, suspend, resume, migrate etc.</li></ul>

<p>Xenstore must be <strong>reliable</strong>: if it fails then the host is unmanageable and must be rebooted.</p>
<p>Xenstore must be <strong>secure</strong>: if it is compromised by a VM then that VM can access data belonging
to other VMs.</p>
<p>The current version of Xenstore is <a href="http://xenbits.xen.org/gitweb/?p=xen.git%3Ba=tree%3Bf=tools/ocaml/xenstored%3Bh=0d762f2a61de098c0100814e0c140575b51688a3%3Bhb=stable-4.4">already written in OCaml</a>
and documented in the paper
<a href="http://gazagnaire.org/pub/GH09.pdf">OXenstored: an efficient hierarchical and transactional database using functional programming with reference cell comparisons</a> presented at ICFP 2009.
The existing code works very reliably, but there is always room for improvement
for debuggability of such a complex system&hellip;</p><a onclick="switchContent('ocamlorg-post29','ocamlorg-post30')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-irmin-in-xenstore">Read more...</a></div><div id="ocamlorg-post30" style="display: none">
      <p><em>This is the second in a series of posts that introduces the <a href="https://github.com/mirage/irmin">Irmin</a> distributed storage engine.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-irmin">introductory post</a>.</em></p>
<p><a href="http://wiki.xen.org/wiki/XenStore">Xenstore</a> is a critical service found on all hosts
running <a href="http://www.xen.org/">Xen</a>. Xenstore is necessary to</p>
<ul><li>configure all VM I/O devices such as disk controllers and network interface cards;</li><li>share performance statistics and OS version information; and</li><li>signal VMs during shutdown, suspend, resume, migrate etc.</li></ul>

<p>Xenstore must be <strong>reliable</strong>: if it fails then the host is unmanageable and must be rebooted.</p>
<p>Xenstore must be <strong>secure</strong>: if it is compromised by a VM then that VM can access data belonging
to other VMs.</p>
<p>The current version of Xenstore is <a href="http://xenbits.xen.org/gitweb/?p=xen.git%3Ba=tree%3Bf=tools/ocaml/xenstored%3Bh=0d762f2a61de098c0100814e0c140575b51688a3%3Bhb=stable-4.4">already written in OCaml</a>
and documented in the paper
<a href="http://gazagnaire.org/pub/GH09.pdf">OXenstored: an efficient hierarchical and transactional database using functional programming with reference cell comparisons</a> presented at ICFP 2009.
The existing code works very reliably, but there is always room for improvement
for debuggability of such a complex system component. This is where Irmin, the
storage layer of Mirage 2.0, can help.</p>
<p>But first, a quick Xenstore primer:</p>
<h3>Xen and Xenstore in 30 seconds</h3>

<p>The Xen hypervisor focuses on isolating VMs from each-other; the hypervisor provides a virtual CPU scheduler
and a memory allocator but does not perform I/O on behalf of guest VMs.
On a Xen host, privileged server VMs perform I/O on behalf of client VMs.
The configuration for calculating which server VM services requests for which client VMs is stored in Xenstore, as
key/value pairs.</p>
<p>The following diagram shows a Xen host with a single client and server VM, with
a single virtual device in operation.  Disk blocks and network packets flow via
shared memory between Xen-aware drivers in the VMs, shown in the lower-half.
The control-plane, shown in the upper-half, contains the metadata about the
datapath: how the device should appear in the client VM; where the I/O should
go in the server VM; where the shared memory control structures are etc.</p>
<p><img src="http://openmirage.org/graphics/xenstore-diagram.png" alt="Device configuration is stored in Xenstore as key=value pairs."/></p>
<p>The Xenstore device attach protocol insists that all device keys are added
through atomic transactions, i.e. partial updates are never visible to clients and transactions
cannot interfere with each other.
A Xenstore server must abort transactions whose operations were not successfully
isolated from other transactions. After an abort, the client is expected to retry.
Each key=value write is communicated to the server as a single request/response, so transactions
comprising multiple writes are open for multiple round-trip times.
This protocol is baked into guest VM kernels (including Linux, FreeBSD, Mirage, ...)
and won't change anytime soon.</p>
<p>Xenstore is used heavily when lots of VMs are starting in parallel. Each VM typically
has several devices, each of these devices is added in a parallel transaction and therefore
many transactions are open at once. If the server aborts too many of these transactions,
causing the clients to retry, the system will make little progress and may appear to live-lock.
The challenge for a Xenstore implementation is to minimise the number of aborted
transactions and retries, without compromising on the isolation guarantee.</p>
<h3>Irmin Xenstore design goals</h3>

<p>The design goals of the Irmin-based Mirage Xenstore server are:</p>
<ol><li>safely restart after a crash;</li><li>make system debugging easy; and</li><li>go really fast!</li></ol>

<p>How does Irmin help achieve these goals?</p>
<h3>Restarting after crashes</h3>

<p>The Xenstore service is a reliable component and very rarely crashes. However,
if a crash does occur, the impact is severe on currently running virtual
machines. There is no protocol for a running VM to close its connection to a
Xenstore and open a new one, so if Xenstore crashes then running VMs are simply
left orphaned. VMs in this state are impossible to manage properly: there is no
way to shut them down cleanly, to suspend/resume or migrate, or to configure
any disk or network interfaces. If Xenstore crashes, the host must be rebooted
shortly after.</p>
<p>Irmin helps make Xenstore recoverable after a crash, by providing a library
that applications can use to persist and synchronise distributed data
structures on disk and in memory. By using Irmin to persist all our state
somewhere sensible and taking care to manage our I/O carefully, then the server
process becomes stateless and can be restarted at will.</p>
<p>To make Xenstore use Irmin,
the first task is to enumerate all the different kinds of state in the running process.
This includes the obvious key-value pairs used for VM configuration
as well as data currently hidden away in the OCaml heap:
the addresses in memory of established communication rings,
per-domain quotas, pending watch events and watch registrations etc etc. 
Once the state has been enumerated it must be mapped onto key-value pairs which can
be stored in Irmin. Rather than using ad-hoc mappings everywhere, the Mirage Irmin
server has
<a href="https://github.com/mirage/ocaml-xenstore-server/blob/blog/introducing-irmin-in-xenstore/server/pMap.mli">persistent Maps</a>,
<a href="https://github.com/mirage/ocaml-xenstore-server/blob/blog/introducing-irmin-in-xenstore/server/pSet.ml">persistent Sets</a>,
<a href="https://github.com/mirage/ocaml-xenstore-server/blob/blog/introducing-irmin-in-xenstore/server/pQueue.ml">persistent Queues</a>
and
<a href="https://github.com/mirage/ocaml-xenstore-server/blob/blog/introducing-irmin-in-xenstore/server/pRef.ml">persistent reference cells</a>.</p>
<p>Irmin applications are naturally written as functors, with the details of the persistence kept
abstract.
The following <a href="https://github.com/mirage/irmin/blob/0.8.3/lib/core/irminView.mli">Irmin-inspired</a> signature represents what Xenstore needs
from Irmin:</p>
<pre><code>module type VIEW = sig
  type t

  val create: unit -&gt; t Lwt.t
  (** Create a fresh VIEW from the current state of the store.
      A VIEW tracks state queries and updates and acts like a branch
      which has an explicit [merge]. *)

  val read: t -&gt; Protocol.Path.t -&gt; 
    [ `Ok of Node.contents | `Enoent of Protocol.Path.t ] Lwt.t
  (** Read a single key *)

  val list: t -&gt; Protocol.Path.t -&gt; 
    [ `Ok of string list | `Enoent of Protocol.Path.t ] Lwt.t
  (** List all the children of a key *)

  val write: t -&gt; Protocol.Path.t -&gt; Node.contents -&gt; 
    [ `Ok of unit ] Lwt.t
  (** Update a single key *)

  val mem: t -&gt; Protocol.Path.t -&gt; bool Lwt.t
  (** Check whether a key exists *)

  val rm: t -&gt; Protocol.Path.t -&gt; [ `Ok of unit ] Lwt.t
  (** Remove a key *)

  val merge: t -&gt; string -&gt; bool Lwt.t
  (** Merge this VIEW into the current state of the store *)
end</code></pre><p>The main 'business logic' of Xenstore can then be functorised over this signature relatively easily.
All we need is to instantiate the functor using Irmin to persist the data somewhere sensible.
Eventually we will need two instantiations: one which runs as a userspace application and which
writes to the filesystem; and a second which will run as a
native Xen kernel (known as a <a href="http://openmirage.org/blog/xenstore-stub.md">xenstore stub domain</a>)
and which will write to a fixed memory region (like a ramdisk).
The choice of which to use is left to the system administrator. Currently most (if not all)
distribution packagers choose to run Xenstore in userspace. Administrators who wish to
further secure their hosts are encouraged to run the kernelspace version to isolate Xenstore
from other processes (where a VM offers more isolation than a container, which offers more
isolation than a chroot). Note this choice is invisible to the guest VMs.</p>
<p>So far in the Irmin Xenstore integration only the userspace instantiation has been implemented.
One of the most significant user-visible features is that all of the operations done through
Irmin can be inspected using the standard <code>git</code> command line tool.
The runes to configure Irmin to write
<a href="http://git-scm.com">git</a> format data to the filesystem are as follows:</p>
<pre><code>    let open Irmin_unix in
    let module Git = IrminGit.FS(struct
      let root = Some filename
      let bare = true
    end) in
    let module DB = Git.Make(IrminKey.SHA1)(IrminContents.String)(IrminTag.String) in
    DB.create () &gt;&gt;= fun db -&gt;</code></pre><p>where keys and values will be mapped into OCaml <code>strings</code>, and our
<code>VIEW.t</code> is simply an Irmin <code>DB.View.t</code>. All that remains is to implement
<code>read</code>, <code>list</code>, <code>write</code>, <code>rm</code> by</p>
<ol><li>mapping Xenstore <code>Protocol.Path.t</code> values onto Irmin keys; and</li><li>mapping Xenstore <code>Node.contents</code> records onto Irmin values.</li></ol>

<p>As it happens Xenstore and Irmin have similar notions of &quot;paths&quot; so the first mapping is
easy. We currently use <a href="https://github.com/janestreet/sexplib">sexplib</a> to map Node.contents
values onto strings for Irmin.</p>
<p>The resulting <a href="https://github.com/mirage/ocaml-xenstore-server/blob/blog/introducing-irmin-in-xenstore/userspace/main.ml#L101">Irmin glue module</a> looks like:</p>
<pre><code>    let module V = struct
      type t = DB.View.t
      let create = DB.View.create
      let write t path contents =
        DB.View.update t (value_of_filename path) (Sexp.to_string (Node.sexp_of_contents contents))
      (* omit read,list,write,rm for brevity *)
      let merge t origin =
        let origin = IrminOrigin.create &quot;%s&quot; origin in
        DB.View.merge_path ~origin db [] t &gt;&gt;= function
        | `Ok () -&gt; return true
        | `Conflict msg -&gt;
          info &quot;Conflict while merging database view: %s&quot; msg;
          return false
    end in</code></pre><p>The <code>write</code> function simply calls through to Irmin's <code>update</code> function, while the <code>merge</code> function
calls Irmin's <code>merge_path</code>. If Irmin cannot merge the transaction then our <code>merge</code> function will
return <code>false</code> and this will be signalled to the client, which is expected to retry the high-level
operation (e.g. hotplugging or unplugging a device).</p>
<p>Now all that remains is to carefully adjust the I/O code so that effects (reading and writing packets
along the persistent connections) are interleaved properly with persisted state changes and
voil&agrave;, we now have a xenstore which can recover after a restart.</p>
<h3>Easy system debugging with Git</h3>

<p>When something goes wrong on a Xen system it's standard procedure to</p>
<ol><li>take a snapshot of the current state of Xenstore; and</li><li>examine the log files for signs of trouble.</li></ol>

<p>Unfortunately by the
time this is done, interesting Xenstore state has usually been deleted. Unfortunately the first task
of the human operator is to evaluate by-hand the logged actions in reverse to figure out what the state
actually was when the problem happened. Obviously this is tedious, error-prone and not always
possible since the log statements are ad-hoc and don't always include the data you need to know.</p>
<p>In the new Irmin-powered Xenstore the history is preserved in a git-format repository, and can
be explored using your favourite git viewing tool. Each store
update has a compact one-line summary, a more verbose multi-line explanation and (of course)
the full state change is available on demand.</p>
<p>For example you can view the history in a highly-summarised form with:</p>
<pre class="console"><code class="console">$ git log --pretty=oneline --abbrev-commit --graph
* 2578013 Closing connection -1 to domain 0
* d4728ba Domain 0: rm /bench/local/domain/0/backend/vbd/10 = ()
* 4b55c99 Domain 0: directory /bench/local/domain/0/backend = [ vbd ]
* a71a903 Domain 0: rm /bench/local/domain/10 = ()
* f267b31 Domain 0: rm /bench/vss/uuid-10 = ()
* 94df8ce Domain 0: rm /bench/vm/uuid-10 = ()
* 0abe6b0 Domain 0: directory /bench/vm/uuid-10/domains = [  ]
* 06ddd3b Domain 0: rm /bench/vm/uuid-10/domains/10 = ()
* 1be2633 Domain 0: read /bench/local/domain/10/vss = /bench/vss/uuid-10
* 237a8e4 Domain 0: read /bench/local/domain/10/vm = /bench/vm/uuid-10
* 49d70f6 Domain 0: directory /bench/local/domain/10/device = [  ]
*   ebf4935 Merge view to /
|\
| * e9afd9f Domain 0: read /bench/local/domain/10 =
* | c4e0fa6 Domain 0: merging transaction 375
|/</code></pre><p>The summarised form shows both individual operations as well as isolated transactions which
are represented as git branches.
You can then 'zoom in' and show the exact state change with commands like:</p>
<pre><code>$ git show bd44e03
commit bd44e0388696380cafd048eac49474f68d41bd3a
Author: 448 &lt;irminsule@openmirage.org&gt;
Date:   Thu Jan 1 00:09:26 1970 +0000

    Domain 0: merging transaction 363

diff --git a/*0/bench.dir/local.dir/domain.dir/7.dir/control.dir/shutdown.value b/*0/bench.dir/local.dir/domain.dir/7.dir/control.dir/shutdown.value
new file mode 100644
index 0000000..aa38106
--- /dev/null
+++ b/*0/bench.dir/local.dir/domain.dir/7.dir/control.dir/shutdown.value
@@ -0,0 +1 @@
+((creator 0)(perms((owner 7)(other NONE)(acl())))(value halt))</code></pre><p>Last but not least, you can <code>git checkout</code> to the exact time the problem occurred and examine
the state of the store.</p>
<h3>Going really fast</h3>

<p>Xenstore is part of the control-plane of a Xen system and is most heavily stressed when lots
of VMs are being started in parallel. Each VM has multiple devices and each device is added in a
separate transaction. These transactions remain open for multiple client-server round-trips, as
each individual operation is sent to Xenstore as a separate RPC. 
To provide isolation, each Xenstore transaction is represented by an Irmin <code>VIEW.t</code> which
is persisted on disk as a git branch.
When starting lots of VMs in
parallel, lots of branches are created and must be merged back together. If a branch cannot
be merged then an abort signal is sent to the client and it must retry.</p>
<p>Earlier versions of Xenstore had naive transaction merging algorithms
which aborted many of these transactions, causing the clients to re-issue them.This led to a live-lock
where clients were constantly reissuing the same transactions again and again.</p>
<p>Happily Irmin's default merging strategy is much better: by default Irmin
records the results of every operation and replays the operations on merge
(similar to <code>git rebase</code>). Irmin will only generate a <code>Conflict</code> and signal an
abort if the client would now see different results to those it has already
received (imagine reading a key twice within an isolated transaction and seeing
two different values). In the case of parallel VM starts, the keys are disjoint
by construction so all transactions are merged trivially; clients never receive
abort signals; and therefore the system makes steady, predictable progress
starting the VMs.</p>
<h3>Trying it out</h3>

<p>The Irmin Xenstore is under <a href="https://github.com/mirage/ocaml-xenstore-server">active development</a>
but you can try it by:</p>
<p>Install basic development tools along with the xen headers and xenstore tools (NB you don't
actually have to run Xen):</p>
<pre><code>  sudo apt-get install libxen-dev xenstore-utils opam build-essential m4</code></pre><p>Initialise opam (if you haven't already). Make sure you have OCaml 4.01:</p>
<pre><code>  opam init
  opam update
  opam switch 4.01.0</code></pre><p>Install the OCaml build dependencies:</p>
<pre><code>  opam install lwt irmin git sexplib cstruct uri sexplib cmdliner xen-evtchn shared-memory-ring io-page ounit</code></pre><p>Clone the code and build it:</p>
<pre><code>  git clone git://github.com/mirage/ocaml-xenstore-server
  cd ocaml-xenstore-server
  make</code></pre><p>Run a server (as a regular user):</p>
<pre><code>  ./main.native --database /tmp/db --enable-unix --path /tmp/xenstored</code></pre><p>In a separate terminal, perform some operations:</p>
<pre><code>  export XENSTORED_PATH=/tmp/xenstored
  xenstore-write -s /one/two/three 4 /five/six/seven 8
  xenstore-ls -s /</code></pre><p>Next check out the git repo generated by Irmin:</p>
<pre><code>  cd /tmp/db
  git log</code></pre>

<p>Comments and/or contributions are welcome: join the <a href="http://lists.xenproject.org/cgi-bin/mailman/listinfo/mirageos-devel">Mirage email list</a> and say hi!</p>

   <a onclick="switchContent('ocamlorg-post30','ocamlorg-post29')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-irmin-in-xenstore">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/introducing-irmin-in-xenstore">by Dave Scott at Jul 21, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/introducing-irmin">
    <a name="#http://openmirage.org/blog/introducing-irmin"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/introducing-irmin">Introducing Irmin: Git-like distributed, branchable storage</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post31">
      <blockquote><p>This is the first post in a series which will describe <a href="https://github.com/mirage/irmin">Irmin</a>,
 the new Git-like storage layer for Mirage OS 2.0. This post gives a
 high-level description on Irmin and its overall architecture, and
 later posts will detail how to use Irmin in real systems.</p>
</blockquote>

<p><a href="https://github.com/mirage/irmin">Irmin</a> is a library to persist and synchronize distributed
data structures both on-disk and in-memory. It enables a style of
programming very similar to the <a href="http://git-scm.com/">Git</a> workflow, where
distributed nodes fork, fetch, merge and push data between
each other. The general idea is that you want every active node to
get a local (partial) copy of a global database and always be very
explicit about how and when data is shared and migrated.</p>
<p>Irmin is <em>not</em>, strictly speaking, a full database engine. It
is, as are all other components of Mirage OS, a collection of
libraries designed to solve different flavours of the challenges raised
by the <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a>. Each application can select the right
combination of libraries to solve its particular distrib&hellip;</p><a onclick="switchContent('ocamlorg-post31','ocamlorg-post32')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-irmin">Read more...</a></div><div id="ocamlorg-post32" style="display: none">
      <blockquote><p>This is the first post in a series which will describe <a href="https://github.com/mirage/irmin">Irmin</a>,
 the new Git-like storage layer for Mirage OS 2.0. This post gives a
 high-level description on Irmin and its overall architecture, and
 later posts will detail how to use Irmin in real systems.</p>
</blockquote>

<p><a href="https://github.com/mirage/irmin">Irmin</a> is a library to persist and synchronize distributed
data structures both on-disk and in-memory. It enables a style of
programming very similar to the <a href="http://git-scm.com/">Git</a> workflow, where
distributed nodes fork, fetch, merge and push data between
each other. The general idea is that you want every active node to
get a local (partial) copy of a global database and always be very
explicit about how and when data is shared and migrated.</p>
<p>Irmin is <em>not</em>, strictly speaking, a full database engine. It
is, as are all other components of Mirage OS, a collection of
libraries designed to solve different flavours of the challenges raised
by the <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a>. Each application can select the right
combination of libraries to solve its particular distributed problem. More
precisely, Irmin consists of a core of well-defined low-level
data structures that specify how data should be persisted
and be shared across nodes. It defines algorithms for efficient
synchronization of those distributed low-level constructs. It also
builds a collection of higher-level data structures, like persistent
<a href="https://github.com/mirage/merge-queues">mergeable queues</a>, that can be used by developers without
having to know precisely how Irmin works underneath.</p>
<p>Since it's a part of Mirage OS, Irmin does not make strong assumptions about the
OS environment that it runs in. This makes the system very portable, and the
details below hold for in-memory databases as well as for slower persistent
serialization such as SSDs, hard drives, web browser local storage, or even
the Git file format.</p>
<h3>Persistent Data Structures</h3>

<p>Persistent data structures are well known and used pervasively in many
different areas. The programming language community has
investigated the concepts <a href="https://www.cs.cmu.edu/~rwh/theses/okasaki.pdf">widely</a> (and this is <a href="http://en.wikipedia.org/wiki/Object_copy">not
limited</a> to functional programming), and in the meantime,
the systems community experimented with various persistent
strategies such as <a href="http://en.wikipedia.org/wiki/Copy-on-write">copy-on-write</a> filesystems. In most of these
systems, the main concern is how to optimize the space complexity by
maximizing the sharing of immutable sub-structures.</p>
<p>The Irmin design ideas share roots with previous works on persistent data
structures, as it provides an efficient way to <em>fork</em> data structures,
but it also explores new strategies and mechanisms to be able to
efficiently <em>merge</em> back these forked structures. This offers
programming constructs very similar to the Git workflow.</p>
<p>Irmin focuses on two main aspects:</p>
<ul><li><p><strong>Semantics</strong>: what properties the resulting merged objects should
verify.</p>
</li><li><p><strong>Complexity</strong>: how to design efficient merge and synchronization
primitives, taking advantage of the immutable nature of the underlying
objects.</p>
</li></ul>

<p>Although it is pervasively used, <em>data persistence</em> has a very broad and
fuzzy meaning. In this blog post, I will refer to data persistence as
a way for:</p>
<ul><li><p>a single process to lazily populate a process memory on startup.
 You need this when you want the process to be able to resume while
 holding part of its previous state if it crashes</p>
</li><li><p>concurrent processes to share references between objects living in
 a global pool of data. Sharing references, as opposed to sharing
 values, reduces memory copies and allow different processes to
 concurrently update a shared store.</p>
</li></ul>

<p>In both cases, you need a global pool of data (the Irmin <em>block store</em>)
and a way to name values in that pool (the Irmin <em>tag store</em>).</p>
<h3>The Block Store: a Virtual Heap</h3>

<p>Even high-level data structures need to be allocated in memory, and it
is the purpose of the runtime to map such high-level constructs into
low-level memory graph blocks. One of the strengths of <a href="http://ocaml.org">OCaml</a>
is the very simple and deterministic mapping from high-level data
structures to low-level block representations (the <em>heap</em>): see for
instance, the excellent series of blog posts on <a href="http://rwmj.wordpress.com/2009/08/04/ocaml-internals/">OCaml
internals</a> by Richard W. Jones, or
<a href="https://realworldocaml.org/v1/en/html/memory-representation-of-values.html">Chapter 20: Memory Representation of Values</a> in
<a href="https://realworldocaml.org">Real World OCaml</a>.</p>
<p>An Irmin <em>block store</em> can be seen as a virtual OCaml heap that uses a more
abstract way of connecting heap blocks. Instead of using the concrete physical
memory addresses of blocks, Irmin uses the hash of the block contents as an
address. As for any <a href="http://en.wikipedia.org/wiki/Content-addressable_storage">content-addressable storage</a>, this gives Irmin
block stores a lot of nice properties and greatly simplifies the way distributed
stores can be synchronized.</p>
<p><em>Persistent</em> data structures are immutable, and once a block is created in
the block store, its contents will never change again.
Updating an immutable data structure means returning a completely new
structure, while trying to share common sub-parts to avoid the cost of
making new allocations as much as possible. For instance, modifying a
value in a persistent tree means creating a chain of new blocks, from
the root of the tree to the modified leaf.
For convenience, Irmin only considers acyclic block graphs --
it is difficult in a non-lazy pure language to generate complex cyclic
values with reasonable space usage.</p>
<p>Conceptually, an Irmin block store has the following signature:</p>
<pre class="ocaml"><code class="ocaml">type t
(** The type for Irmin block store. *)

type key
(** The type for Irmin pointers *)

type value = ...
(** The type for Irmin blocks *)

val read: t -&gt; key -&gt; value option
(** [read t k] is the block stored at the location [k] of the
store. It is [None] if no block is available at that location. *)

val add: t -&gt; key -&gt; value -&gt; t
(** [add t k v] is the *new* store storing the block [v] at the
location [k]. *)</code></pre>

<p>Persistent data structures are very efficient to store in memory and on
disk as you do not need <a href="http://en.wikipedia.org/wiki/Write_barrier">write barriers</a>, and updates
can be written <a href="http://en.wikipedia.org/wiki/Write_amplification#Sequential_writes">sequentially</a> instead of requiring random
access into the data structure.</p>
<h3>The Tag Store: Controlled Mutability and Concurrency</h3>

<p>So far, we have only discussed purely functional data structures,
where updating a structure means returning a pointer to a new
structure in the heap that shares most of its contents with the previous
one. This style of programming is appealing when implementing
<a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">complex protocols</a> as it leads to better compositional properties.</p>
<p><img src="http://openmirage.org/graphics/irmin-stores.png" width="250px" style="float:right; border: 5px" alt="Irmin Stores"/></p>
<p>However, this makes sharing information between processes much more
difficult, as you need a way to &quot;inject&quot; the state of one structure into another process's memory. In order to do so, Irmin borrows the concept of
<em>branches</em> from Git by relating every operation to a branch name, and
modifying the tip of the branch if it has side-effects.
The Irmin <em>tag store</em> is the only mutable part of the whole system and
is responsible for mapping some global (branch) names to blocks in the
block store. These tag names can then be used to pass block references between
different processes.</p>
<p>A block store and a tag store can be combined to build
a higher-level store (the Irmin store) with fine concurrency control
and atomicity guarantees. As mutation happens only in the tag store,
we can ensure that as long a given tag is not updated, no change made
in the block store will be visible by anyone. This also gives a nice
story for concurrency: as in Git, creating a concurrent view of the
store is the straightforward operation of creating a new tag that
denotes a new branch. All concurrent operations can then happen on
different branches:</p>
<pre class="ocaml"><code class="ocaml">type t
(** The type for Irmin store. *)

type tag
(** Mutable tags *)

type key = ...
(** The type for user-defined keys (for instance a list of strings) *)

type value = ...
(** The type for user-defined values *)

val read: t -&gt; ?branch:tag -&gt; key -&gt; value option
(** [read t ?branch k] reads the contents of the key [k] in the branch
[branch] of the store [t]. If no branch is specified, then use the
[&quot;HEAD&quot;] one. *)

val update: t -&gt; ?branch:tag -&gt; key -&gt; value -&gt; unit
(** [update t ?branch k v] *updates* the branch [branch] of the store
[t] the association of the key [key] to the value [value]. *)</code></pre>

<p>Interactions between concurrent processes are completely explicit and
need to happen via synchronization points and merge events (more on
this below). It is also possible to emulate the behaviour of
transactions by recording the sequence of operations (<code>read</code> and
<code>update</code>) on a given branch -- that sequence is used before a merge
to check that all the operations are valid (i.e. that all reads in the
transaction still return the same result on the current tip of the
store) and it can be discarded after the merge takes place.</p>
<h3>Merging Data Structures</h3>

<p>To merge two data structures in a consistent way, one has to compute
the sequence of operations which leads, from an initial common state, to two
diverging states (the ones that you want to merge). Once these two
sequences of operations have been found, they must be combined (if
possible) in a sensible way and then applied again back on the initial
state, in order to get the new merged state. This mechanism sounds
nice, but in practice it has two major drawbacks:</p>
<ul><li>It does not specify how we find the initial state from two diverging
 states -- this is generally not possible (think of diverging
 counters); and</li><li>It means we need to compute the sequence of <code>update</code> operations
 that leads from one state to an other.  This is easier than finding
 the common initial state between two branches, but is still generally
 not very efficient.</li></ul>

<p>In Irmin, we solve these problems using two mechanisms.</p>
<p>First of all, an interesting observation is that that we can model the
sequence of store tips as a purely functional data-structure. We model
the partial order of tips as a directed acyclic graph where nodes are
the tips, and there is an edge between two tips if either <em>(i)</em> one is
the result of applying a sequence of <code>update</code>s to the other, or <em>(ii)</em>
one is the result of a merge operation between the other and some
other tips. Practically speaking, that means that every tip should
contains the list of its predecessors as well as the actual data it
associated to. As it is purely functional, we can (and we do) store
that graph in an Irmin block store.</p>
<p><img src="http://openmirage.org/graphics/irmin-merge.png" width="150px" style="float:right; border:5px" alt="Finding a common ancestor"/></p>
<p>Having a persistent and immutable history is good for various obvious
reasons, such as access to a forensics if an error occurs or
snapshot and rollback features for free. But another less obvious
useful property is that we can now find the greatest common
ancestors of two data structures without an expensive global search.</p>
<p>The second mechanism is that we require the data structures used in
Irmin to be equipped with a well-defined 3-way merge operation, which
takes two diverging states, the corresponding initial state (computed
using the previous mechanism) and that return either a new state or a
conflict (similar to the <code>EAGAIN</code> exception that you get when you try
to commit a conflicting transaction in more traditional transactional
databases). Having access to the common ancestors makes a great
difference when designing new merge functions, as usually no
modification is required to the data-structure itself. In contrast,
the conventional approach is more invasive as it requires the data
structure to carry more information about the operation history
(for instance <a href="http://hal.upmc.fr/docs/00/55/55/88/PDF/techreport.pdf">conflict-free replicated
datatypes</a>, which relies on unbounded vector clocks).</p>
<p>We have thus been designing interesting data structure equipped with a 3-way
merge, such as counters, <a href="https://github.com/mirage/merge-queues">queues</a> and ropes.</p>
<p>This is what the implementation of distributed and mergeable counters
looks like:</p>
<pre class="ocaml"><code class="ocaml">type t = int
(** distributed counters are just normal integers! *)

let merge ~old t1 t2 = old + (t1-old) + (t2-old)
(** Merging counters means:
   - computing the increments of the two states [t1] and [t2]
     relatively to the initial state [old]; and
   - and add these two increments to [old]. *)</code></pre>

<h3>Next steps, how to git at your data</h3>

<p>From a design perspective, having access to the history makes it easier to
design complex data structures with good compositional properties to use in
unikernels. Moreover, as we made few assumptions on how the substrate of the
low-level constructs need to be implemented, the Irmin engine can be be ported
to many exotic backends such as JavaScript or anywhere else that Mirage OS
runs: this is just a matter of implementing a rather trivial
<a href="https://github.com/mirage/irmin/blob/4b06467ddee1e20c35bad64812769587fb9fa8a4/lib/core/irminStore.mli#L61">signature</a>.</p>
<p>From a developer perspective, this means that the full history of operations is
available to inspect, and that the history model is very similar to the Git
workflow that is increasingly familiar. So similar, in fact, that we've
developed a bidirectional mapping between Irmin data structures and the Git
format to permit the <code>git</code> command-line to interact with.</p>
<p>The <a href="http://openmirage.org/blog/introducing-irmin-in-xenstore">next post in our series</a> explains what <a href="http://dave.recoil.org/">Dave Scott</a> has been doing
with the new version of the <a href="http://wiki.xen.org/wiki/XenStoreReference">Xenstore</a> database that powers every Xen host,
where the entire database is stored in a prefix-tree Irmin data-structure and exposed
as a Git repository which is live-updated!  Here's a sneak preview...</p>
<div class="flex-video">
  <iframe allowfullscreen="1" frameborder="0" src="//www.youtube-nocookie.com/embed/DSzvFwIVm5s" height="360" width="480"> &nbsp; </iframe>
</div>


   <a onclick="switchContent('ocamlorg-post32','ocamlorg-post31')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-irmin">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/introducing-irmin">by Thomas Gazagnaire at Jul 18, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/intro-tcpip">
    <a name="#http://openmirage.org/blog/intro-tcpip"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/intro-tcpip">Fitting the modular Mirage TCP/IP stack together</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post33">
      <p>A critical part of any unikernel is its network stack -- it's difficult to
think of a project that needs a cloud platform or runs on a set-top box with no
network communications.</p>
<p>Mirage provides a number of <a href="https://github.com/mirage/mirage/tree/master/types">module
types</a> that abstract
interfaces at different layers of the network stack, allowing unikernels to
customise their own stack based on their deployment needs. Depending on the
abstractions your unikernel uses, you can fulfill these abstract interfaces
with implementations ranging from the venerable and much-imitated Unix sockets
API to a clean-slate Mirage <a href="https://github.com/mirage/mirage-tcpip">TCP/IP
stack</a> written from the ground up in
pure OCaml!</p>
<p>A Mirage unikernel will not use <em>all</em> these interfaces, but will pick those that
are appropriate for the particular application at hand. If your unikernel just
needs a standard TCP/IP stack, the <code>STACKV4</code> abstraction will be sufficient.
However, if you want more control over the implementation of the different
layers in the stack or you don't need TCP support, you might &hellip;</p><a onclick="switchContent('ocamlorg-post33','ocamlorg-post34')" class="btn planet-toggle" href="#http://openmirage.org/blog/intro-tcpip">Read more...</a></div><div id="ocamlorg-post34" style="display: none">
      <p>A critical part of any unikernel is its network stack -- it's difficult to
think of a project that needs a cloud platform or runs on a set-top box with no
network communications.</p>
<p>Mirage provides a number of <a href="https://github.com/mirage/mirage/tree/master/types">module
types</a> that abstract
interfaces at different layers of the network stack, allowing unikernels to
customise their own stack based on their deployment needs. Depending on the
abstractions your unikernel uses, you can fulfill these abstract interfaces
with implementations ranging from the venerable and much-imitated Unix sockets
API to a clean-slate Mirage <a href="https://github.com/mirage/mirage-tcpip">TCP/IP
stack</a> written from the ground up in
pure OCaml!</p>
<p>A Mirage unikernel will not use <em>all</em> these interfaces, but will pick those that
are appropriate for the particular application at hand. If your unikernel just
needs a standard TCP/IP stack, the <code>STACKV4</code> abstraction will be sufficient.
However, if you want more control over the implementation of the different
layers in the stack or you don't need TCP support, you might construct your
stack by hand using just the <a href="https://github.com/mirage/mirage/blob/8b59fbf0b223b3c5c70d4939b5674ecdd7521804/types/V1.mli#L263">NETWORK</a>, <a href="https://github.com/mirage/mirage/blob/8b59fbf0b223b3c5c70d4939b5674ecdd7521804/types/V1.mli#L316">ETHIF</a>, <a href="https://github.com/mirage/mirage/blob/8b59fbf0b223b3c5c70d4939b5674ecdd7521804/types/V1.mli#L368">IPV4</a> and <a href="https://github.com/mirage/mirage/blob/8b59fbf0b223b3c5c70d4939b5674ecdd7521804/types/V1.mli#L457">UDPV4</a> interfaces.</p>
<h2>How a Stack Looks to a Mirage Application</h2>

<p>Mirage provides a high-level interface to a TCP/IP network stack through the module type
<a href="https://github.com/mirage/mirage/blob/8b59fbf0b223b3c5c70d4939b5674ecdd7521804/types/V1.mli#L581">STACKV4</a>.
(Currently this can be included with <code>open V1_LWT</code>, but soon <code>open
V2_LWT</code> will also bring this module type into scope as well when Mirage 2.0 is released.)</p>
<pre class="OCaml"><code class="OCaml">(** Single network stack *)                                                     
module type STACKV4 = STACKV4                                                   
  with type 'a io = 'a Lwt.t                                                    
   and type ('a,'b,'c) config = ('a,'b,'c) stackv4_config                       
   and type ipv4addr = Ipaddr.V4.t                                              
   and type buffer = Cstruct.t </code></pre>

<p><code>STACKV4</code> has useful high-level functions, a subset of which are reproduced below:</p>
<pre class="OCaml"><code class="OCaml">    val listen_udpv4 : t -&gt; port:int -&gt; UDPV4.callback -&gt; unit
    val listen_tcpv4 : t -&gt; port:int -&gt; TCPV4.callback -&gt; unit
    val listen : t -&gt; unit io</code></pre>

<p>as well as submodules that include functions for data transmission:</p>
<pre class="OCaml"><code class="OCaml">    module UDPV4 :
      sig
        type callback =
            src:ipv4addr -&gt; dst:ipv4addr -&gt; src_port:int -&gt; buffer -&gt; unit io
        val input :
          listeners:(dst_port:int -&gt; callback option) -&gt; t -&gt; ipv4input
        val write :
          ?source_port:int -&gt;
          dest_ip:ipv4addr -&gt; dest_port:int -&gt; t -&gt; buffer -&gt; unit io</code></pre>

<pre class="OCaml"><code class="OCaml">    module TCPV4 :
      sig
        type flow
        type callback = flow -&gt; unit io
        val read : flow -&gt; [ `Eof | `Error of error | `Ok of buffer ] io
        val write : flow -&gt; buffer -&gt; unit io
        val close : flow -&gt; unit io
        val create_connection :
          t -&gt; ipv4addr * int -&gt; [ `Error of error | `Ok of flow ] io
        val input : t -&gt; listeners:(int -&gt; callback option) -&gt; ipv4input</code></pre>

<p>These should look rather familiar if you've used the Unix sockets
API before, with one notable difference: the stack accepts functional
callbacks to react to events such as a new connection request.  This
permits callers of the library to define the precise datastructures that
are used to store intermediate state (such as active connections).
This becomes important when building very scalable systems that have
to deal with <a href="https://en.wikipedia.org/wiki/C10k_problem">lots of concurrent connections</a>
efficiently.</p>
<h2>Configuring a Stack</h2>

<p>The <code>STACKV4</code> signature shown so far is just a module signature, and you
need to find a concrete module that satisfies that signature.  The known
implementations of a module can be found in the <code>mirage</code> CLI frontend,
which provids the <a href="https://github.com/mirage/mirage/blob/8b59fbf0b223b3c5c70d4939b5674ecdd7521804/lib/mirage.mli#L266">configuration API</a> for unikernels.<br/>There are currently two implementations for <code>STACKV4</code>: <code>direct</code> and <code>socket</code>.</p>
<pre class="OCaml"><code class="OCaml">module STACKV4_direct: CONFIGURABLE with                                        
  type t = console impl * network impl * [`DHCP | `IPV4 of ipv4_config]         
                                                                                
module STACKV4_socket: CONFIGURABLE with                                        
  type t = console impl * Ipaddr.V4.t list  </code></pre>

<p>The <code>socket</code> implementations rely on an underlying OS kernel to provide the
transport, network, and data link layers, and therefore can't be used for a Xen
guest VM deployment.  Currently, the only way to use <code>socket</code> is by configuring
your Mirage project for Unix with <code>mirage configure --unix</code>.  This is the mode
you will most often use when developing high-level application logic that doesn't
need to delve into the innards of the network stack (e.g. a REST website).</p>
<p>The <code>direct</code> implementations use the <a href="https://github.com/mirage/mirage-tcpip">mirage-tcpip</a> implementations of the
transport, network, and data link layers.  When you use this stack, all the network
traffic from the Ethernet level up will be handled in pure OCaml.  This means that the
<code>direct</code> stack will work with either a Xen
guest VM (provided there's a valid network configuration for the unikernel's
running environment of course), or a Unix program if there's a valid <a href="https://en.wikipedia.org/wiki/TUN/TAP">tuntap</a> interface.
<code>direct</code> this works with both <code>mirage configure --xen</code> and <code>mirage configure --unix</code>
as long as there is a corresponding available device when the unikernel is run.</p>
<p>There are a few Mirage functions that provide IPv4 (and UDP/TCP) stack
implementations (of type <code>stackv4 impl</code>), usable from your application code.
The <code>stackv4 impl</code> is generated in <code>config.ml</code> by some logic set when the
program is <code>mirage configure</code>'d - often by matching an environment variable.
This means it's easy to flip between different stack implementations when
developing an application just be recompiling the application.  The <code>config.ml</code>
below allows the developer to build socket code with <code>NET=socket make</code> and
direct code with <code>NET=direct make</code>.</p>
<pre class="OCaml"><code class="OCaml">let main = foreign &quot;Services.Main&quot; (console @-&gt; stackv4 @-&gt; job)

let net =
  try match Sys.getenv &quot;NET&quot; with
    | &quot;direct&quot; -&gt; `Direct
    | &quot;socket&quot; -&gt; `Socket
    | _        -&gt; `Direct
  with Not_found -&gt; `Direct

let dhcp =
  try match Sys.getenv &quot;ADDR&quot; with
    | &quot;dhcp&quot;   -&gt; `Dhcp
    | &quot;static&quot; -&gt; `Static
    | _ -&gt; `Dhcp
  with Not_found -&gt; `Dhcp

let stack console =
  match net, dhcp with
  | `Direct, `Dhcp   -&gt; direct_stackv4_with_dhcp console tap0
  | `Direct, `Static -&gt; direct_stackv4_with_default_ipv4 console tap0
  | `Socket, _       -&gt; socket_stackv4 console [Ipaddr.V4.any]

let () =
  register &quot;services&quot; [
    main $ default_console $ stack default_console
  ]</code></pre>

<p>Moreover, it's possible to configure multiple stacks individually for use in
the same program, and to <code>register</code> multiple modules from the same <code>config.ml</code>.
This means functions can be written such that they're aware of the network
stack they ought to be using, and no other - a far cry from developing network
code over most socket interfaces, where it can be quite difficult to separate
concerns nicely.</p>
<pre class="OCaml"><code class="OCaml">let client = foreign &quot;Unikernel.Client&quot; (console @-&gt; stackv4 @-&gt; job)
let server = foreign &quot;Unikernel.Server&quot; (console @-&gt; stackv4 @-&gt; job) 

let client_netif = (netif &quot;0&quot;)
let server_netif = (netif &quot;1&quot;) 

let client_stack = direct_stackv4_with_dhcp default_console client_netif
let server_stack = direct_stackv4_with_dhcp default_console server_netif

let () = 
  register &quot;unikernel&quot; [
    main $ default_console $ client_stack;
    server $ default_console $ server_stack 
  ]

</code></pre>

<h2>Acting on Stacks</h2>

<p>Most network applications will either want to listen for incoming connections
and respond to that traffic with information, or to connect to some remote
host, execute a query, and receive information.  <code>STACKV4</code> offers simple ways
to define functions implementing either of these patterns.</p>
<h3>Establishing and Communicating Across Connections</h3>

<p><code>STACKV4</code> offers <code>listen_tcpv4</code> and <code>listen_udpv4</code> functions for establishing
listeners on specific ports.  Both take a <code>stack impl</code>, a named <code>port</code>, and a
<code>callback</code> function.</p>
<p>For UDP listeners, which are datagram-based rather than connection-based,
<code>callback</code> is a function of the source IP, destination IP, source port, and the
<code>Cstruct.t</code> that contains the payload data.  Applications that wish to respond
to incoming UDP packets with their own UDP responses (e.g., DNS servers) can
use this information to construct reply packets and send them with
<code>UDPV4.write</code> from within the callback function.</p>
<p>For TCP listeners, <code>callback</code> is a function of <code>TCPV4.flow -&gt; unit Lwt.t</code>.  <code>STACKV4.TCPV4</code> offers <code>read</code>, <code>write</code>, and <code>close</code> on <code>flow</code>s for application writers to build higher-level protocols on top of.</p>
<p><code>TCPV4</code> also offers <code>create_connection</code>, which allows client application code to establish TCP connections with remote servers.  In success cases, <code>create_connection</code> returns a <code>TCPV4.flow</code>, which can be acted on just as the data in a <code>callback</code> above.  There's also a polymorphic variant for error conditions, such as an unreachable remote server.</p>
<h3>A Simple Example</h3>

<p>Some very simple examples of user-level TCP code are included in <a href="https://github.com/mirage/mirage-tcpip/tree/master/examples">mirage-tcpip/examples</a>.  <code>config.ml</code> is identical to the first configuration example above, and will build a <code>direct</code> stack by default.</p>
<p>Imagine a very simple application - one which simply repeats any data back to the sender, until the sender gets bored and wanders off (<a href="https://en.wikipedia.org/wiki/Echo_Protocol">RFC 862</a>, for the curious).</p>
<pre class="OCaml"><code class="OCaml">open Lwt
open V1_LWT

module Main (C: V1_LWT.CONSOLE) (S: V1_LWT.STACKV4) = struct
  let report_and_close c flow message =
    C.log c message;
    S.TCPV4.close flow

  let rec echo c flow =
    S.TCPV4.read flow &gt;&gt;= fun result -&gt; (
      match result with  
        | `Eof -&gt; report_and_close c flow &quot;Echo connection closure initiated.&quot;
        | `Error e -&gt; 
          let message = 
          match e with 
            | `Timeout -&gt; &quot;Echo connection timed out; closing.\n&quot;
            | `Refused -&gt; &quot;Echo connection refused; closing.\n&quot;
            | `Unknown s -&gt; (Printf.sprintf &quot;Echo connection error: %s\n&quot; s)
             in
          report_and_close c flow message
        | `Ok buf -&gt;
            S.TCPV4.write flow buf &gt;&gt;= fun () -&gt; echo c flow
        ) 

  let start c s = 
    S.listen_tcpv4 s ~port:7 (echo c);
    S.listen s

end</code></pre>

<p>All the application programmer needs to do is define functionality in relation to <code>flow</code> for sending and receiving data, establish this function as a callback with <code>listen_tcpv4</code>, and start a listening thread with <code>listen</code>.</p>
<h2>More Complex Uses</h2>

<p>An OCaml HTTP server, <a href="http://www.github.com/mirage/ocaml-cohttp">Cohttp</a>, is currently powering this very blog.  A simple static webserver using Cohttp <a href="https://github.com/mirage/mirage-skeleton/tree/master/static_website">is included in <code>mirage-skeleton</code></a>.</p>
<p><a href="https://tls.openmirage.org/">The OCaml-TLS demonstration server</a> announced here <a href="http://openmirage.org/blog/introducing-ocaml-tls">just a few days ago</a> is also running atop Cohttp - <a href="https://github.com/mirleft/tls-demo-server">source is available on Github</a>.</p>
<h2>The future</h2>

<p>Mirage's TCP/IP stack is under active development!  <a href="https://github.com/mirage/mirage-tcpip/search?q=TODO&amp;ref=cmdform">Some low-level details</a> are still stubbed out, and we're working on implementing some of the trickier corners of TCP, as well as <a href="http://somerandomidiot.com/blog/2014/05/22/throwing-some-fuzzy-dice/">doing automated testing</a> on the stack.  We welcome testing tools, bug reports, bug fixes, and new protocol implementations!</p>

   <a onclick="switchContent('ocamlorg-post34','ocamlorg-post33')" class="btn planet-toggle" href="#http://openmirage.org/blog/intro-tcpip">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/intro-tcpip">by Mindy Preston at Jul 17, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/update-on-vchan">
    <a name="#http://openmirage.org/blog/update-on-vchan"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/update-on-vchan">Vchan: Low-latency inter-VM communication channels</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post35">
      <p><em>Today's post is an update to <a href="https://github.com/vbmithr">Vincent Bernardoff's</a>
<a href="http://openmirage.org/blog/introducing-vchan">introducing vchan</a> blog
post, updated to use the modern build scheme for Mirage.</em></p>
<p>Unless you are familiar with Xen's source code, there is little chance
that you've ever heard of the <em>vchan</em> library or
protocol. Documentation about it is very scarce: a description can be
found on vchan's
<a href="http://xenbits.xen.org/gitweb/?p=xen.git%3Ba=blob%3Bf=xen/include/public/io/libxenvchan.h%3Bhb=HEAD">public header file</a>,
that I quote here for convenience:</p>
<blockquote><p>Originally borrowed from the
<a href="http://www.qubes-os.org">Qubes OS Project</a>, this code (i.e. libvchan)
has been substantially rewritten [...]
This is a library for inter-domain communication.  A standard Xen ring
buffer is used, with a datagram-based interface built on top.  The
grant reference and event channels are shared in XenStore under a
user-specified path.</p>
</blockquote>

<p>This protocol uses shared memory for inter-domain communication,
i.e. between two VMs residing in the same Xen host, and uses Xen's
mechanisms -- more specifically,
<a href="http://www.informit.com/articles/article.aspx?p=1160234&amp;seqNum=3">ring buffers</a>
and
<a href="http://xenbits.xen.org/gitweb/?p=xen.git%3Ba=blob%3Bf=tools/libxc/xenctrl.h%3Bh=f2cebafc9ddd4815ffc73fcf9e0d292b1d4c91ff%3Bhb=HEAD#l934">event channels</a>
-- in order to achieve its aims. The term <em>datagram-based interface</em> &hellip;</p><a onclick="switchContent('ocamlorg-post35','ocamlorg-post36')" class="btn planet-toggle" href="#http://openmirage.org/blog/update-on-vchan">Read more...</a></div><div id="ocamlorg-post36" style="display: none">
      <p><em>Today's post is an update to <a href="https://github.com/vbmithr">Vincent Bernardoff's</a>
<a href="http://openmirage.org/blog/introducing-vchan">introducing vchan</a> blog
post, updated to use the modern build scheme for Mirage.</em></p>
<p>Unless you are familiar with Xen's source code, there is little chance
that you've ever heard of the <em>vchan</em> library or
protocol. Documentation about it is very scarce: a description can be
found on vchan's
<a href="http://xenbits.xen.org/gitweb/?p=xen.git%3Ba=blob%3Bf=xen/include/public/io/libxenvchan.h%3Bhb=HEAD">public header file</a>,
that I quote here for convenience:</p>
<blockquote><p>Originally borrowed from the
<a href="http://www.qubes-os.org">Qubes OS Project</a>, this code (i.e. libvchan)
has been substantially rewritten [...]
This is a library for inter-domain communication.  A standard Xen ring
buffer is used, with a datagram-based interface built on top.  The
grant reference and event channels are shared in XenStore under a
user-specified path.</p>
</blockquote>

<p>This protocol uses shared memory for inter-domain communication,
i.e. between two VMs residing in the same Xen host, and uses Xen's
mechanisms -- more specifically,
<a href="http://www.informit.com/articles/article.aspx?p=1160234&amp;seqNum=3">ring buffers</a>
and
<a href="http://xenbits.xen.org/gitweb/?p=xen.git%3Ba=blob%3Bf=tools/libxc/xenctrl.h%3Bh=f2cebafc9ddd4815ffc73fcf9e0d292b1d4c91ff%3Bhb=HEAD#l934">event channels</a>
-- in order to achieve its aims. The term <em>datagram-based interface</em> simply
means that the
<a href="http://xenbits.xen.org/gitweb/?p=xen.git%3Ba=blob%3Bf=tools/libvchan/libxenvchan.h%3Bh=6365d36a06f8c8f56454724cefc4c2f1d39beba2%3Bhb=HEAD">interface</a>
resembles UDP, although there is support for stream based communication (like
TCP) as well.</p>
<p>The <code>vchan</code> protocol is an important feature in MirageOS 2.0 since it
forms the foundational communication mechanism for <strong>building distributed
clusters of unikernels</strong> that cooperate to solve problems that are beyond
the power of a single node.  Instead of forcing communication between
nodes via a conventional wire protocol like TCP, it permits highly efficient
low-overhead communication to nodes that are colocated on the same Xen
host machine.</p>
<p>Before diving into vchan, I thought I'd also take the opportunity to describe the
<a href="http://releases.ubuntu.com/14.04/">Ubuntu-Trusty</a> environment for developing
and running <a href="http://www.xenproject.org/">Xen</a> unikernels.</p>
<h3>Installing Xen on Ubuntu</h3>

<p>Ubuntu 14.04 has good support for running Xen 4.4, the most recent release (at time of writing).
For running VMs it's a good idea to install Ubuntu on an LVM volume rather than directly on a
partition, which allows the use of LVs as the virtual disks for your VMs. On my system I have
a 40 Gig partition for '/', an 8 Gig swap partition and the rest is free for my VMs:</p>
<pre class="console"><code class="console">$ sudo lvs
   LV     VG      Attr      LSize  Pool Origin Data%  Move Log Copy%  Convert
   root   st28-vg -wi-ao--- 37.25g
   swap_1 st28-vg -wi-ao---  7.99g</code></pre>

<p>In this particular walkthough I won't be using disks, but later posts will.
Install Xen via the meta-package. This brings in all you will need to run VMs:</p>
<pre class="console"><code class="console">$ sudo apt-get install xen-system-amd64</code></pre>

<p>It used to be necessary to reorder the grub entries to make sure Xen was started
by default, but this is no longer necessary. Once the machine has rebooted, you
should be able to verify you're running virtualized by invoking 'xl':</p>
<pre class="console"><code class="console">$ sudo xl list
Name                                        ID   Mem VCPUs      State   Time(s)
Domain-0                                     0  7958     6     r-----       9.7</code></pre>

<p>My machine has 8 Gigs of memory, and this list shows that it's all being used by
my dom0, so I'll need to either balloon down dom0 or reboot with a lower maximum
memory. Ballooning is the most straightfoward:</p>
<pre class="console"><code class="console">$ sudo xenstore-write /local/domain/0/memory/target 4096000
$ sudo xl list
Name                                        ID   Mem VCPUs      State   Time(s)
Domain-0                                     0  4000     6     r-----      12.2</code></pre>

<p>This is handy for quick testing, but is <a href="http://wiki.xenproject.org/wiki/Xen_Project_Best_Practices">discouraged</a> by the Xen folks. So alternatively, change the xen command line by
editing <code>/etc/default/grub</code> and add the line:</p>
<pre class="console"><code class="console">GRUB_CMDLINE_XEN_DEFAULT=&quot;dom0_mem=4096M,max:4096M&quot;</code></pre>

<p>Once again, update-grub and reboot.</p>
<h3>Mirage</h3>

<p>Now lets get Mirage up and running. Install ocaml, opam and set up the opam environment:</p>
<pre class="console"><code class="console">$ sudo apt-get install ocaml opam ocaml-native-compilers camlp4-extra
...
$ opam init
...
$ eval `opam config env`</code></pre>

<p>Don't forget the <code>ocaml-native-compilers</code>, as without this we can't
compile the unikernels. Now we are almost ready to install Mirage; we
need two more dependencies, and then we're good to go.</p>
<pre class="console"><code class="console">$ sudo apt-get install m4 libxen-dev
$ opam install mirage mirage-xen mirage-unix vchan</code></pre>

<p>Where <code>m4</code> is for ocamlfind, and <code>libxen-dev</code> is required to compile the
unix variants of the <code>xen-evtchn</code> and <code>xen-gnt</code> libraries. Without these
installing vchan will complain that there is no <code>xen-evtchn.lwt</code>
library installed.</p>
<p>This second line installs the various Mirage and vchan libraries, but
doesn't build the demo unikernel and Unix CLI.  To get them, clone
the ocaml-vchan repository:</p>
<pre class="console"><code class="console">$ git clone https://github.com/mirage/ocaml-vchan</code></pre>

<p>The demo unikernel is a very straightforward capitalizing echo server.
The <a href="https://github.com/mirage/ocaml-vchan/blob/master/test/echo.ml#L13">main function</a> simply consists of</p>
<pre class="ocaml"><code class="ocaml">let (&gt;&gt;=) = Lwt.bind

let (&gt;&gt;|=) m f = m &gt;&gt;= function
| `Ok x -&gt; f x
| `Eof -&gt; Lwt.fail (Failure &quot;End of file&quot;)
| `Error (`Not_connected state) -&gt;
    Lwt.fail (Failure (Printf.sprintf &quot;Not in a connected state: %s&quot;
      (Sexplib.Sexp.to_string (Node.V.sexp_of_state state))))

let rec echo vch =
  Node.V.read vch &gt;&gt;|= fun input_line -&gt;
  let line = String.uppercase (Cstruct.to_string input_line) in
  let buf = Cstruct.create (String.length line) in
  Cstruct.blit_from_string line 0 buf 0 (String.length line);
  Node.V.write vch buf &gt;&gt;|= fun () -&gt;
  echo vch</code></pre>

<p>where we've defined an error-handling monadic bind (<code>&gt;&gt;|=</code>) which
is then used to sequence the read and write operations.</p>
<p>Building the CLI is done simply via <code>make</code>.</p>
<pre class="console"><code class="console">$ make
...
$ ls -l node_cli.native
lrwxrwxrwx 1 jludlam jludlam 52 Jul 14 14:56 node_cli.native -&gt; /home/jludlam/ocaml-vchan/_build/cli/node_cli.native</code></pre>

<p>Building the unikernel is done via the <code>mirage</code> tool:</p>
<pre class="console"><code class="console">$ cd test
$ mirage configure --xen
...
$ make depend
...
$ make
...
$ ls -l mir-echo.xen echo.xl
-rw-rw-r-- 1 jludlam jludlam     596 Jul 14 14:58 echo.xl
-rwxrwxr-x 1 jludlam jludlam 3803982 Jul 14 14:59 mir-echo.xen</code></pre>

<p>This make both the unikernel binary (the mir-echo.xen file) and a convenient
xl script to run it. To run, we use the xl tool, passing '-c' to connect
directly to the console so we can see what's going on:</p>
<pre class="console"><code class="console">$ sudo xl create -c echo.xl
Parsing config from echo.xl
kernel.c: Mirage OS!
kernel.c:   start_info: 0x11cd000(VA)
kernel.c:     nr_pages: 0x10000
kernel.c:   shared_inf: 0xdf2f6000(MA)
kernel.c:      pt_base: 0x11d0000(VA)
kernel.c: nr_pt_frames: 0xd
kernel.c:     mfn_list: 0x114d000(VA)
kernel.c:    mod_start: 0x0(VA)
kernel.c:      mod_len: 0
kernel.c:        flags: 0x0
kernel.c:     cmd_line:
x86_setup.c:   stack:      0x144f40-0x944f40
mm.c: MM: Init
x86_mm.c:       _text: 0x0(VA)
x86_mm.c:      _etext: 0xb8eec(VA)
x86_mm.c:    _erodata: 0xde000(VA)
x86_mm.c:      _edata: 0x1336f0(VA)
x86_mm.c: stack start: 0x144f40(VA)
x86_mm.c:        _end: 0x114d000(VA)
x86_mm.c:   start_pfn: 11e0
x86_mm.c:     max_pfn: 10000
x86_mm.c: Mapping memory range 0x1400000 - 0x10000000
x86_mm.c: setting 0x0-0xde000 readonly
x86_mm.c: skipped 0x1000
mm.c: MM: Initialise page allocator for 0x1256000 -&gt; 0x10000000
mm.c: MM: done
x86_mm.c: Pages to allocate for p2m map: 2
x86_mm.c: Used 2 pages for map
x86_mm.c: Demand map pfns at 10001000-2010001000.
Initialising timer interface
Initializing Server domid=0 xs_path=data/vchan
gnttab_stubs.c: gnttab_table mapped at 0x10001000
Server: right_order = 13, left_order = 13
allocate_buffer_locations: gntref = 9
allocate_buffer_locations: gntref = 10
allocate_buffer_locations: gntref = 11
allocate_buffer_locations: gntref = 12
Writing config into the XenStore
Shared page is:

00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0d 00 0d 00 02 01 01 00 09 00 00 00 0a 00 00 00
0b 00 00 00 0c 00 00 00
Initialization done!</code></pre>

<p>Vchan is domain-to-domain communication, and relies on Xen's grant
tables to share the memory. The entries in the grant tables have
domain-level access control, so we need to know the domain ID of the
client and server in order to set up the communications. The test
unikernel server is hard-coded to talk to domain 0, so we only need to
know the domain ID of our echo server. In another terminal,</p>
<pre class="console"><code class="console">$ sudo xl list
Name                                        ID   Mem VCPUs      State   Time(s)
Domain-0                                     0  4095     6     r-----    1602.9
echo                                         2   256     1     -b----       0.0</code></pre>

<p>In this case, the domain ID is 2, so we invoke the CLI as follows:</p>
<pre class="console"><code class="console">$ sudo ./node_cli.native 2
Client initializing: Received gntref = 8, evtchn = 4
Mapped the ring shared page:

00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0d 00 0d 00 02 01 01 00 09 00 00 00 0a 00 00 00
0b 00 00 00 0c 00 00 00
Correctly bound evtchn number 71</code></pre>

<p>We're now connected via vchan to the Mirage domain. The test server
is simply a capitalisation service:</p>
<pre class="console"><code class="console">hello from dom0
HELLO FROM DOM0</code></pre>

<p>Ctrl-C to get out of the CLI, and destroy the domain with an <code>xl destroy</code>:</p>
<pre class="console"><code class="console">$ sudo xl destroy test</code></pre>

<p><code>vchan</code> is a very low-level communication mechanism, and so our next post on
this topic will address how to use it in combination with a name resolver
to intelligently map connection requests to use <code>vchan</code> if available, and
otherwise fall back to normal TCP or TCP+TLS.</p>

   <a onclick="switchContent('ocamlorg-post36','ocamlorg-post35')" class="btn planet-toggle" href="#http://openmirage.org/blog/update-on-vchan">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/update-on-vchan">by Jon Ludlam at Jul 16, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/modular-foreign-function-bindings">
    <a name="#http://openmirage.org/blog/modular-foreign-function-bindings"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/modular-foreign-function-bindings">Modular foreign function bindings</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post37">
      <p>One of the most frequent questions about MirageOS from developers is
&quot;do I really need to write all my code in OCaml&quot;?  There are, of
course, very good reasons to build the core system in pure OCaml: the
module system permits reusing algorithmic abstractions at scale, and
OCaml's static type checking makes it possible to enforce lightweight
invariants across interfaces.  However, it's ultimately necessary to
support interfacing to existing code, and this blog post will describe
what we're doing to make this possible this without sacrificing the
security benefits afforded by unikernels.</p>
<p>A MirageOS application works by abstracting the <em>logic</em> of the
application from the details of <em>platform</em> that it is compiled for.
The <code>mirage</code> CLI tool parses a configuration file that represents the
desired hardware target, which can be a Unix binary or a specialized
Xen guest OS.  Our foreign function interface design elaborates on
these design principles by separating the <em>description</em> of the C
foreig&hellip;</p><a onclick="switchContent('ocamlorg-post37','ocamlorg-post38')" class="btn planet-toggle" href="#http://openmirage.org/blog/modular-foreign-function-bindings">Read more...</a></div><div id="ocamlorg-post38" style="display: none">
      <p>One of the most frequent questions about MirageOS from developers is
&quot;do I really need to write all my code in OCaml&quot;?  There are, of
course, very good reasons to build the core system in pure OCaml: the
module system permits reusing algorithmic abstractions at scale, and
OCaml's static type checking makes it possible to enforce lightweight
invariants across interfaces.  However, it's ultimately necessary to
support interfacing to existing code, and this blog post will describe
what we're doing to make this possible this without sacrificing the
security benefits afforded by unikernels.</p>
<p>A MirageOS application works by abstracting the <em>logic</em> of the
application from the details of <em>platform</em> that it is compiled for.
The <code>mirage</code> CLI tool parses a configuration file that represents the
desired hardware target, which can be a Unix binary or a specialized
Xen guest OS.  Our foreign function interface design elaborates on
these design principles by separating the <em>description</em> of the C
foreign functions from how we <em>link</em> to that code.  For instance, a
Unix unikernel could use the normal <code>ld.so</code> to connect to a shared
library, while in Xen we would need to interface to that C library
through some other mechanism (for instance, a separate VM could be
spawned to run the untrusted OpenSSL code).  If you're curious about
how this works, this blog post is for you!</p>
<h3>Introducing ctypes</h3>

<p><a href="https://github.com/ocamllabs/ocaml-ctypes">ocaml-ctypes</a> (&quot;ctypes&quot; for short) is a library for
gluing together OCaml code and C code without writing any C.  This
post introduces the ctypes library with a couple of simple examples,
and outlines how OCaml's module system makes it possible to write
high-level bindings to C that are independent of any particular
linking mechanism.</p>
<h3>Hello, C</h3>

<p>Binding a C function using ctypes involves two steps.</p>
<ul><li>First, construct an OCaml value that represents the type of the function</li><li>Second, use the type representation and the function name to resolve and bind the function</li></ul>

<p>For example, here's a binding to C's <code>puts</code> function, which prints a string to
standard output and returns the number of characters written:</p>
<pre class="ocaml"><code class="ocaml">let puts = foreign &quot;puts&quot; (string @-&gt; returning int)</code></pre>

<p>After the call to <code>foreign</code> the bound function is available to OCaml
immediately.  Here's a call to <code>puts</code> from the interactive top level:</p>
<pre class="ocaml"><code class="ocaml"># puts &quot;Hello, world&quot;;;
Hello, world
- : int = 13</code></pre>

<h3>&lt;Hello-C/&gt;</h3>

<p>Now that we've had a taste of ctypes, let's look at a more realistic
example: a program that defines bindings to the <a href="http://www.libexpat.org/">expat</a> XML
parsing library, then uses them to display the structure of an XML
document.</p>
<p>We'll start by describing the types used by expat.  Since ctypes
represents C types as OCaml values, each of the types we need becomes
a value binding in our OCaml program.  The parser object involves an
incomplete (abstract) struct definition and a typedef for a pointer to
a struct:</p>
<pre class="C"><code class="C">struct xml_ParserStruct;
typedef xml_ParserStruct *xml_Parser;</code></pre>

<p>In ctypes these become calls to the <code>structure</code> and <code>ptr</code> functions:</p>
<pre class="ocaml"><code class="ocaml">let parser_struct : [`XML_ParserStruct] structure typ = structure &quot;xml_ParserStruct&quot;
let xml_Parser = ptr parser_struct</code></pre>

<p>Next, we'll use the type representations to bind some functions.  The
<a href="http://www.xml.com/pub/a/1999/09/expat/reference.html#parsercreate"><code>XML_ParserCreate</code></a>
and
<a href="http://www.xml.com/pub/a/1999/09/expat/reference.html#parserfree"><code>XML_ParserFree</code></a>
functions construct and destroy parser objects.  As with <code>puts</code>, each
function binding involves a simple call to <code>foreign</code>:</p>
<pre class="ocaml"><code class="ocaml">let parser_create = foreign &quot;XML_ParserCreate&quot;
  (ptr void @-&gt; returning xml_Parser)
let parser_free = foreign &quot;XML_ParserFree&quot;
  (xml_Parser @-&gt; returning void)</code></pre>

<p>Expat operates primarily through callbacks: when start and end elements are
encountered the parser invokes user-registered functions, passing the tag names
and attributes (along with a piece of user data):</p>
<pre class="C"><code class="C">typedef void (*start_handler)(void *, char *, char **);
typedef void (*end_handler)(void *, char *);</code></pre>

<p>In ctypes function pointer types are built using the <code>funptr</code> function:</p>
<pre class="ocaml"><code class="ocaml">let start_handler =
  funptr (ptr void @-&gt; string @-&gt; ptr string @-&gt; returning void)
let end_handler =
  funptr (ptr void @-&gt; string @-&gt; returning void)</code></pre>

<p>We can use the <code>start_handler</code> and <code>end_handler</code> type representations to bind
<a href="http://www.xml.com/pub/a/1999/09/expat/reference.html#elementhandler"><code>XML_SetElementHandler</code></a>, the callback-registration function:</p>
<pre class="ocaml"><code class="ocaml">let set_element_handler = foreign &quot;XML_SetElementHandler&quot;
  (xml_Parser @-&gt; start_handler @-&gt; end_handler @-&gt; returning void)</code></pre>

<p>The type that OCaml infers for <code>set_element_handler</code> reveals that the function
accepts regular OCaml functions as arguments, since the argument types are
normal OCaml function types:</p>
<pre class="ocaml"><code class="ocaml">val set_element_handler :
  [ `XML_ParserStruct ] structure ptr -&gt;
  (unit ptr -&gt; string -&gt; string ptr -&gt; unit) -&gt;
  (unit ptr -&gt; string -&gt; unit) -&gt; unit</code></pre>

<p>There's one remaining function to bind, then we're ready to use the
library.  The
<a href="http://www.xml.com/pub/a/1999/09/expat/reference.html#parse"><code>XML_Parse</code></a>
function performs the actual parsing, invoking the callbacks when tags
are encountered:</p>
<pre class="ocaml"><code class="ocaml">let parse = foreign &quot;XML_Parse&quot;
  (xml_Parser @-&gt; string @-&gt; int @-&gt; int @-&gt; returning int)</code></pre>

<p>As before, all the functions that we've bound are available for use
immediately.  We'll start by using them to define a more idiomatic OCaml entry
point to the library.  The <code>parse_string</code> function accepts the start and end
callbacks as labelled arguments, along with a string to parse:</p>
<pre class="ocaml"><code class="ocaml">let parse_string ~start_handler ~end_handler s =
  let p = parser_create null in
  let () = set_element_handler p start_handler end_handler in
  let _ = parse p s (String.length s) 1 in
  parser_free p</code></pre>

<p>Using <code>parse_string</code> we can write a program that prints out the names of each
element in an XML document, indented according to nesting depth:</p>
<pre class="ocaml"><code class="ocaml">let depth = ref 0

let start_handler _ name _ =
  Printf.printf &quot;%*s%s\n&quot; (!depth * 3) &quot;&quot; name;
  incr depth

let end_handler _ _ =
  decr depth

let () =
  parse_string ~start_handler ~end_handler (In_channel.input_all stdin)</code></pre>

<p>The full source of the program is <a href="https://github.com/yallop/ocaml-ctypes-expat-example">available on github</a>.</p>
<p>Here's the program in action:</p>
<pre class="bash"><code class="bash">$ ocamlfind opt -thread -package core,ctypes.foreign expat_example.ml \
   -linkpkg -cclib -lexpat -o expat_example
$ wget -q http://openmirage.org/blog/atom.xml -O /dev/stdout \
  | ./expat_example
feed
   id
   title
   subtitle
   rights
   updated
   link
   link
   contributor
      email
      uri
      name
[...]</code></pre>

<p>Since this is just a high-level overview we've passed over a number of
details.  The interested reader can find a more comprehensive introduction to
using ctypes in <a href="https://realworldocaml.org/v1/en/html/foreign-function-interface.html">Chapter 19: Foreign Function Interface</a> of <a href="https://realworldocaml.org">Real World OCaml</a>.</p>
<h3>Dynamic vs static</h3>

<p>Up to this point we've been using a single function, <code>foreign</code>, to
make C functions available to OCaml.  Although <code>foreign</code> is simple to
use, there's quite a lot going on behind the scenes.  The two
arguments to <code>foreign</code> are used to dynamically construct an OCaml
function value that wraps the C function: the name is used to resolve
the code for the C function, and the type representation is used to
construct a call frame appropriate to the C types invovled and to the
underlying platform.</p>
<p>The dynamic nature of <code>foreign</code> that makes it convenient for
interactive use, also makes it unsuitable for some environments.
There are three main drawbacks:</p>
<ul><li><p>Binding functions dynamically involves a certain loss of <em>safety</em>:
 since C libraries typically don't maintain information about the
 types of the functions they contain, there's no way to check whether
 the type representation passed to <code>foreign</code> matches the actual type of
 the C function.</p>
</li><li><p>Dynamically constructing calls introduces a certain <em>interpretative
 overhead</em>.  In mitigation, this overhead is much less than might be supposed,
 since much of the work can be done when the function is bound rather than
 when the call is made, and <code>foreign</code> has been used to bind C functions in
 <a href="http://erratique.ch/software/tgls">performance-sensitive applications</a> without problems.</p>
</li><li><p>The implementation of <code>foreign</code> uses a low-level library, <a href="https://sourceware.org/libffi/">libffi</a>,
 to deal with calling conventions across platforms.  While libffi is mature
 and widely supported, it's not appropriate for use in every environment.
 For example, introducing such a (relatively) large and complex library into
 Mirage would compromise many of the benefits of writing the rest of the
 system in OCaml.</p>
</li></ul>

<p>Happily, there's a solution at hand.  As the introduction hints, <code>foreign</code> is
one of a number of binding strategies, and OCaml's module system makes it easy
to defer the choice of which strategy to use when writing the actual code.
Placing the <code>expat</code> bindings in a functor (parameterised module) makes it
possible to abstract over the linking strategy:</p>
<pre class="ocaml"><code class="ocaml">module Bindings(F : FOREIGN) =
struct
  let parser_create = F.foreign &quot;XML_ParserCreate&quot;
    (ptr void @-&gt; returning xml_Parser)
  let parser_free = F.foreign &quot;XML_ParserFree&quot;
    (xml_Parser @-&gt; returning void)
  let set_element_handler = F.foreign &quot;XML_SetElementHandler&quot;
    (xml_Parser @-&gt; start_handler @-&gt; end_handler @-&gt; returning void)
  let parse = F.foreign &quot;XML_Parse&quot;
    (xml_Parser @-&gt; string @-&gt; int @-&gt; int @-&gt; returning int)
end</code></pre>

<p>The <code>Bindings</code> module accepts a single parameter of type <code>FOREIGN</code>, which
encodes the binding strategy to use.  Instantiating <code>Bindings</code> with a module
containing the <code>foreign</code> function used above recovers the
dynamically-constructed bindings that we've been using so far.  However, there
are now other possibilities available.  In particular, we can instantiate
<code>Bindings</code> with code generators that output code to expose the bound functions
to OCaml.  The actual instantiation is hidden behind a couple of convenient
functions, <code>write_c</code> and <code>write_ml</code>, which accept <code>Bindings</code> as a parameter
and write to a <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Format.html#TYPEformatter">formatter</a>:</p>
<pre class="ocaml"><code class="ocaml">Cstubs.write_c formatter ~prefix:&quot;expat&quot; ~bindings:(module Bindings)
Cstubs.write_ml formatter ~prefix:&quot;expat&quot; ~bindings:(module Bindings)</code></pre>

<p>Generating code in this way eliminates the concerns associated with
constructing calls dynamically:</p>
<ul><li><p>The C compiler checks the types of the generated calls against the C
 headers (the API), so the safety concerns associated with linking
 directly against the C library binaries (the ABI) don't apply.</p>
</li><li><p>There's no interpretative overhead, since the generated code is
 (statically) compiled.</p>
</li><li><p>The dependency on libffi disappears altogether.</p>
</li></ul>

<p>How easy is it in practice to switch between dynamic and static
binding strategies?  It turns out that it's quite straightforward,
even for code that was originally written without parameterisation.
Bindings written using early releases of ctypes used the dynamic
strategy exclusively, since dynamic binding was then the only option
available.  The commit logs for projects that switched over to static
generation and linking (e.g. <a href="https://github.com/whitequark/ocaml-lz4/commit/acc257ea1">ocaml-lz4</a> and
<a href="https://github.com/janestreet/async_ssl/commit/ab5ea6f55e">async-ssl</a>) when it became available show that
moving to the new approach involved only straightforward and localised
changes.</p>
<h3>Local vs remote</h3>

<p>Generating code is safer than constructing calls dynamically, since it
allows the C compiler to check the types of function calls against
declarations.  However, there are some safety problems that even C's
type checking doesn't detect.  For instance, the following call is
type correct (given suitable definitions of <code>p</code> and <code>q</code>), but is
likely to misbehave at run time:</p>
<pre class="C"><code class="C">memcpy(p, q, SIZE_MAX)</code></pre>

<p>In contrast, code written purely in OCaml detects and prevents
attempts to write beyond the bounds of allocated objects:</p>
<pre class="ocaml"><code class="ocaml"># StringLabels.blit ~src ~dst ~src_pos:0 ~dst_pos:0 ~len:max_int;;
Exception: Invalid_argument &quot;String.blit&quot;.</code></pre>

<p>It seems a shame to weaken OCaml's safety guarantees by linking in C
code that can potentially write to any region of memory, but what is
the alternative?</p>
<p>One possibility is to use <a href="http://en.wikipedia.org/wiki/Privilege_separation">privilege separation</a> to separate
trusted OCaml code from untrusted C functions.  The modular design of
ctypes means that privilege separation can be treated as one more
linking strategy: we can run C code in an entirely separate process
(or for Mirage/Xen, in a separate virtual machine), and instantiate
<code>Bindings</code> with a strategy that forwards calls to the process using
standard inter-process communication.  The remote calling strategy is
not supported in the <a href="https://github.com/ocamllabs/ocaml-ctypes/releases/tag/0.3.2">current release</a> of ctypes, but
it's scheduled for a future version.  As with the switch from dynamic
to static bindings, we anticipate that updating existing bindings to
use cross-process calls will be straightforward.</p>
<p>This introductory post should give you a sense of the power of the unikernel
approach in Mirage.  By turning the FFI into just another library (for the C
interface description) and protocol (for the linkage model), we can use code
generation to map application logic onto the privilege model most suitable for
the target hardware platform.  This starts with Unix processes, continues onto Xen
paravirtualization, and could even extend into <a href="http://www.cl.cam.ac.uk/research/security/ctsrd/cheri/">CHERI</a> fine-grained
compartmentalization.</p>
<h3>Further examples</h3>

<p>Although ctypes is a fairly new library, it's already in use in a
number of projects across a variety of domains: <a href="http://erratique.ch/software/tgls">graphics</a>,
<a href="http://erratique.ch/software/tsdl">multimedia</a>, <a href="https://github.com/whitequark/ocaml-lz4">compression</a>, <a href="https://github.com/dsheets/ocaml-sodium">cryptography</a>,
<a href="https://github.com/nojb/ocaml-gsasl">security</a>, <a href="https://github.com/hcarty/ocaml-gdal">geospatial data</a>, <a href="http://github.com/rgrinberg/onanomsg">communication</a>,
and many others.  Further resources (documentation, forums, etc.) are
available via the <a href="https://github.com/ocamllabs/ocaml-ctypes">home page</a>.</p>

   <a onclick="switchContent('ocamlorg-post38','ocamlorg-post37')" class="btn planet-toggle" href="#http://openmirage.org/blog/modular-foreign-function-bindings">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/modular-foreign-function-bindings">by Jeremy Yallop at Jul 15, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">
    <a name="#http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">OCaml-TLS: the protocol implementation and mitigations to known attacks</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post39">
      <p><em>This is the fifth in a series of posts that introduce new libraries for a pure OCaml implementation of TLS.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-ocaml-tls">introduction</a>.</em></p>
<p><a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a> is the new, clean-slate implementation of TLS in OCaml
that we've been working on for the past six months. In this post we
try to document some of its internal design, the reasons for the
decisions we made, and the current security status of that work. Try
our <a href="https://tls.openmirage.org">live interactive demonstration server</a> which visualises TLS
sessions.</p>
<h3>The OCaml-TLS architecture</h3>

<p>The OCaml ecosystem has several distinct ways of interacting with the outside world
(and the network in particular): straightforward <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Unix.html">unix</a> interfaces
and the asynchronous programming libraries <a href="http://ocsigen.org/lwt/">lwt</a> and <a href="https://realworldocaml.org/v1/en/html/concurrent-programming-with-async.html">async</a>. One of the
early considerations was not to restrict ourselves to any of those -- we wanted
to support them all.</p>
<p>There were also two distinct basic &quot;platforms&quot; we wanted to target from the
outset: the case of a simple executable, and the case of <code>Mirage</code> unikernels.</p><a onclick="switchContent('ocamlorg-post39','ocamlorg-post40')" class="btn planet-toggle" href="#http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">Read more...</a></div><div id="ocamlorg-post40" style="display: none">
      <p><em>This is the fifth in a series of posts that introduce new libraries for a pure OCaml implementation of TLS.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-ocaml-tls">introduction</a>.</em></p>
<p><a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a> is the new, clean-slate implementation of TLS in OCaml
that we've been working on for the past six months. In this post we
try to document some of its internal design, the reasons for the
decisions we made, and the current security status of that work. Try
our <a href="https://tls.openmirage.org">live interactive demonstration server</a> which visualises TLS
sessions.</p>
<h3>The OCaml-TLS architecture</h3>

<p>The OCaml ecosystem has several distinct ways of interacting with the outside world
(and the network in particular): straightforward <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Unix.html">unix</a> interfaces
and the asynchronous programming libraries <a href="http://ocsigen.org/lwt/">lwt</a> and <a href="https://realworldocaml.org/v1/en/html/concurrent-programming-with-async.html">async</a>. One of the
early considerations was not to restrict ourselves to any of those -- we wanted
to support them all.</p>
<p>There were also two distinct basic &quot;platforms&quot; we wanted to target from the
outset: the case of a simple executable, and the case of <code>Mirage</code> unikernels.</p>
<p>So one of the first questions we faced was deciding how to represent
interactions with the network in a portable way. This can be done by
systematically abstracting out the API boundary which gives access to network
operations, but we had a third thing in mind as well: we wanted to exploit the
functional nature of OCaml to its fullest extent!</p>
<p>Our various prior experiences with Haskell and Idris convinced us to adopt
what is called &quot;purely functional&quot; technique. We believe it to be an approach
which first forces the programmer to give principled answers to all the
difficult design questions (errors and global data-flow) <em>in advance</em>, and then
leads to far cleaner and composable code later on. A purely functional system
has all the data paths made completely explicit in the form of function
arguments and results. There are no unaccounted-for interactions between
components mediated by shared state, and all the activity of the parts of the
system is exposed through types since, after all, it's only about computing
values from values.</p>
<p>For these reasons, the library is split into two parts: the directory <code>/lib</code>
(and the corresponding findlib package <code>tls</code>) contains the core TLS logic, and
<code>/mirage</code> and <code>/lwt</code> (packaged as <code>tls.mirage</code> and <code>tls.lwt</code> respectively)
contain front-ends that tie the core to <code>Mirage</code> and <code>Lwt_unix</code>.</p>
<h3>Core</h3>

<p>The <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.mli">core</a> library is purely functional. A TLS session is represented by the
abstract type <code>Tls.Engine.state</code>, and various functions consume this session
type together with raw bytes (<code>Cstruct.t</code> -- which is by itself mutable, but
<code>ocaml-tls</code> eschews this) and produce new session values and resulting buffers.</p>
<p>The central entry point is <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.ml#L321">handle_tls</a>, which transforms an input state and a
buffer to an output state, a (possibly empty) buffer to send to the
communication partner, and an optional buffer of data intended to be received by
the application:</p>
<pre class="OCaml"><code class="OCaml">type state

type ret = [
  | `Ok of [ `Ok of state | `Eof | `Alert of alert ] *
      [ `Response of Cstruct.t ] * [ `Data of Cstruct.t option ]
  | `Fail of alert * [ `Response of Cstruct.t ]
]

val handle_tls : state -&gt; Cstruct.t -&gt; ret</code></pre>

<p>As the signature shows, errors are signalled through the <code>ret</code> type, which is a <a href="https://realworldocaml.org/v1/en/html/variants.html#polymorphic-variants">polymorphic variant</a>. This
reflects the actual internal structure: all the errors are represented as
values, and operations are composed using an error <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/control.ml">monad</a>.</p>
<p>Other entry points share the same basic behaviour: they transform the prior
state and input bytes into the later state and output bytes.</p>
<p>Here's a rough outline of what happens in <code>handle_tls</code>:</p>
<ul><li><p>TLS packets consist of a header, which contains the protocol
 version, length, and content type, and the payload of the given
 content type. Once inside our <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.ml#L321">main handler</a>, we
 <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.ml#L150">separate</a> the buffer into TLS records, and
 <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.ml#L275">process</a> each individually. We first check that
 the version number is correct, then <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.ml#L95">decrypt</a>, and <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.ml#L85">verify
  the mac</a>.</p>
</li><li><p>Decrypted data is then <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.ml#L240">dispatched</a> to one of four
 sub-protocol handlers (Handshake, Change Cipher Spec, Alert and
 Application Data). Each handler can <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/state.ml#L109">return</a> a new
 handshake state, outgoing data, application data, the new decryption
 state or an error (with the outgoing data being an interleaved list
 of buffers and new encryption states).</p>
</li><li><p>The outgoing buffers and the encryption states are
 <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.ml#L48">traversed</a> to produce the final output to be sent to the
 communication partner, and the final encryption, decryption and
 handshake states are combined into a new overall state which is
 returned to the caller.</p>
</li></ul>

<p>Handshake is (by far) the most complex TLS sub-protocol, with an elaborate state
machine. Our <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/handshake_client.ml#L285">client</a> and <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/handshake_server.ml#L247">server</a> encode
this state as a &quot;flat&quot; <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/state.ml#L61">sum type</a>, with exactly one incoming
message allowed per state. The handlers first <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/reader.ml#L361">parse</a> the
handshake packet (which fails in case of malformed or unknown data) and then
dispatch it to the handling function. The <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/state.ml#L92">handshake state</a> is
carried around and a fresh one is returned from the handler in case it needs
updates. It consists of a protocol version, the handshake state, configuration,
renegotiation data, and possibly a handshake fragment.</p>
<p>Logic of both handshake handlers is very localised, and does not mutate any
global data structures.</p>
<h3>Core API</h3>

<p>OCaml permits the implementation a module to be exported via a more
abstract <em>signature</em> that hides the internal representation
details. Our public API for the core library consists of the
<a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/engine.mli">Tls.Engine</a> and <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/config.mli">Tls.Config</a> modules.</p>
<p><code>Tls.Engine</code> contains the basic reactive function <code>handle_tls</code>, mentioned above,
which processes incoming data and optionally produces a response, together with
several operations that allow one to initiate message transfer like
<code>send_application_data</code> (which processes application-level messages for
sending), <code>send_close_notify</code> (for sending the ending message) and <code>reneg</code>
(which initiates full TLS renegotiation).</p>
<p>The module also contains the only two ways to obtain the initial state:</p>
<pre class="OCaml"><code class="OCaml">val client : Config.client -&gt; (state * Cstruct.t)
val server : Config.server -&gt; state</code></pre>

<p>That is, one needs a configuration value to create it. The <code>Cstruct.t</code>
that <code>client</code> emits is the initial Client Hello since in TLS,
the client starts the session.</p>
<p><code>Tls.Config</code> synthesizes configurations, separately for client and server
endpoints, through the functions <code>client_exn</code> and <code>server_exn</code>. They take a
number of parameters that define a TLS session, check them for consistency, and
return the sanitized <code>config</code> value which can be used to create a <code>state</code> and,
thus, a session. If the check fails, they raise an exception.</p>
<p>The parameters include the pair of a certificate and its private key for the
server, and an <code>X509.Authenticator.t</code> for the client, both produced by our
<a href="https://github.com/mirleft/ocaml-x509">ocaml-x509</a> library and described in a <a href="http://openmirage.org/blog/introducing-x509">previous article</a>.</p>
<p>This design reflects our attempts to make the API as close to &quot;fire and forget&quot;
as we could, given the complexity of TLS: we wanted the library to be relatively
straightforward to use, have a minimal API footprint and, above all, fail very
early and very loudly when misconfigured.</p>
<h3>Effectful front-ends</h3>

<p>Clearly, reading and writing network data <em>does</em> change the state of the world.
Having a pure value describing the state of a TLS session is not really useful
once we write something onto the network; it is certainly not the case that we
can use more than one distinct <code>state</code> to process further data, as only one
value is in sync with the other endpoint at any given time.</p>
<p>Therefore we wrap the core types into stateful structures loosely inspired by
sockets and provide IO operations on those. The structures of <code>mirage</code> and <code>lwt</code>
front-ends mirror one another.</p>
<p>In both cases, the structure is pull-based in the sense that no processing is
done until the client requires a read, as opposed to a callback-driven design
where the client registers a callback and the library starts spinning in a
listening loop and invoking it as soon as there is data to be processed. We do
this because in an asynchronous context, it is easy to create a callback-driven
interface from a demand-driven one, but the opposite is possible only with
unbounded buffering of incoming data.</p>
<p>One exception to demand-driven design is the initial session creation: the
library will only yield the connection after the first handshake is over,
ensuring the invariant that it is impossible to interact with a connection if it
hasn't already been fully established.</p>
<p><strong>Mirage</strong></p>
<p>The <code>Mirage</code> <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/mirage/tls_mirage_types.mli">interface</a> matches the <a href="https://github.com/mirage/mirage/blob/ae3c966f8d726dc97208595b8005e02e39478cb1/types/V1.mli#L136">FLOW</a>
signature (with additional TLS-specific operations). We provide a functor that
needs to be applied to an underlying TCP module, to obtain a TLS transport on
top. For example:</p>
<pre class="OCaml"><code class="OCaml">module Server (Stack: STACKV4) (Entropy: ENTROPY) (KV: KV_RO) =
struct

  module TLS  = Tls_mirage.Make (Stack.TCPV4) (Entropy)
  module X509 = Tls_mirage.X509 (KV) (Clock)

  let accept conf flow =
    TLS.server_of_tcp_flow conf flow &gt;&gt;= function
    | `Ok tls -&gt;
      TLS.read tls &gt;&gt;= function
      | `Ok buf -&gt;
        TLS.write tls buf &gt;&gt;= fun () -&gt; TLS.close buf

  let start stack e kv =
    TLS.attach_entropy e &gt;&gt;= fun () -&gt;
    lwt authenticator = X509.authenticator kv `Default in
    let conf          = Tls.Config.server_exn ~authenticator () in
    Stack.listen_tcpv4 stack 4433 (accept conf) ;
    Stack.listen stack

end</code></pre>

<p><strong>Lwt</strong></p>
<p>The <code>lwt</code> interface has <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lwt/tls_lwt.mli">two layers</a>. <code>Tls_lwt.Unix</code> is loosely based
on read/write operations from <code>Lwt_unix</code> and provides in-place update of
buffers. <code>read</code>, for example, takes a <code>Cstruct.t</code> to write into and returns the
number of bytes read. The surrounding module, <code>Tls_lwt</code>, provides a simpler,
<code>Lwt_io</code>-compatible API built on top:</p>
<pre class="OCaml"><code class="OCaml">let main host port =
  Tls_lwt.rng_init () &gt;&gt;= fun () -&gt;
  lwt authenticator = X509_lwt.authenticator (`Ca_dir nss_trusted_ca_dir) in
  lwt (ic, oc)      = Tls_lwt.connect ~authenticator (host, port) in
  let req = String.concat &quot;\r\n&quot; [
    &quot;GET / HTTP/1.1&quot; ; &quot;Host: &quot; ^ host ; &quot;Connection: close&quot; ; &quot;&quot; ; &quot;&quot;
  ] in
  Lwt_io.(write oc req &gt;&gt;= fun () -&gt; read ic &gt;&gt;= print)</code></pre>

<p>We have further plans to provide wrappers for <a href="https://realworldocaml.org/v1/en/html/concurrent-programming-with-async.html">`Async`</a> and plain <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Unix.html">`Unix`</a> in a
similar vein.</p>
<h3>Attacks on TLS</h3>

<p>TLS the most widely deployed security protocol on the Internet and, at
over 15 years, is also showing its age. As such, a flaw is a valuable
commodity due to the commercially sensitive nature of data that is
encrypted with TLS. Various vulnerabilities on different layers of TLS
have been found - <a href="https://en.wikipedia.org/wiki/Heartbleed">heartbleed</a> and others are implementation
specific, advancements in cryptanalysis such as <a href="http://eprint.iacr.org/2005/067">collisions of
MD5</a> lead to vulnerabilities, and even others are due
to incorrect usage of TLS (<a href="http://www.theregister.co.uk/2013/08/01/gmail_hotmail_hijacking/">truncation attack</a> or
<a href="http://breachattack.com/">BREACH</a>). Finally, some weaknesses are in the protocol
itself. Extensive <a href="http://eprint.iacr.org/2013/049.pdf">overviews</a> of <a href="http://www.mitls.org/wsgi/tls-attacks">attacks on
TLS</a> are available.</p>
<p>We look at protocol level attacks of TLS and how <a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a>
implements mitigations against these.  <a href="https://tools.ietf.org/html/rfc5246#appendix-D.4">TLS 1.2 RFC</a> provides an
overview of attacks and mitigations, and we <a href="https://github.com/mirleft/ocaml-tls/issues/31">track</a> our progress in
covering them. This is slightly out of date as the RFC is roughly six years old and
in the meantime more attacks have been published, such as the <a href="http://www.educatedguesswork.org/2009/11/understanding_the_tls_renegoti.html">renegotiation
flaw</a>.</p>
<p>As <a href="http://openmirage.org/blog/introducing-ocaml-tls">already mentioned</a>, we track all our
<a href="https://github.com/mirleft/ocaml-tls/issues?labels=security%20concern&amp;page=1&amp;state=closed">mitigated</a> and <a href="https://github.com/mirleft/ocaml-tls/issues?labels=security%20concern&amp;page=1&amp;state=open">open</a> security issues on our GitHub
issue tracker.</p>
<p>Due to the choice of using OCaml, a memory managed programming
language, we obstruct entire bug classes, namely temporal and spatial
memory safety.</p>
<p>Cryptanalysis and improvement of computational power weaken some
ciphers, such as RC4 and 3DES (see <a href="https://github.com/mirleft/ocaml-tls/issues/8">issue 8</a> and <a href="https://github.com/mirleft/ocaml-tls/issues/10">issue
10</a>). If we phase these two ciphers out, there wouldn't be
any matching ciphersuite left to communicate with some compliant TLS-1.0
implementations, such as Windows XP, that do not support AES.</p>
<p><strong>Timing attacks</strong></p>
<p>When the timing characteristics between the common case and the error
case are different, this might potentially leak confidential
information. Timing is a very prominent side-channel and there are a huge
variety of timing attacks on different layers, which are observable by
different attackers. Small differences in timing behaviour might
initially be exploitable only by a local attacker, but advancements to
the attack (e.g. increasing the number of tests) might allow a 
remote attacker to filter the noise and exploit the different timing
behaviour.</p>
<p><strong>Timing of cryptographic primitives</strong></p>
<p>We <a href="http://openmirage.org/blog/introducing-nocrypto">already mentioned</a> <a href="http://www.cs.tau.ac.il/~tromer/papers/cache.pdf">cache</a> <a href="http://cr.yp.to/antiforgery/cachetiming-20050414.pdf">timing</a>
attacks on our AES implementation, and that we use <a href="https://en.wikipedia.org/wiki/Blinding_(cryptography)">blinding</a>
techniques to mitigate RSA timing attacks.</p>
<p>By using a memory managed programming language, we open the attack
vector of garbage collector (GC) timing attacks (also mentioned <a href="http://openmirage.org/blog/introducing-nocrypto">in
our nocrypto introduction</a>).</p>
<p>Furthermore, research has been done on virtual machine side channels
(<a href="http://eprint.iacr.org/2013/448.pdf">l3</a>, <a href="http://www.cs.unc.edu/~reiter/papers/2012/CCS.pdf">cross vm</a> and <a href="http://fc12.ifca.ai/pre-proceedings/paper_70.pdf">cache timing</a>), which we
will need to study and mitigate appropriately.</p>
<p><strong>For the time being we suggest to not use the stack on a multi-tenant
shared host or on a shared host which malicious users might have
access to.</strong></p>
<p><strong>Bleichenbacher</strong></p>
<p>In 1998, Daniel Bleichenbacher discovered a <a href="http://archiv.infsec.ethz.ch/education/fs08/secsem/Bleichenbacher98.pdf">timing flaw in the
PKCS1</a> encoding of the premaster secret: the TLS server
failed faster when the padding was wrong than when the decryption
failed. Using this timing, an attacker can run an adaptive chosen
ciphertext attack and find out the plain text of a PKCS1 encrypted
message. In TLS, when RSA is used as the key exchange method, this
leads to discovery of the premaster secret, which is used to derive the
keys for the current session.</p>
<p>The mitigation is to have both padding and decryption failures use the
exact same amount of time, thus there should not be any data-dependent
branches or different memory access patterns in the code. We
implemented this mitigation in <a href="https://github.com/mirleft/ocaml-tls/blob/c06cbaaffe49024d8570916b70f7839603a54692/lib/handshake_server.ml#L45">Handshake_server</a>.</p>
<p><strong>Padding oracle and CBC timing</strong></p>
<p><a href="http://www.iacr.org/archive/eurocrypt2002/23320530/cbc02_e02d.pdf">Vaudenay</a> discovered a vulnerability involving block ciphers: if an
attacker can distinguish between bad mac and bad padding, recovery of
the plaintext is possible (within an adaptive chosen ciphertext
attack). Another approach using the same issue is to use
<a href="http://lasecwww.epfl.ch/memo/memo_ssl.shtml">timing</a> information instead of separate error messages.
Further details are described <a href="https://www.openssl.org/~bodo/tls-cbc.txt">here</a>.</p>
<p>The countermeasure, which we implement <a href="https://github.com/mirleft/ocaml-tls/blob/c06cbaaffe49024d8570916b70f7839603a54692/lib/engine.ml#L100">here</a>, is to continue
with the mac computation even though the padding is
incorrect. Furthermore, we send the same alert (<code>bad_record_mac</code>)
independent of whether the padding is malformed or the mac is
incorrect.</p>
<p><strong>Lucky 13</strong></p>
<p>An advancement of the CBC timing attack was discovered in 2013, named
<a href="http://www.isg.rhul.ac.uk/tls/Lucky13.html">Lucky 13</a>. Due to the fact that the mac is computed over the
plaintext without padding, there is a slight (but measurable)
difference in timing between computing the mac of the plaintext and
computing the fake mac of the ciphertext. This leaks information. We
do not have proper mitigation against Lucky 13 in place yet.  You can
find further discussion in <a href="https://github.com/mirleft/ocaml-tls/issues/7">issue 7</a> and <a href="https://github.com/mirleft/ocaml-tls/pull/49">pull request
49</a>.</p>
<p><strong>Renegotiation not authenticated</strong></p>
<p>In 2009, Marsh Ray published a vulnerability of the TLS protocol which
lets an attacker prepend arbitrary data to a session due to
<a href="http://www.educatedguesswork.org/2009/11/understanding_the_tls_renegoti.html">unauthenticated renegotiation</a>. The attack
exploits the fact that a renegotiation of ciphers and key material is
possible within a session, and this renegotiated handshake is not
authenticated by the previous handshake. A man in the middle can
initiate a session with a server, send some data, and hand over the
session to a client. Neither the client nor the server can detect the
man in the middle.</p>
<p>A fix for this issue is the <a href="https://tools.ietf.org/html/rfc5746">secure renegotiation extension</a>,
which embeds authenticated data of the previous handshake into the
client and server hello messages. Now, if a man in the middle
initiates a renegotiation, the server will not complete it due to
missing authentication data (the client believes this is the first
handshake).</p>
<p>We implement and require the secure renegotiation extension by
default, but it is possible to configure <code>ocaml-tls</code> to not require
it -- to be able to communicate with servers and
clients which do not support this extension.</p>
<p>Implementation of the mitigation is on the server side in
<a href="https://github.com/mirleft/ocaml-tls/blob/c06cbaaffe49024d8570916b70f7839603a54692/lib/handshake_server.ml#L85">ensure_reneg</a> and on the client side in <a href="https://github.com/mirleft/ocaml-tls/blob/c06cbaaffe49024d8570916b70f7839603a54692/lib/handshake_client.ml#L50">validate_reneg</a>. The
data required for the secure renegotiation is stored in
<a href="https://github.com/mirleft/ocaml-tls/blob/c06cbaaffe49024d8570916b70f7839603a54692/lib/state.ml#L97">`handshake_state`</a> while sending and receiving Finished
messages. You can find further discussion in <a href="https://github.com/mirleft/ocaml-tls/issues/3">issue 3</a>.</p>
<p><strong>TLS 1.0 and known-plaintext (BEAST)</strong></p>
<p>TLS 1.0 reuses the last ciphertext block as IV in CBC mode. If an attacker
has a (partially) known plaintext, she can find the remaining plaintext.
This is known as the <a href="http://vnhacker.blogspot.co.uk/2011/09/beast.html">BEAST</a> attack and there is a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=665814">long discussion</a>
about mitigations. Our mitigation is to prepend each TLS-1.0
application data fragment with an empty fragment to randomize the IV.
We do this exactly <a href="https://github.com/mirleft/ocaml-tls/blob/c06cbaaffe49024d8570916b70f7839603a54692/lib/engine.ml#L375">here</a>. There is further discussion in
<a href="https://github.com/mirleft/ocaml-tls/issues/2">issue 2</a>.</p>
<p>Our mitigation is slightly different from the 1/n-1 splitting proposed
<a href="https://community.qualys.com/blogs/securitylabs/2013/09/10/is-beast-still-a-threat">here</a>: we split every application data frame into a 0 byte
and n byte frame, whereas they split into a 1 byte and a n-1 byte
frame.</p>
<p>Researchers have exploited this vulnerability in 2011, although it was
known since <a href="http://eprint.iacr.org/2006/136">2006</a>. TLS versions 1.1 and 1.2 use an explicit IV,
instead of reusing the last cipher block on the wire.</p>
<p><strong>Compression and information leakage (CRIME)</strong></p>
<p>When using compression on a chosen-plaintext, encrypting this can leak
information, known as <a href="http://arstechnica.com/security/2012/09/crime-hijacks-https-sessions/">CRIME</a>. <a href="http://breachattack.com/">BREACH</a> furthermore
exploits application layer compression, such as HTTP compression. We
mitigate CRIME by not providing any TLS compression support, while we
cannot do anything to mitigate BREACH.</p>
<p><strong>Traffic analysis</strong></p>
<p>Due to limited amount of padding data, the actual size of transmitted
data can be recovered. The mitigation is to implement <a href="http://tools.ietf.org/html/draft-pironti-tls-length-hiding-02">length hiding
policies</a>. This is tracked as <a href="https://github.com/mirleft/ocaml-tls/issues/162">issue 162</a>.</p>
<p><strong>Version rollback</strong></p>
<p>SSL-2.0 is insecure, a man in the middle can downgrade the version to
SSL-2.0. The mitigation we implement is that we do not support
SSL-2.0, and thus cannot be downgraded. Also, we check that the
version of the client hello matches the first two bytes in the
premaster secret <a href="https://github.com/mirleft/ocaml-tls/blob/c06cbaaffe49024d8570916b70f7839603a54692/lib/handshake_server.ml#L55">here</a>. You can find further discussion in
<a href="https://github.com/mirleft/ocaml-tls/issues/5">issue 5</a>.</p>
<p><strong>Triple handshake</strong></p>
<p>A vulnerability including session resumption and renegotiation was
discovered by the <a href="http://www.mitls.org">miTLS team</a>, named <a href="https://secure-resumption.com/">triple
handshake</a>.  Mitigations include disallowing renegotiation,
disallowing modification of the certificate during renegotiation, or
a hello extension. Since we do not support session resumption yet, we
have not yet implemented any of the mentioned mitigations. There is
further discussion in <a href="https://github.com/mirleft/ocaml-tls/issues/9">issue 9</a>.</p>
<p><strong>Alert attack</strong></p>
<p>A <a href="http://www.mitls.org/wsgi/alert-attack">fragment of an alert</a> can be sent by a man in the
middle during the initial handshake. If the fragment is not cleared
once the handshake is finished, the authentication of alerts is
broken. This was discovered in 2012; our mitigation is to discard
fragmented alerts.</p>
<h3>EOF.</h3>

<p>Within six months, two hackers managed to develop a clean-slate TLS
stack, together with required crypto primitives, ASN.1, and X.509
handling, in a high-level pure language. We interoperate with widely
deployed TLS stacks, as shown by our <a href="https://tls.openmirage.org">demo server</a>.  The code
size is nearly two orders of magnitude smaller than OpenSSL, the most
widely used open source library (written in C, which a lot of
programming languages wrap instead of providing their own TLS
implementation). Our code base seems to be robust -- the <a href="https://tls.openmirage.org">demo
server</a> successfully finished over 22500 sessions in less than a
week, with only 11 failing traces.</p>
<p>There is a huge need for high quality TLS implementations, because
several TLS implementations suffered this year from severe security
problems, such as <a href="https://en.wikipedia.org/wiki/Heartbleed">heartbleed</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-1266">goto fail</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3466">session
id</a>, <a href="http://armoredbarista.blogspot.de/2014/04/easter-hack-even-more-critical-bugs-in.html">Bleichenbacher</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0224">change cipher
suite</a> and <a href="https://polarssl.org/tech-updates/security-advisories/polarssl-security-advisory-2014-02">GCM DoS</a>. The main cause is
implementation complexity due to lack of abstraction, and memory
safety issues.</p>
<p>We still need to address some security issues, and improve our performance. We
invite people to do rigorous code audits (both manual and automated) and try
testing our code in their services.</p>
<p><strong>Please be aware that this release is a <em>beta</em> and is missing external code audits.
It is not yet intended for use in any security critical applications.</strong></p>
<h3>Acknowledgements</h3>

<p>Since this is the final post in our series, we would like to thank all
people who reported issues so far: <a href="http://anil.recoil.org/">Anil Madhavapeddy</a>, <a href="https://github.com/edwintorok">T&ouml;r&ouml;k
Edwin</a>, <a href="http://erratique.ch/">Daniel B&uuml;nzli</a>, <a href="http://blog.andreas.org/">Andreas Bogk</a>, <a href="http://gregorkopf.de/blog/">Gregor Kopf</a>, <a href="https://twitter.com/graham_steel">Graham
Steel</a>, <a href="https://github.com/vouillon">Jerome Vouillon</a>, <a href="http://amirchaudhry.com/">Amir Chaudhry</a>,
<a href="http://ashishagarwal.org">Ashish Agarwal</a>. Additionally, we want to thank the
<a href="http://www.mitls.org">miTLS</a> team (especially Cedric and Karthikeyan) for fruitful
discussions, as well as the <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/">OCaml Labs</a> and
<a href="http://www.openmirage.org">Mirage</a> teams. And thanks to <a href="http://www.cl.cam.ac.uk/~pes20/">Peter Sewell</a> and
<a href="http://www.cs.nott.ac.uk/~rmm/">Richard Mortier</a> for funding within the <a href="http://rems.io">REMS</a>, <a href="http://usercentricnetworking.eu/">UCN</a>, and <a href="http://www.horizon.ac.uk">Horizon</a>
projects. The software was started in <a href="http://www.aftasmirleft.com/">Aftas beach house</a> in
Mirleft, Morocco.</p>
<p><img src="http://openmirage.org/graphics/aftas-mirleft.jpg" alt="Aftas Beach"/></p>
<p></p><hr/>Posts in this TLS series:
<ul><li><a href="http://openmirage.org/blog/introducing-ocaml-tls">Introducing transport layer security (TLS) in pure OCaml</a></li><li><a href="http://openmirage.org/blog/introducing-nocrypto">OCaml-TLS: building the nocrypto library core</a></li><li><a href="http://openmirage.org/blog/introducing-x509">OCaml-TLS: adventures in X.509 certificate parsing and validation</a></li><li><a href="http://openmirage.org/blog/introducing-asn1">OCaml-TLS: ASN.1 and notation embedding</a></li><li><a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">OCaml-TLS: the protocol implementation and mitigations to known attacks</a></li></ul>


   <a onclick="switchContent('ocamlorg-post40','ocamlorg-post39')" class="btn planet-toggle" href="#http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">by David Kaloper at Jul 14, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/introducing-asn1">
    <a name="#http://openmirage.org/blog/introducing-asn1"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/introducing-asn1">OCaml-TLS: ASN.1 and notation embedding</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post41">
      <p><em>This is the fourth in a series of posts that introduce new libraries for a pure OCaml implementation of TLS.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-ocaml-tls">introduction</a>.</em></p>
<p><a href="https://github.com/mirleft/ocaml-asn1-combinators">asn1-combinators</a> is a library that allows one to express
<a href="https://en.wikipedia.org/wiki/Abstract_Syntax_Notation_One">ASN.1</a> grammars directly in OCaml, manipulate them as first-class entities,
combine them with one of several ASN encoding rules and use the result to parse
or serialize values.</p>
<p>It is the parsing and serialization backend for our <a href="https://github.com/mirleft/ocaml-x509">X.509</a>
certificate library, which in turn provides certificate handling for
<a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a>.
We wrote about the X.509 certificate handling <a href="http://openmirage.org/blog/introducing-x509">yesterday</a>.</p>
<h3>What is ASN.1, really?</h3>

<p><a href="https://en.wikipedia.org/wiki/Abstract_Syntax_Notation_One">ASN.1</a> (Abstract Syntax Notation, version one) is a way to describe
on-the-wire representation of messages. It is split into two components: a way
to describe the content of a message, i.e. a notation for its abstract syntax,
and a series of standard encoding rules that define the exact byte
representations of those syntaxes. It is defined in ITU-T standards X.680-X.683
and X.690-X.6&hellip;</p><a onclick="switchContent('ocamlorg-post41','ocamlorg-post42')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-asn1">Read more...</a></div><div id="ocamlorg-post42" style="display: none">
      <p><em>This is the fourth in a series of posts that introduce new libraries for a pure OCaml implementation of TLS.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-ocaml-tls">introduction</a>.</em></p>
<p><a href="https://github.com/mirleft/ocaml-asn1-combinators">asn1-combinators</a> is a library that allows one to express
<a href="https://en.wikipedia.org/wiki/Abstract_Syntax_Notation_One">ASN.1</a> grammars directly in OCaml, manipulate them as first-class entities,
combine them with one of several ASN encoding rules and use the result to parse
or serialize values.</p>
<p>It is the parsing and serialization backend for our <a href="https://github.com/mirleft/ocaml-x509">X.509</a>
certificate library, which in turn provides certificate handling for
<a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a>.
We wrote about the X.509 certificate handling <a href="http://openmirage.org/blog/introducing-x509">yesterday</a>.</p>
<h3>What is ASN.1, really?</h3>

<p><a href="https://en.wikipedia.org/wiki/Abstract_Syntax_Notation_One">ASN.1</a> (Abstract Syntax Notation, version one) is a way to describe
on-the-wire representation of messages. It is split into two components: a way
to describe the content of a message, i.e. a notation for its abstract syntax,
and a series of standard encoding rules that define the exact byte
representations of those syntaxes. It is defined in ITU-T standards X.680-X.683
and X.690-X.695.</p>
<p>The notation itself contains primitive grammar elements, such as <code>BIT STRING</code> or
<code>GeneralizedTime</code>, and constructs that allow for creation of compound grammars
from other grammars, like <code>SEQUENCE</code>. The notation is probably best introduced
through a real-world example:</p>
<pre><code>-- Simple name bindings
UniqueIdentifier ::= BIT STRING

-- Products
Validity ::= SEQUENCE {
  notBefore Time,
  notAfter  Time
}

-- Sums
Time ::= CHOICE {
  utcTime     UTCTime,
  generalTime GeneralizedTime
}</code></pre>

<p>(Example from <a href="http://tools.ietf.org/html/rfc5280#appendix-A.2">RFC 5280</a>, the RFC that describes X.509
certificates which heavily rely on ASN.)</p>
<p>The first definition shows that we can introduce an alias for any existing ASN
grammar fragment, in this case the primitive <code>BIT STRING</code>. The second and third
definitions are, at least morally, a product and a sum.</p>
<p>At their very core, ASN grammars look roughly like algebraic data types, with a
range of pre-defined primitive grammar fragments like <code>BIT STRING</code>, <code>INTEGER</code>,
<code>NULL</code>, <code>BOOLEAN</code> or even <code>GeneralizedTime</code>, and a number of combining
constructs that can be understood as denoting sums and products.</p>
<p>Definitions such as the above are arranged into named modules. The standard even
provides for some abstractive capabilities: initially just a macro facility, and
later a form of parameterized interfaces.</p>
<p>To facilitate actual message transfer, a grammar needs to be coupled with an
encoding. By far the most relevant ones are Basic Encoding Rules (BER) and
Distinguished Encoding Rules (DER), although other encodings exist.</p>
<p>BER and DER are tag-length-value (TLV) encodings, meaning that every value is
encoded as a triplet containing a tag that gives the interpretation of its
contents, a length field, and the actual contents which can in turn contain
other TLV triplets.</p>
<p>Let's drop the time from the example above, as time encoding is a little
involved, and assume a simpler version for a moment:</p>
<pre><code>Pair ::= SEQUENCE {
  car Value,
  cdr Value
}

Value ::= CHOICE {
  v_str UTF8String,
  v_int INTEGER
}</code></pre>

<p>Then two possible BER encodings of a <code>Pair</code> <code>(&quot;foo&quot;, 42)</code> are:</p>
<pre><code>  30         - SEQUENCE            30         - SEQUENCE
  08         - length              0c         - length
  [ 0c       - UTF8String          [ 2c       - UTF8String, compound
    03       - length                07       - length
    [ 66     - 'f'                   [ 0c     - UTF8String
      6f     - 'o'                     01     - length
      6f ]   - 'o'                     [ 66 ] - 'f'
    02       - INTEGER                 0c     - UTF8String
    01       - length                  02     - length
    [ 2a ] ] - 42                      [ 6f   - 'o'
                                         6f ] - 'o'
                                     02       - INTEGER
                                     01       - length
                                     [ 2a ] ] - 42</code></pre>

<p>The left one is also the only valid DER encoding of this value: BER allows
certain freedoms in encoding, while DER is just a BER subset without those
freedoms. The property of DER that any value has exactly one encoding is useful,
for example, when trying to digitally sign a value.</p>
<p>If this piqued your curiosity about ASN, you might want to take a detour and
check out this <a href="http://luca.ntop.org/Teaching/Appunti/asn1.html">excellent writeup</a>.</p>
<h3>A bit of history</h3>

<p>The description above paints a picture of a technology a little like <a href="https://code.google.com/p/protobuf/">Google's
Protocol Buffers</a> or <a href="https://thrift.apache.org/">Apache Thrift</a>: a way to declaratively
specify the structure of a set of values and derive parsers and serializers,
with the addition of multiple concrete representations.</p>
<p>But the devil is in the detail. For instance, the examples above intentionally
gloss over the fact that often concrete tag values <a href="http://tools.ietf.org/html/rfc5280#page-128">leak</a> into
the grammar specifications for various disambiguation reasons. And ASN has more
than 10 different <a href="http://www.obj-sys.com/asn1tutorial/node128.html">string types</a>, most of which use
long-obsolete character encodings. Not to mention that the full standard is
close to 200 pages of relatively dense language and quite difficult to
follow. In general, ASN seems to have too many features for the relatively
simple task it is solving, and its specification has evolved over decades, apparently
trying to address various other semi-related problems, such as providing a
general <a href="https://en.wikipedia.org/wiki/Information_Object_Class_(ASN.1)">Interface Description Language</a>.</p>
<p>Which is to say, ASN is <em>probably</em> not what you are looking for. So why
implement it?</p>
<p>Developed in the context of the telecom industry around 30 years ago, modified
several times after that and apparently suffering from a lack of a coherent
goal, by the early 90s ASN was still probably the only universal, machine- and
architecture-independent external data representation.</p>
<p>So it came easily to hand around the time RSA Security started publishing its
series of <a href="https://en.wikipedia.org/wiki/PKCS">PKCS</a> standards, aimed at the standardization of
cryptographic material exchange. RSA keys and digital signatures are often
exchanged ASN-encoded.</p>
<p>At roughly the same time, ITU-T started publishing the <a href="https://en.wikipedia.org/wiki/X.500">X.500</a> series
of standards which aimed to provide a comprehensive directory service. Much of
this work ended up as LDAP, but one little bit stands out in particular: the
<a href="https://en.wikipedia.org/wiki/X.509">X.509</a> PKI certificate.</p>
<p>So a few years later, when Netscape tried to build an authenticated and
confidential layer to tunnel HTTP through, they based it on -- amongst other
things -- X.509 certificates. Their work went through several revisions as SSL
and was finally standardized as TLS. Modern TLS still requires X.509.</p>
<p>Thus, even though TLS uses ASN only for encoding certificates (and the odd PKCS1
signature), every implementation needs to know how to deal with ASN. In fact,
many other general cryptographic libraries also need to deal with ASN, as various PKCS
standards mandate ASN as the encoding for exchange of cryptographic material.</p>
<h3>The grammar of the grammar</h3>

<p>As its name implies, ASN was meant to be used with a specialized compiler. ASN
is really a standard for <em>writing down</em> abstract syntaxes, and ASN compilers
provided with the target encoding will generate code in your programming
language of choice that, when invoked, parses to or serializes from ASN.</p>
<p>As long as your programming language of choice is C, C++, Java or C#, obviously
-- there doesn't seem to be one freely available that targets OCaml. In any case, generating code for such a high-level language feels wrong somehow. In
its effort to be language-neutral, ASN needs to deal with things like modules,
abstraction and composition. At this point, most functional programmers reading
this are screaming: &quot;I <em>already</em> have a language that can deal with modules,
abstraction and composition perfectly well!&quot;</p>
<p>So we're left with implementing ASN in OCaml.</p>
<p>One strategy is to provide utility functions for parsing elements of ASN and
simply invoke them in the appropriate order, as imposed by the target grammar.
This amounts to hand-writing the parser and is what TLS libraries in C
typically do.</p>
<p>As of release 1.3.7, <a href="https://github.com/polarssl/polarssl/tree/development/library">PolarSSL</a> includes ~7,500 lines of rather
beautifully written C, that implement a specialized parser for dealing with
X.509. OpenSSL's <a href="https://github.com/openssl/openssl">libcrypto</a> contains ~50,000 lines of C in its
<a href="https://github.com/openssl/openssl/tree/e3ba6a5f834f24aa5ffe9bc1849e3410c87388d5/crypto/asn1">'asn1'</a>, <a href="https://github.com/openssl/openssl/tree/e3ba6a5f834f24aa5ffe9bc1849e3410c87388d5/crypto/x509">'x509'</a> and
<a href="https://github.com/openssl/openssl/tree/e3ba6a5f834f24aa5ffe9bc1849e3410c87388d5/crypto/x509v3">'x509v3'</a> directories, and primarily deals with X.509
specifically as required by TLS.</p>
<p>In both cases, low-level control flow is intertwined with the parsing logic and,
above the ASN parsing level, the code that deals with interpreting the ASN
structure is not particularly concise.
It is certainly a far cry from the (relatively)
simple grammar description ASN itself provides.</p>
<p>Since in BER every value fully describes itself, another strategy is to parse
the input stream without reference to the grammar. This produces a value that
belongs to the general type of all ASN-encoded trees, after which we need to
process the <em>structure</em> according to the grammar. This is similar to a common
treatment of JSON or XML, where one decouples parsing of bytes from the
higher-level concerns about the actual structure contained therein. The problem
here is that either the downstream client of such a parser needs to constantly
re-check whether the parts of the structure it's interacting with are really
formed according to the grammar (probably leading to a tedium of
pattern-matches), or we have to turn around and solve the parsing problem
<em>again</em>, mapping the uni-typed contents of a message to the actual, statically
known structure we require the message to have.</p>
<p>Surely we can do better?</p>
<h3>LAMBDA: The Ultimate Declarative</h3>

<p>Again, ASN is a language with a number of built-in primitives, a few combining
constructs, (recursive) name-binding and a module system. Our target language is
a language with a perfectly good module system and it can certainly express
combining constructs. It includes an abstraction mechanism arguably far simpler
and easier to use than those of ASN, namely, functions. And the OCaml compilers
can already parse OCaml sources. So why not just reuse this machinery?</p>
<p>The idea is familiar. Creating embedded languages for highly declarative
descriptions within narrowly defined problem spaces is the staple of functional
programming. In particular, combinatory parsing has been known, studied and
used for <a href="http://comjnl.oxfordjournals.org/content/32/2/108.short">decades</a>.</p>
<p>However, we also have to diverge from traditional parser combinators in two major ways.
Firstly, a single grammar expression needs to be able to generate
different concrete parsers, corresponding to different ASN encodings. More
importantly, we desire our grammar descriptions to act <strong>bidirectionally</strong>,
producing both parsers and complementary deserializers.</p>
<p>The second point severely restricts the signatures we can support. The usual
monadic parsers are off the table because the expression such as:</p>
<pre class="OCaml"><code class="OCaml">( (pa : a t) &gt;&gt;= fun (a : a) -&gt;
  (pb : b t) &gt;&gt;= fun (b : b) -&gt;
  return (b, b, a) ) : (b * b * a) t</code></pre>

<p>... &quot;hides&quot; parts of the parser inside the closures, especially the method of
mapping the parsed values into the output values, and can not be run &quot;in
reverse&quot; [<a href="http://openmirage.org/blog/atom.xml#footnote-1">1</a>].</p>
<p>We have a similar problem with <a href="http://www.soi.city.ac.uk/~ross/papers/Applicative.html">applicative functors</a>:</p>
<pre class="OCaml"><code class="OCaml">( (fun a b -&gt; (b, b, a))
  &lt;$&gt; (pa : a t)
  &lt;*&gt; (pb : b t) ) : (b * b * a) t</code></pre>

<p>(Given the usual <code>&lt;$&gt; : ('a -&gt; 'b) -&gt; 'a t -&gt; 'b t</code> and <code>&lt;*&gt; : ('a -&gt; 'b) t -&gt;
'a t -&gt; 'b t</code>.) Although the elements of ASN syntax are now exposed, the process
of going from intermediate parsing results to the result of the whole is still
not accessible.</p>
<p>Fortunately, due to the regular structure of ASN, we don't really <em>need</em> the
full expressive power of monadic parsing. The only occurrence of sequential
parsing is within <code>SEQUENCE</code> and related constructs, and we don't need
look-ahead. All we need to do is provide a few specialized combinators to handle
those cases -- combinators the likes of which would be derived in a
more typical setting.</p>
<p>So if we imagine we had a few values, like:</p>
<pre class="OCaml"><code class="OCaml">val gen_time : gen_time t
val utc_time : utc_time t
val choice   : 'a t -&gt; 'b t -&gt; ('a, 'b) choice t
val sequence : 'a t -&gt; 'b t -&gt; ('a * 'b) t</code></pre>

<p>Assuming appropriate OCaml types <code>gen_time</code> and <code>utc_time</code> that reflect their
ASN counterparts, and a simple sum type <code>choice</code>, we could express the
<code>Validity</code> grammar above using:</p>
<pre class="OCaml"><code class="OCaml">type time = (gen_time, utc_time) choice
let time     : time t          = choice gen_time utc_time
let validity : (time * time) t = sequence time time</code></pre>

<p>In fact, ASN maps quite well to algebraic data types. Its <code>SEQUENCE</code> corresponds
to n-ary products and <code>CHOICE</code> to sums. ASN <code>SET</code> is a lot like <code>SEQUENCE</code>,
except the elements can come in any order; and <code>SEQUENCE_OF</code> and <code>SET_OF</code> are
just lifting an <code>'a</code>-grammar into an <code>'a list</code>-grammar.</p>
<p>A small wrinkle is that <code>SEQUENCE</code> allows for more contextual information on its
components (so does <code>CHOICE</code> in reality, but we ignore that): elements can carry
labels (which are not used for parsing) and can be marked as optional. So
instead of working directly on the grammars, our <code>sequence</code> must work on their
annotated versions. A second wrinkle is the arity of the <code>sequence</code> combinator.</p>
<p>Thus we introduce the type of annotated grammars, <code>'a element</code>, which
corresponds to one <code>,</code>-delimited syntactic element in ASN's own <code>SEQUENCE</code>
grammar, and the type <code>'a sequence</code>, which describes the entire contents (<code>{ ...
}</code>) of a <code>SEQUENCE</code> definition:</p>
<pre class="OCaml"><code class="OCaml">val required : 'a t -&gt; 'a element
val optional : 'a t -&gt; 'a option element
val ( -@ )   : 'a element -&gt; 'b element -&gt; ('a * 'b) sequence
val ( @ )    : 'a element -&gt; 'a sequence -&gt; ('a * 'b) sequence
val sequence : 'a sequence -&gt; 'a t</code></pre>

<p>The following are then equivalent:</p>
<pre><code>Triple ::= SEQUENCE {
  a INTEGER,
  b BOOLEAN,
  c BOOLEAN OPTIONAL
}</code></pre>

<pre class="OCaml"><code class="OCaml">let triple : (int * (bool * bool option)) t =
  sequence (
      required int
    @ required bool
   -@ optional bool
  )</code></pre>

<p>We can also re-introduce functions, but in a controlled manner:</p>
<pre class="OCaml"><code class="OCaml">val map : ('a -&gt; 'b) -&gt; ('b -&gt; 'a) -&gt; 'a t -&gt; 'b t</code></pre>

<p>Keeping in line with the general theme of bidirectionality, we require functions
to come in pairs. The deceptively called <code>map</code> could also be called <code>iso</code>, and
comes with a nice property: if the two functions are truly inverses,
the serialization process is fully reversible, and so is parsing, under
single-representation encodings (DER)!</p>
<h3>ASTs of ASNs</h3>

<p>To go that last mile, we should probably also <em>implement</em> what we discussed.</p>
<p>Traditional parser combinators look a little like this:</p>
<pre class="OCaml"><code class="OCaml">type 'a p = string -&gt; 'a * string

let bool : bool p = fun str -&gt; (s.[0] &lt;&gt; &quot;\000&quot;, tail_of_string str)</code></pre>

<p>Usually, the values inhabiting the parser type are the actual parsing functions,
and their composition directly produces larger parsing functions. We would
probably need to represent them with <code>'a p * 'a s</code>, pairs of a parser and its
inverse, but the same general idea applies.</p>
<p>Nevertheless, we don't want to do this.
The grammars need to support more than one concrete
parser/serializer, and composing what is common between them and extracting out
what is not would probably turn into a tangled mess. That is one reason. The other is that if we encode the grammar purely as
(non-function) value, we can traverse it for various other purposes.</p>
<p>So we turn from what is sometimes called &quot;shallow embedding&quot; to &quot;deep
embedding&quot; and try to represent the grammar purely as an algebraic data type.</p>
<p>Let's try to encode the parser for bools, <code>boolean : bool t</code>:</p>
<pre class="OCaml"><code class="OCaml">type 'a t =
  | Bool
  ...

let boolean : bool t = Bool</code></pre>

<p>Unfortunately our constructor is fully polymorphic, of type <code>'a. 'a t</code>. We can
constrain it for the users, but once we traverse it there is nothing left to
prove its intended association with booleans!</p>
<p>Fortunately, starting with the release of <a href="http://ocaml.org/releases/4.00.1.html">OCaml 4.00.0</a>,
OCaml joined the ranks of
languages equipped with what is probably the supreme tool of deep embedding,
<a href="http://en.wikipedia.org/wiki/Generalized_algebraic_data_type">GADTs</a>. Using them, we can do things like:</p>
<pre class="OCaml"><code class="OCaml">type _ t =
  | Bool   : bool t
  | Pair   : ('a t * 'b t) -&gt; ('a * 'b) t
  | Choice : ('a t * 'b t) -&gt; ('a, 'b) choice t
  ...</code></pre>

<p>In fact, this is very close to how the library is <a href="https://github.com/mirleft/ocaml-asn1-combinators/blob/4328bf5ee6f20ad25ff7971ee8013f79e5bfb036/src/core.ml#L19">actually</a>
implemented.</p>
<p>There is only one thing left to worry about: ASN definitions can be recursive.
We might try something like:</p>
<pre class="OCaml"><code class="OCaml">let rec list = choice null (pair int list)</code></pre>

<p>But this won't work. Being just trees of applications, our definitions never
contain <a href="http://caml.inria.fr/pub/docs/manual-ocaml-400/manual021.html#toc70">statically constructive</a> parts -- this expression could never
terminate in a strict language.</p>
<p>We can get around that by wrapping grammars in <code>Lazy.t</code> (or just closures), but
this would be too awkward to use. Like many other similar libraries, we need to
provide a fixpoint combinator:</p>
<pre class="OCaml"><code class="OCaml">val fix : ('a t -&gt; 'a t) -&gt; 'a t</code></pre>

<p>And get to write:</p>
<pre class="OCaml"><code class="OCaml">let list = fix @@ fun list -&gt; choice null (pair int list)</code></pre>

<p>This introduces a small problem. So far we simply reused binding inherited
from OCaml without ever worrying about identifiers and references, but with a
fixpoint, the grammar encodings need to be able to somehow express a cycle.</p>
<p>Borrowing an idea from higher-order abstract syntax, we can represent the entire
fixpoint node using exactly the function provided to define it, re-using OCaml's
own binding and identifier resolution:</p>
<pre class="OCaml"><code class="OCaml">type _ t =
  | Fix : ('a t -&gt; 'a t) -&gt; 'a t
  ...</code></pre>

<p>This treatment completely sidesteps the problems with variables. We need no
binding environments or De Brujin indices, and need not care about the desired
scoping semantics. A little trade-off is that with this simple encoding it
becomes more difficult to track cycles (when traversing the AST, if we keep
applying a <code>Fix</code> node to itself while descending into it, it looks like an
infinite tree), but with a little opportunistic caching it all plays out well
[<a href="http://openmirage.org/blog/atom.xml#footnote-2">2</a>].</p>
<p>The <a href="https://github.com/mirleft/ocaml-asn1-combinators/blob/4328bf5ee6f20ad25ff7971ee8013f79e5bfb036/src/ber_der.ml#L49">parser</a> and <a href="https://github.com/mirleft/ocaml-asn1-combinators/blob/4328bf5ee6f20ad25ff7971ee8013f79e5bfb036/src/ber_der.ml#L432">serializer</a> proper then emerge as interpreters for
this little language of typed trees, traversing them with an input string, and
parsing it in a fully type-safe manner.</p>
<h3>How does it play out?</h3>

<p>The entire ASN library comes down to ~1,700 lines of OCaml, with around ~1,100
more in tests, giving a mostly-complete treatment of BER and DER.</p>
<p>Its main use so far is in the context of the <code>X.509</code> library
(discussed <a href="http://openmirage.org/blog/introducing-x509">yesterday</a>). It allowed the
grammar of certificates and RSA keys, together with a number of transformations
from the raw types to more pleasant, externally facing ones, to be written in
~900 <a href="https://github.com/mirleft/ocaml-x509/blob/6c96f11a2c7911ae0b308af9b328aee38f48b270/lib/asn_grammars.ml">lines</a> of OCaml. And the code looks a lot like the
actual standards the grammars were taken from -- the fragment from the beginning
of this article becomes:</p>
<pre class="OCaml"><code class="OCaml">let unique_identifier = bit_string_cs

let time =
  map (function `C1 t -&gt; t | `C2 t -&gt; t) (fun t -&gt; `C2 t)
      (choice2 utc_time generalized_time)

let validity =
  sequence2
    (required ~label:&quot;not before&quot; time)
    (required ~label:&quot;not after&quot;  time)</code></pre>

<p>We added <code>~label</code> to <code>'a element</code>-forming injections, and have:</p>
<pre class="OCaml"><code class="OCaml">val choice2 : 'a t -&gt; 'b t -&gt; [ `C1 of 'a | `C2 of 'b ] t</code></pre>

<p>To get a sense of how the resulting system eases the translation of standardized
ASN grammars into working code, it is particularly instructive to compare
<a href="https://github.com/polarssl/polarssl/blob/b9e4e2c97a2e448090ff3fcc0f99b8f6dbc08897/library/x509_crt.c#L531">these</a> <a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/asn_grammars.ml#L772">two</a> definitions.</p>
<p>Reversibility was a major simplifying factor during development. Since the
grammars are traversable, it is easy to generate their <a href="https://github.com/mirleft/ocaml-asn1-combinators/blob/cf1a1ffb4a31d02979a6a0bca8fe58856f8907bf/src/asn_random.ml">random</a>
inhabitants, encode them, parse the result and verify the reversibility still
<a href="https://github.com/mirleft/ocaml-asn1-combinators/blob/cf1a1ffb4a31d02979a6a0bca8fe58856f8907bf/tests/testlib.ml#L83">holds</a>. This can't help convince us the parsing/serializing pair
is actually correct with respect to ASN, but it gives a simple tool to generate
large amounts of test cases and convince us that that pair is <em>equivalent</em>. A
number of hand-written cases then check the conformance to the actual ASN.</p>
<p>As for security, there were two concerns we were aware of. There is a history of
catastrophic <a href="https://technet.microsoft.com/en-us/library/security/ms04-007.aspx">buffer overruns</a> in some ASN.1 implementations,
but -- assuming our compiler and runtime system are correct -- we are immune to
these as we are subject to bounds-checking. And
there are some documented <a href="https://www.viathinksoft.de/~daniel-marschall/asn.1/oid_facts.html">problems</a> with security of X.509
certificate verification due to overflows of numbers in ASN OID types, which we
explicitly guard against.</p>
<p>You can check our security status on our <a href="https://github.com/mirleft/ocaml-asn1-combinators/issues?state=open">issue tracker</a>.</p>
<h4>Footnotes</h4>

<ol><li><p><a name="footnote-1"> </a> In fact, the problem with embedding functions in
 combinator languages, and the fact that in a functional language it is not
 possible to extract information from a function other than by applying it,
 was discussed more than a decade ago. Such discussions led to the development of
 <a href="http://www.haskell.org/arrows/biblio.html#Hug00">Arrows</a>, amongst other things.</p>
</li><li><p><a name="footnote-2"> </a> Actually, a version of the library used the more
 <a href="http://dl.acm.org/citation.cfm?id=1411226">proper</a> encoding to be able to inject results of reducing
 referred-to parts of the AST into the referring sites directly, roughly
 like <code>Fix : ('r -&gt; ('a, 'r) t) -&gt; ('a, 'r) t</code>. This approach was abandoned because terms need to be polymorphic in <code>'r</code>, and this becomes
 impossible to hide from the user of the library, creating unwelcome noise.</p>
</li></ol>

<p></p><hr/>Posts in this TLS series:
<ul><li><a href="http://openmirage.org/blog/introducing-ocaml-tls">Introducing transport layer security (TLS) in pure OCaml</a></li><li><a href="http://openmirage.org/blog/introducing-nocrypto">OCaml-TLS: building the nocrypto library core</a></li><li><a href="http://openmirage.org/blog/introducing-x509">OCaml-TLS: adventures in X.509 certificate parsing and validation</a></li><li><a href="http://openmirage.org/blog/introducing-asn1">OCaml-TLS: ASN.1 and notation embedding</a></li><li><a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">OCaml-TLS: the protocol implementation and mitigations to known attacks</a></li></ul>


   <a onclick="switchContent('ocamlorg-post42','ocamlorg-post41')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-asn1">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/introducing-asn1">by David Kaloper at Jul 11, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/introducing-x509">
    <a name="#http://openmirage.org/blog/introducing-x509"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/introducing-x509">OCaml-TLS: Adventures in X.509 certificate parsing and validation</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post43">
      <p><em>This is the third in a series of posts that introduce new libraries for a pure OCaml implementation of TLS.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-ocaml-tls">introduction</a>.</em></p>
<h3>The problem of authentication</h3>

<p>The authenticity of the remote server needs to be verified while
establishing a secure connection to it, or else an
attacker (<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">MITM</a>) between the client and the server can eavesdrop on
the transmitted data. To the best of our knowledge, authentication
cannot be done solely in-band, but needs external
infrastructure. The most common methods used in practice rely on
public key encryption.</p>
<p><em>Web of trust</em> (used by <a href="https://en.wikipedia.org/wiki/OpenPGP">OpenPGP</a>) is a decentralised public key
infrastructure. It relies on out-of-band verification of public keys
and transitivity of trust. If Bob signed Alice's public key, and
Charlie trusts Bob (and signed his public key), then Charlie can trust
that Alice's public key is hers.</p>
<p><em>Public key infrastructure</em> (used by <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>) relies on trust
anchors which are communicated out-of-band (e.g. distributed wit&hellip;</p><a onclick="switchContent('ocamlorg-post43','ocamlorg-post44')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-x509">Read more...</a></div><div id="ocamlorg-post44" style="display: none">
      <p><em>This is the third in a series of posts that introduce new libraries for a pure OCaml implementation of TLS.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-ocaml-tls">introduction</a>.</em></p>
<h3>The problem of authentication</h3>

<p>The authenticity of the remote server needs to be verified while
establishing a secure connection to it, or else an
attacker (<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">MITM</a>) between the client and the server can eavesdrop on
the transmitted data. To the best of our knowledge, authentication
cannot be done solely in-band, but needs external
infrastructure. The most common methods used in practice rely on
public key encryption.</p>
<p><em>Web of trust</em> (used by <a href="https://en.wikipedia.org/wiki/OpenPGP">OpenPGP</a>) is a decentralised public key
infrastructure. It relies on out-of-band verification of public keys
and transitivity of trust. If Bob signed Alice's public key, and
Charlie trusts Bob (and signed his public key), then Charlie can trust
that Alice's public key is hers.</p>
<p><em>Public key infrastructure</em> (used by <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>) relies on trust
anchors which are communicated out-of-band (e.g. distributed with the
client software). In order to authenticate a server, a chain of trust
between a trust anchor and the server certificate (public key) is
established. Only those clients which have the trust anchor deployed
can verify the authenticity of the server.</p>
<h3>X.509 public key infrastructure</h3>

<p><a href="https://en.wikipedia.org/wiki/X.509">X.509</a> is an ITU standard for a public key infrastructure,
developed in 1988. Amongst other things, it specifies the format of
certificates, their attributes, revocation lists, and a path
validation algorithm. X.509 certificates are encoded using abstract
syntax notation one (ASN.1).</p>
<p>A <em>certificate</em> contains a public key, a subject (server name), a
validity period, a purpose (i.e. key usage), an issuer, and
possibly other extensions. All components mentioned in the certificate
are signed by an issuer.</p>
<p>A <em>certificate authority</em> (CA) receives a certificate signing request
from a server operator. It verifies that this signing request is
legitimate (e.g. requested server name is owned by the server
operator) and signs the request. The CA certificate must be trusted by
all potential clients. A CA can also issue intermediate CA
certificates, which are allowed to sign certificates.</p>
<p>When a server certificate or intermediate CA certificate is
compromised, the CA publishes this certificate in its certificate
revocation list (CRL), which each client should poll periodically.</p>
<p>The following certificates are exchanged before a TLS session:</p>
<ul><li>CA -&gt; Client: CA certificate, installed as trust anchor on the client</li><li>Server -&gt; CA: certificate request, to be signed by the CA</li><li>CA -&gt; Server: signed server certificate</li></ul>

<p>During the TLS handshake the server sends the certificate chain to the
client. When a client wants to verify a certificate, it has to verify
the signatures of the entire chain, and find a trust anchor which
signed the outermost certificate. Further constraints, such as the
maximum chain length and the validity period, are checked as
well. Finally, the server name in the server certificate is checked to
match the expected identity.
For an example, you can see the sequence diagram of the TLS handshake your browser makes when you visit our <a href="https://tls.openmirage.org">demonstration server</a>.</p>
<h3>Example code for verification</h3>

<p>OpenSSL implements <a href="https://tools.ietf.org/html/rfc5280">RFC5280</a> path validation, but there is no
implementation to validate the identity of a certificate. This has to
be implemented by each client, which is rather complex (e.g. in
<a href="https://github.com/freebsd/freebsd/blob/bf1a15b165af779577b0278b3d47151edb0d47f9/lib/libfetch/common.c#L326-665">libfetch</a> it spans over more than 300 lines). A client of the
<code>ocaml-x509</code> library (such as our <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lwt/examples/http_client.ml">http-client</a>) has to
write only two lines of code:</p>
<pre class="OCaml"><code class="OCaml">lwt authenticator = X509_lwt.authenticator (`Ca_dir ca_cert_dir) in
lwt (ic, oc) =
  Tls_lwt.connect_ext
    (Tls.Config.client_exn ~authenticator ())
    (host, port)</code></pre>

<p>The authenticator uses the default directory where trust anchors are
stored (<a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lwt/examples/ex_common.ml#L6">'ca_cert_dir'</a>), and this authenticator is
passed to the <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lwt/tls_lwt.ml#L227">'connect_ext'</a> function. This initiates
the TLS handshake, and passes the trust anchors and the hostname to
the TLS library.</p>
<p>During the client handshake when the certificate chain is received by
the server, the given authenticator and hostname are used to
authenticate the certificate chain (in <a href="https://github.com/mirleft/ocaml-tls/blob/6dc9258a38489665abf2bd6cdbed8a1ba544d522/lib/handshake_client.ml#L84">'validate_chain'</a>):</p>
<pre class="OCaml"><code class="OCaml">match
 X509.Authenticator.authenticate ?host:server_name authenticator stack
with
 | `Fail SelfSigned         -&gt; fail Packet.UNKNOWN_CA
 | `Fail NoTrustAnchor      -&gt; fail Packet.UNKNOWN_CA
 | `Fail CertificateExpired -&gt; fail Packet.CERTIFICATE_EXPIRED
 | `Fail _                  -&gt; fail Packet.BAD_CERTIFICATE
 | `Ok                      -&gt; return server_cert</code></pre>

<p>Internally, <code>ocaml-x509</code> extracts the hostname list from a
certificate in <a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L134-144">'cert_hostnames'</a>, and the
<a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L325-L346">wildcard or strict matcher</a> compares it to the input.
In total, this is less than 50 lines of pure OCaml code.</p>
<h3>Problems in X.509 verification</h3>

<p>Several weaknesses in the verification of X.509 certificates have been
discovered, ranging from cryptographic attacks due to
<a href="http://www.win.tue.nl/~bdeweger/CollidingCertificates/ddl-full.pdf">collisions in hash algorithms</a> (<a href="http://www.win.tue.nl/hashclash/rogue-ca/">practical</a>) over
<a href="http://www.blackhat.com/presentations/bh-usa-09/MARLINSPIKE/BHUSA09-Marlinspike-DefeatSSL-SLIDES.pdf">misinterpretation of the name</a> in the certificate (a C
string is terminated by a null byte), and treating X.509 version 1
certificates always as a <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0092">trust anchor in GnuTLS</a>.</p>
<p>An <a href="https://crypto.stanford.edu/~dabo/pubs/abstracts/ssl-client-bugs.html">empirical study of software that does certificate
verification</a> showed that badly designed APIs are the
root cause of vulnerabilities in this area. They tested various
implementations by using a list of certificates, which did not form a
chain, and would not authenticate due to being self-signed, or
carrying a different server name.</p>
<p>Another recent empirical study (<a href="http://www.cs.utexas.edu/~suman/publications/frankencert.pdf">Frankencert</a>) generated random
certificates and validated these with various stacks. They found lots
of small issues in nearly all certificate verification stacks.</p>
<p>Our implementation mitigates against some of the known attacks: we
require a complete valid chain, check the extensions of a certificate,
and implement hostname checking as specified in <a href="https://tools.ietf.org/html/rfc6125">RFC6125</a>. We have a
<a href="https://github.com/mirleft/ocaml-x509/tree/master/tests">test suite</a> with over 3200 tests and multiple CAs. We do not yet discard
certificates which use MD5 as hash algorithm. Our TLS stack
requires certificates to have at least 1024 bit RSA keys.</p>
<h3>X.509 library internals</h3>

<p>The <code>x509</code> library uses <a href="https://github.com/mirleft/ocaml-asn-combinators">asn-combinators</a> to parse X.509 certificates and
the <a href="https://github.com/mirleft/ocaml-nocrypto">nocrypto</a> library for signature verification
(which we wrote about <a href="http://openmirage.org/blog/introducing-nocrypto">previously</a>).
At the moment we do not yet
expose certificate builders from the library, but focus on certificate parsing
and certificate authentication.</p>
<p>The <a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/x509.ml">x509</a> module provides modules which parse
PEM-encoded (<a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/x509.ml#L18">pem</a>) certificates (<a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/x509.ml#L85">Cert</a>)
and private keys
(<a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/x509.ml#L105">Pk</a>), and an authenticator module
(<a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/x509.ml#L123">Authenticators</a>).</p>
<p>So far we have two authenticators implemented:</p>
<ul><li><a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/x509.ml#L137">'chain_of_trust'</a>, which implements the basic path
 validation algorithm from <a href="https://tools.ietf.org/html/rfc5280">RFC5280</a> (section 6) and the hostname
 validation from <a href="https://tools.ietf.org/html/rfc6125">RFC6125</a>. To construct such an authenticator, a
 timestamp and a list of trust anchors is needed.</li><li><a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/x509.ml#L142">'null'</a>, which always returns success.</li></ul>

<p>The method <a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/x509.mli#L42">'authenticate'</a>, to be called when a
certificate stack should be verified, receives an authenticator, a
hostname and the certificate stack. It returns either <code>Ok</code> or <code>Fail</code>.</p>
<p>Our <a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/asn_grammars.ml#L734">certificate type</a> is very similar to the described structure in the RFC:</p>
<pre class="OCaml"><code class="OCaml">type tBSCertificate = {
  version    : [ `V1 | `V2 | `V3 ] ;
  serial     : Z.t ;
  signature  : Algorithm.t ;
  issuer     : Name.dn ;
  validity   : Time.t * Time.t ;
  subject    : Name.dn ;
  pk_info    : PK.t ;
  issuer_id  : Cstruct.t option ;
  subject_id : Cstruct.t option ;
  extensions : (bool * Extension.t) list
}

type certificate = {
  tbs_cert       : tBSCertificate ;
  signature_algo : Algorithm.t ;
  signature_val  : Cstruct.t
}</code></pre>

<p>The certificate itself wraps the to be signed part (<a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/asn_grammars.ml#L734">'tBSCertificate'</a>),
the used signature algorithm, and the actual signature. It consists of
a version, serial number, issuer, validity, subject, public key
information, optional issuer and subject identifiers, and a list of
extensions -- only version 3 certificates may have extensions.</p>
<p>The <a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/certificate.mli">'certificate'</a> module implements the actual
authentication of certificates, and provides some useful getters such
as <a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/certificate.ml#L91">'cert_type'</a>, <a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/certificate.ml#L95">'cert_usage'</a>, and
<a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/certificate.ml#L100">'cert_extended_usage'</a>. The main entry for
authentication is <a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L419">'verify_chain_of_trust'</a>,
which checks correct signatures of the chain, extensions and validity
of each certificate, and the hostname of the server certificate.</p>
<p>The grammar of X.509 certificates is developed in the
<a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/asn_grammars.ml">'asn_grammars'</a> module, and the object
identifiers are gathered in the <a href="https://github.com/mirleft/ocaml-x509/blob/cdea2b1ae222e88a403f2d8f954a6aa31c984941/lib/registry.ml">'registry'</a> module.</p>
<h3>Implementation of certificate verification</h3>

<p>We provide the function <a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L438">'valid_cas'</a>, which takes a
timestamp and a list of certificate authorities. Each certificate
authority is checked to be <a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L282">valid</a>, self-signed,
correctly signed, and having 
<a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L277">proper X.509 v3 extensions</a>.
As mentioned above, version 1 and version 2
certificates do not contain extensions. For a version 3 certificate,
<a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L206">'validate_ca_extensions'</a> is called: The
basic constraints extensions must be present, and its value must be
true. Also, key usage must be present and the certificate must be
allowed to sign certificates. Finally, we reject the certificate if
there is any extension marked critical, apart from the two mentioned
above.</p>
<p>When we have a list of validated CA certificates, we can use these to
<a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L419">verify the chain of trust</a>, which gets a
hostname, a timestamp, a list of trust anchors and a certificate chain
as input. It first checks that the <a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L384">server certificate is
valid</a>, the <a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L264">validity of the intermediate
certificates</a>, and that the <a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L421">chain is complete</a>
(the pathlen constraint is not validated) and rooted in a trust
anchor. A server certificate is valid if the validity period matches
the current timestamp, the given hostname <a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml#L333">matches</a>
its subject alternative name extension or common name (might be
wildcard or strict matching, <a href="https://tools.ietf.org/html/rfc6125">RFC6125</a>), and it does not have a
basic constraints extension which value is true.</p>
<h3>Current status of ocaml-x509</h3>

<p>We currently support only RSA certificates. We do not check revocation
lists or use the online certificate status protocol (<a href="http://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol">OCSP</a>). Our
implementation does not handle name constraints and policies. However, if
any of these extensions is marked critical, we refuse to validate the
chain. To keep our main authentication free of side-effects, it currently uses
the timestamp when the authenticator was created rather than when it is used
(this isn't a problem if lifetime of the OCaml-TLS process is comparatively
short, as in the worst case the lifetime of the certificates can be extended by
the lifetime of the process).</p>
<p>We invite people to read through the
<a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/certificate.ml">certificate verification</a> and the
<a href="https://github.com/mirleft/ocaml-x509/blob/7bd25d152445263d7659c653e4a761222f43c75b/lib/asn_grammars.ml">ASN.1 parsing</a>. We welcome discussion on the
<a href="http://lists.xenproject.org/archives/html/mirageos-devel/">mirage-devel mailing list</a> and bug reports
on the <a href="https://github.com/mirleft/ocaml-x509/issues">GitHub issue tracker</a>.</p>
<p></p><hr/>Posts in this TLS series:
<ul><li><a href="http://openmirage.org/blog/introducing-ocaml-tls">Introducing transport layer security (TLS) in pure OCaml</a></li><li><a href="http://openmirage.org/blog/introducing-nocrypto">OCaml-TLS: building the nocrypto library core</a></li><li><a href="http://openmirage.org/blog/introducing-x509">OCaml-TLS: adventures in X.509 certificate parsing and validation</a></li><li><a href="http://openmirage.org/blog/introducing-asn1">OCaml-TLS: ASN.1 and notation embedding</a></li><li><a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">OCaml-TLS: the protocol implementation and mitigations to known attacks</a></li></ul>


   <a onclick="switchContent('ocamlorg-post44','ocamlorg-post43')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-x509">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/introducing-x509">by Hannes Mehnert at Jul 10, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/introducing-nocrypto">
    <a name="#http://openmirage.org/blog/introducing-nocrypto"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/introducing-nocrypto">OCaml-TLS: building the nocrypto library core</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post45">
      <p><em>This is the second in a series of posts that introduce new libraries for a pure OCaml implementation of TLS.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-ocaml-tls">introduction</a>.</em></p>
<h3>What is nocrypto?</h3>

<p><a href="https://github.com/mirleft/ocaml-nocrypto">nocrypto</a> is the small cryptographic library behind the
<a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a> project. It is built to be straightforward to use, adhere to
functional programming principles and able to run in a Xen-based unikernel.
Its major use-case is <code>ocaml-tls</code>, which we <a href="http://openmirage.org/blog/introducing-ocaml-tls">announced yesterday</a>, but we do intend to provide
sufficient features for it to be more widely applicable.</p>
<p>&quot;Wait, you mean you wrote your own <em>crypto library</em>?&quot;</p>
<h3>&quot;Never write your own crypto&quot;</h3>

<p>Everybody seems to recognize that cryptography is horribly difficult. Building
cryptography, it is all too easy to fall off the deep end and end up needing to
make decisions only a few, select specialists can make. Worse, any mistake is
difficult to uncover but completely compromises the security of the system. Or
in Bruce Schneier's <a href="https://www.schneier.com/essays/archives/1998/01/security_pitfalls_in.html">words</a>:</p>
<blockquote><p>Building a secure cryptographic system is &hellip;</p></blockquote><a onclick="switchContent('ocamlorg-post45','ocamlorg-post46')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-nocrypto">Read more...</a></div><div id="ocamlorg-post46" style="display: none">
      <p><em>This is the second in a series of posts that introduce new libraries for a pure OCaml implementation of TLS.
You might like to begin with the <a href="http://openmirage.org/blog/introducing-ocaml-tls">introduction</a>.</em></p>
<h3>What is nocrypto?</h3>

<p><a href="https://github.com/mirleft/ocaml-nocrypto">nocrypto</a> is the small cryptographic library behind the
<a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a> project. It is built to be straightforward to use, adhere to
functional programming principles and able to run in a Xen-based unikernel.
Its major use-case is <code>ocaml-tls</code>, which we <a href="http://openmirage.org/blog/introducing-ocaml-tls">announced yesterday</a>, but we do intend to provide
sufficient features for it to be more widely applicable.</p>
<p>&quot;Wait, you mean you wrote your own <em>crypto library</em>?&quot;</p>
<h3>&quot;Never write your own crypto&quot;</h3>

<p>Everybody seems to recognize that cryptography is horribly difficult. Building
cryptography, it is all too easy to fall off the deep end and end up needing to
make decisions only a few, select specialists can make. Worse, any mistake is
difficult to uncover but completely compromises the security of the system. Or
in Bruce Schneier's <a href="https://www.schneier.com/essays/archives/1998/01/security_pitfalls_in.html">words</a>:</p>
<blockquote><p>Building a secure cryptographic system is easy to do badly, and very difficult
to do well. Unfortunately, most people can't tell the difference. In other
areas of computer science, functionality serves to differentiate the good from
the bad: a good compression algorithm will work better than a bad one; a bad
compression program will look worse in feature-comparison charts. Cryptography
is different. Just because an encryption program works doesn't mean it is
secure.</p>
</blockquote>

<p>Obviously, it would be far wiser not to attempt to do this and instead reuse
good, proven work done by others. And with the wealth of free cryptographic
libraries around, one gets to take their pick.</p>
<p>So to begin with, we turned to <a href="https://forge.ocamlcore.org/projects/cryptokit/">cryptokit</a>, the more-or-less
standard cryptographic library in the OCaml world. It has a decent coverage of
the basics: some stream ciphers (ARC4), some block ciphers (AES, 3DES and
Blowfish) the core hashes (MD5, SHA, the SHA2 family and RIPEMD) and the
public-key primitives (Diffie-Hellman and RSA). It is also designed with
composability in mind, exposing various elements as stream-transforming objects
that can be combined on top of one another.</p>
<p>Unfortunately, its API was a little difficult to use. Suppose you have a secret
key, an IV and want to use AES-128 in CBC mode to encrypt a bit of data. You do
it like this:</p>
<pre class="OCaml"><code class="OCaml">let key = &quot;abcd1234abcd1234&quot;
and iv  = &quot;1234abcd1234abcd&quot;
and msg = &quot;fire the missile&quot;

let aes     = new Cryptokit.Block.aes_encrypt key
let aes_cbc = new Cryptokit.Block.cbc_encrypt ~iv aes

let cip =
  let size =
    int_of_float (ceil (float String.(length msg) /. 16.) *. 16.) in
  String.create size

let () = aes_cbc#transform msg 0 cip 0</code></pre>

<p>At this point, <code>cip</code> contains our secret message. This being CBC, both <code>msg</code> and
the string the output will be written into (<code>cip</code>) need to have a size that is a
multiple of the underlying block size. If they do not, bad things will
happen -- silently.</p>
<p>There is also the curious case of hashing-object states:</p>
<pre class="OCaml"><code class="OCaml">let md5 = Cryptokit.Hash.md5 ()

let s1 = Cryptokit.hash_string md5 &quot;bacon&quot;
let s2 = Cryptokit.hash_string md5 &quot;bacon&quot;
let s3 = Cryptokit.hash_string md5 &quot;bacon&quot;

(*
  s1 = &quot;x\019%\142\248\198\1822\221\232\204\128\246\189\166/&quot;
  s2 = &quot;'\\F\017\234\172\196\024\142\255\161\145o\142\128\197&quot;
  s3 = &quot;'\\F\017\234\172\196\024\142\255\161\145o\142\128\197&quot;
*)</code></pre>

<p>The error here is to try and carry a single instantiated hashing object around,
while trying to get hashes of distinct strings. But with the convergence after
the second step, the semantics of the hashing object still remains unclear to
us.</p>
<p>One can fairly easily overcome the API style mismatches by making a few
specialized wrappers, of course, except for two major problems:</p>
<ul><li><p>Cryptokit is pervasively stateful. While this is almost certainly a result of
 performance considerations combined with its goals of ease of
 compositionality, it directly clashes with the fundamental design property of
 the TLS library we wanted to use it in: our <code>ocaml-tls</code> library is stateless. We need to
 be able to represent the state the encryption engine is in as a value.</p>
</li><li><p>Cryptokit operates on strings. As a primary target of <code>ocaml-tls</code> was
 <a href="http://openmirage.org/">Mirage</a>, and Mirage uses separate, non-managed regions of memory to
 store network data in, we need to be able to handle foreign-allocated
 storage. This means <code>Bigarray</code> (as exposed by <code>Cstruct</code>), and it seems just
 plain wrong to negate all the careful zero-copy architecture of the stack
 below by copying everything into and out of strings.</p>
</li></ul>

<p>There are further problems. For example, Cryptokit makes no attempts to combat
well-known timing vulnerabilities. It has no support for elliptic curves. And it
depends on the system-provided random number generator, which does not exist
when running in the context of a unikernel.</p>
<p>At this point, with the <em>de facto</em> choice off the table, it's probably worth
thinking about writing OCaml bindings to a rock-solid cryptographic library
written in C.</p>
<p><a href="http://nacl.cr.yp.to/">NaCl</a> is a modern, well-regarded crypto implementation, created by a
group of pretty famous and equally well-regarded cryptographers, and was the
first choice. Or at least its more approachable and packageable <a href="http://labs.opendns.com/2013/03/06/announcing-sodium-a-new-cryptographic-library/">fork</a>
was, which already had <a href="https://github.com/dsheets/ocaml-sodium">OCaml bindings</a>. Unfortunately, <code>NaCl</code>
provides a narrow selection of implementations of various cryptographic
primitives, the ones its authors thought were best-of-breed (for example, the
only symmetric ciphers it implements are (X-)Salsa and AES in CTR mode). And
they are probably right (in some aspects they are <em>certainly</em> right), but NaCl
is best used for implementations of newly-designed security protocols. It is
simply too opinionated to support an old, standardized behemoth like TLS.</p>
<p>Then there is <a href="https://www.openssl.org/docs/crypto/crypto.html">crypto</a>, the library OpenSSL is built on top of. It
is quite famous and provides optimized implementations of a wide range of
cryptographic algorithms. It also contains upwards of 200,000 lines of C and a
very large API footprint, and it's unclear whether it would be possible to run
it in the unikernel context. Recently, the parent project it is embedded in has
become highly suspect, with one high-profile vulnerability piling on top of
another and at least <a href="http://www.libressl.org/">two</a> <a href="https://boringssl.googlesource.com/boringssl/">forks</a> so far attempting to
clean the code base. It just didn't feel like a healthy code base to build
a new project on.</p>
<p>There are other free cryptographic libraries in C one could try to bind, but at
a certain point we faced the question: is the work required to become intimately
familiar with the nuances and the API of an existing code base, and create
bindings for it in OCaml, really that much smaller than writing one from
scratch? When using a full library one commits to its security decisions and
starts depending on its authors' time to keep it up to date -- maybe this
effort is better spent in writing one in the first place.</p>
<p>Tantalizingly, the length of the single OCaml source file in <code>Cryptokit</code> is
2260 lines.</p>
<p>Maybe if we made <strong>zero</strong> decisions ourselves, informed all our work by published
literature and research, and wrote the bare minimum of code needed, it might not
even be dead-wrong to do it ourselves?</p>
<p>And that is the basic design principle. Do nothing fancy. Do only documented
things. Don't write too much code. Keep up to date with security research. Open
up and ask people.</p>
<h3>The anatomy of a simple crypto library</h3>

<p><code>nocrypto</code> uses bits of C, similarly to other cryptographic libraries written in
high-level languages.</p>
<p>This was actually less of a performance concern, and more of a security one: for
the low-level primitives which are tricky to implement and for which known,
compact and widely used code already exists, the implementation is probably
better reused. The major pitfall we hoped to avoid that way are side-channel
attacks.</p>
<p>We use public domain (or BSD licenced) <a href="https://github.com/mirleft/ocaml-nocrypto/tree/master/src/native">C sources</a> for the
simple cores of AES, 3DES, MD5, SHA and SHA2. The impact of errors in this code
is constrained: they contain no recursion, and they perform no allocation,
simply filling in caller-supplied fixed-size buffer by appropriate bytes.</p>
<p>The block implementations in C have a simple API that requires us to provide the
input and output buffers and a key, writing the single encrypted (or decrypted)
block of data into the buffer. Like this:</p>
<pre class="C"><code class="C">void rijndaelEncrypt(const unsigned long *rk, int nrounds,
  const unsigned char plaintext[16], unsigned char ciphertext[16]);

void rijndaelDecrypt(const unsigned long *rk, int nrounds,
  const unsigned char ciphertext[16], unsigned char plaintext[16]);</code></pre>

<p>The hashes can initialize a provided buffer to serve as an empty accumulator,
hash a single chunk of data into that buffer and convert its contents into a
digest, which is written into a provided fixed buffer.</p>
<p>In other words, all the memory management happens exclusively in OCaml and all
the buffers passed into the C layer are tracked by the garbage collector (GC).</p>
<h3>Symmetric ciphers</h3>

<p>So far, the only provided ciphers are AES, 3DES and ARC4, with ARC4 implemented
purely in OCaml (and provided only for TLS compatibility and for testing).</p>
<p>AES and 3DES are based on core C code, on top of which we built some standard
<a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">modes of operation</a> in OCaml. At the moment we support ECB, CBC
and CTR. There is also a nascent <a href="https://en.wikipedia.org/wiki/Galois/Counter_Mode">GCM</a> implementation which is, at the time
of writing, known not to be optimal and possibly prone to timing attacks, and
which we are still working on.</p>
<p>The exposed API strives to be simple and value-oriented. Each mode of each
cipher is packaged up as a module with a similar signature, with a pair of
functions for encryption and decryption. Each of those essentially takes a key
and a byte buffer and yields the resulting byte buffer, minimising hassle.</p>
<p>This is how you encrypt a message:</p>
<pre class="OCaml"><code class="OCaml">open Nocrypto.Block

let key = AES.CBC.of_secret Cstruct.(of_string &quot;abcd1234abcd1234&quot;)
and iv  = Cstruct.of_string &quot;1234abcd1234abcd&quot;
and msg = Cstruct.of_string &quot;fire the missile&quot;

let { AES.CBC.message ; iv } = AES.CBC.encrypt ~key ~iv msg</code></pre>

<p>The hashes implemented are just MD5, SHA and the SHA2 family. Mirroring the
block ciphers, they are based on C cores, with the HMAC construction provided in
OCaml. The API is similarly simple: each hash is a separate module with the same
signature, providing a function that takes a byte buffer to its digest, together
with several stateful operations for incremental computation of digests.</p>
<p>Of special note is that our current set of C sources will probably soon be
replaced. AES uses code that is vulnerable to a <a href="http://cr.yp.to/antiforgery/cachetiming-20050414.pdf">timing attack</a>,
stemming from the fact that substitution tables are loaded into the CPU cache
as-needed. The code does not take advantage of the <a href="https://en.wikipedia.org/wiki/AES_instruction_set">AES-NI</a>
instructions present in modern CPUs that allow AES to be hardware-assisted. SHA
and SHA2 cores turned out to be (comparatively) ill-performing, and static
analysis already uncovered some potential memory issues, so we are looking for
better implementations.</p>
<h3>Public-key cryptography</h3>

<p>Bignum arithmetic is provided by the excellent <a href="https://forge.ocamlcore.org/projects/zarith">zarith</a> library, which
in turn uses <a href="https://gmplib.org/">GMP</a>. This might create some portability problems later on,
but as GMP is widely used and well rounded code base which also includes some of
the needed auxiliary number-theoretical functions (its slightly extended
Miller-Rabin probabilistic primality test and the fast next-prime-scanning
function), it seemed like a much saner choice than redoing it from scratch.</p>
<p>The <a href="https://github.com/mirleft/ocaml-nocrypto/blob/a52bba2dcaf1c5fd45249588254dff2722e9f960/src/rsa.mli">RSA</a> module provides the basics: raw encryption and decryption,
<a href="https://en.wikipedia.org/wiki/PKCS_1">PKCS1</a>-padded versions of the same operations, and PKCS1 signing and
signature verification. It can generate RSA keys, which it does simply by
finding two large primes, in line with <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.310.4183">Rivest's</a> own
recommendation.</p>
<p>Notably, RSA implements the standard <a href="https://en.wikipedia.org/wiki/Blinding_(cryptography)">blinding</a> technique which can mitigate
some side-channel attacks, such as timing or <a href="http://www.cs.tau.ac.il/~tromer/acoustic/">acoustic</a>
cryptanalysis. It seems to foil even stronger, <a href="http://eprint.iacr.org/2013/448.pdf">cache eviction</a>
based attacks, but as of now, we are not yet completely sure.</p>
<p>The <a href="https://github.com/mirleft/ocaml-nocrypto/blob/a52bba2dcaf1c5fd45249588254dff2722e9f960/src/dh.mli">Diffie-Hellman</a> module is also relatively basic. We implement some
<a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.56.1921">widely</a> <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.21.639">recommended</a> checks on the incoming public key to
mitigate some possible MITM attacks, the module can generate strong DH groups
(using safe primes) with guaranteed large prime-order subgroup, and we provide
a catalogue of published DH groups ready for use.</p>
<h3>Randomness</h3>

<p>Random number generation used to be a chronically overlooked part of
cryptographic libraries, so much so that nowadays one of the first questions
about a crypto library is, indeed, &quot;Where does it get randomness from?&quot;</p>
<p>It's an important question. A cryptographic system needs unpredictability in
many places, and violating this causes catastrophic <a href="https://www.debian.org/security/2008/dsa-1571">failures</a>.</p>
<p><code>nocrypto</code> contains its own implementation of <a href="https://www.schneier.com/fortuna.html">Fortuna</a>. Like
<a href="https://www.schneier.com/yarrow.html">Yarrow</a>, Fortuna uses a strong block cipher in CTR mode (AES in our
case) to produce the pseudo-random stream, a technique that is considered as
unbreakable as the underlying cipher.</p>
<p>The stream is both self-rekeyed, and rekeyed with the entropy gathered into its
accumulator pool. Unlike the earlier designs, however, Fortuna is built without
entropy estimators, which usually help the PRNG decide when to actually convert
the contents of an entropy pool into the new internal state. Instead, Fortuna
uses a design where the pools are fed round-robin, but activated with an
exponential backoff. There is <a href="https://eprint.iacr.org/2014/167">recent research</a> showing this
design is essentially sound: after a state compromise, Fortuna wastes no more
than a constant factor of incoming entropy -- whatever the amount of entropy is
-- before coming back to an unpredictable state. The resulting design is both
simple, and robust in terms of its usage of environmental entropy.</p>
<p>The above paper also suggests a slight improvement to the accumulator regime,
yielding a factor-of-2 improvement in entropy usage over the original. We still
haven't implemented this, but certainly intend to.</p>
<p>A PRNG needs to be fed with some actual entropy to be able to produce
unpredictable streams. The library itself contains no provisions for doing this
and its PRNG needs to be fed by the user before any output can be produced. We
are <a href="https://github.com/mirage/mirage-entropy">working with the Mirage team</a> on exposing environmental
entropy sources and connecting them to our implementation of Fortuna.</p>
<h3>Above &amp; beyond</h3>

<p><code>nocrypto</code> is still very small, providing the bare minimum cryptographic
services to support TLS and related X.509 certificate operations. One of the
goals is to flesh it out a bit, adding some more widely deployed algorithms, in
hopes of making it more broadly usable.</p>
<p>There are several specific problems with the library at this stage:</p>
<p><strong>C code</strong> - As mentioned, we are seeking to replace some of the C code we use. The hash
cores are underperforming by about a factor of 2 compared to some other
implementations. AES implementation is on one hand vulnerable to a timing attack
and, on the other hand, we'd like to make use of hardware acceleration for this
workhorse primitive -- without it we lose about an order of magnitude of
performance.</p>
<p>Several options were explored, ranging from looking into the murky waters of
OpenSSL and trying to exploit their heavily optimized primitives, to bringing
AES-NI into OCaml and redoing AES in OCaml. At this point, it is not clear which
path we'll take.</p>
<p><strong>ECC</strong> - Looking further, the library still lacks support for elliptic curve cryptography
and we have several options for solving this. Since it is used by TLS, ECC is
probably the missing feature we will concentrate on first.</p>
<p><strong>Entropy on Xen</strong> - The entropy gathering on Xen is incomplete. The current prototype uses current
time as the random seed and the effort to expose noisier sources like interrupt
timings and the RNG from dom0's kernel is still ongoing.  Dave Scott, for example, has
<a href="http://lists.xen.org/archives/html/xen-devel/2014-06/msg01492.html">submitted patches</a> to upstream Xen to make it easier to establish low-bandwidth
channels to supplies guest VMs with strong entropy from a privileged domain
that has access to physical devices and hence high-quality entropy sources.</p>
<p><strong>GC timing attacks?</strong> - There is the question of GC and timing attacks: whether doing
cryptography in a high-level language opens up a completely new surface for
timing attacks, given that GC runs are very visible in the timing profile. The
basic approach is to leave the core routines which we know are potentially
timing-sensitive (like AES) and for which we don't have explicit timing
mitigations (like RSA) to C, and invoke them atomically from the perspective of
the GC. So far, it's an open question whether the constructions built on top
of them expose further side-channels.</p>
<p>Still, we believe that the whole package is a pleasant library to work with. Its
simplicity contributes to the comparative simplicity of the entire TLS library,
and we are actively seeking input on areas that need further improvement.
Although we are obviously biased, we believe it is the best cryptographic base
library available for this project, and it might be equally suited for your next
project too!</p>
<p>We are striving to be open about the current security status of our code. You
are free to check out our <a href="https://github.com/mirleft/ocaml-nocrypto/issues?state=open">issue tracker</a> and invited to contribute
comments, ideas, and especially audits and code.</p>
<p></p><hr/>Posts in this TLS series:
<ul><li><a href="http://openmirage.org/blog/introducing-ocaml-tls">Introducing transport layer security (TLS) in pure OCaml</a></li><li><a href="http://openmirage.org/blog/introducing-nocrypto">OCaml-TLS: building the nocrypto library core</a></li><li><a href="http://openmirage.org/blog/introducing-x509">OCaml-TLS: adventures in X.509 certificate parsing and validation</a></li><li><a href="http://openmirage.org/blog/introducing-asn1">OCaml-TLS: ASN.1 and notation embedding</a></li><li><a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">OCaml-TLS: the protocol implementation and mitigations to known attacks</a></li></ul>


   <a onclick="switchContent('ocamlorg-post46','ocamlorg-post45')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-nocrypto">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/introducing-nocrypto">by David Kaloper at Jul 09, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/introducing-ocaml-tls">
    <a name="#http://openmirage.org/blog/introducing-ocaml-tls"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/introducing-ocaml-tls">Introducing transport layer security (TLS) in pure OCaml</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post47">
      <p>We announce a <strong>beta</strong> release of <code>ocaml-tls</code>, a clean-slate implementation of
<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Layer Security</a> (TLS) in
OCaml.</p>
<h3>What is TLS?</h3>

<p>Transport Layer Security (TLS) is probably the most widely deployed
security protocol on the Internet. It provides communication privacy
to prevent eavesdropping, tampering, and message forgery. Furthermore,
it optionally provides authentication of the involved endpoints. TLS
is commonly deployed for securing web services (<a href="http://tools.ietf.org/html/rfc2818">HTTPS</a>), emails,
virtual private networks, and wireless networks.</p>
<p>TLS uses asymmetric cryptography to exchange a symmetric key, and
optionally authenticate (using X.509) either or both endpoints. It
provides algorithmic agility, which means that the key exchange
method, symmetric encryption algorithm, and hash algorithm are
negotiated.</p>
<h3>TLS in OCaml</h3>

<p>Our implementation <a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a> is already able to interoperate with
existing TLS implementations, and supports several important TLS extensions
such as server name indication (<a href="https://tools.ietf.org/html/rfc4366">RFC4366</a>, enabli&hellip;</p><a onclick="switchContent('ocamlorg-post47','ocamlorg-post48')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-ocaml-tls">Read more...</a></div><div id="ocamlorg-post48" style="display: none">
      <p>We announce a <strong>beta</strong> release of <code>ocaml-tls</code>, a clean-slate implementation of
<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">Transport Layer Security</a> (TLS) in
OCaml.</p>
<h3>What is TLS?</h3>

<p>Transport Layer Security (TLS) is probably the most widely deployed
security protocol on the Internet. It provides communication privacy
to prevent eavesdropping, tampering, and message forgery. Furthermore,
it optionally provides authentication of the involved endpoints. TLS
is commonly deployed for securing web services (<a href="http://tools.ietf.org/html/rfc2818">HTTPS</a>), emails,
virtual private networks, and wireless networks.</p>
<p>TLS uses asymmetric cryptography to exchange a symmetric key, and
optionally authenticate (using X.509) either or both endpoints. It
provides algorithmic agility, which means that the key exchange
method, symmetric encryption algorithm, and hash algorithm are
negotiated.</p>
<h3>TLS in OCaml</h3>

<p>Our implementation <a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a> is already able to interoperate with
existing TLS implementations, and supports several important TLS extensions
such as server name indication (<a href="https://tools.ietf.org/html/rfc4366">RFC4366</a>, enabling virtual hosting)
and secure renegotiation (<a href="https://tools.ietf.org/html/rfc5746">RFC5746</a>).</p>
<p>Our <a href="https://tls.openmirage.org/">demonstration server</a> runs <code>ocaml-tls</code> and renders exchanged
TLS messages in nearly real time by receiving a trace of the TLS
session setup. If you encounter any problems, please give us <a href="https://github.com/mirleft/ocaml-tls/issues">feedback</a>.</p>
<p><code>ocaml-tls</code> and all dependent libraries are available via <a href="https://opam.ocaml.org/packages/tls/tls.0.1.0/">OPAM</a> (<code>opam install tls</code>). The <a href="https://github.com/mirleft/ocaml-tls">source is available</a>
under a BSD license. We are primarily working towards completeness of
protocol features, such as client authentication, session resumption, elliptic curve and GCM
cipher suites, and have not yet optimised for performance.</p>
<p><code>ocaml-tls</code> depends on the following independent libraries: <a href="https://github.com/mirleft/ocaml-nocrypto">ocaml-nocrypto</a> implements the
cryptographic primitives, <a href="https://github.com/mirleft/ocaml-asn1-combinators">ocaml-asn1-combinators</a> provides ASN.1 parsers/unparsers, and
<a href="https://github.com/mirleft/ocaml-x509">ocaml-x509</a> implements the X509 grammar and certificate validation (<a href="https://tools.ietf.org/html/rfc5280">RFC5280</a>). <a href="https://github.com/mirleft/ocaml-tls">ocaml-tls</a> implements TLS (1.0, 1.1 and 1.2; <a href="https://tools.ietf.org/html/rfc2246">RFC2246</a>,
<a href="https://tools.ietf.org/html/rfc4346">RFC4346</a>, <a href="https://tools.ietf.org/html/rfc5246">RFC5246</a>).</p>
<p>We invite the community to audit and run our code, and we are particularly interested in discussion of our APIs.
Please use the <a href="http://lists.xenproject.org/archives/html/mirageos-devel/">mirage-devel mailing list</a> for discussions.</p>
<p><strong>Please be aware that this release is a <em>beta</em> and is missing external code audits.
It is not yet intended for use in any security critical applications.</strong></p>
<p>In our <a href="https://github.com/mirleft/ocaml-tls/issues">issue tracker</a> we transparently document known attacks against TLS and our mitigations
(<a href="https://github.com/mirleft/ocaml-tls/issues?labels=security%20concern&amp;page=1&amp;state=open">checked</a> and <a href="https://github.com/mirleft/ocaml-tls/issues?labels=security%20concern&amp;page=1&amp;state=closed">unchecked</a>).
We have not yet implemented mitigations against either the
<a href="http://www.isg.rhul.ac.uk/tls/Lucky13.html">Lucky13</a> timing attack or traffic analysis (e.g. <a href="http://tools.ietf.org/html/draft-pironti-tls-length-hiding-02">length-hiding padding</a>).</p>
<h3>Trusted code base</h3>

<p>Designed to run on Mirage, the trusted code base of <code>ocaml-tls</code> is small. It includes the libraries already mentioned,
<a href="https://github.com/mirleft/ocaml-tls">`ocaml-tls`</a>, <a href="https://github.com/mirleft/ocaml-asn1-combinators">`ocaml-asn-combinators`</a>, <a href="https://github.com/mirleft/ocaml-x509">`ocaml-x509`</a>,
and <a href="https://github.com/mirleft/ocaml-nocrypto">`ocaml-nocrypto`</a> (which uses C implementations of block
ciphers and hash algorithms). For arbitrary precision integers needed in 
asymmetric cryptography, we rely on <a href="https://forge.ocamlcore.org/projects/zarith">`zarith`</a>, which wraps
<a href="https://gmplib.org/">`libgmp`</a>. As underlying byte array structure we use
<a href="https://github.com/mirage/ocaml-cstruct">`cstruct`</a> (which uses OCaml <code>Bigarray</code> as storage).</p>
<p>We should also mention the OCaml runtime, the OCaml compiler, the
operating system on which the source is compiled and the binary is executed, as
well as the underlying hardware. Two effectful frontends for
the pure TLS core are implemented, dealing
with side-effects such as reading and writing from the network: <a href="http://ocsigen.org/lwt/api/Lwt_unix">Lwt_unix</a> and
Mirage, so applications can run directly as a Xen unikernel.</p>
<h3>Why a new TLS implementation?</h3>

<p><strong>Update:</strong>
Thanks to <a href="http://frama-c.com/">Frama-C</a> guys for <a href="https://twitter.com/spun_off/status/486535304426188800">pointing</a> <a href="https://twitter.com/spun_off/status/486536572792090626">out</a>
that <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-1266">CVE-2014-1266</a> and <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0224">CVE-2014-0224</a> are <em>not</em> memory safety issues, but
logic errors. This article previously stated otherwise.</p>
<p>There are only a few TLS implementations publicly available and most
programming languages bind to OpenSSL, an open source implementation written
in C. There are valid reasons to interface with an existing TLS library,
rather than developing one from scratch, including protocol complexity and
compatibility with different TLS versions and implementations. But from our
perspective the disadvantage of most existing libraries is that they
are written in C, leading to:</p>
<ul><li>Memory safety issues, as recently observed by <a href="https://en.wikipedia.org/wiki/Heartbleed">Heartbleed</a> and GnuTLS
 session identifier memory corruption (<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3466">CVE-2014-3466</a>) bugs;</li><li>Control flow complexity (Apple's goto fail, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-1266">CVE-2014-1266</a>);</li><li>And difficulty in encoding state machines (OpenSSL change cipher suite
 attack, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0224">CVE-2014-0224</a>).</li></ul>

<p>Our main reasons for <code>ocaml-tls</code> are that OCaml is a modern functional
language, which allows concise and declarative descriptions of the
complex protocol logic and provides type safety and memory safety to help
guard against programming errors. Its functional nature is extensively
employed in our code: the core of the protocol is written in purely
functional style, without any side effects.</p>
<p>Subsequent blog posts <a href="https://github.com/mirage/mirage/issues/257">over the coming
days</a> will examine in more detail
the design and implementation of the four libraries, as well as the security
trade-offs and some TLS attacks and our mitigations against them.  For now
though, we invite you to try out our <strong><a href="https://tls.openmirage.org/">demonstration server</a></strong>
running our stack over HTTPS.  We're particularly interested in feedback on our <a href="https://github.com/mirleft/ocaml-tls">issue tracker</a> about
clients that fail to connect, and any queries from anyone reviewing the <a href="https://github.com/mirleft/">source code</a>
of the constituent libraries.</p>
<p></p><hr/>Posts in this TLS series:
<ul><li><a href="http://openmirage.org/blog/introducing-ocaml-tls">Introducing transport layer security (TLS) in pure OCaml</a></li><li><a href="http://openmirage.org/blog/introducing-nocrypto">OCaml-TLS: building the nocrypto library core</a></li><li><a href="http://openmirage.org/blog/introducing-x509">OCaml-TLS: adventures in X.509 certificate parsing and validation</a></li><li><a href="http://openmirage.org/blog/introducing-asn1">OCaml-TLS: ASN.1 and notation embedding</a></li><li><a href="http://openmirage.org/blog/ocaml-tls-api-internals-attacks-mitigation">OCaml-TLS: the protocol implementation and mitigations to known attacks</a></li></ul>


   <a onclick="switchContent('ocamlorg-post48','ocamlorg-post47')" class="btn planet-toggle" href="#http://openmirage.org/blog/introducing-ocaml-tls">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/introducing-ocaml-tls">by Hannes Mehnert at Jul 08, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/mirage-1.2-released">
    <a name="#http://openmirage.org/blog/mirage-1.2-released"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/mirage-1.2-released">Mirage 1.2 released and the 2.0 runup begins</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post49">
      <p>Summer is in full swing here in Mirage HQ with torrential rainstorms, searing
sunshine, and our <a href="http://www.oscon.com/oscon2014/public/schedule/detail/35024">OSCON 2014</a> talk
rapidly approaching in just a few weeks.  We've been steadily releasing point releases
since the <a href="http://openmirage.org/blog/mirage-1.1-released">first release</a> back in December, and today's <a href="https://github.com/mirage/mirage/releases/tag/v1.2.0">Mirage
1.2.0</a> is the last of the <code>1.x</code> series.
The main improvements are usability-oriented:</p>
<ul><li><p>The Mirage frontend tool now generates a <code>Makefile</code> with a <code>make depend</code>
 target, instead of directly invoking OPAM as part of <code>mirage configure</code>.
 This greatly improves usability on slow platforms such as ARM, since the
 output of OPAM as it builds can be inspected more easily. Users will now
 need to run <code>make depend</code> to ensure they have the latest package set
 before building their unikernel.</p>
</li><li><p>Improve formatting of the <code>mirage</code> output, including pretty colours!
 This makes it easier to distinguish complex unikernel configurations
 that have lots of deployment options.  The generated files are built
 more verbosely by default to facilitate debugging, &hellip;</p></li></ul><a onclick="switchContent('ocamlorg-post49','ocamlorg-post50')" class="btn planet-toggle" href="#http://openmirage.org/blog/mirage-1.2-released">Read more...</a></div><div id="ocamlorg-post50" style="display: none">
      <p>Summer is in full swing here in Mirage HQ with torrential rainstorms, searing
sunshine, and our <a href="http://www.oscon.com/oscon2014/public/schedule/detail/35024">OSCON 2014</a> talk
rapidly approaching in just a few weeks.  We've been steadily releasing point releases
since the <a href="http://openmirage.org/blog/mirage-1.1-released">first release</a> back in December, and today's <a href="https://github.com/mirage/mirage/releases/tag/v1.2.0">Mirage
1.2.0</a> is the last of the <code>1.x</code> series.
The main improvements are usability-oriented:</p>
<ul><li><p>The Mirage frontend tool now generates a <code>Makefile</code> with a <code>make depend</code>
 target, instead of directly invoking OPAM as part of <code>mirage configure</code>.
 This greatly improves usability on slow platforms such as ARM, since the
 output of OPAM as it builds can be inspected more easily. Users will now
 need to run <code>make depend</code> to ensure they have the latest package set
 before building their unikernel.</p>
</li><li><p>Improve formatting of the <code>mirage</code> output, including pretty colours!
 This makes it easier to distinguish complex unikernel configurations
 that have lots of deployment options.  The generated files are built
 more verbosely by default to facilitate debugging, and with debug
 symbols and backtraces enabled by default.</p>
</li><li><p>Added several <a href="https://github.com/mirage/mirage/tree/master/types">device module types</a>, including <code>ENTROPY</code> for random
 noise, <code>FLOW</code> for stream-oriented connections, and exposed the <code>IPV4</code>
 device in the <code>STACKV4</code> TCP/IP stack type.</p>
</li><li><p>Significant bugfixes in supporting libraries such as the TCP/IP
 stack (primarily thanks to <a href="http://www.somerandomidiot.com/">Mindy Preston</a> fuzz testing
 and finding some good <a href="https://github.com/mirage/mirage-tcpip/issues/56">zingers</a>).  There are too many
 library releases to list individually here, but you can <a href="http://openmirage.org/releases">browse the changelog</a> for more details.</p>
</li></ul>

<h4>&nbsp;Towards Mirage OS 2.0</h4>

<p>We've also been working hard on the <strong>Mirage OS 2.x series</strong>, which introduces
a number of new features and usability improvements that emerged from actually
using the tools in practical projects.  Since there have been so many <a href="http://openmirage.org/blog/welcome-to-our-summer-hackers">new
contributors</a> recently,
<a href="http://amirchaudhry.com">Amir Chaudhry</a> is coordinating a <a href="https://github.com/mirage/mirage/issues/257">series of blog
posts</a> in the runup to
<a href="http://www.oscon.com/oscon2014/public/schedule/detail/35024">OSCON</a> that
explains the new work in depth.  Once the release rush has subsided, we'll
be working on integrating these posts into our <a href="http://openmirage.org/docs">documentation</a>
properly.</p>
<p>The new 2.0 features include the <a href="https://github.com/mirage/irmin">Irmin</a> branch-consistent distributed storage
library, the pure OCaml <a href="https://github.com/mirleft/">TLS stack</a>, <a href="https://github.com/mirage/mirage-platform/pull/93">Xen/ARM support</a> and the Conduit I/O
subsystem for <a href="http://anil.recoil.org/papers/2012-resolve-fable.pdf">mapping names to connections</a>.  Also included in the blog series
are some sample usecases on how these tie together for real applications (as a
teaser, here's a video of <a href="https://www.youtube.com/watch?v=DSzvFwIVm5s">Xen VMs booting using
Irmin</a> thanks to <a href="http://dave.recoil.org">Dave
Scott</a> and <a href="http://gazagnaire.org">Thomas Gazagnaire</a>!)</p>
<h4>Upcoming talks and tutorials</h4>

<p><a href="http://mort.io">Richard Mortier</a> and myself will be gallivanting around the world
to deliver a few talks this summer:</p>
<ul><li>The week of <a href="http://www.oscon.com/oscon2014">OSCON</a> on July 20th-24th.  Please get in touch via the conference website or a direct e-mail, or <a href="http://www.oscon.com/oscon2014/public/schedule/detail/35024">attend our talk</a> on Thursday morning.
There's a <a href="https://realworldocaml.org">Real World OCaml</a> book signing on Tuesday morning for the super keen as well.</li><li>The <a href="http://ecoop14.it.uu.se/programme/ecoop-school.php">ECOOP summer school</a> in beautiful Uppsala in Sweden on Weds 30th July. </li><li>I'll be presenting the Irmin and Xen integration at <a href="http://events.linuxfoundation.org/events/xen-project-developer-summit">Xen Project Developer Summit</a> in
 Chicago on Aug 18th (as part of LinuxCon North America).  <a href="http://mort.io">Mort</a> and <a href="http://somerandomidiot.com">Mindy</a> (no jokes please) will be
 joining the community panel about <a href="http://openmirage.org/blog/applying-for-gsoc2014">GSoC/OPW</a> participation.</li></ul>

<p>As always, if there are any particular topics you would like to see more
on, then please comment on the <a href="https://github.com/mirage/mirage/issues/257">tracking issue</a>
or <a href="http://openmirage.org/community">get in touch directly</a>.  There will be a lot of releases coming out
in the next few weeks (including a beta of the new version of <a href="http://opam.ocaml.org">OPAM</a>,
so <a href="https://github.com/mirage/mirage/issues">bug reports</a> are very much appreciated for those
things that slip past <a href="http://travis-ci.org">Travis CI</a>!</p>

   <a onclick="switchContent('ocamlorg-post50','ocamlorg-post49')" class="btn planet-toggle" href="#http://openmirage.org/blog/mirage-1.2-released">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/mirage-1.2-released">by Anil Madhavapeddy at Jul 08, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://ocamllabs.github.com/compiler-hacking/2014/06/24/highlights-from-recent-sessions">
    <a name="#http://ocamllabs.github.com/compiler-hacking/2014/06/24/highlights-from-recent-sessions"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../images/hax0ring.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://ocamllabs.github.com/compiler-hacking/2014/06/24/highlights-from-recent-sessions">Highlights from recent sessions</a>
      (<a href="http://ocamllabs.github.io/compiler-hacking/rss.xml" title="OCaml Labs compiler hacking">Compiler Hacking</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post51"><h2>Highlights from recent sessions</h2>

<p>With the <a href="http://ocamllabs.github.io/compiler-hacking/2014/06/20/sixth-compiler-hacking-session.html">next compiler hacking meeting</a> due to take place in a couple of days it's time for a look back at some results from our last couple of sessions.</p>

<p><a></a></p>

<h3>The front end</h3>

<figure style="float: right; padding: 15px; width: 350px">
<img src="https://farm3.staticflickr.com/2756/4150220583_57a993cc61_z_d.jpg" style="width: 350px" alt="Camel front end"/><br/>
<figcaption><center><small>(<a href="https://www.flickr.com/photos/paperpariah/4150220583"><i>today I stared a camel in the face</i></a> by <a href="https://www.flickr.com/photos/paperpariah/">Adam Foster</a>)</small></center></figcaption>
</figure>

<p>The front end (i.e. <a href="https://realworldocaml.org/v1/en/html/the-compiler-frontend-parsing-and-type-checking.html">the parser and type checker</a>) saw a number of enhancements.</p>

<p><a></a></p>

<h4>Succinct functor syntax</h4>

<p>Syntax tweaks are always popular, if <a href="http://www.haskell.org/haskellwiki/Wadler's_Law">often contentious</a>.   However, reaching agreement is significantly easier when adding syntax is a simple matter of extending an existing correspondence between two parts of the language.  For example, it was clear which syntax to use when adding support for <a href="http://caml.inria.fr/pub/docs/manual-ocaml-400/manual021.html#toc73">lazy patterns</a>: since patterns generally mirror the syntax for the values they match, patterns for destructing lazy values should use the same <code>lazy</code> keyword as the expressions which construct them.</p>

<p>A second correspondence in OCaml's syntax relates modules and values.  Module names and variables are both bound with <code>=</code>; module signatures and&hellip;</p><a onclick="switchContent('ocamlorg-post51','ocamlorg-post52')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/06/24/highlights-from-recent-sessions">Read more...</a></div><div id="ocamlorg-post52" style="display: none"><h2>Highlights from recent sessions</h2>

<p>With the <a href="http://ocamllabs.github.io/compiler-hacking/2014/06/20/sixth-compiler-hacking-session.html">next compiler hacking meeting</a> due to take place in a couple of days it's time for a look back at some results from our last couple of sessions.</p>

<p><a name="the-front-end"></a></p>

<h3>The front end</h3>

<figure style="float: right; padding: 15px; width: 350px">
<img src="https://farm3.staticflickr.com/2756/4150220583_57a993cc61_z_d.jpg" style="width: 350px" alt="Camel front end"/><br/>
<figcaption><center><small>(<a href="https://www.flickr.com/photos/paperpariah/4150220583"><i>today I stared a camel in the face</i></a> by <a href="https://www.flickr.com/photos/paperpariah/">Adam Foster</a>)</small></center></figcaption>
</figure>

<p>The front end (i.e. <a href="https://realworldocaml.org/v1/en/html/the-compiler-frontend-parsing-and-type-checking.html">the parser and type checker</a>) saw a number of enhancements.</p>

<p><a name="succinct-functor-syntax"></a></p>

<h4>Succinct functor syntax</h4>

<p>Syntax tweaks are always popular, if <a href="http://www.haskell.org/haskellwiki/Wadler's_Law">often contentious</a>.   However, reaching agreement is significantly easier when adding syntax is a simple matter of extending an existing correspondence between two parts of the language.  For example, it was clear which syntax to use when adding support for <a href="http://caml.inria.fr/pub/docs/manual-ocaml-400/manual021.html#toc73">lazy patterns</a>: since patterns generally mirror the syntax for the values they match, patterns for destructing lazy values should use the same <code>lazy</code> keyword as the expressions which construct them.</p>

<p>A second correspondence in OCaml's syntax relates modules and values.  Module names and variables are both bound with <code>=</code>; module signatures and types are both ascribed with <code>:</code>; module fields and record fields are both projected with <code>.</code>.  The syntax for functors and functions is also similar, but the latter offers a number of shortcuts not available in the module language; you can write</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> <span class="o">-&gt;</span> <span class="n">e</span>
</code></pre></div>
<p>instead of the more prolix equivalent:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">fun</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="k">fun</span> <span class="n">z</span> <span class="o">-&gt;</span> <span class="n">e</span>
</code></pre></div>
<p>but multi-argument functors must be written out in full:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">functor</span> <span class="o">(</span><span class="nc">X</span> <span class="o">:</span> <span class="nc">R</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">Y</span> <span class="o">:</span> <span class="nc">S</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">Z</span> <span class="o">:</span> <span class="nc">T</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">M</span>
</code></pre></div>
<p>In February's meeting, <a href="http://gazagnaire.org">Thomas</a> wrote a <a href="https://github.com/ocaml/ocaml/pull/16">patch</a> that adds an analogue of the shorter syntax to the module language, allowing the repeated <code>functor</code> to be left out:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">functor</span> <span class="o">(</span><span class="nc">X</span> <span class="o">:</span> <span class="nc">R</span><span class="o">)</span> <span class="o">(</span><span class="nc">Y</span> <span class="o">:</span> <span class="nc">S</span><span class="o">)</span> <span class="o">(</span><span class="nc">Z</span> <span class="o">:</span> <span class="nc">T</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">M</span>
</code></pre></div>
<p>The patch also adds support for a corresponding abbreviation at the module type level.  Defining the type of a multi-argument functor currently involves writing a rather clunky sequence of <code>functor</code> abstractions:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">module</span> <span class="k">type</span> <span class="nc">F</span> <span class="o">=</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">X</span> <span class="o">:</span> <span class="nc">R</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">Y</span> <span class="o">:</span> <span class="nc">S</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">Z</span> <span class="o">:</span> <span class="nc">T</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">U</span>
</code></pre></div>
<p>With Thomas's patch all but the first occurrence of <code>functor</code> disappear:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">module</span> <span class="k">type</span> <span class="nc">F</span> <span class="o">=</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">X</span> <span class="o">:</span> <span class="nc">R</span><span class="o">)</span> <span class="o">(</span><span class="nc">Y</span> <span class="o">:</span> <span class="nc">S</span><span class="o">)</span> <span class="o">(</span><span class="nc">Z</span> <span class="o">:</span> <span class="nc">T</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">U</span>
</code></pre></div>
<p>Since Thomas's patch has been merged into trunk, you can try out the new syntax using the <a href="http://alan.petitepomme.net/cwn/2014.05.27.html#2">4.02.0 beta</a>, which is available as a compiler switch in the OPAM repository:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">opam switch 4.02.0+trunk
</code></pre></div>
<p>The next step is to find out whether the verbose syntax was a symptom or a cause of the infrequency of higher-order functors in OCaml code.  Will we see a surge in the popularity of higher-order modules as the syntax becomes more accommodating?</p>

<p><a name="integer-ranges"></a></p>

<h4>Integer ranges</h4>

<p><a href="http://github.com/dsheets">David</a> started work on extending OCaml's range patterns, which currently support only characters, to support <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on#wiki-integer-range-patterns">integer ranges</a>.  For example, consider the following <a href="https://github.com/ygrek/mldonkey/blob/03896bfc/src/utils/ocamlrss/rss_date.ml#L195-L202">code from MLDonkey</a>:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">match</span> <span class="n">mdn</span> <span class="k">with</span>
  <span class="nc">None</span>       <span class="k">when</span> <span class="n">h</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="mi">23</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">h</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="bp">false</span> <span class="k">when</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="mi">11</span>  <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">h</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="bp">false</span> <span class="k">when</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">12</span>            <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="mi">0</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="bp">true</span>  <span class="k">when</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="mi">11</span>  <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">h</span> <span class="o">+</span> <span class="mi">12</span><span class="o">)</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="bp">true</span>  <span class="k">when</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">12</span>            <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="mi">12</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="o">_</span>                            <span class="o">-&gt;</span> <span class="nc">None</span>
<span class="o">|</span> <span class="nc">None</span>                              <span class="o">-&gt;</span> <span class="nc">None</span>
</code></pre></div>
<p>Although this is fairly clear, it could be made even clearer if we had a <a href="http://en.wikipedia.org/wiki/Rule_of_least_power"><em>less</em> powerful language</a> for expressing the tests involving <code>h</code>.  Since the whole OCaml language is available in the <code>when</code> guard of a case, the reader has to examine the code carefully before concluding that the tests are all simple range checks.  Perhaps worse, using guards inhibits the useful checks that the OCaml compiler performs to determine whether patterns are exhaustive or redundant.  David's patch makes it possible to rewrite the tests without guards, making the simple nature of the tests on <code>h</code> clear at a glance (and making it possible once again to check exhaustiveness and redundancy):</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">match</span> <span class="n">mdn</span><span class="o">,</span> <span class="n">h</span> <span class="k">with</span>
  <span class="nc">None</span>      <span class="o">,</span> <span class="mi">0</span><span class="o">..</span><span class="mi">23</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="bp">false</span><span class="o">,</span> <span class="mi">1</span><span class="o">..</span><span class="mi">11</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">h</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="bp">false</span><span class="o">,</span> <span class="mi">12</span>    <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="mi">0</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="bp">true</span> <span class="o">,</span> <span class="mi">1</span><span class="o">..</span><span class="mi">11</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">h</span> <span class="o">+</span> <span class="mi">12</span><span class="o">)</span>
<span class="o">|</span> <span class="nc">Some</span> <span class="bp">true</span> <span class="o">,</span> <span class="mi">12</span>    <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="mi">12</span>
<span class="o">|</span> <span class="o">_</span>                 <span class="o">-&gt;</span> <span class="nc">None</span>
</code></pre></div>
<p>The work on range patterns led to a robust exchange of views about which other types should be supported -- should we support any enumerable type (e.g. variants with nullary constructors)? or perhaps even any ordered type (e.g. floats or strings)?  For the moment, there seems to be a much clearer consensus in favour of supporting integer types than there is for generalising range patterns any further.</p>

<p><a name="extensible-variants"></a></p>

<h4>Extensible variants</h4>

<p>Since the compiler hacking group only meets for an evening every couple of months or so, most of the <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">projects we work on</a> are designed so that it's possible to implement them in a few hours.  <a href="http://www.lpw25.net/">Leo</a>'s proposal for extensible variants is a notable exception, <a href="https://sympa.inria.fr/sympa/arc/caml-list/2012-01/msg00050.html">predating</a> both the <a href="http://ocamllabs.github.io/compiler-hacking/2013/09/17/compiler-hacking-july-2013.html">compiler hacking group</a> and <a href="http://anil.recoil.org/2012/10/19/announcing-ocaml-labs.html">OCaml Labs</a> itself.</p>

<p>Extensible variants generalise exceptions: with Leo's patch the exception type <code>exn</code> becomes a particular instance of a class of types that can be defined by the user rather than a special builtin provided by the compiler:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="c">(* Define an extensible variant type *)</span>
<span class="k">type</span> <span class="n">exn</span> <span class="o">=</span> <span class="o">..</span>

<span class="c">(* Extend the type with a constructor *)</span>
<span class="k">type</span> <span class="n">exn</span> <span class="o">+=</span> <span class="nc">Not_found</span>

<span class="c">(* Extend the type with another constructor *)</span>
<span class="k">type</span> <span class="n">exn</span> <span class="o">+=</span> <span class="nc">Invalid_argument</span> <span class="k">of</span> <span class="kt">string</span>
</code></pre></div>
<p>Even better, extensible variants come with all the power of regular variant types: they can take type parameters, and even support GADT definitions:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="c">(* Define a parameterised extensible variant type *)</span>
<span class="k">type</span> <span class="k">'</span><span class="n">a</span> <span class="n">error</span> <span class="o">=</span> <span class="o">..</span>

<span class="c">(* Extend the type with a constructor *)</span>
<span class="k">type</span> <span class="k">'</span><span class="n">a</span> <span class="n">error</span> <span class="o">=</span> <span class="nc">Error</span> <span class="k">of</span> <span class="k">'</span><span class="n">a</span>

<span class="c">(* Extend the type with a GADT constructor *)</span>
<span class="k">type</span> <span class="k">'</span><span class="n">a</span> <span class="n">error</span> <span class="o">:</span> <span class="nc">IntError</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="n">error</span>
</code></pre></div>
<p>On the evening of the last compiler hacking meeting, Leo <a href="http://caml.inria.fr/mantis/view.php?id=5584#c11335">completed</a> the patch; shortly afterwards it was <a href="https://github.com/ocaml/ocaml/commit/b56dc4b3df8d022b54f40682a9d5d4168c690413">merged to trunk</a>, ready for inclusion in <a href="http://alan.petitepomme.net/cwn/2014.05.27.html#2">OCaml 4.02</a>!</p>

<p>Extensible variants are a significant addition to the language, and there's more to them than these simple examples show.  A forthcoming post from Leo will describe the new feature in more detail.  In the meantime, since they've been merged into the 4.02 release candidate, you can try them out with OPAM:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">opam switch 4.02.0+trunk
</code></pre></div>
<p><a name="lazy-record-fields"></a></p>

<h4>Lazy record fields</h4>

<p>Not everything we work on makes is destined to make it upstream.  A few years ago, <a href="http://alain.frisch.fr/">Alain Frisch</a> <a href="http://www.lexifi.com/blog/ocaml-extensions-lexifi-semi-implicit-laziness">described</a> an OCaml extension in use at <a href="http://lexifi.com/">Lexifi</a> for marking record fields lazy, making it possible to delay the evaluation of initializing expressions without writing the <code>lazy</code> keyword every time a record is constructed.  Alain's post was received enthusiastically, and lazy record fields seemed like an obvious candidate for inclusion upstream, so in April's meeting Thomas put together a <a href="https://github.com/ocaml/ocaml/pull/48">patch</a> implementing the design.  Although the OCaml team decided not to merge the patch, it led to an enlightening <a href="https://github.com/ocaml/ocaml/pull/48#issuecomment-41758626">discussion</a> with comments from several core developers, including Alain, who described <a href="https://github.com/ocaml/ocaml/pull/48#issuecomment-41758626">subsequent, less positive, experience with the feature at Lexifi</a>, and Xavier, who explained the <a href="https://github.com/ocaml/ocaml/pull/48#issuecomment-41779525">rationale underlying the current design</a>.</p>

<p><a name="back-end"></a></p>

<h3>The back end</h3>

<figure style="float: right; padding: 15px; width: 350px">
<img src="http://farm4.staticflickr.com/3157/2877029132_b34943c8d7_z_d.jpg" style="width: 350px" alt="Camel back end"/><br/>
<figcaption><center><small>(<a href="http://www.flickr.com/photos/16230215@N08/2877029132"><i>Relief</i></a>
by <a href="http://www.flickr.com/photos/h-k-d/">Hartwig HKD</a>)</small></center></figcaption>
</figure>

<p>The OCaml back end (i.e. the <a href="https://realworldocaml.org/v1/en/html/the-compiler-backend-byte-code-and-native-code.html">code generation portion of the compiler</a>) also saw a proposed enhancement.</p>

<p><a name="constant-arithmetic-optimization"></a></p>

<h4>Constant arithmetic optimization</h4>

<p>Stephen submitted a <a href="https://github.com/ocaml/ocaml/pull/17">patch</a> improving the generated code for functions that perform constant arithmetic on integers.</p>

<p>In OCaml, integers and characters are <a href="https://realworldocaml.org/v1/en/html/memory-representation-of-values.html#table20-1_ocaml">represented as shifted immediate values</a>, with the least significant bit set to distinguish them from pointers.  This makes some arithmetic operations <a href="https://realworldocaml.org/v1/en/html/memory-representation-of-values.html#idm181610127856">a little more expensive</a>.  For example, consider a function that <code>int_of_digits</code> that builds an integer from three character digits:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="n">int_of_digits</span> <span class="sc">'3'</span> <span class="sc">'4'</span> <span class="sc">'5'</span> <span class="o">=&gt;</span> <span class="mi">345</span>
</code></pre></div>
<p>We might define <code>int_of_digits</code> as follows:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">int_of_digits</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">=</span> 
  <span class="mi">100</span> <span class="o">*</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">a</span> <span class="o">-</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">'0'</span><span class="o">)</span> <span class="o">+</span> 
   <span class="mi">10</span> <span class="o">*</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">b</span> <span class="o">-</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">'0'</span><span class="o">)</span> <span class="o">+</span>
    <span class="mi">1</span> <span class="o">*</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">c</span> <span class="o">-</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">'0'</span><span class="o">)</span>
</code></pre></div>
<p>Passing the <code>-dcmm</code> flag to ocamlopt shows the results of compiling the function to the <a href="https://github.com/ocaml/ocaml/blob/trunk/asmcomp/cmm.mli">C-- intermediate language</a>. </p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">ocamlopt -dcmm int_of_digits.ml
</code></pre></div>
<p>The generated code has the following form (reformatted for readability):</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="mi">200</span> <span class="o">*</span> <span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="mi">96</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
 <span class="mi">20</span> <span class="o">*</span> <span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="mi">96</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
  <span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="n">c</span> <span class="o">-</span> <span class="mi">96</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div>
<p>The right shifts convert the tagged representation into native integers, and the final <code>+ 1</code> converts the result back to a tagged integer.</p>

<p>Stephen's patch floats the arithmetic operations that involve constant operands outwards, eliminating most of the tag-munging code in favour of a final correcting addition:</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span>
<span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span>
 <span class="n">c</span> <span class="o">-</span> <span class="mi">10766</span>
</code></pre></div>
<p>Although these changes are not yet merged, you can easily try them out, thanks to Anil's script that <a href="http://anil.recoil.org/2014/03/25/ocaml-github-and-opam.html">makes compiler pull requests available as OPAM switches</a>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">opam switch 4.03.0+pr17
</code></pre></div>
<p><a name="standard-library"></a></p>

<h3>Standard library and beyond</h3>

<figure style="float: right; padding: 15px; width: 350px">
<img src="http://i.imgur.com/KKsM0tu.jpg" style="width: 350px" alt="Camel library"/><br/>
<figcaption><center><small>(Literary advocate <a href="http://www.papertigers.org/wordpress/interview-with-dashdondog-jamba-mongolian-author-and-literacy-advocate/">Dashdondog Jamba</a>, and his mobile library, described in <a href="http://www.bookdepository.com/My-Librarian-Is-a-Camel-Margriet-Ruurs/9781590780930"><i>My librarian is a camel</i></a>)</small></center></figcaption>
</figure>

<p>Our compiler hacking group defines &quot;compiler&quot; rather broadly.  As a result people often work on improving the standard library and tools as well as the compiler proper.  For example, in recent sessions, David added a small patch to <a href="http://caml.inria.fr/mantis/view.php?id=6105">expose the is_inet6_addr</a> function, and <a href="http://philippewang.info/">Philippe</a> proposed <a href="https://github.com/ocaml/ocaml/pull/15">a patch that eliminates unnecessary bounds checking</a> in the buffer module.  The last session also saw <a href="http://www.cl.cam.ac.uk/~rp452/">Rapha&euml;l</a> and Simon push a <a href="https://github.com/ocaml/opam-repository/pull/1961">number</a> <a href="https://github.com/ocaml/opam-repository/pull/1968">of</a> <a href="https://github.com/ocaml/opam-repository/pull/1972">patches</a> for integrating <a href="https://github.com/the-lambda-church/merlin">merlin</a> with the <a href="http://en.wikipedia.org/wiki/Acme_(text_editor)">acme</a> editor to OPAM, improving OCaml support in Plan 9.</p>

<h2>Next session</h2>

<p>The compiler hacking group is open to anyone with an interest in contributing to the OCaml compiler.  If you're local to Cambridge, you're welcome to join us at the <a href="http://ocamllabs.github.io/compiler-hacking/2014/06/20/sixth-compiler-hacking-session.html">next session</a>!</p>
<a onclick="switchContent('ocamlorg-post52','ocamlorg-post51')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/06/24/highlights-from-recent-sessions">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://ocamllabs.github.com/compiler-hacking/2014/06/24/highlights-from-recent-sessions">by Compiler Hacking at Jun 24, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://ocamllabs.github.com/compiler-hacking/2014/06/20/sixth-compiler-hacking-session">
    <a name="#http://ocamllabs.github.com/compiler-hacking/2014/06/20/sixth-compiler-hacking-session"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../images/hax0ring.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://ocamllabs.github.com/compiler-hacking/2014/06/20/sixth-compiler-hacking-session">Sixth OCaml compiler hacking session</a>
      (<a href="http://ocamllabs.github.io/compiler-hacking/rss.xml" title="OCaml Labs compiler hacking">Compiler Hacking</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post53"><p>(Update (2014-06-24): Stephen Dolan will be giving a demo of multicore OCaml!)</p>

<p>It's time for the sixth Cambridge OCaml compiler-hacking session!  We'll be meeting in the <a href="http://www.cl.cam.ac.uk/">Computer Lab</a> again next Wednesday evening (25th June).</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/2ps9gunbkiy3tp6i"><em>indicate interest via Doodle</em></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking"><em>sign up to the mailing list</em></a> to receive updates:</p>

<p><em>Where</em>: Room <a href="http://www.cl.cam.ac.uk/research/dtg/openroommap/static/?s=FW11&amp;amp%3Blabels=1">FW11</a>, <a href="http://www.cl.cam.ac.uk/directions/">Computer Laboratory, Madingley Road</a></p>

<p><em>When</em>: 6.30pm, Wednesday 25th June</p>

<p><em>Who</em>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><em>What</em>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><em>Wiki</em>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, &hellip;</p><a onclick="switchContent('ocamlorg-post53','ocamlorg-post54')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/06/20/sixth-compiler-hacking-session">Read more...</a></div><div id="ocamlorg-post54" style="display: none"><p>(Update (2014-06-24): Stephen Dolan will be giving a demo of multicore OCaml!)</p>

<p>It's time for the sixth Cambridge OCaml compiler-hacking session!  We'll be meeting in the <a href="http://www.cl.cam.ac.uk/">Computer Lab</a> again next Wednesday evening (25th June).</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/2ps9gunbkiy3tp6i"><em>indicate interest via Doodle</em></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking"><em>sign up to the mailing list</em></a> to receive updates:</p>

<p><em>Where</em>: Room <a href="http://www.cl.cam.ac.uk/research/dtg/openroommap/static/?s=FW11&amp;amp%3Blabels=1">FW11</a>, <a href="http://www.cl.cam.ac.uk/directions/">Computer Laboratory, Madingley Road</a></p>

<p><em>When</em>: 6.30pm, Wednesday 25th June</p>

<p><em>Who</em>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><em>What</em>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><em>Wiki</em>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-projects</a> for various levels of experience (see also some <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-previously-worked-on">things we've worked on in previous sessions</a>), but feel free to come along and work on whatever you fancy.</p>

<p>We'll also be ordering pizza, so if you want to be counted for food you should aim to arrive by 6.45pm.</p>
<a onclick="switchContent('ocamlorg-post54','ocamlorg-post53')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/06/20/sixth-compiler-hacking-session">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://ocamllabs.github.com/compiler-hacking/2014/06/20/sixth-compiler-hacking-session">by Compiler Hacking at Jun 20, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/">
    <a name="#http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/">Python to OCaml: retrospective</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post55"><p>In 2013, I spent 6 months converting 0install&rsquo;s 29,215 lines of Python to OCaml (learning OCaml along the way).
In this post, I&rsquo;ll describe the approach I took and how it went. There will be graphs.
If you don&rsquo;t want to read the whole thing, the take-away is this:
The new code is a similar length (slightly shorter), runs around 10x faster, and is statically type checked.</p>



<p>( This post also appeared on <a href="https://news.ycombinator.com/item?id=7858276">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/27h2q5/python_to_ocaml_retrospective/">Reddit</a> )</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#background">Background</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#ocaml-migration-overview">OCaml migration overview</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#code-size">Code size</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#porting-method">Porting method</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#binary-size">Binary size</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#build-time">Build time</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#speed">Speed</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#conclusions">Conclusions</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#epilogue">Epilogue</a></li>
</ul>

<h2>Background</h2>

<p>Several readers said they&rsquo;ve been following this blog without knowing what 0install actually is. So, a quick summary!</p>

<p><a href="http://0install.net/"><img src="http://roscidus.com/blog/images/0install-site.png" class="border center"/></a></p>

<p>Since 2003, <a href="http://0install.net">0install</a>&rsquo;s goal has been to provide secure, cross-platform, decentralised software installation.</p>

<p><strong>Secure</strong> means that 0install doesn&rsquo;t grant the software root access when you install it (like most package managers do), and doesn&rsquo;t allow packages to conflict wi&hellip;</p><a onclick="switchContent('ocamlorg-post55','ocamlorg-post56')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/">Read more...</a></div><div id="ocamlorg-post56" style="display: none"><p>In 2013, I spent 6 months converting 0install&rsquo;s 29,215 lines of Python to OCaml (learning OCaml along the way).
In this post, I&rsquo;ll describe the approach I took and how it went. There will be graphs.
If you don&rsquo;t want to read the whole thing, the take-away is this:
The new code is a similar length (slightly shorter), runs around 10x faster, and is statically type checked.</p>



<p>( This post also appeared on <a href="https://news.ycombinator.com/item?id=7858276">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/27h2q5/python_to_ocaml_retrospective/">Reddit</a> )</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#background">Background</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#ocaml-migration-overview">OCaml migration overview</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#code-size">Code size</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#porting-method">Porting method</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#binary-size">Binary size</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#build-time">Build time</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#speed">Speed</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#conclusions">Conclusions</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#epilogue">Epilogue</a></li>
</ul>

<h2>Background</h2>

<p>Several readers said they&rsquo;ve been following this blog without knowing what 0install actually is. So, a quick summary!</p>

<p><a href="http://0install.net/"><img src="http://roscidus.com/blog/images/0install-site.png" class="border center"/></a></p>

<p>Since 2003, <a href="http://0install.net">0install</a>&rsquo;s goal has been to provide secure, cross-platform, decentralised software installation.</p>

<p><strong>Secure</strong> means that 0install doesn&rsquo;t grant the software root access when you install it (like most package managers do), and doesn&rsquo;t allow packages to conflict with each other (each version of each package goes in its own directory). It should always be safe to &ldquo;install&rdquo; a program with 0install, though ideally you&rsquo;d use a sandbox to actually run it (we&rsquo;re still waiting for a decent sandbox to turn up).</p>

<p><strong>Cross-platform</strong> means it works on Linux (it&rsquo;s available from the repositories of all the major Linux distributions), Unix, OS X and Windows (the Windows version is a compatible reimplementation in C#, though it does run some of the original code in a subprocess).</p>

<p><strong>Decentralised</strong> means that upstream projects publish their software on their own web-sites. They still get automatic dependency handling (including dependencies on other sites), GPG signatures, automatic updates, roll-back, and support for binary and source packages.
0install can work with the native package manager (e.g. rpm or dpkg) to satisfy dependencies, in addition to downloading them as 0install packages itself.</p>

<p>0install was originally written in C as a Linux kernel module and user-space helper.
It made other software easy to install, but getting 0install itself was rather tricky.
My naive hope was that distributions would include it by default, but needless to say that didn&rsquo;t happen.
In 2005, it was redesigned and reimplemented in Python to simplify distribution.</p>

<h2>OCaml migration overview</h2>

<dl>
  <dt><a href="http://roscidus.com/blog/blog/2013/06/09/choosing-a-python-replacement-for-0install/">Replacing Python</a> (Jun 2013)</dt>
  <dd>The subject of rewriting 0install in a compiled language had come up a few times, but in 2013 I had just left my job to take a year off and finally had the time for it. I didn&rsquo;t have any idea what language to use so I collected suggestions and tried them all. My test-case was to read the tutorial for each language and reimplement one trivial (4 line) function of 0install in each one. I looked at various factors, including start-up time, binary size, binary compatibility, safety features, diagnostics, ease of writing, support for shared libraries, and static checking.

    <p><a href="http://roscidus.com/blog/blog/2013/06/09/choosing-a-python-replacement-for-0install/#speed-and-size"><span class="caption-wrapper"><img src="http://roscidus.com/blog/images/langspeed.png" class="caption" width="" height="" title="Speed and binary size for the launch helper (dominated by start-up time)."/><span class="caption-text">Speed and binary size for the launch helper (dominated by start-up time).</span></span></a></p>

    <p>There was no very clear conclusion. Rust seemed very promising in the long term, but it was years from being ready. ATS was the fastest and smallest, but too difficult to use. Python and C# were too slow (0install needs fast start-up time). Go did poorly in almost every area I tested. But Haskell and OCaml did surprisingly well.</p>
  </dd>
  <dt><a href="http://roscidus.com/blog/blog/2013/06/20/replacing-python-round-2/">Replacing Python: second round</a></dt>
  <dd>I tried Haskell and OCaml on a larger sample, converting 576 lines of Python and comparing the code.
They both did well, especially for detecting problems at compile time, but I found OCaml considerably easier to use. It also ran twice as fast.</dd>
  <dt><a href="http://roscidus.com/blog/blog/2013/07/07/ocaml-binary-compatibility/">OCaml binary compatibility</a> (Jul)</dt>
  <dd>OCaml can compile to bytecode or to native code. I&rsquo;d hoped that the bytecode would allow us to distribute a single binary that would work everywhere (as with Java). In this post I did some experiments to check this. It almost worked, but in the end I gave up; we now build separate binaries for each platform.</dd>
  <dt><a href="http://roscidus.com/blog/blog/2013/08/31/option-handling-with-ocaml-polymorphic-variants/">Option handling with OCaml polymorphic variants</a> (Aug)</dt>
  <dd>Polymorphic Variants are an unusual and very powerful feature of OCaml&rsquo;s type system. I found I was able to take advantage of them to check statically that all of 0install&rsquo;s sub-commands handle all their options.</dd>
  <dt><a href="http://roscidus.com/blog/blog/2013/09/28/ocaml-objects/">Experiences with OCaml objects</a> (Sep)</dt>
  <dd>Even though OCaml programmers rarely use objects, the language&rsquo;s support for object-oriented programming was a big help in converting the existing Python code. This post looks at OO programming in OCaml and describes the things that confused me at first.</dd>
  <dt><a href="http://roscidus.com/blog/blog/2013/10/13/ocaml-tips/">OCaml tips</a> (Oct)</dt>
  <dd>I go back over my first OCaml code from June, pointing out better ways to do things.</dd>
  <dt><a href="http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/">Asynchronous Python vs OCaml</a> (Nov)</dt>
  <dd>I add support for downloads to the OCaml, which requires using OCaml&rsquo;s support for asynchronous code. I compare it with Python&rsquo;s new asyncio system.</dd>
  <dt><a href="http://roscidus.com/blog/blog/2013/12/20/polymorphism-for-beginners/">Polymorphism for beginners</a> (Dec)</dt>
  <dd>OCaml code is often written without explicit types, letting the compiler infer everything.
However, it&rsquo;s helpful to understand the details of the type system when it comes to writing interface files (describing a restricted public interface to a module) and when trying to understand compiler error messages. After muddling through for a while, I decided it was time to understand how it actually worked.

    <p><a href="http://roscidus.com/blog/blog/2013/12/20/polymorphism-for-beginners/#subtyping"><span class="caption-wrapper"><img src="http://roscidus.com/blog/images/lattice.png" class="caption" width="" height="" title="A lattice showing the subtype relationship."/><span class="caption-text">A lattice showing the subtype relationship.</span></span></a></p>
  </dd>
  <dt><a href="http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/">OCaml: the bugs so far</a> (Jan)</dt>
  <dd>I&rsquo;ve found OCaml to be very good at detecting problems at compile time and the code has been very reliable. Still, some bugs slip though. In this post, I go over each discovered bug that made it into a Git commit and try to work out why it happened and whether it could have been prevented.

    <p><a href="http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/#summary"><span class="caption-wrapper"><img src="http://roscidus.com/blog/images/bugs.png" class="caption" width="" height="" title="Bugs found by type."/><span class="caption-text">Bugs found by type.</span></span></a></p>
  </dd>
  <dt><a href="http://roscidus.com/blog/blog/2014/02/13/ocaml-what-you-gain/">OCaml: what you gain</a> (Feb)</dt>
  <dd>When I first looked at OCaml, I was mainly focused on making sure the things I needed were still available.
With the port complete, I summarise the things you <em>gain</em> from using OCaml.</dd>
</dl>

<h2>Code size</h2>

<p>The final OCaml code was remarkably similar in length to the original Python:</p>

<p><span class="caption-wrapper"><img src="http://roscidus.com/blog/images/retro/0install-loc.png" class="caption" width="" height="" title="Lines of code, before and after."/><span class="caption-text">Lines of code, before and after.</span></span></p>

<p>The main code is slightly shorter, while the unit-tests are slightly longer (probably because I added some extra ones).
The functionality is the same, except that the OCaml adds the &ldquo;0install slave&rdquo; command (325 lines of OCaml) and uses Lwt
rather than its own asynchronous framework (483 lines of Python).</p>

<p>The Python code also included some XML files for the GTK user interface (shown in orange). In the OCaml, building the widgets
is instead done directly in the code. The OCaml version includes some module interface files (the <code>mli</code> files, shown in green).
These are used to control how much of a module&rsquo;s implementation is visible to other modules. They make the code easier to understand,
but they&rsquo;re mostly optional.</p>

<h2>Porting method</h2>

<p>I wanted to avoid having two separate forks of 0install (Python and OCaml).
Then most people would continue using the Python version until the OCaml version was finished, resulting in a sudden switch over and the risk of some major flaw in the whole idea going undiscovered until the end.
Also, it would encourage people to submit bug fixes and features to the Python fork, creating extra porting work for me.
Instead, I used a mix of both languages, slowly migrating functions from Python to OCaml.
The two parts communicated using JSON.</p>

<p>I made sure the complete set of unit-tests passed for every commit and that the software remained fully functional throughout the whole process. The graph below shows the amount of Python and OCaml code over time:</p>

<p><span class="caption-wrapper"><img src="http://roscidus.com/blog/images/retro/0install-loc-time.png" class="caption" width="" height="" title="Lines of code over time."/><span class="caption-text">Lines of code over time.</span></span></p>

<p>For the first couple of months I was just adding OCaml code, duplicating lots of common helper code. For example, the OCaml version needs to be able to parse the XML selections documents, so that code is ported, but parts of the Python still need that code too, so it can&rsquo;t be deleted yet. Once I start deleting Python code, progress is fairly steady until it&rsquo;s all gone. A nice benefit of this approach is that you can see clearly where you are in the process.</p>

<p>Initially, I tried doing clean implementations of the code from the specifications. However, the existing code has a lot of special cases for weird systems and backwards-compatibility hacks, and not all of them were unit-tested. Soon, I switched to translating more literally from the Python and then cleaning it up once it was in OCaml. I kept the basic structure of the Python in most places (e.g. the same classes with the same methods). That made things much easier. Once the port was complete, I did some larger refactoring (such as making the XML type immutable). I think this worked well - refactoring is very pleasant in OCaml.</p>

<h2>Binary size</h2>

<p><span class="caption-wrapper"><img src="http://roscidus.com/blog/images/retro/binary-size.png" class="caption" width="" height="" title="Executable image size over time."/><span class="caption-text">Executable image size over time.</span></span></p>

<p>The binary ended up a bit bigger than I&rsquo;d like. Adding the GTK and OBus libraries in particular added a lot to the size (though they are optional). The main problem with GTK is that it has to be compiled as a plugin, because we don&rsquo;t know if the target system will have libgtk. If we used a single binary and the library wasn&rsquo;t present, it would refuse to start. By having it in a plugin we can try to load it, but fall back to console mode if that fails. However, compiling for plugins prevents OCaml from optimising the binary by removing unused library functions, since it doesn&rsquo;t know which ones might be needed by the plugins.</p>

<p>The binary is compiled with debug symbols, but compiling without has almost no effect (binary becomes 1.5% smaller).</p>

<h2>Build time</h2>

<p><span class="caption-wrapper"><img src="http://roscidus.com/blog/images/retro/build-time.png" class="caption" width="" height="" title="Build time changes over time."/><span class="caption-text">Build time changes over time.</span></span></p>

<p>A full build takes nearly a minute, which isn&rsquo;t too bad. The <code>ocamlbuild</code> command automatically discovers dependencies and rebuilds only what is needed, so incremental builds are usually fast and are generally reliable (the exception is that it doesn&rsquo;t notice if you remove or rename a file, but you always get an error message in that case rather than an incorrect build).</p>

<p>Most errors are picked up by the type checker immediately at the start of the build, rather than by the unit-tests at the end. That saves a lot of time.</p>

<p>Two things did speed it up slightly: building the tests and the main binary with a single invocation (saves having to run the dependency checker twice) and turning on parallel builds. Parallel builds didn&rsquo;t help as much as I&rsquo;d hoped however.</p>

<p>Update: edwintorok <a href="https://news.ycombinator.com/item?id=7860192">profiled the build</a> and noticed that 25.5% of the time is spent running a bytecode version of the camlp4 pre-processor (which we use for the Lwt syntax extension and for conditional compilation) and 10.5% is spent on a bytecode version of ocamlfind (looks like an ocamlbuild bug). 
<a href="http://gallium.inria.fr/blog/ocamlbuild-parallelization/">Why ocamlbuild&rsquo;s parallelization is often disappointing today</a> looks interesting too.</p>

<p>Update 2: I noticed that building while the computer is busy doing something else is much faster! Looks like this is the Linux scaling governor being strange. Echoing &ldquo;performance&rdquo; to <code>/sys/devices/system/cpu/cpu[0-3]/cpufreq/scaling_governor</code> takes the build time (on my new laptop) down from 45s to 23s!</p>

<p>There are some changes (module aliases) coming in OCaml 4.02 which should help. Currently, if I change one of the files in the <code>Support</code> module (e.g. <code>Support.Sat</code>) then it first rebuilds <code>Sat</code>, then rebuilds <code>Support</code> with the new <code>Sat</code> module, then rebuilds everything that uses <code>Support</code> (which is everything). In reality, it only needs to rebuild <code>Zeroinstall.Solver</code> when <code>Sat</code> changes.</p>

<p>If you do need to modify one of the early modules and run the unit tests quickly, a good trick is to compile to byte-code rather than to native. The byte-code compiler doesn&rsquo;t do cross-module inlining optimisations, which means that as long as a module&rsquo;s interface doesn&rsquo;t change, it doesn&rsquo;t need to recompile the things that depend on it.</p>

<p>One interesting feature of the graph is that during December the build time increased faster in proportion to the lines of code added.
This corresponds to the time I was implementing the GTK GUI, so it looks like GUI code takes longer to compile than normal code of the same length.</p>

<h2>Speed</h2>

<p>And the final result: running various operations with the old and new versions:</p>

<table class="table">
  <thead>
    <tr>
      <th style="text-align: right">Test</th>
      <th style="text-align: right">Python 3</th>
      <th style="text-align: right">OCaml</th>
      <th style="text-align: right">Speed-up</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><code>0install --help</code></td>
      <td style="text-align: right">103 ms</td>
      <td style="text-align: right">8 ms</td>
      <td style="text-align: right">12.9</td>
    </tr>
    <tr>
      <td style="text-align: right"><code>0install select 0repo</code></td>
      <td style="text-align: right">322 ms</td>
      <td style="text-align: right">38 ms</td>
      <td style="text-align: right">8.5</td>
    </tr>
    <tr>
      <td style="text-align: right"><code>0install run -w echo armagetron</code></td>
      <td style="text-align: right">120 ms</td>
      <td style="text-align: right">15 ms</td>
      <td style="text-align: right">8.0</td>
    </tr>
    <tr>
      <td style="text-align: right"><code>0install run armagetron --version</code></td>
      <td style="text-align: right">153 ms</td>
      <td style="text-align: right">45 ms</td>
      <td style="text-align: right">3.4</td>
    </tr>
  </tbody>
</table>

<p>The first (<code>--help</code>) shows the overhead of running 0install and producing some simple output.
The extra speed here really helps with tab-completion!
The second test (<code>select</code>) shows 0install running its SAT solver to select a compatible set of libraries to run the &ldquo;0repo&rdquo; application.
The third shows 0install setting up the environment to run Armagetron (<code>-w echo</code> echos the executable path rather than actually running it) and the fourth shows it actually running the program.</p>

<p><span class="caption-wrapper"><img src="http://roscidus.com/blog/images/retro/times.png" class="caption" width="" height="" title="Speed of 0install in Python vs OCaml."/><span class="caption-text">Speed of 0install in Python vs OCaml.</span></span></p>

<p>One other nice win is the time taken to run the unit-tests, which has dropped considerably:</p>

<p><span class="caption-wrapper"><img src="http://roscidus.com/blog/images/retro/0install-test-times.png" class="caption" width="" height="" title="Time to run the unit tests (in seconds)."/><span class="caption-text">Time to run the unit tests (in seconds).</span></span></p>

<p>The spike in the middle is the effect of the JSON bridge, where many tests involved communication between the Python and OCaml parts.</p>

<p>In theory, OUnit should be able to run the tests in parallel on multi-core systems, which would make it even faster, but a <a href="https://forge.ocamlcore.org/tracker/index.php?func=detail&amp;aid=1363&amp;group_id=162&amp;atid=730">bug in OUnit</a> means it doesn&rsquo;t work.</p>

<h2>Conclusions</h2>

<p>It&rsquo;s surprising to me how reliable the initial tests were.
Even though I only converted 4 lines of Python, the tests uncovered pretty much all of OCaml&rsquo;s weaker aspects (non-portable bytecode, lack of support for shared libraries, relatively large binary size, and somewhat terse error messages from the standard library), meaning there were no nasty surprises during the migration.</p>

<p>However, the testing was less successful at uncovering the benefits (excellent type checking, reliability, exhaustive pattern matching, polymorphic variants, abstract types, easy GTK bindings, and API stability).</p>

<p>Blogging about the whole process was extremely useful, attracting many helpful comments, suggestions and corrections from experienced OCaml users.</p>

<h2>Epilogue</h2>

<p>The blog attracted the attention of the OCaml folks at Cambridge University, who do all kinds of <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#Dec%202013">interesting OCaml things</a>.
As a result, I&rsquo;m now working there, adding ARM support to the <a href="http://openmirage.org/">Mirage unikernel</a> - an operating system written in OCaml (the Mirage web-site is all implemented in OCaml, down to and including the TCP/IP stack!).
That will have to be the subject for another blog post though&hellip;</p>
<a onclick="switchContent('ocamlorg-post56','ocamlorg-post55')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2014/06/06/python-to-ocaml-retrospective/">by Thomas Leonard at Jun 06, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/welcome-to-our-summer-hackers">
    <a name="#http://openmirage.org/blog/welcome-to-our-summer-hackers"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/welcome-to-our-summer-hackers">Welcome to the summer Mirage hackers</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post57">
      <p>Following our participation in the <a href="http://openmirage.org/blog/applying-for-gsoc2014">Google Summer of Code</a> program, we've now finalised selections.  We've also got a number of other visitors joining us to hack on Mirage over the summer time, so here are introductions!</p>
<ul><li><strong>SSL support</strong>: <a href="https://github.com/hannesm">Hannes Mehnert</a> and <a href="https://github.com/pqwy">David Kaloper</a> have been working hard on a safe <a href="https://github.com/mirleft/ocaml-tls">OCaml TLS</a> implementation. They're going to hack on <a href="https://github.com/mirage/mirage/issues/242">integrating it all</a> into working under Xen so we can make HTTPS requests (and our Twitter bot will finally be able to tweet!).  Both are also interested in formal verification of the result, and several loooong conversations with <a href="http://www.cl.cam.ac.uk/~pes20/">Peter Sewell</a> will magically transform into machine specifications by summer's end, I'm reliably informed.</li><li><strong>Cloud APIs</strong>: <a href="http://1000hippos.wordpress.com/">Jyotsna Prakash</a> will spend her summer break as part of <a href="http://www.google-melange.com/gsoc/org2/google/gsoc2014/xen_project">Google Summer of Code</a> working on improving cloud provider APIs in OCaml (modelled from her notes on how the <a href="https://github.com/avsm/ocaml-github">GitHub</a> bindings <a href="http://1000hippos.wordpress.com/2014/04/24/ocaml-github/">are built</a>).  This will let the <code>mirage</code> command-line tool have much more natural integration with remote cloud providers &hellip;</li></ul><a onclick="switchContent('ocamlorg-post57','ocamlorg-post58')" class="btn planet-toggle" href="#http://openmirage.org/blog/welcome-to-our-summer-hackers">Read more...</a></div><div id="ocamlorg-post58" style="display: none">
      <p>Following our participation in the <a href="http://openmirage.org/blog/applying-for-gsoc2014">Google Summer of Code</a> program, we've now finalised selections.  We've also got a number of other visitors joining us to hack on Mirage over the summer time, so here are introductions!</p>
<ul><li><strong>SSL support</strong>: <a href="https://github.com/hannesm">Hannes Mehnert</a> and <a href="https://github.com/pqwy">David Kaloper</a> have been working hard on a safe <a href="https://github.com/mirleft/ocaml-tls">OCaml TLS</a> implementation. They're going to hack on <a href="https://github.com/mirage/mirage/issues/242">integrating it all</a> into working under Xen so we can make HTTPS requests (and our Twitter bot will finally be able to tweet!).  Both are also interested in formal verification of the result, and several loooong conversations with <a href="http://www.cl.cam.ac.uk/~pes20/">Peter Sewell</a> will magically transform into machine specifications by summer's end, I'm reliably informed.</li><li><strong>Cloud APIs</strong>: <a href="http://1000hippos.wordpress.com/">Jyotsna Prakash</a> will spend her summer break as part of <a href="http://www.google-melange.com/gsoc/org2/google/gsoc2014/xen_project">Google Summer of Code</a> working on improving cloud provider APIs in OCaml (modelled from her notes on how the <a href="https://github.com/avsm/ocaml-github">GitHub</a> bindings <a href="http://1000hippos.wordpress.com/2014/04/24/ocaml-github/">are built</a>).  This will let the <code>mirage</code> command-line tool have much more natural integration with remote cloud providers for executing the unikernels straight from a command-line.  If you see Jyotsna wandering around aimlessly muttering darkly about HTTP, JSON and REST, then the project is going well.</li><li><strong>Network Stack fuzzing</strong>: <a href="http://www.somerandomidiot.com/">Mindy Preston</a> joins us for the summer after her <a href="https://www.hackerschool.com/">Hacker School</a> stay, courtesy of the <a href="https://opw.gnome.org">OPW</a> program.  She's been delving into the network stack running on EC2 and figuring out how to debug issues when the unikernel is running a cloud far, far away (see the post series here: <a href="http://www.somerandomidiot.com/blog/2014/03/14/its-a-mirage/">1</a>, <a href="http://www.somerandomidiot.com/blog/2014/03/24/advancing-toward-the-mirage/">2</a>, <a href="http://www.somerandomidiot.com/blog/2014/04/02/tying-the-knot/">3</a>, <a href="http://www.somerandomidiot.com/blog/2014/03/24/arriving-at-the-mirage/">4</a>).</li><li><strong>Visualization</strong>: <a href="http://erratique.ch/contact.en">Daniel Buenzli</a> returns to Cambridge this summer to continue his work on extremely succinctly named graphics libaries.  His <a href="https://github.com/dbuenzli/vz">Vz</a>, <a href="https://github.com/dbuenzli/vg">Vg</a> and <a href="https://github.com/dbuenzli/gg">Gg</a> libaries build a set of primitives for 2D graphics programming.  Since the libraries compile to JavaScript, we're planning to use this as the basis for <a href="http://erratique.ch/software/vg/demos/rhtmlc">visualization</a> of Mirage applications via a built-in webserver.</li><li><strong>Modular implicits</strong>: <a href="https://github.com/def-lkb">Frederic Bour</a>, author of the popular <a href="https://github.com/the-lambda-church/merlin">Merlin</a> IDE tool is also in Cambridge this summer working on adding modular implicits to the core OCaml language. Taking inspiration from <a href="http://www.mpi-sws.org/~dreyer/papers/mtc/main-long.pdf">Modular Type-classes</a> and Scala's <a href="http://twitter.github.io/scala_school/advanced-types.html">implicits</a>,  modular implcits allow functions to take implicit module arguments which will be filled-in by the compiler by searching the environment for a module with the appropriate type. This enables ad-hoc polymorphism in a very similar way to Haskell's type classes.</li><li><strong>Irmin storage algorithms</strong>: Benjamin Farinier (from <a href="http://www.ens-lyon.eu/">ENS Lyon</a>) and Matthieu Journault (from <a href="http://www.ens-cachan.fr/">ENS Cachan</a>) will work on datastructures for the <a href="https://github.com/mirage/irmin/wiki/Getting-Started">Irmin</a> storage system that the next version of Mirage will use.  They'll be grabbing copies of the <a href="http://www.amazon.co.uk/Purely-Functional-Structures-Chris-Okasaki/dp/0521663504">Okasaki</a> classic text and porting some of them into a branch-consistent form.</li></ul>

<p>Of course, work continues apace by the rest of the team as usual, with a <a href="http://www.openmirage.org/releases">steady stream of releases</a> that are building up to some exciting new features.  We'll be blogging about ARM support, PVHVM, Irmin storage and SSL integration just as soon as they're pushed into the stable branches.  As always, <a href="http://www.openmirage.org/community/">get in touch</a> via the IRC channel (<code>#mirage</code> on Freenode) or the mailing lists with questions.</p>

   <a onclick="switchContent('ocamlorg-post58','ocamlorg-post57')" class="btn planet-toggle" href="#http://openmirage.org/blog/welcome-to-our-summer-hackers">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/welcome-to-our-summer-hackers">by Anil Madhavapeddy at May 08, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://amirchaudhry.com/writing-planet-in-pure-ocaml">
    <a name="#http://amirchaudhry.com/writing-planet-in-pure-ocaml"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/amir.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://amirchaudhry.com/writing-planet-in-pure-ocaml">Writing Planet in pure OCaml</a>
      (<a href="http://amirchaudhry.com/tags/ocaml-labs-atom.xml" title="Amir Chaudhry - 'ocaml-labs'">Amir Chaudhry</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post59">
<p>I&rsquo;ve been learning OCaml for some time now but not really had a problem that
I wanted to solve. As such, my progress has been rather slow and sporadic
and I only make time for exercises when I&rsquo;m travelling. In order to focus my
learning, I have to identify and tackle something specific. That&rsquo;s usually
the best way to advance and I recently found something I can work on.</p>

<p>As I&rsquo;ve been trying to write more blog posts, I want to be able to keep as
much content on my own site as possible and syndicate my posts out to other
sites I run. Put simply, I want to be able to take multiple feeds from
different sources and merge them into one feed, which will be served from
some other site. In addition, I also want to render that feed as HTML on a
webpage. All of this has to remain within the OCaml toolchain so it can be
used as part of <a href="http://openmirage.org/">Mirage</a> (i.e. I can use it when
<a href="http://amirchaudhry.com/from-jekyll-to-unikernel-in-fifty-lines">building unikernels</a>). </p>

<p>What I&rsquo;m describing might sound familiar and there&rsquo;s a well-known tool that
does this called <a href="http://en.wikipedia.org/wiki/Planet_(software)">Pla&hellip;</a></p><a onclick="switchContent('ocamlorg-post59','ocamlorg-post60')" class="btn planet-toggle" href="#http://amirchaudhry.com/writing-planet-in-pure-ocaml">Read more...</a></div><div id="ocamlorg-post60" style="display: none">
<p>I&rsquo;ve been learning OCaml for some time now but not really had a problem that
I wanted to solve. As such, my progress has been rather slow and sporadic
and I only make time for exercises when I&rsquo;m travelling. In order to focus my
learning, I have to identify and tackle something specific. That&rsquo;s usually
the best way to advance and I recently found something I can work on.</p>

<p>As I&rsquo;ve been trying to write more blog posts, I want to be able to keep as
much content on my own site as possible and syndicate my posts out to other
sites I run. Put simply, I want to be able to take multiple feeds from
different sources and merge them into one feed, which will be served from
some other site. In addition, I also want to render that feed as HTML on a
webpage. All of this has to remain within the OCaml toolchain so it can be
used as part of <a href="http://openmirage.org/">Mirage</a> (i.e. I can use it when
<a href="http://amirchaudhry.com/from-jekyll-to-unikernel-in-fifty-lines">building unikernels</a>). </p>

<p>What I&rsquo;m describing might sound familiar and there&rsquo;s a well-known tool that
does this called <a href="http://en.wikipedia.org/wiki/Planet_(software)">Planet</a>. It&rsquo;s a &lsquo;river of news&rsquo; feed reader, which
aggregates feeds and can display posts on webpages and you can find the
<a href="http://www.planetplanet.org">original Planet</a> and it&rsquo;s successor <a href="http://intertwingly.net/code/venus/docs/index.html">Venus</a>, both written in Python.
However, Venus seems to be unmaintained as there are a number of
<a href="https://github.com/rubys/venus/issues">unresolved issues and pull requests</a>, which have been
languishing for quite some time with no discussion. There does appear to be
a more active Ruby implementation called <a href="http://feedreader.github.io/">Pluto</a>, with recent commits and
no reported issues.</p>



<h3>Benefits of a Planet in pure OCaml</h3>

<p>Although I could use the one of the above options, it would be much more
useful to keep everything within the OCaml ecosystem.  This way I can make
the best use of the <a href="https://queue.acm.org/detail.cfm?id=2566628">unikernel approach</a> with Mirage (i.e lean,
single-purpose appliances). Obviously, the existing options don&rsquo;t lend
themselves to this approach and there are <a href="https://forge.ocamlcore.org/tracker/index.php?func=detail&amp;aid=1349&amp;group_id=1&amp;atid=101">known bugs</a> as a lot has
changed on the web since Planet Venus (e.g the adoption of HTML5).
Having said that, I can learn a lot from the existing implementations and
I&rsquo;m glad I&rsquo;m not embarking into completely uncharted territory.</p>

<p>In addition, the OCaml version doesn&rsquo;t need to (and <em>shouldn&rsquo;t</em>) be written
as one monolithic library.  Instead, pulling together a collection of
smaller, reusable libraries that present clear interfaces to each other
would make things much more maintainable. This would bring substantially
greater benefits to everyone and <a href="https://opam.ocaml.org/">OPAM</a> can manage the dependencies. </p>



<h3>Breaking down the problem</h3>

<p>The first cut is somewhat straightforward as we have a piece that deals with
the consumption and manipulation of feeds and another that takes the result
and emits HTML. This is also how the original Planet is put together, with a
library called <a href="https://pypi.python.org/pypi/feedparser/">feedparser</a> and another for templating pages.  </p>

<p>For the feed-parsing aspect, I can break it down further by considering Atom
and RSS feeds separately and then even further by thinking about how to (1)
consume such feeds and (2) output them. Then there is the HTML component,
where it may be necessary to consider existing representations of HTML. These
are not new ideas and since I&rsquo;m claiming that individual pieces might be
useful then it&rsquo;s worth finding out which ones are already available.</p>

<h4>Existing components</h4>

<p>The easiest way to find existing libraries is via the
<a href="http://opam.ocaml.org/packages">OPAM package list</a>. Some quick searches for <code>RSS</code>, <code>XML</code>, <code>HTML</code>
and <code>net</code> bring up a lot of packages. The most relevant of these seem to be
<a href="https://opam.ocaml.org/packages/xmlm/xmlm.1.2.0/">xmlm</a>, <a href="https://opam.ocaml.org/packages/ocamlrss/ocamlrss.2.2.2/">ocamlrss</a>, <a href="https://opam.ocaml.org/packages/cow/cow.0.9.1/">cow</a> and maybe <a href="http://opam.ocaml.org/packages/xmldiff/xmldiff.0.1/">xmldiff</a>. I noticed that
nothing appears, when searching for <code>Atom</code>, but I do know that <code>cow</code> has an
Atom module for creating feeds. In terms of turning feeds into pages and
HTML, I&rsquo;m aware of <a href="https://github.com/ocaml/ocaml.org/blob/master/script/rss2html.ml">rss2html</a> used on the <a href="http://ocaml.org">OCaml</a> website and parts of
<a href="http://opam.ocaml.org/packages/ocamlnet/ocamlnet.3.7.3/">ocamlnet</a> that may be relevant (e.g <code>nethtml</code> and <code>netstring</code>) as well as
<code>cow</code>.  There is likely to be other code I&rsquo;m missing but this is useful as a
first pass. </p>

<p>Overall, a number of components are already out there but it&rsquo;s not obvious
if they&rsquo;re compatible (e.g html) and there are still gaps (e.g atom). Since
I also want to minimise dependencies, I&rsquo;ll try and use whatever works but
may ultimately have to roll my own. Either way, I can learn from what
already exists. Perhaps I&rsquo;m being overconfident but if I can break things
down sensibly and keep the scope constrained then this should be an
achievable project. </p>

<h3>The first (baby) steps - an Atom parser</h3>

<p>As this is an exercise for me to learn OCaml by solving a problem, I need to
break it down into bite-size pieces and take each one at a time. Practically
speaking, this means limiting the scope to be as narrow as possible while
still producing a useful result <em>for me</em>.  That last part is important as I
have specific needs and it&rsquo;s likely that the first thing I make won&rsquo;t be
particularly interesting for many others. </p>

<p>For my specific use-case, I&rsquo;m only interested in dealing with Atom feeds as
that&rsquo;s what I use on my site and others I&rsquo;m involved with. Initial feedback
is that creating an Atom parser will be the bulk of the work and I should
start by defining the types. To keep this manageable, I&rsquo;m only going to deal
with my own feeds instead of attempting a fully compliant parser (in other
words, I&rsquo;ll only consider the subset of <a href="https://tools.ietf.org/html/rfc4287">RFC4287</a> that&rsquo;s relevant to me).
Once I can parse, merge and write such feeds I should be able to iterate
from there. </p>

<p>To make my requirements more concrete:</p>

<ul>
  <li>Only consider <em>my own</em> Atom feeds for now</li>
  <li>Initially, be able to parse and emit just one Atom feed</li>
  <li>Then be able to merge 2+ feeds, specifically:
    <ul>
      <li>Use tag-based feeds from my personal site as starting points</li>
      <li>Be able to de-dupe content</li>
    </ul>
  </li>
  <li>No database or storage (construct it afresh every time)</li>
  <li>Minimise library dependencies</li>
</ul>



<h4>Timeframes and workflow</h4>

<p>I&rsquo;ve honestly no idea how long this might take and I&rsquo;m treating it as a
side-project. I know there are many people out there who could produce a
working version of everything in a week or two but I&rsquo;m not one of them (yet).
There are also <em>a lot</em> of ancillary things I need to learn on the way, like
packaging, improving my knowledge of Git and dealing with build systems. If
I had to put a vague time frame on this, I&rsquo;d be thinking in months rather
than weeks.  It might even be the case that others start work on parts of
this and ship things sooner but that&rsquo;s great as I&rsquo;ll probably be able to use
whatever they create and move further along the chain.</p>

<p>In terms of workflow, everything will be done in the open, warts and all, and
I expect to make embarrassing mistakes as I go. You can follow along on my
freshly created <a href="https://github.com/amirmc/ocamlatom">OCaml Atom</a> repo, and I&rsquo;ll be using the issue tracker as
the main way of dealing with bugs and features. Let the fun begin.</p>



<hr/>

<p><em>Acknowledgements:</em> Thanks to <a href="http://erratique.ch">Daniel</a>, <a href="http://ashishagarwal.org">Ashish</a>, <a href="https://github.com/Chris00">Christophe</a>,
<a href="http://philippewang.info/">Philippe</a> and <a href="http://gazagnaire.org">Thomas</a> for discussions on an earlier draft of this post
and providing feedback on my approach.</p>



<a onclick="switchContent('ocamlorg-post60','ocamlorg-post59')" class="btn planet-toggle" href="#http://amirchaudhry.com/writing-planet-in-pure-ocaml">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://amirchaudhry.com/writing-planet-in-pure-ocaml">by Amir Chaudhry at Apr 29, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://ocamllabs.github.com/compiler-hacking/2014/04/24/fifth-compiler-hacking-session">
    <a name="#http://ocamllabs.github.com/compiler-hacking/2014/04/24/fifth-compiler-hacking-session"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../images/hax0ring.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://ocamllabs.github.com/compiler-hacking/2014/04/24/fifth-compiler-hacking-session">Fifth OCaml compiler hacking session</a>
      (<a href="http://ocamllabs.github.io/compiler-hacking/rss.xml" title="OCaml Labs compiler hacking">Compiler Hacking</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post61"><p>It's time for the fifth Cambridge OCaml compiler-hacking session!  We'll be meeting in the <a href="http://www.cl.cam.ac.uk/">Computer Lab</a> again next Tuesday evening.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/iapgw89dvmxhnb4e"><em>indicate interest via Doodle</em></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking"><em>sign up to the mailing list</em></a> to receive updates:</p>

<p><em>Where</em>: Room <a href="http://www.cl.cam.ac.uk/research/dtg/openroommap/static/?s=FW11&amp;amp%3Blabels=1">FW11</a>, <a href="http://www.cl.cam.ac.uk/directions/">Computer Laboratory, Madingley Road</a></p>

<p><em>When</em>: 6pm, Tuesday 29th April</p>

<p><em>Who</em>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><em>What</em>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><em>Wiki</em>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-projects</a> for various levels of experience&hellip;</p><a onclick="switchContent('ocamlorg-post61','ocamlorg-post62')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/04/24/fifth-compiler-hacking-session">Read more...</a></div><div id="ocamlorg-post62" style="display: none"><p>It's time for the fifth Cambridge OCaml compiler-hacking session!  We'll be meeting in the <a href="http://www.cl.cam.ac.uk/">Computer Lab</a> again next Tuesday evening.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/iapgw89dvmxhnb4e"><em>indicate interest via Doodle</em></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking"><em>sign up to the mailing list</em></a> to receive updates:</p>

<p><em>Where</em>: Room <a href="http://www.cl.cam.ac.uk/research/dtg/openroommap/static/?s=FW11&amp;amp%3Blabels=1">FW11</a>, <a href="http://www.cl.cam.ac.uk/directions/">Computer Laboratory, Madingley Road</a></p>

<p><em>When</em>: 6pm, Tuesday 29th April</p>

<p><em>Who</em>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><em>What</em>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><em>Wiki</em>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-projects</a> for various levels of experience (see also some <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-previously-worked-on">things we've worked on in previous sessions</a>), but feel free to come along and work on whatever you fancy.</p>

<p>We'll also be ordering pizza, so if you want to be counted for food you should aim to arrive by 6.30pm.</p>
<a onclick="switchContent('ocamlorg-post62','ocamlorg-post61')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/04/24/fifth-compiler-hacking-session">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://ocamllabs.github.com/compiler-hacking/2014/04/24/fifth-compiler-hacking-session">by Compiler Hacking at Apr 24, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/applying-for-gsoc2014">
    <a name="#http://openmirage.org/blog/applying-for-gsoc2014"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/applying-for-gsoc2014">MirageOS is in Google Summer of Code 2014</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post63">
      <p>MirageOS will part of the <a href="https://www.google-melange.com/gsoc/homepage/google/gsoc2014">Google Summer of Code</a> 2014
program, thanks to the Xen Project's participation!  It's been a few years
since I've mentored for GSoc, but I still have fond memories of some great
projects in the past (such as the legendary <a href="http://vmgl.sourceforge.net/">Quake testing</a>
we were forced to do for hours on end).  I've already received a number of
queries about this year's program from potential students, so here's a few
things to note to become a successful applicant.</p>
<ul><li><p>Students still need to apply and be accepted. Your chances of being
 selected are much higher if you demonstrate some participation and
 code contributions (even minor) <em>before</em> submitting an application.
 Thus, even if you don't have a copy of Xen around, roll up your sleeves
 and head over to the <a href="http://openmirage.org/wiki/install">installation instructions</a>.</p>
</li><li><p>Contributions do not have to be just code.  They can be documentation,
 help with packaging, wiki posts about a particular use, or test cases
 to improve code coverage.</p>
</li><li><p>It's unlikely that we'll get students w&hellip;</p></li></ul><a onclick="switchContent('ocamlorg-post63','ocamlorg-post64')" class="btn planet-toggle" href="#http://openmirage.org/blog/applying-for-gsoc2014">Read more...</a></div><div id="ocamlorg-post64" style="display: none">
      <p>MirageOS will part of the <a href="https://www.google-melange.com/gsoc/homepage/google/gsoc2014">Google Summer of Code</a> 2014
program, thanks to the Xen Project's participation!  It's been a few years
since I've mentored for GSoc, but I still have fond memories of some great
projects in the past (such as the legendary <a href="http://vmgl.sourceforge.net/">Quake testing</a>
we were forced to do for hours on end).  I've already received a number of
queries about this year's program from potential students, so here's a few
things to note to become a successful applicant.</p>
<ul><li><p>Students still need to apply and be accepted. Your chances of being
 selected are much higher if you demonstrate some participation and
 code contributions (even minor) <em>before</em> submitting an application.
 Thus, even if you don't have a copy of Xen around, roll up your sleeves
 and head over to the <a href="http://openmirage.org/wiki/install">installation instructions</a>.</p>
</li><li><p>Contributions do not have to be just code.  They can be documentation,
 help with packaging, wiki posts about a particular use, or test cases
 to improve code coverage.</p>
</li><li><p>It's unlikely that we'll get students who are very familiar with both
 OCaml and Xen (if you are, definitely get in touch with us!).  You should
 therefore look over the <a href="http://wiki.xen.org/wiki/GSoc_2014#Mirage_OS">project ideas</a>
 as a set of guidelines and not firm suggestions.  If you have a particular
 thing you'd like to do with Mirage (for example, work on the JavaScript
 backend, an <a href="https://github.com/andrewray/iocamljs">IPython interface</a> or
 a particular protocol implementation such as XMPP, then that's fine.  Just
 get in touch with us on the <a href="http://openmirage.org/community">mailing lists</a> or directly via
 e-mail, and we can work through them.</p>
</li><li><p>Under some circumstances, we can provide resources such as a login to
 a Xen machine, or delegated credits on a cloud provider.  Don't let that
 stop you from applying for a project idea.  In general though, it's best
 to only depend on your own computer resources if practical to do so.</p>
</li></ul>
   <a onclick="switchContent('ocamlorg-post64','ocamlorg-post63')" class="btn planet-toggle" href="#http://openmirage.org/blog/applying-for-gsoc2014">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/applying-for-gsoc2014">by Anil Madhavapeddy at Feb 25, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2014/02/13/ocaml-what-you-gain/">
    <a name="#http://roscidus.com/blog/blog/2014/02/13/ocaml-what-you-gain/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2014/02/13/ocaml-what-you-gain/">OCaml: what you gain</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post65"><p>Way back in June, in <a href="http://roscidus.com/blog/blog/2013/06/20/replacing-python-round-2/">Replacing Python: second round</a>, I wrote:</p>

<blockquote>
  <p>The big surprise for me in these tests was how little you lose going from Python to OCaml.</p>
</blockquote>

<p>Of course, I was mainly focused on making sure the things I needed were still available. With the port now complete (<a href="http://thread.gmane.org/gmane.comp.file-systems.zero-install.devel/7310">0install 2.6 has been released</a>, and contains no Python code), here&rsquo;s a summary of the main things you <em>gain</em>.</p>



<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#functional-programming">Functional programming</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#type-checking">Type-checking</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#data-type-definitions">Data type definitions</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#polymorphic-variants">Polymorphic variants</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#immutability">Immutability</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#abstraction">Abstraction</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#speed">Speed</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#no-dependency-cycles">No dependency cycles</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#gui-code">GUI code</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#api-stability">API stability</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#summary">Summary</a></li>
</ul>

<p>This post also appeared on <a href="https://news.ycombinator.com/item?id=7234855">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/1xtohg/ocaml_replacing_python_what_you_gain/">Reddit</a>, where there are more comments.</p>

<p>( This post is part of a series in which I
<a href="http://roscidus.com/blog/blog/2013/06/09/choosing-a-python-replacement-for-0install">converted 0install from Python to OCaml</a>, learning OCaml in the process. The full code is at <a href="https://github.com/0install/0install">GitHub/0install</a>. )</p>

<p><strong>A note on bias</strong></p>

<p>I started these blog posts unemployed (taking a career break), with no particular connection to any of the languages, and motivated to make a good cho&hellip;</p><a onclick="switchContent('ocamlorg-post65','ocamlorg-post66')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/02/13/ocaml-what-you-gain/">Read more...</a></div><div id="ocamlorg-post66" style="display: none"><p>Way back in June, in <a href="http://roscidus.com/blog/blog/2013/06/20/replacing-python-round-2/">Replacing Python: second round</a>, I wrote:</p>

<blockquote>
  <p>The big surprise for me in these tests was how little you lose going from Python to OCaml.</p>
</blockquote>

<p>Of course, I was mainly focused on making sure the things I needed were still available. With the port now complete (<a href="http://thread.gmane.org/gmane.comp.file-systems.zero-install.devel/7310">0install 2.6 has been released</a>, and contains no Python code), here&rsquo;s a summary of the main things you <em>gain</em>.</p>



<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#functional-programming">Functional programming</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#type-checking">Type-checking</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#data-type-definitions">Data type definitions</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#polymorphic-variants">Polymorphic variants</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#immutability">Immutability</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#abstraction">Abstraction</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#speed">Speed</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#no-dependency-cycles">No dependency cycles</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#gui-code">GUI code</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#api-stability">API stability</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#summary">Summary</a></li>
</ul>

<p>This post also appeared on <a href="https://news.ycombinator.com/item?id=7234855">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/1xtohg/ocaml_replacing_python_what_you_gain/">Reddit</a>, where there are more comments.</p>

<p>( This post is part of a series in which I
<a href="http://roscidus.com/blog/blog/2013/06/09/choosing-a-python-replacement-for-0install">converted 0install from Python to OCaml</a>, learning OCaml in the process. The full code is at <a href="https://github.com/0install/0install">GitHub/0install</a>. )</p>

<p><strong>A note on bias</strong></p>

<p>I started these blog posts unemployed (taking a career break), with no particular connection to any of the languages, and motivated to make a good choice since I&rsquo;d be using it a lot. I wasn&rsquo;t biased towards OCaml; it wasn&rsquo;t even on my list of candidates until a complete stranger <a href="http://article.gmane.org/gmane.comp.file-systems.zero-install.devel/6914/match=ocaml">suggested it on the mailing list</a>.
But I must now disclose that, since my last blog post, I&rsquo;m now getting paid for writing OCaml.</p>

<h2>Functional programming</h2>

<p>Some people commented it was good to see more projects moving to functional programming. So, what&rsquo;s it like doing functional programming after Python? To be honest, not much has changed. According to OCaml&rsquo;s <a href="http://ocaml.org/learn/tutorials/functional_programming.html">What is functional programming?</a>, &ldquo;In a functional language, functions are first-class citizens&rdquo; and &ldquo;The fact is that Perl is actually quite a good functional language&rdquo;.</p>

<p>So, if you&rsquo;ve ever used Python&rsquo;s (built-in) <code>map</code>, <code>reduce</code>, <code>filter</code> or <code>apply</code> functions, ever written or used a <a href="http://www.python.org/dev/peps/pep-0318/">decorator</a> or ever passed a function as an argument to another function, you&rsquo;re already doing functional programming as far as OCaml is concerned. By contrast, &ldquo;<em>pure</em> functional programming&rdquo; (as in Haskell) would be a major change.</p>

<p>OCaml does make partially applying functions easier, which is sometimes convenient, and it supports <a href="http://en.wikipedia.org/wiki/Tail_call">tail recursion</a>. Tail recursion allows you to write loops in a functional style (without needing <code>break</code>, <code>continue</code> or mutable state). That can make it easier to reason about loops, but I couldn&rsquo;t find any examples in 0install where this style was clearly better than a plain Python loop.</p>

<h2>Type-checking</h2>

<p>I&rsquo;ve used statically-typed languages before (I used to program in Java for my day job). That can catch many errors that Python would miss, but OCaml&rsquo;s type system is far more useful than Java&rsquo;s. Here&rsquo;s an example, where we want to display an icon for some program in the GUI:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="n">get_icon</span> <span class="n">program</span>
</span><span class="line"><span class="o">|&gt;</span> <span class="n">widget</span><span class="o">#</span><span class="n">set_icon</span>	<span class="c">(* Error! *)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<pre><code>Error: This expression has type Icon.t -&gt; unit
       but an expression was expected of type Icon.t option -&gt; 'a
</code></pre>

<p>Oops. The program might not have an icon (icons are optional). We&rsquo;ll need to use a default one in that case:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="n">get_icon</span> <span class="n">program</span>
</span><span class="line"><span class="o">|&gt;</span> <span class="n">default</span> <span class="n">generic_program_icon</span>
</span><span class="line"><span class="o">|&gt;</span> <span class="n">widget</span><span class="o">#</span><span class="n">set_icon</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Downloading some data:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">match</span> <span class="n">download</span> <span class="n">url</span> <span class="k">with</span>
</span><span class="line"><span class="o">|</span> <span class="o">`</span><span class="n">success</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="n">data</span>
</span><span class="line"><span class="o">|</span> <span class="o">`</span><span class="n">network_failure</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">show_error_dialog</span> <span class="n">msg</span>
</span><span class="line"><span class="c">(* Error! *)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<pre><code>Warning 8: this pattern-matching is not exhaustive.
Here is an example of a value that is not matched:
`aborted_by_user
</code></pre>

<p>Oops. The user might click the &ldquo;Cancel&rdquo; button - we need to handle that too:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">match</span> <span class="n">download</span> <span class="n">url</span> <span class="k">with</span>
</span><span class="line"><span class="o">|</span> <span class="o">`</span><span class="n">success</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="n">data</span>
</span><span class="line"><span class="o">|</span> <span class="o">`</span><span class="n">network_failure</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">show_error_dialog</span> <span class="n">msg</span>
</span><span class="line"><span class="o">|</span> <span class="o">`</span><span class="n">aborted_by_user</span> <span class="o">-&gt;</span> <span class="n">abort</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>When registering an extra feed to an interface we want to download it first to check it exists:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">add_feed</span> <span class="n">iface</span> <span class="o">(</span><span class="n">feed_url</span><span class="o">:</span><span class="n">feed_url</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="n">download_feed</span> <span class="n">feed_url</span><span class="o">;</span>	<span class="c">(* Error! *)</span>
</span><span class="line">  <span class="n">register_feed</span> <span class="n">iface</span> <span class="n">feed_url</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<pre><code>Error: This expression has type feed_url
       but an expression was expected of type [&lt; `remote_feed of url ]
       The second variant type does not allow tag(s) `local_feed
</code></pre>

<p>Oops. The user might specify a local file too:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">add_feed</span> <span class="n">iface</span> <span class="o">(</span><span class="n">feed_url</span><span class="o">:</span><span class="n">feed_url</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">begin</span> <span class="k">match</span> <span class="n">feed_url</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">remote_feed</span> <span class="o">_</span> <span class="k">as</span> <span class="n">feed_url</span> <span class="o">-&gt;</span> <span class="n">download_feed</span> <span class="n">feed_url</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">local_feed</span> <span class="n">path</span> <span class="o">-&gt;</span> <span class="n">check_file_exists</span> <span class="n">path</span> <span class="k">end</span><span class="o">;</span>
</span><span class="line">  <span class="n">register_feed</span> <span class="n">iface</span> <span class="n">feed_url</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Java makes you do all the work for static type checking, but manages to miss many of the benefits.
No matter how much care you take with your Java types, there&rsquo;s always a good chance you&rsquo;re going to crash with a NullPointerException.
By requiring correct handling of <code>None</code> (<code>null</code>) and ensuring pattern matching is exhaustive, OCaml&rsquo;s type checking is far more useful. As with Haskell, when a piece of OCaml code compiles successfully, there&rsquo;s a very good chance it will work first time.</p>

<p>And, of course, static checking makes refactoring much easier than in Python. For example, if you remove or rename something, the compiler will always find every place you need to update.</p>

<h2>Data type definitions</h2>

<p>OCaml makes it really easy to define new data types as you need them. The types are always easy to see, and you know that OCaml will enforce them (unlike comments in Python, which may be incorrect). Here&rsquo;s a record type for the configuration settings for an interface (an optional stability level and a list of extra feeds):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">type</span> <span class="n">interface_config</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">stability_policy</span> <span class="o">:</span> <span class="n">stability_level</span> <span class="n">option</span><span class="o">;</span>
</span><span class="line">  <span class="n">extra_feeds</span> <span class="o">:</span> <span class="nn">Feed</span><span class="p">.</span><span class="n">feed_import</span> <span class="kt">list</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And here&rsquo;s a variant (enum / tagged union / sum) type for the result of a download:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">type</span> <span class="n">download_result</span> <span class="o">=</span>
</span><span class="line">  <span class="o">[</span> <span class="o">`</span><span class="n">aborted_by_user</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">network_failure</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">success</span> <span class="k">of</span> <span class="n">filepath</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2>Polymorphic variants</h2>

<p>The <a href="http://ocaml.org/learn/tutorials/labels.html#Morevariantspolymorphicvariants">OCaml labels tutorial</a> describes polymorphic variants as a way to use the same name (e.g. <code>Open</code>) for different things (e.g. opening a door vs opening a lock) and says:</p>

<blockquote>
  <p>&ldquo;Because of the reduction in type safety, it is recommended that you don&rsquo;t use these in your code&rdquo;.</p>
</blockquote>

<p>This is quite misleading (and I was <a href="http://thread.gmane.org/gmane.comp.file-systems.zero-install.devel/6975/focus=6977">quickly corrected</a> when I repeated it).
Their real purpose is to support subsets and supersets, which are useful all over the place. Some examples:</p>

<ul>
  <li>
    <p>The &ldquo;0install&rdquo; command-line parser accepts a large number of options. The &ldquo;0install run&rdquo; subcommand accepts a subset of these. That subset can be further subdivided into common options (present in all commands, such as <code>--verbose</code>), options common to selection commands (e.g. <code>--before=VERSION</code>) and those specific to &ldquo;0install run&rdquo; (e.g. <code>--wrapper=COMMAND</code>).</p>
  </li>
  <li>
    <p>The GUI code that handles dialog responses (<code>OK</code>, <code>Cancel</code>, etc) must handle the union of all the action button responses it added and the always-present window close icon.</p>
  </li>
  <li>
    <p>The download code only handles the subset of feed URLs that represent remote resources.</p>
  </li>
  <li>
    <p>Users can only register local and remote feeds to an interface, not distribution-provided virtual feeds.</p>
  </li>
  <li>
    <p>Cached feeds contain only remote implementations, local feeds contain local and remote implementations, and distribution feeds contain only distribution implementations. All three types get combined together and passed to the solver.</p>
  </li>
</ul>

<p>Here&rsquo;s an example, showing the <code>run</code> command dividing its options into sub-groups, with the compiler checking that every option will be handled in all cases:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">select_opts</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
</span><span class="line"><span class="nn">Support</span><span class="p">.</span><span class="nn">Argparse</span><span class="p">.</span><span class="n">iter_options</span> <span class="n">flags</span> <span class="o">(</span><span class="k">function</span>
</span><span class="line">  <span class="o">|</span> <span class="o">#</span><span class="n">common_option</span> <span class="k">as</span> <span class="n">o</span> <span class="o">-&gt;</span> <span class="nn">Common_options</span><span class="p">.</span><span class="n">process_common_option</span> <span class="n">options</span> <span class="n">o</span>
</span><span class="line">  <span class="o">|</span> <span class="o">#</span><span class="n">select_option</span> <span class="o">|</span> <span class="o">`</span><span class="nc">Refresh</span> <span class="k">as</span> <span class="n">o</span> <span class="o">-&gt;</span> <span class="n">select_opts</span> <span class="o">:=</span> <span class="n">o</span> <span class="o">::</span> <span class="o">!</span><span class="n">select_opts</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="nc">Wrapper</span> <span class="n">w</span> <span class="o">-&gt;</span> <span class="n">run_opts</span><span class="o">.</span><span class="n">wrapper</span> <span class="o">&lt;-</span> <span class="nc">Some</span> <span class="n">w</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="nc">MainExecutable</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">run_opts</span><span class="o">.</span><span class="n">main</span> <span class="o">&lt;-</span> <span class="nc">Some</span> <span class="n">m</span>
</span><span class="line"><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Without polymorphic variants, OCaml&rsquo;s exhaustive matching requirements mean you&rsquo;d have to provide code to handle cases that (you think) can&rsquo;t happen. That&rsquo;s tedious and your program will crash if you get it wrong. Polymorphic variants mean you can prove to the compiler that only the correct subset needs to be handled at each point in the code. This is fantastic, and I can&rsquo;t think of any other major language that does this (though I&rsquo;m sure people will suggest some in the comments).</p>

<h2>Immutability</h2>

<p>In OCaml, all variables and record fields are immutable by default. This is far saner than Java (where the default is mutable and you must use <code>final</code> everywhere to override it). Immutable is a better default because:</p>

<ul>
  <li>Typically, you want most things to be immutable (in any language).</li>
  <li>If you forget to mark something as mutable, the compiler will quickly let you know, whereas forgetting to mark something as immutable would be missed.</li>
</ul>

<p>With mutable structures, you are always worrying about whether one piece of code will mutate a structure that another is relying on. For example, I originally made the XML element type mutable, but I found I was writing comments like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="c">(** Note: this returns the actual internal XML; don't modify it *)</span>
</span><span class="line"><span class="k">val</span> <span class="n">as_xml</span> <span class="o">:</span> <span class="n">selections</span> <span class="o">-&gt;</span> <span class="n">element</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>After removing the <code>mutable</code> annotations from the <code>element</code> declaration, the compiler showed me each piece of code I needed to modify to make it work again. Then, I was able to remove those notes.</p>

<p>[ The main difficulty in this conversion was handling XML namespace prefixes. Previously, each element had a reference to its owning document, which held a shared (mutable) pool of prefix bindings. Now, each namespaced item holds its preferred prefix, and the output code builds up a set of bindings before writing out the tree. ]</p>

<p>There is one case where Python and Java do better than OCaml: OCaml strings are mutable! The convention is to treat them as immutable, though.</p>

<p>Update: OCaml 4.02 has an option for immutable strings, with a separate <code>Bytes.t</code> for mutable byte arrays.</p>

<h2>Abstraction</h2>

<p>OCaml makes it very easy to hide a module&rsquo;s implementation details from its users using <em>abstract types</em>.</p>

<p>I gave one example in the <a href="http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/#sorted-treeview-iter-mix-up">bugs post</a>, where hiding the fact that a sorted tree is really the same type as an unsorted one prevents bugs due to mixing them up.</p>

<p>Here&rsquo;s another example. In the Python code, we would parse a selections XML document into a <code>Selections</code> object, like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">Selections</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_element</span><span class="p">):</span>
</span><span class="line">		<span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I found all this parsing and serialising complicated things and so in the OCaml rewrite I decided to use the plain XML element type everywhere.
That did simplify things, but it also removed some safety and clarity from the APIs.
Consider the <code>Selections.create</code> function (which now does nothing unless the document is in an old format and needs to be upgraded):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">create</span> <span class="n">root</span> <span class="o">=</span>
</span><span class="line">  <span class="nn">ZI</span><span class="p">.</span><span class="n">check_tag</span> <span class="s2">&quot;selections&quot;</span> <span class="n">root</span><span class="o">;</span>
</span><span class="line">  <span class="k">if</span> <span class="n">is_latest_format</span> <span class="n">root</span> <span class="k">then</span> <span class="n">root</span>
</span><span class="line">  <span class="k">else</span> <span class="n">convert_to_latest</span> <span class="n">root</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It&rsquo;s nice and simple, but it just returns an <code>element</code>. It would be easy to pass some other XML element to a function that only works on selection documents (or to pass a document that&rsquo;s still in the old format).
We can solve this simply by declaring an abstract type for selection documents in the interface file (<code>selections.mli</code>):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">type</span> <span class="n">t</span>
</span><span class="line"><span class="k">val</span> <span class="n">create</span> <span class="o">:</span> <span class="n">element</span> <span class="o">-&gt;</span> <span class="n">t</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>(note: it&rsquo;s an OCaml convention for a module&rsquo;s main type to be called <code>t</code>; other modules will refer to this type as <code>Selections.t</code>)</p>

<p>I think this gets the best of both worlds. Internally, a selections object is just the XML root element, which is simple and efficient, but code using it can&rsquo;t mix up the types. And, of course, we can change the internal type later if needed without breaking anything.</p>

<p>This isn&rsquo;t a particularly novel idea (you can do something similar in C). However, Python and Java would require you to write a wrapper object around the object you want to hide, and Python makes it easy for users of the API to access the internal representation even then. If you&rsquo;re writing a library, OCaml (like C) makes it clear when you&rsquo;re changing the module&rsquo;s interface vs merely changing its implementation.</p>

<p>( There is another interesting feature, which I haven&rsquo;t used yet: you can use the &ldquo;private&rdquo; modifier to say that users of the module can see the structure of the type but can&rsquo;t create their own instances of it. For example, saying <code>type t = private element</code> would allow users to cast a selections value to an XML element, but not to treat any old XML as a selections value. )</p>

<p>I did experience one case where abstraction didn&rsquo;t work as intended. In the SAT solver, I declared the type of a literal abstractly as <code>type lit</code> and, internally, I used <code>type lit = int</code> (an array index). That worked fine. Later, I changed the internal representation from an int to a record. Ideally, that would have no effect on users of the module, but OCaml allows testing abstract types for equality, which resulted in each comparison recursively exploring the whole SAT problem. It can also cause runtime crashes if it encounters a function in this traversal. Haskell&rsquo;s type classes avoid this problem by letting you control which types can be compared and how the comparison should be done.</p>

<h2>Speed</h2>

<p>Python is well known for being slow, but much of what real programs do is simply calling C libraries.
For example, when calculating a SHA256 digest, C does all the heavy lifting.</p>

<p>Despite this, I&rsquo;ve found OCaml to be fairly consistently 10 times faster in macro benchmarks (measuring a complete run of 0install from start to finish). Also, although I&rsquo;ve added a lot of code and dependencies since the initial benchmarks, it still runs almost as quickly.
<a href="http://roscidus.com/blog/blog/2013/06/20/replacing-python-round-2/#speed">The 0release benchmark</a> took 8ms with June&rsquo;s minimal version, compared to 10ms with the final version.</p>

<p>When doing pure calculations (e.g. a tight loop adding integers), OCaml is typically more than 100x faster than Python.</p>

<p>Even so, OCaml is probably not a great choice for CPU-intensive programs. Like Python, it has a global lock, so you can&rsquo;t have multiple threads all using the CPU at once. But if you&rsquo;re writing small utilities that need to run quickly, it&rsquo;s perfect.</p>

<p>Update: There is a <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Multicore-OCaml">multicore</a> OCaml branch under development which removes the global lock.</p>

<h2>No dependency cycles</h2>

<p>Perhaps I&rsquo;m making a virtue of a flaw here, but I like the fact that OCaml doesn&rsquo;t allow cyclic dependencies between source files.
I think this leads to cleaner code (back when I was writing Java, I wrote a script to extract all module dependencies and graph them so I could find and eliminate cycles).</p>

<p>What this means is that in any OCaml code-base, no matter how complex, there&rsquo;s always at least one module that doesn&rsquo;t depend on any of the others and which you can therefore read first.
Then there&rsquo;s a second module that only depends on the first one, etc.
For example, here are the modules that make up 0install&rsquo;s GTK plugin (note the lack of cycles):</p>

<p><img src="http://roscidus.com/blog/images/guideps.png" class="border center"/></p>

<p>Cycles can be a problem when converting existing code to OCaml, though. For example, the Python had a <code>helpers.py</code> module containing various high-level helper functions (e.g. <code>get_selections_gui</code> to run the GUI and return the user&rsquo;s selections, and <code>ensure_cached</code> to make sure some selections are cached and download them if not). That doesn&rsquo;t work in OCaml, because the helpers module depends on the GUI, but the GUI also depends on the helpers (the GUI sometimes needs to ensure things are cached). The result is that I had to move each helper function to the module it uses, but I don&rsquo;t mind because the result is a clearer API.</p>

<p>Another example is the <code>Config</code> object. When I started the Python code back in 2005, I was very excited about using the idea of <a href="http://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> for connecting together software modules (this is the basis of how 0install runs programs). Yet, for some reason I can&rsquo;t explain, it didn&rsquo;t occur to me to use a dependency injection style <em>within</em> the code. Instead, I made a load of singleton objects. Later, in an attempt to make things more testable, I moved all the singletons to a <code>Config</code> object and passed that around everywhere. I wasn&rsquo;t proud of this design even at the time, but it was the simplest way forward. It looked like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class="line">	<span class="nd">@property</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">fetcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span><span class="p">:</span>
</span><span class="line">			<span class="kn">from</span> <span class="nn">zeroinstall.injector</span> <span class="kn">import</span> <span class="n">fetch</span>
</span><span class="line">			<span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span> <span class="o">=</span> <span class="n">fetch</span><span class="o">.</span><span class="n">Fetcher</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class="line">		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetcher</span>
</span><span class="line">
</span><span class="line">	<span class="nd">@property</span>
</span><span class="line">	<span class="k">def</span> <span class="nf">trust_mgr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="line">		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trust_mgr</span><span class="p">:</span>
</span><span class="line">			<span class="kn">from</span> <span class="nn">zeroinstall.injector</span> <span class="kn">import</span> <span class="n">trust</span>
</span><span class="line">			<span class="bp">self</span><span class="o">.</span><span class="n">_trust_mgr</span> <span class="o">=</span> <span class="n">trust</span><span class="o">.</span><span class="n">TrustMgr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class="line">		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trust_mgr</span>
</span><span class="line">
</span><span class="line">	<span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>OCaml really didn&rsquo;t like this design! <code>config.py</code> depends on all the other modules because it calls their constructors, while they all depend on it to get their dependencies.</p>

<p>Note that this design isn&rsquo;t very safe: <code>Fetcher</code>&rsquo;s constructor could ask for <code>config.trust_mgr</code>, and <code>TrustMgr</code>&rsquo;s constructor could ask for <code>config.fetcher</code>. In Python, we have to remember not to do that, but in OCaml we&rsquo;d like the type checker to prove it can&rsquo;t happen.</p>

<p>In most places, I fixed this by passing to each constructor just the objects it actually needs, which is cleaner.</p>

<p>Another approach, which I used when lots of objects were needed, is that instead of requiring a <code>config</code> object, a class can take simply &ldquo;an object with at least <code>fetcher</code> and <code>trust_mgr</code> methods&rdquo;.
Then we know statically that it will only call those methods, even though we actually give it the full config object.</p>

<p>The result of all this is that you can look at e.g. the <code>fetch.mli</code> interface file and see exactly which other modules it depends on, none of which will depend on it.</p>

<h2>GUI code</h2>

<p>Converting the GTK GUI to OCaml (using the <a href="http://lablgtk.forge.ocamlcore.org/">LablGtk</a> bindings), I replaced <strong>5166</strong> lines of Python (<strong>plus 1736</strong> lines of GtkBuilder XML) with <strong>4017</strong> lines of OCaml (and no XML). I&rsquo;m not sure why, but writing GTK code in OCaml just seems to be much easier than with Python.</p>

<p>I used GtkBuilder in the Python code in the hope that it would make it easier to modify the layouts, and to improve reliability (since the XML should always be valid, whereas Python code might not be). However, it actually made things harder because Glade (the editor) is constantly trying to force you to upgrade to the latest (incompatible) XML syntax, and I ended up having to run an old OS in a VM any time I wanted to edit things.</p>

<p>In the OCaml, the static type checking gives us similar confidence that the layout code won&rsquo;t crash. Also, with GtkBuilder you name each widget in the XML and then search for these names in the code. If they don&rsquo;t match, it will fail at runtime. Having everything in OCaml meant that couldn&rsquo;t happen. [ Note: I later discovered that LablGtk doesn&rsquo;t support GtkBuilder anyway. ]</p>

<p>Here&rsquo;s an example of some OCaml GTK code and the corresponding Python code. This shows how to build and display a menu (simplified to have just one item):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>OCaml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">menu</span> <span class="o">=</span> <span class="nn">GMenu</span><span class="p">.</span><span class="n">menu</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line"><span class="k">let</span> <span class="n">explain</span> <span class="o">=</span> <span class="nn">GMenu</span><span class="p">.</span><span class="n">menu_item</span> <span class="o">~</span><span class="n">packing</span><span class="o">:</span><span class="n">menu</span><span class="o">#</span><span class="n">add</span> <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Explain this decision&quot;</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line"><span class="n">explain</span><span class="o">#</span><span class="n">connect</span><span class="o">#</span><span class="n">activate</span> <span class="o">~</span><span class="n">callback</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">show_explanation</span> <span class="n">impl</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="o">;</span>
</span><span class="line"><span class="n">menu</span><span class="o">#</span><span class="n">popup</span> <span class="o">~</span><span class="n">button</span><span class="o">:(</span><span class="nn">B</span><span class="p">.</span><span class="n">button</span> <span class="n">bev</span><span class="o">)</span> <span class="o">~</span><span class="n">time</span><span class="o">:(</span><span class="nn">B</span><span class="p">.</span><span class="n">time</span> <span class="n">bev</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Python </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">global</span> <span class="n">menu</span>		<span class="c"># Fix GC problem with PyGObject</span>
</span><span class="line"><span class="n">menu</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
</span><span class="line"><span class="n">item</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">()</span>
</span><span class="line"><span class="n">item</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">'Explain this decision'</span><span class="p">)</span>
</span><span class="line"><span class="n">item</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'activate'</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_explanation</span><span class="p">(</span><span class="n">impl</span><span class="p">))</span>
</span><span class="line"><span class="n">item</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span class="line"><span class="n">menu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class="line"><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span class="line">	<span class="n">menu</span><span class="o">.</span><span class="n">popup</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">bev</span><span class="o">.</span><span class="n">button</span><span class="p">,</span> <span class="n">bev</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</span><span class="line"><span class="k">else</span><span class="p">:</span>
</span><span class="line">	<span class="n">menu</span><span class="o">.</span><span class="n">popup</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">bev</span><span class="o">.</span><span class="n">button</span><span class="p">,</span> <span class="n">bev</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Some points to note:</p>

<ul>
  <li>LablGtk allows you to specify many properties at once in the constructor call, whereas in PyGTK we need separate calls for each.</li>
  <li>The Python API broke between Python 2 and Python 3, so we have to make sure to use the right one. It&rsquo;s not sufficient to test the Python code using only one version of Python!</li>
  <li>The Python bindings have always suffered from garbage collection bugs. If we don&rsquo;t store <code>menu</code> in a global variable, it may garbage collect the menu while the user is still choosing - this makes the menu disappear suddenly from the screen!</li>
  <li>Actually, I see that Python&rsquo;s <code>MenuItem</code> takes a <code>label</code> argument, so maybe I could save a line. Or maybe that doesn&rsquo;t work on some older version. It&rsquo;s not worth the risk of changing it.</li>
</ul>

<p>Update: I used the original layout for the OCaml above as I was comparing line counts, but it&rsquo;s a bit wide for this narrow blog and some people are finding it hard to read. Here&rsquo;s an expanded version which uses less special syntax:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">menu</span> <span class="o">=</span> <span class="nn">GMenu</span><span class="p">.</span><span class="n">menu</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line"><span class="k">let</span> <span class="n">explain</span> <span class="o">=</span> <span class="nn">GMenu</span><span class="p">.</span><span class="n">menu_item</span>
</span><span class="line">  <span class="o">~</span><span class="n">packing</span><span class="o">:</span><span class="n">menu</span><span class="o">#</span><span class="n">add</span>
</span><span class="line">  <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Explain this decision&quot;</span>
</span><span class="line">  <span class="bp">()</span> <span class="k">in</span>
</span><span class="line"><span class="k">let</span> <span class="n">callback</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">show_explanation</span> <span class="n">impl</span> <span class="k">in</span>
</span><span class="line"><span class="k">let</span> <span class="o">_</span><span class="n">signal_id</span> <span class="o">=</span> <span class="n">explain</span><span class="o">#</span><span class="n">connect</span><span class="o">#</span><span class="n">activate</span> <span class="o">~</span><span class="n">callback</span> <span class="k">in</span>
</span><span class="line"><span class="n">menu</span><span class="o">#</span><span class="n">popup</span> <span class="o">~</span><span class="n">button</span><span class="o">:(</span><span class="nn">B</span><span class="p">.</span><span class="n">button</span> <span class="n">bev</span><span class="o">)</span> <span class="o">~</span><span class="n">time</span><span class="o">:(</span><span class="nn">B</span><span class="p">.</span><span class="n">time</span> <span class="n">bev</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here, <code>~</code> indicates a named argument and <code>#</code> is a method call. So <code>menu_item ~packing:menu#add ...</code> is like <code>menu_item(packing = menu.add, ...)</code> in Python.</p>

<p>However, I did still have a few problems with the OCaml GTK bindings:</p>

<ul>
  <li>There&rsquo;s no support for custom cell renderers. I used three of these in the Python version and had to find alternative UIs for each.</li>
  <li>Various minor functions aren&rsquo;t included for some reason. The ones I wanted but couldn&rsquo;t find were <code>Dialog.add_action_widget</code>, <code>Style.paint_arrow</code>, <code>MessageDialog.BUTTONS_NONE</code>, <code>Dialog.set_keep_above</code>, <code>icon_size_lookup</code> and <code>Selection_data.get_uris</code>.</li>
  <li>I had to work around a <a href="http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/#crashes-with-gtkiconview">bug in the IconView support</a> (reported <s>but with no response</s> and fixed immediately, although the bug report wasn&rsquo;t updated).</li>
  <li>You usually don&rsquo;t need the result of creating a label or attaching a signal so you need to use <code>ignore</code>, which can cause silent failures if you forgot an argument (it will ignore the partial function rather than the widget or signal result). Probably I should make <code>ignore_signal</code> and <code>ignore_widget</code> utility functions.</li>
</ul>

<p>Update: I did add <code>ignore_widget</code>, but for signals I found a better solution: I created a new <code>==&gt;</code> operator to connect a signal and ignore the resulting signal ID. It&rsquo;s used like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="n">explain</span><span class="o">#</span><span class="n">connect</span><span class="o">#</span><span class="n">activate</span> <span class="o">==&gt;</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">show_explanation</span> <span class="n">impl</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2>API stability</h2>

<p>This is a community thing rather than a language issue, but OCaml and OCaml libraries seem to be very good at maintaining backwards compatibility at the source level. 0install supports the old OCaml 3.12 and libraries in Ubuntu 12.04 up to the latest OCaml 4.01 release without any problems. The only use of conditional compilation for compatibility is that we don&rsquo;t define the <code>|&gt;</code> operator on 4.01 because it&rsquo;s already a built-in (this avoids a warning).</p>

<p>On the other hand, binary compatibility is very poor. You can replace the implementation of a module with a newer version as long as the public interface doesn&rsquo;t change (good), but any change at all to the interface requires everything that depends on it to be recompiled, and then everything that depends on them, and so on.</p>

<p>For example, if the <code>List</code> module adds a new function then the signature of the <code>List</code> module changes. Now any program using the new version of the <code>List</code> module is incompatible with every library binary compiled against the old version. Even if nothing is even using the new function! This means that distributing OCaml libraries in binary form is effectively impossible.</p>

<h2>Summary</h2>

<p>OCaml&rsquo;s main strengths are correctness and speed. Its type checking is very good at catching errors, and its &ldquo;polymorphic variants&rdquo; are a particularly useful feature, which I haven&rsquo;t seen in other languages. Separate module interface files, abstract types, cycle-free dependencies, and data structures that are immutable by default help to make clean APIs.</p>

<p>Surprisingly, writing GTK GUI code in OCaml was easier than in Python. The resulting code was significantly shorter and, I suspect, will prove far more reliable. OCaml&rsquo;s type checking is particularly welcome here, as GUI code is often difficult to unit-test.</p>

<p>The OCaml community is very good at maintaining API stability, allowing the same code to compile on old and new systems and (hopefully) minimising time spent updating it later.</p>
<a onclick="switchContent('ocamlorg-post66','ocamlorg-post65')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/02/13/ocaml-what-you-gain/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2014/02/13/ocaml-what-you-gain/">by Thomas Leonard at Feb 13, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/mirage-1.1-released">
    <a name="#http://openmirage.org/blog/mirage-1.1-released"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/mirage-1.1-released">Mirage 1.1.0: the eat-your-own-dogfood release</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post67">
      <p>We've just released <a href="https://github.com/ocaml/opam-repository/pull/1655">Mirage 1.1.0</a> into OPAM.  Once the
live site updates, you should be able to run <code>opam update -u</code> and get the latest
version.  This release is the &quot;<a href="http://en.wikipedia.org/wiki/Eating_your_own_dog_food">eat our own
dogfood</a>&quot; release; as I
mentioned earlier in January, a number of the Mirage developers have decided to
shift our own personal homepages onto Mirage.  There's nothing better than
using our own tools to find all the little annoyances and shortcomings, and so
Mirage 1.1.0 contains some significant usability and structural improvements
for building unikernels.</p>
<h4>Functional combinators to build device drivers</h4>

<p>Mirage separates the
application logic from the concrete backend in use by writing the application
as an <a href="https://realworldocaml.org/v1/en/html/functors.html">OCaml functor</a>
that is parameterized over module types that represent the device driver
signature.  All of the module types used in Mirage can be browsed in <a href="https://github.com/mirage/mirage/blob/1.1.0/types/V1.mli">one
source file</a>.</p>
<p>In Mirage 1.1.0, <a href="http://gazagnaire.org/">Thomas Gazagnaire</a> implemented a
a <a href="https://github.com/mirage/mirage/blob/1.1.0/lib/mirage.mli#L28">combinator library</a>
that makes it easy to separate the definition of application l&hellip;</p><a onclick="switchContent('ocamlorg-post67','ocamlorg-post68')" class="btn planet-toggle" href="#http://openmirage.org/blog/mirage-1.1-released">Read more...</a></div><div id="ocamlorg-post68" style="display: none">
      <p>We've just released <a href="https://github.com/ocaml/opam-repository/pull/1655">Mirage 1.1.0</a> into OPAM.  Once the
live site updates, you should be able to run <code>opam update -u</code> and get the latest
version.  This release is the &quot;<a href="http://en.wikipedia.org/wiki/Eating_your_own_dog_food">eat our own
dogfood</a>&quot; release; as I
mentioned earlier in January, a number of the Mirage developers have decided to
shift our own personal homepages onto Mirage.  There's nothing better than
using our own tools to find all the little annoyances and shortcomings, and so
Mirage 1.1.0 contains some significant usability and structural improvements
for building unikernels.</p>
<h4>Functional combinators to build device drivers</h4>

<p>Mirage separates the
application logic from the concrete backend in use by writing the application
as an <a href="https://realworldocaml.org/v1/en/html/functors.html">OCaml functor</a>
that is parameterized over module types that represent the device driver
signature.  All of the module types used in Mirage can be browsed in <a href="https://github.com/mirage/mirage/blob/1.1.0/types/V1.mli">one
source file</a>.</p>
<p>In Mirage 1.1.0, <a href="http://gazagnaire.org/">Thomas Gazagnaire</a> implemented a
a <a href="https://github.com/mirage/mirage/blob/1.1.0/lib/mirage.mli#L28">combinator library</a>
that makes it easy to separate the definition of application logic from the details
of the device drivers that actually execute the code (be it a Unix binary or a
dedicated Xen kernel).  It lets us write code of this form
(taken from <a href="https://github.com/mirage/mirage-skeleton/tree/master/block">mirage-skeleton/block</a>):</p>
<pre><code>let () =
  let main = foreign &quot;Unikernel.Block_test&quot; (console @-&gt; block @-&gt; job) in
  let img = block_of_file &quot;disk.img&quot; in
  register &quot;block_test&quot; [main $ default_console $ img]</code></pre>

<p>In this configuration fragment, our unikernel is defined as a functor over a
console and a block device by using <code>console @-&gt; block @-&gt; job</code>.  We then
define a concrete version of this job by applying the functor (using the <code>$</code>
combinator) to a default console and a file-backed disk image.</p>
<p>The combinator approach lets us express complex assemblies of device driver
graphs by writing normal OCaml code, and the <code>mirage</code> command line tool
parses this at build-time and generates a <code>main.ml</code> file that has all the
functors applied to the right device drivers. Any mismatches in module signatures
will result in a build error, thus helping to spot nonsensical combinations
(such as using a Unix network socket in a Xen unikernel).</p>
<p>This new feature is walked through in the <a href="http://openmirage.org/docs/hello-world">tutorial</a>, which
now walks you through several skeleton examples to explain all the different
deployment scenarios.  It's also followed by the <a href="http://openmirage.org/docs/mirage-www">website tutorial</a>
that explains how this website works, and how our <a href="http://openmirage.org/docs/deploying-via-ci">Travis autodeployment</a>
throws the result onto the public Internet.</p>
<p>Who will win the race to get our website up and running first?  Sadly for Anil,
<a href="http://www.cs.nott.ac.uk/~rmm/">Mort</a> is currently <a href="https://github.com/mor1/mort-www">in the
lead</a> with an all-singing, all-dancing shiny
new website.  Will he finish in the lead though? Stay tuned!</p>
<h4>Less magic in the build</h4>

<p>Something that's more behind-the-scenes, but important for easier development,
is a simplication in how we build libraries.  In Mirage 1.0, we had several
packages that couldn't be simultaneously installed, as they had to be compiled 
in just the right order to ensure dependencies.</p>
<p>With Mirage 1.1.0, this is all a thing of the past.  All the libraries can
be installed fully in parallel, including the network stack.  The 1.1.0
<a href="https://github.com/mirage/mirage-tcpip">TCP/IP stack</a> is now built in the
style of the venerable <a href="http://www.cs.cmu.edu/~fox/foxnet.html">FoxNet</a> network
stack, and is parameterized across its network dependencies.  This means
that once can quickly assemble a custom network stack from modular components,
such as this little fragment below from <a href="https://github.com/mirage/mirage-skeleton/blob/master/ethifv4/unikernel.ml">mirage-skeleton/ethifv4/</a>:</p>
<pre><code>module Main (C: CONSOLE) (N: NETWORK) = struct

  module E = Ethif.Make(N)
  module I = Ipv4.Make(E)
  module U = Udpv4.Make(I)
  module T = Tcpv4.Flow.Make(I)(OS.Time)(Clock)(Random)
  module D = Dhcp_clientv4.Make(C)(OS.Time)(Random)(E)(I)(U)
  </code></pre>

<p>This functor stack starts with a <code>NETWORK</code> (i.e. Ethernet) device, and then applies
functors until it ends up with a UDPv4, TCPv4 and DHCPv4 client.  See the <a href="https://github.com/mirage/mirage-skeleton/blob/master/ethifv4/unikernel.ml">full
file</a>
to see how the rest of the logic works, but this serves to illustrate how
Mirage makes it possible to build custom network stacks out of modular
components.  The functors also make it easier to embed the network stack in
non-Mirage applications, and the <code>tcpip</code> OPAM package installs pre-applied Unix
versions for your toplevel convenience.</p>
<p>To show just how powerful the functor approach is, the same stack can also
be mapped onto a version that uses kernel sockets simply by abstracting the
lower-level components into an equivalent that uses the Unix kernel to provide
the same functionality.  We explain how to swap between these variants in
the <a href="http://openmirage.org/wiki/hello-world">tutorials</a>.</p>
<h4>Lots of library releases</h4>

<p>While doing the 1.1.0 release in January, we've also released quite a few libraries
into <a href="https://opam.ocaml.org">OPAM</a>.  Here are some of the highlights.</p>
<p>Low-level libraries:</p>
<ul><li><a href="https://github.com/samoht/ocaml-mstruct/">mstruct</a> is a streaming layer for handling lists of memory buffers with a simpler read/write interface.</li><li><a href="https://github.com/xapi-project/nbd/">nbd</a> is an implementation of the <a href="http://en.wikipedia.org/wiki/Network_block_device">Network Block Device</a> protocol for block drivers.</li></ul>

<p>Networking and web libraries:</p>
<ul><li><a href="https://github.com/mirage/ocaml-ipaddr">ipaddr</a> now has IPv6 parsing support thanks to <a href="https://github.com/hhugo/">Hugo Heuzard</a> and David Sheets.  This is probably the hardest bit of adding IPv6 support to our network stack!</li><li><a href="https://github.com/mirage/cowabloga">cowabloga</a> is slowly emerging as a library to handle the details of rendering Zurb Foundation websites.  It's still in active development, but being used for a few of our <a href="https://github.com/mor1/mort-www">personal websites</a> as well as this website.</li><li><a href="https://github.com/avsm/ocaml-cohttp">cohttp</a> has had several releases thanks to external contributions, particular from <a href="https://github.com/rgrinberg">Rudy Grinberg</a> who added s-expression support and several <a href="https://github.com/avsm/ocaml-cohttp/blob/master/CHANGES">other improvements</a>.</li><li><a href="https://github.com/avsm/ocaml-uri">uri</a> features performance improvements and the elimination of Scanf (considered <a href="http://www.lexifi.com/blog/note-about-performance-printf-and-format">rather slow</a> by OCaml standards).</li><li><a href="https://github.com/mirage/ocaml-cow">cow</a> continues its impossible push to make coding HTML and CSS a pleasant experience, with better support for Markdown now.</li><li>The <a href="https://github.com/avsm/ocaml-github">github</a> bindings are now also in use as part of an experiment to make <a href="http://gallium.inria.fr/blog/patch-review-on-github/">upstream OCaml development</a> easier for newcomers, thanks to Gabriel Scherer.</li></ul>

<p><a href="http://dave.recoil.org">Dave Scott</a> led the splitting up of several low-level Xen libraries as part of the build simplication.  These now compile on both Xen (using the direct hypercall interface) and Unix (using the dom0 <code>/dev</code> devices) where possible.</p>
<ul><li><a href="https://github.com/xapi-project/ocaml-evtchn">xen-evtchn</a> for the event notification mechanism. There are a couple of wiki posts that explain how <a href="http://openmirage.org/wiki/xen-events">event channels</a> and <a href="http://openmirage.org/wiki/xen-suspend">suspend/resume</a> work in Mirage/Xen guests.</li><li><a href="https://github.com/xapi-project/ocaml-gnt">xen-gnt</a> for the grant table mechanism that controls inter-process memory.</li><li>The <a href="https://github.com/mirage/io-page">io-page</a> library no longer needs Unix and Xen variants, as the interface has been standardized to work in both.</li></ul>

<p>All of Dave's hacking on Xen device drivers is showcased in this <a href="http://openmirage.org/wiki/xen-synthesize-virtual-disk">xen-disk wiki post</a> that 
explains how you can synthesize your own virtual disk backends using Mirage.  Xen uses a <a href="https://www.usenix.org/legacy/event/usenix05/tech/general/full_papers/short_papers/warfield/warfield.pdf">split device</a> model,
and now Mirage lets us build <em>backend</em> device drivers that service VMs as well as the frontends!</p>
<p>Last, but not least, <a href="http://gazagnaire.org">Thomas Gazagnaire</a> has been building a brand new storage system for Mirage guests that uses git-style branches under the hood to help coordinate clusters of unikernels.  We'll talk about how this works in a future update, but there are some cool libraries and prototypes available on OPAM for the curious.</p>
<ul><li><a href="https://github.com/samoht/ocaml-lazy-trie/">lazy-trie</a> is a lazy version of the Trie data structure, useful for exposing Git graphs.</li><li><a href="https://github.com/samoht/ocaml-git">git</a> is a now-fairly complete implementation of the Git protocol in pure OCaml, which can interoperate with normal Git servers via the <code>ogit</code> command-line tool that it installs.</li><li><a href="https://github.com/mirage/irmin">irmin</a> is the main library that abstracts Git DAGs into an OCaml programming API.  The homepage has <a href="https://github.com/mirage/irmin/wiki/Getting-Started">instructions</a> on how to play with the command-line frontend to experiment with the database.</li><li><a href="https://github.com/samoht/git2fat">git2fat</a> converts a Git checkout into a FAT block image, useful when bundling up unikernels.</li></ul>

<p>We'd also like to thank several conference organizers for giving us the opportunity to demonstrate Mirage.  The talk video from <a href="http://www.infoq.com/presentations/mirage-os">QCon SF</a> is now live, and we also had a <em>great</em> time at <a href="http://fosdem.org">FOSDEM</a> recently (summarized by Amir <a href="http://nymote.org/blog/2014/fosdem-summary/">here</a>). 
So lots of activities, and no doubt little bugs lurking in places (particularly around installation).  As always, please do let us know of any problem by <a href="https://github.com/mirage/mirage/issues">reporting bugs</a>, or feel free to <a href="http://openmirage.org/community">contact us</a> via our e-mail lists or IRC.  Next stop: our unikernel homepages!</p>

   <a onclick="switchContent('ocamlorg-post68','ocamlorg-post67')" class="btn planet-toggle" href="#http://openmirage.org/blog/mirage-1.1-released">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/mirage-1.1-released">by Anil Madhavapeddy at Feb 11, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://ocamllabs.github.com/compiler-hacking/2014/02/11/fourth-compiler-hacking-session">
    <a name="#http://ocamllabs.github.com/compiler-hacking/2014/02/11/fourth-compiler-hacking-session"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../images/hax0ring.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://ocamllabs.github.com/compiler-hacking/2014/02/11/fourth-compiler-hacking-session">Fourth OCaml compiler hacking session</a>
      (<a href="http://ocamllabs.github.io/compiler-hacking/rss.xml" title="OCaml Labs compiler hacking">Compiler Hacking</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post69"><p>It's time for the fourth Cambridge OCaml compiler-hacking session!  We'll be meeting in the <a href="http://www.cl.cam.ac.uk/">Computer Lab</a> again next Tuesday evening.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/5tk8rs5k3mh82qqx"><em>indicate interest via Doodle</em></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking"><em>sign up to the mailing list</em></a> to receive updates:</p>

<p><em>Where</em>: Room <a href="http://www.cl.cam.ac.uk/research/dtg/openroommap/static/?s=FW11&amp;amp%3Blabels=1">FW11</a>, <a href="http://www.cl.cam.ac.uk/directions/">Computer Laboratory, Madingley Road</a></p>

<p><em>When</em>: 6pm, Tuesday 18th February</p>

<p><em>Who</em>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><em>What</em>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><em>Wiki</em>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-projects</a> for various levels of experi&hellip;</p><a onclick="switchContent('ocamlorg-post69','ocamlorg-post70')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/02/11/fourth-compiler-hacking-session">Read more...</a></div><div id="ocamlorg-post70" style="display: none"><p>It's time for the fourth Cambridge OCaml compiler-hacking session!  We'll be meeting in the <a href="http://www.cl.cam.ac.uk/">Computer Lab</a> again next Tuesday evening.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/5tk8rs5k3mh82qqx"><em>indicate interest via Doodle</em></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking"><em>sign up to the mailing list</em></a> to receive updates:</p>

<p><em>Where</em>: Room <a href="http://www.cl.cam.ac.uk/research/dtg/openroommap/static/?s=FW11&amp;amp%3Blabels=1">FW11</a>, <a href="http://www.cl.cam.ac.uk/directions/">Computer Laboratory, Madingley Road</a></p>

<p><em>When</em>: 6pm, Tuesday 18th February</p>

<p><em>Who</em>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><em>What</em>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><em>Wiki</em>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-projects</a> for various levels of experience (see also some <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-previously-worked-on">things we've worked on in previous sessions</a>), but feel free to come along and work on whatever you fancy.</p>

<p>We'll also be ordering pizza, so if you want to be counted for food you should aim to arrive by 6.30pm.</p>
<a onclick="switchContent('ocamlorg-post70','ocamlorg-post69')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/02/11/fourth-compiler-hacking-session">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://ocamllabs.github.com/compiler-hacking/2014/02/11/fourth-compiler-hacking-session">by Compiler Hacking at Feb 11, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://ocamllabs.github.com/compiler-hacking/2014/02/04/handler-case">
    <a name="#http://ocamllabs.github.com/compiler-hacking/2014/02/04/handler-case"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../images/hax0ring.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://ocamllabs.github.com/compiler-hacking/2014/02/04/handler-case">How to handle success</a>
      (<a href="http://ocamllabs.github.io/compiler-hacking/rss.xml" title="OCaml Labs compiler hacking">Compiler Hacking</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post71"><p>(Update (2014-05-28): Added notes on <a href="http://ocamllabs.github.io/compiler-hacking/rss.xml#delimcc">delimcc</a> and <a href="http://ocamllabs.github.io/compiler-hacking/rss.xml#catch-me">Catch me if you can</a> to the <em>Discoveries</em> section.)</p>

<p>(Update (2014-05-05): The <a href="http://ocamllabs.github.io/compiler-hacking/rss.xml#match-exception"><code>match/exception</code></a> variant of this proposal has been <a href="https://github.com/ocaml/ocaml/commit/0f1fb19cbe48918c5d070e475c39052875623a85">merged into OCaml trunk</a>, ready for release in 4.02.)</p>

<p>(Update: there's a <a href="http://caml.inria.fr/mantis/view.php?id=6318">Mantis issue open</a> to discuss this proposal.)</p>

<p>OCaml's <code>try</code> construct is good at dealing with exceptions, but not so good at handling the case where no exception is raised.  This post describes a simple extension to <code>try</code> that adds support for handling the &quot;success&quot; case.</p>

<p>Here's an example of code that benefits from the extension.  On a recent <a href="http://caml.inria.fr/resources/forums.en.html">caml-list</a> thread, <a href="http://cedeela.fr/~simon/">Simon Cruanes</a> posted <a href="https://sympa.inria.fr/sympa/arc/caml-list/2014-01/msg00113.html">the following function</a> for iterating over a stream:</p>

<blockquote>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">match</span> <span class="o">(</span><span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">MyStream</span><span class="p">.</span><span class="n">get</span> <span class="n">s</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_stream</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s'</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="n">f</span> <span class="n">x</span><span class="o">;</span>
      <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s'</span>
</code></pre></div></blockquote>

<p>For each element of a stream, <code>iter_stream</code> wraps the element with <code>Some</code>, then unwraps it again and passes it to <code>f</code>.  At first glance, wrapping and immedia&hellip;</p><a onclick="switchContent('ocamlorg-post71','ocamlorg-post72')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/02/04/handler-case">Read more...</a></div><div id="ocamlorg-post72" style="display: none"><p>(Update (2014-05-28): Added notes on <a href="http://ocamllabs.github.io/compiler-hacking/rss.xml#delimcc">delimcc</a> and <a href="http://ocamllabs.github.io/compiler-hacking/rss.xml#catch-me">Catch me if you can</a> to the <em>Discoveries</em> section.)</p>

<p>(Update (2014-05-05): The <a href="http://ocamllabs.github.io/compiler-hacking/rss.xml#match-exception"><code>match/exception</code></a> variant of this proposal has been <a href="https://github.com/ocaml/ocaml/commit/0f1fb19cbe48918c5d070e475c39052875623a85">merged into OCaml trunk</a>, ready for release in 4.02.)</p>

<p>(Update: there's a <a href="http://caml.inria.fr/mantis/view.php?id=6318">Mantis issue open</a> to discuss this proposal.)</p>

<p>OCaml's <code>try</code> construct is good at dealing with exceptions, but not so good at handling the case where no exception is raised.  This post describes a simple extension to <code>try</code> that adds support for handling the &quot;success&quot; case.</p>

<p>Here's an example of code that benefits from the extension.  On a recent <a href="http://caml.inria.fr/resources/forums.en.html">caml-list</a> thread, <a href="http://cedeela.fr/~simon/">Simon Cruanes</a> posted <a href="https://sympa.inria.fr/sympa/arc/caml-list/2014-01/msg00113.html">the following function</a> for iterating over a stream:</p>

<blockquote>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">match</span> <span class="o">(</span><span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">MyStream</span><span class="p">.</span><span class="n">get</span> <span class="n">s</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_stream</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s'</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="n">f</span> <span class="n">x</span><span class="o">;</span>
      <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s'</span>
</code></pre></div></blockquote>

<p>For each element of a stream, <code>iter_stream</code> wraps the element with <code>Some</code>, then unwraps it again and passes it to <code>f</code>.  At first glance, wrapping and immediately unwrapping in this way seems like needless obfuscation.  However, moving the last two lines out of the body of the <code>try</code> in this way serves two essential purposes: it turns the recursive call to <code>iter_stream</code> into a tail call, and it allows exceptions raised by <code>f</code> to propagate.  More generally, this use of options makes it easy to specify the <em>success continuation</em> of a <code>try</code> expression, i.e. the piece of code that receives the value of the body when no exception is raised.</p>

<p>As Simon notes, the <code>match (try Some ...)</code> idiom is widely used in OCaml code.  Examples can be found in the source of <a href="https://github.com/ocsigen/lwt/blob/b63b2a/src/unix/lwt_unix.ml#L118-L125">lwt</a>, <a href="https://github.com/ocaml-batteries-team/batteries-included/blob/92ea390c/benchsuite/bench_nreplace.ml#L45-L48">batteries</a>, <a href="https://github.com/savonet/liquidsoap/blob/a81cd8b6/src/decoder/metadata_decoder.ml#L53-L55">liquidsoap</a>, <a href="https://github.com/janestreet/sexplib/blob/f9bd413/lib/conv.ml#L256-L259">sexplib</a>, <a href="https://github.com/MLstate/opalang/blob/0802728/compiler/opalang/opaParser.ml#L127-L135">opa</a>, <a href="https://github.com/avsm/ocaml-uri/blob/35af64db/lib/uri.ml#L250-L255">uri</a>, <a href="https://github.com/coq/coq/blob/724c9c9f/tools/coqdoc/tokens.ml#L36-L41">coq</a>, <a href="https://github.com/pascal-bach/Unison/blob/4788644/src/ubase/prefs.ml#L97-L106">unison</a>, and many other packages.  </p>

<p>In response to Simon's message, <a href="http://okmij.org/ftp">Oleg</a> pointed out <a href="https://sympa.inria.fr/sympa/arc/caml-list/2014-01/msg00146.html">a solution</a>: the 2001 paper <a href="http://research.microsoft.com/~akenn/sml/exceptionalsyntax.pdf">Exceptional Syntax</a>  (<a href="http://research.microsoft.com/~nick/">Benton</a> and <a href="http://research.microsoft.com/~akenn/">Kennedy</a>) extends <code>try</code> with a <code>let</code>-like binding construct that supports the success continuation idiom directly without the need for the option value.</p>



<p>This post describes a patch to OCaml that implements a variant of Benton and Kennedy's design called <em>handler case</em>.  Like Exceptional Syntax, handler case extends <code>try</code> with explicit success continuation handling.  However, unlike Exceptional syntax, handler case uses <code>match</code> binding for both the success continuation and the exception-handling clauses.  Here's the extended <code>try</code> syntax:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">try</span> <span class="n">expr</span>
<span class="k">with</span> <span class="n">pattern_1</span> <span class="o">-&gt;</span> <span class="n">expr_1</span>
   <span class="o">|</span> <span class="o">...</span>
   <span class="o">|</span> <span class="n">pattern_n</span> <span class="o">-&gt;</span> <span class="n">expr_n</span>
   <span class="o">|</span> <span class="k">val</span> <span class="n">pattern_1'</span> <span class="o">-&gt;</span> <span class="n">expr_1'</span>
   <span class="o">|</span> <span class="o">...</span>
   <span class="o">|</span> <span class="k">val</span> <span class="n">pattern_n'</span> <span class="o">-&gt;</span> <span class="n">expr_n'</span>
</code></pre></div>
<p>As in <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/expr.html#@manual.kwd50">current OCaml</a>, the clauses <code>pattern_1 -&gt; expr_1</code> ... <code>pattern_n -&gt; expr_n</code> handle exceptions raised during the evaluation of <code>expr</code>.  The clauses  <code>val pattern_1' -&gt; expr_1'</code> ... <code>val pattern_n' -&gt; expr_n'</code> handle the case where no exception is raised; in this case the value of <code>expr</code> is matched against <code>pattern_1'</code> ... <code>pattern_n'</code> to select the expression to evaluate to produce the result value.  (The actual syntax is implemented slightly more permissively: it allows value-matching and exception-matching clauses to be freely interleaved.)</p>

<p>Using handler case we can rewrite <code>iter_stream</code> to remove the extraneous option value:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">MyStream</span><span class="p">.</span><span class="n">get</span> <span class="n">s</span>
  <span class="k">with</span> <span class="nc">End_of_stream</span> <span class="o">-&gt;</span> <span class="bp">()</span>
     <span class="o">|</span> <span class="k">val</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s'</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span><span class="o">;</span>
                      <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s'</span>
</code></pre></div>
<p>We don't need to look far to find other code that benefits from the new construct.  Here's a function from the <a href="https://github.com/ocaml/ocaml/blob/6a296a02/otherlibs/num/big_int.ml#L323-L328">Big_int</a> module in the standard library: </p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">int_of_big_int</span> <span class="n">bi</span> <span class="o">=</span>
  <span class="k">try</span> <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">int_of_nat</span> <span class="n">bi</span><span class="o">.</span><span class="n">abs_value</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">bi</span><span class="o">.</span><span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="o">-</span> <span class="n">n</span> <span class="k">else</span> <span class="n">n</span>
  <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="n">eq_big_int</span> <span class="n">bi</span> <span class="n">monster_big_int</span> <span class="k">then</span> <span class="n">monster_int</span>
    <span class="k">else</span> <span class="n">failwith</span> <span class="s2">&quot;int_of_big_int&quot;</span>
</code></pre></div>
<p>The core of the function --- the call to <code>int_of_nat</code> --- is rather buried in the complex control flow.  There are two <code>if</code>-<code>then</code>-<code>else</code> constructs, a <code>let</code> binding, and a <code>try</code> expression with a complex body.  Using handler case we can disentangle the code to make the four possible outcomes from the call to <code>int_of_nat</code> explicit:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="n">int_of_big_int</span> <span class="n">bi</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">int_of_nat</span> <span class="n">bi</span><span class="o">.</span><span class="n">abs_value</span> <span class="k">with</span>
  <span class="o">|</span> <span class="k">val</span> <span class="n">n</span> <span class="k">when</span> <span class="n">bi</span><span class="o">.</span><span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-&gt;</span>
     <span class="o">-</span><span class="n">n</span>
  <span class="o">|</span> <span class="k">val</span> <span class="n">n</span> <span class="o">-&gt;</span>
     <span class="n">n</span>
  <span class="o">|</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="k">when</span> <span class="n">eq_big_int</span> <span class="n">bi</span> <span class="n">monster_big_int</span> <span class="o">-&gt;</span>
     <span class="n">monster_int</span>
  <span class="o">|</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span>
     <span class="n">failwith</span> <span class="s2">&quot;int_of_big_int&quot;</span>
</code></pre></div>
<p>Here's a simpler example from <a href="https://github.com/ocaml/ocaml/blob/6a296a02/stdlib/string.ml#L195">the String module</a>, which also involves code that cannot raise an exception in the body of a <code>try</code> block:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">index_rec</span> <span class="n">s</span> <span class="n">l</span> <span class="n">i</span> <span class="n">c</span><span class="o">);</span> <span class="bp">true</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">false</span>
</code></pre></div>
<p>Using handler case we can separate the code that may raise an exception (the call to <code>index_rec</code>) from the expression that produces the result:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">try</span> <span class="n">index_rec</span> <span class="n">s</span> <span class="n">l</span> <span class="n">i</span> <span class="n">c</span> <span class="k">with</span> <span class="k">val</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">|</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">false</span>
</code></pre></div>
<h3>Trying it out</h3>

<p>Using <a href="http://opam.ocaml.org/">opam</a> you can install an OCaml compiler extended with handler case as follows:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ opam remote add ocamllabs git@github.com:ocamllabs/opam-repo-dev.git
ocamllabs Fetching git@github.com:ocamllabs/opam-repo-dev.git
[...]
$ opam switch 4.02.0dev+handler-syntax
# To complete the configuration of OPAM, you need to run:
eval `opam config env`
$ eval `opam config env`
</code></pre></div>
<h4>js<em>of</em>ocaml</h4>

<p>You can also try out the handler case construct in your browser, using the following modified version of <a href="http://www.ocamlpro.com/">OCamlPro</a>'s <a href="http://try.ocamlpro.com/">Try OCaml</a> application:</p>

<h3>The discoveries of success continuations</h3>

<p>As <a href="http://homepages.inf.ed.ac.uk/wadler">Philip Wadler</a> <a href="http://wadler.blogspot.co.uk/2008/02/great-minds-think-alike.html">notes</a>, constructs for handling success continuations have been independently discovered multiple times.  In fact, the history goes back even further than described in Wadler's blog; constructs like handler case date back over thirty years and have been introduced, apparently independently, into at least four languages.  Curiously, all the languages use <code>let</code>-binding for success continuations and <code>match</code> binding for failure continuations.</p>

<h4>Lisp</h4>

<p>In <a href="http://www.lispworks.com/documentation/HyperSpec/Front/">Common Lisp</a> the construct analogous to <code>try</code> is <a href="http://clhs.lisp.se/Body/m_hand_1.htm"><code>handler-case</code></a> (from which the construct discussed here borrows its name).  A <code>handler-case</code> expression has a body and a sequence of clauses which specify how various conditions (exceptions) should be handled.  The special condition specification <code>:no-error</code> specifies the code to run when no condition is signalled.  The <code>iter_stream</code> function might be written as follows in Common Lisp:</p>
<div class="highlight"><pre><code class="language-common-lisp" data-lang="common-lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">iter-stream</span> <span class="p">(</span><span class="nv">f</span> <span class="nv">s</span><span class="p">)</span>
   <span class="p">(</span><span class="nb">handler-case</span> <span class="p">(</span><span class="nv">get-stream</span> <span class="nv">s</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">end-of-stream</span> <span class="p">(</span><span class="nv">_</span><span class="p">)</span> <span class="no">nil</span><span class="p">)</span>
      <span class="p">(</span><span class="ss">:no-error</span> <span class="p">(</span><span class="nv">x</span> <span class="nv">|s'|</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">funcall</span> <span class="nv">f</span> <span class="nv">x</span><span class="p">)</span>
         <span class="p">(</span><span class="nv">iter-stream</span> <span class="nv">f</span> <span class="nv">|s'|</span><span class="p">))))</span>
</code></pre></div>
<p>The Common Lisp specification was completed in 1994 but the <code>handler-case</code> construct and its <code>:no-error</code> clause were present in some of Common Lisp's progenitors.  The construct was apparently introduced to Symbolics Lisp some time around 1982: it appears in the <a href="http://bitsavers.informatik.uni-stuttgart.de/pdf/mit/cadr/chinual_5thEd_Jan83/chinualJan83_27_Errors.pdf">5th edition</a> of the Lisp Machine manual (January 1983) but not the <a href="http://bitsavers.trailing-edge.com/pdf/mit/cadr/chinual_4thEd_Jul81.pdf">4th edition</a> from 18 months earlier (July 1981).</p>

<h4>Python</h4>

<p>Python has supported success continuations in exception handlers since May 1994, when the <code>else</code> clause was added to <code>try</code> blocks.  The <a href="http://hg.python.org/cpython/file/36214c861144/Grammar/Grammar#l9">Changelog in old versions of the Grammar/Grammar file</a> has an entry</p>

<blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text"># 3-May-94:
#Added else clause to try-except
</code></pre></div></blockquote>

<p>introduced in a <a href="http://hg.python.org/cpython/rev/6c0e11b94009">commit from August 1994</a>:</p>

<blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">changeset:   1744:6c0e11b94009
branch:      legacy-trunk
user:        Guido van Rossum &lt;guido@python.org&gt;
date:        Mon Aug 01 11:00:20 1994 +0000
summary:     Bring alpha100 revision back to mainline
</code></pre></div></blockquote>

<p>Unlike the <code>:no-error</code> clause in Lisp's <code>handler-case</code>, Python's <code>else</code> clause doesn't bind variables.  Since Python variables have function scope, not block scope, bindings in the body of the try block are visible throughout the function.  In Python we might write <code>iter_stream</code> as follows:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">iter_stream</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s_</span><span class="p">)</span> <span class="o">=</span> <span class="n">MyStream</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
   <span class="k">except</span> <span class="n">End_of_stream</span><span class="p">:</span>
      <span class="k">pass</span>
   <span class="k">else</span><span class="p">:</span>
      <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="n">iter_stream</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">s_</span><span class="p">)</span>
</code></pre></div>
<p>The provenance of the <code>else</code> clause is unclear, but it doesn't seem to derive from Lisp's <code>handler-case</code>.  The design of Python's exception handling constructs <a href="http://docs.python.org/3/faq/general.html#why-was-python-created-in-the-first-place">comes from Modula-3</a>, but the exception handling construct described in the <a href="http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-52.pdf">Modula-3 report</a> does not include a way of specifying the success continuation.  The syntax of the Modula-3 <code>TRY</code>/<code>EXCEPT</code> statement (found on p21 of the report) does include an <code>ELSE</code> clause:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">   TRY    
     Body
   EXCEPT
     id1 (v1) =&gt; Handler1
   | ...
   | idn (vn) =&gt; Handlern
   ELSE Handler0
   END
</code></pre></div>
<p>However, whereas Python's <code>else</code> handles the case where no exception is raised, Modula-3's <code>ELSE</code> handles the case where an exception not named in one of the <code>EXCEPT</code> clauses is raised: it is equivalent to Python's catch-all <code>except:</code>.</p>

<p>Python also adds success handlers to other constructs.  Both the <a href="http://docs.python.org/2/reference/compound_stmts.html#the-for-statement"><code>for</code></a> and the <a href="http://docs.python.org/2/reference/compound_stmts.html#the-while-statement"><code>while</code></a> statements have an optional <code>else</code> clause which is executed unless the loop terminates prematurely with an exception or <code>break</code>.</p>

<p><a name="exceptional-syntax"></a></p>

<h4>Exceptional Syntax</h4>

<p>The 2001 paper <a href="http://research.microsoft.com/~akenn/sml/exceptionalsyntax.pdf">Exceptional Syntax</a> (<a href="http://research.microsoft.com/~nick/">Benton</a> and <a href="http://research.microsoft.com/~akenn/">Kennedy</a>) proposed the following construct for handling exceptions in Standard ML:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">val</span> <span class="n">pattern_1</span> <span class="o">&lt;=</span> <span class="n">expr_1</span>
    <span class="o">...</span>
    <span class="k">val</span> <span class="n">pattern_n</span> <span class="o">&lt;=</span> <span class="n">expr_n</span>
 <span class="k">in</span>
    <span class="n">expr</span>
<span class="n">unless</span>
    <span class="n">pattern_1'</span> <span class="o">=&gt;</span> <span class="n">expr_1'</span>
  <span class="o">|</span> <span class="o">...</span>
  <span class="o">|</span> <span class="n">pattern_n'</span> <span class="o">=&gt;</span> <span class="n">expr_n'</span>
<span class="k">end</span>
</code></pre></div>
<p>Evaluation of the <code>let</code> binding proceeds as normal, except that if any of <code>expr_1</code> to <code>expr_n</code> raises an exception, control is transferred to the right hand side of the first of the clauses after <code>unless</code> whose left hand side matches the exception.  The construct is largely similar to our proposed variation, except that the bindings used in the success continuation are based on <code>let</code>, so scrutinising the values requires a separate <code>case</code> (i.e. <code>match</code>) expression.</p>

<p>Using the Exceptional Syntax construct we might write <code>iter_stream</code> as follows:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">fun</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s</span> <span class="o">=</span>
 <span class="k">let</span> <span class="k">val</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s'</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="nn">MyStream</span><span class="p">.</span><span class="n">get</span> <span class="n">s</span> <span class="k">in</span>
     <span class="n">f</span> <span class="n">x</span><span class="o">;</span>
     <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s'</span>
 <span class="n">unless</span> <span class="nc">End_of_stream</span> <span class="o">=&gt;</span> <span class="bp">()</span>
 <span class="k">end</span>
</code></pre></div>
<p>Exceptional Syntax has been implemented in the SML-to-Java compiler <a href="http://www.dcs.ed.ac.uk/home/mlj/">MLj</a>.</p>

<h4>Erlang</h4>

<p>The 2004 paper <a href="http://erlang.se/workshop/2004/exception.pdf">Erlang's Exception Handling Revisited</a> (Richard Carlsson, Bj&ouml;rn Gustavsson and Patrik Nyblom) proposed an exception-handling construct for Erlang along the same lines as exceptional syntax, although apparently developed independently.  In the proposed extension to Erlang we might write <code>iter_stream</code> as follows:</p>
<div class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="nf">iter_stream</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">S</span><span class="p">)</span> <span class="o">-&gt;</span>
   <span class="k">try</span> <span class="nv">Mystream</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">S</span><span class="p">)</span> <span class="k">of</span>
      <span class="p">{</span><span class="nv">X</span><span class="p">,</span> <span class="nv">S_</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="p">_</span> <span class="o">=</span> <span class="nv">F</span><span class="p">(</span><span class="nv">X</span><span class="p">),</span>
        <span class="n">iter_stream</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span> <span class="nv">S_</span><span class="p">)</span>
   <span class="n">with</span>
    <span class="nv">End_of_stream</span> <span class="o">-&gt;</span> <span class="p">{}</span>
</code></pre></div>
<h4>Eff</h4>

<p><a href="http://homepages.inf.ed.ac.uk/gdp/">Plotkin</a> and <a href="http://matija.pretnar.info/">Pretnar</a>'s work on <a href="http://matija.pretnar.info/pdf/handling-algebraic-effects.pdf">handlers for algebraic effects</a> generalises Exceptional Syntax to support effects other than exceptions.  The programming language <a href="http://math.andrej.com/eff/">eff</a> implements a design based on this work, and supports Exceptional Syntax, again with <code>let</code> binding for the success continuation.  (Although the success continuation is incorporated into the exception matching construct, only a single success continuation pattern is allowed.)  In eff we might write <code>iter_stream</code> as follows:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s</span> <span class="o">=</span>
  <span class="n">handle</span> <span class="n">my_stream_get</span> <span class="n">s</span>
  <span class="k">with</span> <span class="n">exn</span><span class="o">#</span><span class="n">end_of_stream</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
     <span class="o">|</span> <span class="k">val</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s'</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span><span class="o">;</span>
                      <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s'</span>
</code></pre></div>
<p>The second argument in the <code>end_of_stream</code> clauses binds the continuation of the effect, allowing handling strategies other than the usual stack unwinding.  Since we ignore the continuation argument the behaviour is the same as for a regular exception handler.</p>

<p>The <a href="https://github.com/matijapretnar/eff/blob/2a9a36cc/src/parser.mly#L4-L7">eff implementation</a> uses the term &quot;handler case&quot; for the clauses of the <code>handle</code> construct.</p>

<h4>OCaml</h4>

<p>Several OCaml programmers have proposed or implemented constructs related to handler case.</p>

<p><a name="delimcc"></a>
Oleg's <a href="http://okmij.org/ftp/continuations/implementations.html">delimcc</a> library for delimited continuations provides the operations needed to support the success continuation style.  The programmer can use <code>push_prompt</code> to establish a context, then call <code>shift</code> or <code>shift0</code> to return control to that context later, much as <code>try</code> establishes a context to which <code>raise</code> can transfer control.  If <code>shift</code> is not called then control returns normally from the continuation argument to <code>push_prompt</code>.  Using delimcc we might implement <code>iter_stream</code> as follows:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="n">new_prompt</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">push_prompt</span> <span class="n">p</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">Val</span> <span class="o">(</span><span class="n">my_stream_get</span> <span class="n">s</span> <span class="n">p</span><span class="o">))</span> <span class="k">with</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">Val</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s'</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span><span class="o">;</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s'</span>
  <span class="o">|</span> <span class="o">`</span><span class="nc">End_of_stream</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</code></pre></div>
<p><a href="http://mjambon.com/">Martin Jambon</a> has <a href="http://mjambon.com/mikmatch-manual.html#htoc16">implemented</a> a construct equivalent to Exceptional Syntax for OCaml as part of the <a href="http://mjambon.com/micmatch.html">micmatch extension</a>.  His implementation allows us to write <code>iter_stream</code> in much the same way as Benton and Kennedy's proposal:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">try</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s'</span><span class="o">)</span> <span class="o">=</span> <span class="n">my_stream_get</span> <span class="n">s</span>
   <span class="k">in</span> <span class="n">f</span> <span class="n">x</span><span class="o">;</span>
      <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s'</span>
  <span class="k">with</span> <span class="nc">End_of_stream</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</code></pre></div>
<p>The details of the implementation are discussed in <a href="https://twitter.com/jakedonham">Jake Donham</a>'s <a href="http://ambassadortothecomputers.blogspot.co.uk/2010/09/reading-camlp4-part-11-syntax.html">articles on Camlp4</a>.  The micmatch implementation has a novel feature: the <code>let</code> binding associated with the success continuation may be made recursive.</p>

<p><a href="http://alain.frisch.fr/">Alain Frisch</a> has proposed and implemented a more powerful extension to OCaml, <a href="http://www.lexifi.com/blog/static-exceptions">Static Exceptions</a>, which allow transfer of control to lexically-visible handlers (along the lines of Common Lisp's <a href="http://clhs.lisp.se/Body/s_block.htm#block"><code>block</code></a> and <a href="http://clhs.lisp.se/Body/s_ret_fr.htm#return-from"><code>return-from</code></a>).  Static exceptions are based on an equivalent feature in OCaml's intermediate language.</p>

<p>There is a straightforward translation from OCaml extended with handler case into OCaml extended with static exceptions by wrapping the body of each <code>try</code> expression in <code>raise (`Val (...))</code>, and changing the <code>val</code> keyword in the binding section to <code>`Val</code>.  For example, <code>iter_stream</code> can be written using static exceptions as follows:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="k">raise</span> <span class="o">(`</span><span class="nc">Val</span> <span class="o">(</span><span class="nn">MyStream</span><span class="p">.</span><span class="n">get</span> <span class="n">s</span><span class="o">))</span>
  <span class="k">with</span> <span class="nc">End_of_stream</span> <span class="o">-&gt;</span> <span class="bp">()</span>
     <span class="o">|</span> <span class="o">`</span><span class="nc">Val</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s'</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span><span class="o">;</span>
                       <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s'</span>
</code></pre></div>
<p>Of course, static exceptions allow many other programs to be expressed that are not readily expressible using handler case.</p>

<p><a name="catch-me"></a>
In their 2008 paper <a href="http://www.univ-orleans.fr/lifo/Members/David.Teller/publications/ml2008.pdf">Catch me if you can: Towards type-safe, hierarchical, lightweight, polymorphic and efficient error management in OCaml</a> David Teller Arnaud Spiwack and Till Varoquaux added an <code>attempt</code> keyword to OCaml that extends <code>match</code>-style pattern matching with both a single optional value case and an optional <code>finally</code> clause.</p>

<p>Finally, I discovered while writing this article that Christophe Raffalli proposed the handler case design fifteen years ago in a <a href="http://caml.inria.fr/pub/ml-archives/caml-list/1999/12/a6d3ce9671b16a33530035c2b42df011.en.html">message to caml-list</a>!  Christophe's proposal wasn't picked up back then, but perhaps the time has now come to give OCaml programmers a way to handle success.</p>

<p><a name="match-exception"></a></p>

<h3>Postscript: a symmetric extension</h3>

<p>The <code>try</code> construct in current OCaml supports matching against raised exceptions but not against the value produced when no exception is raised.  Contrariwise, the <code>match</code> construct supports matching against the value produced when no exception is raised, but does not support matching against raised exceptions.  As implemented, the patch addresses this asymmetry, extending <code>match</code> with clauses that specify the &quot;failure continuation&quot;:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">match</span> <span class="n">expr</span>
<span class="k">with</span> <span class="n">pattern_1</span> <span class="o">-&gt;</span> <span class="n">expr_1</span>
   <span class="o">|</span> <span class="o">...</span>
   <span class="o">|</span> <span class="n">pattern_n</span> <span class="o">-&gt;</span> <span class="n">expr_n</span>
   <span class="o">|</span> <span class="k">exception</span> <span class="n">pattern_1'</span> <span class="o">-&gt;</span> <span class="n">expr_1'</span>
   <span class="o">|</span> <span class="o">...</span>
   <span class="o">|</span> <span class="k">exception</span> <span class="n">pattern_n'</span> <span class="o">-&gt;</span> <span class="n">expr_n'</span>
</code></pre></div>
<p>With this additional extension the choice between <code>match</code> and <code>try</code> becomes purely stylistic.  We might optimise for succinctness, and use <code>try</code> in the case where exceptions are expected (for example, where they're used for control flow), reserving <code>match</code> for the case where exceptions are truly exceptional.</p>

<p>For the sake of completeness, here's <code>iter_stream</code> written with the extended <code>match</code> construct:</p>
<div class="highlight"><pre><code class="language-ocaml" data-lang="ocaml"><span class="k">let</span> <span class="k">rec</span> <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">MyStream</span><span class="p">.</span><span class="n">get</span> <span class="n">s</span> <span class="k">with</span>
     <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s'</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span><span class="o">;</span>
                <span class="n">iter_stream</span> <span class="n">f</span> <span class="n">s'</span>
   <span class="o">|</span> <span class="k">exception</span> <span class="nc">End_of_stream</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</code></pre></div>
<p>Since both <code>val</code> and <code>exception</code> are existing keywords, the extensions to both <code>try</code> and <code>match</code> are fully backwards compatible. </p>
<a onclick="switchContent('ocamlorg-post72','ocamlorg-post71')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2014/02/04/handler-case">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://ocamllabs.github.com/compiler-hacking/2014/02/04/handler-case">by Compiler Hacking at Feb 04, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/">
    <a name="#http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/">OCaml: the bugs so far</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post73"><p>OCaml&rsquo;s static typing allows it to detect many problems at compile-time. Still, some bugs slip though. In this post, I go over each discovered bug that made it into a Git commit and try to work out why it happened and whether it could have been prevented.</p>



<p>Note: As this post is entirely about bugs, it may appear rather negative. So let me say first that, overall, I&rsquo;ve been very impressed with the reliability of the OCaml code: I&rsquo;d have expected to find more bugs than this in 27,806 lines of new code!</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#methodology">Methodology</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#core-ocaml-issues">Core OCaml issues</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#out-of-range-integers">Out-of-range integers</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#fails-to-start-on-windows">Fails to start on Windows</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#spawning-a-daemon-fails-on-windows">Spawning a daemon fails on Windows</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#install-select-ignores---refresh">0install select ignores <code>--refresh</code></a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#not-found-errors">Not found errors</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#octal-value">Octal value</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#parsing-a-path-as-a-url">Parsing a path as a URL</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#interrupted-waitpid">Interrupted waitpid</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#http-redirects-with-data-cause-corrupted-downloads">HTTP redirects with data cause corrupted downloads</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#setting-wrong-mtime">Setting wrong mtime</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#strict-sequences">Strict sequences</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#lwt-related-bugs">Lwt-related bugs</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#lwt-process-fails-with-empty-string">Lwt process fails with empty string</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#epipe-on-windows">EPIP&hellip;</a></li></ul></li></ul><a onclick="switchContent('ocamlorg-post73','ocamlorg-post74')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/">Read more...</a></div><div id="ocamlorg-post74" style="display: none"><p>OCaml&rsquo;s static typing allows it to detect many problems at compile-time. Still, some bugs slip though. In this post, I go over each discovered bug that made it into a Git commit and try to work out why it happened and whether it could have been prevented.</p>



<p>Note: As this post is entirely about bugs, it may appear rather negative. So let me say first that, overall, I&rsquo;ve been very impressed with the reliability of the OCaml code: I&rsquo;d have expected to find more bugs than this in 27,806 lines of new code!</p>

<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#methodology">Methodology</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#core-ocaml-issues">Core OCaml issues</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#out-of-range-integers">Out-of-range integers</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#fails-to-start-on-windows">Fails to start on Windows</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#spawning-a-daemon-fails-on-windows">Spawning a daemon fails on Windows</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#install-select-ignores---refresh">0install select ignores <code>--refresh</code></a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#not-found-errors">Not found errors</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#octal-value">Octal value</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#parsing-a-path-as-a-url">Parsing a path as a URL</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#interrupted-waitpid">Interrupted waitpid</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#http-redirects-with-data-cause-corrupted-downloads">HTTP redirects with data cause corrupted downloads</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#setting-wrong-mtime">Setting wrong mtime</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#strict-sequences">Strict sequences</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#lwt-related-bugs">Lwt-related bugs</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#lwt-process-fails-with-empty-string">Lwt process fails with empty string</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#epipe-on-windows">EPIPE on Windows</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#deleting-temporary-files">Deleting temporary files</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#race-shutting-down-test-http-server">Race shutting down test HTTP server</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#reactive-event-handler-gets-garbage-collected">Reactive event handler gets garbage collected</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#stuck-reading-output-from-subprocess">Stuck reading output from subprocess</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#downloads-never-complete">Downloads never complete</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#event-loop-doesnt-work-on-os-x">Event loop doesn&rsquo;t work on OS X</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#curl-related-bugs">Curl-related bugs</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#failing-to-reset-curl-connections">Failing to reset Curl connections</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#error-with-cancelled-downloads">Error with cancelled downloads</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#gtk-bugs">GTK bugs</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#sorted-treeview-iter-mix-up">Sorted treeview iter mix-up</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#crashes-with-gtkiconview">Crashes with GtkIconView</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#logic-errors">Logic errors</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#python-bugs">Python bugs</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#summary">Summary</a></li>
</ul>

<p>( This post is part of a series in which I am
<a href="http://roscidus.com/blog/blog/2013/06/09/choosing-a-python-replacement-for-0install">converting 0install from Python to OCaml</a>, learning OCaml as I go. The code is at <a href="https://github.com/0install/0install">GitHub/0install</a>. )</p>

<h2>Methodology</h2>

<p>I&rsquo;ve gone back through the Git commit log and selected all the ones that say they fix a bug in the comment, starting from when I merged the initial OCaml code to master (on 2013-07-03). It&rsquo;s possible that I sneakily fixed some bugs while making other changes, but this should cover most of them. Any bug that made it into a released version of 0install should certainly have its own commit because it would have to go on the release branch. I also included a few &ldquo;near misses&rdquo; (bugs I spotted before committing, but which I could plausibly have missed).</p>

<p>In a number of cases, I wrote and committed the new OCaml code first, and then ported the Python unit-tests in a later commit and discovered the bug that way (so some of these could never have made it into an actual release). Compile-time bugs have been ignored (e.g. code that didn&rsquo;t compile on older versions of OCaml); I&rsquo;m only interested in run-time errors here.</p>

<p>I&rsquo;ve classified each bug as follows:</p>

<dl>
  <dt>Inexperience</dt>
  <dd>This bug was caused by my inexperience with OCaml. Making proper use of OCaml&rsquo;s features would avoid this class of bug entirely.</dd>
  <dt>Third-party</dt>
  <dd>Caused by a bug in a library I was using (and hopefully now fixed). Could only have been discovered by testing.</dd>
  <dt>Poor API</dt>
  <dd>This bug was my fault, but could have been avoided if the library had a better API.</dd>
  <dt>Warning needed</dt>
  <dd>My fault, but the compiler could have detected the problem and issued a warning.</dd>
  <dt>Testing only</dt>
  <dd>I only know how to find such bugs through testing. Similar bugs could happen again.</dd>
</dl>

<h2>Core OCaml issues</h2>

<p>Note: I&rsquo;m grouping the bugs by the library the code was interacting with, regardless of whether that library was at fault. This section is for bugs that occurred when just using OCaml itself and its standard library.</p>

<h3>Out-of-range integers</h3>

<p>Everything seemed to be working nicely on my Arch system, but the first run on a Debian VM gave this unhelpful error:</p>

<pre><code>Failure &quot;int_of_string&quot;
</code></pre>

<p>I was trying to store a Unix timestamp in an <code>int</code>. Unlike Python, OCaml&rsquo;s integers are limited precision, having 1 bit less than the machine word size. The 32-bit VM only had 31-bit integers and the time value was out of range for it.</p>

<p>This was entirely my fault. OCaml always uses floats to represent times, and they work fine. I was just converting to ints to be consistent with the Python code.</p>

<p>However, the error message is very poor. I replaced all calls to <code>int_of_string</code> with my own version, which at least displays the number it was trying to convert. This should make debugging any similar problems easier in future.</p>

<p>Type: Inexperience</p>

<h3>Fails to start on Windows</h3>

<p>Windows kept complaining that my program didn&rsquo;t exist and to check that the path was correct, even when I was double-clicking on the executable in Explorer!
Turns out, Windows refuses to run binaries with certain character sequences in their names (&ldquo;instal&rdquo; being one such sequence). See <a href="http://social.msdn.microsoft.com/forums/en-US/windowssecurity/thread/73f86e9e-928f-40b7-8dd5-27e40db6997e/">Vista doesn&rsquo;t start application called &ldquo;install&rdquo; w/o being elevated</a>.</p>

<p>Solution: you have to embed an XML &ldquo;manifest&rdquo; in Windows binaries to avoid this behaviour. Would be nice if OCaml did that automatically for you.</p>

<p>Type: Third-party</p>

<h3>Spawning a daemon fails on Windows</h3>

<p>Windows doesn&rsquo;t have <code>fork</code>, so the usual double-fork trick doesn&rsquo;t work.
Solution: Use <code>create_process</code> on Windows.</p>

<p>Would be nice if OCaml grouped all the POSIX-only functions together and made you check which platform you were on. Then you&rsquo;d know when you were using platform-specific functions. e.g.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">match</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">platform_specific_ops</span> <span class="k">with</span>
</span><span class="line"><span class="o">|</span> <span class="nc">POSIX</span> <span class="n">ops</span> <span class="o">-&gt;</span> <span class="n">ops</span><span class="o">#</span><span class="n">fork</span> <span class="o">...</span>
</span><span class="line"><span class="o">|</span> <span class="nc">Windows</span> <span class="n">ops</span> <span class="o">-&gt;</span> <span class="n">ops</span><span class="o">#</span><span class="n">spawn</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Type: Poor API</p>

<h3>0install select ignores <code>--refresh</code></h3>

<p>I forget to handle the <code>Refresh</code> case for the &ldquo;select&rdquo; command.
Different commands need to handle different subsets of the options. I was using a plain variant (enum) type and throwing an exception if I got an option I wasn&rsquo;t expecting:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="nn">Support</span><span class="p">.</span><span class="nn">Argparse</span><span class="p">.</span><span class="n">iter_options</span> <span class="n">extra_options</span> <span class="o">(</span><span class="k">function</span>
</span><span class="line">  <span class="o">|</span> <span class="nc">ShowXML</span> <span class="o">-&gt;</span> <span class="n">select_opts</span><span class="o">.</span><span class="n">xml</span> <span class="o">&lt;-</span> <span class="bp">true</span>
</span><span class="line">  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">raise_safe</span> <span class="s2">&quot;Unknown option&quot;</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>(Note: Several people have asked why I used a default match case here. It&rsquo;s needed because there are many options that don&rsquo;t apply to the &ldquo;select&rdquo; command. The option parser makes sure that each sub-command&rsquo;s handler function is only called with options it claims to support.)</p>

<p>Solution: I switched from plain variants to polymorphic variants and removed the default case. Now, the type-checker verifies at compile-time that each subcommand handles all its options:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="nn">Support</span><span class="p">.</span><span class="nn">Argparse</span><span class="p">.</span><span class="n">iter_options</span> <span class="n">extra_options</span> <span class="o">(</span><span class="k">function</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="nc">ShowXML</span> <span class="o">-&gt;</span> <span class="n">select_opts</span><span class="o">.</span><span class="n">xml</span> <span class="o">&lt;-</span> <span class="bp">true</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="nc">Refresh</span> <span class="o">-&gt;</span> <span class="n">select_opts</span><span class="o">.</span><span class="n">refresh</span> <span class="o">&lt;-</span> <span class="bp">true</span>
</span><span class="line"><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>See <a href="http://roscidus.com/blog/blog/2013/08/31/option-handling-with-ocaml-polymorphic-variants/">Option Handling With OCaml Polymorphic Variants</a> for a write-up of that.</p>

<p>Type: Inexperience</p>

<h3>Not found errors</h3>

<p>When printing diagnostics about a failed solve, we check each interface to see if it has a replacement that it conflicts with. e.g. the new &ldquo;Java&rdquo; interface replaces (and conflicts with) the old &ldquo;Java 6&rdquo; interface. But if the conflicting interface wasn&rsquo;t used in the solve, we&rsquo;d crash with:</p>

<pre><code>Exception: Not_found
</code></pre>

<p>I use a lot of maps with strings as the keys. I therefore created a <code>StringMap</code> module in my <code>common.ml</code> file like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">StringMap</span> <span class="o">=</span> <span class="nn">Map</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>StringMap.find</code> raises <code>Not_found</code> if the key isn&rsquo;t found, which is never what you want. These exceptions are awkward to deal with and it&rsquo;s easy to forget to handle them.</p>

<p>A nice solution is to replace the definition with:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">module</span> <span class="nc">StringMap</span> <span class="o">=</span> <span class="k">struct</span>
</span><span class="line">  <span class="k">include</span> <span class="nn">Map</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">  <span class="k">let</span> <span class="n">find</span> <span class="n">key</span> <span class="n">map</span> <span class="o">=</span>
</span><span class="line">    <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">find</span> <span class="n">key</span> <span class="n">map</span><span class="o">)</span>
</span><span class="line">    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nc">None</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This redefines the <code>find</code> method to return an option type. Now you can&rsquo;t do a <code>StringMap.find</code> without the compiler forcing you to consider the case of the key not being there.</p>

<p>Would be nice if the OCaml standard library did this. Perhaps providing a <code>Map.get</code> function with the new behaviour and deprecating <code>Map.find</code>?</p>

<p>Type: Poor API</p>

<h3>Octal value</h3>

<p>I used <code>0700</code> instead of <code>0o700</code> to set a file mode. Would be nice if OCaml warned about decimals that start with 0, as Python 3 does.</p>

<p>Type: Warning needed</p>

<h3>Parsing a path as a URL</h3>

<p>This didn&rsquo;t actually get committed, but it&rsquo;s interesting anyway. Downloaded feeds are signed with GPG keys, which are trusted only for their particular domains. At one point, I used <code>Trust.domain_from_url feed.url</code> to get the domain. It was defined as:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">domain_from_url</span> <span class="n">url</span> <span class="o">=</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>However, feeds come in different types: there are remote feeds with URLs, and local feeds with local paths (there are also virtual &ldquo;distribution&rdquo; feeds representing the output from the distribution&rsquo;s package manager).</p>

<p>I was trying to get the trust domain for all feeds, not just remote ones where it makes sense.</p>

<p>Once again, the solution was to use polymorphic variants. The three different types of feed get three different constructors. A method (such as <code>domain_from_url</code>) that only works on remote feeds is declared as:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">domain_from_url</span> <span class="o">(`</span><span class="n">remote_feed</span> <span class="n">url</span><span class="o">)</span> <span class="o">=</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then, it&rsquo;s impossible to call it without first ensuring you&rsquo;ve got a remote feed URL.</p>

<p>This change also improves the type-safety of many other parts of the code (e.g. you can&rsquo;t try to download a local feed now either), and uncovered another bug: you couldn&rsquo;t use the GUI to set the stability rating for a distribution-provided implementation, because one of the functions used only worked for non-distribution feeds.</p>

<p>Type: Inexperience (x2)</p>

<h3>Interrupted waitpid</h3>

<p>The <code>Unix.waitpid</code> function can raise <code>EINTR</code> if the system call is interrupted, although the documentation doesn&rsquo;t mention this. It would be nice if OCaml would automatically restart the call in this case (as Python&rsquo;s <code>subprocess</code> module does).</p>

<p>Type: Poor API</p>

<h3>HTTP redirects with data cause corrupted downloads</h3>

<p>We download to a temporary file. If we get an HTTP redirect, we truncate the file and try the new address. However, <code>ftruncate</code> doesn&rsquo;t reset the position in the file. So, if the redirecting site sent any data in its reply, you&rsquo;d get that many zeroes at the start of the download. As with <code>waitpid</code>, OCaml&rsquo;s behaviour is standard POSIX, but not mentioned in the OCaml documentation.</p>

<p>Solution: <code>seek_out ch 0</code>.</p>

<p>Also, I updated the test server used in the unit-tests to send back some data when doing a redirect.</p>

<p>Type: Testing only</p>

<h3>Setting wrong mtime</h3>

<p><code>Unix.utimes</code> is supposed to set the mtime and atime of a file to the given values. However, the behaviour is a little odd:</p>

<ul>
  <li>When 1 &lt;= time &lt; infinity, it sets it to the requested time.</li>
  <li>When 0 &lt;= time &lt; 1 however, it sets it to the current time instead.</li>
</ul>

<p>That&rsquo;s a problem for us, because we often use &ldquo;0&rdquo; as the time for files which don&rsquo;t have a timestamp, and the time is part of the secure hashes we calculate.</p>

<p>Solution: I wrote a C function to allow setting the time to whatever value you like.</p>

<p>This bug didn&rsquo;t make it into a commit because I hit it while writing a test script (I was trying to reset a timestamp file to time zero), and the unit-tests would have caught it if not, but it&rsquo;s still a poor API. Not only does it fail to use a variant type to handle different cases, but it chooses a magic value that&rsquo;s a valid input!</p>

<p>Or, rather than using a variant type for these two cases, it could just drop the magic current time feature completely - it&rsquo;s easy enough to read the current time and pass it explicitly if you need it. That would make the code clearer too.</p>

<p>(note: the documentation does say &ldquo;A time of 0.0 is interpreted as the current time&rdquo;, but it&rsquo;s easy to forget this if it wasn&rsquo;t relevant the first time you read the docs)</p>

<p>Type: Poor API</p>

<h3>Strict sequences</h3>

<p>This didn&rsquo;t make it into a commit, but it&rsquo;s interesting anyway. Simplified version of the problem:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">trace</span> <span class="n">fn</span> <span class="o">=</span>
</span><span class="line">  <span class="n">print_endline</span> <span class="s2">&quot;START&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="n">fn</span> <span class="bp">()</span><span class="o">;</span>
</span><span class="line">  <span class="n">print_endline</span> <span class="s2">&quot;END&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="n">trace</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Hello %s!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This prints:</p>

<pre><code>START
END
</code></pre>

<p>Why is there no warning? You might expect OCaml would infer the type of <code>fn</code> as <code>unit -&gt; unit</code> and then complain that the function we pass has the wrong type (<code>unit -&gt; string -&gt; unit</code>).</p>

<p>In fact, although OCaml warns if you ignore the result of a function that doesn&rsquo;t return unit, it&rsquo;s not actually an error. So it actually infers the type of <code>fn</code> as (<code>unit -&gt; 'a</code>), and it compiles fine.</p>

<p>Solution: always compile with <code>-strict-sequence</code> (or put <code>true: strict_sequence</code> in your <code>_tags</code> file)</p>

<p>Type: Inexperience</p>

<h2>Lwt-related bugs</h2>

<h3>Lwt process fails with empty string</h3>

<p>When spawning a process, the Lwt docs say you can pass an empty string as the binary to run and it will search for the first argument in <code>$PATH</code> for you. However, that behaviour was added only in Lwt 2.4 and using the older version in Debian it failed at runtime with a confusing error.</p>

<p>Probably I should have been reading the old version of the docs (which the web-site helpfully lets you do).</p>

<p>I&rsquo;m classifying this as a poor API because it was caused by using <code>&quot;&quot;</code> as a magic value, rather than defining a new constructor function.</p>

<p>Type: Poor API</p>

<h3>EPIPE on Windows</h3>

<p>On Windows, we couldn&rsquo;t read the output of GnuPG. This was due to a bug in Lwt, which they quickly fixed:</p>

<p><a href="https://github.com/ocsigen/lwt/issues/20">Lwt_io.read fails on Windows with EPIPE</a></p>

<p>Type: Third-party</p>

<h3>Deleting temporary files</h3>

<p>We download various files to a temporary directory. In some cases, they weren&rsquo;t being deleted afterwards.</p>

<p>Solution: the downloader now takes a mandatory Lwt switch and deletes the file when the switch is turned off. Callers just have to wrap the download call in a <code>try ... finally</code> block, like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">switch</span> <span class="o">=</span> <span class="nn">Lwt_switch</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line"><span class="k">try_lwt</span>
</span><span class="line">  <span class="k">match_lwt</span> <span class="n">downloader</span><span class="o">#</span><span class="n">download</span> <span class="o">~</span><span class="n">switch</span> <span class="n">key_url</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">network_failure</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">raise_safe</span> <span class="s2">&quot;%s&quot;</span> <span class="n">msg</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">aborted_by_user</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Aborted</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">tmpfile</span> <span class="n">tmpfile</span> <span class="o">-&gt;</span> <span class="nn">U</span><span class="p">.</span><span class="n">read_file</span> <span class="n">system</span> <span class="n">tmpfile</span> <span class="o">|&gt;</span> <span class="nn">G</span><span class="p">.</span><span class="n">import_key</span> <span class="n">system</span>
</span><span class="line"><span class="k">finally</span>
</span><span class="line">  <span class="nn">Lwt_switch</span><span class="p">.</span><span class="n">turn_off</span> <span class="n">switch</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To make this completely foolproof, you&rsquo;d need something like the linear types from Rust or ATS, but this is good enough for me.</p>

<p>Type: Inexperience</p>

<h3>Race shutting down test HTTP server</h3>

<p>Some of the unit tests run a simple HTTP server. When the test is over, they use <code>Lwt.cancel</code> to kill it. However, it appears that this call is unreliable: depending on exactly what the server is doing at the time it might just ignore it and continue.</p>

<p>Solution: we both cancel the task <em>and</em> set a boolean flag, which we test just before calling <code>accept</code>. If we&rsquo;re in <code>accept</code> at the time of the cancel, the thread will abort correctly. If it&rsquo;s anywhere else, it may continue handling the current request, but will quit as soon as it finishes and checks the flag.</p>

<p>Would perhaps be nice if Lwt remembered that an attempt was made to cancel the thread during a non-cancellable operation, and killed it at the next opportunity.</p>

<p>Type: Poor API</p>

<p>A related race occurred if we spawned a child process while handling an HTTP request, because the child would inherit the client socket and it would never get closed.</p>

<p>Solution: Use <code>Lwt_unix.set_close_on_exec connection</code> as soon as the connection is accepted.</p>

<p>Note that both these hacks should be race-free, because Lwt is cooperatively multi-threaded (e.g. we can&rsquo;t spawn a subprocess between accepting a connection and marking it <code>close_on_exec</code>). I think.</p>

<p>Ideally, when spawning a child process you&rsquo;d specify the file descriptors you wanted it to inherit explicitly (Go does this, but really it needs to be at the POSIX level).</p>

<p>Type: Testing only</p>

<p>(although these bugs only occurred in the unit-tests, I&rsquo;m including them because they could just as easily appear in the main code)</p>

<h3>Reactive event handler gets garbage collected</h3>

<p>The OCaml D-BUS bindings use <a href="http://erratique.ch/software/react/doc/React">functional reactive programming</a> to report property values.
The idea is that you get an object representing the continuously-varying value of the property, rather than a particular sample of it.
Then you can handle the signal as a whole (for example, you can get the &ldquo;progress&rdquo; signal from a PackageKit transaction and pass it to a GUI progress monitor widget, so that the widget always shows the current progress).
You can build up chains of signal processors. For example, you might transform a &ldquo;bytes downloaded&rdquo; signal into a &ldquo;percentage complete&rdquo; one.</p>

<p>The technique seems to come from Haskell. Being purely functional, it&rsquo;s always safe to garbage collect a signal if no-one is holding a reference to it.</p>

<p>However, OCaml is not purely functional. You might easily want to evaluate a signal handler for its side-effects.
I created a handler to monitor the transaction status signal to see when it was finished, and attached the resulting signal to a <code>Lwt_switch</code>.
My plan was that the switch would keep it alive until it fired.
That didn&rsquo;t work, because there was a subtle circular reference in the whole scheme, and OCaml would sometimes garbage-collect the handler and the switch. Then the process would ignore the finished event and appear to hang. I asked on StackOverflow and got some suggestions:</p>

<ul>
  <li><a href="http://stackoverflow.com/questions/19975140/how-to-stop-ocaml-garbage-collecting-my-reactive-event-handler">How to stop OCaml garbage collecting my reactive event handler?</a></li>
</ul>

<p>The solution seems to be to keep references to all active signals in a global variable. Rather messy.</p>

<p>Type: Testing only</p>

<h3>Stuck reading output from subprocess</h3>

<p>When using the <code>Lwt_glib</code> module to integrate with the GTK mainloop, the <code>HUP</code> response from <code>poll</code> is ignored. This means that it will call <code>poll</code> endlessly in a tight loop.
<a href="https://github.com/ocsigen/lwt/commit/a9a7a5b7a3a7093b78e5ec4f5119f1f44d1f3527">Patch</a></p>

<p>Type: Third-party</p>

<h3>Downloads never complete</h3>

<p>When using <code>Lwt_glib</code>, downloads may never complete. This is because OCaml, like Python, has a global lock and <code>Lwt_glib</code> fails to release it when calling <code>poll</code>. Therefore, no other thread (such as the download thread) can make progress while the main thread is waiting (e.g. for the download thread to finish).
<a href="https://github.com/ocsigen/lwt/commit/a9a7a5b7a3a7093b78e5ec4f5119f1f44d1f3527">Patch</a></p>

<p>Type: Third-party</p>

<h3>Event loop doesn&rsquo;t work on OS X</h3>

<p><code>Lwt_glib</code> passes <code>-1000</code> to <code>poll</code> to mean &ldquo;no timeout&rdquo;. This works on Linux, but not on BSD-type systems.
<a href="https://github.com/ocsigen/lwt/commit/062bea739187dbd3b36e8587a35fce35b2ba4073">Patch</a></p>

<p>Type: Third-party</p>

<h2>Curl-related bugs</h2>

<h3>Failing to reset Curl connections</h3>

<p>For efficiency, Curl encourages the reuse of connections. However, I forgot to reset some parameters (max file size and expected modification time). If the next call didn&rsquo;t use them, it would reuse the old values and possibly fail.</p>

<p>Newer versions of ocurl have a <code>reset</code> function, which avoids these problems.</p>

<p>Type: Poor API</p>

<h3>Error with cancelled downloads</h3>

<p>Downloads were sometimes failing with this confusing error:</p>

<pre><code>easy handled already used in multi handle
</code></pre>

<p>It happened when reusing connections (which Curl encourages, for efficiency).
There was no direct way to cancel a download, so I handled cancellation by closing the channel the download was writing to.
Then, next time some data arrived, my write callback would fail to write the new data and throw an exception, aborting the download.
It turned out that this was leaving the connection in an invalid state.</p>

<p>Solution: return 0 from the handler instead of throwing an exception.</p>

<p>Ideally, ocurl should catch exceptions from callbacks and allow the C code to clean up properly. <a href="https://forge.ocamlcore.org/plugins/scmgit/cgi-bin/gitweb.cgi?p=ocurl/ocurl.git%3Ba=commitdiff%3Bh=813e4254cab1c5f1cc806f9aa537c6deff61466f">Now fixed</a>.</p>

<p>Type: Third-party</p>

<h2>GTK bugs</h2>

<h3>Sorted treeview iter mix-up</h3>

<p>(I caught this before committing it, but it&rsquo;s a nasty bug that could easily be missed. It was present for a while in the original Python version.)</p>

<p>The cache explorer dialog allows you to delete implementations from the cache by selecting an item and pressing the Delete button.
It also allows you to sort the table by clicking on the column headings.
However, if you sort the table and then delete something, it deletes the wrong thing!</p>

<p>To make a sortable table (which is just a special case of a tree to GTK), you first create an underlying (unsorted) list model, then wrap it with a sorted model, then pass that to the display widget (GtkTreeView), like so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">list_store</span> <span class="n">cols</span>
</span><span class="line"><span class="k">let</span> <span class="n">sorted_model</span> <span class="o">=</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">model_sort</span> <span class="n">model</span>
</span><span class="line"><span class="k">let</span> <span class="n">view</span> <span class="o">=</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">view</span> <span class="o">~</span><span class="n">model</span><span class="o">:</span><span class="n">sorted_model</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To do things with the model, you pass it a GtkTreeIter, which says which item you want to act on, e.g.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="n">model</span><span class="o">#</span><span class="n">remove</span> <span class="n">iter</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The trouble is, sorted and unsorted GtkTreeIters both have the same type, so you can easily pass an iterator of the sorted model as an argument to the unsorted model.
Then it will act on the wrong item.
If the view isn&rsquo;t sorted then everything works fine, so you might not notice the problem while testing.</p>

<p>Solution: I created a new module for unsorted lists. The implementation (<code>unsorted_list.ml</code>) just proxies calls to the real code:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>unsorted_list.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">list_store</span>
</span><span class="line"><span class="k">type</span> <span class="n">iter</span> <span class="o">=</span> <span class="nn">Gtk</span><span class="p">.</span><span class="n">tree_iter</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">list_store</span> <span class="n">cols</span> <span class="o">=</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">list_store</span> <span class="n">cols</span>
</span><span class="line"><span class="k">let</span> <span class="n">clear</span> <span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="n">model</span><span class="o">#</span><span class="n">clear</span> <span class="bp">()</span>
</span><span class="line"><span class="k">let</span> <span class="n">model_sort</span> <span class="n">model</span> <span class="o">=</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">model_sort</span> <span class="n">model</span>
</span><span class="line"><span class="k">let</span> <span class="n">get_iter_first</span> <span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="n">model</span><span class="o">#</span><span class="n">get_iter_first</span>
</span><span class="line"><span class="k">let</span> <span class="n">set</span> <span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="n">t</span><span class="o">)</span> <span class="o">~(</span><span class="n">row</span><span class="o">:</span><span class="n">iter</span><span class="o">)</span> <span class="o">~</span><span class="n">column</span> <span class="k">value</span> <span class="o">=</span> <span class="n">model</span><span class="o">#</span><span class="n">set</span> <span class="o">~</span><span class="n">row</span> <span class="o">~</span><span class="n">column</span> <span class="k">value</span>
</span><span class="line"><span class="k">let</span> <span class="n">get</span> <span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="n">t</span><span class="o">)</span> <span class="o">~(</span><span class="n">row</span><span class="o">:</span><span class="n">iter</span><span class="o">)</span> <span class="o">~</span><span class="n">column</span> <span class="o">=</span> <span class="n">model</span><span class="o">#</span><span class="n">get</span> <span class="o">~</span><span class="n">row</span> <span class="o">~</span><span class="n">column</span>
</span><span class="line"><span class="k">let</span> <span class="n">remove</span> <span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="n">row</span><span class="o">:</span><span class="n">iter</span><span class="o">)</span> <span class="o">=</span> <span class="n">model</span><span class="o">#</span><span class="n">remove</span> <span class="n">row</span>
</span><span class="line"><span class="k">let</span> <span class="n">convert_iter_to_child_iter</span> <span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="nn">GTree</span><span class="p">.</span><span class="n">model_sort</span><span class="o">)</span> <span class="o">(</span><span class="n">iter</span><span class="o">:</span><span class="nn">Gtk</span><span class="p">.</span><span class="n">tree_iter</span><span class="o">)</span> <span class="o">=</span> <span class="n">model</span><span class="o">#</span><span class="n">convert_iter_to_child_iter</span> <span class="n">iter</span>
</span><span class="line"><span class="k">let</span> <span class="n">append</span> <span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="n">model</span><span class="o">#</span><span class="n">append</span> <span class="bp">()</span>
</span><span class="line"><span class="k">let</span> <span class="n">iter_next</span> <span class="o">(</span><span class="n">model</span><span class="o">:</span><span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="n">row</span><span class="o">:</span><span class="n">iter</span><span class="o">)</span> <span class="o">=</span> <span class="n">model</span><span class="o">#</span><span class="n">iter_next</span> <span class="n">row</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>However, the interface (<code>unsorted_list.mli</code>) makes the types <code>t</code> (the model) and <code>iter</code> (its <code>GtkTreeIter</code>s) abstract, so that code outside of the module isn&rsquo;t allowed to know their real types:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>unsorted_list.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">type</span> <span class="n">t</span>
</span><span class="line"><span class="k">type</span> <span class="n">iter</span>
</span><span class="line"><span class="k">val</span> <span class="n">list_store</span> <span class="o">:</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">column_list</span> <span class="o">-&gt;</span> <span class="n">t</span>
</span><span class="line"><span class="k">val</span> <span class="n">clear</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span><span class="line"><span class="k">val</span> <span class="n">model_sort</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">model_sort</span>
</span><span class="line"><span class="k">val</span> <span class="n">get_iter_first</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">iter</span> <span class="n">option</span>
</span><span class="line"><span class="k">val</span> <span class="n">set</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">row</span><span class="o">:</span><span class="n">iter</span> <span class="o">-&gt;</span> <span class="n">column</span><span class="o">:</span><span class="k">'</span><span class="n">a</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">column</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span><span class="line"><span class="k">val</span> <span class="n">get</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">row</span><span class="o">:</span><span class="n">iter</span> <span class="o">-&gt;</span> <span class="n">column</span><span class="o">:</span><span class="k">'</span><span class="n">a</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">column</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">a</span>
</span><span class="line"><span class="k">val</span> <span class="n">remove</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">iter</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span><span class="line"><span class="k">val</span> <span class="n">convert_iter_to_child_iter</span> <span class="o">:</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">model_sort</span> <span class="o">-&gt;</span> <span class="nn">Gtk</span><span class="p">.</span><span class="n">tree_iter</span> <span class="o">-&gt;</span> <span class="n">iter</span>
</span><span class="line"><span class="k">val</span> <span class="n">append</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">iter</span>
</span><span class="line"><span class="k">val</span> <span class="n">iter_next</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">iter</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now it&rsquo;s impossible to mix up sorted and unsorted types:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="nn">Unsorted_list</span><span class="p">.</span><span class="n">list_store</span> <span class="n">cols</span>     <span class="c">(* Unsorted_list.t *)</span>
</span><span class="line"><span class="k">let</span> <span class="n">sorted_model</span> <span class="o">=</span> <span class="nn">Unsorted_list</span><span class="p">.</span><span class="n">model_sort</span> <span class="n">model</span> <span class="c">(* GTree.model *)</span>
</span><span class="line"><span class="k">let</span> <span class="n">view</span> <span class="o">=</span> <span class="nn">GTree</span><span class="p">.</span><span class="n">view</span> <span class="o">~</span><span class="n">model</span><span class="o">:</span><span class="n">sorted_model</span> <span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It&rsquo;s still possible to mix up iterators in some cases (e.g. between two different instances of a sorted model), but that&rsquo;s a much less likely mistake to make.</p>

<p>Another way to solve the problem would be to bundle the owning model with each iterator, but that would be a big change to how the underlying GTK library works.
And ATS could solve this easily using its dependant types, by declaring the iterator type as <code>iter(m)</code> (&ldquo;iterator of model at address m&rdquo;), linking models to iterators in the type system.</p>

<p>Type: Poor API</p>

<h3>Crashes with GtkIconView</h3>

<p>As with GtkTreeView, you can make a sorted GtkIconView with a pair of models.
For some reason, clearing the underlying model didn&rsquo;t clear the sorted version, and repopulating it corrupted memory:</p>

<pre><code>Program received signal SIGSEGV, Segmentation fault.
</code></pre>

<p>Solution: since there is no UI to let the user change the sort column, I just removed the sorted model and sorted the underlying model myself in OCaml. I guess this is probably a GTK bug.</p>

<p>Type: Third-party</p>

<p>A second crashing bug with GtkIconView is caused by a bug in lablgtk.
The C wrapper <code>get_path_at_pos</code> returns a <code>tree_path option</code> (<code>None</code> if you clicked in a blank area), but the OCaml declaration says it returns a plain <code>tree_path</code>.</p>

<p>Solution: use <code>Obj.magic</code> to do an unchecked cast to the correct type:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">path_unsafe</span> <span class="o">=</span> <span class="n">view</span><span class="o">#</span><span class="n">get_path_at_pos</span> <span class="n">x</span> <span class="n">y</span> <span class="k">in</span>
</span><span class="line"><span class="k">let</span> <span class="n">path</span> <span class="o">:</span> <span class="nn">Gtk</span><span class="p">.</span><span class="n">tree_path</span> <span class="n">option</span> <span class="o">=</span> <span class="nn">Obj</span><span class="p">.</span><span class="n">magic</span> <span class="n">path_unsafe</span> <span class="k">in</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>(reported as <a href="https://forge.ocamlcore.org/tracker/index.php?func=detail&amp;aid=1359&amp;group_id=220&amp;atid=1032">segfault due to GtkIconView type mismatch</a>)</p>

<p>Two interesting things about this bug:</p>

<ol>
  <li>Even the low-level GTK bindings are presumably not generated automatically. If they were, this kind of mismatch surely couldn&rsquo;t happen.</li>
  <li>An OCaml optional pointer doesn&rsquo;t have the same representation as a non-optional pointer. If it did, the code wouldn&rsquo;t crash. This suggests OCaml is being a bit inefficient about option types, which is disappointing.</li>
</ol>

<p>Type: Third-party</p>

<h2>Logic errors</h2>

<p>The remaining bugs aren&rsquo;t very interesting, but I&rsquo;ve included them for completeness:</p>

<ul>
  <li>Failed to handle ambiguous short options (e.g. <code>-r</code>)</li>
  <li>Missing tab completion for <code>0install add</code></li>
  <li><code>0install run</code> ignores <code>--gui</code> option</li>
  <li>Infinite loop handling recursive dependencies</li>
  <li>Allow absolute local paths in local implementations</li>
  <li>Default command for <code>--source</code> should be <code>compile</code>, not <code>run</code></li>
  <li>Allow <code>machine:null</code> in JSON response</li>
  <li>Typo: scripts start <code>#!</code> not <code>!#</code></li>
  <li>Report an error if we need to confirm keys during a headless background update</li>
  <li>Wrong attribute name in overrides XML file</li>
  <li>Allow executing selections with no command but an absolute main</li>
  <li>Handle local-path on <code>&lt;group&gt;</code> elements</li>
  <li>Wrong attribute name when saving user overrides</li>
  <li>Typo: <code>&quot;https://&quot;</code> not <code>&quot;https://'&quot;</code></li>
  <li>Don&rsquo;t try to use GUI in <code>--dry-run</code> mode</li>
  <li>Support old version of selections XML format</li>
  <li>Support old selections without a <code>from-feed</code> attribute</li>
  <li>Don&rsquo;t send an empty GetDetails request to PackageKit</li>
  <li>Cope with dpkg-query returning a non-zero exit status</li>
  <li>Detect Python even if python-gobject is missing</li>
  <li>Race when cancelling downloads</li>
</ul>

<p>Type: Testing only (x21)</p>

<h2>Python bugs</h2>

<p>Just for interest, here are the Python bugs discovered over the same period (it doesn&rsquo;t make sense to compare bug counts, because these are bugs in mature code, often several years old, not just-written new code).</p>

<p>I think these would be impossible or unlikely in OCaml (the problem would be detected at compile time):</p>

<ul>
  <li>Error setting machine type for Cygwin packages (type error)</li>
  <li>When loading selections from a file, convert <code>last-check-mtime</code> attribute to an int (type error)</li>
  <li><code>UnicodeError</code> extracting or generating a manifest for archives with non-ASCII file names (no encoding of file names in OCaml :-)</li>
  <li>Crash when specifying bold text (PyGTK API change)</li>
  <li>Broken clipboard handling in cache explorer (PyGTK API change)</li>
  <li>Broken filtering in cache explorer (PyGTK API change)</li>
  <li>Broken cache explorer menu when using a filter (model mix up; could avoid with abstract types, as above)</li>
  <li>Fails running an app when the master feed is no longer cached (would be forced to handle None case in OCaml)</li>
</ul>

<p>These would likely still be bugs in OCaml:</p>

<ul>
  <li>Fix mtime check in <code>selections.get_unavailable_selections</code> for native packages</li>
  <li>Always return False for native packages in <code>needs_download</code> if <code>include_packages</code> is False</li>
  <li>Always use the prefix &ldquo;xml&rdquo; for the XML namespace</li>
  <li>Don&rsquo;t abort solving just because a local feed is missing</li>
  <li>Escape tooltips in cache explorer</li>
  <li>32-bit size limit in cache explorer</li>
</ul>

<p>This was a third-party bug:</p>

<ul>
  <li>Workaround for PyGTK garbage collection bug</li>
</ul>

<h2>Summary</h2>

<p>Despite the newness of the code, the bug-rate has been surprisingly low so far. Of the (detected) bugs that did make it past the compiler, about a sixth were due to bugs in third-party libraries, another sixth could have been avoided with better third-party APIs and a sixth we due to my inexperience with OCaml. For the remaining half, more testing is still the only way I can see to find such bugs.</p>

<p><img src="http://roscidus.com/blog/images/bugs.png" class="border center"/></p>

<p>It&rsquo;s a shame that OCaml seems to have no system for deprecating old APIs. This means that poor API choices made years ago are still causing trouble today. It would be good if OCaml could flag functions as being there for historical reasons only, and issue a compiler warning if you used them. I do, however, like the fact that they stay around - breaking existing code (as Python 3 did) is not the solution either!</p>

<p>Two of the bugs (&ldquo;Deleting temporary files&rdquo; and &ldquo;Reactive event handler gets garbage collected&rdquo;) could have been avoided if OCaml had linear types, but I have reasonable solutions to both. The XML / JSON handling bugs could have been avoided by using proper schemas, but such schemas didn&rsquo;t exist (my fault).</p>

<p>Overall, I&rsquo;m pretty happy with the bug rate so far. No doubt more bugs will be discovered as the new code makes its way into the distributions and gains more users, but I think this code will be easier to maintain than the Python code, and much less likely to break silently due to changes in the language or third-party libraries.</p>
<a onclick="switchContent('ocamlorg-post74','ocamlorg-post73')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2014/01/07/ocaml-the-bugs-so-far/">by Thomas Leonard at Jan 07, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/decks-n-drums">
    <a name="#http://openmirage.org/blog/decks-n-drums"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/decks-n-drums">Presenting Decks</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post75">
      <p>A few months ago, partly as a stunt, mostly because we could, Anil and I put together <a href="http://decks.openmirage.org/oscon13/">a presentation</a> for <a href="http://www.oscon.com/oscon2013/">OSCON'13</a> about Mirage in Mirage. That is, as a self-hosting Mirage web application that served up slides using <a href="http://lab.hakim.se/reveal-js/">RevealJS</a>. It was a bit of a hack, but it was cool (we thought!) and it worked. Several more presentations were written and given this way, at venues ranging from the <a href="http://www.youtube.com/watch?v=3Jype6sP6MQ">XenSummit 2013</a> to <a href="https://www.usenix.org/conference/foci13%E2%80%8E">ACM FOCI 2013</a> to the Cambridge Computer Lab's <a href="http://decks.openmirage.org/cam13/">MSc in Advanced Computer Science</a>.</p>
<p>With the <a href="http://openmirage.org/blog/releasing-mirage">release of Mirage 1.0</a>, <a href="http://github.com/mirage/ocaml-cohttp">CoHTTP</a>, <a href="http://github.com/mirage/cowabloga">Cowabloga</a> and
the new <a href="http://foundation.zurb.com/">Zurb Foundation</a> based <a href="http://openmirage.org/">website</a>, it was time to refresh them
and as a little seasonal gift, give them a shiny new index with some actual CSS
styling. So <a href="http://decks.openmirage.org/">here they are</a>, a set of presentations that have been given
by various members of the Mirage team over the last 6 months or so. They cover
a range of topics, from general introductions to the Xen roadmap to more
detailed technical background. And, of course, as Mirage is under constant
rapid developm&hellip;</p><a onclick="switchContent('ocamlorg-post75','ocamlorg-post76')" class="btn planet-toggle" href="#http://openmirage.org/blog/decks-n-drums">Read more...</a></div><div id="ocamlorg-post76" style="display: none">
      <p>A few months ago, partly as a stunt, mostly because we could, Anil and I put together <a href="http://decks.openmirage.org/oscon13/">a presentation</a> for <a href="http://www.oscon.com/oscon2013/">OSCON'13</a> about Mirage in Mirage. That is, as a self-hosting Mirage web application that served up slides using <a href="http://lab.hakim.se/reveal-js/">RevealJS</a>. It was a bit of a hack, but it was cool (we thought!) and it worked. Several more presentations were written and given this way, at venues ranging from the <a href="http://www.youtube.com/watch?v=3Jype6sP6MQ">XenSummit 2013</a> to <a href="https://www.usenix.org/conference/foci13%E2%80%8E">ACM FOCI 2013</a> to the Cambridge Computer Lab's <a href="http://decks.openmirage.org/cam13/">MSc in Advanced Computer Science</a>.</p>
<p>With the <a href="http://openmirage.org/blog/releasing-mirage">release of Mirage 1.0</a>, <a href="http://github.com/mirage/ocaml-cohttp">CoHTTP</a>, <a href="http://github.com/mirage/cowabloga">Cowabloga</a> and
the new <a href="http://foundation.zurb.com/">Zurb Foundation</a> based <a href="http://openmirage.org/">website</a>, it was time to refresh them
and as a little seasonal gift, give them a shiny new index with some actual CSS
styling. So <a href="http://decks.openmirage.org/">here they are</a>, a set of presentations that have been given
by various members of the Mirage team over the last 6 months or so. They cover
a range of topics, from general introductions to the Xen roadmap to more
detailed technical background. And, of course, as Mirage is under constant
rapid development, some of the older content may already be outdated. But <a href="http://github.com/mirage/mirage-decks">the
code for the site itself</a> serves as another example of a simple --
somewhat simpler than the <a href="http://openmirage.org/">Mirage website</a> in fact -- Mirage web
application.</p>

   <a onclick="switchContent('ocamlorg-post76','ocamlorg-post75')" class="btn planet-toggle" href="#http://openmirage.org/blog/decks-n-drums">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/decks-n-drums">by Richard Mortier at Jan 03, 2014 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#Dec%202013">
    <a name="#http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#Dec%202013"> </a>
    <h1 class="posttitle">
      <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#Dec%202013">Dec 2013 news update</a>
      (<a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml" title="OCaml Labs News">OCL Monthly News</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post77">
      <p>This time last year in 2012, I had just
<a href="http://anil.recoil.org/2012/10/19/announcing-ocaml-labs.html">announced</a> the
formation of a new group called <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/">OCaml Labs</a> in the
<a href="http://www.cl.cam.ac.uk">Cambridge Computer Lab</a> that would combine research
and community work towards the practical application of functional programming.
An incredible year has absolutely flown by, and I've put together this post to
summarise what's gone on, and point to our future directions for 2014.</p>
<p>The theme of our group was not to be pure research, but rather a hybrid group
that would take on some of the load of day-to-day OCaml maintenance from
<a href="http://caml.inria.fr">INRIA</a>, as well as help grow the wider OCaml community.
To this end, all of our projects have been highly collaborative, often
involving colleagues from <a href="http://ocamlpro.com">OCamlPro</a>,
<a href="http://gallium.inria.fr/">INRIA</a>, <a href="http://janestreet.com">Jane Street</a>,
<a href="http://www.lexifi.com/">Lexifi</a> and <a href="http://citrix.com">Citrix</a>.</p>
<p>This post covers progress in <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#tooling">tooling</a>, the <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#core_compiler">compiler and
language</a>, <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#community_efforts">community efforts</a>, <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#research_projects">research
projects</a> and concludes with our <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#priorities_for_2014">priorities for
2014</a>.</p>
<h3>Tooling</h3>
<p>At the start of 2013, OCaml was in the interesting position of being a mature
decades-old language wit&hellip;</p><a onclick="switchContent('ocamlorg-post77','ocamlorg-post78')" class="btn planet-toggle" href="#http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#Dec%202013">Read more...</a></div><div id="ocamlorg-post78" style="display: none">
      <p>This time last year in 2012, I had just
<a href="http://anil.recoil.org/2012/10/19/announcing-ocaml-labs.html">announced</a> the
formation of a new group called <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/">OCaml Labs</a> in the
<a href="http://www.cl.cam.ac.uk">Cambridge Computer Lab</a> that would combine research
and community work towards the practical application of functional programming.
An incredible year has absolutely flown by, and I've put together this post to
summarise what's gone on, and point to our future directions for 2014.</p>
<p>The theme of our group was not to be pure research, but rather a hybrid group
that would take on some of the load of day-to-day OCaml maintenance from
<a href="http://caml.inria.fr">INRIA</a>, as well as help grow the wider OCaml community.
To this end, all of our projects have been highly collaborative, often
involving colleagues from <a href="http://ocamlpro.com">OCamlPro</a>,
<a href="http://gallium.inria.fr/">INRIA</a>, <a href="http://janestreet.com">Jane Street</a>,
<a href="http://www.lexifi.com/">Lexifi</a> and <a href="http://citrix.com">Citrix</a>.</p>
<p>This post covers progress in <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#tooling">tooling</a>, the <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#core_compiler">compiler and
language</a>, <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#community_efforts">community efforts</a>, <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#research_projects">research
projects</a> and concludes with our <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/atom.xml#priorities_for_2014">priorities for
2014</a>.</p>
<h3>Tooling</h3>
<p>At the start of 2013, OCaml was in the interesting position of being a mature
decades-old language with a small, loyal community of industrial users who built
mission critical applications using it.  We had the opportunity to sit down
with many of them at the <a href="http://caml.inria.fr/consortium/">OCaml Consortium</a>
meeting and prioritise where we started work.  The answer came back clearly:
while the compiler itself is legendary for its stability, the tooling around it
(such as package management) was a pressing problem.</p>
<h4>OPAM</h4>
<p>Our solution to this tooling was centered around the
<a href="http://opam.ocaml.org">OPAM</a> package manager that
<a href="http://ocamlpro.com">OCamlPro</a> released into beta just at the end of 2012, and
had its first stable release in March 2013.  OPAM differs from most system
package managers by emphasising a flexible distributed workflow that uses
version constraints to ensure incompatible libraries aren't mixed up (important
for the statically-typed OCaml that is very careful about dependencies).
Working closely with <a href="http://ocamlpro.com">OCamlPro</a> we developed a git-based
workflow to make it possible for users (both individual or industrial) to
easily build up their own package repositories and redistribute OCaml code, and
started curating the <a href="https://github.com/ocaml/opam-repository">package
repository</a>.</p>
<p>The results have been satisfying: we started with an initial set of around 100 packages in
OPAM (mostly imported by the 4 developers), and ended 2013 with 587 unique packages and 2000 individual versions, with contributions from 160 individuals.  We now have a curated
<a href="https://github.com/ocaml/opam-repository">central package repository</a> for anyone
to submit their OCaml code,
several third-party remotes are maintained (e.g. the <a href="https://github.com/xapi-project/opam-repo-dev">Xen Project</a>
and <a href="https://github.com/ocsigen/opam-ocsigen">Ocsigen</a>).  We also regularly
receive releases of the <a href="http://ocaml.janestreet.com">Core</a> libraries
from Jane Street, and updates from sources as varied as <a href="https://github.com/ocaml/opam-repository/pull/1300">Facebook</a>,
<a href="http://anil.recoil.org/2013/09/16/camlpdf-the-end-of-sucky-pdf-tools.html">Coherent PDF</a>,
to the <a href="http://ocaml.org/meetings/ocaml/2013/slides/guha.pdf">Frenetic SDN</a> research.</p>
<p>A notable contribution from OCamlPro during this time was to
<a href="https://github.com/ocaml/opam-repository/issues/955">clarify</a> the licensing on
the package repository to be the liberal
<a href="http://creativecommons.org/choose/zero/">CC0</a>, and also to pass ownership to
the <a href="http://github.com/ocaml">OCaml</a> organization on GitHub, where it's now
jointly maintained by OCaml Labs, OCamlPro and anyone else that wishes to
contribute.</p>
<h4>A lens into global OCaml code</h4>
<p>It's been quite interesting just watching all the varied code fly into the
repository, but stability quickly became a concern as the new packages piled
up.  OCaml compiles to native code on not just x86, but also PowerPC, Sparc and
<a href="http://anil.recoil.org/2012/02/25/dreamplug-debian-and-ocaml.html">ARM</a> CPUs.
We kicked off various efforts into automated testing: firstly <a href="https://github.com/dsheets">David Sheets</a>
built the
<a href="http://anil.recoil.org/2013/09/09/ocamlot-autotriaging.html">OCamlot</a> daemon
that would schedule builds across all the exotic hardware. Later in the year,
the <a href="http://travis-ci.org">Travis</a> service launched support for testing from GitHub pull requests,
and this became the front line of <a href="http://anil.recoil.org/2013/09/30/travis-and-ocaml.html">automated
checking</a> for all
incoming new packages to OPAM.</p>
<p>A major headache with automated testing is usually setting up the right build
environment with external library dependencies, and so we <a href="http://anil.recoil.org/2013/11/15/docker-and-opam.html">added Docker
support</a> to make it
easier to bulk-build packages for local developer use, with the results of
builds available <a href="https://github.com/avsm/opam-bulk-logs">publically</a> for
anyone to help triage.  Unfortunately fixing the bugs themselves is still a
<a href="https://github.com/ocaml/opam-repository/issues/1304">very manual process</a>, so
more volunteers are always welcome to help out!</p>
<p>We're going to be really seeing the rewards from all this effort as OCaml
4.02 development proceeds, since we can now adopt a data-driven approach
to changing language features instead of guessing how much third-party
code will break.  If your code is in OPAM, then it'll be tested as new
features such as <a href="http://caml.inria.fr/mantis/view.php?id=6063">module aliases</a>,
<a href="http://ocaml.org/meetings/ocaml/2013/slides/garrigue.pdf">injectivity</a> and
<a href="http://ocaml.org/meetings/ocaml/2013/slides/white.pdf">extension points</a> show up.</p>
<h4>Better documentation</h4>
<p>The venerable
<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual029.html">OCamlDoc</a> tool
has done an admirable job for the last decade, but is increasingly showing its
age due to a lack of support for cross-referencing across packages.  We started
working on this problem in the summer when <a href="https://github.com/vincent-botbol">Vincent Botbol</a>
visited us on an internship, expecting it to be a quick job to come up with
something as good as Haskell's excellent <a href="http://www.haskell.org/haddock/">Haddock</a> online documentation.</p>
<p>Instead, we ran into the &quot;module wall&quot;: since OCaml makes it so easy to
parameterise code over other modules, it makes it hard to generate static
documentation without outputting hundreds of megabytes of HTML every time.
After some hard work from Vincent and Leo, we've got a working prototype that
lets you simply run <code>opam install opam-doc &amp;&amp; opam doc core async</code> to generate
package documentation.  You can see the results for
<a href="http://mirage.github.io/">Mirage</a> online, but expect to see this integrated
into the main OCaml site for all OPAM packages as we work through polishing up
the user interface.</p>
<h4>Turning OPAM into libraries</h4>
<p>The other behind-the-scenes effort for OPAM has been to keep the core command-line
tool simple and stable, and to have it install OCaml libraries that can be
interfaced with by other tools to do domain-specific tasks.  <a href="http://gazagnaire.org">Thomas Gazagnaire</a>,
<a href="http://louis.gesbert.fr/cv.en.html">Louis Gesbert</a> and <a href="https://github.com/dsheets">David Sheets</a> have been steadily hacking away at this and
we now have <a href="https://github.com/ocamllabs/opamfu">opamfu</a> to run operations
over all packages, and an easy-to-template <a href="https://github.com/ocaml/opam2web">opam2web</a>
that generates the live <a href="http://opam.ocaml.org">opam.ocaml.org</a> website.</p>
<p>This makes OPAM easier to deploy within other organizations that want to integrate
it into their workflow.  For example, the <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/pkg/">software
section</a> of the OCaml Labs website is regularly
generated from a search of all OPAM packages tagged <code>ocamllabs</code>.  We also used
it to rewrite the entire OPAM repository <a href="https://github.com/ocaml/opam-repository/pull/1240">in one epic diff</a> to add external
library dependencies via a <a href="https://github.com/ocaml/opam/pull/886/files">command-line shim</a>.</p>
<h4>OPAM-in-a-Box</h4>
<p>All of this effort is geared towards making it easier to maintain reusable
local OPAM installations.  After several requests from big universities to help
out their teaching needs, we're putting together all the support needed to
easily redistribute OPAM packages via an
&quot;<a href="https://github.com/ocaml/opam/issues/1035">OPAM-in-a-Box</a>&quot; command that uses
<a href="http://docker.io">Docker</a> containers to let you clone and do lightweight
modifications of OCaml installations.</p>
<p>This will also be useful for anyone who'd like to run tutorials or teach OCaml,
without having to rely on flaky network connectivity at conference venues: a problem we've  <a href="http://amirchaudhry.com/fpdays-review">suffered from</a> too!</p>
<h3>Core Compiler</h3>
<p>Starting to work on a real compiler can often be a daunting prospect, and so
one initiative we started this year is to host regular <a href="http://ocamllabs.github.io/compiler-hacking/2013/10/30/third-compiler-hacking-session.html">compiler hacking sessions</a> where people could find a <a href="https://github.com/ocamllabs/compiler-hacking/wiki">curated list of features</a> to work on, with the regular developers at hand to help out when people get stuck, and free beer and pizza to oil the coding wheels.  This has worked out well, with around 20 people showing up on average for the three we held, and <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-previously-worked-on">several patches</a> submitted upstream to OCaml.  <a href="http://gallium.inria.fr/~scherer/">Gabriel Scherer</a> and <a href="http://cristal.inria.fr/~doligez/">Damien Doligez</a> have been helping this effort by tagging <a href="http://caml.inria.fr/mantis/search.php?project_id=1&amp;sticky_issues=1&amp;sortby=last_updated&amp;dir=DESC&amp;highlight_changed=24&amp;hide_status_id=90&amp;tag_string=junior_job">junior jobs</a> in the OCaml Mantis bug tracker as they are filed.</p>
<h4>Syntax transformations and extension points</h4>
<p><a href="http://www.lpw25.net">Leo White</a> started the year fresh out of completing his PhD with <a href="https://www.cl.cam.ac.uk/~am21/">Alan Mycroft</a>, and before he realized what he'd
gotten himelf into was working with <a href="http://alain.frisch.fr/">Alain Frisch</a> on the
future of syntax transformations in OCaml.  We started off our first
<a href="http://lists.ocaml.org/listinfo/wg-camlp4">wg-camlp4</a> working group on the new
<a href="http://lists.ocaml.org">lists.ocaml.org</a> host, and a spirited discussion
<a href="http://lists.ocaml.org/pipermail/wg-camlp4/2013-January/thread.html">started</a> that
went <a href="http://lists.ocaml.org/pipermail/wg-camlp4/2013-February/thread.html">on</a>
and <a href="http://lists.ocaml.org/pipermail/wg-camlp4/2013-March/thread.html">on</a> for
several months.  It ended with a very satisfying design for a simpler <em>extension
points</em> mechanism which Leo <a href="http://ocaml.org/meetings/ocaml/2013/slides/white.pdf">presented</a>
at the OCaml 2013 workshop at ICFP, and is now merged into OCaml 4.02-trunk.</p>
<h4>Namespaces</h4>
<p>Not all of the working groups were quite as successful in coming to a conclusion as the Camlp4 one.  On the Platform mailing list, Gabriel Scherer started a discussion on the design for <a href="http://lists.ocaml.org/pipermail/platform/2013-February/000050.html">namespaces</a> in OCaml.  The resulting discussion was useful in separating multiple concerns that were intermingled in the initial proposal, and Leo wrote a <a href="http://www.lpw25.net/2013/03/10/ocaml-namespaces.html">comprehensive blog post</a> on a proposed namespace design.</p>
<p>After further discussion at <a href="http://icfpconference.org/icfp2013/">ICFP 2013</a> with Jacques Garrigue later in the year, it turns out adding support for <a href="http://caml.inria.fr/mantis/view.php?id=6063">module aliases</a> would solve much of the cost associated with compiling large libraries such as <a href="http://ocaml.janestreet.com">Core</a>, with no backwards compatibility issues.  This solution has now been integrated into OCaml 4.02.0dev and is being tested with Core.</p>
<h4>Delving into the bug tracker</h4>
<p>Jeremy Yallop joined us in April, and he and Leo also leapt into the core
compiler and started triaging issues on the OCaml <a href="http://caml.inria.fr/mantis">bug
tracker</a>.  This seems unglamorous in the
beginning, but there rapidly turned out to be many fascinating threads that
shed light on OCaml's design and implementation through seemingly harmless
bugs.  Here is a pick of some interesting threads through the year that we've
been involved with:</p>
<ul>
 <li>An <a href="http://caml.inria.fr/mantis/view.php?id=5985&amp;nbn=49#bugnotes">unexpected interaction between variance and GADTs</a>
 that led to Jacques Garrigue's <a href="http://ocaml.org/meetings/ocaml/2013/slides/garrigue.pdf">talk</a> at OCaml 2013.</li>
 <li>Type unsoundness by <a href="http://caml.inria.fr/mantis/view.php?id=5992">pattern matching lazy mutable values</a>, thus
 shedding light on the precise semantics of the order of pattern matching.</li>
 <li>Leo proposed an <a href="http://caml.inria.fr/mantis/view.php?id=5584">open types</a> extension
 to allow abstract types to be declared open. You can try it via <code>opam switch 4.00.1+open-types</code>.</li>
 <li>Designing the popular, but controversial <a href="http://caml.inria.fr/mantis/view.php?id=5759">record disambiguation feature</a> in OCaml 4.01.0, and debating <a href="http://caml.inria.fr/mantis/view.php?id=6000">the right warnings</a> needed to prevent programmer surprise.</li>
 <li>Exposing a <a href="http://caml.inria.fr/mantis/view.php?id=6064">GADT representation for Bigarray</a>.</li>
</ul>

<p>This is just a sample of some of the issues solved in Mantis; if you want to
learn more about OCaml, it's well worth browsing through it to learn from over
a decade of interesting discussions from all the developers.</p>
<h4>Thread-local storage runtime</h4>
<p>While OCamlPro was working on their <a href="https://github.com/lucasaiu/ocaml">reentrant OCaml runtime</a>, we took a different tack by adding <a href="https://github.com/ocamllabs/ocaml/tree/multicore">thread-local storage</a> to the runtime instead, courtesy of <a href="http://mu.netsoc.ie/">Stephen Dolan</a>.  This is an important choice to make at the outset of adding multicore, so both approaches are warranted.  The preemptive runtime adds a lot of code churn (due to adding a context parameter to most function calls) and takes up a register, whereas the thread-local storage approach we tried doesn't permit callbacks to different threads.</p>
<p>Much of this work isn't interesting on its own, but forms the basis for a fully multicore runtime (with associated programming model) in 2014. Stay tuned!</p>
<h4>Ctypes</h4>
<p>One other complaint from the Consortium members was quite surprising: the difficulty of using the OCaml foreign function interface safely to interface with C code.  Jeremy Yallop began working on the <a href="https://github.com/ocamllabs/ocaml-ctypes">ctypes</a> library that had the goal of eliminating the need to write any C code at all for the vast majority of foreign bindings.</p>
<p>Instead, Ctypes lets you describe any C function call as an OCaml value, and provides various linkage options to invoke that function into C.  The first option he implemented was a <code>dlopen</code> interface, which immediately brought us the same level of functionality as the <a href="http://docs.python.org/2/library/ctypes.html">Python</a> or <a href="http://www.haskell.org/haskellwiki/Library/libffi">Haskell</a> Ctypes equivalents.  This early code was in itself startlingly useful and more pleasant to use than the raw FFI, and various folk (such as David Sheets' <a href="https://github.com/dsheets/ocaml-sodium">libsodium</a> cryptography bindings) started adopting it.</p>
<p>At this point, I happened to be struggling to write the Foreign Function Interface chapter of <a href="https://realworldocaml.org">Real World OCaml</a> without blowing through our page budget with a comprehensive explanation of the existing system.  I decided to take a risk and write about Ctypes instead, since it let new users to the language have a <em>far</em> more productive experience to get started.  Xavier Leroy pointed out <a href="https://github.com/realworldocaml/book/issues/1701">some shortcomings</a> of the library in his technical book review, most notably with the lack of an interface with C.  The design of Ctypes fully supports alternate linking mechanisms than just <code>dlopen</code> though, and Jeremy has added automatic C stub generation support as well.  This means that if you use Ctypes to build an OCaml binding in 2014, you can choose several mechanisms for the same source code to link to the external system.  Jeremy even demonstrated a forking model at OCaml 2013 that protects the OCaml runtime from the C binding via process separation.</p>
<p>The effort is paying off: Daniel B&uuml;nzli <a href="http://alan.petitepomme.net/cwn/2013.12.17.html#9">ported SDL2</a> using ctypes, and gave us extensive <a href="https://github.com/ocamllabs/ocaml-ctypes/issues">feedback</a> about any missing corner cases, and the resulting bindings don't require any C code to be written. <a href="http://xulforum.org">Jonathan Protzenko</a> even used it to implement an OCaml controlle
r for the <a href="http://gallium.inria.fr/blog/raspi-lcd/">Adafruit Raspberry Pi RGB LCD</a>!</p>
<h3>Community Efforts</h3>
<p>Our community efforts were largely online, but we also hosted visitors over the year and regular face-to-face tutorials.</p>
<h4>Online at OCaml.org</h4>
<p>While the rest of the crew were hacking on OPAM and OCaml, <a href="http://amirchaudhry.com/">Amir Chaudhry</a> and <a href="http://philippewang.info/CL/">Philippe Wang</a> teamed up with Ashish Agarwal and Christophe Troestler to redesign and relaunch the <a href="http://ocaml.org">OCaml website</a>.  Historically, OCaml's homepage has been the <a href="http://caml.inria.fr">caml.inria.fr</a> domain, and the <a href="http://ocaml.org">ocaml.org</a> effort was begun by Christophe and Ashish <a href="https://www.mail-archive.com/caml-list@inria.fr/msg00169.html">some years ago</a> to modernize the web presence.</p>
<p>The webpages were already rather large with complex scripting (for example, the <a href="http://ocaml.org/learn/tutorials/99problems.html">99 Problems</a> page runs the OCaml code to autogenerate the output). Philippe developed a <a href="https://github.com/pw374/MPP-language-blender">template DSL</a> that made it easier to unify a lot of the templates around the website, and also a <a href="https://github.com/pw374/omd">Markdown parser</a> that we could link to as a library from the rest of the infrastructure without shelling out to Pandoc.</p>
<p>Meanwhile, Amir designed a series of <a href="http://amirchaudhry.com/wireframe-demos-for-ocamlorg/">interactive wireframe sketches</a>  and <a href="http://amirchaudhry.com/ocamlorg-request-for-feedback/">gathered feedback</a> on it from the community. A local design agency in Cambridge helped with visual look and feel, and finally at the end of the summer we began the <a href="http://amirchaudhry.com/migration-plan-ocaml-org/">migration</a> to the new website, followed by a triumphant <a href="http://amirchaudhry.com/announcing-new-ocamlorg/">switchover</a> in November to the design you see today.</p>
<p>The domain isn't just limited to the website itself.  Leo and I set up a <a href="https://github.com/ocaml/ocaml.org-scripts">SVN-to-Git mirror</a> of the OCaml compiler <a href="http://caml.inria.fr/ocaml/anonsvn.en.html">Subversion repository</a> on the GitHub <a href="https://github.com/ocaml/ocaml">OCaml organization</a>, which is proving popular with developers.  There is an ongoing effort to simplify the core compiler tree by splitting out some of the larger components, and so <a href="http://github.com/ocaml/camlp4">camlp4</a> is also now hosted on that organization, along with <a href="https://github.com/ocaml/oasis">OASIS</a>.  We also administer several subdomains of <a href="http://ocaml.org">ocaml.org</a>, such as the <a href="http://lists.ocaml.org">mailing lists</a> and the <a href="http://opam.ocaml.org">OPAM repository</a>, and other services such as the <a href="http://forge.ocamlcore.org">OCaml Forge</a> are currently migrating over.  This was made significantly easier thanks to sponsorship from <a href="http://rackspace.com">Rackspace Cloud</a> (users of <a href="http://xenserver.org">XenServer</a> which is written in OCaml). They saw our struggles with managing physical machines and gave us developer accounts, and all of the ocaml.org infrastructure is now hosted on Rackspace.  We're very grateful to their ongoing help!</p>
<p>If you'd like to contribute to infrastructure help  (for example, I'm experimenting with a <a href="http://git.ocaml.org/public/">GitLab</a> mirror), then please join the <a href="http://lists.ocaml.org/listinfo/infrastructure">infrastructure@lists.ocaml.org</a> mailing list and share your thoughts.  The website team also need help with adding content and <a href="https://github.com/ocaml/ocaml.org/issues/376">international translations</a>, so head over to the <a href="http://github.com/ocaml/ocaml.org/issues">website issue tracker</a> and start proposing improvements you'd like to see.</p>
<h4>Next steps for ocaml.org</h4>
<p>The floodgates requesting features opened up after the launch of the new look and feel.  Pretty much everyone wanted deeper OPAM integration into the main website, for features such as:</p>
<ul>
 <li>Starring and reviewing packages</li>
 <li>Integrating the <a href="https://github.com/ocamllabs/opam-doc">opam-doc</a> documentation with the metadata</li>
 <li>Display test results and a compatibility matrix for non-x86 and non-Linux architectures.</li>
 <li>Link to blog posts and tutorials about the package.</li>
</ul>

<p>Many of these features were part of the <a href="http://amirchaudhry.com/wireframe-demos-for-ocamlorg/">original wireframes</a> but we're being careful to take a long-term view of how they should be create
d and maintained.Rather than building all of this as a huge bloated <a href="https://github.com/ocaml/opam2web">opam2web</a> extension, David Sheets (our resident relucant-to-admit-it web expert) has designed an overlay directory scheme that permits the overlaying of different metadata onto the website. This lets one particular feature (such as blog post aggregation) be handled separately from the others via Atom aggregators.</p>
<h4>&nbsp;Real World OCaml</h4>
<p>A big effort that took up most of the year for me was finishing and publishing an O'Reilly book called <a href="https://realworldocaml.org">Real World OCaml</a> with <a href="https://ocaml.janestreet.com/?q=blog/5">Yaron Minsky</a> and Jason Hickey.  Yaron describes how it all started in <a href="https://ocaml.janestreet.com/?q=node/117">his blog post</a>, but I learnt a lot from developing a book using the <a href="http://anil.recoil.org/2013/06/17/real-world-ocaml-beta-available.html">open commenting scheme</a> that we
developed just for this.</p>
<p>In particular, the book ended up shining a bright light into dark language corners that we might otherwise not have explored in OCaml Labs.  Two chapters of the book that I wasn't satisfied with were the <a href="https://realworldocaml.org/v1/en/html/objects.html">objects</a> and <a href="https://realworldocaml.org/v1/en/html/classes.html">classes</a> chapters, largely since neither Yaron nor Jason nor I had ever really used their full power in our own code.  Luckily, Leo White decided to pick up the baton and champion these oft-maligned (but very powerful) features of OCaml, and the result is the clearest explanation of them that I've read yet.  Meanwhile, Jeremy Yallop helped out with extensive review of the <a href="https://realworldocaml.org/v1/en/html/foreign-function-interface.html">Foreign Function Interface</a> chapter that used his <a href="https://github.com/ocamllabs/ocaml-ctypes">ctypes</a> library.  Finally, <a href="https://plus.google.com/100586365409172579442/posts">Jeremie Diminio</a> at Jane Street worked hard on adding several features to his <a href="https://github.com/diml/utop">utop</a> toplevel that made it compelling enough to become our default recommendation for newcomers.</p>
<p>All in all, we ended up closing over <a href="http://anil.recoil.org/2013/08/06/real-world-ocaml-beta2.html">2000 comments</a> in the process of writing the book, and I'm very proud of the result (freely available <a href="https://realworldocaml.org">online</a>, but do <a href="http://www.amazon.com/Real-World-OCaml-Functional-programming/dp/144932391X/">buy a copy</a> if you can to support it).  Still, there's more I'd like to do in 2014 to improve the ease of using OCaml further.  In particular, I removed a chapter on packaging and build systems since I wasn't happy with its quality, and both <a href="http://gazagnaire.org">Thomas Gazagnaire</a> and I intend to spend time in 2014 on improving this part of the ecosystem.</p>
<h4>Tutorials and Talks</h4>
<p>We had a lively presence at <a href="http://icfpconference.org">ICFP 2013</a> this year, with the third iteration of the <a href="http://ocaml.org/meetings/ocaml/2013/program.html">OCaml 2013</a> held there, and Stephen Dolan presenting a paper in the main conference.  I <a href="http://www.syslog.cl.cam.ac.uk/2013/09/24/liveblogging-ocaml-workshop-2013/">liveblogged the workshop</a> as it happened, and all the <a href="http://ocaml.org/meetings/ocaml/2013/program.html">talks</a> we gave are linked from the program.  The most exciting part of the conference for a lot of us were the two talks by Facebook on their use of OCaml: first for <a href="http://ocaml.org/meetings/ocaml/2013/slides/padioleau.pdf">program analysis using Pfff</a> and then to migrate their massive PHP codebase <a href="http://www.youtube.com/watch?feature=player_detailpage&amp;v=gKWNjFagR9k#t=1150">using an OCaml compiler</a>.  I also had the  opportunity to participate in a panel at the Haskell Workshop on whether <a href="http://ezyang.tumblr.com/post/62157468762/haskell-haskell-and-ghc-too-big-to-fail-panel">Haskell is too big to fail yet</a>; lots of interesting perspectives on scaling another formerly academic language into the real world.</p>
<p><a href="https://ocaml.janestreet.com/?q=blog/5">Yaron Minsky</a> and I have been giving tutorials on OCaml at ICFP for several years, but the release of Real World OCaml has made it significantly easier to give tutorials without the sort of labor intensity that it took in previous years (one memorable ICFP 2011 tutorial that we did took almost 2 hours to get everyone installed with OCaml.  In ICFP 2013, it took us 15 minutes or so to get everyone started).  Still, giving tutorials at ICFP is very much preaching to the choir, and so we've started speaking at more general-purpose events.</p>
<p>Our first local effort was <a href="http://fpdays.net/2013/">FPDays</a> in Cambridge, where Jeremy Yallop and Amir Chaudhry ran the tutorial with help from Phillipe Wang, Leo White and David Sheets. The OCaml session there ended up being the biggest one in the entire two days, and Amir <a href="http://amirchaudhry.com/fpdays-review/">wrote up</a> their experiences.  One interesting change from our ICFP tutorial is that Jeremy used <a href="https://github.com/ocsigen/js_of_ocaml">js_of_ocaml</a> to teach OCaml via JavaScript by building a fun <a href="https://github.com/ocamllabs/fpdays-skeleton">Monty Hall</a> game.</p>
<h4>Visitors and Interns</h4>
<p>Since OCaml Labs is a normal group within the <a href="http://www.cl.cam.ac.uk">Cambridge Computer Lab</a>, we often host academic visitors and interns who pass through.  This year was certainly diverse, and we welcomed a range of colleagues:</p>
<ul>
 <li><a href="http://www.lip6.fr/actualite/personnes-fiche.php?ident=D1161&amp;LANG=en">Mathias Bourgoin</a> has just finished his work on interfacing OCaml with GPUs, and gave us a seminar on how his <a href="http://www.algo-prog.info/spoc/web/index.php?id=spoc">SPOC</a> tool works (also available in OPAM via a <a href="http://www.algo-prog.info/spoc/distribution/opam/">custom remote</a>).</li>
 <li><a href="http://www.benjamin.canou.fr/">Benjamin Canou</a> (now at OCamlPro) practised his <a href="http://ocaml.org/meetings/ocaml/2013/slides/canou.pdf">OCaml 2013 talk</a> on building high-level interfaces to JavaScript with OCaml by giving a departmental seminar.</li>
 <li><a href="http://www.dicosmo.org/">Roberto Di Cosmo</a>, who directs the <a href="http://www.irill.org/">IRILL</a> organization on Free Software in Paris delivered a seminar on constraint solving for <a href="http://mancoosi.org">package systems</a> that are as large-scale as Debian's.</li>
 <li><a href="http://gazagnaire.org">Thomas Gazagnaire</a> visited during the summer to help plot the <a href="http://openmirage.org/blog/mirage-1.0.3-released">Mirage 1.0</a> and <a href="http://anil.recoil.org/2013/09/20/opam-1-1-beta.html">OPAM 1.1</a> releases.  He has also since joined OCaml Labs fulltime to work on <a href="http://nymote.org">Nymote</a>.</li>
 <li><a href="http://louis.gesbert.fr/cv.en.html">Louis Gesbert</a> from OCamlPro visited for 2 weeks in December and kicked off the inaugral OPAM developers summit (which was, admittedly, just 5 developers in the <a href="http://www.kingston-arms.co.uk/">Kingston Arms</a>, but all good things start in a pub, right?)</li>
 <li><a href="http://www.xulforum.org/">Jonathan Protzenko</a> presented his PhD work on <a href="http://protz.github.io/mezzo/">Mezzo</a> (which is now <a href="http://gallium.inria.fr/blog/mezzo-on-opam/">merged into OPAM</a>), and educated us on the vagaries of <a href="http://protz.github.io/ocaml-installer/">Windows support</a>.</li>
 <li><a href="http://gallium.inria.fr/~scherer/">Gabriel Scherer</a> from the Gallium INRIA group visited to discuss the direction of OPAM and various language feature discussions (such as namespaces).  He didn't give a talk, but promises to do so next time!</li>
 <li><a href="https://github.com/bvaugon">Beno&icirc;t Vaugon</a> gave a seminar on his <a href="http://oud.ocaml.org/2012/slides/oud2012-paper10-slides.pdf">OCamlCC</a> OCaml-to-C compiler, talked about porting OCaml to <a href="http://www.algo-prog.info/ocaml_for_pic/web/index.php?id=ocapic">8-bit PICs</a>, and using GADTs to <a href="http://caml.inria.fr/mantis/view.php?id=6017">implement Printf</a> properly.</li>
</ul>

<p>We were also visited several times by <a href="http://danmey.org/">Wojciech Meyer</a> from ARM, who was an OCaml developer who maintained (among other things) the <a href="http://brion.inria.fr/gallium/index.php/Ocamlbuild">ocamlbuild</a> system and worked on <a href="http://www.youtube.com/watch?v=d9Hg5L76FG8">DragonKit</a> (an extensible LLVM-like compiler written in OCaml).  Wojciech very sadly passed away on November 18th, and we all fondly remember his enthusiastic and intelligent contributions to our small Cambridge community.</p>
<p>We also hosted visitors to live in Cambridge and work with us over the summer.  In addition to Vincent Botbol (who worked on OPAM-doc as described earlier) we had the pleasure of having <a href="http://erratique.ch/">Daniel B&uuml;nzli</a> and <a href="http://www.x9c.fr/">Xavier Clerc</a> work here.  Here's what they did in their own words.</p>
<h5>Xavier Clerc: OCamlJava</h5>
<p>Xavier Clerc took a break from his regular duties at INRIA to join us over the summer
to work on <a href="http://ocamljava.x9c.fr/preview/">OCaml-Java</a> and adapt it to the latest
JVM features.  This is an incredibly important project to bridge OCaml with the huge
Java community, and here's his report:</p>
<blockquote><p>After a four-month visit to the OCaml Labs dedicated to the <a href="http://ocamljava.x9c.fr/preview/">OCaml-Java</a>
project, the time has come for an appraisal! The undertaken work can be split
into two areas: improvements to code generation, and interaction between the
OCaml &amp; Java languages.  Regarding code generation, several classical
optimizations have been added to the compiler, for example loop unrolling,
more aggressive unboxing, better handling of globals, or partial evaluation
(at the bytecode level). A new tool, namely ocamljar, has been introduced
allowing post-compilation optimizations. The underlying idea is that some
optimizations cannot always be applied (e.g. depending whether multiple
threads/programs will coexist), but enabling them through command-line flags
would lead to recompilation and/or multiple installations of each library
according to the set of chosen optimizations. It is thus far more easier to
first build an executable jar file, and then modify it according to these
optimizations. Furthermore, this workflow allows the ocamljar tool to take
advantage of whole-program information for some optimizations.  All these
improvements, combined, often lead to a gain of roughly 1/3 in terms of
execution time.</p>
<p>Regarding language interoperability, there are actually two directions 
depending on whether you want to call OCaml code from Java, or want to call 
Java code from OCaml. For the first direction, a tool allows to generate Java
source files from OCaml compiled interfaces, mapping the various constructs
of the OCaml language to Java classes. It is then possible to call functions, 
and to manipulate instances of OCaml types in pure Java, still benefiting 
from the type safety provided by the OCaml language. In the other direction,
an extension of the OCaml typer is provided allowing to create and manipulate
Java instances directly from OCaml sources. This typer extension is indeed a
thin layer upon the original OCaml typer, that is mainly responsible for
encoding Java types into OCaml types.  This encoding uses a number of
advanced elements such as polymorphic variants, subtyping, variance
annotations, phantom typing, and printf-hack, but the end-user does not have
to be aware of this encoding. On the surface, the type of instances of the
Java Object classes is <code>java'lang'Object java_instance</code>, and instances can be
created by calling Java.make <code>Object()</code>.</p>
<p>While still under heavy development, a working prototype <a href="http://ocamljava.x9c.fr/preview/">is available</a>, and bugs <a href="http://bugs.x9c.fr/">can be reported</a>. Finally, I would like to thank the OCaml Labs for providing a great working
environment.</p>
</blockquote>
<h5>Daniel B&uuml;nzli: Typography and Visualisation</h5>
<p>Daniel joined us from Switzerland, and spent some time at Citrix before joining us in OCaml Labs.  All of his <a href="http://erratique.ch/software">software</a> is now on OPAM, and is seeing ever-increasing adoption from the community.</p>
<blockquote><p>Released a first version of <a href="http://erratique.ch/software/vg">Vg</a> [...] I'm
especially happy about that as I wanted to use and work on these ideas since
at least 2008. The project is a long term project and is certainly not
finished yet but this is already a huge step.</p>
<p>Adjusted and released a first version of
<a href="http://erratique.ch/software/gg">Gg</a>. While the module was already mostly
written before my arrival to Cambridge, the development of Vg and Vz prompted
me to make some changes to the module.</p>
<p>[...] released <a href="http://erratique.ch/software/otfm">Otfm</a>, a
module to decode OpenType fonts. This is a work in progress as not every
OpenType table has built-in support for decoding yet. But since it is needed
by Vg's PDF renderer I had to cut a release. It can however already be used
to implement certain simple things like font kerning with Vg, this can be
seen in action in the <code>vecho</code> binary installed by Vg.</p>
<p>Started to work on <a href="http://erratique.ch/software/vz/doc/Vz.html">Vz</a>, a
module for helping to map data to Vg images. This is really unfinished and is
still considered to be at a design stage. There are a few things that are
however well implemented like (human) perceptually meaningful <a href="http://erratique.ch/software/vz/demos/color_schemes.html">color
palettes</a> and the
small folding stat module (<code>Vz.Stat</code>). However it quickly became evident that
I needed to have more in the box w.r.t. text rendering in Vg/Otfm. Things
like d3js entirely rely on the SVG/CSS support for text which makes it easy
to e.g. align things (like tick labels on <a href="http://erratique.ch/software/vz/demos/iris.html">such
drawings</a>). If you can't
rely on that you need ways of measuring rendered text. So I decided to
suspend the work on Vz and put more energy in making a first good release of
Vg. Vz still needs quite some design work, especially since it tries to be
independent of Vg's backend and from the mechanism for user input.</p>
<p>Spent some time figuring out a new &quot;opam-friendly&quot; release workflow in 
pkgopkg. One of my problem is that by designing in the small for programming
in the large --- what a slogan --- the number of packages I'm publishing is
growing (12 and still counting). This means that I need to scale horizontally
maintenance-wise unhelped by the sad state of build systems for OCaml. I need
tools that make the release process flawless, painless and up to my quality
standards. This lead me to enhance and consolidate my old scattered
distribution scripts in that repo, killing my dependencies on Oasis and
ocamlfind along the way. <em>(edited for brevity, see <a href="https://github.com/dbuenzli/pkgopkg">here</a>)</em></p>
</blockquote>
<p>Daniel also left his bicycle here for future visitors to use, and the &quot;B&uuml;nzli-bike&quot;
is available for our next visitor! (Louis Gesbert even donated lights, giving
it a semblance of safety).</p>
<h4>Industrial Fellows</h4>
<p>Most of our regular funding bodies such as <a href="http://epsrc.ac.uk">EPSRC</a> or <a href="http://cordis.europa.eu/fp7/home_en.html">EU FP7</a> provide funding, but leave all the intellectual input to the academics.  A compelling aspect of OCaml Labs has been how involved our industrial colleagues have been with the day-to-day problems that we solve.  Both Jane Street and Citrix have senior staff regularly visiting our group and working alongside us as industrial fellows in the Computer Lab.</p>
<ul>
 <li><a href="http://www.three-tuns.net/mark/">Mark Shinwell</a> from Jane Street Europe has been working on improving the <a href="http://www.youtube.com/watch?v=NF2WpWnB-nk">state of native debugging</a> in OCaml, by adding extended DWARF debugging information to the compiler output.  Mark is also a useful source of feedback about the forthcoming design of multicore, since he has daily insight into a huge production codebase at Jane Street (and can tell us about it without us requiring access!).</li>
 <li><a href="http://dave.recoil.org">Dave Scott</a> is the principal architect of <a href="http://xenserver.org">XenServer</a> at Citrix in Cambridge.  This year has been transformative for that project, since Citrix <a href="http://blogs.citrix.com/2013/06/26/open-source-what-does-it-mean-for-xenserver/">open-sourced XenServer</a> to GitHub and fully adopted OPAM into their workflow.  Dave is the author of numerous libraries that have all been released to OPAM, and his colleagues <a href="http://jon.recoil.org">Jon Ludlam</a> and <a href="http://www.xenserver.org/blog/blogger/listings/euanh.html">Euan Harris</a> are also regular visitors who have also been contributors to the OPAM and Mirage ecosystems.

<h3>Research Projects</h3></li>
</ul>

<p>The other 100% of our time at the Labs is spent on research projects.  When we started the group, I wanted to set up a feedback loop between local people <em>using</em> OCaml to build systems, with the folk <em>developing</em> OCaml itself.  This has worked out particularly well with a couple of big research projects in the Lab.</p>
<h4>&nbsp;Mirage</h4>
<p>Mirage is a <a href="http://anil.recoil.org/papers/2013-asplos-mirage.pdf">library operating system</a> written in OCaml that compiles source code into specialised Xen microkernels, developed at the Cambridge Computer Lab, Citrix and the <a href="http://horizon.ac.uk">Horizon Digital Economy</a> institute at Nottingham.  This year saw several years of effort culminate in the first release of <a href="http://openmirage.org">Mirage 1.0</a> as a self-hosting entity.  While Mirage started off as a <a href="http://anil.recoil.org/papers/2010-hotcloud-lamp.pdf">quick experiment</a> into building specialised virtual appliances, it rapidly became useful to make into a real system for use in bigger research projects.  You can learn more about Mirage <a href="http://openmirage.org/docs">here</a>, or read the <a href="http://cacm.acm.org/magazines/2014/1/170866-unikernels/abstract">Communications of the ACM</a> article that <a href="http://dave.recoil.org">Dave Scott</a> and I wrote to close out the year.</p>
<p>This project is where the OCaml Labs &quot;feedback loop&quot; has been strongest.  A typical <a href="http://www.openmirage.org/wiki/hello-world">Mirage application</a> consists of around 50 libraries that are all installed via OPAM.  These range from <a href="https://github.com/mirage/mirage-block-xen">device drivers</a> to protocol libraries for <a href="https://github.com/avsm/ocaml-cohttp">HTTP</a> or <a href="https://github.com/mirage/ocaml-dns">DNS</a>, to filesystems such as <a href="https://github.com/mirage/ocaml-fat">FAT32</a>.  Coordinating <a href="http://openmirage.org/blog/mirage-1.0.3-released">regular releases</a> of all of these would be near impossible without using OPAM, and has also forced us to use our own tools daily, helping to sort out bugs more quickly.  You can see the full list of libraries on the <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/pkg/">OCaml Labs software page</a>.</p>
<p>Mirage is also starting to share code with big projects such as <a href="http://xenserver.org">XenServer</a> now, and we have been working with Citrix engineers to help them to move to the <a href="http://ocaml.janestreet.com">Core</a> library that Jane Street has released (and that is covered in <a href="https://realworldocaml.org">Real World OCaml</a>).  Moving production codebases this large can take years, but OCaml Labs is turning out to be a good place to start unifying some of the bigger users of OCaml into one place.  We're also now an official <a href="http://www.xenproject.org/developers/teams/mirage-os.html">Xen Project incubator project</a>, which helps us to validate functional programming  to other Linux Foundation efforts.</p>
<h4>Nymote and User Centric Networking</h4>
<p>The release of Mirage 1.0 has put us on the road to simplifying embedded systems programming. The move to the centralized cloud has led to regular well-publicised privacy and security threats to the way <a href="http://de2013.org/wp-content/uploads/2013/09/de2013_submission_25-1.pdf">we handle</a> our digital infrastructure, and so <a href="http://www.cl.cam.ac.uk/~jac22/">Jon Crowcroft</a>, <a href="http://www.cs.nott.ac.uk/~rmm/">Richard Mortier</a> and I are leading an effort to build an alternative privacy-preserving infrastructure using embedded devices as part of the <a href="http://usercentricnetworking.eu/">User Centric Networking</a> project, in collaboration with a host of companies led by <a href="http://www.thlab.net/">Technicolor</a> Paris.
This work also plays on the strong points of OCaml: it already has a <a href="http://anil.recoil.org/2012/02/25/dreamplug-debian-and-ocaml.html">fast ARM backend</a>, and Mirage can easily be ported to the new Xen/ARM target as hardware becomes available.</p>
<p>One of the most difficult aspects of programming on the &quot;wide area&quot; Internet are dealing with the lack of a distributed identity service that's fully secure.  We published <a href="http://anil.recoil.org/papers/2013-foci-signposts.pdf">our thoughts</a> on this at the USENIX Free and Open Communications on the Internet workhsop, and David Sheets is working towards a full implementation using Mirage.  If you're interested in following this effort, Amir Chaudhry is blogging at the <a href="http://nymote.org/">Nymote</a> project website, where we'll talk about the components as they are released.</p>
<h4>&nbsp;Data Center Networking</h4>
<p>At the other extreme from embedded programming is datacenter networking, and we started the <a href="http://gow.epsrc.ac.uk/NGBOViewGrant.aspx?GrantRef=EP/K034723/1">Network-as-a-Service</a> research project with <a href="http://gow.epsrc.ac.uk/NGBOViewGrant.aspx?GrantRef=EP/K032968/1">Imperial College</a> and <a href="http://gow.epsrc.ac.uk/NGBOViewGrant.aspx?GrantRef=EP/K031724/1">Nottingham</a>.  With the rapid rise of <a href="http://en.wikipedia.org/wiki/Software-defined_networking">Software Defined Networking</a> this year, we are investigating how application-specific customisation of network resources can build fast, better, cheaper infrasructure.  OCaml is in a good position here: several other groups have built OpenFlow controllers in OCaml (most notably, the <a href="https://github.com/frenetic-lang">Frenetic Project</a>), and Mirage is specifically designed to assemble such bespoke infrastructure.</p>
<p>Another aspect we've been considering is how to solve the problem of optimal connectivity across nodes.  TCP is increasingly considered harmful in high-through, high-density clusters, and <a href="http://www.sussex.ac.uk/informatics/people/peoplelists/person/334868">George Parisis</a> led the design of <a href="http://anil.recoil.org/papers/2013-hotnets-trevi.pdf">Trevi</a>, which is a fountain-coding based alternative for storage networking.  Meanwhile, <a href="http://gazagnaire.org">Thomas Gazagnaire</a> (who joined OCaml Labs in November), has been working on a branch-consistent data store called <a href="https://github.com/samoht/irminsule">Irminsule</a> which supports scalable data sharing and reconciliation using Mirage.  Both of these systems will see implementations based on the research done this year.</p>
<h4>&nbsp;Higher Kinded Programming</h4>
<p>Jeremy Yallop and Leo White have been developing an approach that makes it possible to write programs with higher-kinded polymorphism (such as monadic functions that are polymorphic in the monad they use) without using functors. It's early days yet, but there's a <a href="https://github.com/ocamllabs/higher">library</a> available on <a href="http://opam.ocaml.org/pkg/higher/higher.0.1">OPAM</a> that implements the approach, and a <a href="https://github.com/ocamllabs/higher/raw/paper/higher.pdf">draft
paper</a> that outlines the design.</p>
<h3>Priorities for 2014</h3>
<p>This year has been a wild ride to get us up to speed, but we now have a solid sense of what to work on for 2014.  We've decided on a high-level set of priorities led by the senior members of the group:</p>
<ul>
 <li><strong>Multicore</strong>: Leo White will be leading efforts in putting an end-to-end multicore capable OCaml together.</li>
 <li><strong>Metaprogramming</strong>: Jeremy Yallop will direct the metaprogramming efforts, continuing with Ctypes and into macros and extension points.</li>
 <li><strong>Platform</strong>: Thomas Gazagnaire will continue to drive OPAM development towards becoming the first <a href="http://ocaml.org/meetings/ocaml/2013/slides/madhavapeddy.pdf">OCaml Platform</a>.</li>
 <li><strong>Online</strong>: Amir Chaudhry will develop the online and community efforts that started in 2013.</li>
</ul>

<p>These are guidelines to choosing where to spend our time, but not excluding other work or day-to-day bugfixing. Our focus on collaboration with Jane Street, Citrix, Lexifi, OCamlPro and our existing colleagues will continue, as well as warmly welcoming new community members that wish to work with us on any of the projects, either via internships, studentships or good old-fashioned open source hacking.</p>
<p>I appreciate the <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/people/">whole team's</a> feedback in editing this long post into shape, the amazing professorial support from <a href="http://www.cl.cam.ac.uk/~jac22/">Jon Crowcroft</a>, <a href="https://www.cl.cam.ac.uk/~iml1/">Ian Leslie</a> and <a href="https://www.cl.cam.ac.uk/~am21/">Alan Mycroft</a> throughout the year, and of course the funding and support from Jane Street, Citrix, RCUK, EPSRC, DARPA and the EU FP7 that made all this possible.  Roll on 2014, and please do <a href="mailto:avsm2@cl.cam.ac.uk">get in touch</a> with me with any queries!</p>

   <a onclick="switchContent('ocamlorg-post78','ocamlorg-post77')" class="btn planet-toggle" href="#http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#Dec%202013">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://www.cl.cam.ac.uk/projects/ocamllabs/news/index.html#Dec%202013">by Anil Madhavapeddy at Dec 29, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2013/12/20/polymorphism-for-beginners/">
    <a name="#http://roscidus.com/blog/blog/2013/12/20/polymorphism-for-beginners/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2013/12/20/polymorphism-for-beginners/">Polymorphism for beginners</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post79"><p>OCaml makes heavy use of <a href="http://en.wikipedia.org/wiki/Parametric_polymorphism">parametric polymorphism</a> (which you may also know as &ldquo;generics&rdquo; in other languages).
The OCaml tutorials mention it from time to time, but the information is spread about over many articles and they don&rsquo;t go into much detail.
I&rsquo;m not a type theorist, just a Python/Java/C programmer who finds this stuff interesting.
I wanted to write this guide while I still remember the things that confused me.
I know several OCaml experts keep an eye on this blog, so hopefully any inaccuracies will be corrected in the comments.</p>



<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#subtyping">Subtyping</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#top-and-bottom">Top and bottom</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#polymorphism">Polymorphism</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#polymorphic-objects">Polymorphic objects</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#polymorphic-variants">Polymorphic variants</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#example--a-polymorphic-dialog-box">Example : a polymorphic dialog box</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#other-issues">Other issues</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#monomorphic-types">Monomorphic types</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#partial-application-loses-polymorphism">Partial application loses polymorphism</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#universal-qualification">Universal qualification</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#polymorphism-in-module-signatures">Polymorphism in module signatures</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#cheat-sheet">Cheat-sheet</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#summary">Summary</a></li>
</ul>

<p>( This post is part of a series in which I am
<a href="http://roscidus.com/blog/blog/2013/06/09/choosing-a-python-replacement-for-0install">converting 0install from Py&hellip;</a></p><a onclick="switchContent('ocamlorg-post79','ocamlorg-post80')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2013/12/20/polymorphism-for-beginners/">Read more...</a></div><div id="ocamlorg-post80" style="display: none"><p>OCaml makes heavy use of <a href="http://en.wikipedia.org/wiki/Parametric_polymorphism">parametric polymorphism</a> (which you may also know as &ldquo;generics&rdquo; in other languages).
The OCaml tutorials mention it from time to time, but the information is spread about over many articles and they don&rsquo;t go into much detail.
I&rsquo;m not a type theorist, just a Python/Java/C programmer who finds this stuff interesting.
I wanted to write this guide while I still remember the things that confused me.
I know several OCaml experts keep an eye on this blog, so hopefully any inaccuracies will be corrected in the comments.</p>



<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#subtyping">Subtyping</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#top-and-bottom">Top and bottom</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#polymorphism">Polymorphism</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#polymorphic-objects">Polymorphic objects</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#polymorphic-variants">Polymorphic variants</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#example--a-polymorphic-dialog-box">Example : a polymorphic dialog box</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#other-issues">Other issues</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#monomorphic-types">Monomorphic types</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#partial-application-loses-polymorphism">Partial application loses polymorphism</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#universal-qualification">Universal qualification</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#polymorphism-in-module-signatures">Polymorphism in module signatures</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#cheat-sheet">Cheat-sheet</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#summary">Summary</a></li>
</ul>

<p>( This post is part of a series in which I am
<a href="http://roscidus.com/blog/blog/2013/06/09/choosing-a-python-replacement-for-0install">converting 0install from Python to OCaml</a>, learning OCaml as I go. )</p>

<h2>Subtyping</h2>

<p>The first thing that confused me was that OCaml tends to use <em>parametric polymorphism</em> where other languages use <em>subtyping</em> (&ldquo;subtype polymorphism&rdquo;), so I&rsquo;ll start with a brief summary of subtyping and then show how OCaml uses parametric polymorphism to achieve similar ends.</p>

<p>Note: in the rest of this article I will always use &ldquo;polymorphism&rdquo; to mean &ldquo;parametric polymorphism&rdquo;, which is the way the OCaml documentation uses it.</p>

<p>When you think of object oriented programming, you probably think of the types arranged in a tree. In fact, with multiple-inheritance of interfaces,
the types form a <em>lattice</em>, which is easier to draw than to explain:</p>

<p><img src="http://roscidus.com/blog/images/lattice.png" class="border center"/></p>

<p>On the left, we have some example primitive types, <code>int</code> and <code>unit</code>.</p>

<p>In the middle, we have some GUI object types. <code>widget</code> represents &ldquo;things that can appear on the screen&rdquo;. <code>button</code> and <code>window</code> are types of <code>widget</code> and a <code>dialog</code> is a type of <code>window</code>. For example, any function that can operate on windows can also operate on dialogs. A <code>button</code> is both a <code>widget</code> and an <code>action</code>. In Java terms, we might write <code>class Button implements Widget, Action</code>.</p>

<p>On the right, we have some variant types (enums). The type &ldquo;yes or no&rdquo; is a sub-type of &ldquo;yes, no or maybe&rdquo;. For example, a function that can format a yes/no/maybe value as a string will also work on the simpler yes/no type.</p>

<p>The rule is that you can always safely cast a type to a super type (going upwards). However, casting in Java and OCaml work differently:</p>

<p>In Java:</p>

<ul>
  <li>
    <p>Upcasting (converting to a type higher up in the lattice) is automatic and implicit. e.g. in <code>Widget w = new Dialog();</code></p>
  </li>
  <li>
    <p><a href="http://en.wikipedia.org/wiki/Downcasting">Downcasting</a> requires an explicit cast, and may throw an exception: <code>Dialog d = (Dialog) w</code>.</p>
  </li>
</ul>

<p>In OCaml:</p>

<ul>
  <li>
    <p>Upcasting must be explicit, e.g. <code>let w : widget = (new dialog :&gt; widget)</code>.</p>
  </li>
  <li>
    <p>Downcasting is impossible (types are not recorded at runtime, so it wouldn&rsquo;t be able to check).</p>
  </li>
</ul>

<p>Here&rsquo;s an example that might surprise you if you&rsquo;re expecting automatic upcasts:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">class</span> <span class="n">window</span> <span class="o">=</span>
</span><span class="line">  <span class="k">object</span>
</span><span class="line">    <span class="k">method</span> <span class="n">close</span> <span class="o">=</span> <span class="o">...</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="n">dialog</span> <span class="o">=</span>
</span><span class="line">  <span class="k">object</span>
</span><span class="line">    <span class="k">inherit</span> <span class="n">window</span>
</span><span class="line">    <span class="k">method</span> <span class="n">get_response</span> <span class="o">=</span> <span class="o">...</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">close_window</span> <span class="o">(</span><span class="n">w</span><span class="o">:</span><span class="n">window</span><span class="o">)</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span>
</span><span class="line">  <span class="n">w</span><span class="o">#</span><span class="n">close</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dialog</span> <span class="k">in</span>
</span><span class="line">  <span class="n">close_window</span> <span class="n">d</span>		<span class="c">(* ERROR! *)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<pre><code>Error: This expression has type dialog but an expression was expected of type window
       The second object type has no method get_response
</code></pre>

<p>OCaml won&rsquo;t let you pass a dialog to <code>close_window</code> because it&rsquo;s a <code>dialog</code>, not a <code>window</code> and there are no automatic coercions in OCaml. However, OCaml does know the subtyping relationship and will therefore let you cast it:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dialog</span> <span class="k">in</span>
</span><span class="line">  <span class="n">close_window</span> <span class="o">(</span><span class="n">d</span> <span class="o">:&gt;</span> <span class="n">window</span><span class="o">)</span>	<span class="c">(* OK *)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Functions also have types and can be cast too, so here&rsquo;s another way to solve this problem:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dialog</span> <span class="k">in</span>
</span><span class="line">  <span class="o">(</span><span class="n">close_window</span> <span class="o">:&gt;</span> <span class="o">(</span><span class="n">dialog</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">))</span> <span class="n">d</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here, we upcast <code>close_window</code> to the type <code>dialog -&gt; unit</code> and then pass it a <code>dialog</code>.</p>

<p>By the way, notice that <code>dialog</code> is a <em>subtype</em> of <code>window</code> but <code>dialog -&gt; unit</code> is a <em>super-type</em> of <code>window -&gt; unit</code>. See <a href="http://en.wikipedia.org/wiki/Covariance_and_contravariance_(computer_science)">covariance and contravariance</a> for the details about that.</p>

<h3>Top and bottom</h3>

<p>The types <em>top</em> and <em>bottom</em> don&rsquo;t seem to exist in OCaml, but I included them for completeness and because they&rsquo;re conceptually interesting and you&rsquo;ll probably run across these terms when reading anything about types.</p>

<p><em>Top</em> is a super-type of everything, like <code>object</code> in Python (or <code>Object</code> in Java, if you ignore unboxed types). Everything is a top and, therefore, knowing that something is a top tells you nothing at all. Because OCaml doesn&rsquo;t allow downcasting, there&rsquo;s not much you could do with a top in OCaml anyway.</p>

<p><em>Bottom</em> is a sub-type of everything. A value of type bottom can be used as an int, a widget, a yes/no enum, etc. Needless to say, instances of this type don&rsquo;t actually exist.</p>

<p>Although OCaml doesn&rsquo;t have a bottom type, it achieves the same effect with polymorphism.
For example, the result of these expressions can be used as any type you like:</p>

<ul>
  <li><code>exit 1</code> (exits the program)</li>
  <li><code>failwith msg</code> (throws an exception)</li>
  <li><code>let rec loop () = loop () in loop ()</code> (infinite loop)</li>
  <li><code>Obj.magic x</code> (unsafe cast; program may segfault if you get it wrong!)</li>
</ul>

<p>So, this code compiles fine, even though we use <code>bot</code> as an <code>int</code> and as a <code>string</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">bot</span> <span class="o">=</span> <span class="n">exit</span> <span class="mi">1</span> <span class="k">in</span>
</span><span class="line">  <span class="k">let</span> <span class="n">x</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">bot</span> <span class="k">in</span>
</span><span class="line">  <span class="k">let</span> <span class="n">y</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="n">bot</span> <span class="k">in</span>
</span><span class="line">  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;x = %d, y = %s&quot;</span> <span class="n">x</span> <span class="n">y</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2>Polymorphism</h2>

<p>If you treat OCaml like Java then things mostly work fine; you just end up doing a lot of explicit casting. However, where Java uses implicit upcasts, OCaml generally prefers using <em>(parametric) polymorphism</em>.</p>

<p>A polymorphic value doesn&rsquo;t have a single concrete type. Instead, it can take on many different types as needed.
For example, the OCaml function <code>Queue.create</code> can create queues of ints, queues of strings, etc. Its type is <code>unit -&gt; 'a Queue.t</code>, where <code>'a</code> is a <em>type variable</em>. When you want to use this function, you can use any type (e.g. <code>int</code> or <code>string</code>) as the value of <code>'a</code>, to get a function that makes queues of ints or queues of strings, as needed.</p>

<p>Note that unlike e.g. C++ templates, using polymorphism does not create any extra code. There is only ever one <code>Queue.create</code> function compiled into your binary, not one for each type you use. The same generic code works for queues of ints and queues of strings.</p>

<p>In Java, upcasting types is implicit, while using polymorphism (generics) requires extra annotations. In OCaml, it&rsquo;s the other way around. Polymorphism is implicit, while upcasting requires annotations. So, in Java:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">items</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span><span class="line"><span class="n">items</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
</span><span class="line"><span class="n">items</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;world&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>&lt;String&gt;</code> parts show where we convert a generic type (list of X) to a concrete type (list of String). In OCaml, this happens implicitly:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">items</span> <span class="o">=</span> <span class="k">new</span> <span class="n">linked_list</span> <span class="k">in</span>
</span><span class="line"><span class="n">items</span><span class="o">#</span><span class="n">add</span> <span class="s2">&quot;hello&quot;</span><span class="o">;</span>
</span><span class="line"><span class="n">items</span><span class="o">#</span><span class="n">add</span> <span class="s2">&quot;world&quot;</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>(Note: I used a made-up <code>linked_list</code> class rather than <code>Queue</code> to keep this example similar to the Java)</p>

<p>This saves a lot of typing, which is good, but it also makes it far harder to understand what&rsquo;s going on.
The way I think of it, OCaml adds type variables at certain points in the code and then uses type inference to work out what they are.
So in this case, we have (note: this is not valid OCaml syntax):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">items</span> <span class="o">=</span> <span class="k">new</span> <span class="n">linked_list</span><span class="o">&lt;</span><span class="n">t</span><span class="o">&gt;</span> <span class="k">in</span>
</span><span class="line"><span class="n">items</span><span class="o">#</span><span class="n">add</span> <span class="s2">&quot;hello&quot;</span><span class="o">;</span>
</span><span class="line"><span class="n">items</span><span class="o">#</span><span class="n">add</span> <span class="s2">&quot;world&quot;</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then OCaml infers that <code>type t = string</code>.</p>

<h3>Polymorphic objects</h3>

<p>The problem with our <code>close_window</code> function in the subtyping section was that we gave it a fixed concrete type (<code>window -&gt; unit</code>):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">close_window</span> <span class="o">(</span><span class="n">w</span><span class="o">:</span><span class="n">window</span><span class="o">)</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="n">w</span><span class="o">#</span><span class="n">close</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If we give it a polymorphic type then there&rsquo;s no problem:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">close_window_poly</span> <span class="o">(</span><span class="n">w</span><span class="o">:#</span><span class="n">window</span><span class="o">)</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="n">w</span><span class="o">#</span><span class="n">close</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">dialog</span> <span class="k">in</span>
</span><span class="line">  <span class="n">close_window_poly</span> <span class="n">d</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here, <code>#window</code> means any type with at least the methods of <code>window</code> (not to be confused with <code>w#close</code>, which is a method call, not a type). The syntax is a bit confusing because OCaml hides the type variable by default. If you wanted to declare the type of <code>close_window_poly</code> explicitly, you&rsquo;d have to make the type variable explicit using <code>as</code>. For comparison, here are the types of the two versions:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">type</span> <span class="n">window_closer</span> <span class="o">=</span> <span class="n">window</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span><span class="line"><span class="k">type</span> <span class="k">'</span><span class="n">a</span> <span class="n">closer</span> <span class="o">=</span> <span class="o">(#</span><span class="n">window</span> <span class="k">as</span> <span class="k">'</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Thus the type <code>window closer</code> is the type of functions that close a <code>window</code>, while <code>dialog closer</code> is the type of functions that close a <code>dialog</code>. OCaml will automatically apply the appropriate type at compile time.</p>

<p>As OCaml will infer polymorphic types automatically, we can define and call the function without any type annotations at all:</p>

<pre><code># let close_window_inf w = w#close;;
val close_window_inf : &lt; close : 'a; .. &gt; -&gt; 'a = &lt;fun&gt;
# close_window_inf d;;
</code></pre>

<p>Here is yet more new syntax! OCaml didn&rsquo;t infer that this requires a <code>#window</code>, only that it requires something with a suitable <code>close</code> method. Also, it couldn&rsquo;t infer that <code>close</code> must return <code>unit</code>, so it left the return type generic as <code>'a</code>. </p>

<p>The <code>..</code> indicates more polymorphism, with another hidden type variable. If we wanted to define the type for this function, it would be:</p>

<pre><code>type ('a, 'b) closer2 = (&lt; close : 'a; .. &gt; as 'b) -&gt; 'a
</code></pre>

<p>This is the polymorphic type for functions which take objects of type <code>'b</code>, where <code>'b</code> includes a <code>close</code> method that returns an <code>'a</code>, and return an <code>'a</code>.</p>

<p>For example, the original <code>close_window</code> function has the type <code>(unit, window) closer2</code>.</p>

<p>What all this means is that defining objects and functions without explicit types usually works fine, but if you later try to add type annotations (e.g. by declaring an interface for your module in an <code>.mli</code> file) then you&rsquo;re likely to remove the polymorphism accidentally unless you&rsquo;re careful. If you don&rsquo;t understand what happened, you&rsquo;ll end up doing a load of explicit casting to make things work again.</p>

<p>A good way around this is to use <code>ocamlc -i</code> to generate an initial <code>.mli</code> file with all the inferred types, with all the polymorphism still there.</p>

<p>In another bit of inconsistent syntax, when defining a class type you need to put the type parameter in brackets, but you don&rsquo;t when declaring an object type:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="c">(* An object with a &quot;get&quot; method returning an 'a *)</span>
</span><span class="line"><span class="k">type</span> <span class="k">'</span><span class="n">a</span> <span class="n">poly_type</span> <span class="o">=</span> <span class="o">&lt;</span>
</span><span class="line">  <span class="n">get</span> <span class="o">:</span> <span class="k">'</span><span class="n">a</span>
</span><span class="line"><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="c">(* A class type with a &quot;get&quot; method *)</span>
</span><span class="line"><span class="k">class</span> <span class="k">type</span> <span class="o">[</span><span class="k">'</span><span class="n">a</span><span class="o">]</span> <span class="n">poly_class</span> <span class="o">=</span>
</span><span class="line">  <span class="k">object</span>
</span><span class="line">    <span class="k">method</span> <span class="n">get</span> <span class="o">:</span> <span class="k">'</span><span class="n">a</span>
</span><span class="line">  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>(see my previous <a href="http://roscidus.com/blog/blog/2013/09/28/ocaml-objects/">Experiences With OCaml Objects</a> post for more on objects and classes)</p>

<h3>Polymorphic variants</h3>

<p>The situation with variants (enums) is similar. Let&rsquo;s start with some non-polymorphic code:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">paint_sky</span> <span class="o">(</span><span class="n">colour</span> <span class="o">:</span> <span class="o">[</span> <span class="o">`</span><span class="n">blue</span> <span class="o">|</span> <span class="o">`</span><span class="n">black</span> <span class="o">])</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">colour</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">blue</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A clear blue sky&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">black</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A dark black sky&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">paint_balloon</span> <span class="o">(</span><span class="n">colour</span> <span class="o">:</span> <span class="o">[`</span><span class="n">blue</span> <span class="o">|</span> <span class="o">`</span><span class="n">black</span> <span class="o">|</span> <span class="o">`</span><span class="n">red</span> <span class="o">])</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">colour</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">black</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A black balloon&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">blue</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A blue balloon&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">red</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A red balloon&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">draw_scene</span> <span class="o">(</span><span class="n">colour</span> <span class="o">:</span> <span class="o">[`</span><span class="n">blue</span> <span class="o">|</span> <span class="o">`</span><span class="n">black</span><span class="o">])</span> <span class="o">=</span>
</span><span class="line">  <span class="n">paint_sky</span> <span class="n">colour</span><span class="o">;</span>
</span><span class="line">  <span class="n">paint_balloon</span> <span class="n">colour</span>	<span class="c">(* Error *)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<pre><code>Error: This expression has type [ `black | `blue ]
       but an expression was expected of type [ `black | `blue | `red ]
       The first variant type does not allow tag(s) `red
</code></pre>

<p>Again, if you&rsquo;re expecting subtyping behaviour then this is confusing. If we can draw a balloon blue, black or red, why can&rsquo;t we draw it blue or black? Again, we can use an upcast (which is checked by the compiler and is entirely type-safe):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">draw_scene</span> <span class="o">(</span><span class="n">colour</span> <span class="o">:</span> <span class="o">[`</span><span class="n">blue</span> <span class="o">|</span> <span class="o">`</span><span class="n">black</span><span class="o">])</span> <span class="o">=</span>
</span><span class="line">  <span class="n">paint_sky</span> <span class="n">colour</span><span class="o">;</span>
</span><span class="line">  <span class="n">paint_balloon</span> <span class="o">(</span><span class="n">colour</span> <span class="o">:&gt;</span> <span class="o">[`</span><span class="n">blue</span> <span class="o">|</span> <span class="o">`</span><span class="n">black</span> <span class="o">|</span> <span class="o">`</span><span class="n">red</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As before, OCaml generally expects you to use polymorphism instead. There&rsquo;s more new syntax for this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">paint_balloon</span> <span class="o">(</span><span class="n">colour</span> <span class="o">:</span> <span class="o">[&lt;</span> <span class="o">`</span><span class="n">blue</span> <span class="o">|</span> <span class="o">`</span><span class="n">black</span> <span class="o">|</span> <span class="o">`</span><span class="n">red</span> <span class="o">])</span> <span class="o">=</span>
</span><span class="line">  <span class="k">match</span> <span class="n">colour</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">black</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A black balloon&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">blue</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A blue balloon&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">red</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A red balloon&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here <code>[&lt; `blue | `black | `red ]</code> means all subtypes of <code>[ `blue | `black | `red ]</code>. The <code>&lt;</code> introduces another hidden type variable. If you wanted to define a type for this function explicitly, you could do it with:</p>

<pre><code>type 'a balloon_painter = ([&lt;`blue | `black | `red ] as 'a) -&gt; unit
</code></pre>

<p>Instead of <code>&lt;</code>, there&rsquo;s also <code>&gt;</code>, which means the variant must have <em>at least</em> the given elements.</p>

<p>As before, just removing the type annotations and letting OCaml infer the polymorphic type is easy:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">paint_balloon</span> <span class="o">=</span> <span class="k">function</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">black</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A black balloon&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">blue</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A blue balloon&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">red</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;A red balloon&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2>Example : a polymorphic dialog box</h2>

<p>Here&rsquo;s a neat polymorphic dialog box (based on lablgtk&rsquo;s GTK bindings):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>dialog.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">class</span> <span class="k">type</span> <span class="o">[</span><span class="k">'</span><span class="n">a</span><span class="o">]</span> <span class="n">dialog</span> <span class="o">=</span>
</span><span class="line">  <span class="k">object</span>
</span><span class="line">    <span class="k">constraint</span> <span class="k">'</span><span class="n">a</span> <span class="o">=</span> <span class="o">[&gt;</span> <span class="o">`</span><span class="n">close</span><span class="o">]</span>
</span><span class="line">    <span class="k">method</span> <span class="n">add_button</span> <span class="o">:</span> <span class="n">label</span><span class="o">:</span><span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">code</span><span class="o">:</span><span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span><span class="line">    <span class="k">method</span> <span class="n">get_response</span> <span class="o">:</span> <span class="k">'</span><span class="n">a</span>
</span><span class="line">  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>prog.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">run_dialog</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Dialog</span><span class="p">.</span><span class="n">dialog</span> <span class="k">in</span>
</span><span class="line">  <span class="n">d</span><span class="o">#</span><span class="n">add_button</span> <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Delete&quot;</span> <span class="o">~</span><span class="n">code</span><span class="o">:`</span><span class="n">delete</span><span class="o">;</span>
</span><span class="line">  <span class="k">match</span> <span class="n">d</span><span class="o">#</span><span class="n">get_response</span> <span class="k">with</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">delete</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;Deleting...&quot;</span>
</span><span class="line">  <span class="o">|</span> <span class="o">`</span><span class="n">close</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;Aborted&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>OCaml will automatically infer <code>'a</code> as <code>[`close | `delete]</code> - a dialog with close and delete responses.
OCaml will force you to handle every response code, so you can&rsquo;t add a button but forget to handle it!
The <code>constraint 'a = [&gt; `close]</code> line forces you to handle the <code>close</code> response in all cases (because the user could always just close the window).</p>

<p>For another example, see my earlier post 
<a href="http://roscidus.com/blog/blog/2013/08/31/option-handling-with-ocaml-polymorphic-variants/">Option Handling With OCaml Polymorphic Variants</a>.</p>

<h2>Other issues</h2>

<h3>Monomorphic types</h3>

<p>There&rsquo;s a subtle but important distinction between <em>polymorphic types</em> (which can be used to generate many concrete types) and <em>monomorphic types</em> (which OCaml uses to mean a single type that is currently undecided). Monomorphic types only occur while OCaml is still working out the types, so you&rsquo;ll only see them in compiler error messages or in the interactive toplevel. They look like regular type variables but start with an underscore. e.g.</p>

<pre><code># let x = [];;
val x : 'a list = []

# let y = ref None;;
val y : '_a option ref = {contents = None}
</code></pre>

<p>Here, <code>x</code> has a polymorphic type (using <code>'a</code>). It can be used as an empty list of ints, or as an empty list of strings, or both. Every time you use <code>x</code>, you get to pick a type for it.</p>

<p><code>y</code> has a monomorphic type (using <code>'_a</code>). It can be used as a mutable container of ints, or of strings, but not both. As soon as OCaml sees it used with a concrete type, it will assign that type for it:</p>

<pre><code># let y = ref None;;
# y;;
- : '_a option ref = {contents = None}

# y := Some 3;;
# y := None;;
# y;;
- : int option ref = {contents = None}

# y := Some &quot;hello&quot;;;
Error: This expression has type string but an expression was expected of type int
</code></pre>

<p>Notice that the second time we print <code>y</code>, OCaml has worked out the concrete type.</p>

<p>Note: The term &ldquo;weakly polymorphic&rdquo; seems to be used as an alias for &ldquo;monomorphic&rdquo; in some OCaml documentation.</p>

<h3>Partial application loses polymorphism</h3>

<p>Partially-applied functions lose their polymorphism. Consider:</p>

<pre><code># let p1 = Printf.fprintf;;
val p1 : out_channel -&gt; ('a, out_channel, unit) format -&gt; 'a = &lt;fun&gt;

# let p2 = Printf.fprintf stdout;;
val p2 : ('_a, out_channel, unit) format -&gt; '_a = &lt;fun&gt;

# let p3 fmt = Printf.fprintf stdout fmt;;
val p3 : ('a, out_channel, unit) format -&gt; 'a = &lt;fun&gt;
</code></pre>

<p><code>fprintf</code> is a polymorphic function. It takes an output channel, a format string (with a polymorphic type) and values of the appropriate type. <code>p1</code> retains the polymorphic type.
However, <code>p2</code>, which partially applies the function to <code>stdout</code>, has a monomorphic type (<code>'_a</code>). You could use <code>p2</code> to print a string, or to print an int, but you couldn&rsquo;t use it twice to do both.
<code>p3</code>, which just makes the format argument explicit, is polymorphic again!</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">p1</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="k">in</span>
</span><span class="line"><span class="k">let</span> <span class="n">p2</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">stdout</span> <span class="k">in</span>
</span><span class="line"><span class="k">let</span> <span class="n">p3</span> <span class="n">fmt</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">stdout</span> <span class="n">fmt</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line"><span class="n">p1</span> <span class="n">stdout</span> <span class="s2">&quot;%d&quot;</span> <span class="mi">3</span><span class="o">;</span>
</span><span class="line"><span class="n">p1</span> <span class="n">stdout</span> <span class="s2">&quot;%s&quot;</span> <span class="s2">&quot;Hello&quot;</span><span class="o">;</span>	<span class="c">(* OK *)</span>
</span><span class="line">
</span><span class="line"><span class="n">p2</span> <span class="s2">&quot;%d&quot;</span> <span class="mi">3</span><span class="o">;</span>
</span><span class="line"><span class="n">p2</span> <span class="s2">&quot;%s&quot;</span> <span class="s2">&quot;Hello&quot;</span><span class="o">;</span>  <span class="c">(* Error *)</span>
</span><span class="line">
</span><span class="line"><span class="n">p3</span> <span class="s2">&quot;%d&quot;</span> <span class="mi">3</span><span class="o">;</span>
</span><span class="line"><span class="n">p3</span> <span class="s2">&quot;%s&quot;</span> <span class="s2">&quot;Hello&quot;</span><span class="o">;</span>  <span class="c">(* OK! *)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>So, what&rsquo;s going on here?
The <a href="http://caml.inria.fr/resources/doc/faq/core.en.html">OCaml FAQ</a> explains what to do about it (use <code>p3</code>), but doesn&rsquo;t explain why.
As <code>fprintf</code> has a really complicated type, let&rsquo;s switch to a simpler example:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">logged_id</span> <span class="n">msg</span> <span class="n">x</span> <span class="o">=</span>
</span><span class="line">  <span class="n">print_endline</span> <span class="n">msg</span><span class="o">;</span>
</span><span class="line">  <span class="n">x</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">logged_id</span> <span class="k">in</span>
</span><span class="line">  <span class="k">let</span> <span class="n">i2</span> <span class="o">=</span> <span class="n">logged_id</span> <span class="s2">&quot;called&quot;</span> <span class="k">in</span>
</span><span class="line">  <span class="k">let</span> <span class="n">i3</span> <span class="n">x</span> <span class="o">=</span> <span class="n">logged_id</span> <span class="s2">&quot;called&quot;</span> <span class="n">x</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">i1</span> <span class="s2">&quot;called&quot;</span> <span class="mi">1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">);</span>
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">i1</span> <span class="s2">&quot;called&quot;</span> <span class="s2">&quot;hi&quot;</span> <span class="o">=</span> <span class="s2">&quot;hi&quot;</span><span class="o">);</span>	<span class="c">(* OK *)</span>
</span><span class="line">
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">i2</span> <span class="mi">1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">);</span>
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">i2</span> <span class="s2">&quot;hi&quot;</span> <span class="o">=</span> <span class="s2">&quot;hi&quot;</span><span class="o">);</span>	<span class="c">(* Error! *)</span>
</span><span class="line">
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">i3</span> <span class="mi">1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">);</span>
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">i3</span> <span class="s2">&quot;hi&quot;</span> <span class="o">=</span> <span class="s2">&quot;hi&quot;</span><span class="o">);</span>	<span class="c">(* OK *)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>logged_id msg x</code> prints the message and then just returns <code>x</code>.</p>

<p>The polymorphism is lost in <code>i2</code> because OCaml doesn&rsquo;t know, from the type of <code>logged_id</code>, whether partially applying it will create any mutable state. Consider:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">logged_mem</span> <span class="n">msg</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span> <span class="k">in</span>
</span><span class="line">  <span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="n">print_endline</span> <span class="n">msg</span><span class="o">;</span>
</span><span class="line">    <span class="k">match</span> <span class="o">!</span><span class="n">prev</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">prev</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="n">x</span><span class="o">;</span> <span class="n">x</span>
</span><span class="line">    <span class="o">|</span> <span class="nc">Some</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>When <code>logged_mem</code> is partially applied, it creates a mutable cell and returns a function that remembers the first value it is called with and always returns that.
The result of <code>logged_mem &quot;called&quot;</code> cannot be polymorphic: it must always be called with the same argument type. Yet <code>logged_mem</code> has the same type as <code>logged_id</code> (<code>string -&gt; 'a -&gt; 'a</code>), so OCaml can&rsquo;t distinguish the two cases.</p>

<p>OCaml assumes that every function call potentially creates mutable state. Therefore, the result of calling a function is never polymorphic. Normally that&rsquo;s what you want, but it can be surprising in the case of partial functions. The solution (<code>i3</code>) is to avoid partial application and do a complete fresh invocation each time.</p>

<p>There are actually some cases where OCaml can turn a monomorphic result type back into a polymorphic one. For example:</p>

<pre><code># let make_empty () = [];;
val make_empty : unit -&gt; 'a list = &lt;fun&gt;

# let x = make_empty ();;
val x : 'a list = []
</code></pre>

<p>Here, <code>x</code> gets a polymorphic type despite being the result of a function call.
See <a href="http://caml.inria.fr/pub/papers/garrigue-value_restriction-fiwflp04.pdf">Relaxing the Value Restriction</a> for how it does that.</p>

<h3>Universal qualification</h3>

<p>This surprised me at first:</p>

<pre><code># let id = fun x -&gt; x;;
val id : 'a -&gt; 'a = &lt;fun&gt;

# let id2 : ('a -&gt; 'a) = fun x -&gt; x + 1;;
val id2 : int -&gt; int = &lt;fun&gt;
</code></pre>

<p>OCaml tells us that the identity function <code>id</code> has the type <code>'a -&gt; 'a</code>. OK. Then I declare another function with the same type, and OCaml tells me its type is <code>int -&gt; int</code>!</p>

<p>OCaml is hiding part of the type! The real type of the identity function is <code>'a. 'a -&gt; 'a</code> (given <code>'a</code>, the type is <code>'a -&gt; 'a</code>). Using this full type, we get the expected error:</p>

<pre><code># let id : 'a. 'a -&gt; 'a = fun x -&gt; x;;
val id : 'a -&gt; 'a = &lt;fun&gt;

# let id2 : 'a. 'a -&gt; 'a = fun x -&gt; x + 1;;
Error: This definition has type int -&gt; int which is less general than
         'a. 'a -&gt; 'a
</code></pre>

<p>The input to the polymorphic type expression (the <code>'a.</code> bit) can only go at the start of a type expression in OCaml. That means that you can&rsquo;t write a function that takes a polymorphic function as an argument. For example:</p>

<pre><code># let use_id (id : 'a. 'a -&gt; 'a) =
    assert (id 3 = 3);
    assert (id &quot;hi&quot; = &quot;hi&quot;) ;;
Error: Syntax error: type expected.
</code></pre>

<p>However, you can put them in object method and record field types:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">type</span> <span class="n">id_holder</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">  <span class="n">id</span> <span class="o">:</span> <span class="k">'</span><span class="n">a</span><span class="o">.</span> <span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">a</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">use_id</span> <span class="n">id_holder</span> <span class="o">=</span>
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">id_holder</span><span class="o">.</span><span class="n">id</span> <span class="mi">3</span> <span class="o">=</span> <span class="mi">3</span><span class="o">);</span>
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">id_holder</span><span class="o">.</span><span class="n">id</span> <span class="s2">&quot;hi&quot;</span> <span class="o">=</span> <span class="s2">&quot;hi&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Or:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">class</span> <span class="k">type</span> <span class="n">id_class</span> <span class="o">=</span>
</span><span class="line">  <span class="k">object</span>
</span><span class="line">    <span class="k">method</span> <span class="n">id</span> <span class="o">:</span> <span class="k">'</span><span class="n">a</span><span class="o">.</span> <span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">a</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">use_id</span> <span class="o">(</span><span class="n">id_obj</span><span class="o">:</span><span class="n">id_class</span><span class="o">)</span> <span class="o">=</span>
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">id_obj</span><span class="o">#</span><span class="n">id</span> <span class="mi">3</span> <span class="o">=</span> <span class="mi">3</span><span class="o">);</span>
</span><span class="line">  <span class="k">assert</span> <span class="o">(</span><span class="n">id_obj</span><span class="o">#</span><span class="n">id</span> <span class="s2">&quot;hi&quot;</span> <span class="o">=</span> <span class="s2">&quot;hi&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>So, you may have to wrap some things up in objects or records. If you use this in a method type, make sure you declare the type of the object you&rsquo;re creating. Otherwise, OCaml will infer the wrong type (it will assume that <code>'a</code> is scoped to the whole object, not a single method):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">class</span> <span class="k">type</span> <span class="n">id_class</span> <span class="o">=</span>
</span><span class="line">  <span class="k">object</span>
</span><span class="line">    <span class="k">method</span> <span class="n">id</span> <span class="o">:</span> <span class="k">'</span><span class="n">a</span><span class="o">.</span> <span class="k">'</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">'</span><span class="n">a</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">make_id_obj</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">object</span>
</span><span class="line">    <span class="k">method</span> <span class="n">id</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">id_obj</span> <span class="o">:</span> <span class="n">id_class</span> <span class="o">=</span> <span class="n">make_id_obj</span> <span class="bp">()</span>	 <span class="c">(* Error *)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<pre><code>Error: This expression has type &lt; id : 'a -&gt; 'a &gt;
       but an expression was expected of type id_class
       The universal variable 'a0 would escape its scope
</code></pre>

<p>You have to give the type at the point where you define the object:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">make_id_obj</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">object</span> <span class="o">(</span><span class="n">self</span> <span class="o">:</span> <span class="n">id_class</span><span class="o">)</span>
</span><span class="line">    <span class="k">method</span> <span class="n">id</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
</span><span class="line">  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>Polymorphism in module signatures</h3>

<p>When you define a module, you can (optionally) write an <code>.mli</code> file giving it a more limited public interface.
In this interface, you can make types abstract, only expose certain functions, etc. 
If you include a value with concrete type, the signature must be the same in the module and in the interface.
But when your module contains polymorphic values, you are allowed to limit the polymorphism in the module signature. For example:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>test.mli </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">val</span> <span class="n">close_window</span> <span class="o">:</span> <span class="o">#</span><span class="n">dialog</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>test.ml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">close_window</span> <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">#</span><span class="n">close</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">window</span> <span class="k">in</span>
</span><span class="line">  <span class="n">close_window</span> <span class="n">w</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Inside the module, <code>close_window</code> will close anything with a <code>close</code> method and return whatever it returns.
But outside the module, <code>close_window</code> can only close subclasses of <code>dialog</code> (and always returns unit).</p>

<h2>Cheat-sheet</h2>

<p>Some concrete types:</p>

<table class="table">
  <thead>
    <tr>
      <th>Type expression</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int list</code></td>
      <td>a list of integers</td>
    </tr>
    <tr>
      <td><code>int -&gt; int</code></td>
      <td>a function that takes an <code>int</code> and returns an <code>int</code></td>
    </tr>
    <tr>
      <td><code>widget</code></td>
      <td>the concrete type <code>widget</code> exactly</td>
    </tr>
    <tr>
      <td><code>&lt;close : unit&gt;</code></td>
      <td>an object type with a single <code>close</code> method</td>
    </tr>
    <tr>
      <td><code>[`red|`green]</code></td>
      <td>the variant type &ldquo;red or green&rdquo;</td>
    </tr>
  </tbody>
</table>

<p>Some polymorphic types (supplying the type parameter <code>'a</code> will produce some concrete type):</p>

<table class="table">
  <thead>
    <tr>
      <th>Type expression</th>
      <th>Can produce types for&hellip;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>'a list</code></td>
      <td>any list of items, each of the same type</td>
    </tr>
    <tr>
      <td><code>'a -&gt; 'a</code></td>
      <td>any function that returns something of the same type as its input</td>
    </tr>
    <tr>
      <td><code>(#widget as 'a)</code></td>
      <td>any type that includes all the methods of <code>widget</code></td>
    </tr>
    <tr>
      <td><code>(&lt;close : unit; ..&gt; as 'a)</code></td>
      <td>any type with at least a <code>close : unit</code> method</td>
    </tr>
    <tr>
      <td><code>([&lt; `red|`green] as 'a)</code></td>
      <td>any variant with some subset of <code>red</code> and <code>green</code> as options</td>
    </tr>
    <tr>
      <td><code>([&gt; `red|`green] as 'a)</code></td>
      <td>any variant with some superset of <code>red</code> and <code>green</code> as options</td>
    </tr>
  </tbody>
</table>

<p>You can omit the <code>as 'a</code> bits, unless you need to refer to <code>'a</code> somewhere else.</p>

<h2>Summary</h2>

<p>Java uses subtyping by default (automatically), with extra syntax for using generics (polymorphism). OCaml uses polymorphism by default, with extra syntax for using subtypes. Polymorphism is powerful, but can be confusing. If you allow OCaml to infer types, it will infer polymorphic types automatically and everything should work, but you&rsquo;ll want to understand polymorphism when you come to writing module signatures and you need to write out the types.</p>

<p>When the compiler and the interactive OCaml interpreter display polymorphic types, they frequently omit the type variables, which can make learning OCaml more difficult. Polymorphic object types, class types and variants all use different syntax to indicate polymorphism, which can also be confusing.</p>

<p>OCaml uses &ldquo;monomorphic type&rdquo; to mean a single (non-polymorphic) type which has not yet been inferred. Monomorphic types occur when you create mutable state or call functions (which may create mutable state internally). This explains why partially applying a function loses its polymorphism.</p>

<p>OCaml does not allow functions that take polymorphic arguments (arguments that remain polymorphic within the function, rather than being resolved to a particular concrete type when the function is called). However, you can work around this using record or object types.</p>

<p>When defining a module&rsquo;s signature (its external API), you can&rsquo;t change concrete types but you can expose less polymorphism in polymorphic types if you want.</p>
<a onclick="switchContent('ocamlorg-post80','ocamlorg-post79')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2013/12/20/polymorphism-for-beginners/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2013/12/20/polymorphism-for-beginners/">by Thomas Leonard at Dec 20, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/mirage-1.0.3-released">
    <a name="#http://openmirage.org/blog/mirage-1.0.3-released"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/mirage-1.0.3-released">Mirage 1.0.3 released; tutorial on building this website available</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post81">
      <p>We've had a lot of people trying out Mirage since the <a href="http://openmirage.org/blog/releasing-mirage">1.0 release</a> last week, and so we've been steadily cutting point releases and new libraries to OPAM as they're done.
The most common build error by far has been people using outdated OPAM packages.  Do make sure that you have at least <a href="http://opam.ocaml.org/doc/Quick_Install.html">OPAM 1.1</a> installed, and that you've run <code>opam update -u</code> to get the latest package lists from the <a href="https://github.com/ocaml/opam-repository">package repository</a>.</p>
<p><a href="https://github.com/mirage/mirage/releases/tag/1.0.3">Mirage 1.0.3</a> improves
Xen configuration generation, cleans up HTTP support, and adds support for FAT
filesystems.  Here are some of the libraries we've released this week to go along with it:</p>
<ul><li><a href="https://github.com/mirage/mirage-www">mirage-www</a> (update): the live website now runs on the 1.0 tools.  Explanation of how to build it in various configurations is available <a href="http://openmirage.org/wiki/mirage-www">here</a>.</li><li><a href="https://github.com/samoht/alcotest">alcotest</a> (new): a lightweight and colourful test framework built over <a href="http://ounit.forge.ocamlcore.org/">oUnit</a>.  The interface is simpler to facilitate writing tests quickly, and it formats test results nicely.</li><li><a href="https://github.com/mirage/mirage-block-xen">mirage-block-xen.1.0.0</a> (new): is the stable release of the Xen <code>Blkfront</code> driver fo&hellip;</li></ul><a onclick="switchContent('ocamlorg-post81','ocamlorg-post82')" class="btn planet-toggle" href="#http://openmirage.org/blog/mirage-1.0.3-released">Read more...</a></div><div id="ocamlorg-post82" style="display: none">
      <p>We've had a lot of people trying out Mirage since the <a href="http://openmirage.org/blog/releasing-mirage">1.0 release</a> last week, and so we've been steadily cutting point releases and new libraries to OPAM as they're done.
The most common build error by far has been people using outdated OPAM packages.  Do make sure that you have at least <a href="http://opam.ocaml.org/doc/Quick_Install.html">OPAM 1.1</a> installed, and that you've run <code>opam update -u</code> to get the latest package lists from the <a href="https://github.com/ocaml/opam-repository">package repository</a>.</p>
<p><a href="https://github.com/mirage/mirage/releases/tag/1.0.3">Mirage 1.0.3</a> improves
Xen configuration generation, cleans up HTTP support, and adds support for FAT
filesystems.  Here are some of the libraries we've released this week to go along with it:</p>
<ul><li><a href="https://github.com/mirage/mirage-www">mirage-www</a> (update): the live website now runs on the 1.0 tools.  Explanation of how to build it in various configurations is available <a href="http://openmirage.org/wiki/mirage-www">here</a>.</li><li><a href="https://github.com/samoht/alcotest">alcotest</a> (new): a lightweight and colourful test framework built over <a href="http://ounit.forge.ocamlcore.org/">oUnit</a>.  The interface is simpler to facilitate writing tests quickly, and it formats test results nicely.</li><li><a href="https://github.com/mirage/mirage-block-xen">mirage-block-xen.1.0.0</a> (new): is the stable release of the Xen <code>Blkfront</code> driver for block devices.  The library supports both frontend and backend operation, but only the frontend is plumbed through to Mirage for now (although the backend can be manually configured).</li><li><a href="https://github.com/mirage/mirage-block-unix">mirage-block-unix.1.2.0</a> (update): fixed some concurrency bugs and added support for buffered I/O to improve performance.</li><li><a href="https://github.com/mirage/ocaml-fat">fat-filesystem.0.10.0</a> (update): copies with more sector sizes, uses buffered I/O on Unix, and adds a <code>KV_RO</code> key/value interface as well as a more complicated filesystem one.</li><li><a href="https://github.com/mirage/mirage-fs-unix">mirage-fs-unix.1.0.0</a> (update): implements the <code>KV_RO</code> signature as a passthrough to a Unix filesystem.  This is convenient during development to avoid recompile cycles while changing data.</li><li><a href="https://github.com/mirage/mirage-platform">mirage-xen.1.0.0</a> (update): removed several distracting-but-harmless linker warnings about code bloat.</li><li><a href="https://github.com/mirage/ocaml-cohttp">cohttp.0.9.14</a> (update): supports Server-Side Events via better channel flushing, has a complete set of HTTP codes autogenerated from <a href="https://github.com/citricsquid/httpstatus.es">httpstatus.es</a> and exposes a platform-independent <code>Cohttp_lwt</code> module.</li><li><a href="https://github.com/mirage/ocaml-cow">cow.0.8.1</a> (update): switch to the <a href="https://github.com/pw374/omd">Omd</a> library for Markdown parsing, which is significantly more compatible with other parsers.</li><li><a href="https://github.com/samoht/ezjsonm">ezjsonm.0.2.0</a> (new): a combinator library to parse, select and manipulate JSON structures.</li><li><a href="https://github.com/avsm/ezxmlm">ezxmlm.1.0.0</a> (new): a combinator library to parse, select and transform XML tags and attributes.</li><li><a href="https://github.com/mirage/mirage-http-xen">mirage-http-xen</a> and <a href="https://github.com/mirage/mirage-http-unix">mirage-http-unix</a> provide the HTTP drivers on top of Cohttp for Mirage. Although they are very similar at the moment, they will diverge as the Unix variant gains options to use kernel sockets instead of only the network stack.</li></ul>

<p>We're making great progress on moving our personal homepages over to Mirage.  The first two introductory wiki posts are also now available:</p>
<ul><li><a href="http://openmirage.org/wiki/hello-world">Building a hello world example</a> takes you through the basic steps to build a Unix and Xen binary.</li><li><a href="http://openmirage.org/wiki/mirage-www">Building the Mirage website</a> lets you build this website with several variants, demonstrating the Unix passthrough filesystem, the OCaml FAT filesystem library, and how to attach a network stack to your application.</li></ul>

<p>As always, please feel free to report any issues via the <a href="https://github.com/mirage/mirage/issues">bug tracker</a> and ask questions on the <a href="mailto:mirageos-devel@lists.xenproject.org">mailing list</a>.</p>

   <a onclick="switchContent('ocamlorg-post82','ocamlorg-post81')" class="btn planet-toggle" href="#http://openmirage.org/blog/mirage-1.0.3-released">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/mirage-1.0.3-released">by Anil Madhavapeddy at Dec 19, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://openmirage.org/blog/announcing-mirage10">
    <a name="#http://openmirage.org/blog/announcing-mirage10"> </a>
    <h1 class="posttitle">
      <a href="http://openmirage.org/blog/announcing-mirage10">Mirage 1.0: not just a hallucination!</a>
      (<a href="http://openmirage.org/blog/atom.xml" title="The Mirage Blog">Mirage OS</a>)
    </h1>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post83">
      <p><em>First</em>: read the <a href="http://openmirage.org/wiki/overview-of-mirage">overview</a> and
<a href="http://openmirage.org/wiki/technical-background">technical background</a> behind the project.</p>
<p>When we started hacking on Mirage back in 2009, it started off looking like a
conventional OS, except written in OCaml.   The <a href="https://github.com/mirage/mirage/tree/old-master">monolithic
repository</a> contained all the
libraries and boot code, and exposed a big <code>OS</code> module for applications to use.
We used this to do several fun <a href="http://cufp.org/conference/sessions/2011/t3-building-functional-os">tutorials</a> at conferences
such as ICFP/CUFP and get early feedback.</p>
<p>As development continued though, we started to understand what it is we were
building: a <a href="http://anil.recoil.org/papers/2013-asplos-mirage.pdf">&quot;library operating system&quot;</a>.  As the number of libraries grew,
putting everything into one repository just wasn't scaling, and it made it hard
to work with third-party code.  We spent some time developing tools to make
Mirage fit into the broader OCaml ecosystem.</p>
<p>Three key things have emerged from this effort:</p>
<ul><li><a href="https://opam.ocaml.org">OPAM</a>, a source-based package manager for
 OCaml. It supports multiple simultaneous compiler installations, flexible
 package constraints, and a Git-friendly development workflow.  S&hellip;</li></ul><a onclick="switchContent('ocamlorg-post83','ocamlorg-post84')" class="btn planet-toggle" href="#http://openmirage.org/blog/announcing-mirage10">Read more...</a></div><div id="ocamlorg-post84" style="display: none">
      <p><em>First</em>: read the <a href="http://openmirage.org/wiki/overview-of-mirage">overview</a> and
<a href="http://openmirage.org/wiki/technical-background">technical background</a> behind the project.</p>
<p>When we started hacking on Mirage back in 2009, it started off looking like a
conventional OS, except written in OCaml.   The <a href="https://github.com/mirage/mirage/tree/old-master">monolithic
repository</a> contained all the
libraries and boot code, and exposed a big <code>OS</code> module for applications to use.
We used this to do several fun <a href="http://cufp.org/conference/sessions/2011/t3-building-functional-os">tutorials</a> at conferences
such as ICFP/CUFP and get early feedback.</p>
<p>As development continued though, we started to understand what it is we were
building: a <a href="http://anil.recoil.org/papers/2013-asplos-mirage.pdf">&quot;library operating system&quot;</a>.  As the number of libraries grew,
putting everything into one repository just wasn't scaling, and it made it hard
to work with third-party code.  We spent some time developing tools to make
Mirage fit into the broader OCaml ecosystem.</p>
<p>Three key things have emerged from this effort:</p>
<ul><li><a href="https://opam.ocaml.org">OPAM</a>, a source-based package manager for
 OCaml. It supports multiple simultaneous compiler installations, flexible
 package constraints, and a Git-friendly development workflow.  Since
 releasing 1.0 in March 2013 and 1.1 in October, the community has leapt
 in to contribute over 1800 packages in this short time.  All of the 
 Mirage libraries are now tracked using it, including the Xen libraries.</li><li>The build system for embedded programming (such as the Xen target) is
 a difficult one to get right.  After several experiments, Mirage provides
 a single <strong><a href="https://github.com/mirage/mirage">command-line tool</a></strong> that
 combines configuration directives (also written in OCaml) with OPAM to
 make building Xen unikernels as easy as Unix binaries.</li><li>All of the Mirage-compatible libraries satisfy a set of module type
 signatures in a <strong><a href="https://github.com/mirage/mirage-types/blob/master/lib/v1.mli">single file</a></strong>.
 This is where Mirage lives up to its name: we've gone from the early
 monolithic repository to a single, standalone interface file that
 describes the interfaces.  Of course, we also have libraries to go along
 with this signature, and they all live in the <a href="https://github.com/mirage">Mirage GitHub organization</a>.</li></ul>

<p>With these components, I'm excited to announce that Mirage 1.0 is finally ready
to see the light of day!  Since it consists of so many libraries, we've decided
not to have a &quot;big bang&quot; release where we dump fifty complex libraries on the
open-source community.  Instead, we're going to spend the month of December
writing a series of blog posts that explain how the core components work,
leading up to several use cases:</p>
<ul><li>The development team have all decided to shift our personal homepages to be Mirage
 kernels running on Xen as a little Christmas present to ourselves, so we'll work through that step-by-step how to build 
 a dedicated unikernel and maintain and deploy it (<strong>spoiler:</strong> see <a href="https://github.com/mirage/mirage-www-deployment">this repo</a>).  This will culminate in
 a webservice that our colleagues at <a href="http://horizon.ac.uk">Horizon</a> have been
 building using Android apps and an HTTP backend.</li><li>The <a href="http://xenserver.org">XenServer</a> crew at Citrix are using Mirage to build custom middlebox VMs
 such as block device caches.</li><li>For teaching purposes, the <a href="http://ocaml.io">Cambridge Computer Lab team</a> want a JavaScript backend,
 so we'll explain how to port Mirage to this target (which is rather different
 from either Unix or Xen, and serves to illustrate the portability of our approach).</li></ul>

<h3>How to get involved</h3>

<p>Bear with us while we update all the documentation and start the blog posts off
today (the final libraries for the 1.0 release are all being merged into OPAM
while I write this, and the usually excellent <a href="http://travis-ci.org">Travis</a> continuous integration system is down due to a <a href="https://github.com/travis-ci/travis-ci/issues/1727">bug</a> on their side).  I'll edit this post to contain links to the future posts
as they happen.</p>
<p>Since we're now also a proud Xen and Linux Foundation incubator project, our mailing
list is shifting to <a href="http://lists.xenproject.org/cgi-bin/mailman/listinfo/mirageos-devel">mirageos-devel@lists.xenproject.org</a>, and we very much
welcome comments and feedback on our efforts over there.
The <code>#mirage</code> channel on FreeNode IRC is also growing increasingly popular, as
is simply reporting issues on the main <a href="http://github.com/mirage/mirage">Mirage GitHub</a> repository.</p>
<p>Several people have also commented that they want to learn OCaml properly to
start using Mirage.  I've just co-published an O'Reilly book called
<a href="https://realworldocaml.org">Real World OCaml</a> that's available for free online
and also as hardcopy/ebook.  Our Cambridge colleague John Whittington has
also written an excellent <a href="http://ocaml-book.com/">introductory text</a>, and
you can generally find more resources <a href="http://ocaml.org/docs/">online</a>.
Feel free to ask beginner OCaml questions on our mailing lists and we'll help
as best we can!</p>

   <a onclick="switchContent('ocamlorg-post84','ocamlorg-post83')" class="btn planet-toggle" href="#http://openmirage.org/blog/announcing-mirage10">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://openmirage.org/blog/announcing-mirage10">by Anil Madhavapeddy at Dec 09, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/">
    <a name="#http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/tleonard.jpg" width="" height="70" alt="" />
    <h1 class="posttitle">
      <a href="http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/">Asynchronous Python vs OCaml</a>
      (<a href="http://roscidus.com/blog/atom.xml" title="Thomas Leonard's blog">Thomas Leonard</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post85"><p>I&rsquo;ve now migrated the asynchronous download logic in 0install from Python to OCaml + Lwt.
This post records my experiences using Lwt, plus some comparisons with Python&rsquo;s coroutines.
As usual, the examples will be based on the real-world case of 0install, rather than on idealised text-book examples.</p>



<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#the-problem">The problem</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#solutions">Solutions</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#callbacks">Callbacks</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#promises">Promises</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#ocaml-lwt">OCaml Lwt</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#python-generators">Python generators</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#examples">Examples</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#following-a-recipe">Following a recipe</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#downloading-with-libcurl">Downloading with libcurl</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#error-handling-in-key-look-ups">Error handling in key look-ups</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#failing-over-to-a-mirror">Failing over to a mirror</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#switches">Switches</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#parallel-tasks">Parallel tasks</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#conclusions">Conclusions</a></li>
</ul>

<h2>The problem</h2>

<p>What happens when you download a program using <a href="http://0install.net/">0install</a>? To make this concrete, let&rsquo;s look at the downloads that happen when you enter the command:</p>

<pre><code>$ 0launch http://simamo.de/0install/armagetronad.xml
</code></pre>

<p>to make this happen:</p>

<p><a href="http://armagetronad.org/"><img src="http://roscidus.com/blog/images/armagetron.png" class="border center"/></a></p>

<p>If the software is cached, we run immediately. If not, we need to download some things first. The steps are (you don&rsquo;t need to r&hellip;</p><a onclick="switchContent('ocamlorg-post85','ocamlorg-post86')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/">Read more...</a></div><div id="ocamlorg-post86" style="display: none"><p>I&rsquo;ve now migrated the asynchronous download logic in 0install from Python to OCaml + Lwt.
This post records my experiences using Lwt, plus some comparisons with Python&rsquo;s coroutines.
As usual, the examples will be based on the real-world case of 0install, rather than on idealised text-book examples.</p>



<p><strong>Table of Contents</strong></p>

<ul>
  <li><a href="http://roscidus.com/blog/atom.xml#the-problem">The problem</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#solutions">Solutions</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#callbacks">Callbacks</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#promises">Promises</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#ocaml-lwt">OCaml Lwt</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#python-generators">Python generators</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#examples">Examples</a>    <ul>
      <li><a href="http://roscidus.com/blog/atom.xml#following-a-recipe">Following a recipe</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#downloading-with-libcurl">Downloading with libcurl</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#error-handling-in-key-look-ups">Error handling in key look-ups</a></li>
      <li><a href="http://roscidus.com/blog/atom.xml#failing-over-to-a-mirror">Failing over to a mirror</a></li>
    </ul>
  </li>
  <li><a href="http://roscidus.com/blog/atom.xml#switches">Switches</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#parallel-tasks">Parallel tasks</a></li>
  <li><a href="http://roscidus.com/blog/atom.xml#conclusions">Conclusions</a></li>
</ul>

<h2>The problem</h2>

<p>What happens when you download a program using <a href="http://0install.net/">0install</a>? To make this concrete, let&rsquo;s look at the downloads that happen when you enter the command:</p>

<pre><code>$ 0launch http://simamo.de/0install/armagetronad.xml
</code></pre>

<p>to make this happen:</p>

<p><a href="http://armagetronad.org/"><img src="http://roscidus.com/blog/images/armagetron.png" class="border center"/></a></p>

<p>If the software is cached, we run immediately. If not, we need to download some things first. The steps are (you don&rsquo;t need to remember this!):</p>

<ol>
  <li>Download <a href="http://simamo.de/0install/armagetronad.xml">http://simamo.de/0install/armagetronad.xml</a>. This feed just points us at various sub-feeds that say where to get implementations for each platform.</li>
  <li>I&rsquo;m on Linux (64 bit), so on my computer we next download (concurrently) the four suggested sub-feeds:
    <ul>
      <li><a href="http://simamo.de/0install/armagetronad-experimental-Linux-x86_64.xml">http://simamo.de/0install/armagetronad-experimental-Linux-x86_64.xml</a></li>
      <li><a href="http://simamo.de/0install/armagetronad-alpha-Linux-x86_64.xml">http://simamo.de/0install/armagetronad-alpha-Linux-x86_64.xml</a></li>
      <li><a href="http://simamo.de/0install/armagetronad-beta-Linux-x86_64.xml">http://simamo.de/0install/armagetronad-beta-Linux-x86_64.xml</a></li>
      <li><a href="http://simamo.de/0install/armagetronad-stable-Linux-x86_64.xml">http://simamo.de/0install/armagetronad-stable-Linux-x86_64.xml</a></li>
    </ul>
  </li>
  <li>Once we have these, we find a dependency on the library <a href="http://simamo.de/0install/armagetronad-libs-Linux-x86_64.xml">http://simamo.de/0install/armagetronad-libs-Linux-x86_64.xml</a>, so we download that XML file too.</li>
  <li>Once all the XML downloads have finished, we select a version of Armagetron (0.2.8.3.2 in my case) and its (single) declared library (version 0.3-pre0.1570 here).</li>
  <li>We download these two tar.bz2 files (concurrently) and unpack them to the cache.</li>
  <li>Finally, we run (as described in previous posts).</li>
</ol>

<p>That&rsquo;s the overall process. It&rsquo;s not totally trivial, but in fact some of the steps are complex in themselves. For example, to download a single feed (XML) file:</p>

<ol>
  <li>We download the feed from the given URL.</li>
  <li>We check the GPG signature on the feed. If we don&rsquo;t have the GPG key, we must download that next.</li>
  <li>Once we&rsquo;ve checked that the signature is valid, we need to decide whether to trust it. We download information from the key information server.</li>
  <li>Depending on the user&rsquo;s configuration and the key information server&rsquo;s response, we may show a confirmation dialog to the user.</li>
</ol>

<p>In addition:</p>

<ol>
  <li>If the primary site (simamo.de) fails, we try the mirror site <a href="http://roscidus.com/0mirror/">http://roscidus.com/0mirror/</a> instead.</li>
  <li>If the primary site is slow, we ask the mirror too. If the primary then succeeds, we cancel the mirror download. If the mirror succeeds first, we use the information we got from it to find more required downloads, but also continue waiting for the primary (which may have more up-to-date information).</li>
  <li>If the key information server is slow, we display the dialog to the user anyway, but update the display if the information arrives while the user is pondering.</li>
  <li>We never use more than 2 HTTP connections per site at the same time. Further requests are queued.</li>
</ol>

<p>In other words, there&rsquo;s quite a bit of logic here (and there&rsquo;s still the archive downloads too&hellip;). How can we make sure all these operations happen at the right time and that errors are handled correctly?</p>

<h2>Solutions</h2>

<p>Note that the challenge here is not to use multiple CPUs in parallel to perform some calculation faster, but to schedule and manage multiple concurrent operations. The effects of concurrency will be visible (i.e. the behaviour of the code, such as whether we decide to contact the mirror server or not, depends on how quickly things happen). Therefore, some non-determinism is unavoidable. However, we want to minimise it.</p>

<p>Most languages provide some kind of low-level <em>preemptive multi-threading</em> support, e.g. Python&rsquo;s <code>threading.create</code>, Haskell&rsquo;s <code>forkIO</code>, OCaml&rsquo;s <code>Thread.create</code>, Java&rsquo;s <code>java.lang.Thread</code> and Go&rsquo;s <code>go</code>. In these cases, all threads always run in parallel by default. If two threads access a shared or global variable without appropriate locking, the program will occasionally fail in ways that are hard to reproduce or diagnose.</p>

<p>Of course, these languages provide mutexes, channels, etc to make correct code possible, but this style is unsafe by default. For example, if a multi-threaded program uses some library from multiple threads, and the author of the library was only thinking about single-threaded use, then you likely have a subtle, hard-to-trigger bug.</p>

<p>Let&rsquo;s consider a simplified example: we want to fetch information from the key information server, parse it, and confirm the key with the user (this server says things like &ldquo;This key belongs to a registered Debian developer&rdquo;).
Within each thread, we might do something like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">confirm_key</span><span class="p">(</span><span class="n">feed</span><span class="p">):</span>
</span><span class="line">	<span class="n">data</span> <span class="o">=</span> <span class="n">download_key_info</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>
</span><span class="line">	<span class="n">info</span> <span class="o">=</span> <span class="n">parse_key_info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class="line">	<span class="n">ok</span> <span class="o">=</span> <span class="n">confirm_with_gui</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="n">ok</span><span class="p">:</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Probably this code will crash if two keys are downloaded close together, because the graphical toolkit library used to show the GUI isn&rsquo;t thread-safe. But there could be similar issues with any code we call (is <code>parse_key_info</code> thread-safe, for example? What about the XML parser it uses? etc).</p>

<p>So how can we avoid these problems? Rust uses its linear types to prevent concurrent access to mutable state, which looks very useful. For other languages, we can use <em>cooperative multi-threading</em>.</p>

<p>The idea here is that instead of running threads in parallel by default and remembering to add locks wherever necessary, we run only one thread at a time, switching between threads only at explicitly marked points.</p>

<p>The two schemes have different failure modes. If you forget the locking in preemptive code, you get subtle bugs. If you forget to allow task switching in a cooperative system, the program may run slower (waiting when it could be getting on with something). For an application like 0install, cooperative makes far more sense. Just making downloads and GUI interaction alone concurrent is really all we need.</p>

<h3>Callbacks</h3>

<p>The simplest scheme to implement uses <em>callbacks</em>. You tell the system to start an operation, and give it a function to call on success:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">confirm_key</span><span class="p">(</span><span class="n">feed</span><span class="p">):</span>
</span><span class="line">	<span class="n">download_key_info</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="n">key_info_downloaded</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">key_info_downloaded</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class="line">	<span class="n">info</span> <span class="o">=</span> <span class="n">parse_key_info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class="line">	<span class="n">confirm_with_gui</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">trust_confirmed</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">trust_confirmed</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
</span><span class="line">	<span class="k">if</span> <span class="n">ok</span><span class="p">:</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here, we don&rsquo;t know what other functions may be called in the time between us calling <code>download_key_info</code> and the <code>key_info_downloaded</code> callback, but while our code is executing we know that we have complete control. For example, it&rsquo;s not a problem if <code>parse_key_info</code> here only supports single threading.</p>

<p>Callbacks have two major problems:</p>

<ul>
  <li>They make the code messy and hard to read.</li>
  <li>They handle exceptions poorly.</li>
</ul>

<p>Imagine that <code>download_key_info</code> has succeeded. It calls the <code>key_info_downloaded</code> callback. That calls <code>parse_key_info</code>, which throws an exception. The exception gets returned to <code>download_key_info</code> which can&rsquo;t do anything useful with it. Probably, it gets logged and the program hangs, waiting for a call to <code>trust_confirmed</code> that will never happen.</p>

<h3>Promises</h3>

<p><em>Promises</em> are a nice alternative to callbacks. When you start an operation, you get a <em>promise</em> for the result. A promise is a place-holder for a result that will arrive in the future. Without any special syntax, using promises might look something like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">confirm_key</span><span class="p">(</span><span class="n">feed</span><span class="p">):</span>
</span><span class="line">	<span class="n">data_promise</span> <span class="o">=</span> <span class="n">download_key_info</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>
</span><span class="line">	<span class="k">return</span> <span class="n">data_promise</span><span class="o">.</span><span class="n">when_fulfilled</span><span class="p">(</span><span class="n">key_info_downloaded</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">key_info_downloaded</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class="line">	<span class="n">info</span> <span class="o">=</span> <span class="n">parse_key_info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class="line">	<span class="n">confirmation_promise</span> <span class="o">=</span> <span class="n">confirm_with_gui</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</span><span class="line">	<span class="k">return</span> <span class="n">confirmation_promise</span><span class="o">.</span><span class="n">when_fulfilled</span><span class="p">(</span><span class="n">trust_confirmed</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">trust_confirmed</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
</span><span class="line">	<span class="k">if</span> <span class="n">ok</span><span class="p">:</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The function <code>promise.when_fulfilled(callback)</code> immediately returns a new promise for the (future) result of the callback.</p>

<p>Internally, a promise initially contains a queue for callbacks. When the promise is (eventually) resolved to a value, the callbacks are all run and the queue is replaced by the value. Attempting to attach any further callbacks just runs them immediately on the value.</p>

<p>Promises have a number of advantages over callbacks. For example, you can store promises of results in lists, pass them to other functions, etc. One particular advantage is exception handling. Consider our previous example:</p>

<ol>
  <li><code>confirm_key</code> returns a promise for the result of <code>key_info_downloaded</code>.</li>
  <li><code>download_key_info</code> downloads the data successfully, fulfilling <code>data_promise</code>.</li>
  <li><code>key_info_downloaded</code> is called (it was attached to <code>data_promise</code> as a callback).</li>
  <li><code>parse_key_info</code> throws an exception, which is caught by the promise system.</li>
  <li>This &ldquo;breaks&rdquo; the promise returned by <code>confirm_key</code>.</li>
  <li>Whoever was waiting for <code>confirm_key</code> gets notified of the exception.</li>
</ol>

<p>Notice that instead of propagating uncaught exceptions <em>backwards</em> (to <code>download_key_info</code>), we propagate them <em>forwards</em> (to whoever is waiting for the result). The result is that, as in synchronous programming, an exception is not lost just because someone in the chain doesn&rsquo;t handle it.</p>

<p>A natural next step is to introduce some simpler syntax for this&hellip;</p>

<h3>OCaml Lwt</h3>

<p>OCaml provides a couple of libraries for handling promises - <a href="http://ocsigen.org/lwt/">Lwt</a> and <a href="https://realworldocaml.org/v1/en/html/concurrent-programming-with-async.html">Jane Street&rsquo;s Async</a>. I&rsquo;ve only looked at Lwt, although they seem <a href="http://lists.ocaml.org/pipermail/wg-parallel/2013-April/000000.html">fairly similar</a>.</p>

<p>The terminology I introduced above I learnt from E (which also has <a href="http://www.erights.org/elib/concurrency/refmech.html">sophisticated distributed promises</a>). I find the E terms more natural, but here&rsquo;s a conversion table:</p>

<table class="table">
  <thead>
    <tr>
      <th>E term</th>
      <th>Lwt term</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Promise</td>
      <td>Thread</td>
    </tr>
    <tr>
      <td>Fulfilled promise</td>
      <td>Returned thread</td>
    </tr>
    <tr>
      <td>Broken promise</td>
      <td>Failed thread</td>
    </tr>
    <tr>
      <td>Unresolved promise</td>
      <td>Sleeping thread</td>
    </tr>
    <tr>
      <td>Resolver</td>
      <td>Waker</td>
    </tr>
  </tbody>
</table>

<p>In particular, while a Lwt thread is still working to produce a result, the thread is said to be &ldquo;sleeping&rdquo;, which I find rather awkward. A resolver/waker is the object used by the maker of the promise to resolve it.</p>

<p>Anyway, switching to OCaml and using Lwt without the syntax extensions, we get this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">confirm_key</span> <span class="n">feed</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">data_promise</span> <span class="o">=</span> <span class="n">download_key_info</span> <span class="n">feed</span><span class="o">.</span><span class="n">signature</span> <span class="k">in</span>
</span><span class="line">  <span class="nn">Lwt</span><span class="p">.</span><span class="n">bind</span> <span class="n">data_promise</span> <span class="o">(</span><span class="k">fun</span> <span class="n">data</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="n">info</span> <span class="o">=</span> <span class="n">parse_key_info</span> <span class="n">data</span> <span class="k">in</span>
</span><span class="line">    <span class="k">let</span> <span class="n">confirmation_promise</span> <span class="o">=</span> <span class="n">confirm_with_gui</span> <span class="n">feed</span> <span class="n">info</span> <span class="k">in</span>
</span><span class="line">    <span class="nn">Lwt</span><span class="p">.</span><span class="n">bind</span> <span class="n">confirmation_promise</span> <span class="o">(</span><span class="k">fun</span> <span class="n">ok</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="k">if</span> <span class="n">ok</span> <span class="k">then</span> <span class="o">...</span>
</span><span class="line">    <span class="o">)</span>
</span><span class="line">  <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here, <code>Lwt.bind promise callback</code> is like our previous <code>promise.when_fulfilled(callback)</code>. Again, <code>confirm_key</code> returns a promise (thread) for the final result.</p>

<p>To make things more convenient, you can enable the Lwt syntax extension. This provides thread-aware alternatives to several built-in OCaml keywords:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">confirm_key</span> <span class="n">feed</span> <span class="o">=</span>
</span><span class="line">  <span class="k">lwt</span> <span class="n">data</span> <span class="o">=</span> <span class="n">download_key_info</span> <span class="n">feed</span><span class="o">.</span><span class="n">signature</span> <span class="k">in</span>
</span><span class="line">  <span class="k">let</span> <span class="n">info</span> <span class="o">=</span> <span class="n">parse_key_info</span> <span class="n">data</span> <span class="k">in</span>
</span><span class="line">  <span class="k">lwt</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">confirm_with_gui</span> <span class="n">feed</span> <span class="n">info</span> <span class="k">in</span>
</span><span class="line">  <span class="k">if</span> <span class="n">ok</span> <span class="k">then</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As if by magic, our asynchronous code now reads like the original synchronous code! <code>lwt</code> is the new way to do <code>Lwt.bind</code>, by analogy with the ordinary <code>let</code> construct. We just have to remember that we give up control between evaluating the right-hand side of the assignment (getting a thread/promise for the data) and assigning the actual data on the left-hand side. For example, another function might change a global variable while we&rsquo;re waiting for the promise to resolve.</p>

<p><a href="http://ocsigen.org/lwt/api/Pa_lwt">The other short-cuts</a> are <code>try_lwt</code>, <code>for_lwt</code>, <code>while_lwt</code> and <code>match_lwt</code>, which do what you&rsquo;d expect. As a bonus, <code>try_lwt</code> also adds a <code>finally</code> construct and <code>for_lwt</code> adds iteration over sequences - both are missing for the core OCaml language.</p>

<p>There are plenty of functions for combining or creating threads in various ways, including:</p>

<ul>
  <li><code>let thread, waker = Lwt.wait ()</code> explicitly creates a promise and a resolver for it.</li>
  <li><code>Lwt.return value</code> evaluates to a returned thread, which is useful if something needs a thread type but you already have the value.</li>
  <li><code>Lwt.choose threads</code> waits until one of the given threads is ready.</li>
  <li><code>Lwt.join threads</code> returns a single thread that returns when all of the given threads have returned.</li>
  <li><code>Lwt_list.map_s fn items</code> applies <code>fn</code> to each item, waiting for the resulting thread to resolve before doing the next item.</li>
  <li><code>Lwt_list.map_p fn items</code> as above, but runs all the threads in parallel.</li>
</ul>

<h3>Python generators</h3>

<p>Python has an unusual solution to the problem, using its <em>generator functions</em>.</p>

<p>A generator is any function which contains a <code>yield</code>. Running such a function gets you an iterator. Each time you ask for a value from the iterator, the generator runs until the next <code>yield</code> to produce the result. It is suspended until the next call. Generators were originally just an easy way to produce sequences, for example:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">count</span><span class="p">():</span>
</span><span class="line">  <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">  <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class="line">    <span class="k">yield</span> <span class="n">x</span>
</span><span class="line">    <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">
</span><span class="line"><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">count</span><span class="p">():</span>
</span><span class="line">  <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>However, this ability to suspend and resume functions is obviously useful for cooperative multi-threading too and, like many other people, I used them to create a such a system (back in 2004). The version used in the Python version of 0install was designed for Python 2.3, but since then Python has added many useful new features so I&rsquo;ll describe the recent <a href="http://www.python.org/dev/peps/pep-3156/">Tulip/asyncio</a> system rather than my own, even though I haven&rsquo;t actually used it much.</p>

<p>The idea is that every time you need to wait, you yield the promise (&ldquo;future&rdquo; in Python terminology) you&rsquo;re waiting for. When it&rsquo;s ready, the scheduler will resume your generator function with the result:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">confirm_key</span><span class="p">(</span><span class="n">feed</span><span class="p">):</span>
</span><span class="line">	<span class="n">data</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">download_key_info</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>
</span><span class="line">	<span class="n">info</span> <span class="o">=</span> <span class="n">parse_key_info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class="line">	<span class="n">ok</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">confirm_with_gui</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="n">ok</span><span class="p">:</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2>Examples</h2>

<p>Both systems (OCaml Lwt and Python generators) work very well in general. Here are some (slightly simplified) examples from 0install.</p>

<h3>Following a recipe</h3>

<p>Some downloads require collecting files from several places (e.g. an upstream tarball and some files to patch it with). We want to download the files in parallel, but execute the steps (e.g. unpacking downloads into the target directory) in series. My solution is that each download is a thread that performs the download and then returns a lazy thunk that applies it:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line">  <span class="c">(* Start all the downloads in parallel. *)</span>
</span><span class="line">  <span class="k">let</span> <span class="n">downloads</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">do_step</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">  <span class="c">(* Now iterate over the steps in series. *)</span>
</span><span class="line">  <span class="n">downloads</span> <span class="o">|&gt;</span> <span class="nn">Lwt_list</span><span class="p">.</span><span class="n">iter_s</span> <span class="o">(</span><span class="k">fun</span> <span class="n">unpack</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="c">(* Wait for download *)</span>
</span><span class="line">    <span class="k">lwt</span> <span class="n">unpack</span> <span class="o">=</span> <span class="n">unpack</span> <span class="k">in</span>
</span><span class="line">    <span class="c">(* Apply download to directory *)</span>
</span><span class="line">    <span class="nn">Lazy</span><span class="p">.</span><span class="n">force</span> <span class="n">unpack</span>
</span><span class="line">  <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note that we start unpacking as soon as possible; we only wait when the next thing to unpack isn&rsquo;t downloaded yet.</p>

<p>This was my first attempt at a Python version with asyncio:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Start all downloads in parallel</span>
</span><span class="line"><span class="n">downloads</span> <span class="o">=</span> <span class="p">[</span><span class="n">do_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># Wait for all downloads to complete</span>
</span><span class="line"><span class="n">tasks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">downloads</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="c"># Unpack each download in sequence</span>
</span><span class="line"><span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
</span><span class="line">	<span class="n">unpack</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span><span class="line">	<span class="k">yield from</span> <span class="n">unpack</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>An interesting difference is that OCaml threads, once started, continue to run by themselves even if no-one is waiting for the result. When the OCaml code is waiting for the first download to complete, the other downloads are still going on. But if we <code>yield from</code> just the first download in Python, only that download makes progress. In the code above, therefore, the Python waits for all downloads to complete before it starts unpacking.</p>

<p>You can fix this by wrapping the future with <code>async</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="c"># Start all downloads in parallel</span>
</span><span class="line"><span class="n">downloads</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">async</span><span class="p">(</span><span class="n">do_step</span><span class="p">(</span><span class="n">step</span><span class="p">))</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">]</span>
</span><span class="line">
</span><span class="line"><span class="c"># Now iterate over the steps in series.</span>
</span><span class="line"><span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">downloads</span><span class="p">:</span>
</span><span class="line">	<span class="c"># Wait for download</span>
</span><span class="line">	<span class="n">unpack</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">d</span>
</span><span class="line">	<span class="c"># Apply download to directory</span>
</span><span class="line">	<span class="k">yield from</span> <span class="n">unpack</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>Downloading with libcurl</h3>

<p>libcurl doesn&rsquo;t provide Lwt support. However, it is thread-safe. We can therefore use the <code>Lwt_preemptive</code> module to run each download in a real operating system thread and get a promise for its completion. In addition, we use a <code>Lwt_pool</code> to keep up to two Curl connections per site (queuing further requests).</p>

<p>When it&rsquo;s our turn to run, we also start a five second timer if the caller wanted to be notified if the download is slow. This is used when downloading the small XML metadata files so the mirror can be tried in parallel (for archives, we only try the mirror if the download actually fails).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">make_site</span> <span class="n">max_per_site</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">create_connection</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span> <span class="o">(</span><span class="nn">Curl</span><span class="p">.</span><span class="n">init</span> <span class="bp">()</span><span class="o">)</span> <span class="k">in</span>
</span><span class="line">  <span class="k">let</span> <span class="n">pool</span> <span class="o">=</span> <span class="nn">Lwt_pool</span><span class="p">.</span><span class="n">create</span> <span class="n">max_per_site</span> <span class="n">create_connection</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">  <span class="k">object</span>
</span><span class="line">    <span class="k">method</span> <span class="n">schedule_download</span> <span class="o">?</span><span class="n">if_slow</span> <span class="n">channel</span> <span class="n">url</span> <span class="o">=</span>
</span><span class="line">      <span class="nn">Lwt_pool</span><span class="p">.</span><span class="n">use</span> <span class="n">pool</span> <span class="o">(</span><span class="k">fun</span> <span class="n">connection</span> <span class="o">-&gt;</span>
</span><span class="line">	<span class="k">let</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">if_slow</span> <span class="o">|&gt;</span> <span class="n">pipe_some</span> <span class="o">(</span><span class="k">fun</span> <span class="n">if_slow</span> <span class="o">-&gt;</span>
</span><span class="line">	  <span class="k">let</span> <span class="n">timeout</span> <span class="o">=</span> <span class="nn">Lwt_timeout</span><span class="p">.</span><span class="n">create</span> <span class="mi">5</span> <span class="n">if_slow</span> <span class="k">in</span>
</span><span class="line">	  <span class="nn">Lwt_timeout</span><span class="p">.</span><span class="n">start</span> <span class="n">timeout</span><span class="o">;</span>
</span><span class="line">	  <span class="nc">Some</span> <span class="n">timeout</span><span class="o">;</span>
</span><span class="line">	<span class="o">)</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">	<span class="k">let</span> <span class="n">download</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class="line">	  <span class="n">download_in_thread</span> <span class="n">connection</span> <span class="n">channel</span> <span class="n">url</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">	<span class="k">try_lwt</span>
</span><span class="line">	  <span class="nn">Lwt_preemptive</span><span class="p">.</span><span class="n">detach</span> <span class="n">download</span> <span class="bp">()</span>
</span><span class="line">	<span class="k">finally</span>
</span><span class="line">	  <span class="n">timeout</span> <span class="o">|&gt;</span> <span class="n">if_some</span> <span class="nn">Lwt_timeout</span><span class="p">.</span><span class="n">stop</span><span class="o">;</span>
</span><span class="line">	  <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span> <span class="bp">()</span>
</span><span class="line">    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>download_in_thread</code> function also needs to send progress notifications to back to Lwt, which it does using <code>Lwt_preemptive.run_in_main</code>.</p>

<p>Update: note that recent versions of ocurl support Lwt directly.</p>

<p>Python provides the <code>ThreadPoolExecutor</code>, which combines pooling and preemptive threading. This makes it a bit harder to start the timer (which should happen cooperatively), so we need to use <code>call_soon_threadsafe</code>, which is like Lwt&rsquo;s <code>run_in_main</code>. Python doesn&rsquo;t seem to provide a way to manage the HTTP connections with the pool - I guess you have to do that manually.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">class</span> <span class="nc">Site</span><span class="p">:</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_per_site</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
</span><span class="line">        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_per_site</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">schedule_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">if_slow</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
</span><span class="line">        <span class="n">thread_ready</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">()</span>
</span><span class="line">        <span class="k">def</span> <span class="nf">timer</span><span class="p">():</span>
</span><span class="line">            <span class="c"># Wait for an executor to be ready...</span>
</span><span class="line">            <span class="k">yield from</span> <span class="n">thread_ready</span>
</span><span class="line">            <span class="c"># Wait until 5 seconds into the download</span>
</span><span class="line">            <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class="line">            <span class="c"># Notify that the download is slow</span>
</span><span class="line">            <span class="n">if_slow</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">run_in_thread</span><span class="p">():</span>
</span><span class="line">            <span class="n">connection</span> <span class="o">=</span> <span class="o">...</span>
</span><span class="line">            <span class="k">if</span> <span class="n">if_slow</span><span class="p">:</span>
</span><span class="line">                <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">thread_ready</span><span class="o">.</span><span class="n">set_result</span><span class="p">,</span>
</span><span class="line">					  <span class="bp">True</span><span class="p">)</span>
</span><span class="line">            <span class="n">download_in_thread</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="n">download</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">run_in_thread</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="n">t</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">async</span><span class="p">(</span><span class="n">timer</span><span class="p">())</span>
</span><span class="line">	<span class="k">try</span><span class="p">:</span>
</span><span class="line">	    <span class="k">yield from</span> <span class="n">download</span>
</span><span class="line">	<span class="k">finally</span><span class="p">:</span>
</span><span class="line">	    <span class="n">t</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>Error handling in key look-ups</h3>

<p>Lwt does have a gotcha for error handling. Consider this code:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">confirm_key</span> <span class="n">feed</span> <span class="o">=</span>
</span><span class="line">  <span class="k">lwt</span> <span class="n">data</span> <span class="o">=</span>
</span><span class="line">    <span class="k">try</span>
</span><span class="line">      <span class="n">download_key_info</span> <span class="n">feed</span><span class="o">.</span><span class="n">signature</span>
</span><span class="line">    <span class="k">with</span> <span class="nc">Failure</span> <span class="n">msg</span> <span class="o">-&gt;</span>
</span><span class="line">      <span class="n">log_warning</span> <span class="s2">&quot;Failed to download key info: %s&quot;</span> <span class="n">msg</span><span class="o">;</span>
</span><span class="line">      <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span> <span class="bp">[]</span>
</span><span class="line">  <span class="k">in</span>
</span><span class="line">  <span class="k">let</span> <span class="n">info</span> <span class="o">=</span> <span class="n">parse_key_info</span> <span class="n">data</span> <span class="k">in</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If querying the key info server fails, we want to log the error but continue with the confirmation, just with an empty list of hints.</p>

<p>Something I really dislike is code that looks right, compiles without warnings, works when you test it, and then fails in the field. Unfortunately, this code does just that. Even if you unit-test the error case!</p>

<p>The bug occurs because we accidentally used <code>try</code> rather than <code>try_lwt</code>. <code>download_key_info</code> successfully returns a promise for the information, so the <code>with</code> clause isn&rsquo;t triggered and we exit the try block. Then Lwt waits for the promise to resolve so it can set <code>data</code>.
When unit-testing, you&rsquo;ll probably raise the test exception immediately and so the <code>with</code> block does get called.</p>

<p>By contrast, Python&rsquo;s generators have no such problems:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">confirm_key</span><span class="p">(</span><span class="n">feed</span><span class="p">):</span>
</span><span class="line">	<span class="k">try</span><span class="p">:</span>
</span><span class="line">		<span class="n">data</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">download_key_info</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>
</span><span class="line">	<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span class="line">		<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Failed to download key info: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
</span><span class="line">		<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class="line">	<span class="n">info</span> <span class="o">=</span> <span class="n">parse_key_info</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class="line">	<span class="n">ok</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">confirm_with_gui</span><span class="p">(</span><span class="n">feed</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</span><span class="line">	<span class="k">if</span> <span class="n">ok</span><span class="p">:</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The other Lwt constructs don&rsquo;t have this problem because the type-system will detect the error (e.g. if you use <code>match</code> instead of <code>match_lwt</code>), but with <code>try</code> and <code>try_lwt</code> the type signatures are the same.</p>

<h3>Failing over to a mirror</h3>

<p>We start downloading each XML feed from its primary site, but trigger a timeout task if it takes too long.
The timeout starts a download from the mirror, which happens in parallel with the original download attempt.
We don&rsquo;t want to start the timer immediately because the download might get queued due to the rate limiting code, so we just pass the <code>if_slow</code> trigger to the download system (see above).</p>

<p>Because we need to report intermediate results (e.g. we have downloaded a possibly-slightly-old version from the mirror), we return a pair of the new result and a promise for the next update (or <code>None</code> if this is the last). In a similar way, we return errors as a pair of the current error (e.g. &ldquo;mirror failed&rdquo;) and a promise for the other result.</p>

<p><code>Lwt.choose</code> selects the result of the first task from a list to resolve. When choosing between the primary and the mirror however we ignore the result and test explicitly, because we need to know which one it was.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">timeout_task</span><span class="o">,</span> <span class="n">timeout_waker</span> <span class="o">=</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">wait</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line"><span class="k">let</span> <span class="n">if_slow</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">wakeup</span> <span class="n">timeout_waker</span> <span class="o">`</span><span class="n">timeout</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line"><span class="k">let</span> <span class="n">primary</span> <span class="o">=</span> <span class="n">do_primary_download</span> <span class="o">~</span><span class="n">if_slow</span> <span class="n">feed</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line"><span class="c">(* Download just the upstream feed, unless it takes too long... *)</span>
</span><span class="line"><span class="n">match_lwt</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">choose</span> <span class="o">[</span><span class="n">primary</span><span class="o">;</span> <span class="n">timeout_task</span><span class="o">]</span> <span class="k">with</span>
</span><span class="line"><span class="o">|</span> <span class="o">`</span><span class="n">ok</span> <span class="n">result</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="o">`</span><span class="n">update</span> <span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span>
</span><span class="line"><span class="o">|</span> <span class="o">`</span><span class="n">problem</span> <span class="n">msg</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="k">let</span> <span class="n">mirror</span> <span class="o">=</span> <span class="n">do_mirror_download</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">    <span class="o">`</span><span class="n">problem</span> <span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">wait_for_mirror</span> <span class="n">mirror</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span>
</span><span class="line"><span class="o">|</span> <span class="o">`</span><span class="n">timeout</span> <span class="o">-&gt;</span>
</span><span class="line">    <span class="c">(* OK, maybe it's just being slow... *)</span>
</span><span class="line">    <span class="n">log_info</span> <span class="s2">&quot;Feed download from %s is taking a long time.&quot;</span> <span class="n">feed_url</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="c">(* Start downloading from mirror... *)</span>
</span><span class="line">    <span class="k">let</span> <span class="n">mirror</span> <span class="o">=</span> <span class="n">do_mirror_download</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">    <span class="c">(* Wait for a result from either *)</span>
</span><span class="line">    <span class="n">lwt</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">choose</span> <span class="o">[</span><span class="n">primary</span><span class="o">;</span> <span class="n">mirror</span><span class="o">]</span> <span class="k">in</span>
</span><span class="line">
</span><span class="line">    <span class="k">match</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">state</span> <span class="n">primary</span> <span class="k">with</span>
</span><span class="line">    <span class="o">|</span> <span class="nn">Lwt</span><span class="p">.</span><span class="nc">Fail</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="n">msg</span>
</span><span class="line">    <span class="o">|</span> <span class="nn">Lwt</span><span class="p">.</span><span class="nc">Sleep</span> <span class="o">-&gt;</span>
</span><span class="line">	<span class="c">(* The mirror finished first *)</span>
</span><span class="line">	<span class="k">begin</span> <span class="n">match_lwt</span> <span class="n">mirror</span> <span class="k">with</span>
</span><span class="line">	<span class="o">|</span> <span class="o">`</span><span class="n">ok</span> <span class="n">result</span> <span class="o">-&gt;</span>
</span><span class="line">	    <span class="n">log_info</span> <span class="s2">&quot;Mirror succeeded, but will continue to wait for primary&quot;</span><span class="o">;</span>
</span><span class="line">	    <span class="o">`</span><span class="n">update</span> <span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">wait_for_primary</span> <span class="n">primary</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span>
</span><span class="line">	<span class="o">|</span> <span class="o">`</span><span class="n">problem</span> <span class="n">msg</span> <span class="o">-&gt;</span>
</span><span class="line">	    <span class="n">log_info</span> <span class="s2">&quot;Mirror download failed: %s&quot;</span> <span class="n">msg</span><span class="o">;</span>
</span><span class="line">	    <span class="n">wait_for_primary</span> <span class="n">primary</span> <span class="k">end</span>
</span><span class="line">    <span class="o">|</span> <span class="nn">Lwt</span><span class="p">.</span><span class="nc">Return</span> <span class="n">v</span> <span class="o">-&gt;</span>
</span><span class="line">	<span class="c">(* The primary returned first *)</span>
</span><span class="line">	<span class="k">match</span> <span class="n">v</span> <span class="k">with</span>
</span><span class="line">	<span class="o">|</span> <span class="o">`</span><span class="n">ok</span> <span class="n">result</span> <span class="o">-&gt;</span>
</span><span class="line">	    <span class="nn">Lwt</span><span class="p">.</span><span class="n">cancel</span> <span class="n">mirror</span><span class="o">;</span>
</span><span class="line">	    <span class="o">`</span><span class="n">update</span> <span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span> <span class="o">&gt;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span>
</span><span class="line">	<span class="o">|</span> <span class="o">`</span><span class="n">problem</span> <span class="n">msg</span> <span class="o">-&gt;</span>
</span><span class="line">	    <span class="o">`</span><span class="n">problem</span> <span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">wait_for_mirror</span> <span class="n">mirror</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I&rsquo;m too lazy to translate this into modern Python, but I think it&rsquo;s clear that a direct translation would be easy enough.</p>

<p>The main problem would be losing OCaml&rsquo;s type checking, which ensures that we handle all the possible error conditions. I simplified the outcomes into just <code>ok</code> and <code>problem</code> above, but in the real code we also distinguish <code>replay_attack</code>, <code>aborted_by_user</code> and <code>no_trusted_keys</code>, and handle them differently. For example, a &ldquo;replay attack&rdquo; from the mirror (where the mirror gives us a version older than one we&rsquo;ve already seen) is ignored, whereas it&rsquo;s reported if it comes from the primary.</p>

<h2>Switches</h2>

<p>The <code>Lwt_switch</code> module provides a way to group a set of activities together so you can stop them all at once.
You create a switch and pass it to all the various setup functions you call.
When you&rsquo;re done, call <code>Lwt_switch.turn_off</code> to kill everything.
For example, each download goes to a temporary file. To ensure they&rsquo;re all deleted afterwards:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">switch</span> <span class="o">=</span> <span class="nn">Lwt_switch</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line"><span class="k">try_lwt</span>
</span><span class="line">  <span class="k">let</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">download</span> <span class="o">~</span><span class="n">switch</span> <span class="n">url</span> <span class="k">in</span>
</span><span class="line">  <span class="o">...</span>
</span><span class="line"><span class="k">finally</span>
</span><span class="line">  <span class="nn">Lwt_switch</span><span class="p">.</span><span class="n">turn_off</span> <span class="n">switch</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It&rsquo;s easy to attach whatever finalisation code you want to a switch, e.g.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">download</span> <span class="o">~</span><span class="n">switch</span> <span class="n">url</span> <span class="o">=</span>
</span><span class="line">  <span class="k">let</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">make_temp_file</span> <span class="bp">()</span> <span class="k">in</span>
</span><span class="line">  <span class="nn">Lwt_switch</span><span class="p">.</span><span class="n">add_hook</span>
</span><span class="line">    <span class="o">(</span><span class="nc">Some</span> <span class="n">switch</span><span class="o">)</span>
</span><span class="line">    <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">unlink</span> <span class="n">tmpfile</span><span class="o">;</span> <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span> <span class="bp">()</span><span class="o">);</span>
</span><span class="line">  <span class="o">...</span>
</span><span class="line">  <span class="nn">Lwt</span><span class="p">.</span><span class="n">return</span> <span class="n">tmpfile</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then it doesn&rsquo;t matter whether we download successfully, raise an exception inside of <code>download</code>, raise an exception after calling <code>download</code>, etc; the file always gets deleted.</p>

<p>Perhaps this is bad API design and I shouldn&rsquo;t rely on <code>download</code>&rsquo;s caller to clean up the file if <code>download</code> fails, but it does seem convenient. To avoid mistakes, I used <code>~switch</code> to force the caller to pass a switch instead of the more normal <code>?switch</code> (where use of a switch is optional).</p>

<h2>Parallel tasks</h2>

<p>Regular OCaml lets you assign multiple variables at once using <code>and</code>, so that all the expressions are evaluated in a context where none of them is bound. For example, to switch the names of two variables:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">y</span>
</span><span class="line"><span class="ow">and</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="k">in</span>
</span><span class="line"><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Lwt uses this syntax with <code>lwt</code> to create multiple tasks in parallel and then wait for all of them. For example, when we run a command we may want to collect the standard output and standard error separately but in parallel (if we did them in series, the process might get stuck trying to write its stderr while we were trying to read its stdout, if the Unix pipe gets full). With this syntax, we can get the two strings with just:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ocaml"><span class="line"><span class="k">lwt</span> <span class="n">stdout</span> <span class="o">=</span> <span class="nn">Lwt_io</span><span class="p">.</span><span class="n">read</span> <span class="n">child</span><span class="o">#</span><span class="n">stdout</span>
</span><span class="line"><span class="ow">and</span> <span class="n">stderr</span> <span class="o">=</span> <span class="nn">Lwt_io</span><span class="p">.</span><span class="n">read</span> <span class="n">child</span><span class="o">#</span><span class="n">stderr</span> <span class="k">in</span>
</span><span class="line"><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2>Conclusions</h2>

<p>0install needs to manage several fairly complex concurrent download activities, including error handling, timeouts and mirrors. Cooperative multi-threading allows us to support this easily with a low risk of race conditions.</p>

<p>Python and OCaml both provide powerful and easy-to-use cooperative threading support. I think Python&rsquo;s generators are slightly easier to understand for beginners, but I find both quite easy to use. I find Lwt&rsquo;s terminology a little confusing, but thinking of threads as promises seems to help. Both systems handle exceptions sensibly.</p>

<p>Comparing Python and OCaml code, they&rsquo;re pretty similar. Both make it easy to start and manage cooperative threads, to interact with pools of preemptively threaded code (e.g. libcurl) and to handle errors.
Using OCaml variants for network errors rather than exceptions is useful; this ensures that all such errors are handled. If you rely on exceptions instead then things mostly work, but watch out for using <code>try</code> rather than <code>try_lwt</code>.</p>

<p>The old 0install Python code used a custom system built on top of Python&rsquo;s generators, but Python&rsquo;s new asyncio module provides a standardised replacement (asyncio will be added to the standard library in Python 3.4). Lwt has been around for a while and is already available from Linux distribution repositories.</p>

<p>Lwt also integrates with several other libraries, including GTK, OBus (D-BUS bindings) and React. Lwt seems very reliable. The only bug I found in Lwt so far was <a href="https://github.com/ocsigen/lwt/issues/20">a pipe read failure on Windows</a>, which they quickly fixed.</p>
<a onclick="switchContent('ocamlorg-post86','ocamlorg-post85')" class="btn planet-toggle" href="#http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://roscidus.com/blog/blog/2013/11/28/asynchronous-python-vs-ocaml/">by Thomas Leonard at Nov 28, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://amirchaudhry.com/switching-from-bootstrap-to-zurb-foundation">
    <a name="#http://amirchaudhry.com/switching-from-bootstrap-to-zurb-foundation"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/amir.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://amirchaudhry.com/switching-from-bootstrap-to-zurb-foundation">Switching from Bootstrap to Zurb Foundation</a>
      (<a href="http://amirchaudhry.com/tags/ocaml-labs-atom.xml" title="Amir Chaudhry - 'ocaml-labs'">Amir Chaudhry</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post87">
<p>I&rsquo;ve just updated my site&rsquo;s HTML/CSS and moved from Twitter Bootstrap to 
<a href="http://foundation.zurb.com/learn/features.html">Zurb Foundation</a>.  This post captures my subjective notes on the 
migration.</p>

<h4>My use of Bootstrap</h4>

<p>When I originally set this site up, I didn&rsquo;t know what frameworks existed or 
anything more than the basics of dealing with HTML (and barely any CSS).  I 
came across Twitter Bootstrap and immediately decided it would Solve All My 
Problems.  It really did.  Since then, I&rsquo;ve gone through one &lsquo;upgrade&rsquo; with 
Bootstrap (from 1.x to 2.x), after which I dutifully ignored all the fixes 
and improvements (note that Bootstrap was up to v2.3.2 while I was still 
using v2.0.2).  </p>

<p><img src="http://amirchaudhry.com/images/switch-to-foundation/responsive-design.png" alt="Responsive Design"/></p>

<p>For the most part, this was fine with me but for a while now, I&rsquo;ve been 
meaning to make this site &lsquo;responsive&rsquo; (read: not look like crap from a 
mobile).  Bootstrap v3 purports to be mobile-first so upgrading would likely 
give me what I&rsquo;m after but v3 is <a href="http://getbootstrap.com/getting-started/">not backwards compatible</a>, 
meaning I&rsquo;d have to rewrite parts of the H&hellip;</p><a onclick="switchContent('ocamlorg-post87','ocamlorg-post88')" class="btn planet-toggle" href="#http://amirchaudhry.com/switching-from-bootstrap-to-zurb-foundation">Read more...</a></div><div id="ocamlorg-post88" style="display: none">
<p>I&rsquo;ve just updated my site&rsquo;s HTML/CSS and moved from Twitter Bootstrap to 
<a href="http://foundation.zurb.com/learn/features.html">Zurb Foundation</a>.  This post captures my subjective notes on the 
migration.</p>

<h4>My use of Bootstrap</h4>

<p>When I originally set this site up, I didn&rsquo;t know what frameworks existed or 
anything more than the basics of dealing with HTML (and barely any CSS).  I 
came across Twitter Bootstrap and immediately decided it would Solve All My 
Problems.  It really did.  Since then, I&rsquo;ve gone through one &lsquo;upgrade&rsquo; with 
Bootstrap (from 1.x to 2.x), after which I dutifully ignored all the fixes 
and improvements (note that Bootstrap was up to v2.3.2 while I was still 
using v2.0.2).  </p>

<p><img src="http://amirchaudhry.com/images/switch-to-foundation/responsive-design.png" alt="Responsive Design"/></p>

<p>For the most part, this was fine with me but for a while now, I&rsquo;ve been 
meaning to make this site &lsquo;responsive&rsquo; (read: not look like crap from a 
mobile).  Bootstrap v3 purports to be mobile-first so upgrading would likely 
give me what I&rsquo;m after but v3 is <a href="http://getbootstrap.com/getting-started/">not backwards compatible</a>, 
meaning I&rsquo;d have to rewrite parts of the HTML.  Since this step was 
unavoidable, it led me to have another look at front-end frameworks, just to 
see if I was missing anything.  This was especially relevant since we&rsquo;d 
<a href="http://amirchaudhry.com/announcing-new-ocamlorg/">just released</a> the new <a href="http://ocaml.org">OCaml.org</a> 
website, itself built with Bootstrap v2.3.1 (we&rsquo;d done the design/templating 
work long before v3 was released).  It would be useful to know what else is 
out there for any future work.</p>

<p>Around this time I discovered Zurb Foundation and also the numerous 
comparisons between them (note: Foundation seems to come out ahead in most 
of those).  A few days ago, the folks at Zurb released 
<a href="http://zurb.com/article/1280/foundation-5-blasts-off--2">version 5</a>, so I decided that now is the time to kick the 
tires.  For the last few days, I&rsquo;ve been playing with the framework and in 
the end I decided to migrate my site over completely.  </p>

<p><a href="http://foundation.zurb.com/learn/features.html"><img src="http://amirchaudhry.com/images/switch-to-foundation/zurb-yeti.png" alt="Foundation's Yeti"/></a></p>

<h4>Swapping out one framework for another</h4>

<p>Over time, I&rsquo;ve become moderately experienced with HTML/CSS and I can 
usually wrangle things to look the way I want, but my solutions aren&rsquo;t 
necessarily elegant. I was initially concerned that I&rsquo;d already munged 
things so much that changing anything would be a pain.  When I first put the 
styles for this site together, I had to spend quite a bit of time 
overwriting Bootstrap&rsquo;s defaults so I was prepared for the same when using 
Foundation.  Turns out that I was fine.  I currently use <a href="http://jekyllrb.com">Jekyll</a> (and 
<a href="http://jekyllbootstrap.com">Jekyll Bootstrap</a>) so I only had three template files and a couple of 
HTML pages to edit and because I&rsquo;d kept most of my custom CSS in a separate 
file, it was literally a case of swapping out one framework for another and 
bug-fixing from there onwards.  There&rsquo;s definitely a lesson here in using 
automation as much as possible.</p>

<p>Customising the styles was another area of concern but I was pleasantly 
surprised to find I needed <em>less</em> customisation than with Bootstrap.  This 
is likely because I didn&rsquo;t have to override as many defaults (and probably 
because I&rsquo;ve learned more about CSS since then).  The one thing I seemed to 
be missing was a way to deal with code sections, so I just took what 
Bootstrap had and copied it in.  At some point I should revisit this.</p>

<p>It did take me a while to get my head around Foundation&rsquo;s grid but it was 
worth it in the end.  The idea is that you should design for small screens 
first and then adjust things for larger screens as necessary. There are 
several different default sizes which inherit their properties from the size 
below, unless you explicitly override them.  I initially screwed this up by 
explicitly defining the grid using the <code>small-#</code> classes, which obviously 
looks ridiculous on small screens.  I fixed it by swapping out <code>small-#</code> for 
<code>medium-#</code> everywhere in the HTML, after which everything looked reasonable. 
Items flowed sensibly into a default column for the small screens and looked 
acceptable for larger screens and perfectly fine on desktops.  I could do 
more styling of the mobile view but I&rsquo;d already achieved most of what I was 
after.  </p>

<h4>Fixing image galleries and embedded content</h4>

<p>The only additional thing I used from Bootstrap was the <a href="http://getbootstrap.com/javascript/#carousel">Carousel</a>. I&rsquo;d 
written some custom helper scripts that would take some images and 
thumbnails from a specified folder and produce clickable thumbnails with a 
slider underneath.  Foundation provides <a href="http://foundation.zurb.com/docs/components/orbit.html">Orbit</a>, so I had to spend time 
rewriting my script to produce the necessary HTML.  This actually resulted 
in cleaner HTML and one of the features I wanted (the ability to link to a 
specific image) was available by default in Orbit.  At this point I also 
tried to make the output look better for the case where JavaScript is 
disabled (in essence, each image is just displayed as a list).  Below is an 
example of an image gallery, taken from a previous post, when I 
<a href="http://amirchaudhry.com/joined-the-computer-lab/">joined the computer lab</a>.</p>

<div class="gallery">
  <noscript><small><em>Note: The gallery needs JavaScript but I've tried to make it degrade gracefully. -Amir</em></small></noscript>
  <ul class="inline-list">
    
      <li><a data-orbit-link="join-comp-lab-1"><img src="http://amirchaudhry.com/images/join-comp-lab/join-comp-lab-thumb-1.png" alt="join-comp-lab-thumb-1"/></a></li>
    
      <li><a data-orbit-link="join-comp-lab-2"><img src="http://amirchaudhry.com/images/join-comp-lab/join-comp-lab-thumb-2.png" alt="join-comp-lab-thumb-2"/></a></li>
    
      <li><a data-orbit-link="join-comp-lab-3"><img src="http://amirchaudhry.com/images/join-comp-lab/join-comp-lab-thumb-3.png" alt="join-comp-lab-thumb-3"/></a></li>
    
  </ul>
  <ul data-orbit="" data-options="next_on_click:true; timer_speed:3000; pause_on_hover:false; bullets:false;">
    
    <li class="gallery-image" data-orbit-slide="join-comp-lab-1"><img src="http://amirchaudhry.com/images/join-comp-lab/join-comp-lab-1.jpg" alt="join-comp-lab-1"/></li>
    
    <li class="gallery-image" data-orbit-slide="join-comp-lab-2"><img src="http://amirchaudhry.com/images/join-comp-lab/join-comp-lab-2.jpg" alt="join-comp-lab-2"/></li>
    
    <li class="gallery-image" data-orbit-slide="join-comp-lab-3"><img src="http://amirchaudhry.com/images/join-comp-lab/join-comp-lab-3.jpg" alt="join-comp-lab-3"/></li>
    
  </ul>
</div>

<p>Foundation also provides a component called <a href="http://foundation.zurb.com/docs/components/flex_video.html">Flex Video</a>, which allows the 
browser to scale videos to the appropriate size.  This fix was as simple as 
going back through old posts and wrapping anything that was <code>&lt;iframe&gt;</code> in a 
<code>&lt;div class=&quot;flex-video&quot;&gt;</code>.  It really was that simple and all the Vimeo and 
YouTube items scaled perfectly.  Here&rsquo;s an example of a video from an 
earlier post, where I gave a <a href="http://amirchaudhry.com/wireframe-demos-for-ocamlorg/">walkthrough of the ocaml.org site</a>. 
Try changing the width of your browser window to see it scale.</p>

<div class="flex-video widescreen vimeo">
  <iframe src="http://player.vimeo.com/video/61768157?byline=0&amp;portrait=0&amp;color=de9e6a" width="540" height="303" frameborder="0" webkitallowfullscreen="true" mozallowfullscreen="true" allowfullscreen="true">Video demo</iframe>
</div>

<h4>Framework differences</h4>

<p>Another of the main difference between the two frameworks is that Bootstrap 
uses <a href="http://lesscss.org">LESS</a> to manage its CSS whereas Foundation uses <a href="http://sass-lang.com">SASS</a>.  Frankly, 
I&rsquo;ve no experience with either of them so it makes little difference to me. 
It&rsquo;s worth bearing in mind for anyone who&rsquo;s workflow does involve 
pre-processing.  Also, Bootstrap is available under the 
<a href="http://getbootstrap.com/getting-started/#license-faqs">Apache 2 License</a>, while Foundation is released under 
the <a href="http://foundation.zurb.com/learn/faq.html#question-3">MIT license</a>.</p>

<h4>Summary</h4>

<p>Overall, the transition was pretty painless and most of the time was spent 
getting familiar with the grid, hunting for docs/examples and trying to make 
the image gallery work the way I wanted.  I do think Bootstrap&rsquo;s docs are 
better but Foundation&rsquo;s aren&rsquo;t bad.  </p>

<p>Although this isn&rsquo;t meant to be a comparison, I much prefer Foundation to 
Bootstrap.  If you&rsquo;re not sure which to use then I think the secret is in 
the names of the frameworks.  </p>

<ul>
  <li>Bootstrap (for me) was a <em>great</em> way to &lsquo;<em>bootstrap</em>&rsquo; a site quickly with 
lots of acceptable defaults &ndash; it was quick to get started but took some 
work to alter.  </li>
  <li>Foundation seems to provide a great &lsquo;<em>foundation</em>&rsquo; on which to create more 
customised sites &ndash; it&rsquo;s more flexible but needs more upfront thought.  </li>
</ul>

<p>That&rsquo;s pretty much how I&rsquo;d recommend them to people now.</p>

<a onclick="switchContent('ocamlorg-post88','ocamlorg-post87')" class="btn planet-toggle" href="#http://amirchaudhry.com/switching-from-bootstrap-to-zurb-foundation">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://amirchaudhry.com/switching-from-bootstrap-to-zurb-foundation">by Amir Chaudhry at Nov 26, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://amirchaudhry.com/announcing-new-ocamlorg">
    <a name="#http://amirchaudhry.com/announcing-new-ocamlorg"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/amir.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://amirchaudhry.com/announcing-new-ocamlorg">Announcing the new OCaml.org</a>
      (<a href="http://amirchaudhry.com/tags/ocaml-labs-atom.xml" title="Amir Chaudhry - 'ocaml-labs'">Amir Chaudhry</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post89">
<p>As some of you may have noticed, the new OCaml.org site is now live!  </p>

<p>The DNS may still be propagating so if <a href="http://ocaml.org">http://ocaml.org</a> hasn&rsquo;t updated for you then try http://166.78.252.20.  This post is in two parts: the first is the announcement and the second is a call for content.</p>

<h3>New OCaml.org website design!</h3>

<p>The new site represents a major milestone in the continuing growth of the OCaml ecosystem. It&rsquo;s the culmination of a lot of volunteer work over the last several months and I&rsquo;d specifically like to thank <a href="https://github.com/Chris00">Christophe</a>, <a href="http://ashishagarwal.org">Ashish</a> and <a href="http://philippewang.info/CL/">Philippe</a> for their dedication (the <a href="https://github.com/ocaml/ocaml.org/commits/master">commit logs</a> speak volumes).  </p>

<p><a href="http://amirchaudhry.com/wireframe-demos-for-ocamlorg/"><img src="http://amirchaudhry.com/images/ann-new-ocamlorg/ocaml-home-wire.png" alt="OCaml.org Wireframes"/></a></p>

<p>We began this journey just over 8 months ago with paper, pencils and a lot of ideas. This led to a comprehensive set of <a href="http://amirchaudhry.com/wireframe-demos-for-ocamlorg/">wireframes and walk-throughs</a> of the site, which then developed into a collection of <a href="https://github.com/ocaml/ocaml.org/wiki/Site-Redesign">Photoshop mockups</a>. In turn, these formed the basis for the html templates and style sheets, which we&rsquo;ve adapted to fit our needs across the site.  </p>

<p>Alongside the design process, we a&hellip;</p><a onclick="switchContent('ocamlorg-post89','ocamlorg-post90')" class="btn planet-toggle" href="#http://amirchaudhry.com/announcing-new-ocamlorg">Read more...</a></div><div id="ocamlorg-post90" style="display: none">
<p>As some of you may have noticed, the new OCaml.org site is now live!  </p>

<p>The DNS may still be propagating so if <a href="http://ocaml.org">http://ocaml.org</a> hasn&rsquo;t updated for you then try http://166.78.252.20.  This post is in two parts: the first is the announcement and the second is a call for content.</p>

<h3>New OCaml.org website design!</h3>

<p>The new site represents a major milestone in the continuing growth of the OCaml ecosystem. It&rsquo;s the culmination of a lot of volunteer work over the last several months and I&rsquo;d specifically like to thank <a href="https://github.com/Chris00">Christophe</a>, <a href="http://ashishagarwal.org">Ashish</a> and <a href="http://philippewang.info/CL/">Philippe</a> for their dedication (the <a href="https://github.com/ocaml/ocaml.org/commits/master">commit logs</a> speak volumes).  </p>

<p><a href="http://amirchaudhry.com/wireframe-demos-for-ocamlorg/"><img src="http://amirchaudhry.com/images/ann-new-ocamlorg/ocaml-home-wire.png" alt="OCaml.org Wireframes"/></a></p>

<p>We began this journey just over 8 months ago with paper, pencils and a lot of ideas. This led to a comprehensive set of <a href="http://amirchaudhry.com/wireframe-demos-for-ocamlorg/">wireframes and walk-throughs</a> of the site, which then developed into a collection of <a href="https://github.com/ocaml/ocaml.org/wiki/Site-Redesign">Photoshop mockups</a>. In turn, these formed the basis for the html templates and style sheets, which we&rsquo;ve adapted to fit our needs across the site.  </p>

<p>Alongside the design process, we also considered the kind of structure and <a href="http://lists.ocaml.org/pipermail/infrastructure/2013-July/000211.html">workflow we aspired to</a>, both as maintainers and contributors.  This led us to develop completely new tools for <a href="http://pw374.github.io/posts/2013-09-05-22-31-26-about-omd.html">Markdown</a> and <a href="http://pw374.github.io/posts/2013-10-03-20-35-12-using-mpp-two-different-ways.html">templating</a> in OCaml, which are now available in OPAM for the benefit all.  </p>

<p>Working on all these things in parallel definitely had it challenges (which I&rsquo;ll write about separately) but the result has been worth the effort.  </p>

<p><a href="http://ocaml.org"><img src="http://amirchaudhry.com/images/ann-new-ocamlorg/ocaml-home-mockup.png" alt="OCaml.org"/></a></p>

<p>The journey is ongoing and we still have many more improvements we hope to make. The site you see today primarily improves upon the design, structure and workflows but in time, we also intend to incorporate more information on packages and documentation. With the new tooling, moving the website forward will become much easier and I hope that more members of the community become involved in the generation and curation of content.  This brings me to the second part of this post.</p>

<h3>Call for content</h3>

<p>We have lots of great content on the website but there are parts that could do with a refresh and gaps that could be filled.  As a community driven site, we need ongoing contributions to ensure that the site best reflects its members.  </p>

<p>For example, if you do commercial work on OCaml then maybe you&rsquo;d like to add yourself to the <a href="http://ocaml.org/community/support.html">support page</a>? Perhaps there are tutorials you can help to complete, like <a href="http://ocaml.org/learn/tutorials/99problems.html">99 problems</a>?  If you&rsquo;re not sure where to begin, there are already a number of <a href="https://github.com/ocaml/ocaml.org/issues?labels=content">content issues</a> you could contribute to.  </p>

<p>Although we&rsquo;ve gone through a bug-hunt already, feedback on the site is still very welcome.  You can either <a href="https://github.com/ocaml/ocaml.org/issues">create an issue</a> on the tracker (preferred), or email the infrastructure list. </p>

<p>It&rsquo;s fantastic how far we&rsquo;ve come and I look forward to the next phase!</p>

<a onclick="switchContent('ocamlorg-post90','ocamlorg-post89')" class="btn planet-toggle" href="#http://amirchaudhry.com/announcing-new-ocamlorg">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://amirchaudhry.com/announcing-new-ocamlorg">by Amir Chaudhry at Nov 20, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://amirchaudhry.com/migration-plan-ocaml-org">
    <a name="#http://amirchaudhry.com/migration-plan-ocaml-org"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/amir.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://amirchaudhry.com/migration-plan-ocaml-org">Migration plan for the OCaml.org redesign</a>
      (<a href="http://amirchaudhry.com/tags/ocaml-labs-atom.xml" title="Amir Chaudhry - 'ocaml-labs'">Amir Chaudhry</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post91">
<p>We&rsquo;re close to releasing the new design of ocaml.org but need help from the 
OCaml community to identify and fix bugs before we switch next week.</p>

<p>Ashish, Christophe, Philippe and I have been discussing how we should go 
about this and below is the plan for migration.  If anyone would like to 
discuss any of this, then the <a href="http://lists.ocaml.org/listinfo/infrastructure">infrastructure list</a> is the best 
place to do so.</p>

<ol>
  <li>
    <p>We&rsquo;ve made a <strong><a href="https://github.com/ocaml/ocaml.org/tree/redesign">new branch</a></strong> on the main ocaml.org repository with 
the redesign.  This branch is a fork of the master and we&rsquo;ve simply cleaned 
up and replayed our git commits there.</p>
  </li>
  <li>
    <p>We&rsquo;ve built a live version of the new site, which is visible at 
<strong><a href="http://preview.ocaml.org">http://preview.ocaml.org</a></strong> - this is rebuilt every few minutes 
from the branch mentioned above.  </p>
  </li>
  <li>
    <p>Over the course of one week, we ask the community to review the new site 
and <strong><a href="https://github.com/ocaml/ocaml.org/issues">report any bugs or problems</a></strong> on the issue tracker. We <em>triage</em> 
those bugs to identify any blockers and work on those first.  This is the 
phase we&rsquo;ll be in from <em>today</em>.</p>
 &hellip;</li></ol><a onclick="switchContent('ocamlorg-post91','ocamlorg-post92')" class="btn planet-toggle" href="#http://amirchaudhry.com/migration-plan-ocaml-org">Read more...</a></div><div id="ocamlorg-post92" style="display: none">
<p>We&rsquo;re close to releasing the new design of ocaml.org but need help from the 
OCaml community to identify and fix bugs before we switch next week.</p>

<p>Ashish, Christophe, Philippe and I have been discussing how we should go 
about this and below is the plan for migration.  If anyone would like to 
discuss any of this, then the <a href="http://lists.ocaml.org/listinfo/infrastructure">infrastructure list</a> is the best 
place to do so.</p>

<ol>
  <li>
    <p>We&rsquo;ve made a <strong><a href="https://github.com/ocaml/ocaml.org/tree/redesign">new branch</a></strong> on the main ocaml.org repository with 
the redesign.  This branch is a fork of the master and we&rsquo;ve simply cleaned 
up and replayed our git commits there.</p>
  </li>
  <li>
    <p>We&rsquo;ve built a live version of the new site, which is visible at 
<strong><a href="http://preview.ocaml.org">http://preview.ocaml.org</a></strong> - this is rebuilt every few minutes 
from the branch mentioned above.  </p>
  </li>
  <li>
    <p>Over the course of one week, we ask the community to review the new site 
and <strong><a href="https://github.com/ocaml/ocaml.org/issues">report any bugs or problems</a></strong> on the issue tracker. We <em>triage</em> 
those bugs to identify any blockers and work on those first.  This is the 
phase we&rsquo;ll be in from <em>today</em>.</p>
  </li>
  <li>
    <p>After one week (7 days), and after blocking bugs have been fixed, we 
<strong>merge the redesign branch</strong> into the master branch.  This would 
effectively present the new site to the world.  </p>
  </li>
</ol>

<p>During the above, we would not be able to accept any new pull requests on 
the master branch but would be happy to accept them on the new, redesign 
branch.  Hence, restricting the time frame to one week.  </p>

<p>Please note that the above is only intended to merge the <em>design</em> and 
<em>toolchain</em> for the new site.  Specifically, we&rsquo;ve created new landing 
pages, have new style sheets and have restructured the site&rsquo;s contents as 
well as made some new libraries (<a href="http://pw374.github.io/posts/2013-09-05-22-31-26-about-omd.html">OMD</a> and <a href="http://pw374.github.io/posts/2013-10-03-20-39-07-OPAMaging-MPP.html">MPP</a>). The new toolchain 
means people can write files in markdown, which makes contributing content a 
lot easier.  </p>

<p>Since the files are on GitHub, people don&rsquo;t even need to clone the site 
locally to make simple edits (or even add new pages). Just click the &lsquo;Edit 
this page&rsquo; link in the footer to be taken to the right file in the 
repository and GitHub&rsquo;s editing and pull request features will allow you to 
make changes and submit updates, all from within your browser (see the 
<a href="https://help.github.com/articles/creating-and-editing-files-in-your-repository">GitHub Article</a> for details).  </p>

<p>There is still work to be done on adding new features but the above changes 
are already a great improvement to the site and are ready to be reviewed by 
the OCaml community and merged.</p>

<a onclick="switchContent('ocamlorg-post92','ocamlorg-post91')" class="btn planet-toggle" href="#http://amirchaudhry.com/migration-plan-ocaml-org">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://amirchaudhry.com/migration-plan-ocaml-org">by Amir Chaudhry at Nov 06, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://ocamllabs.github.com/compiler-hacking/2013/10/30/third-compiler-hacking-session">
    <a name="#http://ocamllabs.github.com/compiler-hacking/2013/10/30/third-compiler-hacking-session"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../images/hax0ring.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://ocamllabs.github.com/compiler-hacking/2013/10/30/third-compiler-hacking-session">Third OCaml compiler hacking session</a>
      (<a href="http://ocamllabs.github.io/compiler-hacking/rss.xml" title="OCaml Labs compiler hacking">Compiler Hacking</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post93"><p>It's time for the third Cambridge OCaml compiler-hacking session! This time we're going to be back in the <a href="http://www.cl.cam.ac.uk/">Computer Lab</a>, where the first session was held.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/czzp7ik4r72npz6p"><em>indicate interest via Doodle</em></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking"><em>sign up to the mailing list</em></a> to receive updates:</p>

<p><em>Where</em>: Room <a href="http://www.cl.cam.ac.uk/research/dtg/openroommap/static/?s=FW11&amp;amp%3Blabels=1">FW11</a>, <a href="http://www.cl.cam.ac.uk/directions/">Computer Laboratory, Madingley Road</a></p>

<p><em>When</em>: 6pm, Wednesday 6th November</p>

<p><em>Who</em>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><em>What</em>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><em>Wiki</em>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-camlp4/manual002.html">camlp4</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-project&hellip;</a></p><a onclick="switchContent('ocamlorg-post93','ocamlorg-post94')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2013/10/30/third-compiler-hacking-session">Read more...</a></div><div id="ocamlorg-post94" style="display: none"><p>It's time for the third Cambridge OCaml compiler-hacking session! This time we're going to be back in the <a href="http://www.cl.cam.ac.uk/">Computer Lab</a>, where the first session was held.</p>

<p>If you're planning to come along, it'd be helpful if you could <a href="http://doodle.com/czzp7ik4r72npz6p"><em>indicate interest via Doodle</em></a> and <a href="http://lists.ocaml.org/listinfo/cam-compiler-hacking"><em>sign up to the mailing list</em></a> to receive updates:</p>

<p><em>Where</em>: Room <a href="http://www.cl.cam.ac.uk/research/dtg/openroommap/static/?s=FW11&amp;amp%3Blabels=1">FW11</a>, <a href="http://www.cl.cam.ac.uk/directions/">Computer Laboratory, Madingley Road</a></p>

<p><em>When</em>: 6pm, Wednesday 6th November</p>

<p><em>Who</em>: anyone interested in improving OCaml. Knowledge of OCaml programming will obviously be helpful, but prior experience of working on OCaml internals isn't necessary.</p>

<p><em>What</em>: fixing bugs, implementing new features, learning about OCaml internals</p>

<p><em>Wiki</em>: <a href="https://github.com/ocamllabs/compiler-hacking/wiki">https://github.com/ocamllabs/compiler-hacking/wiki</a></p>

<p>We're defining &quot;compiler&quot; pretty broadly, to include anything that's part of the standard distribution, which means at least the <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/libref/index.html">standard library</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual024.html">runtime</a>, tools (<a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.01/depend.html">ocamldep</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc105">ocamllex</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual026.html#toc107">ocamlyacc</a>, etc.), <a href="http://caml.inria.fr/pub/docs/manual-camlp4/manual002.html">camlp4</a>, <a href="http://caml.inria.fr/pub/docs/manual-ocaml-4.00/manual032.html">ocamlbuild</a>, the <a href="http://caml.inria.fr/resources/doc/index.en.html">documentation</a>, and the compiler itself. We'll have suggestions for <a href="https://github.com/ocamllabs/compiler-hacking/wiki/Things-to-work-on">mini-projects</a> for various levels of experience, but feel free to come along and work on whatever you fancy.</p>

<p>We'll also be ordering pizza, so if you want to be counted for food you should aim to arrive by 6.30pm.</p>
<a onclick="switchContent('ocamlorg-post94','ocamlorg-post93')" class="btn planet-toggle" href="#http://ocamllabs.github.com/compiler-hacking/2013/10/30/third-compiler-hacking-session">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://ocamllabs.github.com/compiler-hacking/2013/10/30/third-compiler-hacking-session">by Compiler Hacking at Oct 30, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>

<br/><br/><br/>
<div class="channelgroup">
  <div class="entrygroup" id="http://amirchaudhry.com/fpdays-review">
    <a name="#http://amirchaudhry.com/fpdays-review"> </a>
    <div>
    <img style="float:right; padding-left: 20px;" class="face" src="../mugshots/amir.jpg" width="" height="50" alt="" />
    <h1 class="posttitle">
      <a href="http://amirchaudhry.com/fpdays-review">Review of the OCaml FPDays tutorial</a>
      (<a href="http://amirchaudhry.com/tags/ocaml-labs-atom.xml" title="Amir Chaudhry - 'ocaml-labs'">Amir Chaudhry</a>)
    </h1>
    </div>
    <hr/>
    <div class="entry">
      <div class="content">
        <div>
          <div id="ocamlorg-post95">
<p><a href="http://fpdays.net/2013/sessions/index.php?session=24"><img src="http://amirchaudhry.com/images/web/fpdays-logo.png" style="float: right; margin-top: 10px; margin-left: 10px"/></a>
Last Thursday a bunch of us from the OCaml Labs team gave an OCaml tutorial 
at the <a href="http://fpdays.net/2013/sessions/index.php?session=24">FPDays</a> conference (an event for people interested in Functional 
Programming).  <a href="https://github.com/yallop">Jeremy</a> and I led the session with <a href="http://www.lpw25.net">Leo</a>, <a href="https://github.com/dsheets">David</a> and 
<a href="http://philippewang.info/CL/">Philippe</a> helping everyone progress and dealing with questions.</p>

<p><img src="http://amirchaudhry.com/images/fpdays2013/fpdays2013-01.jpg" style="float: left; margin-right: 10px"/>
It turned out to be by far the <em>most popular session</em> at the conference with 
over 20 people all wanting to get to grips with OCaml!  An excellent turnout 
and a great indicator of the interest that&rsquo;s out there, especially when you 
offer a hands-on session to people.  This shouldn&rsquo;t be a surprise as we&rsquo;ve 
had good attendance for the general <a href="http://www.meetup.com/Cambridge-NonDysFunctional-Programmers/">OCaml meetups</a> I&rsquo;ve run 
and also the <a href="http://ocamllabs.github.io/compiler-hacking/2013/09/17/compiler-hacking-july-2013.html">compiler hacking sessions</a>, which Jeremy and 
Leo have been building up (do sign up if you&rsquo;re interested in either of 
those!).  We had a nice surprise for attendees, which were 
<a href="http://en.wikipedia.org/wiki/Galley_proof">uncorrected proof</a> copies of Real World OCaml and luckily, we had just 
enough to go around.</p>

<p>For the tutorial itself, Jeremy put together a nice sequen&hellip;</p><a onclick="switchContent('ocamlorg-post95','ocamlorg-post96')" class="btn planet-toggle" href="#http://amirchaudhry.com/fpdays-review">Read more...</a></div><div id="ocamlorg-post96" style="display: none">
<p><a href="http://fpdays.net/2013/sessions/index.php?session=24"><img src="http://amirchaudhry.com/images/web/fpdays-logo.png" style="float: right; margin-top: 10px; margin-left: 10px"/></a>
Last Thursday a bunch of us from the OCaml Labs team gave an OCaml tutorial 
at the <a href="http://fpdays.net/2013/sessions/index.php?session=24">FPDays</a> conference (an event for people interested in Functional 
Programming).  <a href="https://github.com/yallop">Jeremy</a> and I led the session with <a href="http://www.lpw25.net">Leo</a>, <a href="https://github.com/dsheets">David</a> and 
<a href="http://philippewang.info/CL/">Philippe</a> helping everyone progress and dealing with questions.</p>

<p><img src="http://amirchaudhry.com/images/fpdays2013/fpdays2013-01.jpg" style="float: left; margin-right: 10px"/>
It turned out to be by far the <em>most popular session</em> at the conference with 
over 20 people all wanting to get to grips with OCaml!  An excellent turnout 
and a great indicator of the interest that&rsquo;s out there, especially when you 
offer a hands-on session to people.  This shouldn&rsquo;t be a surprise as we&rsquo;ve 
had good attendance for the general <a href="http://www.meetup.com/Cambridge-NonDysFunctional-Programmers/">OCaml meetups</a> I&rsquo;ve run 
and also the <a href="http://ocamllabs.github.io/compiler-hacking/2013/09/17/compiler-hacking-july-2013.html">compiler hacking sessions</a>, which Jeremy and 
Leo have been building up (do sign up if you&rsquo;re interested in either of 
those!).  We had a nice surprise for attendees, which were 
<a href="http://en.wikipedia.org/wiki/Galley_proof">uncorrected proof</a> copies of Real World OCaml and luckily, we had just 
enough to go around.</p>

<p>For the tutorial itself, Jeremy put together a nice sequence of exercises 
and a <a href="https://github.com/ocamllabs/fpdays-skeleton">skeleton repo</a> (with helpful comments in the code) so that people 
could dive in quickly.  The event was set up to be really informal and the 
rough plan was as following:</p>

<ol>
  <li>
    <p><em>Installation/Intro</em> - We checked that people had been able to follow the 
<a href="http://amirchaudhry.com/fpdays-ocaml-session/">installation instructions</a>, which we&rsquo;d sent them in advance. 
We also handed out copies of the book and made sure folks were comfortable 
with <a href="http://opam.ocaml.org">OPAM</a>.</p>
  </li>
  <li>
    <p><em>Hello world</em> - A light intro to get people familiar with the OCaml 
syntax and installing packages with OPAM. This would also help people to get 
familiar with the toolchain, workflow and compilation.  </p>
  </li>
  <li>
    <p><em>Monty Hall browser game</em> - Using <a href="http://ocsigen.org/js_of_ocaml/"><code>js_of_ocaml</code></a>, we wanted 
people to create and run the <a href="http://en.wikipedia.org/wiki/Monty_Hall_problem">Monty Hall problem</a> in their 
browser.  This would give people a taste of some real world interaction by 
having to deal with the DOM and interfaces.  If folks did well, they could 
add code to keep logs of the game results.</p>
  </li>
  <li>
    <p><em>Client-server game</em> - The previous game was all in the browser (so could 
be examined by players) so here the task was to split it into a client and 
server, ensuring the two stay in sync.  This would demonstrate the 
re-usability of the OCaml code already written and give people a feel for 
client server interactions. If people wanted to do more, they could use 
<a href="http://opam.ocaml.org/pkg/ctypes/0.1.1/">ctypes</a> and get better random numbers.  </p>
  </li>
</ol>

<p>We did manage to stick to the overall scheme as above and we think this is a 
great base from which to improve future tutorials.  It has the really nice 
benefit of having visual, interactive elements and the ability to run things 
both in the browser as well as on the server is a great way to show the 
versatility of OCaml.  <code>js_of_ocaml</code> is quite a mature tool and so it&rsquo;s 
no surprise that it&rsquo;s also used by companies such as Facebook (see the recent 
<a href="http://www.youtube.com/watch?v=gKWNjFagR9k">CUFP talk by Julien Verlaguet</a> - skip to <a href="http://www.youtube.com/watch?feature=player_detailpage&amp;v=gKWNjFagR9k#t=1149">19:00</a>).  </p>

<p>We learned a lot from running this session so we&rsquo;ve captured the good, the 
bad and the ugly below.  This is useful for anyone who&rsquo;d like to run an 
OCaml tutorial in the future and also for us to be aware of the next 
time we do this.  I&rsquo;ve incorporated the feedback from the attendees as well 
as our own thoughts.</p>

<p><img src="http://amirchaudhry.com/images/fpdays2013/fpdays2013-03.jpg" alt="Heads down and hands on"/></p>

<h3>Things we learnt</h3>

<h4>The Good</h4>

<ul>
  <li>
    <p>Most people really did follow the install instructions beforehand. This 
made things so much easier on the day as we didn&rsquo;t have to worry about 
compile times and people getting bored.  A few people had even got in touch 
with me the night before to sort out installation problems.  </p>
  </li>
  <li>
    <p>Many folks from OCaml Labs also came over to help people, which meant 
no-one was waiting longer than around 10 seconds before getting help.  </p>
  </li>
  <li>
    <p>We had a good plan of the things we wanted to cover but we were happy to 
be flexible and made it clear the aim was to get right into it.  Several 
folks told us that they really appreciated this loose (as opposed to rigid) 
structure.  </p>
  </li>
  <li>
    <p>We didn&rsquo;t spend any time lecturing the room but instead got people right 
into the code.  Having enough of a skeleton to get something interesting 
working was a big plus in this regard. People did progress from the early 
examples to the later ones fairly well.</p>
  </li>
  <li>
    <p>We had a VM with the correct set up that we could log people into if they 
were having trouble locally.  Two people made use of this.</p>
  </li>
  <li>
    <p>Of course, It was great to have early proofs of the book and these were 
well-received.</p>
  </li>
</ul>

<p><img src="http://amirchaudhry.com/images/fpdays2013/fpdays2013-02.jpg" alt="RWO books galore!"/></p>

<h4>The Bad</h4>

<ul>
  <li>
    <p>In our excitement to get right into the exercises, we didn&rsquo;t really give 
an overview of OCaml and its benefits.  A few minutes at the beginning would 
be enough and it&rsquo;s important so that people can leave with a few sound-bites.</p>
  </li>
  <li>
    <p>Not everyone received my email about installation, and certainly not the 
late arrivals.  This meant some pain getting things downloaded and running 
especially due to the wifi (see &lsquo;Ugly&rsquo; below).  </p>
  </li>
  <li>
    <p>A few of the people who <em>had</em> installed, didn&rsquo;t complete the instructions 
fully but didn&rsquo;t realise this until the morning of the session.  There was a good 
suggestion about having some kind of test to run that would check 
everything, so you&rsquo;d know if there was something missing.</p>
  </li>
  <li>
    <p>We really should have had a cut-off where we told people to use VMs 
instead of fixing installation issues and 10-15 minutes would have been 
enough.  This would have been especially useful for the late-comers.</p>
  </li>
  <li>
    <p>We didn&rsquo;t really keep a record of the problems folks were having so we 
can&rsquo;t now go back and fix underlying issues.  To be fair, this would have 
been a little awkward to do ad-hoc but in hindsight, it&rsquo;s a good thing to 
plan for.</p>
  </li>
</ul>

<h4>The Ugly</h4>

<ul>
  <li>The only ugly part was the wifi.  It turned out that the room itself was a 
bit of a dead-spot and that wasn&rsquo;t helped by 30ish devices trying to connect 
to one access point!  Having everyone grab packages at the same time in the 
morning probably didn&rsquo;t help.  It was especially tricky as all our 
mitigation plans seemed to revolve around at least having local connectivity.
In any case, this problem only lasted for the morning session and was a 
little better by the afternoon.  I&rsquo;d definitely recommend a backup plan in 
the case of complete wifi failure next time!  One such plan that Leo got 
started on was to put the repository and other information onto a flash 
drive that could be shared with people.  We didn&rsquo;t need this in the end but 
it&rsquo;ll be useful to have something like this prepared for next time.  If 
anyone fancies donating a bunch of flash drives, I&rsquo;ll happily receive them!</li>
</ul>

<p>Overall, it was a great session and everyone left happy, having completed 
most of the tutorial (and with a book!).  A few even continued at home 
afterwards and <a href="https://twitter.com/richardclegg/status/393458073052139520">got in touch</a> to let us know that they got 
everything working.
It was a great session and thanks to <a href="https://twitter.com/MarkDalgarno">Mark</a>, <a href="https://twitter.com/JacquiDDavidson">Jacqui</a> and the rest of 
the FPDays crew for a great conference!</p>

<p><img src="http://amirchaudhry.com/images/fpdays2013/fpdays2013-04.jpg" alt="RWO Book giveaway"/></p>

<p>(Thanks to Jeremy, Leo, David and Philippe for contributions to this post)</p>

<a onclick="switchContent('ocamlorg-post96','ocamlorg-post95')" class="btn planet-toggle" href="#http://amirchaudhry.com/fpdays-review">Hide</a></div>
        </div>
      </div>
      <div>
      <p class="date">
        <a href="http://amirchaudhry.com/fpdays-review">by Amir Chaudhry at Oct 28, 2013 </a>
      </p>
      </div>
    </div>
  </div>
</div>
 </div>
  </body>